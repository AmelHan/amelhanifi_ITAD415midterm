<html>
<head>
<title>test_array_core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_array_core.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">copy</span>
<span class="s0">import </span><span class="s1">pathlib</span>
<span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">xml.etree.ElementTree</span>
<span class="s0">from </span><span class="s1">unittest </span><span class="s0">import </span><span class="s1">mock</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">np = pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">math</span>
<span class="s0">import </span><span class="s1">operator</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">time</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">reduce</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">StringIO</span>
<span class="s0">from </span><span class="s1">operator </span><span class="s0">import </span><span class="s1">add</span><span class="s0">, </span><span class="s1">sub</span>
<span class="s0">from </span><span class="s1">threading </span><span class="s0">import </span><span class="s1">Lock</span>

<span class="s0">from </span><span class="s1">packaging.version </span><span class="s0">import </span><span class="s1">Version</span>
<span class="s0">from </span><span class="s1">tlz </span><span class="s0">import </span><span class="s1">concat</span><span class="s0">, </span><span class="s1">merge</span>
<span class="s0">from </span><span class="s1">tlz.curried </span><span class="s0">import </span><span class="s1">identity</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask._compatibility </span><span class="s0">import </span><span class="s1">PY_VERSION</span>
<span class="s0">from </span><span class="s1">dask.array.chunk </span><span class="s0">import </span><span class="s1">getitem</span>
<span class="s0">from </span><span class="s1">dask.array.core </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">Array</span><span class="s0">,</span>
    <span class="s1">BlockView</span><span class="s0">,</span>
    <span class="s1">PerformanceWarning</span><span class="s0">,</span>
    <span class="s1">blockdims_from_blockshape</span><span class="s0">,</span>
    <span class="s1">broadcast_chunks</span><span class="s0">,</span>
    <span class="s1">broadcast_shapes</span><span class="s0">,</span>
    <span class="s1">broadcast_to</span><span class="s0">,</span>
    <span class="s1">common_blockdim</span><span class="s0">,</span>
    <span class="s1">concatenate</span><span class="s0">,</span>
    <span class="s1">concatenate3</span><span class="s0">,</span>
    <span class="s1">concatenate_axes</span><span class="s0">,</span>
    <span class="s1">dotmany</span><span class="s0">,</span>
    <span class="s1">from_array</span><span class="s0">,</span>
    <span class="s1">from_delayed</span><span class="s0">,</span>
    <span class="s1">from_func</span><span class="s0">,</span>
    <span class="s1">getter</span><span class="s0">,</span>
    <span class="s1">graph_from_arraylike</span><span class="s0">,</span>
    <span class="s1">normalize_chunks</span><span class="s0">,</span>
    <span class="s1">optimize</span><span class="s0">,</span>
    <span class="s1">stack</span><span class="s0">,</span>
    <span class="s1">store</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.array.reshape </span><span class="s0">import </span><span class="s1">_not_implemented_message</span>
<span class="s0">from </span><span class="s1">dask.array.tests.test_dispatch </span><span class="s0">import </span><span class="s1">EncapsulateNDArray</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">same_keys</span>
<span class="s0">from </span><span class="s1">dask.base </span><span class="s0">import </span><span class="s1">compute_as_if_collection</span><span class="s0">, </span><span class="s1">tokenize</span>
<span class="s0">from </span><span class="s1">dask.blockwise </span><span class="s0">import </span><span class="s1">broadcast_dimensions</span>
<span class="s0">from </span><span class="s1">dask.blockwise </span><span class="s0">import </span><span class="s1">make_blockwise_graph </span><span class="s0">as </span><span class="s1">top</span>
<span class="s0">from </span><span class="s1">dask.blockwise </span><span class="s0">import </span><span class="s1">optimize_blockwise</span>
<span class="s0">from </span><span class="s1">dask.delayed </span><span class="s0">import </span><span class="s1">Delayed</span><span class="s0">, </span><span class="s1">delayed</span>
<span class="s0">from </span><span class="s1">dask.highlevelgraph </span><span class="s0">import </span><span class="s1">HighLevelGraph</span><span class="s0">, </span><span class="s1">MaterializedLayer</span>
<span class="s0">from </span><span class="s1">dask.layers </span><span class="s0">import </span><span class="s1">Blockwise</span>
<span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">SerializableLock</span><span class="s0">, </span><span class="s1">key_split</span><span class="s0">, </span><span class="s1">parse_bytes</span><span class="s0">, </span><span class="s1">tmpdir</span><span class="s0">, </span><span class="s1">tmpfile</span>
<span class="s0">from </span><span class="s1">dask.utils_test </span><span class="s0">import </span><span class="s1">dec</span><span class="s0">, </span><span class="s1">hlg_layer_topological</span><span class="s0">, </span><span class="s1">inc</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_graph_from_arraylike(inline_array):</span>
    <span class="s1">d = </span><span class="s3">2</span>
    <span class="s1">chunk = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">shape = tuple(d * n </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">chunk)</span>
    <span class="s1">arr = np.ones(shape)</span>

    <span class="s1">dsk = graph_from_arraylike(</span>
        <span class="s1">arr</span><span class="s0">, </span><span class="s1">chunk</span><span class="s0">, </span><span class="s1">shape=shape</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;X&quot;</span><span class="s0">, </span><span class="s1">inline_array=inline_array</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">isinstance(dsk</span><span class="s0">, </span><span class="s1">HighLevelGraph)</span>
    <span class="s0">if </span><span class="s1">inline_array:</span>
        <span class="s0">assert </span><span class="s1">len(dsk.layers) == </span><span class="s3">1</span>
        <span class="s0">assert </span><span class="s1">isinstance(hlg_layer_topological(dsk</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Blockwise)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">len(dsk.layers) == </span><span class="s3">2</span>
        <span class="s0">assert </span><span class="s1">isinstance(hlg_layer_topological(dsk</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">MaterializedLayer)</span>
        <span class="s0">assert </span><span class="s1">isinstance(hlg_layer_topological(dsk</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Blockwise)</span>
    <span class="s1">dsk = dict(dsk)</span>

    <span class="s4"># Somewhat odd membership check to avoid numpy elemwise __in__ overload</span>
    <span class="s0">assert </span><span class="s1">any(arr </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">dsk.values()) </span><span class="s0">is not </span><span class="s1">inline_array</span>


<span class="s0">def </span><span class="s1">test_top():</span>
    <span class="s0">assert </span><span class="s1">top(inc</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s0">assert </span><span class="s1">top(</span>
        <span class="s1">add</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span>
    <span class="s1">) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s0">assert </span><span class="s1">top(</span>
        <span class="s1">dotmany</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span>
    <span class="s1">) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (dotmany</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (dotmany</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (dotmany</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (dotmany</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s0">assert </span><span class="s1">top(identity</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">,</span><span class="s1">): (identity</span><span class="s0">, </span><span class="s1">[[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]])</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_top_supports_broadcasting_rules():</span>
    <span class="s0">assert </span><span class="s1">top(</span>
        <span class="s1">add</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)}</span>
    <span class="s1">) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_top_literals():</span>
    <span class="s0">assert </span><span class="s1">top(add</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s3">123</span><span class="s0">, None, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}) == {</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">123</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">123</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">123</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;z&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">123</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_blockwise_literals():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">z = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, None, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">100</span><span class="s1">)</span>

    <span class="s1">z = da.blockwise(</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z: x * y + z</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, None, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* x + </span><span class="s3">100</span><span class="s1">)</span>

    <span class="s1">z = da.blockwise(getitem</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">x)</span>


<span class="s0">def </span><span class="s1">test_blockwise_1_in_shape_I():</span>
    <span class="s0">def </span><span class="s1">test_f(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">assert </span><span class="s3">1 </span><span class="s0">in </span><span class="s1">b.shape</span>

    <span class="s1">p</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">N = </span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span>
    <span class="s1">da.blockwise(</span>
        <span class="s1">test_f</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((</span><span class="s3">2 </span><span class="s1">* p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">k * N)</span><span class="s0">, </span><span class="s1">chunks=(p</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">k))</span><span class="s0">,</span>
        <span class="s2">&quot;xzt&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((</span><span class="s3">2 </span><span class="s1">* p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(p</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;xzt&quot;</span><span class="s0">,</span>
        <span class="s1">concatenate=</span><span class="s0">True,</span>
        <span class="s1">dtype=float</span><span class="s0">,</span>
    <span class="s1">).compute()</span>


<span class="s0">def </span><span class="s1">test_blockwise_1_in_shape_II():</span>
    <span class="s0">def </span><span class="s1">test_f(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">assert </span><span class="s3">1 </span><span class="s0">in </span><span class="s1">b.shape</span>

    <span class="s1">p</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">N = </span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span>
    <span class="s1">da.blockwise(</span>
        <span class="s1">test_f</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((</span><span class="s3">2 </span><span class="s1">* p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">k * N</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;xztu&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((</span><span class="s3">2 </span><span class="s1">* p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(p</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;xztu&quot;</span><span class="s0">,</span>
        <span class="s1">concatenate=</span><span class="s0">True,</span>
        <span class="s1">dtype=float</span><span class="s0">,</span>
    <span class="s1">).compute()</span>


<span class="s0">def </span><span class="s1">test_blockwise_1_in_shape_III():</span>
    <span class="s0">def </span><span class="s1">test_f(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">assert </span><span class="s3">1 </span><span class="s0">in </span><span class="s1">b.shape</span>

    <span class="s1">k</span><span class="s0">, </span><span class="s1">N = </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span>
    <span class="s1">da.blockwise(</span>
        <span class="s1">test_f</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((k * N</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(k</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;xtu&quot;</span><span class="s0">,</span>
        <span class="s1">da.zeros((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;xtu&quot;</span><span class="s0">,</span>
        <span class="s1">concatenate=</span><span class="s0">True,</span>
        <span class="s1">dtype=float</span><span class="s0">,</span>
    <span class="s1">).compute()</span>


<span class="s0">def </span><span class="s1">test_concatenate3_on_scalars():</span>
    <span class="s1">assert_eq(concatenate3([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_chunked_dot_product():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">o = np.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>

    <span class="s1">getx = graph_from_arraylike(x</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s1">)</span>
    <span class="s1">geto = graph_from_arraylike(o</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;o&quot;</span><span class="s1">)</span>

    <span class="s1">result = top(</span>
        <span class="s1">dotmany</span><span class="s0">, </span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;o&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)}</span>
    <span class="s1">)</span>

    <span class="s1">dsk = merge(getx</span><span class="s0">, </span><span class="s1">geto</span><span class="s0">, </span><span class="s1">result)</span>
    <span class="s1">out = dask.get(dsk</span><span class="s0">, </span><span class="s1">[[(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)])</span>

    <span class="s1">assert_eq(np.dot(x</span><span class="s0">, </span><span class="s1">o)</span><span class="s0">, </span><span class="s1">concatenate3(out))</span>


<span class="s0">def </span><span class="s1">test_chunked_transpose_plus_one():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>

    <span class="s1">getx = graph_from_arraylike(x</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s1">)</span>

    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">x: x.T + </span><span class="s3">1</span>
    <span class="s1">comp = top(f</span><span class="s0">, </span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ji&quot;</span><span class="s0">, </span><span class="s1">numblocks={</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)})</span>

    <span class="s1">dsk = merge(getx</span><span class="s0">, </span><span class="s1">comp)</span>
    <span class="s1">out = dask.get(dsk</span><span class="s0">, </span><span class="s1">[[(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)])</span>

    <span class="s1">assert_eq(concatenate3(out)</span><span class="s0">, </span><span class="s1">x.T + </span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_broadcast_dimensions_works_with_singleton_dimensions():</span>
    <span class="s1">argpairs = [(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)]</span>
    <span class="s1">numblocks = {</span><span class="s2">&quot;x&quot;</span><span class="s1">: ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">broadcast_dimensions(argpairs</span><span class="s0">, </span><span class="s1">numblocks) == {</span><span class="s2">&quot;i&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)}</span>


<span class="s0">def </span><span class="s1">test_broadcast_dimensions():</span>
    <span class="s1">argpairs = [(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)]</span>
    <span class="s1">d = {</span><span class="s2">&quot;x&quot;</span><span class="s1">: (</span><span class="s2">&quot;Hello&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))}</span>
    <span class="s0">assert </span><span class="s1">broadcast_dimensions(argpairs</span><span class="s0">, </span><span class="s1">d) == {</span><span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s2">&quot;Hello&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)}</span>


<span class="s0">def </span><span class="s1">test_Array():</span>
    <span class="s1">arr = object()  </span><span class="s4"># arraylike is unimportant since we never compute</span>
    <span class="s1">shape = (</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">1000</span><span class="s1">)</span>
    <span class="s1">chunks = (</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">name = </span><span class="s2">&quot;x&quot;</span>
    <span class="s1">dsk = graph_from_arraylike(arr</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">name)</span>
    <span class="s1">a = Array(dsk</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape=shape</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">a.numblocks == (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">a.__dask_keys__() == [[(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)]</span>

    <span class="s0">assert </span><span class="s1">a.chunks == ((</span><span class="s3">100</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">100</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">a.shape == shape</span>

    <span class="s0">assert </span><span class="s1">len(a) == shape[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">Array(dsk</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape=shape)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">Array(dsk</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape=shape</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s0">, </span><span class="s1">meta=np.empty(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_uneven_chunks():</span>
    <span class="s1">a = Array({}</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a.chunks == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_numblocks_suppoorts_singleton_block_dims():</span>
    <span class="s1">arr = object()  </span><span class="s4"># arraylike is unimportant since we never compute</span>
    <span class="s1">shape = (</span><span class="s3">100</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">chunks = (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">name = </span><span class="s2">&quot;x&quot;</span>
    <span class="s1">dsk = graph_from_arraylike(arr</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">name)</span>
    <span class="s1">a = Array(dsk</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">shape=shape</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">set(concat(a.__dask_keys__())) == {(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)}</span>


<span class="s0">def </span><span class="s1">test_keys():</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j): () </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">)}</span>
    <span class="s1">dx = Array(dsk</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">dx.__dask_keys__() == [[(dx.name</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">)]</span>
    <span class="s4"># Cache works</span>
    <span class="s0">assert </span><span class="s1">dx.__dask_keys__() </span><span class="s0">is </span><span class="s1">dx.__dask_keys__()</span>
    <span class="s4"># Test mutating names clears key cache</span>
    <span class="s1">dx.dask = {(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j): () </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">)}</span>
    <span class="s1">dx._name = </span><span class="s2">&quot;y&quot;</span>
    <span class="s1">new_keys = [[(dx.name</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">)] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">dx.__dask_keys__() == new_keys</span>
    <span class="s0">assert </span><span class="s1">np.array_equal(dx._key_array</span><span class="s0">, </span><span class="s1">np.array(new_keys</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span><span class="s1">))</span>
    <span class="s1">d = Array({}</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">shape=()</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">d.__dask_keys__() == [(</span><span class="s2">&quot;x&quot;</span><span class="s0">,</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_Array_computation():</span>
    <span class="s1">a = Array({(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): np.eye(</span><span class="s3">3</span><span class="s1">)}</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(np.array(a)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">isinstance(a.compute()</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
    <span class="s0">assert </span><span class="s1">float(a[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]) == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_Array_numpy_gufunc_call__array_ufunc__01():</span>
    <span class="s1">x = da.random.default_rng().normal(size=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">nx = x.compute()</span>
    <span class="s1">ny = np.linalg._umath_linalg.inv(nx)</span>
    <span class="s1">y = np.linalg._umath_linalg.inv(x)</span>
    <span class="s1">assert_eq(ny</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_Array_numpy_gufunc_call__array_ufunc__02():</span>
    <span class="s1">x = da.random.default_rng().normal(size=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">nx = x.compute()</span>
    <span class="s1">nw</span><span class="s0">, </span><span class="s1">nv = np.linalg._umath_linalg.eig(nx)</span>
    <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg._umath_linalg.eig(x)</span>
    <span class="s1">assert_eq(nw</span><span class="s0">, </span><span class="s1">w)</span>
    <span class="s1">assert_eq(nv</span><span class="s0">, </span><span class="s1">v)</span>


<span class="s0">def </span><span class="s1">test_stack():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = (</span>
        <span class="s1">Array(</span>
            <span class="s1">graph_from_arraylike(object()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=name)</span><span class="s0">,</span>
            <span class="s1">name</span><span class="s0">,</span>
            <span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s0">,</span>
            <span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s2">&quot;ABC&quot;</span>
    <span class="s1">)</span>

    <span class="s1">s = stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">colon = slice(</span><span class="s0">None, None, None</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">s.shape == (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">s.chunksize == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s.dask[(s.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">colon</span><span class="s0">, </span><span class="s1">colon))</span>
    <span class="s0">assert </span><span class="s1">s.dask[(s.name</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">colon</span><span class="s0">, </span><span class="s1">colon))</span>
    <span class="s0">assert </span><span class="s1">same_keys(s</span><span class="s0">, </span><span class="s1">stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">s2 = stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">s2.chunksize == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.dask[(s2.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(colon</span><span class="s0">, None, </span><span class="s1">colon))</span>
    <span class="s0">assert </span><span class="s1">s2.dask[(s2.name</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(colon</span><span class="s0">, None, </span><span class="s1">colon))</span>
    <span class="s0">assert </span><span class="s1">same_keys(s2</span><span class="s0">, </span><span class="s1">stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">s2 = stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">s2.chunksize == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">s2.dask[(s2.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(colon</span><span class="s0">, </span><span class="s1">colon</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">s2.dask[(s2.name</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(colon</span><span class="s0">, </span><span class="s1">colon</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(s2</span><span class="s0">, </span><span class="s1">stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: stack([]))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">set(b.dask.keys()).issubset(s2.dask.keys())</span>

    <span class="s0">assert </span><span class="s1">stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">).chunks == stack([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">).chunks</span>


<span class="s0">def </span><span class="s1">test_stack_zero_size():</span>
    <span class="s1">x = np.empty((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">result_np = np.concatenate([x</span><span class="s0">, </span><span class="s1">x])</span>
    <span class="s1">result_da = da.concatenate([y</span><span class="s0">, </span><span class="s1">y])</span>

    <span class="s1">assert_eq(result_np</span><span class="s0">, </span><span class="s1">result_da)</span>


<span class="s0">def </span><span class="s1">test_short_stack():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">s = da.stack([d])</span>
    <span class="s0">assert </span><span class="s1">s.shape == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">chunks = compute_as_if_collection(Array</span><span class="s0">, </span><span class="s1">s.dask</span><span class="s0">, </span><span class="s1">s.__dask_keys__())</span>
    <span class="s0">assert </span><span class="s1">chunks[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">].shape == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_stack_scalars():</span>
    <span class="s1">d = da.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">s = da.stack([d.mean()</span><span class="s0">, </span><span class="s1">d.sum()])</span>

    <span class="s0">assert </span><span class="s1">s.compute().tolist() == [np.arange(</span><span class="s3">4</span><span class="s1">).mean()</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">4</span><span class="s1">).sum()]</span>


<span class="s0">def </span><span class="s1">test_stack_promote_type():</span>
    <span class="s1">i = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">f = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span>
    <span class="s1">di = da.from_array(i</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">df = da.from_array(f</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">res = da.stack([di</span><span class="s0">, </span><span class="s1">df])</span>
    <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">np.stack([i</span><span class="s0">, </span><span class="s1">f]))</span>


<span class="s0">def </span><span class="s1">test_stack_rechunk():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = rng.random(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = rng.random(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s1">z = da.stack([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.shape == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.stack([x.compute()</span><span class="s0">, </span><span class="s1">y.compute()]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_stack_unknown_chunksizes():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">a_df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">)})</span>
    <span class="s1">b_df = pd.DataFrame({</span><span class="s2">&quot;y&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">})</span>

    <span class="s1">a_ddf = dd.from_pandas(a_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">b_ddf = dd.from_pandas(b_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">a_x = a_ddf.values</span>
    <span class="s1">b_x = b_ddf.values</span>

    <span class="s0">assert </span><span class="s1">np.isnan(a_x.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">np.isnan(b_x.shape[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">exc_info:</span>
        <span class="s1">da.stack([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s2">&quot;shape&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;nan&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>

    <span class="s1">c_x = da.stack([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">allow_unknown_chunksizes=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">assert_eq(c_x</span><span class="s0">, </span><span class="s1">np.stack([a_df.values</span><span class="s0">, </span><span class="s1">b_df.values]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">exc_info:</span>
        <span class="s1">da.stack([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s2">&quot;shape&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;nan&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>

    <span class="s1">c_x = da.stack([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">allow_unknown_chunksizes=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">assert_eq(c_x</span><span class="s0">, </span><span class="s1">np.stack([a_df.values</span><span class="s0">, </span><span class="s1">b_df.values]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">m_df = pd.DataFrame({</span><span class="s2">&quot;m&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">) * </span><span class="s3">100</span><span class="s1">})</span>
    <span class="s1">n_df = pd.DataFrame({</span><span class="s2">&quot;n&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">) * </span><span class="s3">1000</span><span class="s1">})</span>

    <span class="s1">m_ddf = dd.from_pandas(m_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">n_ddf = dd.from_pandas(n_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">m_x = m_ddf.values</span>
    <span class="s1">n_x = n_ddf.values</span>

    <span class="s0">assert </span><span class="s1">np.isnan(m_x.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">np.isnan(n_x.shape[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">exc_info:</span>
        <span class="s1">da.stack([[a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">[m_x</span><span class="s0">, </span><span class="s1">n_x]])</span>

    <span class="s0">assert </span><span class="s2">&quot;shape&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;nan&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>

    <span class="s1">c_x = da.stack([[a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">[m_x</span><span class="s0">, </span><span class="s1">n_x]]</span><span class="s0">, </span><span class="s1">allow_unknown_chunksizes=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">assert_eq(c_x</span><span class="s0">, </span><span class="s1">np.stack([[a_df.values</span><span class="s0">, </span><span class="s1">b_df.values]</span><span class="s0">, </span><span class="s1">[m_df.values</span><span class="s0">, </span><span class="s1">n_df.values]]))</span>


<span class="s0">def </span><span class="s1">test_concatenate():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = (</span>
        <span class="s1">Array(</span>
            <span class="s1">graph_from_arraylike(object()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">name=name)</span><span class="s0">,</span>
            <span class="s1">name</span><span class="s0">,</span>
            <span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s0">,</span>
            <span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">name </span><span class="s0">in </span><span class="s2">&quot;ABC&quot;</span>
    <span class="s1">)</span>

    <span class="s1">x = concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">x.shape == (</span><span class="s3">12</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.dask[(x.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == (</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.dask[(x.name</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">same_keys(x</span><span class="s0">, </span><span class="s1">concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">y = concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">y.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">18</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] == (</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">same_keys(y</span><span class="s0">, </span><span class="s1">concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">set(b.dask.keys()).issubset(y.dask.keys())</span>

    <span class="s1">z = concatenate([a]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">z.shape == a.shape</span>
    <span class="s0">assert </span><span class="s1">z.chunks == a.chunks</span>
    <span class="s0">assert </span><span class="s1">z.dask == a.dask</span>
    <span class="s0">assert </span><span class="s1">z </span><span class="s0">is </span><span class="s1">a</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">).chunks == concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">).chunks</span>
    <span class="s1">)</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: concatenate([]))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: concatenate([a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dtypes&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s2">&quot;&gt;f8&quot;</span><span class="s0">, </span><span class="s2">&quot;&gt;f8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s2">&quot;&lt;f4&quot;</span><span class="s0">, </span><span class="s2">&quot;&lt;f8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;float64&quot;</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_concatenate_types(dtypes):</span>
    <span class="s1">dts_in</span><span class="s0">, </span><span class="s1">dt_out = dtypes</span>
    <span class="s1">arrs = [np.zeros(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=dt) </span><span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">dts_in]</span>
    <span class="s1">darrs = [from_array(arr</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)) </span><span class="s0">for </span><span class="s1">arr </span><span class="s0">in </span><span class="s1">arrs]</span>

    <span class="s1">x = concatenate(darrs</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.dtype == dt_out</span>


<span class="s0">def </span><span class="s1">test_concatenate_unknown_axes():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">a_df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">)})</span>
    <span class="s1">b_df = pd.DataFrame({</span><span class="s2">&quot;y&quot;</span><span class="s1">: np.arange(</span><span class="s3">12</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">})</span>

    <span class="s1">a_ddf = dd.from_pandas(a_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">b_ddf = dd.from_pandas(b_df</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">False, </span><span class="s1">npartitions=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">a_x = a_ddf.values</span>
    <span class="s1">b_x = b_ddf.values</span>

    <span class="s0">assert </span><span class="s1">np.isnan(a_x.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">np.isnan(b_x.shape[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s1">da.concatenate([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)  </span><span class="s4"># works fine</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">exc_info:</span>
        <span class="s1">da.concatenate([a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)  </span><span class="s4"># unknown chunks</span>

    <span class="s0">assert </span><span class="s2">&quot;nan&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;allow_unknown_chunksize&quot; </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>

    <span class="s1">c_x = da.concatenate(</span>
        <span class="s1">[a_x</span><span class="s0">, </span><span class="s1">b_x]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">allow_unknown_chunksizes=</span><span class="s0">True</span>
    <span class="s1">)  </span><span class="s4"># unknown chunks</span>

    <span class="s1">assert_eq(c_x</span><span class="s0">, </span><span class="s1">np.concatenate([a_df.values</span><span class="s0">, </span><span class="s1">b_df.values]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_concatenate_flatten():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">y = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.concatenate([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.concatenate([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_concatenate_rechunk():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = rng.random((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">y = rng.random((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.shape == (</span><span class="s3">12</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.concatenate([x.compute()</span><span class="s0">, </span><span class="s1">y.compute()]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.shape == (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.concatenate([x.compute()</span><span class="s0">, </span><span class="s1">y.compute()]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_concatenate_fixlen_strings():</span>
    <span class="s1">x = np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">y = np.array([</span><span class="s2">&quot;aa&quot;</span><span class="s0">, </span><span class="s2">&quot;bb&quot;</span><span class="s0">, </span><span class="s2">&quot;cc&quot;</span><span class="s1">])</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.concatenate([x</span><span class="s0">, </span><span class="s1">y])</span><span class="s0">, </span><span class="s1">da.concatenate([a</span><span class="s0">, </span><span class="s1">b]))</span>


<span class="s0">def </span><span class="s1">test_concatenate_zero_size():</span>
    <span class="s1">x = np.random.default_rng().random(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">result_np = np.concatenate([x</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">0</span><span class="s1">]])</span>
    <span class="s1">result_da = da.concatenate([y</span><span class="s0">, </span><span class="s1">y[:</span><span class="s3">0</span><span class="s1">]])</span>
    <span class="s1">assert_eq(result_np</span><span class="s0">, </span><span class="s1">result_da)</span>
    <span class="s0">assert </span><span class="s1">result_da </span><span class="s0">is </span><span class="s1">y</span>

    <span class="s4"># dtype of a size 0 arrays can affect the output dtype</span>
    <span class="s1">result_np = np.concatenate([np.zeros(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dtype=float)</span><span class="s0">, </span><span class="s1">np.zeros(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=int)])</span>
    <span class="s1">result_da = da.concatenate([da.zeros(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dtype=float)</span><span class="s0">, </span><span class="s1">da.zeros(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=int)])</span>

    <span class="s1">assert_eq(result_np</span><span class="s0">, </span><span class="s1">result_da)</span>

    <span class="s4"># All empty arrays case</span>
    <span class="s1">result_np = np.concatenate([np.zeros(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros(</span><span class="s3">0</span><span class="s1">)])</span>
    <span class="s1">result_da = da.concatenate([da.zeros(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.zeros(</span><span class="s3">0</span><span class="s1">)])</span>

    <span class="s1">assert_eq(result_np</span><span class="s0">, </span><span class="s1">result_da)</span>


<span class="s0">def </span><span class="s1">test_block_simple_row_wise():</span>
    <span class="s1">a1 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a2 = </span><span class="s3">2 </span><span class="s1">* a1</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([a1</span><span class="s0">, </span><span class="s1">a2])</span>
    <span class="s1">result = da.block([d1</span><span class="s0">, </span><span class="s1">d2])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">expected = np.block([a1</span><span class="s0">, </span><span class="s1">a2[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]])</span>
    <span class="s1">result = da.block([d1</span><span class="s0">, </span><span class="s1">d2[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]])</span>

    <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">d1</span>
    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_simple_column_wise():</span>
    <span class="s1">a1 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a2 = </span><span class="s3">2 </span><span class="s1">* a1</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([[a1]</span><span class="s0">, </span><span class="s1">[a2]])</span>
    <span class="s1">result = da.block([[d1]</span><span class="s0">, </span><span class="s1">[d2]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_with_1d_arrays_row_wise():</span>
    <span class="s4"># # # 1-D vectors are treated as row arrays</span>
    <span class="s1">a1 = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">a2 = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([a1</span><span class="s0">, </span><span class="s1">a2])</span>
    <span class="s1">result = da.block([d1</span><span class="s0">, </span><span class="s1">d2])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">expected = np.block([a1</span><span class="s0">, </span><span class="s1">a2[:</span><span class="s3">0</span><span class="s1">]])</span>
    <span class="s1">result = da.block([d1</span><span class="s0">, </span><span class="s1">d2[:</span><span class="s3">0</span><span class="s1">]])</span>

    <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">d1</span>
    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_with_1d_arrays_multiple_rows():</span>
    <span class="s1">a1 = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">a2 = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([[a1</span><span class="s0">, </span><span class="s1">a2]</span><span class="s0">, </span><span class="s1">[a1</span><span class="s0">, </span><span class="s1">a2]])</span>
    <span class="s1">result = da.block([[d1</span><span class="s0">, </span><span class="s1">d2]</span><span class="s0">, </span><span class="s1">[d1</span><span class="s0">, </span><span class="s1">d2]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_with_1d_arrays_column_wise():</span>
    <span class="s4"># # # 1-D vectors are treated as row arrays</span>
    <span class="s1">a1 = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">a2 = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([[a1]</span><span class="s0">, </span><span class="s1">[a2]])</span>
    <span class="s1">result = da.block([[d1]</span><span class="s0">, </span><span class="s1">[d2]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_mixed_1d_and_2d():</span>
    <span class="s1">a1 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a2 = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>

    <span class="s1">expected = np.block([[d1]</span><span class="s0">, </span><span class="s1">[d2]])</span>
    <span class="s1">result = da.block([[a1]</span><span class="s0">, </span><span class="s1">[a2]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_complicated():</span>
    <span class="s4"># a bit more complicated</span>
    <span class="s1">a1 = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">a2 = np.array([[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">a3 = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s1">a4 = np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">a5 = np.array(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a6 = np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">a7 = np.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>
    <span class="s1">d3 = da.asarray(a3)</span>
    <span class="s1">d4 = da.asarray(a4)</span>
    <span class="s1">d5 = da.asarray(a5)</span>
    <span class="s1">d6 = da.asarray(a6)</span>
    <span class="s1">d7 = da.asarray(a7)</span>

    <span class="s1">expected = np.block([[a1</span><span class="s0">, </span><span class="s1">a2]</span><span class="s0">, </span><span class="s1">[a3]</span><span class="s0">, </span><span class="s1">[a4]</span><span class="s0">, </span><span class="s1">[a5</span><span class="s0">, </span><span class="s1">a6]</span><span class="s0">, </span><span class="s1">[a7]])</span>
    <span class="s1">result = da.block([[d1</span><span class="s0">, </span><span class="s1">d2]</span><span class="s0">, </span><span class="s1">[d3]</span><span class="s0">, </span><span class="s1">[d4]</span><span class="s0">, </span><span class="s1">[d5</span><span class="s0">, </span><span class="s1">d6]</span><span class="s0">, </span><span class="s1">[d7]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_nested():</span>
    <span class="s1">a1 = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">a2 = np.array([[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">a3 = np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">a4 = np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">a5 = np.array(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a6 = np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">a7 = np.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>

    <span class="s1">d1 = da.asarray(a1)</span>
    <span class="s1">d2 = da.asarray(a2)</span>
    <span class="s1">d3 = da.asarray(a3)</span>
    <span class="s1">d4 = da.asarray(a4)</span>
    <span class="s1">d5 = da.asarray(a5)</span>
    <span class="s1">d6 = da.asarray(a6)</span>
    <span class="s1">d7 = da.asarray(a7)</span>

    <span class="s1">expected = np.block([[np.block([[a1]</span><span class="s0">, </span><span class="s1">[a3]</span><span class="s0">, </span><span class="s1">[a4]])</span><span class="s0">, </span><span class="s1">a2]</span><span class="s0">, </span><span class="s1">[a5</span><span class="s0">, </span><span class="s1">a6]</span><span class="s0">, </span><span class="s1">[a7]])</span>
    <span class="s1">result = da.block([[da.block([[d1]</span><span class="s0">, </span><span class="s1">[d3]</span><span class="s0">, </span><span class="s1">[d4]])</span><span class="s0">, </span><span class="s1">d2]</span><span class="s0">, </span><span class="s1">[d5</span><span class="s0">, </span><span class="s1">d6]</span><span class="s0">, </span><span class="s1">[d7]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_3d():</span>
    <span class="s1">a000 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">1</span>

    <span class="s1">a100 = np.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">2</span>
    <span class="s1">a010 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">3</span>
    <span class="s1">a001 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">4</span>

    <span class="s1">a011 = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">5</span>
    <span class="s1">a101 = np.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">6</span>
    <span class="s1">a110 = np.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">7</span>

    <span class="s1">a111 = np.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int) * </span><span class="s3">8</span>

    <span class="s1">d000 = da.asarray(a000)</span>

    <span class="s1">d100 = da.asarray(a100)</span>
    <span class="s1">d010 = da.asarray(a010)</span>
    <span class="s1">d001 = da.asarray(a001)</span>

    <span class="s1">d011 = da.asarray(a011)</span>
    <span class="s1">d101 = da.asarray(a101)</span>
    <span class="s1">d110 = da.asarray(a110)</span>

    <span class="s1">d111 = da.asarray(a111)</span>

    <span class="s1">expected = np.block([[[a000</span><span class="s0">, </span><span class="s1">a001]</span><span class="s0">, </span><span class="s1">[a010</span><span class="s0">, </span><span class="s1">a011]]</span><span class="s0">, </span><span class="s1">[[a100</span><span class="s0">, </span><span class="s1">a101]</span><span class="s0">, </span><span class="s1">[a110</span><span class="s0">, </span><span class="s1">a111]]])</span>
    <span class="s1">result = da.block([[[d000</span><span class="s0">, </span><span class="s1">d001]</span><span class="s0">, </span><span class="s1">[d010</span><span class="s0">, </span><span class="s1">d011]]</span><span class="s0">, </span><span class="s1">[[d100</span><span class="s0">, </span><span class="s1">d101]</span><span class="s0">, </span><span class="s1">[d110</span><span class="s0">, </span><span class="s1">d111]]])</span>

    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>

    <span class="s1">expected = np.block(</span>
        <span class="s1">[</span>
            <span class="s1">[[a000</span><span class="s0">, </span><span class="s1">a001[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[a010[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a011[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]]</span><span class="s0">,</span>
            <span class="s1">[[a100[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a101[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[a110[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">a111[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">result = da.block(</span>
        <span class="s1">[</span>
            <span class="s1">[[d000</span><span class="s0">, </span><span class="s1">d001[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[d010[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">d011[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]]</span><span class="s0">,</span>
            <span class="s1">[[d100[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">d101[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[d110[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">d111[:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">]]]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">result </span><span class="s0">is </span><span class="s1">d000</span>
    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_block_with_mismatched_shape():</span>
    <span class="s1">a = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">b = np.eye(</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">arrays </span><span class="s0">in </span><span class="s1">[[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[b</span><span class="s0">, </span><span class="s1">a]]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">da.block(arrays)</span>


<span class="s0">def </span><span class="s1">test_block_no_lists():</span>
    <span class="s1">assert_eq(da.block(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.block(</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.block(np.eye(</span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.block(np.eye(</span><span class="s3">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_block_invalid_nesting():</span>
    <span class="s0">for </span><span class="s1">arrays </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]]</span><span class="s0">,  </span><span class="s4"># missing brackets</span>
    <span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">da.block(arrays)</span>
        <span class="s1">e.match(</span><span class="s2">r&quot;depths are mismatched&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_block_empty_lists():</span>
    <span class="s0">for </span><span class="s1">arrays </span><span class="s0">in </span><span class="s1">[[]</span><span class="s0">, </span><span class="s1">[[]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]]]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">da.block(arrays)</span>
        <span class="s1">e.match(</span><span class="s2">r&quot;empty&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_block_tuple():</span>
    <span class="s0">for </span><span class="s1">arrays </span><span class="s0">in </span><span class="s1">[([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">da.block(arrays)</span>
        <span class="s1">e.match(</span><span class="s2">r&quot;tuple&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_broadcast_shapes():</span>
    <span class="s0">assert </span><span class="s1">() == broadcast_shapes()</span>
    <span class="s0">assert </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">) == broadcast_shapes((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">) == broadcast_shapes((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.allclose(</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">broadcast_shapes((</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.allclose(</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">broadcast_shapes((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan))</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">) == broadcast_shapes((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">())</span>
    <span class="s0">assert </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">) == broadcast_shapes((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">) == broadcast_shapes((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: broadcast_shapes((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: broadcast_shapes((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: broadcast_shapes((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan)))</span>


<span class="s0">def </span><span class="s1">test_elemwise_on_scalars():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">len(a.__dask_keys__()) == </span><span class="s3">2</span>
    <span class="s1">assert_eq(a.sum() ** </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x.sum() ** </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">y = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">result = a.sum() * b</span>
    <span class="s4"># Dask 0-d arrays do not behave like numpy scalars for type promotion</span>
    <span class="s0">assert </span><span class="s1">result.dtype == np.int64</span>
    <span class="s0">assert </span><span class="s1">result.compute().dtype == np.int64</span>
    <span class="s0">assert </span><span class="s1">(x.sum() * y).dtype == np.int32</span>
    <span class="s1">assert_eq((x.sum() * y).astype(np.int64)</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_elemwise_with_ndarrays():</span>
    <span class="s1">x = np.arange(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">assert_eq(x + a</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* x)</span>
    <span class="s1">assert_eq(a + x</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* x)</span>

    <span class="s1">assert_eq(x + b</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s1">assert_eq(b + x</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s1">assert_eq(a + y</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s1">assert_eq(y + a</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s4"># Error on shape mismatch</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: a + y.T)</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: a + np.arange(</span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_elemwise_differently_chunked():</span>
    <span class="s1">x = np.arange(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(a + b</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s1">assert_eq(b + a</span><span class="s0">, </span><span class="s1">x + y)</span>


<span class="s0">def </span><span class="s1">test_elemwise_dtype():</span>
    <span class="s1">values = [</span>
        <span class="s1">da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.int16)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.int64)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones(()</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">chunks=()) * </span><span class="s3">1e200</span><span class="s0">,</span>
        <span class="s1">np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s0">,</span>
        <span class="s3">1.0</span><span class="s0">,</span>
        <span class="s3">1e200</span><span class="s0">,</span>
        <span class="s1">np.int64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.ones(()</span><span class="s0">, </span><span class="s1">np.int64)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">values:</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">values:</span>
            <span class="s0">assert </span><span class="s1">da.maximum(x</span><span class="s0">, </span><span class="s1">y).dtype == da.result_type(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_operators():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">10</span><span class="s1">).reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">c = a + </span><span class="s3">1</span>
    <span class="s1">assert_eq(c</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">c = a + b</span>
    <span class="s1">assert_eq(c</span><span class="s0">, </span><span class="s1">x + x.reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>

    <span class="s1">expr = (</span><span class="s3">3 </span><span class="s1">/ a * b) ** </span><span class="s3">2 </span><span class="s1">&gt; </span><span class="s3">5</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">RuntimeWarning)  </span><span class="s4"># divide by zero</span>
        <span class="s1">assert_eq(expr</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3 </span><span class="s1">/ x * y) ** </span><span class="s3">2 </span><span class="s1">&gt; </span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">c = da.exp(a)</span>
    <span class="s1">assert_eq(c</span><span class="s0">, </span><span class="s1">np.exp(x))</span>

    <span class="s1">assert_eq(abs(-a)</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">+x)</span>


<span class="s0">def </span><span class="s1">test_operator_dtype_promotion():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s1">y = np.array([</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(x + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">a + </span><span class="s3">1</span><span class="s1">)  </span><span class="s4"># still float32</span>
    <span class="s1">assert_eq(x + </span><span class="s3">1e50</span><span class="s0">, </span><span class="s1">a + </span><span class="s3">1e50</span><span class="s1">)  </span><span class="s4"># now float64</span>
    <span class="s1">assert_eq(x + y</span><span class="s0">, </span><span class="s1">a + y)  </span><span class="s4"># also float64</span>


<span class="s0">def </span><span class="s1">test_field_access():</span>
    <span class="s1">x = np.array([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;f4&quot;</span><span class="s1">)])</span>
    <span class="s1">y = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(y[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[</span><span class="s2">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">assert_eq(y[[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]])</span>
    <span class="s0">assert </span><span class="s1">same_keys(y[[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">y[[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_field_access_with_shape():</span>
    <span class="s1">dtype = [(</span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;f4&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;col2&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;f4&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))]</span>
    <span class="s1">data = np.ones((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">x = da.from_array(data</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">assert_eq(x[</span><span class="s2">&quot;col1&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">data[</span><span class="s2">&quot;col1&quot;</span><span class="s1">])</span>
    <span class="s1">assert_eq(x[[</span><span class="s2">&quot;col1&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">data[[</span><span class="s2">&quot;col1&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_eq(x[</span><span class="s2">&quot;col2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">data[</span><span class="s2">&quot;col2&quot;</span><span class="s1">])</span>
    <span class="s1">assert_eq(x[[</span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">data[[</span><span class="s2">&quot;col1&quot;</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_matmul():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(operator.matmul(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">a.dot(b))</span>
    <span class="s1">assert_eq(operator.matmul(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">operator.matmul(x</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(operator.matmul(a</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">operator.matmul(x</span><span class="s0">, </span><span class="s1">b))</span>
    <span class="s1">list_vec = list(range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_eq(operator.matmul(list_vec</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">operator.matmul(list_vec</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(operator.matmul(x</span><span class="s0">, </span><span class="s1">list_vec)</span><span class="s0">, </span><span class="s1">operator.matmul(a</span><span class="s0">, </span><span class="s1">list_vec))</span>
    <span class="s1">z = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">c = from_array(z</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(operator.matmul(a</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">operator.matmul(x</span><span class="s0">, </span><span class="s1">c))</span>
    <span class="s1">assert_eq(operator.matmul(z</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s1">operator.matmul(c</span><span class="s0">, </span><span class="s1">x))</span>


<span class="s0">def </span><span class="s1">test_matmul_array_ufunc():</span>
    <span class="s4"># regression test for https://github.com/dask/dask/issues/4353</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">result = b.__array_ufunc__(np.matmul</span><span class="s0">, </span><span class="s2">&quot;__call__&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.dot(y))</span>


<span class="s0">def </span><span class="s1">test_T():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(x.T</span><span class="s0">, </span><span class="s1">a.T)</span>


<span class="s0">def </span><span class="s1">test_broadcast_to():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[a.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]:</span>
        <span class="s1">xb = np.broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">ab = broadcast_to(a</span><span class="s0">, </span><span class="s1">shape)</span>

        <span class="s1">assert_eq(xb</span><span class="s0">, </span><span class="s1">ab)</span>

        <span class="s0">if </span><span class="s1">a.shape == ab.shape:</span>
            <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">ab</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: broadcast_to(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: broadcast_to(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_broadcast_to_array():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]:</span>
        <span class="s1">a = np.broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">d = broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>

        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">d)</span>


<span class="s0">def </span><span class="s1">test_broadcast_to_scalar():</span>
    <span class="s1">x = </span><span class="s3">5</span>

    <span class="s0">for </span><span class="s1">shape </span><span class="s0">in </span><span class="s1">[tuple()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]:</span>
        <span class="s1">a = np.broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">d = broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>

        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">d)</span>


<span class="s0">def </span><span class="s1">test_broadcast_to_chunks():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">expected_chunks </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">]:</span>
        <span class="s1">xb = np.broadcast_to(x</span><span class="s0">, </span><span class="s1">shape)</span>
        <span class="s1">ab = broadcast_to(a</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
        <span class="s1">assert_eq(xb</span><span class="s0">, </span><span class="s1">ab)</span>
        <span class="s0">assert </span><span class="s1">ab.chunks == expected_chunks</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">broadcast_to(a</span><span class="s0">, </span><span class="s1">a.shape</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">broadcast_to(a</span><span class="s0">, </span><span class="s1">a.shape</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">broadcast_to(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_broadcast_arrays():</span>
    <span class="s0">assert </span><span class="s1">np.broadcast_arrays() == da.broadcast_arrays()</span>

    <span class="s1">a = np.arange(</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=tuple(s // </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">a.shape))</span>

    <span class="s1">a_0 = np.arange(</span><span class="s3">4</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:]</span>
    <span class="s1">a_1 = np.arange(</span><span class="s3">4</span><span class="s1">)[:</span><span class="s0">, None</span><span class="s1">]</span>

    <span class="s1">d_a_0 = d_a[</span><span class="s0">None, </span><span class="s1">:]</span>
    <span class="s1">d_a_1 = d_a[:</span><span class="s0">, None</span><span class="s1">]</span>

    <span class="s1">a_r = np.broadcast_arrays(a_0</span><span class="s0">, </span><span class="s1">a_1)</span>
    <span class="s1">d_r = da.broadcast_arrays(d_a_0</span><span class="s0">, </span><span class="s1">d_a_1)</span>

    <span class="s0">assert </span><span class="s1">isinstance(d_r</span><span class="s0">, </span><span class="s1">list)</span>
    <span class="s0">assert </span><span class="s1">len(a_r) == len(d_r)</span>

    <span class="s0">for </span><span class="s1">e_a_r</span><span class="s0">, </span><span class="s1">e_d_r </span><span class="s0">in </span><span class="s1">zip(a_r</span><span class="s0">, </span><span class="s1">d_r):</span>
        <span class="s1">assert_eq(e_a_r</span><span class="s0">, </span><span class="s1">e_d_r)</span>


<span class="s0">def </span><span class="s1">test_broadcast_arrays_uneven_chunks():</span>
    <span class="s1">x = da.ones(</span><span class="s3">30</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.ones(</span><span class="s3">30</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">z = np.broadcast_arrays(x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">z)</span>

    <span class="s1">x = da.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">y = da.ones(</span><span class="s3">30</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">z = np.broadcast_arrays(x</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">z)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;u_shape, v_shape&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[tuple()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_broadcast_operator(u_shape</span><span class="s0">, </span><span class="s1">v_shape):</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">u = rng.random(u_shape)</span>
    <span class="s1">v = rng.random(v_shape)</span>

    <span class="s1">d_u = from_array(u</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">d_v = from_array(v</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">w = u * v</span>
    <span class="s1">d_w = d_u * d_v</span>

    <span class="s1">assert_eq(w</span><span class="s0">, </span><span class="s1">d_w)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;original_shape,new_shape,chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">24</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">64</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">16</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">64</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">32</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_reshape(original_shape</span><span class="s0">, </span><span class="s1">new_shape</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=original_shape)</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">xr = x.reshape(new_shape)</span>
    <span class="s1">ar = a.reshape(new_shape)</span>

    <span class="s0">if </span><span class="s1">a.shape == new_shape:</span>
        <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">ar</span>

    <span class="s1">assert_eq(xr</span><span class="s0">, </span><span class="s1">ar)</span>


<span class="s0">def </span><span class="s1">test_reshape_exceptions():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.reshape(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">100</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_reshape_splat():</span>
    <span class="s1">x = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.reshape((</span><span class="s3">25</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">x.reshape(</span><span class="s3">25</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_reshape_not_implemented_error():</span>
    <span class="s1">a = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">new_shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">NotImplementedError</span><span class="s0">, </span><span class="s1">match=re.escape(_not_implemented_message)</span>
        <span class="s1">):</span>
            <span class="s1">a.reshape(new_shape)</span>


<span class="s0">def </span><span class="s1">test_reshape_unknown_dimensions():</span>
    <span class="s0">for </span><span class="s1">original_shape </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]:</span>
        <span class="s0">for </span><span class="s1">new_shape </span><span class="s0">in </span><span class="s1">[(-</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]:</span>
            <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=original_shape)</span>
            <span class="s1">a = from_array(x</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span>
            <span class="s1">assert_eq(x.reshape(new_shape)</span><span class="s0">, </span><span class="s1">a.reshape(new_shape))</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: da.reshape(a</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;limit&quot;</span><span class="s0">,  </span><span class="s4"># in bytes</span>
    <span class="s1">[</span>
        <span class="s0">None,  </span><span class="s4"># Default value: dask.config.get(&quot;array.chunk-size&quot;)</span>
        <span class="s3">134217728</span><span class="s0">,  </span><span class="s4"># 128 MiB (default value size on a typical laptop)</span>
        <span class="s3">67108864</span><span class="s0">,  </span><span class="s4"># 64 MiB (half the typical default value size)</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks, reshape_size&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s4"># Test reshape where output chunks would otherwise be too large</span>
        <span class="s1">((</span><span class="s3">300</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">18483</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">183</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">300</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s4"># Test reshape where multiple chunks match between input and output</span>
        <span class="s1">((</span><span class="s3">300</span><span class="s0">, </span><span class="s3">300</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">18483</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">183</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">300</span><span class="s0">, </span><span class="s3">300</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_reshape_avoids_large_chunks(limit</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reshape_size):</span>
    <span class="s1">array = da.random.default_rng().random(shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s0">if </span><span class="s1">limit </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">dask.config.set(**{</span><span class="s2">&quot;array.slicing.split_large_chunks&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
            <span class="s1">result = array.reshape(*reshape_size</span><span class="s0">, </span><span class="s1">limit=limit)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">result = array.reshape(*reshape_size</span><span class="s0">, </span><span class="s1">limit=limit)</span>
    <span class="s1">nbytes = array.dtype.itemsize</span>
    <span class="s1">max_chunksize_in_bytes = reduce(operator.mul</span><span class="s0">, </span><span class="s1">result.chunksize) * nbytes</span>
    <span class="s0">if </span><span class="s1">limit </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">limit = parse_bytes(dask.config.get(</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">max_chunksize_in_bytes &lt; limit</span>


<span class="s0">def </span><span class="s1">test_reshape_warns_by_default_if_it_is_producing_large_chunks():</span>
    <span class="s4"># Test reshape where output chunks would otherwise be too large</span>
    <span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reshape_size = (</span><span class="s3">300</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">18483</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">183</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">300</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">array = da.random.default_rng().random(shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(PerformanceWarning) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">result = array.reshape(*reshape_size)</span>
        <span class="s1">nbytes = array.dtype.itemsize</span>
        <span class="s1">max_chunksize_in_bytes = reduce(operator.mul</span><span class="s0">, </span><span class="s1">result.chunksize) * nbytes</span>
        <span class="s1">limit = parse_bytes(dask.config.get(</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">max_chunksize_in_bytes &gt; limit</span>

    <span class="s0">assert </span><span class="s1">len(record) == </span><span class="s3">1</span>

    <span class="s0">with </span><span class="s1">dask.config.set(**{</span><span class="s2">&quot;array.slicing.split_large_chunks&quot;</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}):</span>
        <span class="s1">result = array.reshape(*reshape_size)</span>
        <span class="s1">nbytes = array.dtype.itemsize</span>
        <span class="s1">max_chunksize_in_bytes = reduce(operator.mul</span><span class="s0">, </span><span class="s1">result.chunksize) * nbytes</span>
        <span class="s1">limit = parse_bytes(dask.config.get(</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">max_chunksize_in_bytes &gt; limit</span>

    <span class="s0">with </span><span class="s1">dask.config.set(**{</span><span class="s2">&quot;array.slicing.split_large_chunks&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
        <span class="s1">result = array.reshape(*reshape_size)</span>
        <span class="s1">nbytes = array.dtype.itemsize</span>
        <span class="s1">max_chunksize_in_bytes = reduce(operator.mul</span><span class="s0">, </span><span class="s1">result.chunksize) * nbytes</span>
        <span class="s1">limit = parse_bytes(dask.config.get(</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">max_chunksize_in_bytes &lt; limit</span>


<span class="s0">def </span><span class="s1">test_full():</span>
    <span class="s1">d = da.full((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">d.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">np.full((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">d = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">e = d.map_blocks(inc</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>

    <span class="s0">assert </span><span class="s1">d.chunks == e.chunks</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">e = d.map_blocks(inc</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;increment&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.name.startswith(</span><span class="s2">&quot;increment-&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">d.map_blocks(inc</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">).name != d.map_blocks(dec</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">).name</span>

    <span class="s1">d = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span><span class="s0">lambda </span><span class="s1">x: x[::</span><span class="s3">2</span><span class="s0">, </span><span class="s1">::</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>

    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x[::</span><span class="s3">2</span><span class="s0">, </span><span class="s1">::</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">d = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span>
        <span class="s0">lambda </span><span class="s1">x: x[::</span><span class="s3">2</span><span class="s0">, </span><span class="s1">::</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=d.dtype</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x[::</span><span class="s3">2</span><span class="s0">, </span><span class="s1">::</span><span class="s3">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_map_blocks2():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
    <span class="s1">d = from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">func(block</span><span class="s0">, </span><span class="s1">block_id=</span><span class="s0">None, </span><span class="s1">c=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">np.ones_like(block) * sum(block_id) + c</span>

    <span class="s1">out = d.map_blocks(func</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
    <span class="s1">expected = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>

    <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(d.map_blocks(func</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s1">out = d.map_blocks(func</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">expected = expected + </span><span class="s3">1</span>

    <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(d.map_blocks(func</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_block_info():</span>
    <span class="s1">x = da.arange(</span><span class="s3">50</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">func(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">]:  </span><span class="s4"># positions in args</span>
            <span class="s0">assert </span><span class="s1">block_info[idx][</span><span class="s2">&quot;shape&quot;</span><span class="s1">] == (</span><span class="s3">50</span><span class="s0">,</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">block_info[idx][</span><span class="s2">&quot;num-chunks&quot;</span><span class="s1">] == (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>
            <span class="s1">start</span><span class="s0">, </span><span class="s1">stop = block_info[idx][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span>
            <span class="s0">assert </span><span class="s1">stop - start == </span><span class="s3">10</span>
            <span class="s0">assert </span><span class="s3">0 </span><span class="s1">&lt;= start &lt;= </span><span class="s3">40</span>
            <span class="s0">assert </span><span class="s3">10 </span><span class="s1">&lt;= stop &lt;= </span><span class="s3">50</span>

            <span class="s0">assert </span><span class="s3">0 </span><span class="s1">&lt;= block_info[idx][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">][</span><span class="s3">0</span><span class="s1">] &lt;= </span><span class="s3">4</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-shape&quot;</span><span class="s1">] == (</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">] == x.dtype</span>

        <span class="s0">return </span><span class="s1">a + b + c</span>

    <span class="s1">z = da.map_blocks(func</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">x + x + </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">100</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_block_info_with_new_axis():</span>
    <span class="s4"># https://github.com/dask/dask/issues/4298</span>
    <span class="s1">values = da.from_array(np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">func(x</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">assert </span><span class="s1">block_info.keys() == {</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">}</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">] == (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;num-chunks&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">] == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;num-chunks&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-shape&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">] == np.dtype(</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] </span><span class="s0">in </span><span class="s1">{(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)}</span>

        <span class="s0">if </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">):</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>
        <span class="s0">elif </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">):</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>

        <span class="s0">return </span><span class="s1">np.ones((len(x)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">z = values.map_blocks(func</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">new_axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_block_info_with_drop_axis():</span>
    <span class="s4"># https://github.com/dask/dask/issues/4584</span>
    <span class="s1">values = da.from_array(</span>
        <span class="s1">np.array(</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">32</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">64</span><span class="s0">, </span><span class="s3">128</span><span class="s0">, </span><span class="s3">256</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1024</span><span class="s0">, </span><span class="s3">2048</span><span class="s0">, </span><span class="s3">4096</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;u4&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">func(x</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">assert </span><span class="s1">block_info.keys() == {</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">}</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">] == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s4"># drop_axis concatenates along the dropped dimension, hence not (2, 3)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;num-chunks&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">] == (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;num-chunks&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-shape&quot;</span><span class="s1">] == (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">] == np.dtype(</span><span class="s2">&quot;u4&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] </span><span class="s0">in </span><span class="s1">{(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)}</span>

        <span class="s0">if </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">):</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
        <span class="s0">elif </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">):</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s3">0</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">] == [(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span>

        <span class="s0">return </span><span class="s1">np.sum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;u4&quot;</span><span class="s1">)</span>

    <span class="s1">z = values.map_blocks(func</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;u4&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">448</span><span class="s0">, </span><span class="s3">7168</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;u4&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_block_info_with_broadcast():</span>
    <span class="s1">expected0 = [</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">expected1 = [</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">expected2 = [</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">expected = [</span>
        <span class="s1">{</span>
            <span class="s3">0</span><span class="s1">: expected0[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: expected1[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: expected2[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None</span><span class="s1">: {</span>
                <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="s1">: np.float64</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s3">0</span><span class="s1">: expected0[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: expected1[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: expected2[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None</span><span class="s1">: {</span>
                <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="s1">: np.float64</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s3">0</span><span class="s1">: expected0[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: expected1[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: expected2[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None</span><span class="s1">: {</span>
                <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="s1">: np.float64</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s3">0</span><span class="s1">: expected0[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s1">: expected1[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s1">: expected2[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None</span><span class="s1">: {</span>
                <span class="s2">&quot;shape&quot;</span><span class="s1">: (</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;num-chunks&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;dtype&quot;</span><span class="s1">: np.float64</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-shape&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;array-location&quot;</span><span class="s1">: [(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s2">&quot;chunk-location&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">def </span><span class="s1">func(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">for </span><span class="s1">info </span><span class="s0">in </span><span class="s1">expected:</span>
            <span class="s0">if </span><span class="s1">block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">] == info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;chunk-location&quot;</span><span class="s1">]:</span>
                <span class="s0">assert </span><span class="s1">block_info == info</span>
                <span class="s0">break</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert False</span>
        <span class="s0">return </span><span class="s1">x + y + z</span>

    <span class="s1">a = da.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">b = da.ones((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">c = da.ones((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">d = da.map_blocks(func</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
    <span class="s0">assert </span><span class="s1">d.chunks == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s3">3 </span><span class="s1">* np.ones((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_constants():</span>
    <span class="s1">d = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">e = d.map_blocks(add</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>

    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">100</span><span class="s1">)</span>

    <span class="s1">assert_eq(da.map_blocks(sub</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) - </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.map_blocks(sub</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span><span class="s0">, </span><span class="s3">10 </span><span class="s1">- np.arange(</span><span class="s3">10</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_kwargs():</span>
    <span class="s1">d = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">result = d.map_blocks(np.max</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True, </span><span class="s1">dtype=d.dtype</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_infer_chunks_broadcast():</span>
    <span class="s1">dx = da.from_array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">dy = da.from_array([[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">30</span><span class="s0">, </span><span class="s3">40</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)))</span>
    <span class="s1">result = da.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">dx</span><span class="s0">, </span><span class="s1">dy)</span>
    <span class="s0">assert </span><span class="s1">result.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">24</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">31</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">44</span><span class="s1">]]))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_chunks():</span>
    <span class="s1">dx = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dy = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dz = da.map_blocks(np.add</span><span class="s0">, </span><span class="s1">dx</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s1">chunks=dx.chunks)</span>
    <span class="s1">assert_eq(dz</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) * </span><span class="s3">2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_dtype_inference():</span>
    <span class="s1">x = np.arange(</span><span class="s3">50</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">y = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">dy = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">foo(x</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">cast = kwargs.pop(</span><span class="s2">&quot;cast&quot;</span><span class="s0">, </span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">(x + sum(args)).astype(cast)</span>

    <span class="s1">assert_eq(dx.map_blocks(foo</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">foo(dx</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(dx.map_blocks(foo</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">cast=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">foo(dx</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">cast=</span><span class="s2">&quot;f8&quot;</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">dx.map_blocks(foo</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">cast=</span><span class="s2">&quot;f8&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">foo(dx</span><span class="s0">, </span><span class="s1">dy</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">cast=</span><span class="s2">&quot;f8&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">foo(x):</span>
        <span class="s0">raise </span><span class="s1">RuntimeError(</span><span class="s2">&quot;Woops&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s1">dx.map_blocks(foo)</span>
    <span class="s1">msg = str(e.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;dtype&quot; </span><span class="s0">in </span><span class="s1">msg</span>


<span class="s0">def </span><span class="s1">test_map_blocks_infer_newaxis():</span>
    <span class="s1">x = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = da.map_blocks(</span><span class="s0">lambda </span><span class="s1">x: x[</span><span class="s0">None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">da.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_no_array_args():</span>
    <span class="s0">def </span><span class="s1">func(dtype</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">loc = block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">]</span>
        <span class="s0">return </span><span class="s1">np.arange(loc[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">loc[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s1">x = da.map_blocks(func</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_unique_name_chunks_dtype():</span>
    <span class="s0">def </span><span class="s1">func(block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s1">loc = block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;array-location&quot;</span><span class="s1">]</span>
        <span class="s1">dtype = block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">]</span>
        <span class="s0">return </span><span class="s1">np.arange(loc[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">loc[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s1">x = da.map_blocks(func</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>

    <span class="s1">y = da.map_blocks(func</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
    <span class="s0">assert </span><span class="s1">x.name != y.name</span>

    <span class="s1">z = da.map_blocks(func</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=np.float64))</span>
    <span class="s0">assert </span><span class="s1">x.name != z.name</span>
    <span class="s0">assert </span><span class="s1">y.name != z.name</span>


<span class="s0">def </span><span class="s1">test_map_blocks_unique_name_drop_axis():</span>
    <span class="s0">def </span><span class="s1">func(some_3d</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if not </span><span class="s1">block_info:</span>
            <span class="s0">return </span><span class="s1">some_3d</span>
        <span class="s1">dtype = block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">]</span>
        <span class="s0">return </span><span class="s1">np.zeros(block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s1">input_arr = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s1">x = da.map_blocks(func</span><span class="s0">, </span><span class="s1">input_arr</span><span class="s0">, </span><span class="s1">drop_axis=[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>

    <span class="s1">y = da.map_blocks(func</span><span class="s0">, </span><span class="s1">input_arr</span><span class="s0">, </span><span class="s1">drop_axis=[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
    <span class="s0">assert </span><span class="s1">x.name != y.name</span>


<span class="s0">def </span><span class="s1">test_map_blocks_unique_name_new_axis():</span>
    <span class="s0">def </span><span class="s1">func(some_2d</span><span class="s0">, </span><span class="s1">block_info=</span><span class="s0">None</span><span class="s1">):</span>
        <span class="s0">if not </span><span class="s1">block_info:</span>
            <span class="s0">return </span><span class="s1">some_2d</span>
        <span class="s1">dtype = block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;dtype&quot;</span><span class="s1">]</span>
        <span class="s0">return </span><span class="s1">np.zeros(block_info[</span><span class="s0">None</span><span class="s1">][</span><span class="s2">&quot;shape&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s1">input_arr = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s1">x = da.map_blocks(func</span><span class="s0">, </span><span class="s1">input_arr</span><span class="s0">, </span><span class="s1">new_axis=[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>

    <span class="s1">y = da.map_blocks(func</span><span class="s0">, </span><span class="s1">input_arr</span><span class="s0">, </span><span class="s1">new_axis=[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
    <span class="s0">assert </span><span class="s1">x.name != y.name</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">block_info: x + y])</span>
<span class="s0">def </span><span class="s1">test_map_blocks_optimize_blockwise(func):</span>
    <span class="s4"># Check that map_blocks layers can merge with elementwise layers</span>
    <span class="s1">base = [da.full((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)]</span>
    <span class="s1">a = base[</span><span class="s3">0</span><span class="s1">] + base[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">b = da.map_blocks(func</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">base[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
    <span class="s1">c = b + base[</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">dsk = c.__dask_graph__()</span>
    <span class="s1">optimized = optimize_blockwise(dsk)</span>

    <span class="s4"># Everything should be fused into a single layer.</span>
    <span class="s4"># If the lambda includes block_info, there will be two layers.</span>
    <span class="s0">assert </span><span class="s1">len(optimized.layers) == len(dsk.layers) - </span><span class="s3">6</span>


<span class="s0">def </span><span class="s1">test_repr():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">key_split(d.name) </span><span class="s0">in </span><span class="s1">repr(d)</span>
    <span class="s0">assert </span><span class="s1">str(d.shape) </span><span class="s0">in </span><span class="s1">repr(d)</span>
    <span class="s0">assert </span><span class="s1">str(d.dtype) </span><span class="s0">in </span><span class="s1">repr(d)</span>
    <span class="s1">d = da.ones((</span><span class="s3">4000</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">len(str(d)) &lt; </span><span class="s3">1000</span>


<span class="s0">def </span><span class="s1">test_repr_meta():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s2">&quot;chunktype=numpy.ndarray&quot; </span><span class="s0">in </span><span class="s1">repr(d)</span>

    <span class="s4"># Test non-numpy meta</span>
    <span class="s1">sparse = pytest.importorskip(</span><span class="s2">&quot;sparse&quot;</span><span class="s1">)</span>
    <span class="s1">s = d.map_blocks(sparse.COO)</span>
    <span class="s0">assert </span><span class="s2">&quot;chunktype=sparse.COO&quot; </span><span class="s0">in </span><span class="s1">repr(s)</span>


<span class="s0">def </span><span class="s1">test_repr_html_array_highlevelgraph():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;jinja2&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones((</span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)).T[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:</span><span class="s3">4</span><span class="s1">]</span>
    <span class="s1">hg = x.dask</span>
    <span class="s0">assert </span><span class="s1">xml.etree.ElementTree.fromstring(hg._repr_html_()) </span><span class="s0">is not None</span>
    <span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">hg.layers.values():</span>
        <span class="s0">assert </span><span class="s1">xml.etree.ElementTree.fromstring(layer._repr_html_()) </span><span class="s0">is not None</span>


<span class="s0">def </span><span class="s1">test_slicing_with_ellipsis():</span>
    <span class="s1">x = np.arange(</span><span class="s3">256</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>

    <span class="s1">assert_eq(d[...</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[...</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">assert_eq(d[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">...</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">...</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_slicing_with_ndarray():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>

    <span class="s1">assert_eq(d[np.arange(</span><span class="s3">8</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">assert_eq(d[np.ones(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=bool)]</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">assert_eq(d[np.array([</span><span class="s3">1</span><span class="s1">])]</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">assert_eq(d[np.array([</span><span class="s0">True, False, True</span><span class="s1">] + [</span><span class="s0">False</span><span class="s1">] * </span><span class="s3">5</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_slicing_flexible_type():</span>
    <span class="s1">a = np.array([[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]])</span>
    <span class="s1">b = da.from_array(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(a[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_slicing_with_object_dtype():</span>
    <span class="s4"># https://github.com/dask/dask/issues/6892</span>
    <span class="s1">d = da.from_array(np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">d.dtype == d[(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)].dtype</span>


<span class="s0">def </span><span class="s1">test_dtype():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">d.dtype == d.compute().dtype</span>
    <span class="s0">assert </span><span class="s1">(d * </span><span class="s3">1.0</span><span class="s1">).dtype == (d + </span><span class="s3">1.0</span><span class="s1">).compute().dtype</span>
    <span class="s0">assert </span><span class="s1">d.sum().dtype == d.sum().compute().dtype  </span><span class="s4"># no shape</span>


<span class="s0">def </span><span class="s1">test_blockdims_from_blockshape():</span>
    <span class="s0">assert </span><span class="s1">blockdims_from_blockshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">pytest.raises(TypeError</span><span class="s0">, lambda</span><span class="s1">: blockdims_from_blockshape((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">blockdims_from_blockshape((</span><span class="s3">1e2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1e1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]) == ((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">blockdims_from_blockshape((np.int8(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)) == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_coerce():</span>
    <span class="s1">d0 = da.from_array(np.array(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">d1 = da.from_array(np.array([</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">dask.config.set(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">):</span>
        <span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">d0</span><span class="s0">, </span><span class="s1">d1:</span>
            <span class="s0">assert </span><span class="s1">bool(d) </span><span class="s0">is True</span>
            <span class="s0">assert </span><span class="s1">int(d) == </span><span class="s3">1</span>
            <span class="s0">assert </span><span class="s1">float(d) == </span><span class="s3">1.0</span>
            <span class="s0">assert </span><span class="s1">complex(d) == complex(</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">a2 = np.arange(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">d2 = da.from_array(a2</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">func </span><span class="s0">in </span><span class="s1">(int</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">complex):</span>
        <span class="s1">pytest.raises(TypeError</span><span class="s0">, lambda </span><span class="s1">func=func: func(d2))</span>


<span class="s0">def </span><span class="s1">test_bool():</span>
    <span class="s1">arr = np.arange(</span><span class="s3">100</span><span class="s1">).reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">darr = da.from_array(arr</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">bool(darr)</span>
        <span class="s1">bool(darr == darr)</span>


<span class="s0">def </span><span class="s1">test_store_kwargs():</span>
    <span class="s1">d = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = d + </span><span class="s3">1</span>

    <span class="s1">called = [</span><span class="s0">False</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">get_func(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">assert </span><span class="s1">kwargs.pop(</span><span class="s2">&quot;foo&quot;</span><span class="s1">) == </span><span class="s2">&quot;test kwarg&quot;</span>
        <span class="s1">r = dask.get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">r</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">store([a]</span><span class="s0">, </span><span class="s1">[at]</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a.store(at</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">store([a]</span><span class="s0">, </span><span class="s1">[at]</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_store_delayed_target():</span>
    <span class="s0">from </span><span class="s1">dask.delayed </span><span class="s0">import </span><span class="s1">delayed</span>

    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = d + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">d + </span><span class="s3">2</span>

    <span class="s4"># empty buffers to be used as targets</span>
    <span class="s1">targs = {}</span>

    <span class="s0">def </span><span class="s1">make_target(key):</span>
        <span class="s1">a = np.empty((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
        <span class="s1">targs[key] = a</span>
        <span class="s0">return </span><span class="s1">a</span>

    <span class="s4"># delayed calls to these targets</span>
    <span class="s1">atd = delayed(make_target)(</span><span class="s2">&quot;at&quot;</span><span class="s1">)</span>
    <span class="s1">btd = delayed(make_target)(</span><span class="s2">&quot;bt&quot;</span><span class="s1">)</span>

    <span class="s4"># test not keeping result</span>
    <span class="s1">st = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[atd</span><span class="s0">, </span><span class="s1">btd])</span>

    <span class="s1">at = targs[</span><span class="s2">&quot;at&quot;</span><span class="s1">]</span>
    <span class="s1">bt = targs[</span><span class="s2">&quot;bt&quot;</span><span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">st </span><span class="s0">is None</span>
    <span class="s1">assert_eq(at</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s1">assert_eq(bt</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s4"># test keeping result</span>
    <span class="s0">for </span><span class="s1">st_compute </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
        <span class="s1">targs.clear()</span>

        <span class="s1">st = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[atd</span><span class="s0">, </span><span class="s1">btd]</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True, </span><span class="s1">compute=st_compute)</span>
        <span class="s0">if </span><span class="s1">st_compute:</span>
            <span class="s0">assert </span><span class="s1">all(</span><span class="s0">not </span><span class="s1">any(dask.core.get_deps(e.dask)[</span><span class="s3">0</span><span class="s1">].values()) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">st)</span>

        <span class="s1">st = dask.compute(*st)</span>

        <span class="s1">at = targs[</span><span class="s2">&quot;at&quot;</span><span class="s1">]</span>
        <span class="s1">bt = targs[</span><span class="s2">&quot;bt&quot;</span><span class="s1">]</span>

        <span class="s0">assert </span><span class="s1">st </span><span class="s0">is not None</span>
        <span class="s0">assert </span><span class="s1">isinstance(st</span><span class="s0">, </span><span class="s1">tuple)</span>
        <span class="s0">assert </span><span class="s1">all([isinstance(v</span><span class="s0">, </span><span class="s1">np.ndarray) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">st])</span>
        <span class="s1">assert_eq(at</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_eq(bt</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_eq(st[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_eq(st[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b)</span>

        <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda </span><span class="s1">at=at</span><span class="s0">, </span><span class="s1">bt=bt: store([a]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]))</span>
        <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda </span><span class="s1">at=at: store(at</span><span class="s0">, </span><span class="s1">at))</span>
        <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda </span><span class="s1">at=at</span><span class="s0">, </span><span class="s1">bt=bt: store([at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]))</span>


<span class="s0">def </span><span class="s1">test_store():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = d + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">d + </span><span class="s3">2</span>

    <span class="s1">at = np.empty(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">bt = np.empty(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">st = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt])</span>
    <span class="s0">assert </span><span class="s1">st </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all()</span>
    <span class="s0">assert </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all()</span>

    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: store([a]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: store(at</span><span class="s0">, </span><span class="s1">at))</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: store([at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]))</span>


<span class="s0">def </span><span class="s1">test_store_regions():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = d + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">d + </span><span class="s3">2</span>
    <span class="s1">a = a[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:</span><span class="s0">, </span><span class="s1">:].astype(float)</span>

    <span class="s1">region = (slice(</span><span class="s0">None, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>

    <span class="s4"># Single region:</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">bt = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">regions=region</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Delayed)</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert </span><span class="s1">all([ev </span><span class="s0">is None for </span><span class="s1">ev </span><span class="s0">in </span><span class="s1">v.compute()])</span>
    <span class="s0">assert </span><span class="s1">(at[region] == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">3</span><span class="s1">).all()</span>
    <span class="s0">assert not </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert not </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all()</span>

    <span class="s4"># Multiple regions:</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">bt = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">regions=[region</span><span class="s0">, </span><span class="s1">region]</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Delayed)</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert </span><span class="s1">all([ev </span><span class="s0">is None for </span><span class="s1">ev </span><span class="s0">in </span><span class="s1">v.compute()])</span>
    <span class="s0">assert </span><span class="s1">(at[region] == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">3</span><span class="s1">).all()</span>
    <span class="s0">assert not </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert not </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all()</span>

    <span class="s4"># Single region (keep result):</span>
    <span class="s0">for </span><span class="s1">st_compute </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
        <span class="s1">at = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
        <span class="s1">bt = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
        <span class="s1">v = store(</span>
            <span class="s1">[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">regions=region</span><span class="s0">, </span><span class="s1">compute=st_compute</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">tuple)</span>
        <span class="s0">assert </span><span class="s1">all([isinstance(e</span><span class="s0">, </span><span class="s1">da.Array) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">v])</span>
        <span class="s0">if </span><span class="s1">st_compute:</span>
            <span class="s0">assert </span><span class="s1">all(</span><span class="s0">not </span><span class="s1">any(dask.core.get_deps(e.dask)[</span><span class="s3">0</span><span class="s1">].values()) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">v)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">0</span><span class="s1">).all()</span>

        <span class="s1">ar</span><span class="s0">, </span><span class="s1">br = v</span>
        <span class="s0">assert </span><span class="s1">ar.dtype == a.dtype</span>
        <span class="s0">assert </span><span class="s1">br.dtype == b.dtype</span>
        <span class="s0">assert </span><span class="s1">ar.shape == a.shape</span>
        <span class="s0">assert </span><span class="s1">br.shape == b.shape</span>
        <span class="s0">assert </span><span class="s1">ar.chunks == a.chunks</span>
        <span class="s0">assert </span><span class="s1">br.chunks == b.chunks</span>

        <span class="s1">ar</span><span class="s0">, </span><span class="s1">br = da.compute(ar</span><span class="s0">, </span><span class="s1">br)</span>
        <span class="s0">assert </span><span class="s1">(at[region] == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">3</span><span class="s1">).all()</span>
        <span class="s0">assert not </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
        <span class="s0">assert not </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">(br == </span><span class="s3">3</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">(ar == </span><span class="s3">2</span><span class="s1">).all()</span>

    <span class="s4"># Multiple regions (keep result):</span>
    <span class="s0">for </span><span class="s1">st_compute </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
        <span class="s1">at = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
        <span class="s1">bt = np.zeros(shape=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
        <span class="s1">v = store(</span>
            <span class="s1">[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">,</span>
            <span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">,</span>
            <span class="s1">regions=[region</span><span class="s0">, </span><span class="s1">region]</span><span class="s0">,</span>
            <span class="s1">compute=st_compute</span><span class="s0">,</span>
            <span class="s1">return_stored=</span><span class="s0">True,</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">tuple)</span>
        <span class="s0">assert </span><span class="s1">all([isinstance(e</span><span class="s0">, </span><span class="s1">da.Array) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">v])</span>
        <span class="s0">if </span><span class="s1">st_compute:</span>
            <span class="s0">assert </span><span class="s1">all(</span><span class="s0">not </span><span class="s1">any(dask.core.get_deps(e.dask)[</span><span class="s3">0</span><span class="s1">].values()) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">v)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">0</span><span class="s1">).all()</span>

        <span class="s1">ar</span><span class="s0">, </span><span class="s1">br = v</span>
        <span class="s0">assert </span><span class="s1">ar.dtype == a.dtype</span>
        <span class="s0">assert </span><span class="s1">br.dtype == b.dtype</span>
        <span class="s0">assert </span><span class="s1">ar.shape == a.shape</span>
        <span class="s0">assert </span><span class="s1">br.shape == b.shape</span>
        <span class="s0">assert </span><span class="s1">ar.chunks == a.chunks</span>
        <span class="s0">assert </span><span class="s1">br.chunks == b.chunks</span>

        <span class="s1">ar</span><span class="s0">, </span><span class="s1">br = da.compute(ar</span><span class="s0">, </span><span class="s1">br)</span>
        <span class="s0">assert </span><span class="s1">(at[region] == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt[region] == </span><span class="s3">3</span><span class="s1">).all()</span>
        <span class="s0">assert not </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
        <span class="s0">assert not </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and not </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">(br == </span><span class="s3">3</span><span class="s1">).all()</span>
        <span class="s0">assert </span><span class="s1">(ar == </span><span class="s3">2</span><span class="s1">).all()</span>


<span class="s0">def </span><span class="s1">test_store_compute_false():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = d + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">d + </span><span class="s3">2</span>

    <span class="s1">at = np.zeros(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">bt = np.zeros(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Delayed)</span>

    <span class="s4"># You need a well-formed HighLevelgraph for e.g. dask.graph_manipulation.bind</span>
    <span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">v.__dask_layers__():</span>
        <span class="s0">assert </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">v.dask.layers</span>

    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert </span><span class="s1">all([ev </span><span class="s0">is None for </span><span class="s1">ev </span><span class="s0">in </span><span class="s1">v.compute()])</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all()</span>

    <span class="s1">at = np.zeros(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">bt = np.zeros(shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">dat</span><span class="s0">, </span><span class="s1">dbt = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False, </span><span class="s1">return_stored=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dat</span><span class="s0">, </span><span class="s1">Array) </span><span class="s0">and </span><span class="s1">isinstance(dbt</span><span class="s0">, </span><span class="s1">Array)</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">0</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt == </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s0">assert </span><span class="s1">(dat.compute() == at).all() </span><span class="s0">and </span><span class="s1">(dbt.compute() == bt).all()</span>
    <span class="s0">assert </span><span class="s1">(at == </span><span class="s3">2</span><span class="s1">).all() </span><span class="s0">and </span><span class="s1">(bt == </span><span class="s3">3</span><span class="s1">).all()</span>


<span class="s0">def </span><span class="s1">test_store_nocompute_regions():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">y = np.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">d1 = da.store(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">regions=(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">d2 = da.store(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">regions=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">d1.key != d2.key</span>


<span class="s0">class </span><span class="s1">ThreadSafetyError(Exception):</span>
    <span class="s0">pass</span>


<span class="s0">class </span><span class="s1">NonthreadSafeStore:</span>
    <span class="s0">def </span><span class="s1">__init__(self):</span>
        <span class="s1">self.in_use = </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">__setitem__(self</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">value):</span>
        <span class="s0">if </span><span class="s1">self.in_use:</span>
            <span class="s0">raise </span><span class="s1">ThreadSafetyError()</span>
        <span class="s1">self.in_use = </span><span class="s0">True</span>
        <span class="s1">time.sleep(</span><span class="s3">0.001</span><span class="s1">)</span>
        <span class="s1">self.in_use = </span><span class="s0">False</span>


<span class="s0">class </span><span class="s1">ThreadSafeStore:</span>
    <span class="s0">def </span><span class="s1">__init__(self):</span>
        <span class="s1">self.concurrent_uses = </span><span class="s3">0</span>
        <span class="s1">self.max_concurrent_uses = </span><span class="s3">0</span>

    <span class="s0">def </span><span class="s1">__setitem__(self</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">value):</span>
        <span class="s1">self.concurrent_uses += </span><span class="s3">1</span>
        <span class="s1">self.max_concurrent_uses = max(self.concurrent_uses</span><span class="s0">, </span><span class="s1">self.max_concurrent_uses)</span>
        <span class="s1">time.sleep(</span><span class="s3">0.01</span><span class="s1">)</span>
        <span class="s1">self.concurrent_uses -= </span><span class="s3">1</span>


<span class="s0">class </span><span class="s1">CounterLock:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.lock = Lock(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

        <span class="s1">self.acquire_count = </span><span class="s3">0</span>
        <span class="s1">self.release_count = </span><span class="s3">0</span>

    <span class="s0">def </span><span class="s1">acquire(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.acquire_count += </span><span class="s3">1</span>
        <span class="s0">return </span><span class="s1">self.lock.acquire(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">release(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self.release_count += </span><span class="s3">1</span>
        <span class="s0">return </span><span class="s1">self.lock.release(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">test_store_locks():</span>
    <span class="s1">_Lock = type(Lock())</span>
    <span class="s1">d = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = d + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">d + </span><span class="s3">2</span>

    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">bt = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>

    <span class="s1">lock = Lock()</span>
    <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False, </span><span class="s1">lock=lock)</span>
    <span class="s0">assert </span><span class="s1">isinstance(v</span><span class="s0">, </span><span class="s1">Delayed)</span>
    <span class="s1">dsk = v.dask</span>
    <span class="s1">locks = {vv </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">dsk.values() </span><span class="s0">for </span><span class="s1">vv </span><span class="s0">in </span><span class="s1">v </span><span class="s0">if </span><span class="s1">isinstance(vv</span><span class="s0">, </span><span class="s1">_Lock)}</span>
    <span class="s0">assert </span><span class="s1">locks == {lock}</span>

    <span class="s4"># Ensure same lock applies over multiple stores</span>
    <span class="s1">at = NonthreadSafeStore()</span>
    <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">at]</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s0">, </span><span class="s1">num_workers=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">v </span><span class="s0">is None</span>

    <span class="s4"># Don't assume thread safety by default</span>
    <span class="s1">at = NonthreadSafeStore()</span>
    <span class="s0">assert </span><span class="s1">store(a</span><span class="s0">, </span><span class="s1">at</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s0">, </span><span class="s1">num_workers=</span><span class="s3">10</span><span class="s1">) </span><span class="s0">is None</span>
    <span class="s0">assert </span><span class="s1">a.store(at</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s0">, </span><span class="s1">num_workers=</span><span class="s3">10</span><span class="s1">) </span><span class="s0">is None</span>

    <span class="s4"># Ensure locks can be removed</span>
    <span class="s1">at = ThreadSafeStore()</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">):</span>
        <span class="s1">st = a.store(at</span><span class="s0">, </span><span class="s1">lock=</span><span class="s0">False, </span><span class="s1">scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s0">, </span><span class="s1">num_workers=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">st </span><span class="s0">is None</span>
        <span class="s0">if </span><span class="s1">at.max_concurrent_uses &gt; </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s0">break</span>
        <span class="s0">if </span><span class="s1">i == </span><span class="s3">9</span><span class="s1">:</span>
            <span class="s0">assert False</span>

    <span class="s4"># Verify number of lock calls</span>
    <span class="s1">nchunks = sum(math.prod(map(len</span><span class="s0">, </span><span class="s1">e.chunks)) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">(a</span><span class="s0">, </span><span class="s1">b))</span>
    <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">(</span><span class="s0">False, True</span><span class="s1">):</span>
        <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
        <span class="s1">bt = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
        <span class="s1">lock = CounterLock()</span>

        <span class="s1">v = store([a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[at</span><span class="s0">, </span><span class="s1">bt]</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">compute=c</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">all(isinstance(e</span><span class="s0">, </span><span class="s1">Array) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">v)</span>

        <span class="s1">da.compute(v)</span>

        <span class="s4"># When `return_stored=True` and `compute=False`,</span>
        <span class="s4"># the lock should be acquired only once for store and load steps</span>
        <span class="s4"># as they are fused together into one step.</span>
        <span class="s0">assert </span><span class="s1">lock.acquire_count == lock.release_count</span>
        <span class="s0">if </span><span class="s1">c:</span>
            <span class="s0">assert </span><span class="s1">lock.acquire_count == </span><span class="s3">2 </span><span class="s1">* nchunks</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">lock.acquire_count == nchunks</span>


<span class="s0">def </span><span class="s1">test_store_method_return():</span>
    <span class="s1">d = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = d + </span><span class="s3">1</span>

    <span class="s0">for </span><span class="s1">compute </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
        <span class="s0">for </span><span class="s1">return_stored </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
            <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
            <span class="s1">r = a.store(</span>
                <span class="s1">at</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s0">, </span><span class="s1">compute=compute</span><span class="s0">, </span><span class="s1">return_stored=return_stored</span>
            <span class="s1">)</span>

            <span class="s0">if </span><span class="s1">return_stored:</span>
                <span class="s0">assert </span><span class="s1">isinstance(r</span><span class="s0">, </span><span class="s1">Array)</span>
            <span class="s0">elif </span><span class="s1">compute:</span>
                <span class="s0">assert </span><span class="s1">r </span><span class="s0">is None</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">isinstance(r</span><span class="s0">, </span><span class="s1">Delayed)</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;can't lock with multiprocessing&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_store_multiprocessing_lock():</span>
    <span class="s1">d = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = d + </span><span class="s3">1</span>

    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">st = a.store(at</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;processes&quot;</span><span class="s0">, </span><span class="s1">num_workers=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">st </span><span class="s0">is None</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;return_stored&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;delayed_target&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_store_deterministic_keys(return_stored</span><span class="s0">, </span><span class="s1">delayed_target):</span>
    <span class="s1">a = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">at = np.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">delayed_target:</span>
        <span class="s1">at = delayed(at)</span>
    <span class="s1">st1 = a.store(at</span><span class="s0">, </span><span class="s1">return_stored=return_stored</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">st2 = a.store(at</span><span class="s0">, </span><span class="s1">return_stored=return_stored</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">st1.dask.keys() == st2.dask.keys()</span>


<span class="s0">def </span><span class="s1">test_to_hdf5():</span>
    <span class="s1">h5py = pytest.importorskip(</span><span class="s2">&quot;h5py&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = da.ones(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">x.to_hdf5(fn</span><span class="s0">, </span><span class="s2">&quot;/x&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r+&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f[</span><span class="s2">&quot;/x&quot;</span><span class="s1">]</span>

            <span class="s1">assert_eq(d[:]</span><span class="s0">, </span><span class="s1">x)</span>
            <span class="s0">assert </span><span class="s1">d.chunks == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">x.to_hdf5(fn</span><span class="s0">, </span><span class="s2">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r+&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f[</span><span class="s2">&quot;/x&quot;</span><span class="s1">]</span>

            <span class="s1">assert_eq(d[:]</span><span class="s0">, </span><span class="s1">x)</span>
            <span class="s0">assert </span><span class="s1">d.chunks </span><span class="s0">is None</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">x.to_hdf5(fn</span><span class="s0">, </span><span class="s2">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r+&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f[</span><span class="s2">&quot;/x&quot;</span><span class="s1">]</span>

            <span class="s1">assert_eq(d[:]</span><span class="s0">, </span><span class="s1">x)</span>
            <span class="s0">assert </span><span class="s1">d.chunks == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">da.to_hdf5(fn</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;/x&quot;</span><span class="s1">: x</span><span class="s0">, </span><span class="s2">&quot;/y&quot;</span><span class="s1">: y})</span>

        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r+&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">assert_eq(f[</span><span class="s2">&quot;/x&quot;</span><span class="s1">][:]</span><span class="s0">, </span><span class="s1">x)</span>
            <span class="s0">assert </span><span class="s1">f[</span><span class="s2">&quot;/x&quot;</span><span class="s1">].chunks == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
            <span class="s1">assert_eq(f[</span><span class="s2">&quot;/y&quot;</span><span class="s1">][:]</span><span class="s0">, </span><span class="s1">y)</span>
            <span class="s0">assert </span><span class="s1">f[</span><span class="s2">&quot;/y&quot;</span><span class="s1">].chunks == (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_dask_dataframe():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">a = da.ones((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">d = a.to_dask_dataframe()</span>
    <span class="s0">assert </span><span class="s1">isinstance(d</span><span class="s0">, </span><span class="s1">dd.Series)</span>

    <span class="s1">a = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">d = a.to_dask_dataframe()</span>
    <span class="s0">assert </span><span class="s1">isinstance(d</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>


<span class="s0">def </span><span class="s1">test_np_array_with_zero_dimensions():</span>
    <span class="s1">d = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.array(d.sum())</span><span class="s0">, </span><span class="s1">np.array(d.compute().sum()))</span>


<span class="s0">def </span><span class="s1">test_dtype_complex():</span>
    <span class="s1">x = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)).astype(</span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)).astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
    <span class="s1">z = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)).astype(</span><span class="s2">&quot;i2&quot;</span><span class="s1">)</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">c = da.from_array(z</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">return </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">np.dtype) </span><span class="s0">and </span><span class="s1">isinstance(b</span><span class="s0">, </span><span class="s1">np.dtype) </span><span class="s0">and </span><span class="s1">str(a) == str(b)</span>

    <span class="s1">assert_eq(a.dtype</span><span class="s0">, </span><span class="s1">x.dtype)</span>
    <span class="s1">assert_eq(b.dtype</span><span class="s0">, </span><span class="s1">y.dtype)</span>

    <span class="s1">assert_eq((a + </span><span class="s3">1</span><span class="s1">).dtype</span><span class="s0">, </span><span class="s1">(x + </span><span class="s3">1</span><span class="s1">).dtype)</span>
    <span class="s1">assert_eq((a + b).dtype</span><span class="s0">, </span><span class="s1">(x + y).dtype)</span>
    <span class="s1">assert_eq(a.T.dtype</span><span class="s0">, </span><span class="s1">x.T.dtype)</span>
    <span class="s1">assert_eq(a[:</span><span class="s3">3</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">3</span><span class="s1">].dtype)</span>
    <span class="s1">assert_eq((a.dot(b.T)).dtype</span><span class="s0">, </span><span class="s1">(x.dot(y.T)).dtype)</span>

    <span class="s1">assert_eq(stack([a</span><span class="s0">, </span><span class="s1">b]).dtype</span><span class="s0">, </span><span class="s1">np.vstack([x</span><span class="s0">, </span><span class="s1">y]).dtype)</span>
    <span class="s1">assert_eq(concatenate([a</span><span class="s0">, </span><span class="s1">b]).dtype</span><span class="s0">, </span><span class="s1">np.concatenate([x</span><span class="s0">, </span><span class="s1">y]).dtype)</span>

    <span class="s1">assert_eq(b.std().dtype</span><span class="s0">, </span><span class="s1">y.std().dtype)</span>
    <span class="s1">assert_eq(c.sum().dtype</span><span class="s0">, </span><span class="s1">z.sum().dtype)</span>
    <span class="s1">assert_eq(a.min().dtype</span><span class="s0">, </span><span class="s1">a.min().dtype)</span>
    <span class="s1">assert_eq(b.std().dtype</span><span class="s0">, </span><span class="s1">b.std().dtype)</span>
    <span class="s1">assert_eq(a.argmin(axis=</span><span class="s3">0</span><span class="s1">).dtype</span><span class="s0">, </span><span class="s1">a.argmin(axis=</span><span class="s3">0</span><span class="s1">).dtype)</span>

    <span class="s1">assert_eq(da.sin(c).dtype</span><span class="s0">, </span><span class="s1">np.sin(z).dtype)</span>
    <span class="s1">assert_eq(da.exp(b).dtype</span><span class="s0">, </span><span class="s1">np.exp(y).dtype)</span>
    <span class="s1">assert_eq(da.floor(a).dtype</span><span class="s0">, </span><span class="s1">np.floor(x).dtype)</span>
    <span class="s1">assert_eq(da.isnan(b).dtype</span><span class="s0">, </span><span class="s1">np.isnan(y).dtype)</span>
    <span class="s0">with </span><span class="s1">contextlib.suppress(ImportError):</span>
        <span class="s0">assert </span><span class="s1">da.isnull(b).dtype == </span><span class="s2">&quot;bool&quot;</span>
        <span class="s0">assert </span><span class="s1">da.notnull(b).dtype == </span><span class="s2">&quot;bool&quot;</span>

    <span class="s1">x = np.array([(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=[(</span><span class="s2">&quot;text&quot;</span><span class="s0">, </span><span class="s2">&quot;S1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;numbers&quot;</span><span class="s0">, </span><span class="s2">&quot;i4&quot;</span><span class="s1">)])</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(d[</span><span class="s2">&quot;text&quot;</span><span class="s1">].dtype</span><span class="s0">, </span><span class="s1">x[</span><span class="s2">&quot;text&quot;</span><span class="s1">].dtype)</span>
    <span class="s1">assert_eq(d[[</span><span class="s2">&quot;numbers&quot;</span><span class="s0">, </span><span class="s2">&quot;text&quot;</span><span class="s1">]].dtype</span><span class="s0">, </span><span class="s1">x[[</span><span class="s2">&quot;numbers&quot;</span><span class="s0">, </span><span class="s2">&quot;text&quot;</span><span class="s1">]].dtype)</span>


<span class="s0">def </span><span class="s1">test_astype():</span>
    <span class="s1">x = np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">).dtype == </span><span class="s2">&quot;i8&quot;</span>
    <span class="s1">assert_eq(d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">casting=</span><span class="s2">&quot;safe&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">not_a_real_kwarg=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s4"># smoketest with kwargs</span>
    <span class="s1">assert_eq(d.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.astype(</span><span class="s2">&quot;i8&quot;</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">))</span>

    <span class="s4"># Check it's a noop</span>
    <span class="s0">assert </span><span class="s1">d.astype(</span><span class="s2">&quot;f8&quot;</span><span class="s1">) </span><span class="s0">is </span><span class="s1">d</span>


<span class="s0">def </span><span class="s1">test_astype_gh1151():</span>
    <span class="s1">a = np.arange(</span><span class="s3">5</span><span class="s1">).astype(np.int32)</span>
    <span class="s1">b = da.from_array(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(a.astype(np.int16)</span><span class="s0">, </span><span class="s1">b.astype(np.int16))</span>


<span class="s0">def </span><span class="s1">test_astype_gh9318():</span>
    <span class="s4"># `order`` kwarg in `astype` should not cause an error</span>
    <span class="s1">a = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">)</span>
    <span class="s1">b = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">result_a = a.astype(float</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>
    <span class="s1">result_b = b.astype(float</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)  </span><span class="s4"># if no error at this line, pytest passes</span>
    <span class="s1">assert_eq(result_a</span><span class="s0">, </span><span class="s1">result_b)  </span><span class="s4"># won't check the order matches, but checks results</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;Github issue https://github.com/dask/dask/issues/9316&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_astype_gh9316():</span>
    <span class="s4"># Issue https://github.com/dask/dask/issues/9316</span>
    <span class="s4"># Can be combined with test_astype_gh9318 above when XFAIL marker is removed</span>
    <span class="s1">a = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">)</span>
    <span class="s1">b = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">result_a = a.astype(float</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>
    <span class="s1">result_b = b.astype(float</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>
    <span class="s1">result_b = result_b.compute()</span>
    <span class="s0">assert </span><span class="s1">result_a.flags.c_contiguous == result_b.flags.c_contiguous</span>
    <span class="s0">assert </span><span class="s1">result_a.flags.f_contiguous == result_b.flags.f_contiguous</span>


<span class="s0">def </span><span class="s1">test_arithmetic():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">).astype(</span><span class="s2">&quot;f4&quot;</span><span class="s1">) + </span><span class="s3">2</span>
    <span class="s1">y = np.arange(</span><span class="s3">5</span><span class="s1">).astype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">) + </span><span class="s3">2</span>
    <span class="s1">z = np.arange(</span><span class="s3">5</span><span class="s1">).astype(</span><span class="s2">&quot;i4&quot;</span><span class="s1">) + </span><span class="s3">2</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">c = da.from_array(z</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(a + b</span><span class="s0">, </span><span class="s1">x + y)</span>
    <span class="s1">assert_eq(a * b</span><span class="s0">, </span><span class="s1">x * y)</span>
    <span class="s1">assert_eq(a - b</span><span class="s0">, </span><span class="s1">x - y)</span>
    <span class="s1">assert_eq(a / b</span><span class="s0">, </span><span class="s1">x / y)</span>
    <span class="s1">assert_eq(b &amp; b</span><span class="s0">, </span><span class="s1">y &amp; y)</span>
    <span class="s1">assert_eq(b | b</span><span class="s0">, </span><span class="s1">y | y)</span>
    <span class="s1">assert_eq(b ^ b</span><span class="s0">, </span><span class="s1">y ^ y)</span>
    <span class="s1">assert_eq(a // b</span><span class="s0">, </span><span class="s1">x // y)</span>
    <span class="s1">assert_eq(a**b</span><span class="s0">, </span><span class="s1">x**y)</span>
    <span class="s1">assert_eq(a % b</span><span class="s0">, </span><span class="s1">x % y)</span>
    <span class="s1">assert_eq(a &gt; b</span><span class="s0">, </span><span class="s1">x &gt; y)</span>
    <span class="s1">assert_eq(a &lt; b</span><span class="s0">, </span><span class="s1">x &lt; y)</span>
    <span class="s1">assert_eq(a &gt;= b</span><span class="s0">, </span><span class="s1">x &gt;= y)</span>
    <span class="s1">assert_eq(a &lt;= b</span><span class="s0">, </span><span class="s1">x &lt;= y)</span>
    <span class="s1">assert_eq(a == b</span><span class="s0">, </span><span class="s1">x == y)</span>
    <span class="s1">assert_eq(a != b</span><span class="s0">, </span><span class="s1">x != y)</span>

    <span class="s1">assert_eq(a + </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a - </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x - </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a / </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x / </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(b &amp; </span><span class="s0">True, </span><span class="s1">y &amp; </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(b | </span><span class="s0">True, </span><span class="s1">y | </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(b ^ </span><span class="s0">True, </span><span class="s1">y ^ </span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(a // </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x // </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a**</span><span class="s3">2</span><span class="s0">, </span><span class="s1">x**</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a % </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x % </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a &gt; </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x &gt; </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a &lt; </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x &lt; </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a &gt;= </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x &gt;= </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a &lt;= </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x &lt;= </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a == </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x == </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(a != </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x != </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">+ b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">+ y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">* b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">- b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">- y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">/ b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">/ y)</span>
    <span class="s1">assert_eq(</span><span class="s0">True </span><span class="s1">&amp; b</span><span class="s0">, True </span><span class="s1">&amp; y)</span>
    <span class="s1">assert_eq(</span><span class="s0">True </span><span class="s1">| b</span><span class="s0">, True </span><span class="s1">| y)</span>
    <span class="s1">assert_eq(</span><span class="s0">True </span><span class="s1">^ b</span><span class="s0">, True </span><span class="s1">^ y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">// b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">// y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2</span><span class="s1">**b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">**y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">% b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">% y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">&gt; b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">&gt; y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">&lt; b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">&lt; y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">&gt;= b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">&gt;= y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">&lt;= b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">&lt;= y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">== b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">== y)</span>
    <span class="s1">assert_eq(</span><span class="s3">2 </span><span class="s1">!= b</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">!= y)</span>

    <span class="s1">assert_eq(-a</span><span class="s0">, </span><span class="s1">-x)</span>
    <span class="s1">assert_eq(abs(a)</span><span class="s0">, </span><span class="s1">abs(x))</span>
    <span class="s1">assert_eq(~(a == b)</span><span class="s0">, </span><span class="s1">~(x == y))</span>
    <span class="s1">assert_eq(~(a == b)</span><span class="s0">, </span><span class="s1">~(x == y))</span>

    <span class="s1">assert_eq(da.logaddexp(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">np.logaddexp(x</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.logaddexp2(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">np.logaddexp2(x</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.exp(b)</span><span class="s0">, </span><span class="s1">np.exp(y))</span>
    <span class="s1">assert_eq(da.log(a)</span><span class="s0">, </span><span class="s1">np.log(x))</span>
    <span class="s1">assert_eq(da.log10(a)</span><span class="s0">, </span><span class="s1">np.log10(x))</span>
    <span class="s1">assert_eq(da.log1p(a)</span><span class="s0">, </span><span class="s1">np.log1p(x))</span>
    <span class="s1">assert_eq(da.expm1(b)</span><span class="s0">, </span><span class="s1">np.expm1(y))</span>
    <span class="s1">assert_eq(da.sqrt(a)</span><span class="s0">, </span><span class="s1">np.sqrt(x))</span>
    <span class="s1">assert_eq(da.square(a)</span><span class="s0">, </span><span class="s1">np.square(x))</span>

    <span class="s1">assert_eq(da.sin(a)</span><span class="s0">, </span><span class="s1">np.sin(x))</span>
    <span class="s1">assert_eq(da.cos(b)</span><span class="s0">, </span><span class="s1">np.cos(y))</span>
    <span class="s1">assert_eq(da.tan(a)</span><span class="s0">, </span><span class="s1">np.tan(x))</span>
    <span class="s1">assert_eq(da.arcsin(b / </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arcsin(y / </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.arccos(b / </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arccos(y / </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.arctan(b / </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arctan(y / </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.arctan2(b * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s1">np.arctan2(y * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">x))</span>
    <span class="s1">assert_eq(da.hypot(b</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s1">np.hypot(y</span><span class="s0">, </span><span class="s1">x))</span>
    <span class="s1">assert_eq(da.sinh(a)</span><span class="s0">, </span><span class="s1">np.sinh(x))</span>
    <span class="s1">assert_eq(da.cosh(b)</span><span class="s0">, </span><span class="s1">np.cosh(y))</span>
    <span class="s1">assert_eq(da.tanh(a)</span><span class="s0">, </span><span class="s1">np.tanh(x))</span>
    <span class="s1">assert_eq(da.arcsinh(b * </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arcsinh(y * </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.arccosh(b * </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arccosh(y * </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.arctanh(b / </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arctanh(y / </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.deg2rad(a)</span><span class="s0">, </span><span class="s1">np.deg2rad(x))</span>
    <span class="s1">assert_eq(da.rad2deg(a)</span><span class="s0">, </span><span class="s1">np.rad2deg(x))</span>

    <span class="s1">assert_eq(da.logical_and(a &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">b &lt; </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.logical_and(x &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y &lt; </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.logical_or(a &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">b &lt; </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.logical_or(x &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y &lt; </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.logical_xor(a &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">b &lt; </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.logical_xor(x &lt; </span><span class="s3">1</span><span class="s0">, </span><span class="s1">y &lt; </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.logical_not(a &lt; </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.logical_not(x &lt; </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.maximum(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a)</span><span class="s0">, </span><span class="s1">np.maximum(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a))</span>
    <span class="s1">assert_eq(da.minimum(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a)</span><span class="s0">, </span><span class="s1">np.minimum(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a))</span>
    <span class="s1">assert_eq(da.fmax(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a)</span><span class="s0">, </span><span class="s1">np.fmax(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a))</span>
    <span class="s1">assert_eq(da.fmin(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a)</span><span class="s0">, </span><span class="s1">np.fmin(a</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">- a))</span>

    <span class="s1">assert_eq(da.isreal(a + </span><span class="s3">1j </span><span class="s1">* b)</span><span class="s0">, </span><span class="s1">np.isreal(x + </span><span class="s3">1j </span><span class="s1">* y))</span>
    <span class="s1">assert_eq(da.iscomplex(a + </span><span class="s3">1j </span><span class="s1">* b)</span><span class="s0">, </span><span class="s1">np.iscomplex(x + </span><span class="s3">1j </span><span class="s1">* y))</span>
    <span class="s1">assert_eq(da.isfinite(a)</span><span class="s0">, </span><span class="s1">np.isfinite(x))</span>
    <span class="s1">assert_eq(da.isinf(a)</span><span class="s0">, </span><span class="s1">np.isinf(x))</span>
    <span class="s1">assert_eq(da.isnan(a)</span><span class="s0">, </span><span class="s1">np.isnan(x))</span>
    <span class="s1">assert_eq(da.signbit(a - </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.signbit(x - </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.copysign(a - </span><span class="s3">3</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">np.copysign(x - </span><span class="s3">3</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.nextafter(a - </span><span class="s3">3</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">np.nextafter(x - </span><span class="s3">3</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.ldexp(c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">np.ldexp(z</span><span class="s0">, </span><span class="s1">z))</span>
    <span class="s1">assert_eq(da.fmod(a * </span><span class="s3">12</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">np.fmod(x * </span><span class="s3">12</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.floor(a * </span><span class="s3">0.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.floor(x * </span><span class="s3">0.5</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.ceil(a)</span><span class="s0">, </span><span class="s1">np.ceil(x))</span>
    <span class="s1">assert_eq(da.trunc(a / </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.trunc(x / </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.degrees(b)</span><span class="s0">, </span><span class="s1">np.degrees(y))</span>
    <span class="s1">assert_eq(da.radians(a)</span><span class="s0">, </span><span class="s1">np.radians(x))</span>

    <span class="s1">assert_eq(da.rint(a + </span><span class="s3">0.3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.rint(x + </span><span class="s3">0.3</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.fix(a - </span><span class="s3">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.fix(x - </span><span class="s3">2.5</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.angle(a + </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.angle(x + </span><span class="s3">1j</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.real(a + </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.real(x + </span><span class="s3">1j</span><span class="s1">))</span>
    <span class="s1">assert_eq((a + </span><span class="s3">1j</span><span class="s1">).real</span><span class="s0">, </span><span class="s1">np.real(x + </span><span class="s3">1j</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.imag(a + </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.imag(x + </span><span class="s3">1j</span><span class="s1">))</span>
    <span class="s1">assert_eq((a + </span><span class="s3">1j</span><span class="s1">).imag</span><span class="s0">, </span><span class="s1">np.imag(x + </span><span class="s3">1j</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.conj(a + </span><span class="s3">1j </span><span class="s1">* b)</span><span class="s0">, </span><span class="s1">np.conj(x + </span><span class="s3">1j </span><span class="s1">* y))</span>
    <span class="s1">assert_eq((a + </span><span class="s3">1j </span><span class="s1">* b).conj()</span><span class="s0">, </span><span class="s1">(x + </span><span class="s3">1j </span><span class="s1">* y).conj())</span>

    <span class="s1">assert_eq(da.clip(b</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.clip(y</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(b.clip(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y.clip(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.fabs(b)</span><span class="s0">, </span><span class="s1">np.fabs(y))</span>
    <span class="s1">assert_eq(da.sign(b - </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.sign(y - </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.absolute(b - </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.absolute(y - </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.absolute(b - </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.absolute(y - </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">))</span>

    <span class="s1">l1</span><span class="s0">, </span><span class="s1">l2 = da.frexp(a)</span>
    <span class="s1">r1</span><span class="s0">, </span><span class="s1">r2 = np.frexp(x)</span>
    <span class="s1">assert_eq(l1</span><span class="s0">, </span><span class="s1">r1)</span>
    <span class="s1">assert_eq(l2</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s1">l1</span><span class="s0">, </span><span class="s1">l2 = da.modf(a)</span>
    <span class="s1">r1</span><span class="s0">, </span><span class="s1">r2 = np.modf(x)</span>
    <span class="s1">assert_eq(l1</span><span class="s0">, </span><span class="s1">r1)</span>
    <span class="s1">assert_eq(l2</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s1">assert_eq(da.around(a</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.around(x</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_elemwise_consistent_names():</span>
    <span class="s1">a = da.from_array(np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(a + b</span><span class="s0">, </span><span class="s1">a + b)</span>
    <span class="s0">assert </span><span class="s1">same_keys(a + </span><span class="s3">2</span><span class="s0">, </span><span class="s1">a + </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.exp(a)</span><span class="s0">, </span><span class="s1">da.exp(a))</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.exp(a</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.exp(a</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.maximum(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">da.maximum(a</span><span class="s0">, </span><span class="s1">b))</span>


<span class="s0">def </span><span class="s1">test_optimize():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">).astype(</span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">expr = a[</span><span class="s3">1</span><span class="s1">:</span><span class="s3">4</span><span class="s1">] + </span><span class="s3">1</span>
    <span class="s1">result = optimize(expr.dask</span><span class="s0">, </span><span class="s1">expr.__dask_keys__())</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">dict)</span>
    <span class="s0">assert </span><span class="s1">all(key </span><span class="s0">in </span><span class="s1">result </span><span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">expr.__dask_keys__())</span>


<span class="s0">def </span><span class="s1">test_slicing_with_non_ndarrays():</span>
    <span class="s0">class </span><span class="s1">ARangeSlice:</span>
        <span class="s1">dtype = np.dtype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
        <span class="s1">ndim = </span><span class="s3">1</span>

        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">start</span><span class="s0">, </span><span class="s1">stop):</span>
            <span class="s1">self.start = start</span>
            <span class="s1">self.stop = stop</span>

        <span class="s0">def </span><span class="s1">__array__(self):</span>
            <span class="s0">return </span><span class="s1">np.arange(self.start</span><span class="s0">, </span><span class="s1">self.stop)</span>

    <span class="s0">class </span><span class="s1">ARangeSlicable:</span>
        <span class="s1">dtype = np.dtype(</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
        <span class="s1">ndim = </span><span class="s3">1</span>

        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">n):</span>
            <span class="s1">self.n = n</span>

        <span class="s1">@property</span>
        <span class="s0">def </span><span class="s1">shape(self):</span>
            <span class="s0">return </span><span class="s1">(self.n</span><span class="s0">,</span><span class="s1">)</span>

        <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">key):</span>
            <span class="s0">return </span><span class="s1">ARangeSlice(key[</span><span class="s3">0</span><span class="s1">].start</span><span class="s0">, </span><span class="s1">key[</span><span class="s3">0</span><span class="s1">].stop)</span>

    <span class="s1">x = da.from_array(ARangeSlicable(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq((x + </span><span class="s3">1</span><span class="s1">).sum()</span><span class="s0">, </span><span class="s1">(np.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=x.dtype) + </span><span class="s3">1</span><span class="s1">).sum())</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:the matrix subclass&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_getter():</span>
    <span class="s0">assert </span><span class="s1">type(getter(np.matrix([[</span><span class="s3">1</span><span class="s1">]])</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)) </span><span class="s0">is </span><span class="s1">np.ndarray</span>
    <span class="s0">assert </span><span class="s1">type(getter(np.matrix([[</span><span class="s3">1</span><span class="s1">]])</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">asarray=</span><span class="s0">False</span><span class="s1">)) </span><span class="s0">is </span><span class="s1">np.matrix</span>
    <span class="s1">assert_eq(getter([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]))</span>

    <span class="s1">assert_eq(getter(np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">slice(</span><span class="s0">None, None</span><span class="s1">)))</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:])</span>


<span class="s0">def </span><span class="s1">test_size():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.size == np.array(x).size</span>
    <span class="s0">assert </span><span class="s1">isinstance(x.size</span><span class="s0">, </span><span class="s1">int)</span>


<span class="s0">def </span><span class="s1">test_nbytes():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.nbytes == np.array(x).nbytes</span>


<span class="s0">def </span><span class="s1">test_itemsize():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.itemsize == </span><span class="s3">8</span>


<span class="s0">def </span><span class="s1">test_Array_normalizes_dtype():</span>
    <span class="s1">x = da.ones((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s0">assert </span><span class="s1">isinstance(x.dtype</span><span class="s0">, </span><span class="s1">np.dtype)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_from_array_with_lock(inline_array):</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">class </span><span class="s1">FussyLock(SerializableLock):</span>
        <span class="s0">def </span><span class="s1">acquire(self</span><span class="s0">, </span><span class="s1">blocking=</span><span class="s0">True, </span><span class="s1">timeout=-</span><span class="s3">1</span><span class="s1">):</span>
            <span class="s0">if </span><span class="s1">self.locked():</span>
                <span class="s0">raise </span><span class="s1">RuntimeError(</span><span class="s2">&quot;I am locked&quot;</span><span class="s1">)</span>
            <span class="s0">return </span><span class="s1">super().acquire(blocking</span><span class="s0">, </span><span class="s1">timeout)</span>

    <span class="s1">lock = FussyLock()</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">inline_array=inline_array)</span>

    <span class="s1">lock.acquire()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError):</span>
        <span class="s1">d.compute()</span>

    <span class="s1">lock.release()</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">x)</span>

    <span class="s1">lock = CounterLock()</span>
    <span class="s1">e = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">inline_array=inline_array)</span>

    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s4"># Note: the specific counts for composite arithmetic operations can vary</span>
    <span class="s4"># significantly based on the complexity of the computation, whether we are inlining,</span>
    <span class="s4"># and optimization fusion settings. But for this simple comparison it seems pretty</span>
    <span class="s4"># stable.</span>
    <span class="s0">assert </span><span class="s1">lock.release_count == </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">lock.acquire_count == </span><span class="s3">2</span>


<span class="s0">class </span><span class="s1">MyArray:</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.x = x</span>
        <span class="s1">self.dtype = x.dtype</span>
        <span class="s1">self.shape = x.shape</span>
        <span class="s1">self.ndim = len(x.shape)</span>

    <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">i):</span>
        <span class="s0">return </span><span class="s1">self.x[i]</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;x,chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.arange(</span><span class="s3">25</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.arange(</span><span class="s3">25</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([[</span><span class="s3">1</span><span class="s1">]])</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_from_array_tasks_always_call_getter(x</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">inline_array):</span>
    <span class="s1">dx = da.from_array(</span>
        <span class="s1">MyArray(x)</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">asarray=</span><span class="s0">False, </span><span class="s1">inline_array=inline_array</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.ma.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">mask=[[</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, False</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.ma.array([</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">mask=[</span><span class="s0">True</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.ma.array([</span><span class="s3">1.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">mask=[</span><span class="s0">True</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.ma.array(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">mask=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.ma.array(</span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">mask=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_from_array_ndarray_onechunk(x):</span>
    <span class="s5">&quot;&quot;&quot;ndarray with a single chunk produces a minimal single key dict&quot;&quot;&quot;</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>
    <span class="s0">assert </span><span class="s1">len(dx.dask) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">dx.dask[(dx.name</span><span class="s0">,</span><span class="s1">) + (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * dx.ndim] </span><span class="s0">is </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">test_from_array_ndarray_getitem():</span>
    <span class="s5">&quot;&quot;&quot;For ndarray, don't use getter / getter_nofancy; use the cleaner 
    operator.getitem&quot;&quot;&quot;</span>
    <span class="s1">x = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>
    <span class="s0">assert </span><span class="s1">(dx.dask[dx.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])).all()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">memoryview(</span><span class="s6">b&quot;abc&quot;</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_from_array_list(x):</span>
    <span class="s5">&quot;&quot;&quot;Lists, tuples, and memoryviews are automatically converted to ndarray&quot;&quot;&quot;</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(np.array(x)</span><span class="s0">, </span><span class="s1">dx)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dx.dask[dx.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(np.array(x)</span><span class="s0">, </span><span class="s1">dx)</span>
    <span class="s0">assert </span><span class="s1">dx.dask[dx.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">] == x[</span><span class="s3">0</span><span class="s1">]</span>


<span class="s4"># On MacOS Python 3.9, the order of the np.ScalarType tuple randomly changes across</span>
<span class="s4"># interpreter restarts, thus causing pytest-xdist failures; setting PYTHONHASHSEED does</span>
<span class="s4"># not help</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;type_&quot;</span><span class="s0">, </span><span class="s1">sorted((t </span><span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">np.ScalarType </span><span class="s0">if </span><span class="s1">t </span><span class="s0">is not </span><span class="s1">memoryview)</span><span class="s0">, </span><span class="s1">key=str)</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_from_array_scalar(type_):</span>
    <span class="s5">&quot;&quot;&quot;Python and numpy scalars are automatically converted to ndarray&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">type_ == np.datetime64:</span>
        <span class="s1">x = np.datetime64(</span><span class="s2">&quot;2000-01-01&quot;</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">x = type_(</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(np.array(x)</span><span class="s0">, </span><span class="s1">dx)</span>
    <span class="s0">assert </span><span class="s1">isinstance(</span>
        <span class="s1">dx.dask[dx.name</span><span class="s0">,</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">np.ndarray</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;asarray,cls&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">True, </span><span class="s1">np.ndarray)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, </span><span class="s1">np.matrix)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:the matrix subclass&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_from_array_no_asarray(asarray</span><span class="s0">, </span><span class="s1">cls</span><span class="s0">, </span><span class="s1">inline_array):</span>
    <span class="s0">def </span><span class="s1">assert_chunks_are_of_type(x):</span>
        <span class="s1">chunks = compute_as_if_collection(Array</span><span class="s0">, </span><span class="s1">x.dask</span><span class="s0">, </span><span class="s1">x.__dask_keys__())</span>
        <span class="s4"># If it's a tuple of tuples we want to concat, but if it's a tuple</span>
        <span class="s4"># of 1d arrays, we just want to iterate directly</span>
        <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">concat(chunks) </span><span class="s0">if </span><span class="s1">isinstance(chunks[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">tuple) </span><span class="s0">else </span><span class="s1">chunks:</span>
            <span class="s0">assert </span><span class="s1">type(c) </span><span class="s0">is </span><span class="s1">cls</span>

    <span class="s1">x = np.matrix(np.arange(</span><span class="s3">100</span><span class="s1">).reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">asarray=asarray</span><span class="s0">, </span><span class="s1">inline_array=inline_array)</span>
    <span class="s1">assert_chunks_are_of_type(dx)</span>
    <span class="s1">assert_chunks_are_of_type(dx[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">assert_chunks_are_of_type(dx[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">5</span><span class="s1">][:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;wrap&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_from_array_getitem(wrap</span><span class="s0">, </span><span class="s1">inline_array):</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">called = </span><span class="s0">False</span>

    <span class="s0">def </span><span class="s1">my_getitem(a</span><span class="s0">, </span><span class="s1">ind):</span>
        <span class="s0">nonlocal </span><span class="s1">called</span>
        <span class="s1">called = </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">a[ind]</span>

    <span class="s1">xx = MyArray(x) </span><span class="s0">if </span><span class="s1">wrap </span><span class="s0">else </span><span class="s1">x</span>
    <span class="s1">y = da.from_array(xx</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">getitem=my_getitem</span><span class="s0">, </span><span class="s1">inline_array=inline_array)</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s4"># If we have a raw numpy array we eagerly slice, so custom getters</span>
    <span class="s4"># are not called.</span>
    <span class="s0">assert </span><span class="s1">called </span><span class="s0">is </span><span class="s1">wrap</span>


<span class="s0">def </span><span class="s1">test_from_array_minus_one():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_array_copy_noop(chunks):</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/9533</span>
    <span class="s4"># Which is a revert of the solution for https://github.com/dask/dask/issues/3751</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">y_c = y.copy()</span>
    <span class="s0">assert </span><span class="s1">y.name == y_c.name</span>


<span class="s0">def </span><span class="s1">test_from_array_dask_array():</span>
    <span class="s1">x = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.from_array(dx)</span>


<span class="s0">def </span><span class="s1">test_from_array_dask_collection_warns():</span>
    <span class="s0">class </span><span class="s1">CustomCollection(np.ndarray):</span>
        <span class="s0">def </span><span class="s1">__dask_graph__(self):</span>
            <span class="s0">return </span><span class="s1">{</span><span class="s2">&quot;bar&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span>

    <span class="s1">x = CustomCollection([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
        <span class="s1">da.from_array(x)</span>

    <span class="s4"># Ensure da.array warns too</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
        <span class="s1">da.array(x)</span>


<span class="s0">def </span><span class="s1">test_from_array_inline():</span>
    <span class="s0">class </span><span class="s1">MyArray(np.ndarray):</span>
        <span class="s0">pass</span>

    <span class="s1">a = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]).view(MyArray)</span>
    <span class="s1">dsk = dict(da.from_array(a</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;my-array&quot;</span><span class="s0">, </span><span class="s1">inline_array=</span><span class="s0">False</span><span class="s1">).dask)</span>
    <span class="s0">assert </span><span class="s1">dsk[</span><span class="s2">&quot;original-my-array&quot;</span><span class="s1">] </span><span class="s0">is </span><span class="s1">a</span>

    <span class="s1">dsk = dict(da.from_array(a</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;my-array&quot;</span><span class="s0">, </span><span class="s1">inline_array=</span><span class="s0">True</span><span class="s1">).dask)</span>
    <span class="s0">assert </span><span class="s2">&quot;original-my-array&quot; </span><span class="s0">not in </span><span class="s1">dsk</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;asarray&quot;</span><span class="s0">, </span><span class="s1">[da.asarray</span><span class="s0">, </span><span class="s1">da.asanyarray])</span>
<span class="s0">def </span><span class="s1">test_asarray(asarray):</span>
    <span class="s1">assert_eq(asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span>

    <span class="s1">x = asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">asarray(x) </span><span class="s0">is </span><span class="s1">x</span>

    <span class="s1">y = [x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">2</span><span class="s1">]]</span>
    <span class="s1">assert_eq(asarray(y)</span><span class="s0">, </span><span class="s1">x)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;asarray&quot;</span><span class="s0">, </span><span class="s1">[da.asarray</span><span class="s0">, </span><span class="s1">da.asanyarray])</span>
<span class="s0">def </span><span class="s1">test_asarray_dask_dataframe(asarray):</span>
    <span class="s4"># https://github.com/dask/dask/issues/3885</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>

    <span class="s1">s = dd.from_pandas(pd.Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">result = asarray(s)</span>
    <span class="s1">expected = s.values</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">df = s.to_frame(name=</span><span class="s2">&quot;s&quot;</span><span class="s1">)</span>
    <span class="s1">result = asarray(df)</span>
    <span class="s1">expected = df.values</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;asarray&quot;</span><span class="s0">, </span><span class="s1">[da.asarray</span><span class="s0">, </span><span class="s1">da.asanyarray])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_asarray_h5py(asarray</span><span class="s0">, </span><span class="s1">inline_array):</span>
    <span class="s1">h5py = pytest.importorskip(</span><span class="s2">&quot;h5py&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f.create_dataset(</span><span class="s2">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float)</span>
            <span class="s1">x = asarray(d</span><span class="s0">, </span><span class="s1">inline_array=inline_array)</span>

            <span class="s4"># Check for the array in the dsk</span>
            <span class="s1">dsk = dict(x.dask)</span>
            <span class="s0">assert </span><span class="s1">(d </span><span class="s0">in </span><span class="s1">dsk.values()) </span><span class="s0">is not </span><span class="s1">inline_array</span>
            <span class="s0">assert not </span><span class="s1">any(isinstance(v</span><span class="s0">, </span><span class="s1">np.ndarray) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">dsk.values())</span>


<span class="s0">def </span><span class="s1">test_asarray_chunks():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;100 B&quot;</span><span class="s1">}):</span>
        <span class="s1">x = np.ones(</span><span class="s3">1000</span><span class="s1">)</span>
        <span class="s1">d = da.asarray(x)</span>
        <span class="s0">assert </span><span class="s1">d.npartitions &gt; </span><span class="s3">1</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:the matrix subclass&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_asanyarray():</span>
    <span class="s1">x = np.matrix([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">dx = da.asanyarray(x)</span>
    <span class="s0">assert </span><span class="s1">dx.numblocks == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">chunks = compute_as_if_collection(Array</span><span class="s0">, </span><span class="s1">dx.dask</span><span class="s0">, </span><span class="s1">dx.__dask_keys__())</span>
    <span class="s0">assert </span><span class="s1">isinstance(chunks[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.matrix)</span>
    <span class="s0">assert </span><span class="s1">da.asanyarray(dx) </span><span class="s0">is </span><span class="s1">dx</span>


<span class="s0">def </span><span class="s1">test_asanyarray_dataframe():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">x = np.asanyarray(df)</span>
    <span class="s1">dx = da.asanyarray(ddf)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dx</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>

    <span class="s1">x = np.asanyarray(df.x)</span>
    <span class="s1">dx = da.asanyarray(ddf.x)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dx</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_asanyarray_datetime64():</span>
    <span class="s1">x = np.array([</span><span class="s2">&quot;2000-01-01&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;datetime64&quot;</span><span class="s1">)</span>
    <span class="s1">dx = da.asanyarray(x)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dx</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_from_func():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">f = </span><span class="s0">lambda </span><span class="s1">n: n * x</span>
    <span class="s1">d = from_func(f</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.dtype</span><span class="s0">, </span><span class="s1">kwargs={</span><span class="s2">&quot;n&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span>

    <span class="s0">assert </span><span class="s1">d.shape == x.shape</span>
    <span class="s0">assert </span><span class="s1">d.dtype == x.dtype</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* x)</span>
    <span class="s0">assert </span><span class="s1">same_keys(d</span><span class="s0">, </span><span class="s1">from_func(f</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.dtype</span><span class="s0">, </span><span class="s1">kwargs={</span><span class="s2">&quot;n&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}))</span>


<span class="s0">def </span><span class="s1">test_concatenate3_2():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(concatenate3([x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>

    <span class="s1">x = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">concatenate3([[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]])</span>
        <span class="s1">== np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">).all()</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">concatenate3([[x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x]])</span>
        <span class="s1">== np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">).all()</span>

    <span class="s1">x = np.arange(</span><span class="s3">12</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">concatenate3([[[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]]</span><span class="s0">, </span><span class="s1">[[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]]])</span><span class="s0">,</span>
        <span class="s1">np.array(</span>
            <span class="s1">[</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span>
                    <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;one_d&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@mock.patch.object(da.core</span><span class="s0">, </span><span class="s2">&quot;_concatenate2&quot;</span><span class="s0">, </span><span class="s1">wraps=da.core._concatenate2)</span>
<span class="s0">def </span><span class="s1">test_concatenate3_nep18_dispatching(mock_concatenate2</span><span class="s0">, </span><span class="s1">one_d):</span>
    <span class="s1">x = EncapsulateNDArray(np.arange(</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">concat = [x</span><span class="s0">, </span><span class="s1">x] </span><span class="s0">if </span><span class="s1">one_d </span><span class="s0">else </span><span class="s1">[[x[</span><span class="s0">None</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[x[</span><span class="s0">None</span><span class="s1">]]]</span>
    <span class="s1">result = concatenate3(concat)</span>
    <span class="s0">assert </span><span class="s1">type(result) </span><span class="s0">is </span><span class="s1">type(x)</span>
    <span class="s1">mock_concatenate2.assert_called()</span>
    <span class="s1">mock_concatenate2.reset_mock()</span>

    <span class="s4"># When all the inputs are supported by plain `np.concatenate`, we should take the concatenate3</span>
    <span class="s4"># fastpath of allocating the full array up front and writing blocks into it.</span>
    <span class="s1">concat = [x.arr</span><span class="s0">, </span><span class="s1">x.arr] </span><span class="s0">if </span><span class="s1">one_d </span><span class="s0">else </span><span class="s1">[[x.arr[</span><span class="s0">None</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[x.arr[</span><span class="s0">None</span><span class="s1">]]]</span>
    <span class="s1">plain_np_result = concatenate3(concat)</span>
    <span class="s1">mock_concatenate2.assert_not_called()</span>
    <span class="s0">assert </span><span class="s1">type(plain_np_result) </span><span class="s0">is </span><span class="s1">np.ndarray</span>


<span class="s0">def </span><span class="s1">test_map_blocks3():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">10</span><span class="s1">) * </span><span class="s3">2</span>

    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">e = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.core.map_blocks(</span><span class="s0">lambda </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b: a + </span><span class="s3">2 </span><span class="s1">* b</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">2 </span><span class="s1">* y</span>
    <span class="s1">)</span>

    <span class="s1">z = np.arange(</span><span class="s3">100</span><span class="s1">).reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">f = da.from_array(z</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">func = </span><span class="s0">lambda </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b: a + </span><span class="s3">2 </span><span class="s1">* b</span>
    <span class="s1">res = da.core.map_blocks(func</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>
    <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">2 </span><span class="s1">* z)</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.core.map_blocks(func</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span><span class="s0">, </span><span class="s1">res)</span>

    <span class="s1">assert_eq(da.map_blocks(func</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span><span class="s0">, </span><span class="s1">z + </span><span class="s3">2 </span><span class="s1">* x)</span>


<span class="s0">def </span><span class="s1">test_from_array_with_missing_chunks():</span>
    <span class="s1">x = np.random.default_rng().standard_normal((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s0">None, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">d.chunks == da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)).chunks</span>


<span class="s0">def </span><span class="s1">test_normalize_chunks():</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)) == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)) == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">8</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)) == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)) == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) == ((</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks((</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks((</span><span class="s3">3</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks({</span><span class="s3">0</span><span class="s1">: </span><span class="s3">3</span><span class="s1">}</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks([[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]) == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">30</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)) == ((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) == ((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks(((float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)) == ((np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">normalize_chunks(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">20</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span><span class="s1">) == (</span>
        <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">normalize_chunks((</span><span class="s2">&quot;auto&quot;</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int) == ((</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks(((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks(((</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_align_chunks_to_previous_chunks():</span>
    <span class="s1">chunks = normalize_chunks(</span>
        <span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">2000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">previous_chunks=(</span><span class="s3">512</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s2">&quot;600 B&quot;</span><span class="s0">, </span><span class="s1">dtype=np.uint8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">512</span><span class="s0">, </span><span class="s3">512</span><span class="s0">, </span><span class="s3">512</span><span class="s0">, </span><span class="s3">2000 </span><span class="s1">- </span><span class="s3">512 </span><span class="s1">* </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks = normalize_chunks(</span>
        <span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">2000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">previous_chunks=(</span><span class="s3">128</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s2">&quot;600 B&quot;</span><span class="s0">, </span><span class="s1">dtype=np.uint8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">512</span><span class="s0">, </span><span class="s3">512</span><span class="s0">, </span><span class="s3">512</span><span class="s0">, </span><span class="s3">2000 </span><span class="s1">- </span><span class="s3">512 </span><span class="s1">* </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks = normalize_chunks(</span>
        <span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">2000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">previous_chunks=(</span><span class="s3">512</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s2">&quot;1200 B&quot;</span><span class="s0">, </span><span class="s1">dtype=np.uint8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">1024</span><span class="s0">, </span><span class="s3">2000 </span><span class="s1">- </span><span class="s3">1024</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks = normalize_chunks(</span>
        <span class="s2">&quot;auto&quot;</span><span class="s0">,</span>
        <span class="s1">shape=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">10211</span><span class="s0">, </span><span class="s3">10376</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">previous_chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">512</span><span class="s0">, </span><span class="s3">512</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">limit=</span><span class="s2">&quot;1MiB&quot;</span><span class="s0">,</span>
        <span class="s1">dtype=np.float32</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks[</span><span class="s3">0</span><span class="s1">] == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(c % </span><span class="s3">512 </span><span class="s1">== </span><span class="s3">0 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chunks[</span><span class="s3">1</span><span class="s1">][:-</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">all(c % </span><span class="s3">512 </span><span class="s1">== </span><span class="s3">0 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chunks[</span><span class="s3">2</span><span class="s1">][:-</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_raise_on_no_chunks():</span>
    <span class="s1">x = da.ones(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">Array(x.dask</span><span class="s0">, </span><span class="s1">x.name</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s0">None, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">shape=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert False</span>
    <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">assert </span><span class="s2">&quot;dask&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>
        <span class="s0">assert </span><span class="s2">&quot;.org&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>


<span class="s0">def </span><span class="s1">test_chunks_is_immutable():</span>
    <span class="s1">x = da.ones(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">x.chunks = </span><span class="s3">2</span>
        <span class="s0">assert False</span>
    <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">assert </span><span class="s2">&quot;rechunk(2)&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>


<span class="s0">def </span><span class="s1">test_raise_on_bad_kwargs():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">da.minimum(x</span><span class="s0">, </span><span class="s1">foo=</span><span class="s0">None</span><span class="s1">)</span>
    <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">assert </span><span class="s2">&quot;minimum&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>
        <span class="s0">assert </span><span class="s2">&quot;foo&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>


<span class="s0">def </span><span class="s1">test_long_slice():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10000</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">assert_eq(d[</span><span class="s3">8000</span><span class="s1">:</span><span class="s3">8200</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">8000</span><span class="s1">:</span><span class="s3">8200</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_h5py_newaxis():</span>
    <span class="s1">h5py = pytest.importorskip(</span><span class="s2">&quot;h5py&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">x = f.create_dataset(</span><span class="s2">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
            <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
            <span class="s0">assert </span><span class="s1">d[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:].compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">).shape == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">d[:</span><span class="s0">, None, </span><span class="s1">:].compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">).shape == (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">d[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">].compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">).shape == (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">same_keys(d[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">d[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_ellipsis_slicing():</span>
    <span class="s1">assert_eq(da.ones(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)[...]</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">4</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_point_slicing():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">result = d.vindex[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>

    <span class="s1">result = d.vindex[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
    <span class="s0">assert </span><span class="s1">same_keys(result</span><span class="s0">, </span><span class="s1">d.vindex[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_point_slicing_with_full_slice():</span>
    <span class="s0">from </span><span class="s1">dask.array.core </span><span class="s0">import </span><span class="s1">_get_axis</span><span class="s0">, </span><span class="s1">_vindex_transpose</span>

    <span class="s1">x = np.arange(</span><span class="s3">4 </span><span class="s1">* </span><span class="s3">5 </span><span class="s1">* </span><span class="s3">6 </span><span class="s1">* </span><span class="s3">7</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">inds = [</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, None, </span><span class="s1">np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s0">None, None, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s0">None, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">inds:</span>
        <span class="s1">slc = [</span>
            <span class="s1">i </span><span class="s0">if </span><span class="s1">isinstance(i</span><span class="s0">, </span><span class="s1">(np.ndarray</span><span class="s0">, </span><span class="s1">list)) </span><span class="s0">else </span><span class="s1">slice(</span><span class="s0">None, None</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">ind</span>
        <span class="s1">]</span>
        <span class="s1">result = d.vindex[tuple(slc)]</span>

        <span class="s4"># Rotate the expected result accordingly</span>
        <span class="s1">axis = _get_axis(ind)</span>
        <span class="s1">expected = _vindex_transpose(x[tuple(slc)]</span><span class="s0">, </span><span class="s1">axis)</span>

        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s4"># Always have the first axis be the length of the points</span>
        <span class="s1">k = len(next(i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">ind </span><span class="s0">if </span><span class="s1">isinstance(i</span><span class="s0">, </span><span class="s1">(np.ndarray</span><span class="s0">, </span><span class="s1">list))))</span>
        <span class="s0">assert </span><span class="s1">result.shape[</span><span class="s3">0</span><span class="s1">] == k</span>


<span class="s0">def </span><span class="s1">test_slice_with_floats():</span>
    <span class="s1">d = da.ones((</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">d[</span><span class="s3">1.5</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">d[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">1.5</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">d[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">]]</span>


<span class="s0">def </span><span class="s1">test_slice_with_integer_types():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">inds = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;u8&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(dx[inds]</span><span class="s0">, </span><span class="s1">x[inds])</span>
    <span class="s1">assert_eq(dx[inds.astype(</span><span class="s2">&quot;u4&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">x[inds.astype(</span><span class="s2">&quot;u4&quot;</span><span class="s1">)])</span>

    <span class="s1">inds = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">assert_eq(dx[inds]</span><span class="s0">, </span><span class="s1">x[inds])</span>
    <span class="s1">assert_eq(dx[inds.astype(</span><span class="s2">&quot;u4&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">x[inds.astype(</span><span class="s2">&quot;u4&quot;</span><span class="s1">)])</span>


<span class="s0">def </span><span class="s1">test_index_with_integer_types():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">inds = int(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">assert_eq(dx[inds]</span><span class="s0">, </span><span class="s1">x[inds])</span>

    <span class="s1">inds = np.int64(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">assert_eq(dx[inds]</span><span class="s0">, </span><span class="s1">x[inds])</span>


<span class="s0">def </span><span class="s1">test_vindex_basic():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># cases where basic and advanced indexing coincide</span>
    <span class="s1">result = d.vindex[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s1">result = d.vindex[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">result = d.vindex[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">::-</span><span class="s3">1</span><span class="s1">]  </span><span class="s4"># slices last</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">::-</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_vindex_nd():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">result = d.vindex[[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]])</span>

    <span class="s1">result = d.vindex[np.arange(</span><span class="s3">7</span><span class="s1">)[:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:]]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x)</span>

    <span class="s1">result = d.vindex[np.arange(</span><span class="s3">7</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">8</span><span class="s1">)[:</span><span class="s0">, None</span><span class="s1">]]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.T)</span>


<span class="s0">def </span><span class="s1">test_vindex_negative():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">result = d.vindex[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])]</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])])</span>


<span class="s0">def </span><span class="s1">test_vindex_errors():</span>
    <span class="s1">d = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: d.vindex[np.newaxis])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: d.vindex[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: d.vindex[[</span><span class="s0">True</span><span class="s1">] * </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: d.vindex[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: d.vindex[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">6</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;does not support indexing with dask objects&quot;</span><span class="s1">):</span>
        <span class="s1">d.vindex[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.array([</span><span class="s3">0</span><span class="s1">])]</span>


<span class="s0">def </span><span class="s1">test_vindex_merge():</span>
    <span class="s0">from </span><span class="s1">dask.array.core </span><span class="s0">import </span><span class="s1">_vindex_merge</span>

    <span class="s1">locations = [</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">values = [np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">]])]</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">_vindex_merge(locations</span><span class="s0">, </span><span class="s1">values)</span>
        <span class="s1">== np.array([[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]])</span>
    <span class="s1">).all()</span>


<span class="s0">def </span><span class="s1">test_vindex_identity():</span>
    <span class="s1">rng = da.random.default_rng(</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span>

    <span class="s1">x = rng.random(a</span><span class="s0">, </span><span class="s1">chunks=a // </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">x.vindex[:]</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">x.vindex[:a]</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[: a - </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[</span><span class="s3">1</span><span class="s1">:])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[</span><span class="s3">0</span><span class="s1">:a:</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">x = rng.random((a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">chunks=(a // </span><span class="s3">2</span><span class="s0">, </span><span class="s1">b // </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">x.vindex[:</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">x.vindex[:a</span><span class="s0">, </span><span class="s1">:b]</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[:</span><span class="s0">, </span><span class="s1">: b - </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:])</span>
    <span class="s1">pytest.raises(IndexError</span><span class="s0">, lambda</span><span class="s1">: x.vindex[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:b:</span><span class="s3">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_empty_array():</span>
    <span class="s1">assert_eq(np.arange(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_memmap():</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;npy&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn_1:</span>
        <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;npy&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn_2:</span>
            <span class="s0">try</span><span class="s1">:</span>
                <span class="s1">x = da.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">15</span><span class="s1">)</span>
                <span class="s1">target = np.memmap(fn_1</span><span class="s0">, </span><span class="s1">shape=x.shape</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w+&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>

                <span class="s1">x.store(target)</span>

                <span class="s1">assert_eq(target</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>

                <span class="s1">np.save(fn_2</span><span class="s0">, </span><span class="s1">target)</span>

                <span class="s1">assert_eq(np.load(fn_2</span><span class="s0">, </span><span class="s1">mmap_mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s0">finally</span><span class="s1">:</span>
                <span class="s1">target._mmap.close()</span>


<span class="s0">def </span><span class="s1">test_to_npy_stack():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5 </span><span class="s1">* </span><span class="s3">10 </span><span class="s1">* </span><span class="s3">10</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dirname:</span>
        <span class="s1">stackdir = os.path.join(dirname</span><span class="s0">, </span><span class="s2">&quot;test&quot;</span><span class="s1">)</span>
        <span class="s1">da.to_npy_stack(stackdir</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">os.path.exists(os.path.join(stackdir</span><span class="s0">, </span><span class="s2">&quot;0.npy&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">(np.load(os.path.join(stackdir</span><span class="s0">, </span><span class="s2">&quot;1.npy&quot;</span><span class="s1">)) == x[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s1">]).all()</span>

        <span class="s1">e = da.from_npy_stack(stackdir)</span>
        <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">e)</span>


<span class="s0">def </span><span class="s1">test_view():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">assert_eq(x.view()</span><span class="s0">, </span><span class="s1">d.view())</span>
    <span class="s1">assert_eq(x.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">all(isinstance(s</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">d.shape)</span>

    <span class="s1">x = np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i1&quot;</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x = np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i1&quot;</span><span class="s1">)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;asdf&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_view_fortran():</span>
    <span class="s1">x = np.asfortranarray(np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.T.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.T.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_h5py_tokenize():</span>
    <span class="s1">h5py = pytest.importorskip(</span><span class="s2">&quot;h5py&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn1:</span>
        <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn2:</span>
            <span class="s1">f = h5py.File(fn1</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
            <span class="s1">g = h5py.File(fn2</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

            <span class="s1">f[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = np.arange(</span><span class="s3">10</span><span class="s1">).astype(float)</span>
            <span class="s1">g[</span><span class="s2">&quot;x&quot;</span><span class="s1">] = np.ones(</span><span class="s3">10</span><span class="s1">).astype(float)</span>

            <span class="s1">x1 = f[</span><span class="s2">&quot;x&quot;</span><span class="s1">]</span>
            <span class="s1">x2 = g[</span><span class="s2">&quot;x&quot;</span><span class="s1">]</span>

            <span class="s0">assert </span><span class="s1">tokenize(x1) != tokenize(x2)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_changed_dimension():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">e = d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x.sum(axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s4"># Provided chunks have wrong shape</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=()</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x.sum(axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span>
        <span class="s0">lambda </span><span class="s1">b: b[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">new_axis=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">dtype=d.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">])</span>

    <span class="s1">e = d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">new_axis=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=d.dtype)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">])</span>

    <span class="s4"># Adding axis with a gap</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.map_blocks(</span><span class="s0">lambda </span><span class="s1">b: b</span><span class="s0">, </span><span class="s1">new_axis=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># Both new_axis and drop_axis</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span>
        <span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)[:</span><span class="s0">, None, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">drop_axis=</span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">new_axis=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">dtype=d.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x.sum(axis=</span><span class="s3">0</span><span class="s1">)[:</span><span class="s0">, None, None</span><span class="s1">])</span>

    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">e = d.map_blocks(</span>
        <span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">1</span><span class="s1">)[:</span><span class="s0">, None, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">drop_axis=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">new_axis=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">dtype=d.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x.sum(axis=</span><span class="s3">1</span><span class="s1">)[:</span><span class="s0">, None, None</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_negative_drop_axis():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">drop_axis </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]:</span>
        <span class="s4"># test with equivalent positive and negative drop_axis</span>
        <span class="s1">e = d.map_blocks(</span>
            <span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=drop_axis</span><span class="s0">, </span><span class="s1">dtype=d.dtype</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">x.sum(axis=</span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_invalid_drop_axis():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">drop_axis </span><span class="s0">in </span><span class="s1">[x.ndim</span><span class="s0">, </span><span class="s1">-x.ndim - </span><span class="s3">1</span><span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">d.map_blocks(</span>
                <span class="s0">lambda </span><span class="s1">b: b.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">drop_axis=drop_axis</span><span class="s0">, </span><span class="s1">dtype=d.dtype</span>
            <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_with_changed_dimension_and_broadcast_chunks():</span>
    <span class="s4"># https://github.com/dask/dask/issues/4299</span>
    <span class="s1">a = da.from_array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">b = da.from_array(np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">result = da.map_blocks(operator.add</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">chunks=b.chunks)</span>
    <span class="s1">expected = da.from_array(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_broadcast_chunks():</span>
    <span class="s0">assert </span><span class="s1">broadcast_chunks() == ()</span>

    <span class="s0">assert </span><span class="s1">broadcast_chunks(((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)) == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">broadcast_chunks(((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)) == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">a = ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b) == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">broadcast_chunks(b</span><span class="s0">, </span><span class="s1">a) == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">a = ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b) == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">a = ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s1">a = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b) == a</span>

    <span class="s1">a = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s1">b = ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">r = broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s0">assert </span><span class="s1">r[</span><span class="s3">0</span><span class="s1">] == b[</span><span class="s3">0</span><span class="s1">] </span><span class="s0">and </span><span class="s1">np.allclose(r[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">a = ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s1">r = broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s0">assert </span><span class="s1">r[</span><span class="s3">0</span><span class="s1">] == a[</span><span class="s3">0</span><span class="s1">] </span><span class="s0">and </span><span class="s1">np.allclose(r[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">b[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">a = ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">broadcast_chunks(a</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s0">def </span><span class="s1">test_chunks_error():</span>
    <span class="s1">x = np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_array_compute_forward_kwargs():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">).sum()</span>
    <span class="s1">x.compute(bogus_keyword=</span><span class="s3">10</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_dont_fuse_outputs():</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))}</span>

    <span class="s1">a = da.Array(dsk</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.array([</span><span class="s3">1</span><span class="s1">]).dtype)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=a.dtype))</span>


<span class="s0">def </span><span class="s1">test_dont_dealias_outputs():</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">a = da.Array(dsk</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.ones(</span><span class="s3">1</span><span class="s1">).dtype)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_timedelta_op():</span>
    <span class="s1">x = np.array([np.timedelta64(</span><span class="s3">10</span><span class="s0">, </span><span class="s2">&quot;h&quot;</span><span class="s1">)])</span>
    <span class="s1">y = np.timedelta64(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;h&quot;</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) / y</span>
    <span class="s0">assert </span><span class="s1">a.compute() == x / y</span>


<span class="s0">def </span><span class="s1">test_to_delayed():</span>
    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = x + </span><span class="s3">10</span>

    <span class="s1">[[a</span><span class="s0">, </span><span class="s1">b]</span><span class="s0">, </span><span class="s1">[c</span><span class="s0">, </span><span class="s1">d]] = y.to_delayed()</span>
    <span class="s1">assert_eq(a.compute()</span><span class="s0">, </span><span class="s1">y[:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">s = </span><span class="s3">2</span>
    <span class="s1">x = da.from_array(np.array(s)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">a = x.to_delayed()[tuple()]</span>
    <span class="s0">assert </span><span class="s1">a.compute() == s</span>


<span class="s0">def </span><span class="s1">test_to_delayed_optimize_graph():</span>
    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = x[</span><span class="s3">1</span><span class="s1">:][</span><span class="s3">1</span><span class="s1">:][</span><span class="s3">1</span><span class="s1">:][:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:][:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:][:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:]</span>

    <span class="s4"># optimizations</span>
    <span class="s1">d = y.to_delayed().flatten().tolist()[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">len([k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">d.dask </span><span class="s0">if </span><span class="s1">k[</span><span class="s3">0</span><span class="s1">].startswith(</span><span class="s2">&quot;getitem&quot;</span><span class="s1">)]) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">d.key == (y.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">d.dask.layers.keys() == {</span><span class="s2">&quot;delayed-&quot; </span><span class="s1">+ y.name}</span>
    <span class="s0">assert </span><span class="s1">d.dask.dependencies == {</span><span class="s2">&quot;delayed-&quot; </span><span class="s1">+ y.name: set()}</span>
    <span class="s0">assert </span><span class="s1">d.__dask_layers__() == (</span><span class="s2">&quot;delayed-&quot; </span><span class="s1">+ y.name</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s4"># no optimizations</span>
    <span class="s1">d2 = y.to_delayed(optimize_graph=</span><span class="s0">False</span><span class="s1">).flatten().tolist()[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">d2.dask </span><span class="s0">is </span><span class="s1">y.dask</span>
    <span class="s0">assert </span><span class="s1">d2.key == (y.name</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">d2.__dask_layers__() == y.__dask_layers__()</span>

    <span class="s0">assert </span><span class="s1">(d.compute() == d2.compute()).all()</span>


<span class="s0">def </span><span class="s1">test_cumulative():</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">x = da.arange(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">assert_eq(x.cumsum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">20</span><span class="s1">).cumsum())</span>
    <span class="s1">assert_eq(x.cumprod(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">20</span><span class="s1">).cumprod())</span>

    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(np.arange(</span><span class="s3">20</span><span class="s1">)))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(np.arange(</span><span class="s3">20</span><span class="s1">)))</span>

    <span class="s1">a = rng.random(</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">a[rng.random(a.shape) &lt; </span><span class="s3">0.5</span><span class="s1">] = np.nan</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(a))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(a))</span>

    <span class="s1">a = rng.random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">24</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.cumsum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a.cumsum(axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.cumsum(axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a.cumsum(axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.cumprod(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a.cumprod(axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.cumprod(axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">a.cumprod(axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">a = rng.random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">24</span><span class="s1">))</span>
    <span class="s1">a[rng.random(a.shape) &lt; </span><span class="s3">0.5</span><span class="s1">] = np.nan</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">a = rng.random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">13</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]:</span>
        <span class="s1">assert_eq(x.cumsum(axis=axis)</span><span class="s0">, </span><span class="s1">a.cumsum(axis=axis))</span>
        <span class="s1">assert_eq(x.cumprod(axis=axis)</span><span class="s0">, </span><span class="s1">a.cumprod(axis=axis))</span>

        <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=axis))</span>
        <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=axis))</span>

    <span class="s1">a = rng.random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">13</span><span class="s1">))</span>
    <span class="s1">a[rng.random(a.shape) &lt; </span><span class="s3">0.5</span><span class="s1">] = np.nan</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]:</span>
        <span class="s1">assert_eq(da.nancumsum(x</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">np.nancumsum(a</span><span class="s0">, </span><span class="s1">axis=axis))</span>
        <span class="s1">assert_eq(da.nancumprod(x</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">np.nancumprod(a</span><span class="s0">, </span><span class="s1">axis=axis))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.cumsum(axis=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.cumsum(axis=-</span><span class="s3">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_from_delayed():</span>
    <span class="s1">v = delayed(np.ones)((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">x = from_delayed(v</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.ones(</span><span class="s3">0</span><span class="s1">).dtype)</span>
    <span class="s0">assert </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">Array)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_from_delayed_meta():</span>
    <span class="s1">v = delayed(np.ones)((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">x = from_delayed(v</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">meta=np.ones(</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">Array)</span>
    <span class="s0">assert </span><span class="s1">isinstance(x._meta</span><span class="s0">, </span><span class="s1">np.ndarray)</span>


<span class="s0">def </span><span class="s1">test_A_property():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.A </span><span class="s0">is </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">test_copy_mutate():</span>
    <span class="s1">x = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = x.copy()</span>
    <span class="s1">memo = {}</span>
    <span class="s1">y2 = copy.deepcopy(x</span><span class="s0">, </span><span class="s1">memo=memo)</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">1</span>

    <span class="s1">xx = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">xx[xx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">xx)</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(y2</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">memo[id(x)] </span><span class="s0">is </span><span class="s1">y2</span>


<span class="s0">def </span><span class="s1">test_npartitions():</span>
    <span class="s0">assert </span><span class="s1">da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)).npartitions == </span><span class="s3">3</span>
    <span class="s0">assert </span><span class="s1">da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)).npartitions == </span><span class="s3">6</span>


<span class="s0">def </span><span class="s1">test_elemwise_name():</span>
    <span class="s0">assert </span><span class="s1">(da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">) + </span><span class="s3">1</span><span class="s1">).name.startswith(</span><span class="s2">&quot;add-&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_name():</span>
    <span class="s0">assert </span><span class="s1">da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">).map_blocks(inc).name.startswith(</span><span class="s2">&quot;inc-&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_token_deprecated():</span>
    <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;use `name=` instead&quot;</span><span class="s1">):</span>
        <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">).map_blocks(inc</span><span class="s0">, </span><span class="s1">token=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.name.startswith(</span><span class="s2">&quot;foo-&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_from_array_names():</span>
    <span class="s1">x = np.ones(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a.dask.keys() == {(a.name</span><span class="s0">, </span><span class="s1">i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">5</span><span class="s1">)}</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;array&quot;</span><span class="s0">, </span><span class="s1">[da.arange(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">25</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">25</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_array_picklable(array):</span>
    <span class="s0">from </span><span class="s1">pickle </span><span class="s0">import </span><span class="s1">dumps</span><span class="s0">, </span><span class="s1">loads</span>

    <span class="s1">a2 = loads(dumps(array))</span>
    <span class="s1">assert_eq(array</span><span class="s0">, </span><span class="s1">a2)</span>

    <span class="s1">a3 = da.ma.masked_equal(array</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(a3._meta</span><span class="s0">, </span><span class="s1">np.ma.MaskedArray)</span>
    <span class="s1">a4 = loads(dumps(a3))</span>
    <span class="s1">assert_eq(a3</span><span class="s0">, </span><span class="s1">a4)</span>
    <span class="s0">assert </span><span class="s1">isinstance(a4._meta</span><span class="s0">, </span><span class="s1">np.ma.MaskedArray)</span>


<span class="s0">def </span><span class="s1">test_from_array_raises_on_bad_chunks():</span>
    <span class="s1">x = np.ones(</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s4"># with pytest.raises(ValueError):</span>
    <span class="s4">#      da.from_array(x, chunks=100)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_concatenate_axes():</span>
    <span class="s1">x = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(concatenate_axes([x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">assert_eq(concatenate_axes([x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">assert_eq(concatenate_axes([x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">assert_eq(concatenate_axes([[x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x]]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">assert_eq(concatenate_axes([[x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x]]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>
    <span class="s1">assert_eq(concatenate_axes([[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x]]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">concatenate_axes(</span>
            <span class="s1">[[x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x]]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">)  </span><span class="s4"># not all nested lists accounted for</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">concatenate_axes([x</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">axes=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])  </span><span class="s4"># too many axes</span>


<span class="s0">def </span><span class="s1">test_blockwise_concatenate():</span>
    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">f(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">assert </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">isinstance(b</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

        <span class="s0">assert </span><span class="s1">a.shape == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">b.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>

        <span class="s0">return </span><span class="s1">(a + b).sum(axis=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">z = da.blockwise(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">4</span><span class="s1">) * </span><span class="s3">32</span><span class="s1">)</span>

    <span class="s1">z = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)) * </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">f(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c):</span>
        <span class="s0">assert </span><span class="s1">isinstance(a</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">isinstance(b</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">isinstance(c</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

        <span class="s0">assert </span><span class="s1">a.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">b.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

        <span class="s0">return </span><span class="s1">np.ones(</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">z = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ki&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_shape=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_common_blockdim():</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]) == (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]) == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]) == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]) == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]) == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]) == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">common_blockdim([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]) == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_uneven_chunks_that_fit_neatly():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(x + y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + np.ones(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s1">z = x + y</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_elemwise_uneven_chunks():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(x + y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + np.ones(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s1">z = x + y</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">x = rng.random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s1">y = rng.random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>

    <span class="s1">z = x + y</span>
    <span class="s1">assert_eq(x + y</span><span class="s0">, </span><span class="s1">x.compute() + y.compute())</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_uneven_chunks_blockwise():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = rng.random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>
    <span class="s1">y = rng.random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)))</span>
    <span class="s1">z = da.blockwise(np.dot</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == (x.chunks[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y.chunks[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">x.compute().dot(y))</span>


<span class="s0">def </span><span class="s1">test_warn_bad_rechunking():</span>
    <span class="s1">x = da.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">y = da.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.warns(da.core.PerformanceWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;factor of 20&quot;</span><span class="s1">):</span>
        <span class="s1">x + y</span>


<span class="s0">def </span><span class="s1">test_concatenate_stack_dont_warn():</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">da.concatenate([da.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)] * </span><span class="s3">62</span><span class="s1">)</span>
    <span class="s0">assert not </span><span class="s1">record</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">da.stack([da.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)] * </span><span class="s3">62</span><span class="s1">)</span>
    <span class="s0">assert not </span><span class="s1">record</span>


<span class="s0">def </span><span class="s1">test_map_blocks_delayed():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">z = x.map_blocks(add</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>

    <span class="s1">yy = delayed(y)</span>
    <span class="s1">zz = x.map_blocks(add</span><span class="s0">, </span><span class="s1">yy</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>

    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">zz)</span>

    <span class="s0">assert </span><span class="s1">yy.key </span><span class="s0">in </span><span class="s1">zz.dask</span>


<span class="s0">def </span><span class="s1">test_no_chunks():</span>
    <span class="s1">X = np.arange(</span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)}</span>
    <span class="s1">x = Array(dsk</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">1</span><span class="s1">).dtype)</span>
    <span class="s1">assert_eq(x + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">X + </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(x.sum()</span><span class="s0">, </span><span class="s1">X.sum())</span>
    <span class="s1">assert_eq((x + </span><span class="s3">1</span><span class="s1">).std()</span><span class="s0">, </span><span class="s1">(X + </span><span class="s3">1</span><span class="s1">).std())</span>
    <span class="s1">assert_eq((x + x).std()</span><span class="s0">, </span><span class="s1">(X + X).std())</span>
    <span class="s1">assert_eq((x + x).std(keepdims=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(X + X).std(keepdims=</span><span class="s0">True</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_no_chunks_2d():</span>
    <span class="s1">X = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">x._chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">RuntimeWarning)  </span><span class="s4"># divide by zero</span>
        <span class="s1">assert_eq(da.log(x)</span><span class="s0">, </span><span class="s1">np.log(X))</span>
    <span class="s1">assert_eq(x.T</span><span class="s0">, </span><span class="s1">X.T)</span>
    <span class="s1">assert_eq(x.sum(axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">X.sum(axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.sum(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">X.sum(axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.dot(x.T + </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">X.dot(X.T + </span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_no_chunks_yes_chunks():</span>
    <span class="s1">X = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">x._chunks = ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>

    <span class="s0">assert </span><span class="s1">(x + </span><span class="s3">1</span><span class="s1">).chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s0">assert </span><span class="s1">(x.T).chunks == ((np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">(x.dot(x.T)).chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_raise_informative_errors_no_chunks():</span>
    <span class="s1">X = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">a._chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">b = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">b._chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s0">lambda</span><span class="s1">: a + b</span><span class="s0">,</span>
        <span class="s0">lambda</span><span class="s1">: a[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s0">lambda</span><span class="s1">: a[::</span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s0">lambda</span><span class="s1">: a[-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s0">lambda</span><span class="s1">: a.rechunk(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda</span><span class="s1">: a.reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">op()</span>
        <span class="s0">if </span><span class="s2">&quot;chunk&quot; </span><span class="s0">not in </span><span class="s1">str(e.value) </span><span class="s0">or </span><span class="s2">&quot;unknown&quot; </span><span class="s0">not in </span><span class="s1">str(e.value):</span>
            <span class="s1">op()</span>


<span class="s0">def </span><span class="s1">test_no_chunks_slicing_2d():</span>
    <span class="s1">X = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">x._chunks = ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>

    <span class="s1">assert_eq(x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s0">for </span><span class="s1">op </span><span class="s0">in </span><span class="s1">[</span><span class="s0">lambda</span><span class="s1">: x[:</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, lambda</span><span class="s1">: x[:</span><span class="s0">, </span><span class="s1">::</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, lambda</span><span class="s1">: x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s1">]]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;chunk sizes are unknown&quot;</span><span class="s1">):</span>
            <span class="s1">op()</span>


<span class="s0">def </span><span class="s1">test_index_array_with_array_1d():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">dx._chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">assert_eq(x[x &gt; </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">])</span>

    <span class="s1">dy = da.ones(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dx[dy &gt; </span><span class="s3">5</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_index_array_with_array_2d():</span>
    <span class="s1">x = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(x[x &gt; </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">])</span>

    <span class="s4"># Test with unknown chunks</span>
    <span class="s1">dx._chunks = ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan))</span>

    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;different ordering&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s0">assert </span><span class="s1">sorted(x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">].tolist()) == sorted(</span>
            <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">].compute().tolist()</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">sorted(x[x &gt; </span><span class="s3">6</span><span class="s1">].tolist()) == sorted(dx[dx &gt; </span><span class="s3">6</span><span class="s1">].compute().tolist())</span>

    <span class="s0">assert </span><span class="s1">len(record) == </span><span class="s3">2</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;Chunking does not align well&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_index_array_with_array_3d_2d():</span>
    <span class="s1">x = np.arange(</span><span class="s3">4</span><span class="s1">**</span><span class="s3">3</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">ind = np.random.default_rng().random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)) &gt; </span><span class="s3">0.5</span>
    <span class="s1">ind = np.arange(</span><span class="s3">4</span><span class="s1">**</span><span class="s3">2</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)) % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span>
    <span class="s1">dind = da.from_array(ind</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(x[ind]</span><span class="s0">, </span><span class="s1">dx[dind])</span>
    <span class="s1">assert_eq(x[:</span><span class="s0">, </span><span class="s1">ind]</span><span class="s0">, </span><span class="s1">dx[:</span><span class="s0">, </span><span class="s1">dind])</span>


<span class="s0">def </span><span class="s1">test_setitem_1d():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">x[x &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>

    <span class="s1">index = da.arange(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Boolean index assignment in Dask&quot;</span><span class="s1">):</span>
        <span class="s1">dx[index] = </span><span class="s3">1</span>


<span class="s1">@pytest.mark.xfail(</span>
    <span class="s1">sys.platform == </span><span class="s2">&quot;win32&quot; </span><span class="s0">and </span><span class="s1">PY_VERSION &gt;= Version(</span><span class="s2">&quot;3.12.0&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s2">&quot;https://github.com/dask/dask/issues/10604&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_hardmask():</span>
    <span class="s1">x = np.ma.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">x.harden_mask()</span>

    <span class="s1">y = x.copy()</span>
    <span class="s0">assert </span><span class="s1">y.hardmask</span>

    <span class="s1">x[</span><span class="s3">0</span><span class="s1">] = np.ma.masked</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] = np.ma.masked</span>

    <span class="s1">dx = da.from_array(y)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = np.ma.masked</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] = np.ma.masked</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_setitem_2d():</span>
    <span class="s1">x = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">x[x &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_setitem_extended_API_0d():</span>
    <span class="s4"># 0-d array</span>
    <span class="s1">x = np.array(</span><span class="s3">9</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(</span><span class="s3">9</span><span class="s1">)</span>

    <span class="s1">x[()] = -</span><span class="s3">1</span>
    <span class="s1">dx[()] = -</span><span class="s3">1</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">x[...] = -</span><span class="s3">11</span>
    <span class="s1">dx[...] = -</span><span class="s3">11</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index, value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">8</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">8</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">30</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">40</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(-</span><span class="s3">3</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[slice(-</span><span class="s3">4</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s1">]]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_extended_API_1d(index</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s4"># 1-d array</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">dx[index] = value</span>
    <span class="s1">x[index] = value</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index, value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(Ellipsis</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">31</span><span class="s0">, </span><span class="s1">-</span><span class="s3">32</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[([-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">31</span><span class="s0">, </span><span class="s1">-</span><span class="s3">32</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">50</span><span class="s0">, </span><span class="s1">-</span><span class="s3">51</span><span class="s0">, </span><span class="s1">-</span><span class="s3">52</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">60</span><span class="s0">, </span><span class="s1">-</span><span class="s3">61</span><span class="s0">, </span><span class="s1">-</span><span class="s3">62</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">[[-</span><span class="s3">70</span><span class="s0">, </span><span class="s1">-</span><span class="s3">71</span><span class="s0">, </span><span class="s1">-</span><span class="s3">72</span><span class="s1">]]]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">80</span><span class="s0">, </span><span class="s1">-</span><span class="s3">81</span><span class="s0">, </span><span class="s3">91</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[([</span><span class="s0">True, False, False, False, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, False, True, True, False, True, False, True, True</span><span class="s1">])</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(np.array([</span><span class="s0">False, False, True, True, False, False</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s3">4</span><span class="s0">,</span>
                <span class="s1">da.from_array(</span>
                    <span class="s1">[</span><span class="s0">False, False, True, True, False, False, True, False, False, True</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s1">slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">da.from_array(</span>
                    <span class="s1">[</span><span class="s0">False, False, True, True, False, False, True, False, False, True</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[[-</span><span class="s3">100</span><span class="s0">, </span><span class="s1">-</span><span class="s3">101</span><span class="s0">, </span><span class="s1">-</span><span class="s3">102</span><span class="s0">, </span><span class="s1">-</span><span class="s3">103</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">200</span><span class="s0">, </span><span class="s1">-</span><span class="s3">201</span><span class="s0">, </span><span class="s1">-</span><span class="s3">202</span><span class="s0">, </span><span class="s1">-</span><span class="s3">203</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">5</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">99</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">5</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">98</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">21</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_extended_API_2d(index</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s4"># 2-d array</span>
    <span class="s1">x = np.ma.arange(</span><span class="s3">60</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">dx[index] = value</span>
    <span class="s1">x[index] = value</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s0">def </span><span class="s1">test_setitem_extended_API_2d_rhs_func_of_lhs():</span>
    <span class="s4"># Cases:</span>
    <span class="s4"># * RHS and/or indices are a function of the LHS</span>
    <span class="s4"># * Indices have unknown chunk sizes</span>
    <span class="s4"># * RHS has extra leading size 1 dimensions compared to LHS</span>
    <span class="s1">x = np.arange(</span><span class="s3">60</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">chunks = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dx[</span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">3</span><span class="s1">] = -</span><span class="s3">5</span>
    <span class="s1">x[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">3</span><span class="s1">] = -</span><span class="s3">5</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dx[</span><span class="s3">0</span><span class="s1">] &lt; -</span><span class="s3">2</span><span class="s1">] = -</span><span class="s3">7</span>
    <span class="s1">x[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">] &lt; -</span><span class="s3">2</span><span class="s1">] = -</span><span class="s3">7</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">] = -dx[:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">] = -x[:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">] = -dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">] = -x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[...] = dx</span>
    <span class="s1">x[...] = x</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[...] = dx[...]</span>
    <span class="s1">x[...] = x[...]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = dx[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s1">] = x[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = dx[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = x[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = dx[:</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = x[:</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.from_array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">8</span><span class="s1">] = [</span><span class="s3">99</span><span class="s0">, </span><span class="s3">88</span><span class="s1">]</span>
    <span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">8</span><span class="s1">] = [</span><span class="s3">99</span><span class="s0">, </span><span class="s3">88</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[:</span><span class="s0">, </span><span class="s1">index] = dx[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]] = x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">23</span><span class="s0">, </span><span class="s1">-</span><span class="s3">33</span><span class="s1">]</span>
    <span class="s1">x[index.compute()</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">23</span><span class="s0">, </span><span class="s1">-</span><span class="s3">33</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[(index</span><span class="s0">,</span><span class="s1">)] = -</span><span class="s3">34</span>
    <span class="s1">x[(index.compute()</span><span class="s0">,</span><span class="s1">)] = -</span><span class="s3">34</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = index - </span><span class="s3">4</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">43</span><span class="s0">, </span><span class="s1">-</span><span class="s3">53</span><span class="s1">]</span>
    <span class="s1">x[index.compute()</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">43</span><span class="s0">, </span><span class="s1">-</span><span class="s3">53</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.from_array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]] = </span><span class="s3">9999</span>
    <span class="s1">dx[(index</span><span class="s0">,</span><span class="s1">)] = </span><span class="s3">9999</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">dx[...] = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s4"># RHS has extra leading size 1 dimensions compared to LHS</span>
    <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">v = x.reshape((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) + x.shape)</span>
    <span class="s1">x[...] = v</span>
    <span class="s1">dx[...] = v</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">v = -np.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]] = v</span>
    <span class="s1">dx[:</span><span class="s0">, </span><span class="s1">index] = v</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index, value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.ma.masked]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ma.masked_all((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_extended_API_2d_mask(index</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s1">x = np.ma.arange(</span><span class="s3">60</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x.data</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">dx[index] = value</span>
    <span class="s4"># See https://github.com/numpy/numpy/issues/23000 for the `RuntimeWarning`</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.filterwarnings(</span>
            <span class="s2">&quot;ignore&quot;</span><span class="s0">,</span>
            <span class="s1">category=RuntimeWarning</span><span class="s0">,</span>
            <span class="s1">message=</span><span class="s2">&quot;invalid value encountered in cast&quot;</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">x[index] = value</span>
        <span class="s1">dx = dx.persist()</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>
    <span class="s1">assert_eq(x.mask</span><span class="s0">, </span><span class="s1">da.ma.getmaskarray(dx).compute())</span>


<span class="s0">def </span><span class="s1">test_setitem_on_read_only_blocks():</span>
    <span class="s4"># Outputs of broadcast_trick-style functions contain read-only</span>
    <span class="s4"># arrays</span>
    <span class="s1">dx = da.empty((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">99</span>

    <span class="s1">assert_eq(dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">99.0</span><span class="s1">)</span>

    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] = </span><span class="s3">88</span>

    <span class="s1">assert_eq(dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">88.0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_setitem_errs():</span>
    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[x &gt; </span><span class="s3">1</span><span class="s1">] = x</span>

    <span class="s4"># Shape mismatch</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, True, False</span><span class="s1">]] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, True, False</span><span class="s1">]] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[da.from_array([</span><span class="s0">True, True, True, False</span><span class="s1">])</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">da.from_array([</span><span class="s0">True, False, False, True</span><span class="s1">])] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s4"># Too many indices</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:] = </span><span class="s3">2</span>

    <span class="s4"># 2-d boolean indexing a single dimension</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[[</span><span class="s0">True, True, False, False</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s4"># Too many/not enough booleans</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[</span><span class="s0">False, True, True, True, False</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s4"># 2-d indexing a single dimension</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s4"># Multiple 1-d boolean/integer arrays</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]] = </span><span class="s3">6</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True, False, False</span><span class="s1">]] = </span><span class="s3">7</span>

    <span class="s4"># scalar boolean indexing</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[</span><span class="s0">True</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[np.array(</span><span class="s0">True</span><span class="s1">)] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">da.from_array(</span><span class="s0">True</span><span class="s1">)] = </span><span class="s3">5</span>

    <span class="s4"># Scalar arrays</span>
    <span class="s1">y = da.from_array(np.array(</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">y[:] = </span><span class="s3">2</span>

    <span class="s4"># RHS has non-brodacastable extra leading dimensions</span>
    <span class="s1">x = np.arange(</span><span class="s3">12</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dx[...] = np.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># RHS doesn't have chunks set</span>
    <span class="s1">dx = da.unique(da.random.default_rng().random([</span><span class="s3">10</span><span class="s1">]))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Arrays chunk sizes are unknown&quot;</span><span class="s1">):</span>
        <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s4"># np.nan assigned to integer array</span>
    <span class="s1">x = da.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;cannot convert float NaN to integer&quot;</span><span class="s1">):</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = np.nan</span>


<span class="s0">def </span><span class="s1">test_zero_slice_dtypes():</span>
    <span class="s1">x = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">y = x[[]]</span>
    <span class="s0">assert </span><span class="s1">y.dtype == x.dtype</span>
    <span class="s0">assert </span><span class="s1">y.shape == (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(x[[]]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">)[[]])</span>


<span class="s0">def </span><span class="s1">test_zero_sized_array_rechunk():</span>
    <span class="s1">x = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">y = da.blockwise(identity</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_blockwise_zero_shape():</span>
    <span class="s1">da.blockwise(</span>
        <span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">,</span>
        <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
        <span class="s1">da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;ab&quot;</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;a&quot;</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_blockwise_zero_shape_new_axes():</span>
    <span class="s1">da.blockwise(</span>
        <span class="s0">lambda </span><span class="s1">x: np.ones(</span><span class="s3">42</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;ab&quot;</span><span class="s0">,</span>
        <span class="s1">da.from_array(np.ones((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s2">&quot;a&quot;</span><span class="s0">,</span>
        <span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s0">,</span>
        <span class="s1">new_axes={</span><span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s3">42</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_broadcast_against_zero_shape():</span>
    <span class="s1">assert_eq(da.arange(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">1</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.arange(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">1</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))[:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">0.1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_from_array_name():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">chunks = x.shape</span>
    <span class="s4"># Default is tokenize the array</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">hashed_name = dx.name</span>
    <span class="s0">assert </span><span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks).name == hashed_name</span>
    <span class="s4"># Specify name directly</span>
    <span class="s0">assert </span><span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s1">).name == </span><span class="s2">&quot;x&quot;</span>
    <span class="s4"># False gives a random name</span>
    <span class="s1">dx2 = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">name=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">dx3 = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">name=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">dx2.name != hashed_name</span>
    <span class="s0">assert </span><span class="s1">dx3.name != hashed_name</span>
    <span class="s0">assert </span><span class="s1">dx2.name != dx3.name</span>


<span class="s0">def </span><span class="s1">test_concatenate_errs():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">r&quot;Shapes.*\(2, 1\)&quot;</span><span class="s1">):</span>
        <span class="s1">da.concatenate(</span>
            <span class="s1">[da.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">da.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))]</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.concatenate(</span>
            <span class="s1">[da.zeros((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_stack_errs():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s1">da.stack([da.zeros((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)] * </span><span class="s3">10 </span><span class="s1">+ [da.zeros((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)] * </span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">str(e.value)</span>
        <span class="s1">== </span><span class="s2">&quot;Stacked arrays must have the same shape. The first array had shape (2,), while array 11 has shape (3,).&quot;</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(str(e.value)) &lt; </span><span class="s3">105</span>


<span class="s0">def </span><span class="s1">test_blockwise_with_numpy_arrays():</span>
    <span class="s1">x = np.ones(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(x + y</span><span class="s0">, </span><span class="s1">x + x)</span>

    <span class="s1">s = da.sum(x)</span>
    <span class="s0">assert </span><span class="s1">any(x </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">s.dask.values())</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;other&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_elemwise_with_lists(chunks</span><span class="s0">, </span><span class="s1">other):</span>
    <span class="s1">x = np.arange(</span><span class="s3">12</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">d = da.arange(</span><span class="s3">12</span><span class="s0">, </span><span class="s1">chunks=chunks).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">x2 = np.vstack([x[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]).T</span>
    <span class="s1">d2 = da.vstack([d[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">d[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">d[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]).T</span>

    <span class="s1">assert_eq(x2</span><span class="s0">, </span><span class="s1">d2)</span>

    <span class="s1">x3 = x2 * other</span>
    <span class="s1">d3 = d2 * other</span>

    <span class="s1">assert_eq(x3</span><span class="s0">, </span><span class="s1">d3)</span>


<span class="s0">def </span><span class="s1">test_constructor_plugin():</span>
    <span class="s1">L = []</span>
    <span class="s1">L2 = []</span>
    <span class="s0">with </span><span class="s1">dask.config.set(array_plugins=[L.append</span><span class="s0">, </span><span class="s1">L2.append]):</span>
        <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">y = x + </span><span class="s3">1</span>

    <span class="s0">assert </span><span class="s1">L == L2 == [x</span><span class="s0">, </span><span class="s1">y]</span>

    <span class="s0">with </span><span class="s1">dask.config.set(array_plugins=[</span><span class="s0">lambda </span><span class="s1">x: x.compute()]):</span>
        <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">y = x + </span><span class="s3">1</span>

    <span class="s0">assert </span><span class="s1">isinstance(y</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
    <span class="s0">assert </span><span class="s1">len(L) == </span><span class="s3">2</span>


<span class="s0">def </span><span class="s1">test_no_warnings_on_metadata():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">da.arccos(x)</span>

    <span class="s0">assert not </span><span class="s1">record</span>


<span class="s0">def </span><span class="s1">test_delayed_array_key_hygeine():</span>
    <span class="s1">a = da.zeros((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">d = delayed(identity)(a)</span>
    <span class="s1">b = da.from_delayed(d</span><span class="s0">, </span><span class="s1">shape=a.shape</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s0">def </span><span class="s1">test_empty_chunks_in_array_len():</span>
    <span class="s1">x = da.ones(()</span><span class="s0">, </span><span class="s1">chunks=())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError) </span><span class="s0">as </span><span class="s1">exc_info:</span>
        <span class="s1">len(x)</span>

    <span class="s1">err_msg = </span><span class="s2">&quot;len() of unsized object&quot;</span>
    <span class="s0">assert </span><span class="s1">err_msg </span><span class="s0">in </span><span class="s1">str(exc_info.value)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s1">[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;f4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">object)]])</span>
<span class="s0">def </span><span class="s1">test_meta(dtype):</span>
    <span class="s1">a = da.zeros((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">a._meta.dtype == a.dtype</span>
    <span class="s0">assert </span><span class="s1">isinstance(a._meta</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
    <span class="s0">assert </span><span class="s1">a.nbytes &lt; </span><span class="s3">1000</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape,limit,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">24</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">23</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># relatively prime, don't use 1s</span>
        <span class="s1">(</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">167</span><span class="s0">, </span><span class="s1">(</span><span class="s3">167</span><span class="s0">, </span><span class="s3">167</span><span class="s0">, </span><span class="s3">167</span><span class="s0">, </span><span class="s3">167</span><span class="s0">, </span><span class="s3">167</span><span class="s0">, </span><span class="s3">165</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_normalize_chunks_auto_1d(shape</span><span class="s0">, </span><span class="s1">limit</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">result = normalize_chunks(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(shape</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=limit</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s0">assert </span><span class="s1">result == (expected</span><span class="s0">,</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape,chunks,limit,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">20</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_normalize_chunks_auto_2d(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">limit</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">result = normalize_chunks(chunks</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">limit=limit</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_normalize_chunks_auto_3d():</span>
    <span class="s1">result = normalize_chunks(</span>
        <span class="s1">(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">200</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span>
    <span class="s1">)</span>
    <span class="s1">expected = ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">result = normalize_chunks(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span><span class="s1">)</span>
    <span class="s1">expected = ((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_constructors_chunks_dict():</span>
    <span class="s1">x = da.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">5</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">x = da.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_from_array_chunks_dict():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;128kiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = np.empty((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">))</span>
        <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: -</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">})</span>
        <span class="s1">z = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">(</span><span class="s3">16</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">6 </span><span class="s1">+ (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)))</span>
        <span class="s0">assert </span><span class="s1">y.chunks == z.chunks</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[object</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">object)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">int)]])</span>
<span class="s0">def </span><span class="s1">test_normalize_chunks_object_dtype(dtype):</span>
    <span class="s1">x = np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_normalize_chunks_tuples_of_tuples():</span>
    <span class="s1">result = normalize_chunks(((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s1">expected = ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_normalize_chunks_nan():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">normalize_chunks(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s0">assert </span><span class="s2">&quot;auto&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">normalize_chunks(((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s0">assert </span><span class="s2">&quot;auto&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>


<span class="s0">def </span><span class="s1">test_pandas_from_dask_array():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s0">from </span><span class="s1">dask.dataframe._compat </span><span class="s0">import </span><span class="s1">PANDAS_GE_131</span>

    <span class="s1">a = da.ones((</span><span class="s3">12</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">s = pd.Series(a</span><span class="s0">, </span><span class="s1">index=range(</span><span class="s3">12</span><span class="s1">))</span>

    <span class="s0">if not </span><span class="s1">PANDAS_GE_131:</span>
        <span class="s4"># https://github.com/pandas-dev/pandas/issues/38645</span>
        <span class="s0">assert </span><span class="s1">s.dtype != a.dtype</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">s.dtype == a.dtype</span>
        <span class="s1">assert_eq(s.values</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">def </span><span class="s1">test_from_zarr_unique_name():</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">a = zarr.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">b = zarr.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span>

    <span class="s0">assert </span><span class="s1">da.from_zarr(a).name != da.from_zarr(b).name</span>


<span class="s0">def </span><span class="s1">test_from_zarr_name():</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">a = zarr.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">da.from_zarr(a</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;foo&quot;</span><span class="s1">).name == </span><span class="s2">&quot;foo&quot;</span>


<span class="s0">def </span><span class="s1">test_zarr_roundtrip():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a.to_zarr(d)</span>
        <span class="s1">a2 = da.from_zarr(d)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s0">def </span><span class="s1">test_zarr_roundtrip_with_path_like():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">path = pathlib.Path(d)</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a.to_zarr(path)</span>
        <span class="s1">a2 = da.from_zarr(path)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;compute&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_zarr_return_stored(compute):</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a2 = a.to_zarr(d</span><span class="s0">, </span><span class="s1">compute=compute</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(a2</span><span class="s0">, </span><span class="s1">Array)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2</span><span class="s0">, </span><span class="s1">check_graph=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;inline_array&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_zarr_inline_array(inline_array):</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">a = zarr.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">dsk = dict(da.from_zarr(a</span><span class="s0">, </span><span class="s1">inline_array=inline_array).dask)</span>
    <span class="s0">assert </span><span class="s1">len(dsk) == (</span><span class="s3">0 </span><span class="s0">if </span><span class="s1">inline_array </span><span class="s0">else </span><span class="s3">1</span><span class="s1">) + </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">(a </span><span class="s0">in </span><span class="s1">dsk.values()) </span><span class="s0">is not </span><span class="s1">inline_array</span>


<span class="s0">def </span><span class="s1">test_zarr_existing_array():</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">c = (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">a = da.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=c)</span>
    <span class="s1">z = zarr.zeros_like(a</span><span class="s0">, </span><span class="s1">chunks=c)</span>
    <span class="s1">a.to_zarr(z)</span>
    <span class="s1">a2 = da.from_zarr(z)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s0">def </span><span class="s1">test_to_zarr_unknown_chunks_raises():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">a = da.random.default_rng().random((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">a = a[a &gt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;unknown chunk sizes&quot;</span><span class="s1">):</span>
        <span class="s1">a.to_zarr({})</span>


<span class="s0">def </span><span class="s1">test_read_zarr_chunks():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">a = da.zeros((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">a.to_zarr(d)</span>
        <span class="s1">arr = da.from_zarr(d</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">arr.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_zarr_pass_mapper():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">zarr.storage</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">mapper = zarr.storage.DirectoryStore(d)</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a.to_zarr(mapper)</span>
        <span class="s1">a2 = da.from_zarr(mapper)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s0">def </span><span class="s1">test_zarr_group():</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;test&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises((OSError</span><span class="s0">, </span><span class="s1">ValueError)):</span>
            <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s4"># second time is fine, group exists</span>
        <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;test2&quot;</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;nested/test&quot;</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">group = zarr.open_group(d</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;r&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">list(group) == [</span><span class="s2">&quot;nested&quot;</span><span class="s0">, </span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s2">&quot;test2&quot;</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s2">&quot;test&quot; </span><span class="s0">in </span><span class="s1">group[</span><span class="s2">&quot;nested&quot;</span><span class="s1">]</span>

        <span class="s1">a2 = da.from_zarr(d</span><span class="s0">, </span><span class="s1">component=</span><span class="s2">&quot;test&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;data&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[()</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_regular_chunks(data):</span>
    <span class="s1">chunkset</span><span class="s0">, </span><span class="s1">expected = data</span>
    <span class="s0">assert </span><span class="s1">da.core._check_regular_chunks(chunkset) == expected</span>


<span class="s0">def </span><span class="s1">test_zarr_nocompute():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
        <span class="s1">a = da.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">out = a.to_zarr(d</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(out</span><span class="s0">, </span><span class="s1">Delayed)</span>
        <span class="s1">dask.compute(out)</span>
        <span class="s1">a2 = da.from_zarr(d)</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">a2)</span>
        <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>


<span class="s0">def </span><span class="s1">test_zarr_regions():</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>

    <span class="s1">a = da.arange(</span><span class="s3">16</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)).rechunk(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">z = zarr.zeros_like(a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">a[:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">].to_zarr(z</span><span class="s0">, </span><span class="s1">region=(slice(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">a2 = da.from_zarr(z)</span>
    <span class="s1">expected = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s1">assert_eq(a2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>

    <span class="s1">a[:</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:</span><span class="s3">4</span><span class="s1">].to_zarr(z</span><span class="s0">, </span><span class="s1">region=(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s1">a2 = da.from_zarr(z)</span>
    <span class="s1">expected = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s1">assert_eq(a2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>

    <span class="s1">a[</span><span class="s3">3</span><span class="s1">:</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:].to_zarr(z</span><span class="s0">, </span><span class="s1">region=(slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">a2 = da.from_zarr(z)</span>
    <span class="s1">expected = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s1">assert_eq(a2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">a2.chunks == a.chunks</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">d:</span>
            <span class="s1">a.to_zarr(d</span><span class="s0">, </span><span class="s1">region=(slice(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">2</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_tiledb_roundtrip():</span>
    <span class="s1">tiledb = pytest.importorskip(</span><span class="s2">&quot;tiledb&quot;</span><span class="s1">)</span>
    <span class="s4"># 1) load with default chunking</span>
    <span class="s4"># 2) load from existing tiledb.DenseArray</span>
    <span class="s4"># 3) write to existing tiledb.DenseArray</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">a = rng.random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">uri:</span>
        <span class="s1">da.to_tiledb(a</span><span class="s0">, </span><span class="s1">uri)</span>
        <span class="s1">tdb = da.from_tiledb(uri)</span>

        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">tdb)</span>
        <span class="s0">assert </span><span class="s1">a.chunks == tdb.chunks</span>

        <span class="s4"># from tiledb.array</span>
        <span class="s0">with </span><span class="s1">tiledb.open(uri) </span><span class="s0">as </span><span class="s1">t:</span>
            <span class="s1">tdb2 = da.from_tiledb(t)</span>
            <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">tdb2)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">uri2:</span>
        <span class="s0">with </span><span class="s1">tiledb.empty_like(uri2</span><span class="s0">, </span><span class="s1">a) </span><span class="s0">as </span><span class="s1">t:</span>
            <span class="s1">a.to_tiledb(t)</span>
            <span class="s1">assert_eq(da.from_tiledb(uri2)</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s4"># specific chunking</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">uri:</span>
        <span class="s1">a = rng.random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">a.to_tiledb(uri)</span>
        <span class="s1">tdb = da.from_tiledb(uri)</span>

        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">tdb)</span>
        <span class="s0">assert </span><span class="s1">a.chunks == tdb.chunks</span>


<span class="s0">def </span><span class="s1">test_tiledb_multiattr():</span>
    <span class="s1">tiledb = pytest.importorskip(</span><span class="s2">&quot;tiledb&quot;</span><span class="s1">)</span>
    <span class="s1">dom = tiledb.Domain(</span>
        <span class="s1">tiledb.Dim(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tile=</span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tiledb.Dim(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tile=</span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">schema = tiledb.ArraySchema(</span>
        <span class="s1">attrs=(tiledb.Attr(</span><span class="s2">&quot;attr1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tiledb.Attr(</span><span class="s2">&quot;attr2&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">domain=dom</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">uri:</span>
        <span class="s1">tiledb.DenseArray.create(uri</span><span class="s0">, </span><span class="s1">schema)</span>
        <span class="s1">tdb = tiledb.DenseArray(uri</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">)</span>

        <span class="s1">rng = np.random.default_rng()</span>
        <span class="s1">ar1 = rng.standard_normal(tdb.schema.shape)</span>
        <span class="s1">ar2 = rng.standard_normal(tdb.schema.shape)</span>

        <span class="s1">tdb[:] = {</span><span class="s2">&quot;attr1&quot;</span><span class="s1">: ar1</span><span class="s0">, </span><span class="s2">&quot;attr2&quot;</span><span class="s1">: ar2}</span>
        <span class="s1">tdb = tiledb.DenseArray(uri</span><span class="s0">, </span><span class="s2">&quot;r&quot;</span><span class="s1">)</span>

        <span class="s4"># basic round-trip from dask.array</span>
        <span class="s1">d = da.from_tiledb(uri</span><span class="s0">, </span><span class="s1">attribute=</span><span class="s2">&quot;attr2&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">ar2)</span>

        <span class="s4"># smoke-test computation directly on the TileDB view</span>
        <span class="s1">d = da.from_tiledb(uri</span><span class="s0">, </span><span class="s1">attribute=</span><span class="s2">&quot;attr2&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(np.mean(ar2)</span><span class="s0">, </span><span class="s1">d.mean().compute(scheduler=</span><span class="s2">&quot;threads&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_blockview():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">blockview = BlockView(x)</span>
    <span class="s0">assert </span><span class="s1">x.blocks == blockview</span>
    <span class="s0">assert </span><span class="s1">isinstance(blockview[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(blockview[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[-</span><span class="s3">2</span><span class="s1">:])</span>
    <span class="s1">assert_eq(blockview[:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview[[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]))</span>
    <span class="s1">assert_eq(blockview.shape</span><span class="s0">, </span><span class="s1">tuple(map(len</span><span class="s0">, </span><span class="s1">x.chunks)))</span>
    <span class="s1">assert_eq(blockview.size</span><span class="s0">, </span><span class="s1">math.prod(blockview.shape))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">blockview.ravel()</span><span class="s0">, </span><span class="s1">[blockview[idx] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">np.ndindex(blockview.shape)]</span>
    <span class="s1">)</span>

    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">blockview = BlockView(x)</span>
    <span class="s1">assert_eq(blockview[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>
    <span class="s1">assert_eq(blockview.shape</span><span class="s0">, </span><span class="s1">tuple(map(len</span><span class="s0">, </span><span class="s1">x.chunks)))</span>
    <span class="s1">assert_eq(blockview.size</span><span class="s0">, </span><span class="s1">math.prod(blockview.shape))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">blockview.ravel()</span><span class="s0">, </span><span class="s1">[blockview[idx] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">np.ndindex(blockview.shape)]</span>
    <span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">blockview = BlockView(x)</span>
    <span class="s1">assert_eq(blockview[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>
    <span class="s1">assert_eq(blockview.shape</span><span class="s0">, </span><span class="s1">tuple(map(len</span><span class="s0">, </span><span class="s1">x.chunks)))</span>
    <span class="s1">assert_eq(blockview.size</span><span class="s0">, </span><span class="s1">math.prod(blockview.shape))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">blockview.ravel()</span><span class="s0">, </span><span class="s1">[blockview[idx] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">np.ndindex(blockview.shape)]</span>
    <span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">blockview[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">blockview[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">blockview[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span>
    <span class="s0">assert </span><span class="s2">&quot;list&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">blockview[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s0">assert </span><span class="s2">&quot;newaxis&quot; </span><span class="s0">in </span><span class="s1">str(info.value) </span><span class="s0">and </span><span class="s2">&quot;not supported&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">blockview[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_blocks_indexer():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">isinstance(x.blocks[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(x.blocks[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.blocks[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[-</span><span class="s3">2</span><span class="s1">:])</span>
    <span class="s1">assert_eq(x.blocks[:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.blocks[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.blocks[[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]))</span>

    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.blocks[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.blocks[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.blocks[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>

    <span class="s1">x = da.ones((</span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.blocks[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>

    <span class="s1">x = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.blocks[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.blocks[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.blocks[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span>
    <span class="s0">assert </span><span class="s2">&quot;list&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.blocks[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s0">assert </span><span class="s2">&quot;newaxis&quot; </span><span class="s0">in </span><span class="s1">str(info.value) </span><span class="s0">and </span><span class="s2">&quot;not supported&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.blocks[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_partitions_indexer():</span>
    <span class="s4"># .partitions is an alias of .blocks for dask arrays</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">isinstance(x.partitions[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(x.partitions[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.partitions[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[-</span><span class="s3">2</span><span class="s1">:])</span>
    <span class="s1">assert_eq(x.partitions[:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.partitions[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.partitions[[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]))</span>

    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.partitions[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.partitions[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>
    <span class="s1">assert_eq(x.partitions[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">15</span><span class="s1">])</span>

    <span class="s1">x = da.ones((</span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.partitions[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>

    <span class="s1">x = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.partitions[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x.partitions[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.partitions[np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])]</span>
    <span class="s0">assert </span><span class="s2">&quot;list&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.partitions[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s0">assert </span><span class="s2">&quot;newaxis&quot; </span><span class="s0">in </span><span class="s1">str(info.value) </span><span class="s0">and </span><span class="s2">&quot;not supported&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.partitions[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:the matrix subclass:PendingDeprecationWarning&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_dask_array_holds_scipy_sparse_containers():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;scipy.sparse&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">scipy.sparse</span>

    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">x[x &lt; </span><span class="s3">0.9</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">xx = x.compute()</span>
    <span class="s1">y = x.map_blocks(scipy.sparse.csr_matrix)</span>

    <span class="s1">vs = y.to_delayed().flatten().tolist()</span>
    <span class="s1">values = dask.compute(*vs</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(isinstance(v</span><span class="s0">, </span><span class="s1">scipy.sparse.csr_matrix) </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">values)</span>

    <span class="s1">yy = y.compute(scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(yy</span><span class="s0">, </span><span class="s1">scipy.sparse.spmatrix)</span>
    <span class="s0">assert </span><span class="s1">(yy == xx).all()</span>

    <span class="s1">z = x.T.map_blocks(scipy.sparse.csr_matrix)</span>
    <span class="s1">zz = z.compute(scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(zz</span><span class="s0">, </span><span class="s1">scipy.sparse.spmatrix)</span>
    <span class="s0">assert </span><span class="s1">(zz == xx.T).all()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_scipy_sparse_concatenate(axis):</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;scipy.sparse&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">scipy.sparse</span>

    <span class="s1">rng = da.random.default_rng()</span>

    <span class="s1">xs = []</span>
    <span class="s1">ys = []</span>
    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
        <span class="s1">x = rng.random((</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
        <span class="s1">x[x &lt; </span><span class="s3">0.9</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">xs.append(x)</span>
        <span class="s1">ys.append(x.map_blocks(scipy.sparse.csr_matrix))</span>

    <span class="s1">z = da.concatenate(ys</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s1">z = z.compute()</span>

    <span class="s0">if </span><span class="s1">axis == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s1">sp_concatenate = scipy.sparse.vstack</span>
    <span class="s0">elif </span><span class="s1">axis == </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s1">sp_concatenate = scipy.sparse.hstack</span>
    <span class="s1">z_expected = sp_concatenate([scipy.sparse.csr_matrix(e.compute()) </span><span class="s0">for </span><span class="s1">e </span><span class="s0">in </span><span class="s1">xs])</span>

    <span class="s0">assert </span><span class="s1">(z != z_expected).nnz == </span><span class="s3">0</span>


<span class="s0">def </span><span class="s1">test_3851():</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">Y = da.random.default_rng().random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s1">da.argmax(Y</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">).compute()</span>
    <span class="s0">assert not </span><span class="s1">record</span>


<span class="s0">def </span><span class="s1">test_3925():</span>
    <span class="s1">x = da.from_array(np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(x[</span><span class="s3">0</span><span class="s1">] == x[</span><span class="s3">0</span><span class="s1">]).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_large_inputs_delayed():</span>
    <span class="s1">a = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = np.ones(</span><span class="s3">1000000</span><span class="s1">)</span>

    <span class="s1">c = a.map_blocks(add</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s0">assert </span><span class="s1">any(b </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">c.dask.values())</span>
    <span class="s0">assert </span><span class="s1">repr(dict(c.dask)).count(repr(b)[:</span><span class="s3">10</span><span class="s1">]) == </span><span class="s3">1  </span><span class="s4"># only one occurrence</span>

    <span class="s1">d = a.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y.sum()</span><span class="s0">, </span><span class="s1">y=b)</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">d)</span>
    <span class="s0">assert </span><span class="s1">any(b </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">d.dask.values())</span>
    <span class="s0">assert </span><span class="s1">repr(dict(c.dask)).count(repr(b)[:</span><span class="s3">10</span><span class="s1">]) == </span><span class="s3">1  </span><span class="s4"># only one occurrence</span>


<span class="s0">def </span><span class="s1">test_blockwise_large_inputs_delayed():</span>
    <span class="s1">a = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = np.ones(</span><span class="s3">1000000</span><span class="s1">)</span>

    <span class="s1">c = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, None, </span><span class="s1">dtype=a.dtype)</span>
    <span class="s0">assert </span><span class="s1">any(b </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">c.dask.values())</span>
    <span class="s0">assert </span><span class="s1">repr(dict(c.dask)).count(repr(b)[:</span><span class="s3">10</span><span class="s1">]) == </span><span class="s3">1  </span><span class="s4"># only one occurrence</span>

    <span class="s1">d = da.blockwise(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">y=b</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
    <span class="s0">assert </span><span class="s1">any(b </span><span class="s0">is </span><span class="s1">v </span><span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">d.dask.values())</span>
    <span class="s0">assert </span><span class="s1">repr(dict(c.dask)).count(repr(b)[:</span><span class="s3">10</span><span class="s1">]) == </span><span class="s3">1  </span><span class="s4"># only one occurrence</span>


<span class="s0">def </span><span class="s1">test_slice_reversed():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">y = x[</span><span class="s3">6</span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_blocks_chunks():</span>
    <span class="s1">x = da.arange(</span><span class="s3">400</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">100</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.arange(</span><span class="s3">40</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">func(a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">return </span><span class="s1">np.array([a.max()</span><span class="s0">, </span><span class="s1">b.max()])</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.map_blocks(func</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">99</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">199</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">299</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">399</span><span class="s0">, </span><span class="s3">39</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_nbytes_auto():</span>
    <span class="s1">chunks = normalize_chunks(</span><span class="s2">&quot;800B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">chunks = normalize_chunks(</span><span class="s2">&quot;200B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">chunks = normalize_chunks((</span><span class="s3">5</span><span class="s0">, </span><span class="s2">&quot;200B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">chunks = normalize_chunks(</span><span class="s2">&quot;33B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">chunks = normalize_chunks(</span><span class="s2">&quot;1800B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks(</span><span class="s2">&quot;10B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">20</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks(</span><span class="s2">&quot;100B&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">20</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks((</span><span class="s2">&quot;100B&quot;</span><span class="s0">, </span><span class="s2">&quot;10B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">normalize_chunks((</span><span class="s2">&quot;10B&quot;</span><span class="s0">, </span><span class="s2">&quot;10B&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">limit=</span><span class="s3">20</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_auto_chunks_h5py():</span>
    <span class="s1">h5py = pytest.importorskip(</span><span class="s2">&quot;h5py&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.hdf5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f.create_dataset(</span>
                <span class="s2">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">32</span><span class="s0">, </span><span class="s3">64</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span>
            <span class="s1">)</span>
            <span class="s1">d[:] = </span><span class="s3">1</span>

        <span class="s0">with </span><span class="s1">h5py.File(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">d = f[</span><span class="s2">&quot;x&quot;</span><span class="s1">]</span>
            <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;1 MiB&quot;</span><span class="s1">}):</span>
                <span class="s1">x = da.from_array(d)</span>
                <span class="s0">assert </span><span class="s1">isinstance(x._meta</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
                <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">256</span><span class="s0">, </span><span class="s3">256</span><span class="s0">, </span><span class="s3">256</span><span class="s0">, </span><span class="s3">232</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">512</span><span class="s0">, </span><span class="s3">488</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_no_warnings_from_blockwise():</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">x = da.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">da.map_blocks(</span><span class="s0">lambda </span><span class="s1">y: np.mean(y</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">drop_axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert not </span><span class="s1">record</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">x = da.ones((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
        <span class="s1">(x.dot(x.T + </span><span class="s3">1</span><span class="s1">) - x.mean(axis=</span><span class="s3">0</span><span class="s1">)).std()</span>
    <span class="s0">assert not </span><span class="s1">record</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">x = da.ones((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s3">1 </span><span class="s1">/ x[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert not </span><span class="s1">record</span>


<span class="s0">def </span><span class="s1">test_from_array_meta():</span>
    <span class="s1">sparse = pytest.importorskip(</span><span class="s2">&quot;sparse&quot;</span><span class="s1">)</span>
    <span class="s1">x = np.ones(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">meta = sparse.COO.from_numpy(x)</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">meta=meta)</span>
    <span class="s0">assert </span><span class="s1">isinstance(y._meta</span><span class="s0">, </span><span class="s1">sparse.COO)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes():</span>
    <span class="s1">x = da.from_array(np.linspace(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = x[x &lt; </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">np.isnan(y.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((np.nan</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">z = y.compute_chunk_sizes()</span>
    <span class="s0">assert </span><span class="s1">y </span><span class="s0">is </span><span class="s1">z</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(z) == </span><span class="s3">25</span>

    <span class="s4"># check that dtype of chunk dimensions is `int`</span>
    <span class="s0">assert </span><span class="s1">isinstance(z.chunks[</span><span class="s3">0</span><span class="s1">][</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_2d_array():</span>
    <span class="s1">X = np.linspace(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">9 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">).reshape(</span><span class="s3">9</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">X = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">idx = X.sum(axis=</span><span class="s3">1</span><span class="s1">) &gt; </span><span class="s3">0</span>
    <span class="s1">Y = X[idx]</span>

    <span class="s4"># This is very similar to the DataFrame-&gt;Array conversion</span>
    <span class="s0">assert </span><span class="s1">np.isnan(Y.shape[</span><span class="s3">0</span><span class="s1">]) </span><span class="s0">and </span><span class="s1">Y.shape[</span><span class="s3">1</span><span class="s1">] == </span><span class="s3">4</span>
    <span class="s0">assert </span><span class="s1">Y.chunks == ((np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">Z = Y.compute_chunk_sizes()</span>
    <span class="s0">assert </span><span class="s1">Y </span><span class="s0">is </span><span class="s1">Z</span>
    <span class="s0">assert </span><span class="s1">Z.chunks == ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">Z.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_3d_array(N=</span><span class="s3">8</span><span class="s1">):</span>
    <span class="s1">X = np.linspace(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">8 </span><span class="s1">* </span><span class="s3">8 </span><span class="s1">* </span><span class="s3">8</span><span class="s1">).reshape(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">X = da.from_array(X</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">idx = X.sum(axis=</span><span class="s3">0</span><span class="s1">).sum(axis=</span><span class="s3">0</span><span class="s1">) &gt; </span><span class="s3">0</span>
    <span class="s1">Y = X[idx]</span>
    <span class="s1">idx = X.sum(axis=</span><span class="s3">1</span><span class="s1">).sum(axis=</span><span class="s3">1</span><span class="s1">) &lt; </span><span class="s3">0</span>
    <span class="s1">Y = Y[:</span><span class="s0">, </span><span class="s1">idx]</span>
    <span class="s1">idx = X.sum(axis=</span><span class="s3">2</span><span class="s1">).sum(axis=</span><span class="s3">1</span><span class="s1">) &gt; </span><span class="s3">0.1</span>
    <span class="s1">Y = Y[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">idx]</span>

    <span class="s4"># Checking to make sure shapes are different on outputs</span>
    <span class="s0">assert </span><span class="s1">Y.compute().shape == (</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">X.compute().shape == (</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">Y.chunks == ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span>
    <span class="s0">assert </span><span class="s1">all(np.isnan(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">Y.shape)</span>
    <span class="s1">Z = Y.compute_chunk_sizes()</span>
    <span class="s0">assert </span><span class="s1">Z </span><span class="s0">is </span><span class="s1">Y</span>
    <span class="s0">assert </span><span class="s1">Z.shape == (</span><span class="s3">8</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">Z.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">_known(num=</span><span class="s3">50</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">da.from_array(np.linspace(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">num=num)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>


<span class="s1">@pytest.fixture()</span>
<span class="s0">def </span><span class="s1">unknown():</span>
    <span class="s1">x = _known()</span>
    <span class="s1">y = x[x &lt; </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((np.nan</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">return </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_rechunk(unknown):</span>
    <span class="s1">y = unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">y.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
    <span class="s1">y.compute_chunk_sizes()</span>
    <span class="s1">y.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_to_zarr(unknown):</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s1">y = unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">StringIO() </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">y.to_zarr(f)</span>
    <span class="s1">y.compute_chunk_sizes()</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;irregular chunking&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">StringIO() </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">y.to_zarr(f)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_to_svg(unknown):</span>
    <span class="s1">y = unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">y.to_svg()</span>
    <span class="s1">y.compute_chunk_sizes()</span>
    <span class="s1">y.to_svg()</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_concatenate():</span>
    <span class="s1">x = _known(num=</span><span class="s3">100</span><span class="s1">).reshape(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">idx = x.sum(axis=</span><span class="s3">0</span><span class="s1">) &gt; </span><span class="s3">0</span>
    <span class="s1">y1 = x[idx]</span>
    <span class="s1">y2 = x[idx]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">da.concatenate((y1</span><span class="s0">, </span><span class="s1">y2)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">y1.compute_chunk_sizes()</span>
    <span class="s1">y2.compute_chunk_sizes()</span>
    <span class="s1">da.concatenate((y1</span><span class="s0">, </span><span class="s1">y2)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_reduction(unknown):</span>
    <span class="s1">y = unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">da.argmin(y)</span>
    <span class="s1">y.compute_chunk_sizes()</span>
    <span class="s1">da.argmin(y)</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_reshape(unknown):</span>
    <span class="s1">y = unknown</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">da.reshape(y</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y.compute_chunk_sizes()</span>
    <span class="s1">da.reshape(y</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_compute_chunk_sizes_warning_fixes_slicing():</span>
    <span class="s1">x = _known(num=</span><span class="s3">100</span><span class="s1">).reshape(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = x[x.sum(axis=</span><span class="s3">0</span><span class="s1">) &lt; </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;compute_chunk_sizes&quot;</span><span class="s1">):</span>
        <span class="s1">y[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">y.compute_chunk_sizes()</span>
    <span class="s1">y[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:]</span>


<span class="s0">def </span><span class="s1">test_rechunk_auto():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk()</span>

    <span class="s0">assert </span><span class="s1">y.npartitions == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_chunk_assignment_invalidates_cached_properties():</span>
    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = x.copy()</span>
    <span class="s4"># change chunks directly, which should change all of the tested properties</span>
    <span class="s1">y._chunks = ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">assert not </span><span class="s1">x.ndim == y.ndim</span>
    <span class="s0">assert not </span><span class="s1">x.shape == y.shape</span>
    <span class="s0">assert not </span><span class="s1">x.size == y.size</span>
    <span class="s0">assert not </span><span class="s1">x.numblocks == y.numblocks</span>
    <span class="s0">assert not </span><span class="s1">x.npartitions == y.npartitions</span>
    <span class="s0">assert not </span><span class="s1">x.__dask_keys__() == y.__dask_keys__()</span>
    <span class="s0">assert not </span><span class="s1">np.array_equal(x._key_array</span><span class="s0">, </span><span class="s1">y._key_array)</span>


<span class="s0">def </span><span class="s1">test_map_blocks_series():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">dask.dataframe </span><span class="s0">as </span><span class="s1">dd</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.utils </span><span class="s0">import </span><span class="s1">assert_eq </span><span class="s0">as </span><span class="s1">dd_assert_eq</span>

    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">s = x.map_blocks(pd.Series)</span>
    <span class="s0">assert </span><span class="s1">isinstance(s</span><span class="s0">, </span><span class="s1">dd.Series)</span>
    <span class="s0">assert </span><span class="s1">s.npartitions == x.npartitions</span>

    <span class="s1">dd_assert_eq(s</span><span class="s0">, </span><span class="s1">s)</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;need to remove singleton index dimension&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_map_blocks_dataframe():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">dask.dataframe </span><span class="s0">as </span><span class="s1">dd</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.utils </span><span class="s0">import </span><span class="s1">assert_eq </span><span class="s0">as </span><span class="s1">dd_assert_eq</span>

    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">s = x.map_blocks(pd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">isinstance(s</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">s.npartitions == x.npartitions</span>
    <span class="s1">dd_assert_eq(s</span><span class="s0">, </span><span class="s1">s)</span>


<span class="s0">def </span><span class="s1">test_dask_layers():</span>
    <span class="s1">a = da.ones(</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a.dask.layers.keys() == {a.name}</span>
    <span class="s0">assert </span><span class="s1">a.dask.dependencies == {a.name: set()}</span>
    <span class="s0">assert </span><span class="s1">a.__dask_layers__() == (a.name</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">b = a + </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">b.dask.layers.keys() == {a.name</span><span class="s0">, </span><span class="s1">b.name}</span>
    <span class="s0">assert </span><span class="s1">b.dask.dependencies == {a.name: set()</span><span class="s0">, </span><span class="s1">b.name: {a.name}}</span>
    <span class="s0">assert </span><span class="s1">b.__dask_layers__() == (b.name</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_len_object_with_unknown_size():</span>
    <span class="s1">a = da.random.default_rng().random(size=(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">b = a[a &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;on object with unknown chunk size&quot;</span><span class="s1">):</span>
        <span class="s0">assert </span><span class="s1">len(b)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ndim&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_chunk_shape_broadcast(ndim):</span>
    <span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>

    <span class="s0">def </span><span class="s1">f(x</span><span class="s0">, </span><span class="s1">ndim=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s4"># Ignore `x` and return arbitrary one-element array of dimensionality `ndim`</span>
        <span class="s4"># For example,</span>
        <span class="s4"># f(x, 0) = array(5)</span>
        <span class="s4"># f(x, 1) = array([5])</span>
        <span class="s4"># f(x, 2) = array([[5]])</span>
        <span class="s4"># f(x, 3) = array([[[5]]])</span>
        <span class="s0">return </span><span class="s1">np.array(</span><span class="s3">5</span><span class="s1">)[(np.newaxis</span><span class="s0">,</span><span class="s1">) * ndim]</span>

    <span class="s1">array = da.from_array([</span><span class="s3">1</span><span class="s1">] + [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">] + [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">out_chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s4"># check ``enforce_ndim`` keyword parameter of ``map_blocks()``</span>
    <span class="s1">out = array.map_blocks(partial(f</span><span class="s0">, </span><span class="s1">ndim=ndim)</span><span class="s0">, </span><span class="s1">chunks=out_chunks</span><span class="s0">, </span><span class="s1">enforce_ndim=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">ndim != </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Dimension mismatch:&quot;</span><span class="s1">):</span>
            <span class="s1">out.compute()</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">out.compute()  </span><span class="s4"># should not raise an exception</span>

    <span class="s4"># check ``check_ndim`` keyword parameter of ``assert_eq()``</span>
    <span class="s1">out = array.map_blocks(partial(f</span><span class="s0">, </span><span class="s1">ndim=ndim)</span><span class="s0">, </span><span class="s1">chunks=out_chunks)</span>
    <span class="s1">expected = np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">except </span><span class="s1">AssertionError:</span>
        <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_ndim=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">ndim != </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">&quot;Expected a ValueError: Dimension mismatch&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_chunk_non_array_like():</span>
    <span class="s1">array = da.from_array([</span><span class="s3">1</span><span class="s1">] + [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">] + [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">out_chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s4"># check ``enforce_ndim`` keyword parameter of ``map_blocks()``</span>
    <span class="s1">out = array.map_blocks(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=out_chunks</span><span class="s0">, </span><span class="s1">enforce_ndim=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Dimension mismatch:&quot;</span><span class="s1">):</span>
        <span class="s1">out.compute()</span>

    <span class="s1">expected = np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s4"># check ``check_ndim`` keyword parameter of ``assert_eq()``</span>
    <span class="s1">out = array.map_blocks(</span><span class="s0">lambda </span><span class="s1">x: </span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=out_chunks)</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">except </span><span class="s1">AssertionError:</span>
        <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_chunks=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">AssertionError(</span><span class="s2">&quot;Expected a ValueError: Dimension mismatch&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_backend():</span>
    <span class="s4"># Test that `Array.to_backend` works as expected</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.backend&quot;</span><span class="s1">: </span><span class="s2">&quot;numpy&quot;</span><span class="s1">}):</span>
        <span class="s4"># Start with numpy-backed array</span>
        <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(x._meta</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

        <span class="s4"># Default `to_backend` shouldn't change data</span>
        <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">x.to_backend())</span>

        <span class="s4"># Moving to a &quot;missing&quot; backend should raise an error</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;No backend dispatch registered&quot;</span><span class="s1">):</span>
            <span class="s1">x.to_backend(</span><span class="s2">&quot;missing&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>