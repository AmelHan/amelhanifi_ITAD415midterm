<html>
<head>
<title>test_binned_statistic.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_binned_statistic.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">from </span><span class="s1">scipy.stats </span><span class="s0">import </span><span class="s1">(binned_statistic</span><span class="s0">, </span><span class="s1">binned_statistic_2d</span><span class="s0">,</span>
                         <span class="s1">binned_statistic_dd)</span>
<span class="s0">from </span><span class="s1">scipy._lib._util </span><span class="s0">import </span><span class="s1">check_random_state</span>

<span class="s0">from </span><span class="s1">.common_tests </span><span class="s0">import </span><span class="s1">check_named_results</span>


<span class="s0">class </span><span class="s1">TestBinnedStatistic:</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">rng = check_random_state(</span><span class="s2">9865</span><span class="s1">)</span>
        <span class="s1">cls.x = rng.uniform(size=</span><span class="s2">100</span><span class="s1">)</span>
        <span class="s1">cls.y = rng.uniform(size=</span><span class="s2">100</span><span class="s1">)</span>
        <span class="s1">cls.v = rng.uniform(size=</span><span class="s2">100</span><span class="s1">)</span>
        <span class="s1">cls.X = rng.uniform(size=(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
        <span class="s1">cls.w = rng.uniform(size=</span><span class="s2">100</span><span class="s1">)</span>
        <span class="s1">cls.u = rng.uniform(size=</span><span class="s2">100</span><span class="s1">) + </span><span class="s2">1e6</span>

    <span class="s0">def </span><span class="s1">test_1d_count(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">count2</span><span class="s0">, </span><span class="s1">edges2 = np.histogram(x</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(count1</span><span class="s0">, </span><span class="s1">count2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_gh5927(self):</span>
        <span class="s4"># smoke test for gh5927 - binned_statistic was using `is` for string</span>
        <span class="s4"># comparison</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>
        <span class="s1">statistics = [</span><span class="s3">'mean'</span><span class="s0">, </span><span class="s3">'median'</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s3">'sum'</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">statistic </span><span class="s0">in </span><span class="s1">statistics:</span>
            <span class="s1">binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">statistic</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_big_number_std(self):</span>
        <span class="s4"># tests for numerical stability of std calculation</span>
        <span class="s4"># see issue gh-10126 for more</span>
        <span class="s1">x = self.x</span>
        <span class="s1">u = self.u</span>
        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>

    <span class="s0">def </span><span class="s1">test_empty_bins_std(self):</span>
        <span class="s4"># tests that std returns gives nan for empty bins</span>
        <span class="s1">x = self.x</span>
        <span class="s1">u = self.u</span>
        <span class="s1">print(binned_statistic(x</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">1000</span><span class="s1">))</span>
        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">1000</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">1000</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>

    <span class="s0">def </span><span class="s1">test_non_finite_inputs_and_int_bins(self):</span>
        <span class="s4"># if either `values` or `sample` contain np.inf or np.nan throw</span>
        <span class="s4"># see issue gh-9010 for more</span>
        <span class="s1">x = self.x</span>
        <span class="s1">u = self.u</span>
        <span class="s1">orig = u[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">u[</span><span class="s2">0</span><span class="s1">] = np.inf</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">binned_statistic</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s4"># need to test for non-python specific ints, e.g. np.int8, np.int64</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">binned_statistic</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">,</span>
                      <span class="s1">bins=np.int64(</span><span class="s2">10</span><span class="s1">))</span>
        <span class="s1">u[</span><span class="s2">0</span><span class="s1">] = np.nan</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">binned_statistic</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s4"># replace original value, u belongs the class</span>
        <span class="s1">u[</span><span class="s2">0</span><span class="s1">] = orig</span>

    <span class="s0">def </span><span class="s1">test_1d_result_attributes(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">res = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">attributes = (</span><span class="s3">'statistic'</span><span class="s0">, </span><span class="s3">'bin_edges'</span><span class="s0">, </span><span class="s3">'binnumber'</span><span class="s1">)</span>
        <span class="s1">check_named_results(res</span><span class="s0">, </span><span class="s1">attributes)</span>

    <span class="s0">def </span><span class="s1">test_1d_sum(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">sum1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'sum'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">sum2</span><span class="s0">, </span><span class="s1">edges2 = np.histogram(x</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s0">, </span><span class="s1">weights=v)</span>

        <span class="s1">assert_allclose(sum1</span><span class="s0">, </span><span class="s1">sum2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_mean(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.mean</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_std(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_min(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'min'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.min</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_max(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'max'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.max</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_median(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'median'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.median</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_1d_bincode(self):</span>
        <span class="s1">x = self.x[:</span><span class="s2">20</span><span class="s1">]</span>
        <span class="s1">v = self.v[:</span><span class="s2">20</span><span class="s1">]</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">bc2 = np.array([</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s0">,</span>
                        <span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>

        <span class="s1">bcount = [(bc == i).sum() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">np.unique(bc)]</span>

        <span class="s1">assert_allclose(bc</span><span class="s0">, </span><span class="s1">bc2)</span>
        <span class="s1">assert_allclose(bcount</span><span class="s0">, </span><span class="s1">count1)</span>

    <span class="s0">def </span><span class="s1">test_1d_range_keyword(self):</span>
        <span class="s4"># Regression test for gh-3063, range can be (min, max) or [(min, max)]</span>
        <span class="s1">np.random.seed(</span><span class="s2">9865</span><span class="s1">)</span>
        <span class="s1">x = np.arange(</span><span class="s2">30</span><span class="s1">)</span>
        <span class="s1">data = np.random.random(</span><span class="s2">30</span><span class="s1">)</span>

        <span class="s1">mean</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">_ = binned_statistic(x[:</span><span class="s2">15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">data[:</span><span class="s2">15</span><span class="s1">])</span>
        <span class="s1">mean_range</span><span class="s0">, </span><span class="s1">bins_range</span><span class="s0">, </span><span class="s1">_ = binned_statistic(x</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">range=[(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">14</span><span class="s1">)])</span>
        <span class="s1">mean_range2</span><span class="s0">, </span><span class="s1">bins_range2</span><span class="s0">, </span><span class="s1">_ = binned_statistic(x</span><span class="s0">, </span><span class="s1">data</span><span class="s0">, </span><span class="s1">range=(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">14</span><span class="s1">))</span>

        <span class="s1">assert_allclose(mean</span><span class="s0">, </span><span class="s1">mean_range)</span>
        <span class="s1">assert_allclose(bins</span><span class="s0">, </span><span class="s1">bins_range)</span>
        <span class="s1">assert_allclose(mean</span><span class="s0">, </span><span class="s1">mean_range2)</span>
        <span class="s1">assert_allclose(bins</span><span class="s0">, </span><span class="s1">bins_range2)</span>

    <span class="s0">def </span><span class="s1">test_1d_multi_values(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">v = self.v</span>
        <span class="s1">w = self.w</span>

        <span class="s1">stat1v</span><span class="s0">, </span><span class="s1">edges1v</span><span class="s0">, </span><span class="s1">bc1v = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat1w</span><span class="s0">, </span><span class="s1">edges1w</span><span class="s0">, </span><span class="s1">bc1w = binned_statistic(x</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc2 = binned_statistic(x</span><span class="s0">, </span><span class="s1">[v</span><span class="s0">, </span><span class="s1">w]</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat2[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1v)</span>
        <span class="s1">assert_allclose(stat2[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1w)</span>
        <span class="s1">assert_allclose(edges1v</span><span class="s0">, </span><span class="s1">edges2)</span>
        <span class="s1">assert_allclose(bc1v</span><span class="s0">, </span><span class="s1">bc2)</span>

    <span class="s0">def </span><span class="s1">test_2d_count(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">count2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2 = np.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(count1</span><span class="s0">, </span><span class="s1">count2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_result_attributes(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">res = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">attributes = (</span><span class="s3">'statistic'</span><span class="s0">, </span><span class="s3">'x_edge'</span><span class="s0">, </span><span class="s3">'y_edge'</span><span class="s0">, </span><span class="s3">'binnumber'</span><span class="s1">)</span>
        <span class="s1">check_named_results(res</span><span class="s0">, </span><span class="s1">attributes)</span>

    <span class="s0">def </span><span class="s1">test_2d_sum(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">sum1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'sum'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">sum2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2 = np.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s0">, </span><span class="s1">weights=v)</span>

        <span class="s1">assert_allclose(sum1</span><span class="s0">, </span><span class="s1">sum2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_mean(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.mean</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_mean_unicode(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>
        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.mean</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_std(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_min(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'min'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.min</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_max(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'max'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.max</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_median(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'median'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.median</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(binx1</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1</span><span class="s0">, </span><span class="s1">biny2)</span>

    <span class="s0">def </span><span class="s1">test_2d_bincode(self):</span>
        <span class="s1">x = self.x[:</span><span class="s2">20</span><span class="s1">]</span>
        <span class="s1">y = self.y[:</span><span class="s2">20</span><span class="s1">]</span>
        <span class="s1">v = self.v[:</span><span class="s2">20</span><span class="s1">]</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">binx1</span><span class="s0">, </span><span class="s1">biny1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">bc2 = np.array([</span><span class="s2">17</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">16</span><span class="s0">,</span>
                        <span class="s2">6</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">8</span><span class="s1">])</span>

        <span class="s1">bcount = [(bc == i).sum() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">np.unique(bc)]</span>

        <span class="s1">assert_allclose(bc</span><span class="s0">, </span><span class="s1">bc2)</span>
        <span class="s1">count1adj = count1[count1.nonzero()]</span>
        <span class="s1">assert_allclose(bcount</span><span class="s0">, </span><span class="s1">count1adj)</span>

    <span class="s0">def </span><span class="s1">test_2d_multi_values(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>
        <span class="s1">w = self.w</span>

        <span class="s1">stat1v</span><span class="s0">, </span><span class="s1">binx1v</span><span class="s0">, </span><span class="s1">biny1v</span><span class="s0">, </span><span class="s1">bc1v = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>
        <span class="s1">stat1w</span><span class="s0">, </span><span class="s1">binx1w</span><span class="s0">, </span><span class="s1">biny1w</span><span class="s0">, </span><span class="s1">bc1w = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">binx2</span><span class="s0">, </span><span class="s1">biny2</span><span class="s0">, </span><span class="s1">bc2 = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">[v</span><span class="s0">, </span><span class="s1">w]</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat2[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1v)</span>
        <span class="s1">assert_allclose(stat2[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1w)</span>
        <span class="s1">assert_allclose(binx1v</span><span class="s0">, </span><span class="s1">binx2)</span>
        <span class="s1">assert_allclose(biny1w</span><span class="s0">, </span><span class="s1">biny2)</span>
        <span class="s1">assert_allclose(bc1v</span><span class="s0">, </span><span class="s1">bc2)</span>

    <span class="s0">def </span><span class="s1">test_2d_binnumbers_unraveled(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">y = self.y</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat</span><span class="s0">, </span><span class="s1">edgesx</span><span class="s0">, </span><span class="s1">bcx = binned_statistic(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">20</span><span class="s1">)</span>
        <span class="s1">stat</span><span class="s0">, </span><span class="s1">edgesy</span><span class="s0">, </span><span class="s1">bcy = binned_statistic(y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edgesx2</span><span class="s0">, </span><span class="s1">edgesy2</span><span class="s0">, </span><span class="s1">bc2 = binned_statistic_2d(</span>
            <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=(</span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expand_binnumbers=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">bcx3 = np.searchsorted(edgesx</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">side=</span><span class="s3">'right'</span><span class="s1">)</span>
        <span class="s1">bcy3 = np.searchsorted(edgesy</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">side=</span><span class="s3">'right'</span><span class="s1">)</span>

        <span class="s4"># `numpy.searchsorted` is non-inclusive on right-edge, compensate</span>
        <span class="s1">bcx3[x == x.max()] -= </span><span class="s2">1</span>
        <span class="s1">bcy3[y == y.max()] -= </span><span class="s2">1</span>

        <span class="s1">assert_allclose(bcx</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(bcy</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">assert_allclose(bcx3</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(bcy3</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_dd_count(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">count2</span><span class="s0">, </span><span class="s1">edges2 = np.histogramdd(X</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(count1</span><span class="s0">, </span><span class="s1">count2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_result_attributes(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">res = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">attributes = (</span><span class="s3">'statistic'</span><span class="s0">, </span><span class="s3">'bin_edges'</span><span class="s0">, </span><span class="s3">'binnumber'</span><span class="s1">)</span>
        <span class="s1">check_named_results(res</span><span class="s0">, </span><span class="s1">attributes)</span>

    <span class="s0">def </span><span class="s1">test_dd_sum(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">sum1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'sum'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">sum2</span><span class="s0">, </span><span class="s1">edges2 = np.histogramdd(X</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s0">, </span><span class="s1">weights=v)</span>
        <span class="s1">sum3</span><span class="s0">, </span><span class="s1">edges3</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.sum</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(sum1</span><span class="s0">, </span><span class="s1">sum2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>
        <span class="s1">assert_allclose(sum1</span><span class="s0">, </span><span class="s1">sum3)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges3)</span>

    <span class="s0">def </span><span class="s1">test_dd_mean(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.mean</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_std(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'std'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_min(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'min'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.min</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_max(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'max'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.max</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_median(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'median'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">np.median</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>

        <span class="s1">assert_allclose(stat1</span><span class="s0">, </span><span class="s1">stat2)</span>
        <span class="s1">assert_allclose(edges1</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s0">def </span><span class="s1">test_dd_bincode(self):</span>
        <span class="s1">X = self.X[:</span><span class="s2">20</span><span class="s1">]</span>
        <span class="s1">v = self.v[:</span><span class="s2">20</span><span class="s1">]</span>

        <span class="s1">count1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">bc2 = np.array([</span><span class="s2">63</span><span class="s0">, </span><span class="s2">33</span><span class="s0">, </span><span class="s2">86</span><span class="s0">, </span><span class="s2">83</span><span class="s0">, </span><span class="s2">88</span><span class="s0">, </span><span class="s2">67</span><span class="s0">, </span><span class="s2">57</span><span class="s0">, </span><span class="s2">33</span><span class="s0">, </span><span class="s2">42</span><span class="s0">, </span><span class="s2">41</span><span class="s0">, </span><span class="s2">82</span><span class="s0">, </span><span class="s2">83</span><span class="s0">, </span><span class="s2">92</span><span class="s0">,</span>
                        <span class="s2">32</span><span class="s0">, </span><span class="s2">36</span><span class="s0">, </span><span class="s2">91</span><span class="s0">, </span><span class="s2">43</span><span class="s0">, </span><span class="s2">87</span><span class="s0">, </span><span class="s2">81</span><span class="s0">, </span><span class="s2">81</span><span class="s1">])</span>

        <span class="s1">bcount = [(bc == i).sum() </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">np.unique(bc)]</span>

        <span class="s1">assert_allclose(bc</span><span class="s0">, </span><span class="s1">bc2)</span>
        <span class="s1">count1adj = count1[count1.nonzero()]</span>
        <span class="s1">assert_allclose(bcount</span><span class="s0">, </span><span class="s1">count1adj)</span>

    <span class="s0">def </span><span class="s1">test_dd_multi_values(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>
        <span class="s1">w = self.w</span>

        <span class="s0">for </span><span class="s1">stat </span><span class="s0">in </span><span class="s1">[</span><span class="s3">&quot;count&quot;</span><span class="s0">, </span><span class="s3">&quot;sum&quot;</span><span class="s0">, </span><span class="s3">&quot;mean&quot;</span><span class="s0">, </span><span class="s3">&quot;std&quot;</span><span class="s0">, </span><span class="s3">&quot;min&quot;</span><span class="s0">, </span><span class="s3">&quot;max&quot;</span><span class="s0">, </span><span class="s3">&quot;median&quot;</span><span class="s0">,</span>
                     <span class="s1">np.std]:</span>
            <span class="s1">stat1v</span><span class="s0">, </span><span class="s1">edges1v</span><span class="s0">, </span><span class="s1">bc1v = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">stat</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>
            <span class="s1">stat1w</span><span class="s0">, </span><span class="s1">edges1w</span><span class="s0">, </span><span class="s1">bc1w = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">stat</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>
            <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc2 = binned_statistic_dd(X</span><span class="s0">, </span><span class="s1">[v</span><span class="s0">, </span><span class="s1">w]</span><span class="s0">, </span><span class="s1">stat</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">8</span><span class="s1">)</span>
            <span class="s1">assert_allclose(stat2[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1v)</span>
            <span class="s1">assert_allclose(stat2[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">stat1w)</span>
            <span class="s1">assert_allclose(edges1v</span><span class="s0">, </span><span class="s1">edges2)</span>
            <span class="s1">assert_allclose(edges1w</span><span class="s0">, </span><span class="s1">edges2)</span>
            <span class="s1">assert_allclose(bc1v</span><span class="s0">, </span><span class="s1">bc2)</span>

    <span class="s0">def </span><span class="s1">test_dd_binnumbers_unraveled(self):</span>
        <span class="s1">X = self.X</span>
        <span class="s1">v = self.v</span>

        <span class="s1">stat</span><span class="s0">, </span><span class="s1">edgesx</span><span class="s0">, </span><span class="s1">bcx = binned_statistic(X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">15</span><span class="s1">)</span>
        <span class="s1">stat</span><span class="s0">, </span><span class="s1">edgesy</span><span class="s0">, </span><span class="s1">bcy = binned_statistic(X[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">20</span><span class="s1">)</span>
        <span class="s1">stat</span><span class="s0">, </span><span class="s1">edgesz</span><span class="s0">, </span><span class="s1">bcz = binned_statistic(X[:</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">stat2</span><span class="s0">, </span><span class="s1">edges2</span><span class="s0">, </span><span class="s1">bc2 = binned_statistic_dd(</span>
            <span class="s1">X</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=(</span><span class="s2">15</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expand_binnumbers=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s1">assert_allclose(bcx</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(bcy</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">assert_allclose(bcz</span><span class="s0">, </span><span class="s1">bc2[</span><span class="s2">2</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_dd_binned_statistic_result(self):</span>
        <span class="s4"># NOTE: tests the reuse of bin_edges from previous call</span>
        <span class="s1">x = np.random.random((</span><span class="s2">10000</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
        <span class="s1">v = np.random.random(</span><span class="s2">10000</span><span class="s1">)</span>
        <span class="s1">bins = np.linspace(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">bins = (bins</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">bins)</span>

        <span class="s1">result = binned_statistic_dd(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=bins)</span>
        <span class="s1">stat = result.statistic</span>

        <span class="s1">result = binned_statistic_dd(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">,</span>
                                     <span class="s1">binned_statistic_result=result)</span>
        <span class="s1">stat2 = result.statistic</span>

        <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s1">stat2)</span>

    <span class="s0">def </span><span class="s1">test_dd_zero_dedges(self):</span>
        <span class="s1">x = np.random.random((</span><span class="s2">10000</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
        <span class="s1">v = np.random.random(</span><span class="s2">10000</span><span class="s1">)</span>
        <span class="s1">bins = np.linspace(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">bins = np.append(bins</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">bins = (bins</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">bins)</span>
        <span class="s0">with </span><span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">'difference is numerically 0'</span><span class="s1">):</span>
            <span class="s1">binned_statistic_dd(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s3">'mean'</span><span class="s0">, </span><span class="s1">bins=bins)</span>

    <span class="s0">def </span><span class="s1">test_dd_range_errors(self):</span>
        <span class="s4"># Test that descriptive exceptions are raised as appropriate for bad</span>
        <span class="s4"># values of the `range` argument. (See gh-12996)</span>
        <span class="s0">with </span><span class="s1">assert_raises(ValueError</span><span class="s0">,</span>
                           <span class="s1">match=</span><span class="s3">'In range, start must be &lt;= stop'</span><span class="s1">):</span>
            <span class="s1">binned_statistic_dd([self.y]</span><span class="s0">, </span><span class="s1">self.v</span><span class="s0">,</span>
                                <span class="s1">range=[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">assert_raises(</span>
                <span class="s1">ValueError</span><span class="s0">,</span>
                <span class="s1">match=</span><span class="s3">'In dimension 1 of range, start must be &lt;= stop'</span><span class="s1">):</span>
            <span class="s1">binned_statistic_dd([self.x</span><span class="s0">, </span><span class="s1">self.y]</span><span class="s0">, </span><span class="s1">self.v</span><span class="s0">,</span>
                                <span class="s1">range=[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">assert_raises(</span>
                <span class="s1">ValueError</span><span class="s0">,</span>
                <span class="s1">match=</span><span class="s3">'In dimension 2 of range, start must be &lt;= stop'</span><span class="s1">):</span>
            <span class="s1">binned_statistic_dd([self.x</span><span class="s0">, </span><span class="s1">self.y]</span><span class="s0">, </span><span class="s1">self.v</span><span class="s0">,</span>
                                <span class="s1">range=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">assert_raises(</span>
                <span class="s1">ValueError</span><span class="s0">,</span>
                <span class="s1">match=</span><span class="s3">'range given for 1 dimensions; 2 required'</span><span class="s1">):</span>
            <span class="s1">binned_statistic_dd([self.x</span><span class="s0">, </span><span class="s1">self.y]</span><span class="s0">, </span><span class="s1">self.v</span><span class="s0">,</span>
                                <span class="s1">range=[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">test_binned_statistic_float32(self):</span>
        <span class="s1">X = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0.42358226</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
        <span class="s1">stat</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = binned_statistic(X</span><span class="s0">, None, </span><span class="s3">'count'</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float64))</span>

    <span class="s0">def </span><span class="s1">test_gh14332(self):</span>
        <span class="s4"># Test the wrong output when the `sample` is close to bin edge</span>
        <span class="s1">x = []</span>
        <span class="s1">size = </span><span class="s2">20</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(size):</span>
            <span class="s1">x += [</span><span class="s2">1</span><span class="s1">-</span><span class="s2">0.1</span><span class="s1">**i]</span>

        <span class="s1">bins = np.linspace(</span><span class="s2">0</span><span class="s0">,</span><span class="s2">1</span><span class="s0">,</span><span class="s2">11</span><span class="s1">)</span>
        <span class="s1">sum1</span><span class="s0">, </span><span class="s1">edges1</span><span class="s0">, </span><span class="s1">bc = binned_statistic_dd(x</span><span class="s0">, </span><span class="s1">np.ones(len(x))</span><span class="s0">,</span>
                                               <span class="s1">bins=[bins]</span><span class="s0">, </span><span class="s1">statistic=</span><span class="s3">'sum'</span><span class="s1">)</span>
        <span class="s1">sum2</span><span class="s0">, </span><span class="s1">edges2 = np.histogram(x</span><span class="s0">, </span><span class="s1">bins=bins)</span>

        <span class="s1">assert_allclose(sum1</span><span class="s0">, </span><span class="s1">sum2)</span>
        <span class="s1">assert_allclose(edges1[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">edges2)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float64</span><span class="s0">, </span><span class="s1">np.complex128])</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;statistic&quot;</span><span class="s0">, </span><span class="s1">[np.mean</span><span class="s0">, </span><span class="s1">np.median</span><span class="s0">, </span><span class="s1">np.sum</span><span class="s0">, </span><span class="s1">np.std</span><span class="s0">,</span>
                                           <span class="s1">np.min</span><span class="s0">, </span><span class="s1">np.max</span><span class="s0">, </span><span class="s3">'count'</span><span class="s0">,</span>
                                           <span class="s0">lambda </span><span class="s1">x: (x**</span><span class="s2">2</span><span class="s1">).sum()</span><span class="s0">,</span>
                                           <span class="s0">lambda </span><span class="s1">x: (x**</span><span class="s2">2</span><span class="s1">).sum() * </span><span class="s2">1j</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_dd_all(self</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">statistic):</span>
        <span class="s0">def </span><span class="s1">ref_statistic(x):</span>
            <span class="s0">return </span><span class="s1">len(x) </span><span class="s0">if </span><span class="s1">statistic == </span><span class="s3">'count' </span><span class="s0">else </span><span class="s1">statistic(x)</span>

        <span class="s1">rng = np.random.default_rng(</span><span class="s2">3704743126639371</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s2">10</span>
        <span class="s1">x = rng.random(size=n)</span>
        <span class="s1">i = x &gt;= </span><span class="s2">0.5</span>
        <span class="s1">v = rng.random(size=n)</span>
        <span class="s0">if </span><span class="s1">dtype </span><span class="s0">is </span><span class="s1">np.complex128:</span>
            <span class="s1">v = v + rng.random(size=n)*</span><span class="s2">1j</span>

        <span class="s1">stat</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = binned_statistic_dd(x</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">statistic</span><span class="s0">, </span><span class="s1">bins=</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">ref = np.array([ref_statistic(v[~i])</span><span class="s0">, </span><span class="s1">ref_statistic(v[i])])</span>
        <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s1">ref)</span>
        <span class="s0">assert </span><span class="s1">stat.dtype == np.result_type(ref.dtype</span><span class="s0">, </span><span class="s1">np.float64)</span>
</pre>
</body>
</html>