<html>
<head>
<title>test_optimization.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_optimization.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">pickle</span>
<span class="s0">from </span><span class="s1">functools </span><span class="s0">import </span><span class="s1">partial</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">from </span><span class="s1">dask.base </span><span class="s0">import </span><span class="s1">tokenize</span>
<span class="s0">from </span><span class="s1">dask.core </span><span class="s0">import </span><span class="s1">get_dependencies</span>
<span class="s0">from </span><span class="s1">dask.local </span><span class="s0">import </span><span class="s1">get_sync</span>
<span class="s0">from </span><span class="s1">dask.optimization </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">SubgraphCallable</span><span class="s0">,</span>
    <span class="s1">cull</span><span class="s0">,</span>
    <span class="s1">functions_of</span><span class="s0">,</span>
    <span class="s1">fuse</span><span class="s0">,</span>
    <span class="s1">fuse_linear</span><span class="s0">,</span>
    <span class="s1">inline</span><span class="s0">,</span>
    <span class="s1">inline_functions</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">apply</span><span class="s0">, </span><span class="s1">partial_by_order</span>
<span class="s0">from </span><span class="s1">dask.utils_test </span><span class="s0">import </span><span class="s1">add</span><span class="s0">, </span><span class="s1">inc</span>


<span class="s0">def </span><span class="s1">_subgraph_callables_eq(self</span><span class="s0">, </span><span class="s1">other):</span>
    <span class="s0">return </span><span class="s1">(</span>
        <span class="s1">type(self) </span><span class="s0">is </span><span class="s1">type(other)</span>
        <span class="s0">and </span><span class="s1">self.outkey == other.outkey</span>
        <span class="s0">and </span><span class="s1">set(self.inkeys) == set(other.inkeys)</span>
        <span class="s0">and </span><span class="s1">tokenize(self.dsk) == tokenize(other.dsk)</span>
    <span class="s1">)</span>


<span class="s1">@pytest.fixture</span>
<span class="s0">def </span><span class="s1">compare_subgraph_callables(monkeypatch):</span>
    <span class="s2">&quot;&quot;&quot;Ignore name when comparing instances of :class:`SubgraphCallable`. 
 
    They have UUID-generated names which prevents instances generated by the 
    test from comparing equal to reference values. Instead, compare the 
    embedded graph using ``tokenize``. 
    &quot;&quot;&quot;</span>
    <span class="s1">monkeypatch.setattr(SubgraphCallable</span><span class="s0">, </span><span class="s3">&quot;__eq__&quot;</span><span class="s0">, </span><span class="s1">_subgraph_callables_eq)</span>


<span class="s0">def </span><span class="s1">double(x):</span>
    <span class="s0">return </span><span class="s1">x * </span><span class="s4">2</span>


<span class="s0">def </span><span class="s1">test_cull():</span>
    <span class="s5"># 'out' depends on 'x' and 'y', but not 'z'</span>
    <span class="s1">d = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;out&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)}</span>
    <span class="s1">culled</span><span class="s0">, </span><span class="s1">dependencies = cull(d</span><span class="s0">, </span><span class="s3">&quot;out&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">culled == {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;out&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">dependencies == {</span><span class="s3">&quot;x&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">&quot;x&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;out&quot;</span><span class="s1">: [</span><span class="s3">&quot;y&quot;</span><span class="s1">]}</span>

    <span class="s0">assert </span><span class="s1">cull(d</span><span class="s0">, </span><span class="s3">&quot;out&quot;</span><span class="s1">) == cull(d</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;out&quot;</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">cull(d</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;out&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])[</span><span class="s4">0</span><span class="s1">] == d</span>
    <span class="s0">assert </span><span class="s1">cull(d</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">&quot;out&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;z&quot;</span><span class="s1">]]) == cull(d</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;out&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">])</span>
    <span class="s1">pytest.raises(KeyError</span><span class="s0">, lambda</span><span class="s1">: cull(d</span><span class="s0">, </span><span class="s3">&quot;badkey&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">fuse2(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s2">&quot;&quot;&quot;Run both ``fuse`` and ``fuse_linear`` and compare results&quot;&quot;&quot;</span>
    <span class="s1">rv1 = fuse_linear(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s0">if </span><span class="s1">kwargs.get(</span><span class="s3">&quot;rename_keys&quot;</span><span class="s1">) </span><span class="s0">is not False</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">rv1</span>
    <span class="s1">rv2 = fuse(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s0">assert </span><span class="s1">rv1 == rv2</span>
    <span class="s0">return </span><span class="s1">rv1</span>


<span class="s0">def </span><span class="s1">with_deps(dsk):</span>
    <span class="s0">return </span><span class="s1">dsk</span><span class="s0">, </span><span class="s1">{k: get_dependencies(dsk</span><span class="s0">, </span><span class="s1">k) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">dsk}</span>


<span class="s0">def </span><span class="s1">test_fuse():</span>
    <span class="s1">fuse = fuse2  </span><span class="s5"># tests both `fuse` and `fuse_linear`</span>
    <span class="s1">d = {</span>
        <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))))</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;z-y-x-w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))))</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;z-y-x-w&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;NEW&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;NEW&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;NEW&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z-y&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;x-w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;z-y&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;z-y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;w&quot;</span><span class="s1">: </span><span class="s3">&quot;x-w&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: </span><span class="s3">&quot;z-y&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;v&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;u&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;w&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;u&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;v&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x-w-u&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;z-y&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;v&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z-y&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;z-y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;c-a&quot;</span><span class="s0">, </span><span class="s3">&quot;d-b&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c-a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d-b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s3">&quot;c-a&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;d-b&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;u&quot;</span><span class="s1">: </span><span class="s3">&quot;x-w-u&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: </span><span class="s3">&quot;z-y&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y-x&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y-x&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c-d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;y-x&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;y-x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;c-d&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s3">&quot;y-x&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a-b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a-b&quot;</span><span class="s0">, </span><span class="s3">&quot;a-b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a-b&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_fuse_keys():</span>
    <span class="s1">fuse = fuse2  </span><span class="s5"># tests both `fuse` and `fuse_linear`</span>
    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)}</span>
    <span class="s1">keys = [</span><span class="s3">&quot;b&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">keys</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">keys</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a-b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a-b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a-b&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">keys = [</span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">keys</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">keys</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;w&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y-x&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;y-x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s3">&quot;y-x&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_inline():</span>
    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline(d) == {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline(d</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]) == {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">d = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline(d) == {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline(d</span><span class="s0">, </span><span class="s1">keys=</span><span class="s3">&quot;y&quot;</span><span class="s1">) == {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))}</span>
    <span class="s0">assert </span><span class="s1">inline(d</span><span class="s0">, </span><span class="s1">keys=</span><span class="s3">&quot;y&quot;</span><span class="s0">, </span><span class="s1">inline_constants=</span><span class="s0">False</span><span class="s1">) == {</span>
        <span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(len</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline(d</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">) == {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(len</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">inline(d</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">inline_constants=</span><span class="s0">False</span><span class="s1">) == {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(len</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_inline_functions():</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">d = </span><span class="s3">&quot;xyid&quot;</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;out&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">i: (inc</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">d: (double</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">x: </span><span class="s4">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s4">1</span><span class="s1">}</span>

    <span class="s1">result = inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">fast_functions={inc})</span>
    <span class="s1">expected = {</span><span class="s3">&quot;out&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">d: (double</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">x: </span><span class="s4">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_inline_ignores_curries_and_partials():</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">: (partial(add</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)}</span>

    <span class="s1">result = inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">fast_functions={add})</span>
    <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;b&quot;</span><span class="s1">] == (inc</span><span class="s0">, </span><span class="s1">dsk[</span><span class="s3">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s3">&quot;a&quot; </span><span class="s0">not in </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_inline_functions_non_hashable():</span>
    <span class="s0">class </span><span class="s1">NonHashableCallable:</span>
        <span class="s0">def </span><span class="s1">__call__(self</span><span class="s0">, </span><span class="s1">a):</span>
            <span class="s0">return </span><span class="s1">a + </span><span class="s4">1</span>

        <span class="s0">def </span><span class="s1">__hash__(self):</span>
            <span class="s0">raise </span><span class="s1">TypeError(</span><span class="s3">&quot;Not hashable&quot;</span><span class="s1">)</span>

    <span class="s1">nohash = NonHashableCallable()</span>

    <span class="s1">dsk = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (nohash</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)}</span>

    <span class="s1">result = inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">fast_functions={inc})</span>
    <span class="s0">assert </span><span class="s1">result[</span><span class="s3">&quot;c&quot;</span><span class="s1">] == (nohash</span><span class="s0">, </span><span class="s1">dsk[</span><span class="s3">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s3">&quot;b&quot; </span><span class="s0">not in </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_inline_doesnt_shrink_fast_functions_at_top():</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s1">result = inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">fast_functions={inc})</span>
    <span class="s0">assert </span><span class="s1">result == dsk</span>


<span class="s0">def </span><span class="s1">test_inline_traverses_lists():</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s1">d = </span><span class="s3">&quot;xyid&quot;</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;out&quot;</span><span class="s1">: (sum</span><span class="s0">, </span><span class="s1">[i</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">i: (inc</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">d: (double</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">x: </span><span class="s4">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s1">expected = {</span><span class="s3">&quot;out&quot;</span><span class="s1">: (sum</span><span class="s0">, </span><span class="s1">[(inc</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">d: (double</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">x: </span><span class="s4">1</span><span class="s0">, </span><span class="s1">y: </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s1">result = inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">fast_functions={inc})</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_inline_functions_protects_output_keys():</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (double</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">inline_functions(dsk</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[inc]) == {</span><span class="s3">&quot;y&quot;</span><span class="s1">: (double</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))}</span>
    <span class="s0">assert </span><span class="s1">inline_functions(dsk</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;x&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[inc]) == {</span><span class="s3">&quot;y&quot;</span><span class="s1">: (double</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)}</span>


<span class="s0">def </span><span class="s1">test_functions_of():</span>
    <span class="s1">a = </span><span class="s0">lambda </span><span class="s1">x: x</span>
    <span class="s1">b = </span><span class="s0">lambda </span><span class="s1">x: x</span>
    <span class="s0">assert </span><span class="s1">functions_of((a</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)) == {a}</span>
    <span class="s0">assert </span><span class="s1">functions_of((a</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))) == {a</span><span class="s0">, </span><span class="s1">b}</span>
    <span class="s0">assert </span><span class="s1">functions_of((a</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)])) == {a</span><span class="s0">, </span><span class="s1">b}</span>
    <span class="s0">assert </span><span class="s1">functions_of((a</span><span class="s0">, </span><span class="s1">[[[(b</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)]]])) == {a</span><span class="s0">, </span><span class="s1">b}</span>
    <span class="s0">assert </span><span class="s1">functions_of(</span><span class="s4">1</span><span class="s1">) == set()</span>
    <span class="s0">assert </span><span class="s1">functions_of(a) == set()</span>
    <span class="s0">assert </span><span class="s1">functions_of((a</span><span class="s0">,</span><span class="s1">)) == {a}</span>


<span class="s0">def </span><span class="s1">test_inline_cull_dependencies():</span>
    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(len</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)}</span>

    <span class="s1">d2</span><span class="s0">, </span><span class="s1">dependencies = cull(d</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s1">inline(d2</span><span class="s0">, </span><span class="s1">{</span><span class="s3">&quot;b&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dependencies=dependencies)</span>


<span class="s0">def </span><span class="s1">test_fuse_reductions_single_input():</span>
    <span class="s0">def </span><span class="s1">f(*args):</span>
        <span class="s0">return </span><span class="s1">args</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b1-b2-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-c&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b1-b2-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d1-d2-e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: </span><span class="s3">&quot;d1-d2-e&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s0">, </span><span class="s3">&quot;b4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b3-b4-c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: </span><span class="s3">&quot;b3-b4-c2&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-b4-c1-c2-d&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-b4-c1-c2-d&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b5&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b6&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b7&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b8&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s0">, </span><span class="s3">&quot;b4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b5&quot;</span><span class="s0">, </span><span class="s3">&quot;b6&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b7&quot;</span><span class="s0">, </span><span class="s3">&quot;b8&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b3-b4-c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b5-b6-c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b7-b8-c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: </span><span class="s3">&quot;b3-b4-c2&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c3&quot;</span><span class="s1">: </span><span class="s3">&quot;b5-b6-c3&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c4&quot;</span><span class="s1">: </span><span class="s3">&quot;b7-b8-c4&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.6</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-b4-c1-c2-d1&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b5-b6-b7-b8-c3-c4-d2&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-b4-c1-c2-d1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: </span><span class="s3">&quot;b5-b6-b7-b8-c3-c4-d2&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.6</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.7</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.7</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-b4-b5-b6-b7-b8-c1-c2-c3-c4-d1-d2-e&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-b4-b5-b6-b7-b8-c1-c2-c3-c4-d1-d2-e&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b5&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b6&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b7&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b8&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b9&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b10&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b11&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b12&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b13&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b14&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b15&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b16&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s0">, </span><span class="s3">&quot;b4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b5&quot;</span><span class="s0">, </span><span class="s3">&quot;b6&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b7&quot;</span><span class="s0">, </span><span class="s3">&quot;b8&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c5&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b9&quot;</span><span class="s0">, </span><span class="s3">&quot;b10&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c6&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b11&quot;</span><span class="s0">, </span><span class="s3">&quot;b12&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c7&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b13&quot;</span><span class="s0">, </span><span class="s3">&quot;b14&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c8&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b15&quot;</span><span class="s0">, </span><span class="s3">&quot;b16&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c5&quot;</span><span class="s0">, </span><span class="s3">&quot;c6&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c7&quot;</span><span class="s0">, </span><span class="s3">&quot;c8&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c5&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c6&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c7&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c8&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c5&quot;</span><span class="s0">, </span><span class="s3">&quot;c6&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c7&quot;</span><span class="s0">, </span><span class="s3">&quot;c8&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b3-b4-c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b5-b6-c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b7-b8-c4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b10-b9-c5&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b11-b12-c6&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b13-b14-c7&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;b15-b16-c8&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s0">, </span><span class="s3">&quot;c4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c5&quot;</span><span class="s0">, </span><span class="s3">&quot;c6&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c7&quot;</span><span class="s0">, </span><span class="s3">&quot;c8&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: </span><span class="s3">&quot;b3-b4-c2&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c3&quot;</span><span class="s1">: </span><span class="s3">&quot;b5-b6-c3&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c4&quot;</span><span class="s1">: </span><span class="s3">&quot;b7-b8-c4&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c5&quot;</span><span class="s1">: </span><span class="s3">&quot;b10-b9-c5&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c6&quot;</span><span class="s1">: </span><span class="s3">&quot;b11-b12-c6&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c7&quot;</span><span class="s1">: </span><span class="s3">&quot;b13-b14-c7&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c8&quot;</span><span class="s1">: </span><span class="s3">&quot;b15-b16-c8&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d4&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.6</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-b4-c1-c2-d1&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b5-b6-b7-b8-c3-c4-d2&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b10-b11-b12-b9-c5-c6-d3&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b13-b14-b15-b16-c7-c8-d4&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s0">, </span><span class="s3">&quot;d4&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-b4-c1-c2-d1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: </span><span class="s3">&quot;b5-b6-b7-b8-c3-c4-d2&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: </span><span class="s3">&quot;b10-b11-b12-b9-c5-c6-d3&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d4&quot;</span><span class="s1">: </span><span class="s3">&quot;b13-b14-b15-b16-c7-c8-d4&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.6</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.7</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">7.4</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-b4-b5-b6-b7-b8-c1-c2-c3-c4-d1-d2-e1&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b10-b11-b12-b13-b14-b15-b16-b9-c5-c6-c7-c8-d3-d4-e2&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;e2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-b4-b5-b6-b7-b8-c1-c2-c3-c4-d1-d2-e1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;e2&quot;</span><span class="s1">: </span><span class="s3">&quot;b10-b11-b12-b13-b14-b15-b16-b9-c5-c6-c7-c8-d3-d4-e2&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">4.7</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">7.4</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">7.5</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">7.5</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b10-b11-b12-b13-b14-b15-b16-b2-b3-b4-b5-b6-b7-b8-b9-c1-c2-c3-c4-c5-c6-c7-c8-d1-d2-d3-d4-e1-e2-f&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                    <span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b10-b11-b12-b13-b14-b15-b16-b2-b3-b4-b5-b6-b7-b8-b9-c1-c2-c3-c4-c5-c6-c7-c8-d1-d2-d3-d4-e1-e2-f&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps({</span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)})</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a-b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a-b&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps({</span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)))})</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a-b-c-d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)))</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;a-b-c-d&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b-c-d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;b-c-d&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b1-c1-d1-e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-c1-d1-e1&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c1-d1-e1-f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c1-d1-e1-f&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s1">expected = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b1-c1-d1-e1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;e1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;e1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-c1-d1-e1&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-c1-d1-e1-f&quot;</span><span class="s1">: (</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">))))</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;f&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-c1-d1-e1-f&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b1-c1-d1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;b2-c2-d2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;b3-c3-d3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;e-f-g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;d1&quot;</span><span class="s0">, </span><span class="s3">&quot;d2&quot;</span><span class="s0">, </span><span class="s3">&quot;d3&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-c1-d1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d2&quot;</span><span class="s1">: </span><span class="s3">&quot;b2-c2-d2&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d3&quot;</span><span class="s1">: </span><span class="s3">&quot;b3-c3-d3&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;g&quot;</span><span class="s1">: </span><span class="s3">&quot;e-f-g&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a-b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c-d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;e-f-g&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s3">&quot;a-b&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;c-d&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;g&quot;</span><span class="s1">: </span><span class="s3">&quot;e-f-g&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_fuse_stressed():</span>
    <span class="s0">def </span><span class="s1">f(*args):</span>
        <span class="s0">return </span><span class="s1">args</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;array-original-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s3">&quot;array-original-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">,</span>
            <span class="s4">0</span><span class="s0">,</span>
            <span class="s4">1</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">f</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">&quot;cholesky-lt-dot-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-lt-dot-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s3">&quot;array-original-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s3">&quot;array-original-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">&quot;array-27b9f9d257a80fa6adae06a98faf71eb&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">keys = {</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">&quot;cholesky-upper-26a6b670a8aabb7e2f8936db7ccb6a88&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">rv = fuse(d</span><span class="s0">, </span><span class="s1">keys=keys</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">rv == with_deps(rv[</span><span class="s4">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_fuse_reductions_multiple_input():</span>
    <span class="s0">def </span><span class="s1">f(*args):</span>
        <span class="s0">return </span><span class="s1">args</span>

    <span class="s1">d = {</span><span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">)}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps({</span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))})</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a1-a2-b-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;a1-a2-b-c&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;b-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b-c&quot;</span><span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">expected = with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2.9</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == expected</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span><span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b2-b3-c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b2-b3-c&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b1-c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b3-c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s3">&quot;c1&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-c1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;c2&quot;</span><span class="s1">: </span><span class="s3">&quot;b3-c2&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>

    <span class="s1">d = {</span>
        <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
        <span class="s3">&quot;b1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;b3&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c1&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">&quot;b3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">&quot;c2&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(d)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(d)</span>

    <span class="s5"># A more aggressive heuristic could do this at `ave_width=2`.  Perhaps</span>
    <span class="s5"># we can improve this.  Nevertheless, this is behaving as intended.</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s1">ave_width=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">) == with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;a1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;a2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
            <span class="s3">&quot;b2&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;b1-b3-c1-c2-d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;b2&quot;</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s3">&quot;a2&quot;</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s3">&quot;d&quot;</span><span class="s1">: </span><span class="s3">&quot;b1-b3-c1-c2-d&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">func_with_kwargs(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c=</span><span class="s4">2</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">a + b + c</span>


<span class="s0">def </span><span class="s1">test_SubgraphCallable():</span>
    <span class="s1">non_hashable = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>

    <span class="s1">dsk = {</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: (apply</span><span class="s0">, </span><span class="s1">add</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;in1&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: (</span>
            <span class="s1">apply</span><span class="s0">,</span>
            <span class="s1">partial_by_order</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;in2&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;function&quot;</span><span class="s1">: func_with_kwargs</span><span class="s0">, </span><span class="s3">&quot;other&quot;</span><span class="s1">: [(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;c&quot;</span><span class="s1">: (</span>
            <span class="s1">apply</span><span class="s0">,</span>
            <span class="s1">partial_by_order</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">&quot;in2&quot;</span><span class="s0">, </span><span class="s3">&quot;in1&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s3">&quot;function&quot;</span><span class="s1">: func_with_kwargs</span><span class="s0">, </span><span class="s3">&quot;other&quot;</span><span class="s1">: [(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)]}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;e&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;f&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">(sum</span><span class="s0">, </span><span class="s1">non_hashable))]</span><span class="s0">,</span>
        <span class="s3">&quot;h&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s1">(sum</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(sum</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">]))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">f = SubgraphCallable(dsk</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;in1&quot;</span><span class="s0">, </span><span class="s3">&quot;in2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">f.name == </span><span class="s3">&quot;test&quot;</span>
    <span class="s0">assert </span><span class="s1">repr(f) == </span><span class="s3">&quot;test&quot;</span>

    <span class="s1">f2 = SubgraphCallable(dsk</span><span class="s0">, </span><span class="s3">&quot;h&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;in1&quot;</span><span class="s0">, </span><span class="s3">&quot;in2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">f == f2</span>

    <span class="s1">f3 = SubgraphCallable(dsk</span><span class="s0">, </span><span class="s3">&quot;g&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;in1&quot;</span><span class="s0">, </span><span class="s3">&quot;in2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">f != f3</span>

    <span class="s0">assert </span><span class="s1">hash(SubgraphCallable(</span><span class="s0">None, None, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]))</span>
    <span class="s0">assert </span><span class="s1">hash(f3) != hash(f2)</span>
    <span class="s1">dsk2 = dsk.copy()</span>
    <span class="s1">dsk2.update({</span><span class="s3">&quot;in1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;in2&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">f(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) == get_sync(cull(dsk2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;h&quot;</span><span class="s1">])[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;h&quot;</span><span class="s1">])[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">f(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) == f(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">f2 = pickle.loads(pickle.dumps(f))</span>
    <span class="s0">assert </span><span class="s1">f2 == f</span>
    <span class="s0">assert </span><span class="s1">hash(f2) == hash(f)</span>
    <span class="s0">assert </span><span class="s1">f2(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) == f(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_SubgraphCallable_with_numpy():</span>
    <span class="s1">np = pytest.importorskip(</span><span class="s3">&quot;numpy&quot;</span><span class="s1">)</span>

    <span class="s5"># Testing support of numpy arrays in `dsk`, which uses elementwise equalities.</span>
    <span class="s1">dsk1 = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.arange(</span><span class="s4">10</span><span class="s1">)}</span>
    <span class="s1">f1 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s1">f2 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">f1 == f2</span>

    <span class="s5"># Notice, even though `dsk1` and `dsk2` are not equal they compare equal because</span>
    <span class="s5"># SubgraphCallable.__eq__() only checks name, outkeys, and inkeys.</span>
    <span class="s1">dsk2 = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: np.arange(</span><span class="s4">10</span><span class="s1">) + </span><span class="s4">1</span><span class="s1">}</span>
    <span class="s1">f3 = SubgraphCallable(dsk2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">f1 == f3</span>

    <span class="s1">f4 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;test2&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">f1 != f4</span>


<span class="s0">def </span><span class="s1">test_SubgraphCallable_eq():</span>
    <span class="s1">dsk1 = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">)}</span>
    <span class="s1">dsk2 = {</span><span class="s3">&quot;a&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">)}</span>
    <span class="s1">f1 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s1">f2 = SubgraphCallable(dsk2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">])</span>
    <span class="s5"># Different graphs must compare unequal (when no name given)</span>
    <span class="s0">assert </span><span class="s1">f1 != f2</span>

    <span class="s5"># Different inputs must compare unequal</span>
    <span class="s1">f3 = SubgraphCallable(dsk2</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=f1.name)</span>
    <span class="s0">assert </span><span class="s1">f3 != f1</span>

    <span class="s5"># Different outputs must compare unequal</span>
    <span class="s1">f4 = SubgraphCallable(dsk2</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=f1.name)</span>
    <span class="s0">assert </span><span class="s1">f4 != f1</span>

    <span class="s5"># Reordering the inputs must not prevent equality</span>
    <span class="s1">f5 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;e&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=f1.name)</span>
    <span class="s0">assert </span><span class="s1">f1 == f5</span>
    <span class="s0">assert </span><span class="s1">hash(f1) == hash(f5)</span>

    <span class="s5"># Explicitly named graphs with different names must be unequal</span>
    <span class="s1">unnamed1 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;first&quot;</span><span class="s1">)</span>
    <span class="s1">unnamed2 = SubgraphCallable(dsk1</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;d&quot;</span><span class="s0">, </span><span class="s3">&quot;e&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;second&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unnamed1 != unnamed2</span>


<span class="s0">def </span><span class="s1">test_fuse_subgraphs(compare_subgraph_callables):</span>
    <span class="s1">dsk = {</span>
        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;inc-1&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;inc-2&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;inc-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;inc-3&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;inc-4&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;inc-3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-2&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-4&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;inc-5&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;inc-5&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;inc-6&quot;</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">sol = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;inc-6&quot;</span><span class="s1">: </span><span class="s3">&quot;add-inc-x-1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;add-inc-x-1&quot;</span><span class="s1">: (</span>
                <span class="s1">SubgraphCallable(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                        <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)))))</span><span class="s0">,</span>
                    <span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-6&quot;</span><span class="s0">,</span>
                    <span class="s1">()</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res == sol</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;inc-6&quot;</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True, </span><span class="s1">rename_keys=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">sol = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (</span>
                <span class="s1">SubgraphCallable(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                        <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)))))</span><span class="s0">,</span>
                    <span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-6&quot;</span><span class="s0">,</span>
                    <span class="s1">()</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res == sol</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">sol = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;add-inc-x-1&quot;</span><span class="s1">: (</span>
                <span class="s1">SubgraphCallable(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                        <span class="s3">&quot;add-2&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                    <span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;add-2&quot;</span><span class="s0">,</span>
                    <span class="s1">()</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;add-2&quot;</span><span class="s1">: </span><span class="s3">&quot;add-inc-x-1&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res == sol</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s5"># ordering of arguments is unstable, check all permutations</span>
    <span class="s1">sols = []</span>
    <span class="s0">for </span><span class="s1">inkeys </span><span class="s0">in </span><span class="s1">itertools.permutations((</span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s1">)):</span>
        <span class="s1">sols.append(</span>
            <span class="s1">with_deps(</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-2&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-6&quot;</span><span class="s1">: </span><span class="s3">&quot;inc-add-1&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-add-1&quot;</span><span class="s1">: (</span>
                        <span class="s1">SubgraphCallable(</span>
                            <span class="s1">{</span>
                                <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (</span>
                                    <span class="s1">inc</span><span class="s0">,</span>
                                    <span class="s1">(inc</span><span class="s0">, </span><span class="s1">(add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">))))</span><span class="s0">,</span>
                                <span class="s1">)</span><span class="s0">,</span>
                            <span class="s1">}</span><span class="s0">,</span>
                            <span class="s3">&quot;inc-6&quot;</span><span class="s0">,</span>
                            <span class="s1">inkeys</span><span class="s0">,</span>
                        <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span>
                    <span class="s1">+ inkeys</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res </span><span class="s0">in </span><span class="s1">sols</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;inc-2&quot;</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s5"># ordering of arguments is unstable, check all permutations</span>
    <span class="s1">sols = []</span>
    <span class="s0">for </span><span class="s1">inkeys </span><span class="s0">in </span><span class="s1">itertools.permutations((</span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s1">)):</span>
        <span class="s1">sols.append(</span>
            <span class="s1">with_deps(</span>
                <span class="s1">{</span>
                    <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-2&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-add-1&quot;</span><span class="s1">: (</span>
                        <span class="s1">SubgraphCallable(</span>
                            <span class="s1">{</span>
                                <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;inc-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                <span class="s3">&quot;add-2&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)))</span><span class="s0">,</span>
                            <span class="s1">}</span><span class="s0">,</span>
                            <span class="s3">&quot;add-2&quot;</span><span class="s0">,</span>
                            <span class="s1">inkeys</span><span class="s0">,</span>
                        <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span>
                    <span class="s1">+ inkeys</span><span class="s0">,</span>
                    <span class="s3">&quot;add-2&quot;</span><span class="s1">: </span><span class="s3">&quot;inc-add-1&quot;</span><span class="s0">,</span>
                    <span class="s3">&quot;inc-6&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">(inc</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res </span><span class="s0">in </span><span class="s1">sols</span>


<span class="s0">def </span><span class="s1">test_fuse_subgraphs_linear_chains_of_duplicate_deps(compare_subgraph_callables):</span>
    <span class="s1">dsk = {</span>
        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-2&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-3&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-4&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-3&quot;</span><span class="s0">, </span><span class="s3">&quot;add-3&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;add-5&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-4&quot;</span><span class="s0">, </span><span class="s3">&quot;add-4&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">res = fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;add-5&quot;</span><span class="s0">, </span><span class="s1">fuse_subgraphs=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">sol = with_deps(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;add-x-1&quot;</span><span class="s1">: (</span>
                <span class="s1">SubgraphCallable(</span>
                    <span class="s1">{</span>
                        <span class="s3">&quot;x-1&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
                        <span class="s3">&quot;add-1&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s0">, </span><span class="s3">&quot;x-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s3">&quot;add-2&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s0">, </span><span class="s3">&quot;add-1&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s3">&quot;add-3&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s0">, </span><span class="s3">&quot;add-2&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s3">&quot;add-4&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-3&quot;</span><span class="s0">, </span><span class="s3">&quot;add-3&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s3">&quot;add-5&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s3">&quot;add-4&quot;</span><span class="s0">, </span><span class="s3">&quot;add-4&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">}</span><span class="s0">,</span>
                    <span class="s3">&quot;add-5&quot;</span><span class="s0">,</span>
                    <span class="s1">()</span><span class="s0">,</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s3">&quot;add-5&quot;</span><span class="s1">: </span><span class="s3">&quot;add-x-1&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">res == sol</span>


<span class="s0">def </span><span class="s1">test_dont_fuse_numpy_arrays():</span>
    <span class="s2">&quot;&quot;&quot; 
    Some types should stay in the graph bare 
 
    This helps with things like serialization 
    &quot;&quot;&quot;</span>
    <span class="s1">np = pytest.importorskip(</span><span class="s3">&quot;numpy&quot;</span><span class="s1">)</span>
    <span class="s1">dsk = {</span><span class="s3">&quot;x&quot;</span><span class="s1">: np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">)}</span>

    <span class="s0">assert </span><span class="s1">fuse(dsk</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] == dsk</span>


<span class="s0">def </span><span class="s1">test_fuse_config():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s3">&quot;optimization.fuse.active&quot;</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}):</span>
        <span class="s1">d = {</span>
            <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">dependencies = {</span><span class="s3">&quot;b&quot;</span><span class="s1">: (</span><span class="s3">&quot;a&quot;</span><span class="s0">,</span><span class="s1">)}</span>
        <span class="s0">assert </span><span class="s1">fuse(d</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s1">dependencies=dependencies) == (d</span><span class="s0">, </span><span class="s1">dependencies)</span>


<span class="s0">def </span><span class="s1">test_fused_keys_max_length():  </span><span class="s5"># generic fix for gh-5999</span>
    <span class="s1">d = {</span>
        <span class="s3">&quot;u-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">inc</span><span class="s0">,</span>
            <span class="s3">&quot;v-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;v-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">inc</span><span class="s0">,</span>
            <span class="s3">&quot;w-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;w-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">inc</span><span class="s0">,</span>
            <span class="s3">&quot;x-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;x-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">inc</span><span class="s0">,</span>
            <span class="s3">&quot;y-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;y-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">inc</span><span class="s0">,</span>
            <span class="s3">&quot;z-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;z-looooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooooong&quot;</span><span class="s1">: (</span>
            <span class="s1">add</span><span class="s0">,</span>
            <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s3">&quot;a&quot;</span><span class="s1">: </span><span class="s4">1</span><span class="s0">,</span>
        <span class="s3">&quot;b&quot;</span><span class="s1">: </span><span class="s4">2</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">fused</span><span class="s0">, </span><span class="s1">deps = fuse(d</span><span class="s0">, </span><span class="s1">rename_keys=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">fused:</span>
        <span class="s0">assert </span><span class="s1">len(key) &lt; </span><span class="s4">150</span>
</pre>
</body>
</html>