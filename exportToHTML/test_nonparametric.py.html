<html>
<head>
<title>test_nonparametric.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_nonparametric.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
 
Created on Fri Jul 05 14:05:24 2013 
Aug 15 2020: add brunnermunzel, rank_compare_2indep 
 
Author: Josef Perktold 
&quot;&quot;&quot;</span>
<span class="s3">from </span><span class="s1">statsmodels.compat.python </span><span class="s3">import </span><span class="s1">lzip</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">(assert_allclose</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">,</span>
                           <span class="s1">assert_approx_equal</span><span class="s3">, </span><span class="s1">assert_)</span>

<span class="s3">from </span><span class="s1">scipy </span><span class="s3">import </span><span class="s1">stats</span>
<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">statsmodels.stats.contingency_tables </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">mcnemar</span><span class="s3">, </span><span class="s1">cochrans_q</span><span class="s3">, </span><span class="s1">SquareTable)</span>
<span class="s3">from </span><span class="s1">statsmodels.sandbox.stats.runs </span><span class="s3">import </span><span class="s1">(Runs</span><span class="s3">,</span>
                                            <span class="s1">runstest_1samp</span><span class="s3">, </span><span class="s1">runstest_2samp)</span>
<span class="s3">from </span><span class="s1">statsmodels.sandbox.stats.runs </span><span class="s3">import </span><span class="s1">mcnemar </span><span class="s3">as </span><span class="s1">sbmcnemar</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.nonparametric </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">rank_compare_2indep</span><span class="s3">, </span><span class="s1">rank_compare_2ordinal</span><span class="s3">, </span><span class="s1">prob_larger_continuous</span><span class="s3">,</span>
    <span class="s1">cohensd2problarger)</span>
<span class="s3">from </span><span class="s1">statsmodels.tools.testing </span><span class="s3">import </span><span class="s1">Holder</span>


<span class="s3">def </span><span class="s1">_expand_table(table):</span>
    <span class="s2">'''expand a 2 by 2 contingency table to observations 
    '''</span>
    <span class="s3">return </span><span class="s1">np.repeat([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">table.ravel()</span><span class="s3">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_mcnemar_exact():</span>
    <span class="s1">f_obs1 = np.array([[</span><span class="s4">101</span><span class="s3">, </span><span class="s4">121</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs2 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">70</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs3 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">80</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs4 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">30</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">60</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs5 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">10</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">30</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs6 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">10</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">10</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>

    <span class="s0">#vassar college online computation</span>
    <span class="s1">res1 = </span><span class="s4">0.000004</span>
    <span class="s1">res2 = </span><span class="s4">0.378688</span>
    <span class="s1">res3 = </span><span class="s4">0.089452</span>
    <span class="s1">res4 = </span><span class="s4">0.00206</span>
    <span class="s1">res5 = </span><span class="s4">0.002221</span>
    <span class="s1">res6 = </span><span class="s4">1.</span>
    <span class="s1">stat = mcnemar(f_obs1</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s1">res1]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs2</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s1">res2]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs3</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s1">res3]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs4</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">30</span><span class="s3">, </span><span class="s1">res4]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs5</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">10</span><span class="s3">, </span><span class="s1">res5]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs6</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">10</span><span class="s3">, </span><span class="s1">res6]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_mcnemar_chisquare():</span>
    <span class="s1">f_obs1 = np.array([[</span><span class="s4">101</span><span class="s3">, </span><span class="s4">121</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs2 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">70</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>
    <span class="s1">f_obs3 = np.array([[</span><span class="s4">101</span><span class="s3">,  </span><span class="s4">80</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">59</span><span class="s3">, </span><span class="s4">33</span><span class="s1">]])</span>

    <span class="s0">#&gt; mcn = mcnemar.test(matrix(c(101, 121,  59,  33),nrow=2))</span>
    <span class="s1">res1 = [</span><span class="s4">2.067222e01</span><span class="s3">, </span><span class="s4">5.450095e-06</span><span class="s1">]</span>
    <span class="s1">res2 = [</span><span class="s4">0.7751938</span><span class="s3">,    </span><span class="s4">0.3786151</span><span class="s1">]</span>
    <span class="s1">res3 = [</span><span class="s4">2.87769784</span><span class="s3">,   </span><span class="s4">0.08981434</span><span class="s1">]</span>

    <span class="s1">stat = mcnemar(f_obs1</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs2</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
    <span class="s1">stat = mcnemar(f_obs3</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([stat.statistic</span><span class="s3">, </span><span class="s1">stat.pvalue]</span><span class="s3">, </span><span class="s1">res3</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s0"># test correction = False</span>
    <span class="s1">res1 = [</span><span class="s4">2.135556e01</span><span class="s3">, </span><span class="s4">3.815136e-06</span><span class="s1">]</span>
    <span class="s1">res2 = [</span><span class="s4">0.9379845</span><span class="s3">,   </span><span class="s4">0.3327967</span><span class="s1">]</span>
    <span class="s1">res3 = [</span><span class="s4">3.17266187</span><span class="s3">,  </span><span class="s4">0.07488031</span><span class="s1">]</span>

    <span class="s1">res = mcnemar(f_obs1</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
    <span class="s1">res = mcnemar(f_obs2</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">res2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
    <span class="s1">res = mcnemar(f_obs3</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">res3</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_mcnemar_vectorized(reset_randomstate):</span>
    <span class="s1">ttk = np.random.randint(</span><span class="s4">5</span><span class="s3">,</span><span class="s4">15</span><span class="s3">, </span><span class="s1">size=(</span><span class="s4">2</span><span class="s3">,</span><span class="s4">2</span><span class="s3">,</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res = sbmcnemar(ttk</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res1 = lzip(*[sbmcnemar(ttk[:</span><span class="s3">, </span><span class="s1">:</span><span class="s3">, </span><span class="s1">i]</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False</span><span class="s1">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>
    <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res = sbmcnemar(ttk</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res1 = lzip(*[sbmcnemar(ttk[:</span><span class="s3">, </span><span class="s1">:</span><span class="s3">, </span><span class="s1">i]</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
                      <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>
    <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res = sbmcnemar(ttk</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">res1 = lzip(*[sbmcnemar(ttk[:</span><span class="s3">, </span><span class="s1">:</span><span class="s3">, </span><span class="s1">i]</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">True</span><span class="s1">) </span><span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">)])</span>
    <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_symmetry_bowker():</span>
    <span class="s1">table = np.array([</span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">,</span>
                      <span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s1">]).reshape(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s1">)</span>

    <span class="s1">res = SquareTable(table</span><span class="s3">, </span><span class="s1">shift_zeros=</span><span class="s3">False</span><span class="s1">).symmetry()</span>
    <span class="s1">mcnemar5_1 = dict(statistic=</span><span class="s4">7.001587</span><span class="s3">, </span><span class="s1">pvalue=</span><span class="s4">0.7252951</span><span class="s3">, </span><span class="s1">parameters=(</span><span class="s4">10</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
                      <span class="s1">distr=</span><span class="s5">'chi2'</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">,</span>
                    <span class="s1">[mcnemar5_1[</span><span class="s5">'statistic'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">mcnemar5_1[</span><span class="s5">'pvalue'</span><span class="s1">]]</span><span class="s3">,</span>
                    <span class="s1">rtol=</span><span class="s4">1e-7</span><span class="s1">)</span>

    <span class="s1">res = SquareTable(</span><span class="s4">1 </span><span class="s1">+ table</span><span class="s3">, </span><span class="s1">shift_zeros=</span><span class="s3">False</span><span class="s1">).symmetry()</span>
    <span class="s1">mcnemar5_1b = dict(statistic=</span><span class="s4">5.355988</span><span class="s3">, </span><span class="s1">pvalue=</span><span class="s4">0.8661652</span><span class="s3">, </span><span class="s1">parameters=(</span><span class="s4">10</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
                       <span class="s1">distr=</span><span class="s5">'chi2'</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">,</span>
                    <span class="s1">[mcnemar5_1b[</span><span class="s5">'statistic'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">mcnemar5_1b[</span><span class="s5">'pvalue'</span><span class="s1">]]</span><span class="s3">,</span>
                    <span class="s1">rtol=</span><span class="s4">1e-7</span><span class="s1">)</span>

    <span class="s1">table = np.array([</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">9</span><span class="s3">,</span>
                      <span class="s4">8</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]).reshape(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">5</span><span class="s1">)</span>

    <span class="s1">res = SquareTable(table</span><span class="s3">, </span><span class="s1">shift_zeros=</span><span class="s3">False</span><span class="s1">).symmetry()</span>
    <span class="s1">mcnemar5_2 = dict(statistic=</span><span class="s4">18.76432</span><span class="s3">, </span><span class="s1">pvalue=</span><span class="s4">0.04336035</span><span class="s3">, </span><span class="s1">parameters=(</span><span class="s4">10</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
                      <span class="s1">distr=</span><span class="s5">'chi2'</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">,</span>
                    <span class="s1">[mcnemar5_2[</span><span class="s5">'statistic'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">mcnemar5_2[</span><span class="s5">'pvalue'</span><span class="s1">]]</span><span class="s3">,</span>
                    <span class="s1">rtol=</span><span class="s4">1.5e-7</span><span class="s1">)</span>

    <span class="s1">res = SquareTable(</span><span class="s4">1 </span><span class="s1">+ table</span><span class="s3">, </span><span class="s1">shift_zeros=</span><span class="s3">False</span><span class="s1">).symmetry()</span>
    <span class="s1">mcnemar5_2b = dict(statistic=</span><span class="s4">14.55256</span><span class="s3">, </span><span class="s1">pvalue=</span><span class="s4">0.1492461</span><span class="s3">, </span><span class="s1">parameters=(</span><span class="s4">10</span><span class="s3">,</span><span class="s1">)</span><span class="s3">,</span>
                       <span class="s1">distr=</span><span class="s5">'chi2'</span><span class="s1">)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">,</span>
                    <span class="s1">[mcnemar5_2b[</span><span class="s5">'statistic'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">mcnemar5_2b[</span><span class="s5">'pvalue'</span><span class="s1">]]</span><span class="s3">,</span>
                    <span class="s1">rtol=</span><span class="s4">1e-7</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_cochransq():</span>
    <span class="s0">#example from dataplot docs, Conovover p. 253</span>
    <span class="s0">#http://www.itl.nist.gov/div898/software/dataplot/refman1/auxillar/cochran.htm</span>
    <span class="s1">x = np.array([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                   <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">res_qstat = </span><span class="s4">2.8</span>
    <span class="s1">res_pvalue = </span><span class="s4">0.246597</span>
    <span class="s1">res = cochrans_q(x)</span>
    <span class="s1">assert_almost_equal([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">[res_qstat</span><span class="s3">, </span><span class="s1">res_pvalue])</span>

    <span class="s0">#equivalence of mcnemar and cochranq for 2 samples</span>
    <span class="s1">a</span><span class="s3">,</span><span class="s1">b = x[:</span><span class="s3">,</span><span class="s1">:</span><span class="s4">2</span><span class="s1">].T</span>
    <span class="s1">res = cochrans_q(x[:</span><span class="s3">, </span><span class="s1">:</span><span class="s4">2</span><span class="s1">])</span>
    <span class="s3">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">assert_almost_equal(sbmcnemar(a</span><span class="s3">, </span><span class="s1">b</span><span class="s3">, </span><span class="s1">exact=</span><span class="s3">False, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">[res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue])</span>


<span class="s3">def </span><span class="s1">test_cochransq2():</span>
    <span class="s0"># from an example found on web, verifies 13.286</span>
    <span class="s1">data = np.array(</span><span class="s5">''' 
        0 0 0 1 
        0 0 0 1 
        0 0 0 1 
        1 1 1 1 
        1 0 0 1 
        0 1 0 1 
        1 0 0 1 
        0 0 0 1 
        0 1 0 0 
        0 0 0 0 
        1 0 0 1 
        0 0 1 1'''</span><span class="s1">.split()</span><span class="s3">, </span><span class="s1">int).reshape(-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span>

    <span class="s1">res = cochrans_q(data)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">13.2857143</span><span class="s3">, </span><span class="s4">0.00405776</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_cochransq3():</span>
    <span class="s0"># another example compared to SAS</span>
    <span class="s0"># in frequency weight format</span>
    <span class="s1">dt = [(</span><span class="s5">'A'</span><span class="s3">, </span><span class="s5">'S1'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">(</span><span class="s5">'B'</span><span class="s3">, </span><span class="s5">'S1'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">(</span><span class="s5">'C'</span><span class="s3">, </span><span class="s5">'S1'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">(</span><span class="s5">'count'</span><span class="s3">, </span><span class="s1">int)]</span>
    <span class="s1">dta = np.array([(</span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s4">6</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s4">16</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'F'</span><span class="s3">, </span><span class="s4">6</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'F'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s5">'U'</span><span class="s3">, </span><span class="s4">6</span><span class="s1">)]</span><span class="s3">, </span><span class="s1">dt)</span>

    <span class="s1">cases = np.array([[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">count = np.array([ </span><span class="s4">6</span><span class="s3">,  </span><span class="s4">2</span><span class="s3">, </span><span class="s4">16</span><span class="s3">,  </span><span class="s4">4</span><span class="s3">,  </span><span class="s4">2</span><span class="s3">,  </span><span class="s4">6</span><span class="s3">,  </span><span class="s4">4</span><span class="s3">,  </span><span class="s4">6</span><span class="s1">])</span>
    <span class="s1">data = np.repeat(cases</span><span class="s3">, </span><span class="s1">count</span><span class="s3">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">res = cochrans_q(data)</span>
    <span class="s1">assert_allclose([res.statistic</span><span class="s3">, </span><span class="s1">res.pvalue]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">8.4706</span><span class="s3">, </span><span class="s4">0.0145</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">5e-5</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">test_runstest(reset_randomstate):</span>
    <span class="s0">#comparison numbers from R, tseries, runs.test</span>
    <span class="s0">#currently only 2-sided used</span>
    <span class="s1">x = np.array([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">z_twosided = </span><span class="s4">1.386750</span>
    <span class="s1">pvalue_twosided = </span><span class="s4">0.1655179</span>

    <span class="s1">z_greater = </span><span class="s4">1.386750</span>
    <span class="s1">pvalue_greater = </span><span class="s4">0.08275893</span>

    <span class="s1">z_less = </span><span class="s4">1.386750</span>
    <span class="s1">pvalue_less = </span><span class="s4">0.917241</span>

    <span class="s0">#print Runs(x).runs_test(correction=False)</span>
    <span class="s1">assert_almost_equal(np.array(Runs(x).runs_test(correction=</span><span class="s3">False</span><span class="s1">))</span><span class="s3">,</span>
                        <span class="s1">[z_twosided</span><span class="s3">, </span><span class="s1">pvalue_twosided]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>


    <span class="s0"># compare with runstest_1samp which should have same indicator</span>
    <span class="s1">assert_almost_equal(runstest_1samp(x</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">[z_twosided</span><span class="s3">, </span><span class="s1">pvalue_twosided]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s1">x2 = x - </span><span class="s4">0.5 </span><span class="s1">+ np.random.uniform(-</span><span class="s4">0.1</span><span class="s3">, </span><span class="s4">0.1</span><span class="s3">, </span><span class="s1">size=len(x))</span>
    <span class="s1">assert_almost_equal(runstest_1samp(x2</span><span class="s3">, </span><span class="s1">cutoff=</span><span class="s4">0</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">[z_twosided</span><span class="s3">, </span><span class="s1">pvalue_twosided]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(runstest_1samp(x2</span><span class="s3">, </span><span class="s1">cutoff=</span><span class="s5">'mean'</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">[z_twosided</span><span class="s3">, </span><span class="s1">pvalue_twosided]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(runstest_1samp(x2</span><span class="s3">, </span><span class="s1">cutoff=x2.mean()</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">[z_twosided</span><span class="s3">, </span><span class="s1">pvalue_twosided]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>

    <span class="s0"># check median</span>
    <span class="s1">assert_almost_equal(runstest_1samp(x2</span><span class="s3">, </span><span class="s1">cutoff=</span><span class="s5">'median'</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">runstest_1samp(x2</span><span class="s3">, </span><span class="s1">cutoff=np.median(x2)</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span><span class="s3">,</span>
                        <span class="s1">decimal=</span><span class="s4">6</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_runstest_2sample():</span>
    <span class="s0"># regression test, checked with MonteCarlo and looks reasonable</span>

    <span class="s1">x = [</span><span class="s4">31.8</span><span class="s3">, </span><span class="s4">32.8</span><span class="s3">, </span><span class="s4">39.2</span><span class="s3">, </span><span class="s4">36</span><span class="s3">, </span><span class="s4">30</span><span class="s3">, </span><span class="s4">34.5</span><span class="s3">, </span><span class="s4">37.4</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">35.5</span><span class="s3">, </span><span class="s4">27.6</span><span class="s3">, </span><span class="s4">21.3</span><span class="s3">, </span><span class="s4">24.8</span><span class="s3">, </span><span class="s4">36.7</span><span class="s3">, </span><span class="s4">30</span><span class="s1">]</span>
    <span class="s1">y[-</span><span class="s4">1</span><span class="s1">] += </span><span class="s4">1e-6  </span><span class="s0">#avoid tie that creates warning</span>
    <span class="s1">groups = np.concatenate((np.zeros(len(x))</span><span class="s3">, </span><span class="s1">np.ones(len(y))))</span>

    <span class="s1">res = runstest_2samp(x</span><span class="s3">, </span><span class="s1">y)</span>
    <span class="s1">res1 = (</span><span class="s4">0.022428065200812752</span><span class="s3">, </span><span class="s4">0.98210649318649212</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s0"># check as stacked array</span>
    <span class="s1">res2 = runstest_2samp(x</span><span class="s3">, </span><span class="s1">y)</span>
    <span class="s1">assert_allclose(res2</span><span class="s3">, </span><span class="s1">res</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s1">xy = np.concatenate((x</span><span class="s3">, </span><span class="s1">y))</span>
    <span class="s1">res_1s = runstest_1samp(xy)</span>
    <span class="s1">assert_allclose(res_1s</span><span class="s3">, </span><span class="s1">res1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
    <span class="s0"># check cutoff</span>
    <span class="s1">res2_1s = runstest_1samp(xy</span><span class="s3">, </span><span class="s1">xy.mean())</span>
    <span class="s1">assert_allclose(res2_1s</span><span class="s3">, </span><span class="s1">res_1s</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_brunnermunzel_one_sided():</span>
    <span class="s0"># copied from scipy with adjustment</span>
    <span class="s1">x = [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]</span>
    <span class="s1">significant = </span><span class="s4">13</span>

    <span class="s0"># revere direction to match our definition</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y = y</span><span class="s3">, </span><span class="s1">x</span>

    <span class="s0"># Results are compared with R's lawstat package.</span>
    <span class="s1">u1</span><span class="s3">, </span><span class="s1">p1 = rank_compare_2indep(x</span><span class="s3">, </span><span class="s1">y</span>
                                 <span class="s1">).test_prob_superior(alternative=</span><span class="s5">'smaller'</span><span class="s1">)</span>
    <span class="s1">u2</span><span class="s3">, </span><span class="s1">p2 = rank_compare_2indep(y</span><span class="s3">, </span><span class="s1">x</span>
                                 <span class="s1">).test_prob_superior(alternative=</span><span class="s5">'larger'</span><span class="s1">)</span>
    <span class="s1">u3</span><span class="s3">, </span><span class="s1">p3 = rank_compare_2indep(x</span><span class="s3">, </span><span class="s1">y</span>
                                 <span class="s1">).test_prob_superior(alternative=</span><span class="s5">'larger'</span><span class="s1">)</span>
    <span class="s1">u4</span><span class="s3">, </span><span class="s1">p4 = rank_compare_2indep(y</span><span class="s3">, </span><span class="s1">x</span>
                                 <span class="s1">).test_prob_superior(alternative=</span><span class="s5">'smaller'</span><span class="s1">)</span>

    <span class="s1">assert_approx_equal(p1</span><span class="s3">, </span><span class="s1">p2</span><span class="s3">, </span><span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(p3</span><span class="s3">, </span><span class="s1">p4</span><span class="s3">, </span><span class="s1">significant=significant)</span>
    <span class="s1">assert_(p1 != p3)</span>
    <span class="s1">assert_approx_equal(u1</span><span class="s3">, </span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(u2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(u3</span><span class="s3">, </span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(u4</span><span class="s3">, </span><span class="s1">-</span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>

    <span class="s0"># Note: scipy and lawstat tail is reversed compared to test statistic</span>
    <span class="s1">assert_approx_equal(p3</span><span class="s3">, </span><span class="s4">0.0028931043330757342</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(p1</span><span class="s3">, </span><span class="s4">0.99710689566692423</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>


<span class="s3">def </span><span class="s1">test_brunnermunzel_two_sided():</span>
    <span class="s0"># copied from scipy with adjustment</span>
    <span class="s1">x = [</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]</span>
    <span class="s1">significant = </span><span class="s4">13</span>

    <span class="s0"># revere direction to match our definition</span>
    <span class="s1">x</span><span class="s3">, </span><span class="s1">y = y</span><span class="s3">, </span><span class="s1">x</span>

    <span class="s0"># Results are compared with R's lawstat package.</span>
    <span class="s1">res1 = rank_compare_2indep(x</span><span class="s3">, </span><span class="s1">y)</span>
    <span class="s1">u1</span><span class="s3">, </span><span class="s1">p1 = res1</span>
    <span class="s1">t1 = res1.test_prob_superior(alternative=</span><span class="s5">'two-sided'</span><span class="s1">)</span>
    <span class="s1">res2 = rank_compare_2indep(y</span><span class="s3">, </span><span class="s1">x)</span>
    <span class="s1">u2</span><span class="s3">, </span><span class="s1">p2 = res2</span>
    <span class="s1">t2 = res2.test_prob_superior(alternative=</span><span class="s5">'two-sided'</span><span class="s1">)</span>

    <span class="s1">assert_approx_equal(p1</span><span class="s3">, </span><span class="s1">p2</span><span class="s3">, </span><span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(u1</span><span class="s3">, </span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(u2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">3.1374674823029505</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>
    <span class="s1">assert_approx_equal(p2</span><span class="s3">, </span><span class="s4">0.0057862086661515377</span><span class="s3">,</span>
                        <span class="s1">significant=significant)</span>

    <span class="s1">assert_allclose(t1[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">u1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(t2[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">u2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(t1[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">p1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(t2[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">p2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_rank_compare_2indep1():</span>
    <span class="s0"># Example from Munzel and Hauschke 2003</span>
    <span class="s0"># data is given by counts, expand to observations</span>
    <span class="s1">levels = [-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">new = [</span><span class="s4">24</span><span class="s3">, </span><span class="s4">37</span><span class="s3">, </span><span class="s4">21</span><span class="s3">, </span><span class="s4">19</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]</span>
    <span class="s1">active = [</span><span class="s4">11</span><span class="s3">, </span><span class="s4">51</span><span class="s3">, </span><span class="s4">22</span><span class="s3">, </span><span class="s4">21</span><span class="s3">, </span><span class="s4">7</span><span class="s1">]</span>
    <span class="s1">x1 = np.repeat(levels</span><span class="s3">, </span><span class="s1">new)</span>
    <span class="s1">x2 = np.repeat(levels</span><span class="s3">, </span><span class="s1">active)</span>

    <span class="s0"># using lawstat</span>
    <span class="s0"># &gt; brunner.munzel.test(xn, xa) #brunnermunzel.test(x, y)</span>
    <span class="s1">res2_t = Holder(statistic=</span><span class="s4">1.1757561456582</span><span class="s3">,</span>
                    <span class="s1">df=</span><span class="s4">204.2984239868</span><span class="s3">,</span>
                    <span class="s1">pvalue=</span><span class="s4">0.2410606649547</span><span class="s3">,</span>
                    <span class="s1">ci=[</span><span class="s4">0.4700629827705593</span><span class="s3">, </span><span class="s4">0.6183882855872511</span><span class="s1">]</span><span class="s3">,</span>
                    <span class="s1">prob=</span><span class="s4">0.5442256341789052</span><span class="s1">)</span>

    <span class="s1">res = rank_compare_2indep(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">use_t=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">-res2_t.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.prob1</span><span class="s3">, </span><span class="s4">1 </span><span class="s1">- res2_t.prob</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.prob2</span><span class="s3">, </span><span class="s1">res2_t.prob</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">tt = res.test_prob_superior()</span>
    <span class="s0"># TODO: return HolderTuple</span>
    <span class="s0"># assert_allclose(tt.statistic, res2_t.statistic)</span>
    <span class="s0"># TODO: check sign/direction in lawstat</span>
    <span class="s1">assert_allclose(tt[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">-res2_t.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s1">ci = res.conf_int(alpha=</span><span class="s4">0.05</span><span class="s1">)</span>
    <span class="s0"># we compare normal confint with t confint, lower rtol</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s4">1 </span><span class="s1">- np.array(res2_t.ci)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.005</span><span class="s1">)</span>
    <span class="s0"># test consistency of test and confint</span>
    <span class="s1">res_lb = res.test_prob_superior(value=ci[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_lb[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">res_ub = res.test_prob_superior(value=ci[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_ub[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s0"># test consistency of tost and confint</span>
    <span class="s0"># lower margin is binding, alternative larger</span>
    <span class="s1">res_tost = res.tost_prob_superior(ci[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci[</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">1.05</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.results_larger.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s0"># upper margin is binding, alternative smaller</span>
    <span class="s1">res_tost = res.tost_prob_superior(ci[</span><span class="s4">0</span><span class="s1">] * </span><span class="s4">0.85</span><span class="s3">, </span><span class="s1">ci[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_tost.results_smaller.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s0"># use t-distribution</span>
    <span class="s0"># our ranking is defined as reversed from lawstat, and BM article</span>
    <span class="s0"># revere direction to match our definition</span>
    <span class="s1">x1</span><span class="s3">, </span><span class="s1">x2 = x2</span><span class="s3">, </span><span class="s1">x1</span>
    <span class="s1">res = rank_compare_2indep(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">use_t=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res2_t.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">tt = res.test_prob_superior()</span>
    <span class="s0"># TODO: return HolderTuple</span>
    <span class="s0"># assert_allclose(tt.statistic, res2_t.statistic)</span>
    <span class="s0"># TODO: check sign/direction in lawstat, reversed from ours</span>
    <span class="s1">assert_allclose(tt[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2_t.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(tt[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2_t.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res2_t.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res2_t.df</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s1">ci = res.conf_int(alpha=</span><span class="s4">0.05</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">res2_t.ci</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-11</span><span class="s1">)</span>
    <span class="s0"># test consistency of test and confint</span>
    <span class="s1">res_lb = res.test_prob_superior(value=ci[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_lb[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-11</span><span class="s1">)</span>
    <span class="s1">res_ub = res.test_prob_superior(value=ci[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_ub[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-11</span><span class="s1">)</span>

    <span class="s0"># test consistency of tost and confint</span>
    <span class="s0"># lower margin is binding, alternative larger</span>
    <span class="s1">res_tost = res.tost_prob_superior(ci[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci[</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">1.05</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.results_larger.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

    <span class="s0"># upper margin is binding, alternative smaller</span>
    <span class="s1">res_tost = res.tost_prob_superior(ci[</span><span class="s4">0</span><span class="s1">] * </span><span class="s4">0.85</span><span class="s3">, </span><span class="s1">ci[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res_tost.results_smaller.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res_tost.pvalue</span><span class="s3">, </span><span class="s4">0.025</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

    <span class="s0"># extras</span>
    <span class="s0"># cohen's d</span>
    <span class="s1">esd = res.effectsize_normal()</span>
    <span class="s1">p = prob_larger_continuous(stats.norm(loc=esd)</span><span class="s3">, </span><span class="s1">stats.norm)</span>
    <span class="s0"># round trip</span>
    <span class="s1">assert_allclose(p</span><span class="s3">, </span><span class="s1">res.prob1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s0"># round trip with cohen's d</span>
    <span class="s1">pc = cohensd2problarger(esd)</span>
    <span class="s1">assert_allclose(pc</span><span class="s3">, </span><span class="s1">res.prob1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s1">ci_tr = res.confint_lintransf(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_tr</span><span class="s3">, </span><span class="s4">1 </span><span class="s1">- np.array(res2_t.ci)[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.005</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_rank_compare_ord():</span>
    <span class="s0"># compare ordinal count version with full version</span>
    <span class="s0"># Example from Munzel and Hauschke 2003</span>
    <span class="s0"># data is given by counts, expand to observations</span>
    <span class="s1">levels = [-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">new = [</span><span class="s4">24</span><span class="s3">, </span><span class="s4">37</span><span class="s3">, </span><span class="s4">21</span><span class="s3">, </span><span class="s4">19</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]</span>
    <span class="s1">active = [</span><span class="s4">11</span><span class="s3">, </span><span class="s4">51</span><span class="s3">, </span><span class="s4">22</span><span class="s3">, </span><span class="s4">21</span><span class="s3">, </span><span class="s4">7</span><span class="s1">]</span>
    <span class="s1">x1 = np.repeat(levels</span><span class="s3">, </span><span class="s1">new)</span>
    <span class="s1">x2 = np.repeat(levels</span><span class="s3">, </span><span class="s1">active)</span>

    <span class="s3">for </span><span class="s1">use_t </span><span class="s3">in </span><span class="s1">[</span><span class="s3">False, True</span><span class="s1">]:</span>
        <span class="s1">res2 = rank_compare_2indep(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">use_t=use_t)</span>
        <span class="s1">res1 = rank_compare_2ordinal(new</span><span class="s3">, </span><span class="s1">active</span><span class="s3">, </span><span class="s1">use_t=use_t)</span>
        <span class="s1">assert_allclose(res2.prob1</span><span class="s3">, </span><span class="s1">res1.prob1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res2.var_prob</span><span class="s3">, </span><span class="s1">res1.var_prob</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">s1 = str(res1.summary())</span>
        <span class="s1">s2 = str(res2.summary())</span>
        <span class="s3">assert </span><span class="s1">s1 == s2</span>


<span class="s3">def </span><span class="s1">test_rank_compare_vectorized():</span>
    <span class="s1">np.random.seed(</span><span class="s4">987126</span><span class="s1">)</span>
    <span class="s1">x1 = np.random.randint(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s1">(</span><span class="s4">50</span><span class="s3">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">x2 = np.random.randint(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">25</span><span class="s3">, </span><span class="s1">(</span><span class="s4">50</span><span class="s3">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">res = rank_compare_2indep(x1</span><span class="s3">, </span><span class="s1">x2)</span>
    <span class="s1">tst = res.test_prob_superior(</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">tost = res.tost_prob_superior(</span><span class="s4">0.4</span><span class="s3">, </span><span class="s4">0.6</span><span class="s1">)</span>

    <span class="s0"># smoke test for summary</span>
    <span class="s1">res.summary()</span>

    <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">):</span>
        <span class="s1">res_i = rank_compare_2indep(x1[:</span><span class="s3">, </span><span class="s1">i]</span><span class="s3">, </span><span class="s1">x2[:</span><span class="s3">, </span><span class="s1">i])</span>
        <span class="s1">assert_allclose(res.statistic[i]</span><span class="s3">, </span><span class="s1">res_i.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue[i]</span><span class="s3">, </span><span class="s1">res_i.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.prob1[i]</span><span class="s3">, </span><span class="s1">res_i.prob1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>

        <span class="s1">tst_i = res_i.test_prob_superior(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tst.statistic[i]</span><span class="s3">, </span><span class="s1">tst_i.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tst.pvalue[i]</span><span class="s3">, </span><span class="s1">tst_i.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>

        <span class="s1">tost_i = res_i.tost_prob_superior(</span><span class="s4">0.4</span><span class="s3">, </span><span class="s4">0.6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tost.statistic[i]</span><span class="s3">, </span><span class="s1">tost_i.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tost.pvalue[i]</span><span class="s3">, </span><span class="s1">tost_i.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
</pre>
</body>
</html>