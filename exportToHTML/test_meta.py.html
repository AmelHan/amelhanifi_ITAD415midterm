<html>
<head>
<title>test_meta.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_meta.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
Created on Tue Apr  7 13:08:37 2020 
 
Author: Josef Perktold 
License: BSD-3 
 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">io</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pandas </span><span class="s3">as </span><span class="s1">pd</span>
<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span>

<span class="s3">from </span><span class="s1">statsmodels.regression.linear_model </span><span class="s3">import </span><span class="s1">WLS</span>
<span class="s3">from </span><span class="s1">statsmodels.genmod.generalized_linear_model </span><span class="s3">import </span><span class="s1">GLM</span>

<span class="s3">from </span><span class="s1">statsmodels.stats.meta_analysis </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">effectsize_smd</span><span class="s3">, </span><span class="s1">effectsize_2proportions</span><span class="s3">, </span><span class="s1">combine_effects</span><span class="s3">,</span>
    <span class="s1">_fit_tau_iterative</span><span class="s3">, </span><span class="s1">_fit_tau_mm</span><span class="s3">, </span><span class="s1">_fit_tau_iter_mm)</span>

<span class="s3">from </span><span class="s1">.results </span><span class="s3">import </span><span class="s1">results_meta</span>


<span class="s3">class </span><span class="s1">TestEffectsizeBinom:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.results = results_meta.eff_prop1</span>
        <span class="s1">ss = </span><span class="s4">&quot;&quot;&quot;</span><span class="s3">\ 
            </span><span class="s4">study,nei,nci,e1i,c1i,e2i,c2i,e3i,c3i,e4i,c4i 
            1,19,22,16.0,20.0,11,12,4.0,8.0,4,3 
            2,34,35,22.0,22.0,18,12,15.0,8.0,15,6 
            3,72,68,44.0,40.0,21,15,10.0,3.0,3,0 
            4,22,20,19.0,12.0,14,5,5.0,4.0,2,3 
            5,70,32,62.0,27.0,42,13,26.0,6.0,15,5 
            6,183,94,130.0,65.0,80,33,47.0,14.0,30,11 
            7,26,50,24.0,30.0,13,18,5.0,10.0,3,9 
            8,61,55,51.0,44.0,37,30,19.0,19.0,11,15 
            9,36,25,30.0,17.0,23,12,13.0,4.0,10,4 
            10,45,35,43.0,35.0,19,14,8.0,4.0,6,0 
            11,246,208,169.0,139.0,106,76,67.0,42.0,51,35 
            12,386,141,279.0,97.0,170,46,97.0,21.0,73,8 
            13,59,32,56.0,30.0,34,17,21.0,9.0,20,7 
            14,45,15,42.0,10.0,18,3,9.0,1.0,9,1 
            15,14,18,14.0,18.0,13,14,12.0,13.0,9,12 
            16,26,19,21.0,15.0,12,10,6.0,4.0,5,1 
            17,74,75,,,42,40,,,23,30&quot;&quot;&quot;</span>
        <span class="s1">df3 = pd.read_csv(io.StringIO(ss))</span>
        <span class="s1">df_12y = df3[[</span><span class="s4">&quot;e2i&quot;</span><span class="s3">, </span><span class="s4">&quot;nei&quot;</span><span class="s3">, </span><span class="s4">&quot;c2i&quot;</span><span class="s3">, </span><span class="s4">&quot;nci&quot;</span><span class="s1">]]</span>
        <span class="s0"># TODO: currently 1 is reference, switch labels</span>
        <span class="s0"># cls.count2, cls.nobs2, cls.count1, cls.nobs1 = df_12y.values.T</span>
        <span class="s1">cls.count1</span><span class="s3">, </span><span class="s1">cls.nobs1</span><span class="s3">, </span><span class="s1">cls.count2</span><span class="s3">, </span><span class="s1">cls.nobs2 = df_12y.values.T</span>

    <span class="s3">def </span><span class="s1">test_effectsize(self):</span>
        <span class="s1">res2 = self.results</span>
        <span class="s1">dta = (self.count1</span><span class="s3">, </span><span class="s1">self.nobs1</span><span class="s3">, </span><span class="s1">self.count2</span><span class="s3">, </span><span class="s1">self.nobs2)</span>
        <span class="s0"># count1, nobs1, count2, nobs2 = dta</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_2proportions(*dta)</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">res2.y_rd</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">res2.v_rd</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_2proportions(*dta</span><span class="s3">, </span><span class="s1">statistic=</span><span class="s4">&quot;rr&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">res2.y_rr</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">res2.v_rr</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_2proportions(*dta</span><span class="s3">, </span><span class="s1">statistic=</span><span class="s4">&quot;or&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">res2.y_or</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">res2.v_or</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_2proportions(*dta</span><span class="s3">, </span><span class="s1">statistic=</span><span class="s4">&quot;as&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">res2.y_as</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">res2.v_as</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestEffSmdMeta:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s0"># example from book Applied Meta-Analysis with R</span>
        <span class="s1">data = [</span>
            <span class="s1">[</span><span class="s4">&quot;Carroll&quot;</span><span class="s3">, </span><span class="s5">94</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">60</span><span class="s3">, </span><span class="s5">92</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s5">60</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">[</span><span class="s4">&quot;Grant&quot;</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">65</span><span class="s3">, </span><span class="s5">92</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">65</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">[</span><span class="s4">&quot;Peck&quot;</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">28</span><span class="s3">, </span><span class="s5">40</span><span class="s3">, </span><span class="s5">88</span><span class="s3">, </span><span class="s5">26</span><span class="s3">, </span><span class="s5">40</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">[</span><span class="s4">&quot;Donat&quot;</span><span class="s3">, </span><span class="s5">94</span><span class="s3">, </span><span class="s5">19</span><span class="s3">, </span><span class="s5">200</span><span class="s3">, </span><span class="s5">82</span><span class="s3">, </span><span class="s5">17</span><span class="s3">, </span><span class="s5">200</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">[</span><span class="s4">&quot;Stewart&quot;</span><span class="s3">, </span><span class="s5">98</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">50</span><span class="s3">, </span><span class="s5">88</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">45</span><span class="s1">]</span><span class="s3">,</span>
            <span class="s1">[</span><span class="s4">&quot;Young&quot;</span><span class="s3">, </span><span class="s5">96</span><span class="s3">, </span><span class="s5">21</span><span class="s3">, </span><span class="s5">85</span><span class="s3">, </span><span class="s5">92</span><span class="s3">, </span><span class="s5">22</span><span class="s3">, </span><span class="s5">85</span><span class="s1">]]</span>
        <span class="s1">colnames = [</span><span class="s4">&quot;study&quot;</span><span class="s3">, </span><span class="s4">&quot;mean_t&quot;</span><span class="s3">, </span><span class="s4">&quot;sd_t&quot;</span><span class="s3">, </span><span class="s4">&quot;n_t&quot;</span><span class="s3">, </span><span class="s4">&quot;mean_c&quot;</span><span class="s3">, </span><span class="s4">&quot;sd_c&quot;</span><span class="s3">, </span><span class="s4">&quot;n_c&quot;</span><span class="s1">]</span>
        <span class="s1">dframe = pd.DataFrame(data</span><span class="s3">, </span><span class="s1">columns=colnames)</span>
        <span class="s1">cls.dta = np.asarray(dframe[[</span><span class="s4">&quot;mean_t&quot;</span><span class="s3">, </span><span class="s4">&quot;sd_t&quot;</span><span class="s3">, </span><span class="s4">&quot;n_t&quot;</span><span class="s3">,</span>
                                     <span class="s4">&quot;mean_c&quot;</span><span class="s3">, </span><span class="s4">&quot;sd_c&quot;</span><span class="s3">, </span><span class="s4">&quot;n_c&quot;</span><span class="s1">]]).T</span>
        <span class="s1">cls.row_names = dframe[</span><span class="s4">&quot;study&quot;</span><span class="s1">]</span>

    <span class="s3">def </span><span class="s1">test_smd(self):</span>
        <span class="s0"># compare with metafor</span>
        <span class="s1">yi = np.array([</span>
            <span class="s5">0.09452415852032972</span><span class="s3">, </span><span class="s5">0.27735586626551018</span><span class="s3">, </span><span class="s5">0.36654442951591998</span><span class="s3">,</span>
            <span class="s5">0.66438496832691396</span><span class="s3">, </span><span class="s5">0.46180628128769841</span><span class="s3">, </span><span class="s5">0.18516443739910043</span><span class="s1">])</span>

        <span class="s1">vi_asy = np.array([</span>
            <span class="s5">0.03337056173559990</span><span class="s3">, </span><span class="s5">0.03106510106366112</span><span class="s3">, </span><span class="s5">0.05083971761755720</span><span class="s3">,</span>
            <span class="s5">0.01055175923267344</span><span class="s3">, </span><span class="s5">0.04334466980873156</span><span class="s3">, </span><span class="s5">0.02363025255552155</span><span class="s1">])</span>
        <span class="s1">vi_ub = np.array([</span>
            <span class="s5">0.03337176211751222</span><span class="s3">, </span><span class="s5">0.03107388569950075</span><span class="s3">, </span><span class="s5">0.05088098670518214</span><span class="s3">,</span>
            <span class="s5">0.01055698026322296</span><span class="s3">, </span><span class="s5">0.04339077140867459</span><span class="s3">, </span><span class="s5">0.02363252645927709</span><span class="s1">])</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_smd(*self.dta)</span>
        <span class="s0"># agreement with metafor is lower, atol for var 2.5e-06</span>
        <span class="s0"># It's likely a small difference in bias correction</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">yi</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">vi_ub</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-4</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">vi_asy</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">2e-3</span><span class="s1">)  </span><span class="s0"># not the same definition</span>

        <span class="s0"># with unequal variance, not available yet</span>
        <span class="s0"># &gt; r = escalc(measure=&quot;SMDH&quot;, m1i=m.t, sd1i=sd.t, n1i=n.t, m2i=m.c,</span>
        <span class="s0">#             sd2i=sd.c, n2i=n.c, data=dat, vtype=&quot;UB&quot;)</span>
        <span class="s1">yi = np.array([</span>
            <span class="s5">0.09452415852032972</span><span class="s3">, </span><span class="s5">0.27735586626551023</span><span class="s3">, </span><span class="s5">0.36654442951591998</span><span class="s3">,</span>
            <span class="s5">0.66438496832691396</span><span class="s3">, </span><span class="s5">0.46122883016705268</span><span class="s3">, </span><span class="s5">0.18516443739910043</span><span class="s1">])</span>
        <span class="s1">vi_ub = np.array([</span>
            <span class="s5">0.03350541862210323</span><span class="s3">, </span><span class="s5">0.03118164624093491</span><span class="s3">, </span><span class="s5">0.05114625874744853</span><span class="s3">,</span>
            <span class="s5">0.01057160214284120</span><span class="s3">, </span><span class="s5">0.04368303906568672</span><span class="s3">, </span><span class="s5">0.02369839436451885</span><span class="s1">])</span>

        <span class="s0"># compare with package `meta`</span>
        <span class="s0"># high agreement, using smd function was written based on meta example</span>

        <span class="s0"># &gt; rm = metacont(n.t,m.t,sd.t,n.c,m.c,sd.c,</span>
        <span class="s0"># +               data=dat,studlab=rownames(dat),sm=&quot;SMD&quot;)</span>

        <span class="s0"># &gt; rm$TE</span>
        <span class="s1">yi_m = np.array([</span>
            <span class="s5">0.09452437336063831</span><span class="s3">, </span><span class="s5">0.27735640148036095</span><span class="s3">, </span><span class="s5">0.36654634845797818</span><span class="s3">,</span>
            <span class="s5">0.66438509989113559</span><span class="s3">, </span><span class="s5">0.46180797677414176</span><span class="s3">, </span><span class="s5">0.18516464424648887</span><span class="s1">])</span>
        <span class="s0"># &gt; rm$seTE**2</span>
        <span class="s1">vi_m = np.array([</span>
            <span class="s5">0.03337182573880991</span><span class="s3">, </span><span class="s5">0.03107434965484927</span><span class="s3">, </span><span class="s5">0.05088322525353587</span><span class="s3">,</span>
            <span class="s5">0.01055724834741877</span><span class="s3">, </span><span class="s5">0.04339324466573324</span><span class="s3">, </span><span class="s5">0.02363264537147130</span><span class="s1">])</span>
        <span class="s1">assert_allclose(eff</span><span class="s3">, </span><span class="s1">yi_m</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_eff</span><span class="s3">, </span><span class="s1">vi_m</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestMetaK1:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">cls.eff = np.array([</span><span class="s5">61.00</span><span class="s3">, </span><span class="s5">61.40</span><span class="s3">, </span><span class="s5">62.21</span><span class="s3">, </span><span class="s5">62.30</span><span class="s3">, </span><span class="s5">62.34</span><span class="s3">, </span><span class="s5">62.60</span><span class="s3">, </span><span class="s5">62.70</span><span class="s3">,</span>
                            <span class="s5">62.84</span><span class="s3">, </span><span class="s5">65.90</span><span class="s1">])</span>
        <span class="s1">cls.var_eff = np.array([</span><span class="s5">0.2025</span><span class="s3">, </span><span class="s5">1.2100</span><span class="s3">, </span><span class="s5">0.0900</span><span class="s3">, </span><span class="s5">0.2025</span><span class="s3">, </span><span class="s5">0.3844</span><span class="s3">, </span><span class="s5">0.5625</span><span class="s3">,</span>
                                <span class="s5">0.0676</span><span class="s3">, </span><span class="s5">0.0225</span><span class="s3">, </span><span class="s5">1.8225</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_tau_kacker(self):</span>
        <span class="s0"># test iterative and two-step methods, Kacker 2004</span>
        <span class="s0"># PM CA DL C2 from table 1 first row p. 135</span>
        <span class="s0"># test for PM and DL are also against R metafor in other tests</span>
        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = self.eff</span><span class="s3">, </span><span class="s1">self.var_eff</span>
        <span class="s1">t_PM</span><span class="s3">, </span><span class="s1">t_CA</span><span class="s3">, </span><span class="s1">t_DL</span><span class="s3">, </span><span class="s1">t_C2 = [</span><span class="s5">0.8399</span><span class="s3">, </span><span class="s5">1.1837</span><span class="s3">, </span><span class="s5">0.5359</span><span class="s3">, </span><span class="s5">0.9352</span><span class="s1">]</span>

        <span class="s1">tau2</span><span class="s3">, </span><span class="s1">converged = _fit_tau_iterative(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">,</span>
                                             <span class="s1">tau2_start=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_equal(converged</span><span class="s3">, True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.sqrt(tau2)</span><span class="s3">, </span><span class="s1">t_PM</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-5</span><span class="s1">)</span>

        <span class="s1">k = len(eff)</span>
        <span class="s0"># cochrane uniform weights</span>
        <span class="s1">tau2_ca = _fit_tau_mm(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s1">np.ones(k) / k)</span>
        <span class="s1">assert_allclose(np.sqrt(tau2_ca)</span><span class="s3">, </span><span class="s1">t_CA</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-5</span><span class="s1">)</span>

        <span class="s0"># DL one step, and 1 iteration, reduced agreement with Kacker</span>
        <span class="s1">tau2_dl = _fit_tau_mm(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s5">1 </span><span class="s1">/ var_eff)</span>
        <span class="s1">assert_allclose(np.sqrt(tau2_dl)</span><span class="s3">, </span><span class="s1">t_DL</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-3</span><span class="s1">)</span>

        <span class="s1">tau2_dl_</span><span class="s3">, </span><span class="s1">converged = _fit_tau_iter_mm(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s1">tau2_start=</span><span class="s5">0</span><span class="s3">,</span>
                                               <span class="s1">maxiter=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(converged</span><span class="s3">, False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tau2_dl_</span><span class="s3">, </span><span class="s1">tau2_dl</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># C2 two step, start with CA</span>
        <span class="s1">tau2_c2</span><span class="s3">, </span><span class="s1">converged = _fit_tau_iter_mm(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">,</span>
                                              <span class="s1">tau2_start=tau2_ca</span><span class="s3">,</span>
                                              <span class="s1">maxiter=</span><span class="s5">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(converged</span><span class="s3">, False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.sqrt(tau2_c2)</span><span class="s3">, </span><span class="s1">t_C2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-5</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_pm(self):</span>
        <span class="s1">res = results_meta.exk1_metafor</span>
        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = self.eff</span><span class="s3">, </span><span class="s1">self.var_eff</span>

        <span class="s1">tau2</span><span class="s3">, </span><span class="s1">converged = _fit_tau_iterative(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">,</span>
                                             <span class="s1">tau2_start=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_equal(converged</span><span class="s3">, True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(tau2</span><span class="s3">, </span><span class="s1">res.tau2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># compare with WLS, PM weights</span>
        <span class="s1">mod_wls = WLS(eff</span><span class="s3">, </span><span class="s1">np.ones(len(eff))</span><span class="s3">, </span><span class="s1">weights=</span><span class="s5">1 </span><span class="s1">/ (var_eff + tau2))</span>
        <span class="s1">res_wls = mod_wls.fit(cov_type=</span><span class="s4">&quot;fixed_scale&quot;</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res_wls.params</span><span class="s3">, </span><span class="s1">res.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res_wls.bse</span><span class="s3">, </span><span class="s1">res.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_upp = res_wls.conf_int()[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">assert_allclose(ci_low</span><span class="s3">, </span><span class="s1">res.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci_upp</span><span class="s3">, </span><span class="s1">res.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># need stricter atol to match metafor,</span>
        <span class="s0"># I also used higher precision in metafor</span>
        <span class="s1">res3 = combine_effects(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s1">method_re=</span><span class="s4">&quot;pm&quot;</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-7</span><span class="s1">)</span>
        <span class="s0"># TODO: asserts below are copy paste, DRY?</span>
        <span class="s1">assert_allclose(res3.tau2</span><span class="s3">, </span><span class="s1">res.tau2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.mean_effect_re</span><span class="s3">, </span><span class="s1">res.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.sd_eff_w_re</span><span class="s3">, </span><span class="s1">res.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">ci = res3.conf_int(use_t=</span><span class="s3">False</span><span class="s1">)[</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res3.q</span><span class="s3">, </span><span class="s1">res.QE</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s0"># the following does not pass yet</span>
        <span class="s0"># assert_allclose(res3.i2, res.I2 / 100, atol=1e-10)  # percent in R</span>
        <span class="s0"># assert_allclose(res3.h2, res.H2, atol=1e-10)</span>
        <span class="s1">th = res3.test_homogeneity()</span>
        <span class="s1">q</span><span class="s3">, </span><span class="s1">pv = th</span>
        <span class="s1">df = th.df</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">res.QEp</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(q</span><span class="s3">, </span><span class="s1">res.QE</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df</span><span class="s3">, </span><span class="s5">9 </span><span class="s1">- </span><span class="s5">1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_dl(self):</span>
        <span class="s1">res = results_meta.exk1_dl</span>
        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = self.eff</span><span class="s3">, </span><span class="s1">self.var_eff</span>

        <span class="s1">tau2 = _fit_tau_mm(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s5">1 </span><span class="s1">/ var_eff)</span>
        <span class="s1">assert_allclose(tau2</span><span class="s3">, </span><span class="s1">res.tau2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">res3 = combine_effects(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s1">method_re=</span><span class="s4">&quot;dl&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.tau2</span><span class="s3">, </span><span class="s1">res.tau2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.mean_effect_re</span><span class="s3">, </span><span class="s1">res.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.sd_eff_w_re</span><span class="s3">, </span><span class="s1">res.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">ci = res3.conf_int(use_t=</span><span class="s3">False</span><span class="s1">)  </span><span class="s0"># fe, re, fe_wls, re_wls</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res3.q</span><span class="s3">, </span><span class="s1">res.QE</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s0"># I2 is in percent in metafor</span>
        <span class="s1">assert_allclose(res3.i2</span><span class="s3">, </span><span class="s1">res.I2 / </span><span class="s5">100</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.h2</span><span class="s3">, </span><span class="s1">res.H2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">th = res3.test_homogeneity()</span>
        <span class="s1">q</span><span class="s3">, </span><span class="s1">pv = th</span>
        <span class="s1">df = th.df</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">res.QEp</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(q</span><span class="s3">, </span><span class="s1">res.QE</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df</span><span class="s3">, </span><span class="s5">9 </span><span class="s1">- </span><span class="s5">1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># compare FE estimate</span>
        <span class="s1">res_fe = results_meta.exk1_fe</span>
        <span class="s1">assert_allclose(res3.mean_effect_fe</span><span class="s3">, </span><span class="s1">res_fe.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.sd_eff_w_fe</span><span class="s3">, </span><span class="s1">res_fe.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(ci[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_fe.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_fe.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># compare FE, RE with HKSJ adjustment</span>
        <span class="s1">res_dls = results_meta.exk1_dl_hksj</span>
        <span class="s1">res_fes = results_meta.exk1_fe_hksj</span>

        <span class="s1">assert_allclose(res3.mean_effect_re</span><span class="s3">, </span><span class="s1">res_dls.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.mean_effect_fe</span><span class="s3">, </span><span class="s1">res_fes.b</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res3.sd_eff_w_fe * np.sqrt(res3.scale_hksj_fe)</span><span class="s3">,</span>
                        <span class="s1">res_fes.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res3.sd_eff_w_re * np.sqrt(res3.scale_hksj_re)</span><span class="s3">,</span>
                        <span class="s1">res_dls.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.sqrt(res3.var_hksj_fe)</span><span class="s3">, </span><span class="s1">res_fes.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.sqrt(res3.var_hksj_re)</span><span class="s3">, </span><span class="s1">res_dls.se</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># metafor uses t distribution for hksj</span>
        <span class="s1">ci = res3.conf_int(use_t=</span><span class="s3">True</span><span class="s1">)  </span><span class="s0"># fe, re, fe_wls, re_wls</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_dls.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_dls.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_fes.ci_lb</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_fes.ci_ub</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">th = res3.test_homogeneity()</span>
        <span class="s1">q</span><span class="s3">, </span><span class="s1">pv = th</span>
        <span class="s1">df = th.df</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">res_dls.QEp</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(q</span><span class="s3">, </span><span class="s1">res_dls.QE</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df</span><span class="s3">, </span><span class="s5">9 </span><span class="s1">- </span><span class="s5">1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestMetaBinOR:</span>
    <span class="s0"># testing against results from R package `meta`</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = res2 = results_meta.results_or_dl_hk</span>
        <span class="s1">cls.dta = (res2.event_e</span><span class="s3">, </span><span class="s1">res2.n_e</span><span class="s3">, </span><span class="s1">res2.event_c</span><span class="s3">, </span><span class="s1">res2.n_c)</span>

        <span class="s1">eff</span><span class="s3">, </span><span class="s1">var_eff = effectsize_2proportions(*cls.dta</span><span class="s3">, </span><span class="s1">statistic=</span><span class="s4">&quot;or&quot;</span><span class="s1">)</span>
        <span class="s1">res1 = combine_effects(eff</span><span class="s3">, </span><span class="s1">var_eff</span><span class="s3">, </span><span class="s1">method_re=</span><span class="s4">&quot;chi2&quot;</span><span class="s3">, </span><span class="s1">use_t=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.eff = eff</span>
        <span class="s1">cls.var_eff = var_eff</span>
        <span class="s1">cls.res1 = res1</span>

    <span class="s3">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s1">assert_allclose(self.eff</span><span class="s3">, </span><span class="s1">res2.TE</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(self.var_eff</span><span class="s3">, </span><span class="s1">res2.seTE**</span><span class="s5">2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res1.mean_effect_fe</span><span class="s3">, </span><span class="s1">res2.TE_fixed</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s0"># R meta does not adjust sd FE for HKSJ</span>
        <span class="s1">assert_allclose(res1.sd_eff_w_fe</span><span class="s3">, </span><span class="s1">res2.seTE_fixed</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res1.q</span><span class="s3">, </span><span class="s1">res2.Q</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.tau2</span><span class="s3">, </span><span class="s1">res2.tau2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res1.mean_effect_re</span><span class="s3">, </span><span class="s1">res2.TE_random</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.sd_eff_w_re_hksj</span><span class="s3">, </span><span class="s1">res2.seTE_random</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">th = res1.test_homogeneity()</span>
        <span class="s1">q</span><span class="s3">, </span><span class="s1">pv = th</span>
        <span class="s1">df = th.df</span>
        <span class="s1">assert_allclose(q</span><span class="s3">, </span><span class="s1">res2.Q</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">res2.pval_Q</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df</span><span class="s3">, </span><span class="s1">res2.df_Q</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res1.i2</span><span class="s3">, </span><span class="s1">res2.I2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.h2</span><span class="s3">, </span><span class="s1">res2.H**</span><span class="s5">2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">ci = res1.conf_int(use_t=</span><span class="s3">True</span><span class="s1">)  </span><span class="s0"># fe, re, fe_wls, re_wls</span>
        <span class="s0"># R meta does not adjust FE for HKSJ, still uses normal dist</span>
        <span class="s0"># assert_allclose(ci[0][0], res2.lower_fixed, atol=1e-10)</span>
        <span class="s0"># assert_allclose(ci[0][1], res2.upper_fixed, atol=1e-10)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2.lower_random</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">3</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2.upper_random</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">ci = res1.conf_int(use_t=</span><span class="s3">False</span><span class="s1">)  </span><span class="s0"># fe, re, fe_wls, re_wls</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2.lower_fixed</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ci[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2.upper_fixed</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">weights = </span><span class="s5">1 </span><span class="s1">/ self.var_eff</span>
        <span class="s1">mod_glm = GLM(self.eff</span><span class="s3">, </span><span class="s1">np.ones(len(self.eff))</span><span class="s3">,</span>
                      <span class="s1">var_weights=weights)</span>
        <span class="s1">res_glm = mod_glm.fit()</span>
        <span class="s1">assert_allclose(res_glm.params</span><span class="s3">, </span><span class="s1">res2.TE_fixed</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">weights = </span><span class="s5">1 </span><span class="s1">/ (self.var_eff + res1.tau2)</span>
        <span class="s1">mod_glm = GLM(self.eff</span><span class="s3">, </span><span class="s1">np.ones(len(self.eff))</span><span class="s3">,</span>
                      <span class="s1">var_weights=weights)</span>
        <span class="s1">res_glm = mod_glm.fit()</span>
        <span class="s1">assert_allclose(res_glm.params</span><span class="s3">, </span><span class="s1">res2.TE_random</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s3">def </span><span class="s1">test_plot(self):</span>
        <span class="s0"># smoke tests</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s0"># `use_t=False` avoids warning about missing nobs for use_t is true</span>
        <span class="s1">res1.plot_forest(use_t=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">res1.plot_forest(use_exp=</span><span class="s3">True, </span><span class="s1">use_t=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">res1.plot_forest(alpha=</span><span class="s5">0.01</span><span class="s3">, </span><span class="s1">use_t=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s3">with </span><span class="s1">pytest.raises(TypeError</span><span class="s3">, </span><span class="s1">match=</span><span class="s4">&quot;unexpected keyword&quot;</span><span class="s1">):</span>
            <span class="s1">res1.plot_forest(junk=</span><span class="s5">5</span><span class="s3">, </span><span class="s1">use_t=</span><span class="s3">False</span><span class="s1">)</span>
</pre>
</body>
</html>