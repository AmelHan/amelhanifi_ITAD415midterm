<html>
<head>
<title>test_netcdf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_netcdf.py</font>
</center></td></tr></table>
<pre><span class="s0">''' Tests for netcdf '''</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">from </span><span class="s1">os.path </span><span class="s2">import </span><span class="s1">join </span><span class="s2">as </span><span class="s1">pjoin</span><span class="s2">, </span><span class="s1">dirname</span>
<span class="s2">import </span><span class="s1">shutil</span>
<span class="s2">import </span><span class="s1">tempfile</span>
<span class="s2">import </span><span class="s1">warnings</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">BytesIO</span>
<span class="s2">from </span><span class="s1">glob </span><span class="s2">import </span><span class="s1">glob</span>
<span class="s2">from </span><span class="s1">contextlib </span><span class="s2">import </span><span class="s1">contextmanager</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">(assert_</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">,</span>
                           <span class="s1">break_cycles</span><span class="s2">, </span><span class="s1">suppress_warnings</span><span class="s2">, </span><span class="s1">IS_PYPY)</span>
<span class="s2">from </span><span class="s1">pytest </span><span class="s2">import </span><span class="s1">raises </span><span class="s2">as </span><span class="s1">assert_raises</span>

<span class="s2">from </span><span class="s1">scipy.io </span><span class="s2">import </span><span class="s1">netcdf_file</span>
<span class="s2">from </span><span class="s1">scipy._lib._tmpdirs </span><span class="s2">import </span><span class="s1">in_tempdir</span>

<span class="s1">TEST_DATA_PATH = pjoin(dirname(__file__)</span><span class="s2">, </span><span class="s3">'data'</span><span class="s1">)</span>

<span class="s1">N_EG_ELS = </span><span class="s4">11  </span><span class="s5"># number of elements for example variable</span>
<span class="s1">VARTYPE_EG = </span><span class="s3">'b'  </span><span class="s5"># var type for example variable</span>


<span class="s1">@contextmanager</span>
<span class="s2">def </span><span class="s1">make_simple(*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
    <span class="s1">f = netcdf_file(*args</span><span class="s2">, </span><span class="s1">**kwargs)</span>
    <span class="s1">f.history = </span><span class="s3">'Created for a test'</span>
    <span class="s1">f.createDimension(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s1">N_EG_ELS)</span>
    <span class="s1">time = f.createVariable(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s1">VARTYPE_EG</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'time'</span><span class="s2">,</span><span class="s1">))</span>
    <span class="s1">time[:] = np.arange(N_EG_ELS)</span>
    <span class="s1">time.units = </span><span class="s3">'days since 2008-01-01'</span>
    <span class="s1">f.flush()</span>
    <span class="s2">yield </span><span class="s1">f</span>
    <span class="s1">f.close()</span>


<span class="s2">def </span><span class="s1">check_simple(ncfileobj):</span>
    <span class="s0">'''Example fileobj tests '''</span>
    <span class="s1">assert_equal(ncfileobj.history</span><span class="s2">, </span><span class="s6">b'Created for a test'</span><span class="s1">)</span>
    <span class="s1">time = ncfileobj.variables[</span><span class="s3">'time'</span><span class="s1">]</span>
    <span class="s1">assert_equal(time.units</span><span class="s2">, </span><span class="s6">b'days since 2008-01-01'</span><span class="s1">)</span>
    <span class="s1">assert_equal(time.shape</span><span class="s2">, </span><span class="s1">(N_EG_ELS</span><span class="s2">,</span><span class="s1">))</span>
    <span class="s1">assert_equal(time[-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">N_EG_ELS-</span><span class="s4">1</span><span class="s1">)</span>

<span class="s2">def </span><span class="s1">assert_mask_matches(arr</span><span class="s2">, </span><span class="s1">expected_mask):</span>
    <span class="s0">''' 
    Asserts that the mask of arr is effectively the same as expected_mask. 
 
    In contrast to numpy.ma.testutils.assert_mask_equal, this function allows 
    testing the 'mask' of a standard numpy array (the mask in this case is treated 
    as all False). 
 
    Parameters 
    ---------- 
    arr : ndarray or MaskedArray 
        Array to test. 
    expected_mask : array_like of booleans 
        A list giving the expected mask. 
    '''</span>

    <span class="s1">mask = np.ma.getmaskarray(arr)</span>
    <span class="s1">assert_equal(mask</span><span class="s2">, </span><span class="s1">expected_mask)</span>


<span class="s2">def </span><span class="s1">test_read_write_files():</span>
    <span class="s5"># test round trip for example file</span>
    <span class="s1">cwd = os.getcwd()</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">tmpdir = tempfile.mkdtemp()</span>
        <span class="s1">os.chdir(tmpdir)</span>
        <span class="s2">with </span><span class="s1">make_simple(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s2">pass</span>
        <span class="s5"># read the file we just created in 'a' mode</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">check_simple(f)</span>
            <span class="s5"># add something</span>
            <span class="s1">f._attributes[</span><span class="s3">'appendRan'</span><span class="s1">] = </span><span class="s4">1</span>

        <span class="s5"># To read the NetCDF file we just created::</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'simple.nc'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s5"># Using mmap is the default (but not on pypy)</span>
            <span class="s1">assert_equal(f.use_mmap</span><span class="s2">, not </span><span class="s1">IS_PYPY)</span>
            <span class="s1">check_simple(f)</span>
            <span class="s1">assert_equal(f._attributes[</span><span class="s3">'appendRan'</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s5"># Read it in append (and check mmap is off)</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">f.use_mmap)</span>
            <span class="s1">check_simple(f)</span>
            <span class="s1">assert_equal(f._attributes[</span><span class="s3">'appendRan'</span><span class="s1">]</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s5"># Now without mmap</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">False</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s5"># Using mmap is the default</span>
            <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">f.use_mmap)</span>
            <span class="s1">check_simple(f)</span>

        <span class="s5"># To read the NetCDF file we just created, as file object, no</span>
        <span class="s5"># mmap.  When n * n_bytes(var_type) is not divisible by 4, this</span>
        <span class="s5"># raised an error in pupynere 1.0.12 and scipy rev 5893, because</span>
        <span class="s5"># calculated vsize was rounding up in units of 4 - see</span>
        <span class="s5"># https://www.unidata.ucar.edu/software/netcdf/guide_toc.html</span>
        <span class="s2">with </span><span class="s1">open(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">fobj:</span>
            <span class="s2">with </span><span class="s1">netcdf_file(fobj) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s5"># by default, don't use mmap for file-like</span>
                <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">f.use_mmap)</span>
                <span class="s1">check_simple(f)</span>

        <span class="s5"># Read file from fileobj, with mmap</span>
        <span class="s2">with </span><span class="s1">suppress_warnings() </span><span class="s2">as </span><span class="s1">sup:</span>
            <span class="s2">if </span><span class="s1">IS_PYPY:</span>
                <span class="s1">sup.filter(RuntimeWarning</span><span class="s2">,</span>
                           <span class="s3">&quot;Cannot close a netcdf_file opened with mmap=True.*&quot;</span><span class="s1">)</span>
            <span class="s2">with </span><span class="s1">open(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'rb'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">fobj:</span>
                <span class="s2">with </span><span class="s1">netcdf_file(fobj</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                    <span class="s1">assert_(f.use_mmap)</span>
                    <span class="s1">check_simple(f)</span>

        <span class="s5"># Again read it in append mode (adding another att)</span>
        <span class="s2">with </span><span class="s1">open(</span><span class="s3">'simple.nc'</span><span class="s2">, </span><span class="s3">'r+b'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">fobj:</span>
            <span class="s2">with </span><span class="s1">netcdf_file(fobj</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">f.use_mmap)</span>
                <span class="s1">check_simple(f)</span>
                <span class="s1">f.createDimension(</span><span class="s3">'app_dim'</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
                <span class="s1">var = f.createVariable(</span><span class="s3">'app_var'</span><span class="s2">, </span><span class="s3">'i'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'app_dim'</span><span class="s2">,</span><span class="s1">))</span>
                <span class="s1">var[:] = </span><span class="s4">42</span>

        <span class="s5"># And... check that app_var made it in...</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'simple.nc'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">check_simple(f)</span>
            <span class="s1">assert_equal(f.variables[</span><span class="s3">'app_var'</span><span class="s1">][:]</span><span class="s2">, </span><span class="s4">42</span><span class="s1">)</span>

    <span class="s2">finally</span><span class="s1">:</span>
        <span class="s2">if </span><span class="s1">IS_PYPY:</span>
            <span class="s5"># windows cannot remove a dead file held by a mmap</span>
            <span class="s5"># that has not been collected in PyPy</span>
            <span class="s1">break_cycles()</span>
            <span class="s1">break_cycles()</span>
        <span class="s1">os.chdir(cwd)</span>
        <span class="s1">shutil.rmtree(tmpdir)</span>


<span class="s2">def </span><span class="s1">test_read_write_sio():</span>
    <span class="s1">eg_sio1 = BytesIO()</span>
    <span class="s2">with </span><span class="s1">make_simple(eg_sio1</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">):</span>
        <span class="s1">str_val = eg_sio1.getvalue()</span>

    <span class="s1">eg_sio2 = BytesIO(str_val)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(eg_sio2) </span><span class="s2">as </span><span class="s1">f2:</span>
        <span class="s1">check_simple(f2)</span>

    <span class="s5"># Test that error is raised if attempting mmap for sio</span>
    <span class="s1">eg_sio3 = BytesIO(str_val)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">netcdf_file</span><span class="s2">, </span><span class="s1">eg_sio3</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s5"># Test 64-bit offset write / read</span>
    <span class="s1">eg_sio_64 = BytesIO()</span>
    <span class="s2">with </span><span class="s1">make_simple(eg_sio_64</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">, </span><span class="s1">version=</span><span class="s4">2</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f_64:</span>
        <span class="s1">str_val = eg_sio_64.getvalue()</span>

    <span class="s1">eg_sio_64 = BytesIO(str_val)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(eg_sio_64) </span><span class="s2">as </span><span class="s1">f_64:</span>
        <span class="s1">check_simple(f_64)</span>
        <span class="s1">assert_equal(f_64.version_byte</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s5"># also when version 2 explicitly specified</span>
    <span class="s1">eg_sio_64 = BytesIO(str_val)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(eg_sio_64</span><span class="s2">, </span><span class="s1">version=</span><span class="s4">2</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f_64:</span>
        <span class="s1">check_simple(f_64)</span>
        <span class="s1">assert_equal(f_64.version_byte</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_bytes():</span>
    <span class="s1">raw_file = BytesIO()</span>
    <span class="s1">f = netcdf_file(raw_file</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">)</span>
    <span class="s5"># Dataset only has a single variable, dimension and attribute to avoid</span>
    <span class="s5"># any ambiguity related to order.</span>
    <span class="s1">f.a = </span><span class="s3">'b'</span>
    <span class="s1">f.createDimension(</span><span class="s3">'dim'</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">var = f.createVariable(</span><span class="s3">'var'</span><span class="s2">, </span><span class="s1">np.int16</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'dim'</span><span class="s2">,</span><span class="s1">))</span>
    <span class="s1">var[</span><span class="s4">0</span><span class="s1">] = -</span><span class="s4">9999</span>
    <span class="s1">var.c = </span><span class="s3">'d'</span>
    <span class="s1">f.sync()</span>

    <span class="s1">actual = raw_file.getvalue()</span>

    <span class="s1">expected = (</span><span class="s6">b'CDF</span><span class="s2">\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x0a</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s6">'</span>
                <span class="s6">b'dim</span><span class="s2">\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x0c</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'a</span><span class="s2">\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x02</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'b</span><span class="s2">\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x0b</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s6">'</span>
                <span class="s6">b'var</span><span class="s2">\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x0c</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'c</span><span class="s2">\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x02</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x01</span><span class="s6">'</span>
                <span class="s6">b'd</span><span class="s2">\x00\x00\x00</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x03</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x04</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\x00\x00\x00\x78</span><span class="s6">'</span>
                <span class="s6">b'</span><span class="s2">\xd8\xf1\x80\x01</span><span class="s6">'</span><span class="s1">)</span>

    <span class="s1">assert_equal(actual</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s2">def </span><span class="s1">test_encoded_fill_value():</span>
    <span class="s2">with </span><span class="s1">netcdf_file(BytesIO()</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.createDimension(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">var = f.createVariable(</span><span class="s3">'var'</span><span class="s2">, </span><span class="s3">'S1'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(var._get_encoded_fill_value()</span><span class="s2">, </span><span class="s6">b'</span><span class="s2">\x00</span><span class="s6">'</span><span class="s1">)</span>
        <span class="s1">var._FillValue = </span><span class="s6">b'</span><span class="s2">\x01</span><span class="s6">'</span>
        <span class="s1">assert_equal(var._get_encoded_fill_value()</span><span class="s2">, </span><span class="s6">b'</span><span class="s2">\x01</span><span class="s6">'</span><span class="s1">)</span>
        <span class="s1">var._FillValue = </span><span class="s6">b'</span><span class="s2">\x00\x00</span><span class="s6">'  </span><span class="s5"># invalid, wrong size</span>
        <span class="s1">assert_equal(var._get_encoded_fill_value()</span><span class="s2">, </span><span class="s6">b'</span><span class="s2">\x00</span><span class="s6">'</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_read_example_data():</span>
    <span class="s5"># read any example data files</span>
    <span class="s2">for </span><span class="s1">fname </span><span class="s2">in </span><span class="s1">glob(pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'*.nc'</span><span class="s1">)):</span>
        <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s3">'r'</span><span class="s1">):</span>
            <span class="s2">pass</span>
        <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">False</span><span class="s1">):</span>
            <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">test_itemset_no_segfault_on_readonly():</span>
    <span class="s5"># Regression test for ticket #1202.</span>
    <span class="s5"># Open the test file in read-only mode.</span>

    <span class="s1">filename = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_1.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">suppress_warnings() </span><span class="s2">as </span><span class="s1">sup:</span>
        <span class="s1">sup.filter(RuntimeWarning</span><span class="s2">,</span>
                   <span class="s3">&quot;Cannot close a netcdf_file opened with mmap=True, when netcdf_variables or arrays referring to its data still exist&quot;</span><span class="s1">)</span>
        <span class="s2">with </span><span class="s1">netcdf_file(filename</span><span class="s2">, </span><span class="s3">'r'</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">time_var = f.variables[</span><span class="s3">'time'</span><span class="s1">]</span>

    <span class="s5"># time_var.assignValue(42) should raise a RuntimeError--not seg. fault!</span>
    <span class="s1">assert_raises(RuntimeError</span><span class="s2">, </span><span class="s1">time_var.assignValue</span><span class="s2">, </span><span class="s4">42</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_appending_issue_gh_8625():</span>
    <span class="s1">stream = BytesIO()</span>

    <span class="s2">with </span><span class="s1">make_simple(stream</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.createDimension(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">f.createVariable(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">f.variables[</span><span class="s3">'x'</span><span class="s1">][...] = </span><span class="s4">1</span>
        <span class="s1">f.flush()</span>
        <span class="s1">contents = stream.getvalue()</span>

    <span class="s1">stream = BytesIO(contents)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(stream</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.variables[</span><span class="s3">'x'</span><span class="s1">][...] = </span><span class="s4">2</span>


<span class="s2">def </span><span class="s1">test_write_invalid_dtype():</span>
    <span class="s1">dtypes = [</span><span class="s3">'int64'</span><span class="s2">, </span><span class="s3">'uint64'</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">np.dtype(</span><span class="s3">'int'</span><span class="s1">).itemsize == </span><span class="s4">8</span><span class="s1">:   </span><span class="s5"># 64-bit machines</span>
        <span class="s1">dtypes.append(</span><span class="s3">'int'</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">np.dtype(</span><span class="s3">'uint'</span><span class="s1">).itemsize == </span><span class="s4">8</span><span class="s1">:   </span><span class="s5"># 64-bit machines</span>
        <span class="s1">dtypes.append(</span><span class="s3">'uint'</span><span class="s1">)</span>

    <span class="s2">with </span><span class="s1">netcdf_file(BytesIO()</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.createDimension(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s1">N_EG_ELS)</span>
        <span class="s2">for </span><span class="s1">dt </span><span class="s2">in </span><span class="s1">dtypes:</span>
            <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">f.createVariable</span><span class="s2">, </span><span class="s3">'time'</span><span class="s2">, </span><span class="s1">dt</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'time'</span><span class="s2">,</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">test_flush_rewind():</span>
    <span class="s1">stream = BytesIO()</span>
    <span class="s2">with </span><span class="s1">make_simple(stream</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.createDimension(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s4">4</span><span class="s1">)  </span><span class="s5"># x is used in createVariable</span>
        <span class="s1">v = f.createVariable(</span><span class="s3">'v'</span><span class="s2">, </span><span class="s3">'i2'</span><span class="s2">, </span><span class="s1">[</span><span class="s3">'x'</span><span class="s1">])</span>
        <span class="s1">v[:] = </span><span class="s4">1</span>
        <span class="s1">f.flush()</span>
        <span class="s1">len_single = len(stream.getvalue())</span>
        <span class="s1">f.flush()</span>
        <span class="s1">len_double = len(stream.getvalue())</span>

    <span class="s1">assert_(len_single == len_double)</span>


<span class="s2">def </span><span class="s1">test_dtype_specifiers():</span>
    <span class="s5"># Numpy 1.7.0-dev had a bug where 'i2' wouldn't work.</span>
    <span class="s5"># Specifying np.int16 or similar only works from the same commit as this</span>
    <span class="s5"># comment was made.</span>
    <span class="s2">with </span><span class="s1">make_simple(BytesIO()</span><span class="s2">, </span><span class="s1">mode=</span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.createDimension(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">f.createVariable(</span><span class="s3">'v1'</span><span class="s2">, </span><span class="s3">'i2'</span><span class="s2">, </span><span class="s1">[</span><span class="s3">'x'</span><span class="s1">])</span>
        <span class="s1">f.createVariable(</span><span class="s3">'v2'</span><span class="s2">, </span><span class="s1">np.int16</span><span class="s2">, </span><span class="s1">[</span><span class="s3">'x'</span><span class="s1">])</span>
        <span class="s1">f.createVariable(</span><span class="s3">'v3'</span><span class="s2">, </span><span class="s1">np.dtype(np.int16)</span><span class="s2">, </span><span class="s1">[</span><span class="s3">'x'</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_ticket_1720():</span>
    <span class="s1">io = BytesIO()</span>

    <span class="s1">items = [</span><span class="s4">0</span><span class="s2">,</span><span class="s4">0.1</span><span class="s2">,</span><span class="s4">0.2</span><span class="s2">,</span><span class="s4">0.3</span><span class="s2">,</span><span class="s4">0.4</span><span class="s2">,</span><span class="s4">0.5</span><span class="s2">,</span><span class="s4">0.6</span><span class="s2">,</span><span class="s4">0.7</span><span class="s2">,</span><span class="s4">0.8</span><span class="s2">,</span><span class="s4">0.9</span><span class="s1">]</span>

    <span class="s2">with </span><span class="s1">netcdf_file(io</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.history = </span><span class="s3">'Created for a test'</span>
        <span class="s1">f.createDimension(</span><span class="s3">'float_var'</span><span class="s2">, </span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">float_var = f.createVariable(</span><span class="s3">'float_var'</span><span class="s2">, </span><span class="s3">'f'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'float_var'</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">float_var[:] = items</span>
        <span class="s1">float_var.units = </span><span class="s3">'metres'</span>
        <span class="s1">f.flush()</span>
        <span class="s1">contents = io.getvalue()</span>

    <span class="s1">io = BytesIO(contents)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(io</span><span class="s2">, </span><span class="s3">'r'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">assert_equal(f.history</span><span class="s2">, </span><span class="s6">b'Created for a test'</span><span class="s1">)</span>
        <span class="s1">float_var = f.variables[</span><span class="s3">'float_var'</span><span class="s1">]</span>
        <span class="s1">assert_equal(float_var.units</span><span class="s2">, </span><span class="s6">b'metres'</span><span class="s1">)</span>
        <span class="s1">assert_equal(float_var.shape</span><span class="s2">, </span><span class="s1">(</span><span class="s4">10</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">assert_allclose(float_var[:]</span><span class="s2">, </span><span class="s1">items)</span>


<span class="s2">def </span><span class="s1">test_mmaps_segfault():</span>
    <span class="s1">filename = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_1.nc'</span><span class="s1">)</span>

    <span class="s2">if not </span><span class="s1">IS_PYPY:</span>
        <span class="s2">with </span><span class="s1">warnings.catch_warnings():</span>
            <span class="s1">warnings.simplefilter(</span><span class="s3">&quot;error&quot;</span><span class="s1">)</span>
            <span class="s2">with </span><span class="s1">netcdf_file(filename</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">x = f.variables[</span><span class="s3">'lat'</span><span class="s1">][:]</span>
                <span class="s5"># should not raise warnings</span>
                <span class="s2">del </span><span class="s1">x</span>

    <span class="s2">def </span><span class="s1">doit():</span>
        <span class="s2">with </span><span class="s1">netcdf_file(filename</span><span class="s2">, </span><span class="s1">mmap=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s2">return </span><span class="s1">f.variables[</span><span class="s3">'lat'</span><span class="s1">][:]</span>

    <span class="s5"># should not crash</span>
    <span class="s2">with </span><span class="s1">suppress_warnings() </span><span class="s2">as </span><span class="s1">sup:</span>
        <span class="s1">sup.filter(RuntimeWarning</span><span class="s2">,</span>
                   <span class="s3">&quot;Cannot close a netcdf_file opened with mmap=True, when netcdf_variables or arrays referring to its data still exist&quot;</span><span class="s1">)</span>
        <span class="s1">x = doit()</span>
    <span class="s1">x.sum()</span>


<span class="s2">def </span><span class="s1">test_zero_dimensional_var():</span>
    <span class="s1">io = BytesIO()</span>
    <span class="s2">with </span><span class="s1">make_simple(io</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">v = f.createVariable(</span><span class="s3">'zerodim'</span><span class="s2">, </span><span class="s3">'i2'</span><span class="s2">, </span><span class="s1">[])</span>
        <span class="s5"># This is checking that .isrec returns a boolean - don't simplify it</span>
        <span class="s5"># to 'assert not ...'</span>
        <span class="s2">assert </span><span class="s1">v.isrec </span><span class="s2">is False, </span><span class="s1">v.isrec</span>
        <span class="s1">f.flush()</span>


<span class="s2">def </span><span class="s1">test_byte_gatts():</span>
    <span class="s5"># Check that global &quot;string&quot; atts work like they did before py3k</span>
    <span class="s5"># unicode and general bytes confusion</span>
    <span class="s2">with </span><span class="s1">in_tempdir():</span>
        <span class="s1">filename = </span><span class="s3">'g_byte_atts.nc'</span>
        <span class="s1">f = netcdf_file(filename</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">)</span>
        <span class="s1">f._attributes[</span><span class="s3">'holy'</span><span class="s1">] = </span><span class="s6">b'grail'</span>
        <span class="s1">f._attributes[</span><span class="s3">'witch'</span><span class="s1">] = </span><span class="s3">'floats'</span>
        <span class="s1">f.close()</span>
        <span class="s1">f = netcdf_file(filename</span><span class="s2">, </span><span class="s3">'r'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f._attributes[</span><span class="s3">'holy'</span><span class="s1">]</span><span class="s2">, </span><span class="s6">b'grail'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f._attributes[</span><span class="s3">'witch'</span><span class="s1">]</span><span class="s2">, </span><span class="s6">b'floats'</span><span class="s1">)</span>
        <span class="s1">f.close()</span>


<span class="s2">def </span><span class="s1">test_open_append():</span>
    <span class="s5"># open 'w' put one attr</span>
    <span class="s2">with </span><span class="s1">in_tempdir():</span>
        <span class="s1">filename = </span><span class="s3">'append_dat.nc'</span>
        <span class="s1">f = netcdf_file(filename</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">)</span>
        <span class="s1">f._attributes[</span><span class="s3">'Kilroy'</span><span class="s1">] = </span><span class="s3">'was here'</span>
        <span class="s1">f.close()</span>

        <span class="s5"># open again in 'a', read the att and a new one</span>
        <span class="s1">f = netcdf_file(filename</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f._attributes[</span><span class="s3">'Kilroy'</span><span class="s1">]</span><span class="s2">, </span><span class="s6">b'was here'</span><span class="s1">)</span>
        <span class="s1">f._attributes[</span><span class="s3">'naughty'</span><span class="s1">] = </span><span class="s6">b'Zoot'</span>
        <span class="s1">f.close()</span>

        <span class="s5"># open yet again in 'r' and check both atts</span>
        <span class="s1">f = netcdf_file(filename</span><span class="s2">, </span><span class="s3">'r'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f._attributes[</span><span class="s3">'Kilroy'</span><span class="s1">]</span><span class="s2">, </span><span class="s6">b'was here'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f._attributes[</span><span class="s3">'naughty'</span><span class="s1">]</span><span class="s2">, </span><span class="s6">b'Zoot'</span><span class="s1">)</span>
        <span class="s1">f.close()</span>


<span class="s2">def </span><span class="s1">test_append_recordDimension():</span>
    <span class="s1">dataSize = </span><span class="s4">100</span>

    <span class="s2">with </span><span class="s1">in_tempdir():</span>
        <span class="s5"># Create file with record time dimension</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'withRecordDimension.nc'</span><span class="s2">, </span><span class="s3">'w'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">f.createDimension(</span><span class="s3">'time'</span><span class="s2">, None</span><span class="s1">)</span>
            <span class="s1">f.createVariable(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s3">'d'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'time'</span><span class="s2">,</span><span class="s1">))</span>
            <span class="s1">f.createDimension(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s1">dataSize)</span>
            <span class="s1">x = f.createVariable(</span><span class="s3">'x'</span><span class="s2">, </span><span class="s3">'d'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'x'</span><span class="s2">,</span><span class="s1">))</span>
            <span class="s1">x[:] = np.array(range(dataSize))</span>
            <span class="s1">f.createDimension(</span><span class="s3">'y'</span><span class="s2">, </span><span class="s1">dataSize)</span>
            <span class="s1">y = f.createVariable(</span><span class="s3">'y'</span><span class="s2">, </span><span class="s3">'d'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'y'</span><span class="s2">,</span><span class="s1">))</span>
            <span class="s1">y[:] = np.array(range(dataSize))</span>
            <span class="s1">f.createVariable(</span><span class="s3">'testData'</span><span class="s2">, </span><span class="s3">'i'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'time'</span><span class="s2">, </span><span class="s3">'x'</span><span class="s2">, </span><span class="s3">'y'</span><span class="s1">))</span>
            <span class="s1">f.flush()</span>
            <span class="s1">f.close()</span>

        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s1">):</span>
            <span class="s5"># Open the file in append mode and add data</span>
            <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'withRecordDimension.nc'</span><span class="s2">, </span><span class="s3">'a'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">f.variables[</span><span class="s3">'time'</span><span class="s1">].data = np.append(f.variables[</span><span class="s3">&quot;time&quot;</span><span class="s1">].data</span><span class="s2">, </span><span class="s1">i)</span>
                <span class="s1">f.variables[</span><span class="s3">'testData'</span><span class="s1">][i</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:] = np.full((dataSize</span><span class="s2">, </span><span class="s1">dataSize)</span><span class="s2">, </span><span class="s1">i)</span>
                <span class="s1">f.flush()</span>

            <span class="s5"># Read the file and check that append worked</span>
            <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'withRecordDimension.nc'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">assert_equal(f.variables[</span><span class="s3">'time'</span><span class="s1">][-</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">i)</span>
                <span class="s1">assert_equal(f.variables[</span><span class="s3">'testData'</span><span class="s1">][-</span><span class="s4">1</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:].copy()</span><span class="s2">, </span><span class="s1">np.full((dataSize</span><span class="s2">, </span><span class="s1">dataSize)</span><span class="s2">, </span><span class="s1">i))</span>
                <span class="s1">assert_equal(f.variables[</span><span class="s3">'time'</span><span class="s1">].data.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">i+</span><span class="s4">1</span><span class="s1">)</span>
                <span class="s1">assert_equal(f.variables[</span><span class="s3">'testData'</span><span class="s1">].data.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">i+</span><span class="s4">1</span><span class="s1">)</span>

        <span class="s5"># Read the file and check that 'data' was not saved as user defined</span>
        <span class="s5"># attribute of testData variable during append operation</span>
        <span class="s2">with </span><span class="s1">netcdf_file(</span><span class="s3">'withRecordDimension.nc'</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s2">with </span><span class="s1">assert_raises(KeyError) </span><span class="s2">as </span><span class="s1">ar:</span>
                <span class="s1">f.variables[</span><span class="s3">'testData'</span><span class="s1">]._attributes[</span><span class="s3">'data'</span><span class="s1">]</span>
            <span class="s1">ex = ar.value</span>
            <span class="s1">assert_equal(ex.args[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s3">'data'</span><span class="s1">)</span>

<span class="s2">def </span><span class="s1">test_maskandscale():</span>
    <span class="s1">t = np.linspace(</span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span><span class="s2">, </span><span class="s4">15</span><span class="s1">)</span>
    <span class="s1">t[</span><span class="s4">3</span><span class="s1">] = </span><span class="s4">100</span>
    <span class="s1">tm = np.ma.masked_greater(t</span><span class="s2">, </span><span class="s4">99</span><span class="s1">)</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_2.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">Temp = f.variables[</span><span class="s3">'Temperature'</span><span class="s1">]</span>
        <span class="s1">assert_equal(Temp.missing_value</span><span class="s2">, </span><span class="s4">9999</span><span class="s1">)</span>
        <span class="s1">assert_equal(Temp.add_offset</span><span class="s2">, </span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">assert_equal(Temp.scale_factor</span><span class="s2">, </span><span class="s1">np.float32(</span><span class="s4">0.01</span><span class="s1">))</span>
        <span class="s1">found = Temp[:].compressed()</span>
        <span class="s2">del </span><span class="s1">Temp  </span><span class="s5"># Remove ref to mmap, so file can be closed.</span>
        <span class="s1">expected = np.round(tm.compressed()</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(found</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">with </span><span class="s1">in_tempdir():</span>
        <span class="s1">newfname = </span><span class="s3">'ms.nc'</span>
        <span class="s1">f = netcdf_file(newfname</span><span class="s2">, </span><span class="s3">'w'</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">f.createDimension(</span><span class="s3">'Temperature'</span><span class="s2">, </span><span class="s1">len(tm))</span>
        <span class="s1">temp = f.createVariable(</span><span class="s3">'Temperature'</span><span class="s2">, </span><span class="s3">'i'</span><span class="s2">, </span><span class="s1">(</span><span class="s3">'Temperature'</span><span class="s2">,</span><span class="s1">))</span>
        <span class="s1">temp.missing_value = </span><span class="s4">9999</span>
        <span class="s1">temp.scale_factor = </span><span class="s4">0.01</span>
        <span class="s1">temp.add_offset = </span><span class="s4">20</span>
        <span class="s1">temp[:] = tm</span>
        <span class="s1">f.close()</span>

        <span class="s2">with </span><span class="s1">netcdf_file(newfname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">Temp = f.variables[</span><span class="s3">'Temperature'</span><span class="s1">]</span>
            <span class="s1">assert_equal(Temp.missing_value</span><span class="s2">, </span><span class="s4">9999</span><span class="s1">)</span>
            <span class="s1">assert_equal(Temp.add_offset</span><span class="s2">, </span><span class="s4">20</span><span class="s1">)</span>
            <span class="s1">assert_equal(Temp.scale_factor</span><span class="s2">, </span><span class="s1">np.float32(</span><span class="s4">0.01</span><span class="s1">))</span>
            <span class="s1">expected = np.round(tm.compressed()</span><span class="s2">, </span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">found = Temp[:].compressed()</span>
            <span class="s2">del </span><span class="s1">Temp</span>
            <span class="s1">assert_allclose(found</span><span class="s2">, </span><span class="s1">expected)</span>


<span class="s5"># ------------------------------------------------------------------------</span>
<span class="s5"># Test reading with masked values (_FillValue / missing_value)</span>
<span class="s5"># ------------------------------------------------------------------------</span>

<span class="s2">def </span><span class="s1">test_read_withValuesNearFillValue():</span>
    <span class="s5"># Regression test for ticket #5626</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var1_fillval0'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True, False</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_withNoFillValue():</span>
    <span class="s5"># For a variable with no fill value, reading data with maskandscale=True</span>
    <span class="s5"># should return unmasked data</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var2_noFillval'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">,</span><span class="s4">2</span><span class="s2">,</span><span class="s4">3</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_withFillValueAndMissingValue():</span>
    <span class="s5"># For a variable with both _FillValue and missing_value, the _FillValue</span>
    <span class="s5"># should be used</span>
    <span class="s1">IRRELEVANT_VALUE = </span><span class="s4">9999</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var3_fillvalAndMissingValue'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(vardata</span><span class="s2">, </span><span class="s1">[IRRELEVANT_VALUE</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_withMissingValue():</span>
    <span class="s5"># For a variable with missing_value but not _FillValue, the missing_value</span>
    <span class="s5"># should be used</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var4_missingValue'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True, False</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_withFillValNaN():</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var5_fillvalNaN'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True, False</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_withChar():</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var6_char'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True, False</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_read_with2dVar():</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">True</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var7_2d'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[[</span><span class="s2">True, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True</span><span class="s1">]])</span>

<span class="s2">def </span><span class="s1">test_read_withMaskAndScaleFalse():</span>
    <span class="s5"># If a variable has a _FillValue (or missing_value) attribute, but is read</span>
    <span class="s5"># with maskandscale set to False, the result should be unmasked</span>
    <span class="s1">fname = pjoin(TEST_DATA_PATH</span><span class="s2">, </span><span class="s3">'example_3_maskedvals.nc'</span><span class="s1">)</span>
    <span class="s5"># Open file with mmap=False to avoid problems with closing a mmap'ed file</span>
    <span class="s5"># when arrays referring to its data still exist:</span>
    <span class="s2">with </span><span class="s1">netcdf_file(fname</span><span class="s2">, </span><span class="s1">maskandscale=</span><span class="s2">False, </span><span class="s1">mmap=</span><span class="s2">False</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">vardata = f.variables[</span><span class="s3">'var3_fillvalAndMissingValue'</span><span class="s1">][:]</span>
        <span class="s1">assert_mask_matches(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, False, False</span><span class="s1">])</span>
        <span class="s1">assert_equal(vardata</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
</pre>
</body>
</html>