<html>
<head>
<title>test_openml.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_openml.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;Test the openml loader.&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">gzip</span>
<span class="s2">import </span><span class="s1">json</span>
<span class="s2">import </span><span class="s1">os</span>
<span class="s2">import </span><span class="s1">re</span>
<span class="s2">from </span><span class="s1">functools </span><span class="s2">import </span><span class="s1">partial</span>
<span class="s2">from </span><span class="s1">io </span><span class="s2">import </span><span class="s1">BytesIO</span>
<span class="s2">from </span><span class="s1">urllib.error </span><span class="s2">import </span><span class="s1">HTTPError</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">scipy.sparse</span>

<span class="s2">import </span><span class="s1">sklearn</span>
<span class="s2">from </span><span class="s1">sklearn </span><span class="s2">import </span><span class="s1">config_context</span>
<span class="s2">from </span><span class="s1">sklearn.datasets </span><span class="s2">import </span><span class="s1">fetch_openml </span><span class="s2">as </span><span class="s1">fetch_openml_orig</span>
<span class="s2">from </span><span class="s1">sklearn.datasets._openml </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">_OPENML_PREFIX</span><span class="s2">,</span>
    <span class="s1">_get_local_path</span><span class="s2">,</span>
    <span class="s1">_open_openml_url</span><span class="s2">,</span>
    <span class="s1">_retry_with_clean_cache</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">sklearn.utils </span><span class="s2">import </span><span class="s1">Bunch</span><span class="s2">, </span><span class="s1">check_pandas_support</span>
<span class="s2">from </span><span class="s1">sklearn.utils._testing </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">SkipTest</span><span class="s2">,</span>
    <span class="s1">assert_allclose</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">fails_if_pypy</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">sklearn.utils.fixes </span><span class="s2">import </span><span class="s1">_open_binary</span>

<span class="s1">OPENML_TEST_DATA_MODULE = </span><span class="s3">&quot;sklearn.datasets.tests.data.openml&quot;</span>
<span class="s4"># if True, urlopen will be monkey patched to only use local files</span>
<span class="s1">test_offline = </span><span class="s2">True</span>


<span class="s2">class </span><span class="s1">_MockHTTPResponse:</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">is_gzip):</span>
        <span class="s1">self.data = data</span>
        <span class="s1">self.is_gzip = is_gzip</span>

    <span class="s2">def </span><span class="s1">read(self</span><span class="s2">, </span><span class="s1">amt=-</span><span class="s5">1</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">self.data.read(amt)</span>

    <span class="s2">def </span><span class="s1">close(self):</span>
        <span class="s1">self.data.close()</span>

    <span class="s2">def </span><span class="s1">info(self):</span>
        <span class="s2">if </span><span class="s1">self.is_gzip:</span>
            <span class="s2">return </span><span class="s1">{</span><span class="s3">&quot;Content-Encoding&quot;</span><span class="s1">: </span><span class="s3">&quot;gzip&quot;</span><span class="s1">}</span>
        <span class="s2">return </span><span class="s1">{}</span>

    <span class="s2">def </span><span class="s1">__iter__(self):</span>
        <span class="s2">return </span><span class="s1">iter(self.data)</span>

    <span class="s2">def </span><span class="s1">__enter__(self):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">__exit__(self</span><span class="s2">, </span><span class="s1">exc_type</span><span class="s2">, </span><span class="s1">exc_val</span><span class="s2">, </span><span class="s1">exc_tb):</span>
        <span class="s2">return False</span>


<span class="s4"># Disable the disk-based cache when testing `fetch_openml`:</span>
<span class="s4"># the mock data in sklearn/datasets/tests/data/openml/ is not always consistent</span>
<span class="s4"># with the version on openml.org. If one were to load the dataset outside of</span>
<span class="s4"># the tests, it may result in data that does not represent openml.org.</span>
<span class="s1">fetch_openml = partial(fetch_openml_orig</span><span class="s2">, </span><span class="s1">data_home=</span><span class="s2">None</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">_monkey_patch_webbased_functions(context</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s4"># monkey patches the urlopen function. Important note: Do NOT use this</span>
    <span class="s4"># in combination with a regular cache directory, as the files that are</span>
    <span class="s4"># stored as cache should not be mixed up with real openml datasets</span>
    <span class="s1">url_prefix_data_description = </span><span class="s3">&quot;https://api.openml.org/api/v1/json/data/&quot;</span>
    <span class="s1">url_prefix_data_features = </span><span class="s3">&quot;https://api.openml.org/api/v1/json/data/features/&quot;</span>
    <span class="s1">url_prefix_download_data = </span><span class="s3">&quot;https://api.openml.org/data/v1/&quot;</span>
    <span class="s1">url_prefix_data_list = </span><span class="s3">&quot;https://api.openml.org/api/v1/json/data/list/&quot;</span>

    <span class="s1">path_suffix = </span><span class="s3">&quot;.gz&quot;</span>
    <span class="s1">read_fn = gzip.open</span>

    <span class="s1">data_module = OPENML_TEST_DATA_MODULE + </span><span class="s3">&quot;.&quot; </span><span class="s1">+ </span><span class="s3">f&quot;id_</span><span class="s2">{</span><span class="s1">data_id</span><span class="s2">}</span><span class="s3">&quot;</span>

    <span class="s2">def </span><span class="s1">_file_name(url</span><span class="s2">, </span><span class="s1">suffix):</span>
        <span class="s1">output = (</span>
            <span class="s1">re.sub(</span><span class="s3">r&quot;\W&quot;</span><span class="s2">, </span><span class="s3">&quot;-&quot;</span><span class="s2">, </span><span class="s1">url[len(</span><span class="s3">&quot;https://api.openml.org/&quot;</span><span class="s1">) :])</span>
            <span class="s1">+ suffix</span>
            <span class="s1">+ path_suffix</span>
        <span class="s1">)</span>
        <span class="s4"># Shorten the filenames to have better compatibility with windows 10</span>
        <span class="s4"># and filenames &gt; 260 characters</span>
        <span class="s2">return </span><span class="s1">(</span>
            <span class="s1">output.replace(</span><span class="s3">&quot;-json-data-list&quot;</span><span class="s2">, </span><span class="s3">&quot;-jdl&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-json-data-features&quot;</span><span class="s2">, </span><span class="s3">&quot;-jdf&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-json-data-qualities&quot;</span><span class="s2">, </span><span class="s3">&quot;-jdq&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-json-data&quot;</span><span class="s2">, </span><span class="s3">&quot;-jd&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-data_name&quot;</span><span class="s2">, </span><span class="s3">&quot;-dn&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-download&quot;</span><span class="s2">, </span><span class="s3">&quot;-dl&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-limit&quot;</span><span class="s2">, </span><span class="s3">&quot;-l&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-data_version&quot;</span><span class="s2">, </span><span class="s3">&quot;-dv&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-status&quot;</span><span class="s2">, </span><span class="s3">&quot;-s&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-deactivated&quot;</span><span class="s2">, </span><span class="s3">&quot;-dact&quot;</span><span class="s1">)</span>
            <span class="s1">.replace(</span><span class="s3">&quot;-active&quot;</span><span class="s2">, </span><span class="s3">&quot;-act&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_shared(url</span><span class="s2">, </span><span class="s1">has_gzip_header</span><span class="s2">, </span><span class="s1">expected_prefix</span><span class="s2">, </span><span class="s1">suffix):</span>
        <span class="s2">assert </span><span class="s1">url.startswith(expected_prefix)</span>

        <span class="s1">data_file_name = _file_name(url</span><span class="s2">, </span><span class="s1">suffix)</span>

        <span class="s2">with </span><span class="s1">_open_binary(data_module</span><span class="s2">, </span><span class="s1">data_file_name) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s2">if </span><span class="s1">has_gzip_header </span><span class="s2">and </span><span class="s1">gzip_response:</span>
                <span class="s1">fp = BytesIO(f.read())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse(fp</span><span class="s2">, True</span><span class="s1">)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">decompressed_f = read_fn(f</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">)</span>
                <span class="s1">fp = BytesIO(decompressed_f.read())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse(fp</span><span class="s2">, False</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_description(url</span><span class="s2">, </span><span class="s1">has_gzip_header):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared(</span>
            <span class="s1">url=url</span><span class="s2">,</span>
            <span class="s1">has_gzip_header=has_gzip_header</span><span class="s2">,</span>
            <span class="s1">expected_prefix=url_prefix_data_description</span><span class="s2">,</span>
            <span class="s1">suffix=</span><span class="s3">&quot;.json&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_features(url</span><span class="s2">, </span><span class="s1">has_gzip_header):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared(</span>
            <span class="s1">url=url</span><span class="s2">,</span>
            <span class="s1">has_gzip_header=has_gzip_header</span><span class="s2">,</span>
            <span class="s1">expected_prefix=url_prefix_data_features</span><span class="s2">,</span>
            <span class="s1">suffix=</span><span class="s3">&quot;.json&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_download_data(url</span><span class="s2">, </span><span class="s1">has_gzip_header):</span>
        <span class="s2">return </span><span class="s1">_mock_urlopen_shared(</span>
            <span class="s1">url=url</span><span class="s2">,</span>
            <span class="s1">has_gzip_header=has_gzip_header</span><span class="s2">,</span>
            <span class="s1">expected_prefix=url_prefix_download_data</span><span class="s2">,</span>
            <span class="s1">suffix=</span><span class="s3">&quot;.arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen_data_list(url</span><span class="s2">, </span><span class="s1">has_gzip_header):</span>
        <span class="s2">assert </span><span class="s1">url.startswith(url_prefix_data_list)</span>

        <span class="s1">data_file_name = _file_name(url</span><span class="s2">, </span><span class="s3">&quot;.json&quot;</span><span class="s1">)</span>

        <span class="s4"># load the file itself, to simulate a http error</span>
        <span class="s2">with </span><span class="s1">_open_binary(data_module</span><span class="s2">, </span><span class="s1">data_file_name) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s1">decompressed_f = read_fn(f</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">)</span>
            <span class="s1">decoded_s = decompressed_f.read().decode(</span><span class="s3">&quot;utf-8&quot;</span><span class="s1">)</span>
            <span class="s1">json_data = json.loads(decoded_s)</span>
        <span class="s2">if </span><span class="s3">&quot;error&quot; </span><span class="s2">in </span><span class="s1">json_data:</span>
            <span class="s2">raise </span><span class="s1">HTTPError(</span>
                <span class="s1">url=</span><span class="s2">None, </span><span class="s1">code=</span><span class="s5">412</span><span class="s2">, </span><span class="s1">msg=</span><span class="s3">&quot;Simulated mock error&quot;</span><span class="s2">, </span><span class="s1">hdrs=</span><span class="s2">None, </span><span class="s1">fp=</span><span class="s2">None</span>
            <span class="s1">)</span>

        <span class="s2">with </span><span class="s1">_open_binary(data_module</span><span class="s2">, </span><span class="s1">data_file_name) </span><span class="s2">as </span><span class="s1">f:</span>
            <span class="s2">if </span><span class="s1">has_gzip_header:</span>
                <span class="s1">fp = BytesIO(f.read())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse(fp</span><span class="s2">, True</span><span class="s1">)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">decompressed_f = read_fn(f</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">)</span>
                <span class="s1">fp = BytesIO(decompressed_f.read())</span>
                <span class="s2">return </span><span class="s1">_MockHTTPResponse(fp</span><span class="s2">, False</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen(request</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">url = request.get_full_url()</span>
        <span class="s1">has_gzip_header = request.get_header(</span><span class="s3">&quot;Accept-encoding&quot;</span><span class="s1">) == </span><span class="s3">&quot;gzip&quot;</span>
        <span class="s2">if </span><span class="s1">url.startswith(url_prefix_data_list):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_list(url</span><span class="s2">, </span><span class="s1">has_gzip_header)</span>
        <span class="s2">elif </span><span class="s1">url.startswith(url_prefix_data_features):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_features(url</span><span class="s2">, </span><span class="s1">has_gzip_header)</span>
        <span class="s2">elif </span><span class="s1">url.startswith(url_prefix_download_data):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_download_data(url</span><span class="s2">, </span><span class="s1">has_gzip_header)</span>
        <span class="s2">elif </span><span class="s1">url.startswith(url_prefix_data_description):</span>
            <span class="s2">return </span><span class="s1">_mock_urlopen_data_description(url</span><span class="s2">, </span><span class="s1">has_gzip_header)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s3">&quot;Unknown mocking URL pattern: %s&quot; </span><span class="s1">% url)</span>

    <span class="s4"># XXX: Global variable</span>
    <span class="s2">if </span><span class="s1">test_offline:</span>
        <span class="s1">context.setattr(sklearn.datasets._openml</span><span class="s2">, </span><span class="s3">&quot;urlopen&quot;</span><span class="s2">, </span><span class="s1">_mock_urlopen)</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Test the behaviour of `fetch_openml` depending of the input parameters.</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data_id, dataset_params, n_samples, n_features, n_targets&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s4"># iris</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">61</span><span class="s1">}</span><span class="s2">, </span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># anneal</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;anneal&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># cpu</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">561</span><span class="s1">}</span><span class="s2">, </span><span class="s5">209</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;cpu&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">209</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># emotions</span>
        <span class="s1">(</span><span class="s5">40589</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40589</span><span class="s1">}</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">72</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># adult-census</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">1119</span><span class="s1">}</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;adult-census&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># miceprotein</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40966</span><span class="s1">}</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;MiceProtein&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># titanic</span>
        <span class="s1">(</span><span class="s5">40945</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40945</span><span class="s1">}</span><span class="s2">, </span><span class="s5">1309</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_as_frame_true(</span>
    <span class="s1">monkeypatch</span><span class="s2">,</span>
    <span class="s1">data_id</span><span class="s2">,</span>
    <span class="s1">dataset_params</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">,</span>
    <span class="s1">n_targets</span><span class="s2">,</span>
    <span class="s1">parser</span><span class="s2">,</span>
    <span class="s1">gzip_response</span><span class="s2">,</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `fetch_openml` with `as_frame=True`. 
 
    Fetch by ID and/or name (depending if the file was previously cached). 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=gzip_response)</span>
    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
        <span class="s1">**dataset_params</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s2">assert </span><span class="s1">int(bunch.details[</span><span class="s3">&quot;id&quot;</span><span class="s1">]) == data_id</span>
    <span class="s2">assert </span><span class="s1">isinstance(bunch</span><span class="s2">, </span><span class="s1">Bunch)</span>

    <span class="s2">assert </span><span class="s1">isinstance(bunch.frame</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
    <span class="s2">assert </span><span class="s1">bunch.frame.shape == (n_samples</span><span class="s2">, </span><span class="s1">n_features + n_targets)</span>

    <span class="s2">assert </span><span class="s1">isinstance(bunch.data</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
    <span class="s2">assert </span><span class="s1">bunch.data.shape == (n_samples</span><span class="s2">, </span><span class="s1">n_features)</span>

    <span class="s2">if </span><span class="s1">n_targets == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">isinstance(bunch.target</span><span class="s2">, </span><span class="s1">pd.Series)</span>
        <span class="s2">assert </span><span class="s1">bunch.target.shape == (n_samples</span><span class="s2">,</span><span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">isinstance(bunch.target</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
        <span class="s2">assert </span><span class="s1">bunch.target.shape == (n_samples</span><span class="s2">, </span><span class="s1">n_targets)</span>

    <span class="s2">assert </span><span class="s1">bunch.categories </span><span class="s2">is None</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data_id, dataset_params, n_samples, n_features, n_targets&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s4"># iris</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">61</span><span class="s1">}</span><span class="s2">, </span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;iris&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># anneal</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;anneal&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># cpu</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">561</span><span class="s1">}</span><span class="s2">, </span><span class="s5">209</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;cpu&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">, </span><span class="s5">209</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># emotions</span>
        <span class="s1">(</span><span class="s5">40589</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40589</span><span class="s1">}</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">72</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># adult-census</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">1119</span><span class="s1">}</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;adult-census&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># miceprotein</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40966</span><span class="s1">}</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;MiceProtein&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_as_frame_false(</span>
    <span class="s1">monkeypatch</span><span class="s2">,</span>
    <span class="s1">data_id</span><span class="s2">,</span>
    <span class="s1">dataset_params</span><span class="s2">,</span>
    <span class="s1">n_samples</span><span class="s2">,</span>
    <span class="s1">n_features</span><span class="s2">,</span>
    <span class="s1">n_targets</span><span class="s2">,</span>
    <span class="s1">parser</span><span class="s2">,</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `fetch_openml` with `as_frame=False`. 
 
    Fetch both by ID and/or name + version. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
        <span class="s1">**dataset_params</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">int(bunch.details[</span><span class="s3">&quot;id&quot;</span><span class="s1">]) == data_id</span>
    <span class="s2">assert </span><span class="s1">isinstance(bunch</span><span class="s2">, </span><span class="s1">Bunch)</span>

    <span class="s2">assert </span><span class="s1">bunch.frame </span><span class="s2">is None</span>

    <span class="s2">assert </span><span class="s1">isinstance(bunch.data</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">assert </span><span class="s1">bunch.data.shape == (n_samples</span><span class="s2">, </span><span class="s1">n_features)</span>

    <span class="s2">assert </span><span class="s1">isinstance(bunch.target</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">if </span><span class="s1">n_targets == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">bunch.target.shape == (n_samples</span><span class="s2">,</span><span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">bunch.target.shape == (n_samples</span><span class="s2">, </span><span class="s1">n_targets)</span>

    <span class="s2">assert </span><span class="s1">isinstance(bunch.categories</span><span class="s2">, </span><span class="s1">dict)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;data_id&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">61</span><span class="s2">, </span><span class="s5">1119</span><span class="s2">, </span><span class="s5">40945</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_consistency_parser(monkeypatch</span><span class="s2">, </span><span class="s1">data_id):</span>
    <span class="s0">&quot;&quot;&quot;Check the consistency of the LIAC-ARFF and pandas parsers.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">bunch_liac = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">bunch_pandas = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s4"># The data frames for the input features should match up to some numerical</span>
    <span class="s4"># dtype conversions (e.g. float64 &lt;=&gt; Int64) due to limitations of the</span>
    <span class="s4"># LIAC-ARFF parser.</span>
    <span class="s1">data_liac</span><span class="s2">, </span><span class="s1">data_pandas = bunch_liac.data</span><span class="s2">, </span><span class="s1">bunch_pandas.data</span>

    <span class="s2">def </span><span class="s1">convert_numerical_dtypes(series):</span>
        <span class="s1">pandas_series = data_pandas[series.name]</span>
        <span class="s2">if </span><span class="s1">pd.api.types.is_numeric_dtype(pandas_series):</span>
            <span class="s2">return </span><span class="s1">series.astype(pandas_series.dtype)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">series</span>

    <span class="s1">data_liac_with_fixed_dtypes = data_liac.apply(convert_numerical_dtypes)</span>
    <span class="s1">pd.testing.assert_frame_equal(data_liac_with_fixed_dtypes</span><span class="s2">, </span><span class="s1">data_pandas)</span>

    <span class="s4"># Let's also check that the .frame attributes also match</span>
    <span class="s1">frame_liac</span><span class="s2">, </span><span class="s1">frame_pandas = bunch_liac.frame</span><span class="s2">, </span><span class="s1">bunch_pandas.frame</span>

    <span class="s4"># Note that the .frame attribute is a superset of the .data attribute:</span>
    <span class="s1">pd.testing.assert_frame_equal(frame_pandas[bunch_pandas.feature_names]</span><span class="s2">, </span><span class="s1">data_pandas)</span>

    <span class="s4"># However the remaining columns, typically the target(s), are not necessarily</span>
    <span class="s4"># dtyped similarly by both parsers due to limitations of the LIAC-ARFF parser.</span>
    <span class="s4"># Therefore, extra dtype conversions are required for those columns:</span>

    <span class="s2">def </span><span class="s1">convert_numerical_and_categorical_dtypes(series):</span>
        <span class="s1">pandas_series = frame_pandas[series.name]</span>
        <span class="s2">if </span><span class="s1">pd.api.types.is_numeric_dtype(pandas_series):</span>
            <span class="s2">return </span><span class="s1">series.astype(pandas_series.dtype)</span>
        <span class="s2">elif </span><span class="s1">isinstance(pandas_series.dtype</span><span class="s2">, </span><span class="s1">pd.CategoricalDtype):</span>
            <span class="s4"># Compare categorical features by converting categorical liac uses</span>
            <span class="s4"># strings to denote the categories, we rename the categories to make</span>
            <span class="s4"># them comparable to the pandas parser. Fixing this behavior in</span>
            <span class="s4"># LIAC-ARFF would allow to check the consistency in the future but</span>
            <span class="s4"># we do not plan to maintain the LIAC-ARFF on the long term.</span>
            <span class="s2">return </span><span class="s1">series.cat.rename_categories(pandas_series.cat.categories)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">series</span>

    <span class="s1">frame_liac_with_fixed_dtypes = frame_liac.apply(</span>
        <span class="s1">convert_numerical_and_categorical_dtypes</span>
    <span class="s1">)</span>
    <span class="s1">pd.testing.assert_frame_equal(frame_liac_with_fixed_dtypes</span><span class="s2">, </span><span class="s1">frame_pandas)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_array_dataframe(monkeypatch</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check the equivalence of the dataset when using `as_frame=False` and 
    `as_frame=True`. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">bunch_as_frame_true = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">bunch_as_frame_false = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_allclose(bunch_as_frame_false.data</span><span class="s2">, </span><span class="s1">bunch_as_frame_true.data)</span>
    <span class="s1">assert_array_equal(bunch_as_frame_false.target</span><span class="s2">, </span><span class="s1">bunch_as_frame_true.target)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_iris_pandas(monkeypatch</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check fetching on a numerical only dataset with string labels.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">CategoricalDtype = pd.api.types.CategoricalDtype</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">data_shape = (</span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)</span>
    <span class="s1">target_shape = (</span><span class="s5">150</span><span class="s2">,</span><span class="s1">)</span>
    <span class="s1">frame_shape = (</span><span class="s5">150</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s1">target_dtype = CategoricalDtype(</span>
        <span class="s1">[</span><span class="s3">&quot;Iris-setosa&quot;</span><span class="s2">, </span><span class="s3">&quot;Iris-versicolor&quot;</span><span class="s2">, </span><span class="s3">&quot;Iris-virginica&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">data_dtypes = [np.float64] * </span><span class="s5">4</span>
    <span class="s1">data_names = [</span><span class="s3">&quot;sepallength&quot;</span><span class="s2">, </span><span class="s3">&quot;sepalwidth&quot;</span><span class="s2">, </span><span class="s3">&quot;petallength&quot;</span><span class="s2">, </span><span class="s3">&quot;petalwidth&quot;</span><span class="s1">]</span>
    <span class="s1">target_name = </span><span class="s3">&quot;class&quot;</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>

    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">data = bunch.data</span>
    <span class="s1">target = bunch.target</span>
    <span class="s1">frame = bunch.frame</span>

    <span class="s2">assert </span><span class="s1">isinstance(data</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
    <span class="s2">assert </span><span class="s1">np.all(data.dtypes == data_dtypes)</span>
    <span class="s2">assert </span><span class="s1">data.shape == data_shape</span>
    <span class="s2">assert </span><span class="s1">np.all(data.columns == data_names)</span>
    <span class="s2">assert </span><span class="s1">np.all(bunch.feature_names == data_names)</span>
    <span class="s2">assert </span><span class="s1">bunch.target_names == [target_name]</span>

    <span class="s2">assert </span><span class="s1">isinstance(target</span><span class="s2">, </span><span class="s1">pd.Series)</span>
    <span class="s2">assert </span><span class="s1">target.dtype == target_dtype</span>
    <span class="s2">assert </span><span class="s1">target.shape == target_shape</span>
    <span class="s2">assert </span><span class="s1">target.name == target_name</span>
    <span class="s2">assert </span><span class="s1">target.index.is_unique</span>

    <span class="s2">assert </span><span class="s1">isinstance(frame</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
    <span class="s2">assert </span><span class="s1">frame.shape == frame_shape</span>
    <span class="s2">assert </span><span class="s1">np.all(frame.dtypes == data_dtypes + [target_dtype])</span>
    <span class="s2">assert </span><span class="s1">frame.index.is_unique</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;target_column&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;petalwidth&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;petalwidth&quot;</span><span class="s2">, </span><span class="s3">&quot;petallength&quot;</span><span class="s1">]])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_forcing_targets(monkeypatch</span><span class="s2">, </span><span class="s1">parser</span><span class="s2">, </span><span class="s1">target_column):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can force the target to not be the default target.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s1">bunch_forcing_target = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">target_column=target_column</span><span class="s2">,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">bunch_default = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">pd.testing.assert_frame_equal(bunch_forcing_target.frame</span><span class="s2">, </span><span class="s1">bunch_default.frame)</span>
    <span class="s2">if </span><span class="s1">isinstance(target_column</span><span class="s2">, </span><span class="s1">list):</span>
        <span class="s1">pd.testing.assert_index_equal(</span>
            <span class="s1">bunch_forcing_target.target.columns</span><span class="s2">, </span><span class="s1">pd.Index(target_column)</span>
        <span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target.data.shape == (</span><span class="s5">150</span><span class="s2">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target.target.name == target_column</span>
        <span class="s2">assert </span><span class="s1">bunch_forcing_target.data.shape == (</span><span class="s5">150</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;data_id&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">61</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">561</span><span class="s2">, </span><span class="s5">40589</span><span class="s2">, </span><span class="s5">1119</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_frame_return_X_y(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `return_X_y=True` when `as_frame=True`.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">return_X_y=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">return_X_y=</span><span class="s2">True,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">pd.testing.assert_frame_equal(bunch.data</span><span class="s2">, </span><span class="s1">X)</span>
    <span class="s2">if </span><span class="s1">isinstance(y</span><span class="s2">, </span><span class="s1">pd.Series):</span>
        <span class="s1">pd.testing.assert_series_equal(bunch.target</span><span class="s2">, </span><span class="s1">y)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">pd.testing.assert_frame_equal(bunch.target</span><span class="s2">, </span><span class="s1">y)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;data_id&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">61</span><span class="s2">, </span><span class="s5">561</span><span class="s2">, </span><span class="s5">40589</span><span class="s2">, </span><span class="s5">1119</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_equivalence_array_return_X_y(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check the behaviour of `return_X_y=True` when `as_frame=False`.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">return_X_y=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">X</span><span class="s2">, </span><span class="s1">y = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">return_X_y=</span><span class="s2">True,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_array_equal(bunch.data</span><span class="s2">, </span><span class="s1">X)</span>
    <span class="s1">assert_array_equal(bunch.target</span><span class="s2">, </span><span class="s1">y)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_difference_parsers(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check the difference between liac-arff and pandas parser.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">1119</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s4"># When `as_frame=False`, the categories will be ordinally encoded with</span>
    <span class="s4"># liac-arff parser while this is not the case with pandas parser.</span>
    <span class="s1">as_frame = </span><span class="s2">False</span>
    <span class="s1">bunch_liac_arff = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=as_frame</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">bunch_pandas = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=as_frame</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s2">assert </span><span class="s1">bunch_liac_arff.data.dtype.kind == </span><span class="s3">&quot;f&quot;</span>
    <span class="s2">assert </span><span class="s1">bunch_pandas.data.dtype == </span><span class="s3">&quot;O&quot;</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Test the ARFF parsing on several dataset to check if detect the correct</span>
<span class="s4"># types (categories, integers, floats).</span>


<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;module&quot;</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">datasets_column_names():</span>
    <span class="s0">&quot;&quot;&quot;Returns the columns names for each dataset.&quot;&quot;&quot;</span>
    <span class="s2">return </span><span class="s1">{</span>
        <span class="s5">61</span><span class="s1">: [</span><span class="s3">&quot;sepallength&quot;</span><span class="s2">, </span><span class="s3">&quot;sepalwidth&quot;</span><span class="s2">, </span><span class="s3">&quot;petallength&quot;</span><span class="s2">, </span><span class="s3">&quot;petalwidth&quot;</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s5">2</span><span class="s1">: [</span>
            <span class="s3">&quot;family&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;product-type&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;steel&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;carbon&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;hardness&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;temper_rolling&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;condition&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;formability&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;strength&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;non-ageing&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;surface-finish&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;surface-quality&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;enamelability&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bc&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bf&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bt&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bw%2Fme&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bl&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;m&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;chrom&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;phos&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;cbond&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;marvi&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;exptl&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ferro&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;corr&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;blue%2Fbright%2Fvarn%2Fclean&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;lustre&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;jurofm&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;s&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;p&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;shape&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;thick&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;width&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;len&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;oil&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;bore&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;packing&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;class&quot;</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s5">561</span><span class="s1">: [</span><span class="s3">&quot;vendor&quot;</span><span class="s2">, </span><span class="s3">&quot;MYCT&quot;</span><span class="s2">, </span><span class="s3">&quot;MMIN&quot;</span><span class="s2">, </span><span class="s3">&quot;MMAX&quot;</span><span class="s2">, </span><span class="s3">&quot;CACH&quot;</span><span class="s2">, </span><span class="s3">&quot;CHMIN&quot;</span><span class="s2">, </span><span class="s3">&quot;CHMAX&quot;</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s5">40589</span><span class="s1">: [</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_Centroid&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_Rolloff&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_Flux&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_4&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_5&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_6&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_7&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_8&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_9&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_10&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_11&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Mean_Mem40_MFCC_12&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_Centroid&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_Rolloff&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_Flux&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_4&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_5&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_6&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_7&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_8&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_9&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_10&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_11&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Mean_Acc1298_Std_Mem40_MFCC_12&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_Centroid&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_Rolloff&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_Flux&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_4&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_5&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_6&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_7&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_8&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_9&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_10&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_11&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Mean_Mem40_MFCC_12&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_Centroid&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_Rolloff&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_Flux&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_0&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_4&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_5&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_6&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_7&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_8&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_9&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_10&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_11&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Std_Acc1298_Std_Mem40_MFCC_12&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BH_LowPeakAmp&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BH_LowPeakBPM&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BH_HighPeakAmp&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BH_HighPeakBPM&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BH_HighLowRatio&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BHSUM1&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BHSUM2&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BHSUM3&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;amazed.suprised&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;happy.pleased&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;relaxing.calm&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;quiet.still&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;sad.lonely&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;angry.aggresive&quot;</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s5">1119</span><span class="s1">: [</span>
            <span class="s3">&quot;age&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;workclass&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;fnlwgt:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;education:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;education-num:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;marital-status:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;occupation:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;relationship:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;race:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;sex:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;capital-gain:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;capital-loss:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;hours-per-week:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;native-country:&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;class&quot;</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s5">40966</span><span class="s1">: [</span>
            <span class="s3">&quot;DYRK1A_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ITSN1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BDNF_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;NR1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;NR2A_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pAKT_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pBRAF_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pCAMKII_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pCREB_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pELK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pERK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pJNK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;PKCA_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pMEK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pNR1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pNR2A_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pNR2B_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pPKCAB_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pRSK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;AKT_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BRAF_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;CAMKII_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;CREB_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ELK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ERK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;GSK3B_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;JNK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;MEK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;TRKA_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;RSK_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;APP_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Bcatenin_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;SOD1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;MTOR_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;P38_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pMTOR_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;DSCR1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;AMPKA_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;NR2B_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pNUMB_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;RAPTOR_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;TIAM1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pP70S6_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;NUMB_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;P70S6_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pGSK3B_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pPKCG_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;CDK5_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;S6_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ADARB1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;AcetylH3K9_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;RRP1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BAX_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ARC_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ERBB4_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;nNOS_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Tau_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;GFAP_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;GluR3_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;GluR4_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;IL1B_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;P3525_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pCASP9_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;PSD95_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;SNCA_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;Ubiquitin_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pGSK3B_Tyr216_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;SHH_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BAD_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;BCL2_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pS6_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;pCFOS_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;SYP_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;H3AcK18_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;EGR1_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;H3MeK4_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;CaNA_N&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;class&quot;</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s5">40945</span><span class="s1">: [</span>
            <span class="s3">&quot;pclass&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;survived&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;name&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;sex&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;age&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;sibsp&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;parch&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;ticket&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;fare&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;cabin&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;embarked&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;boat&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;body&quot;</span><span class="s2">,</span>
            <span class="s3">&quot;home.dest&quot;</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">}</span>


<span class="s1">@pytest.fixture(scope=</span><span class="s3">&quot;module&quot;</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">datasets_missing_values():</span>
    <span class="s2">return </span><span class="s1">{</span>
        <span class="s5">61</span><span class="s1">: {}</span><span class="s2">,</span>
        <span class="s5">2</span><span class="s1">: {</span>
            <span class="s3">&quot;family&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;temper_rolling&quot;</span><span class="s1">: </span><span class="s5">9</span><span class="s2">,</span>
            <span class="s3">&quot;condition&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s2">,</span>
            <span class="s3">&quot;formability&quot;</span><span class="s1">: </span><span class="s5">4</span><span class="s2">,</span>
            <span class="s3">&quot;non-ageing&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s2">,</span>
            <span class="s3">&quot;surface-finish&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;enamelability&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;bc&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;bf&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s2">,</span>
            <span class="s3">&quot;bt&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;bw%2Fme&quot;</span><span class="s1">: </span><span class="s5">8</span><span class="s2">,</span>
            <span class="s3">&quot;bl&quot;</span><span class="s1">: </span><span class="s5">9</span><span class="s2">,</span>
            <span class="s3">&quot;m&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;chrom&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;phos&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;cbond&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s2">,</span>
            <span class="s3">&quot;marvi&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;exptl&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;ferro&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;corr&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;blue%2Fbright%2Fvarn%2Fclean&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;lustre&quot;</span><span class="s1">: </span><span class="s5">8</span><span class="s2">,</span>
            <span class="s3">&quot;jurofm&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;s&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;p&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
            <span class="s3">&quot;oil&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s2">,</span>
            <span class="s3">&quot;packing&quot;</span><span class="s1">: </span><span class="s5">11</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s5">561</span><span class="s1">: {}</span><span class="s2">,</span>
        <span class="s5">40589</span><span class="s1">: {}</span><span class="s2">,</span>
        <span class="s5">1119</span><span class="s1">: {}</span><span class="s2">,</span>
        <span class="s5">40966</span><span class="s1">: {</span><span class="s3">&quot;BCL2_N&quot;</span><span class="s1">: </span><span class="s5">7</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s5">40945</span><span class="s1">: {</span>
            <span class="s3">&quot;age&quot;</span><span class="s1">: </span><span class="s5">263</span><span class="s2">,</span>
            <span class="s3">&quot;fare&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s2">,</span>
            <span class="s3">&quot;cabin&quot;</span><span class="s1">: </span><span class="s5">1014</span><span class="s2">,</span>
            <span class="s3">&quot;embarked&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s2">,</span>
            <span class="s3">&quot;boat&quot;</span><span class="s1">: </span><span class="s5">823</span><span class="s2">,</span>
            <span class="s3">&quot;body&quot;</span><span class="s1">: </span><span class="s5">1188</span><span class="s2">,</span>
            <span class="s3">&quot;home.dest&quot;</span><span class="s1">: </span><span class="s5">564</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
    <span class="s1">}</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data_id, parser, expected_n_categories, expected_n_floats, expected_n_ints&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s4"># iris dataset</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># anneal dataset</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">33</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">33</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># cpu dataset</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">561</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">7</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># emotions dataset</span>
        <span class="s1">(</span><span class="s5">40589</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">72</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">40589</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">69</span><span class="s2">, </span><span class="s5">3</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># adult-census dataset</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">1119</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># miceprotein</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">40966</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">77</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4"># titanic</span>
        <span class="s1">(</span><span class="s5">40945</span><span class="s2">, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s5">40945</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_types_inference(</span>
    <span class="s1">monkeypatch</span><span class="s2">,</span>
    <span class="s1">data_id</span><span class="s2">,</span>
    <span class="s1">parser</span><span class="s2">,</span>
    <span class="s1">expected_n_categories</span><span class="s2">,</span>
    <span class="s1">expected_n_floats</span><span class="s2">,</span>
    <span class="s1">expected_n_ints</span><span class="s2">,</span>
    <span class="s1">gzip_response</span><span class="s2">,</span>
    <span class="s1">datasets_column_names</span><span class="s2">,</span>
    <span class="s1">datasets_missing_values</span><span class="s2">,</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Check that `fetch_openml` infer the right number of categories, integers, and 
    floats.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">CategoricalDtype = pd.api.types.CategoricalDtype</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=gzip_response)</span>

    <span class="s1">bunch = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">frame = bunch.frame</span>

    <span class="s1">n_categories = len(</span>
        <span class="s1">[dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame.dtypes </span><span class="s2">if </span><span class="s1">isinstance(dtype</span><span class="s2">, </span><span class="s1">CategoricalDtype)]</span>
    <span class="s1">)</span>
    <span class="s1">n_floats = len([dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame.dtypes </span><span class="s2">if </span><span class="s1">dtype.kind == </span><span class="s3">&quot;f&quot;</span><span class="s1">])</span>
    <span class="s1">n_ints = len([dtype </span><span class="s2">for </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">frame.dtypes </span><span class="s2">if </span><span class="s1">dtype.kind == </span><span class="s3">&quot;i&quot;</span><span class="s1">])</span>

    <span class="s2">assert </span><span class="s1">n_categories == expected_n_categories</span>
    <span class="s2">assert </span><span class="s1">n_floats == expected_n_floats</span>
    <span class="s2">assert </span><span class="s1">n_ints == expected_n_ints</span>

    <span class="s2">assert </span><span class="s1">frame.columns.tolist() == datasets_column_names[data_id]</span>

    <span class="s1">frame_feature_to_n_nan = frame.isna().sum().to_dict()</span>
    <span class="s2">for </span><span class="s1">name</span><span class="s2">, </span><span class="s1">n_missing </span><span class="s2">in </span><span class="s1">frame_feature_to_n_nan.items():</span>
        <span class="s1">expected_missing = datasets_missing_values[data_id].get(name</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">n_missing == expected_missing</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Test some more specific behaviour</span>


<span class="s4"># TODO(1.4): remove this filterwarning decorator</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:The default value of `parser` will change&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;unknown&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s3">&quot;The 'parser' parameter of fetch_openml must be a str among&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s3">&quot;unknown&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s3">&quot;The 'as_frame' parameter of fetch_openml must be an instance&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_validation_parameter(monkeypatch</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg):</span>
    <span class="s1">data_id = </span><span class="s5">1119</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">**params)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;params&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True, </span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;auto&quot;</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">{</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;auto&quot;</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">{</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">False, </span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;pandas&quot;</span><span class="s1">}</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_requires_pandas_error(monkeypatch</span><span class="s2">, </span><span class="s1">params):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise the proper errors when we require pandas.&quot;&quot;&quot;</span>
    <span class="s1">data_id = </span><span class="s5">1119</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">check_pandas_support(</span><span class="s3">&quot;test_fetch_openml_requires_pandas&quot;</span><span class="s1">)</span>
    <span class="s2">except </span><span class="s1">ImportError:</span>
        <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
        <span class="s1">err_msg = </span><span class="s3">&quot;requires pandas to be installed. Alternatively, explicitly&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ImportError</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
            <span class="s1">fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">**params)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">SkipTest(</span><span class="s3">&quot;This test requires pandas to not be installed.&quot;</span><span class="s1">)</span>


<span class="s4"># TODO(1.4): move this parameter option in`test_fetch_openml_requires_pandas_error`</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_requires_pandas_in_future(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a warning that pandas will be required in the future.&quot;&quot;&quot;</span>
    <span class="s1">params = {</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">False, </span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;auto&quot;</span><span class="s1">}</span>
    <span class="s1">data_id = </span><span class="s5">1119</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">check_pandas_support(</span><span class="s3">&quot;test_fetch_openml_requires_pandas&quot;</span><span class="s1">)</span>
    <span class="s2">except </span><span class="s1">ImportError:</span>
        <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
        <span class="s1">warn_msg = (</span>
            <span class="s3">&quot;From version 1.4, `parser='auto'` with `as_frame=False` will use pandas&quot;</span>
        <span class="s1">)</span>
        <span class="s2">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s2">, </span><span class="s1">match=warn_msg):</span>
            <span class="s1">fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">**params)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">SkipTest(</span><span class="s3">&quot;This test requires pandas to not be installed.&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:Version 1 of dataset Australian is inactive&quot;</span><span class="s1">)</span>
<span class="s4"># TODO(1.4): remove this filterwarning decorator for `parser`</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:The default value of `parser` will change&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;params, err_msg&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;pandas&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s3">&quot;Sparse ARFF datasets cannot be loaded with parser='pandas'&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s3">&quot;Sparse ARFF datasets cannot be loaded with as_frame=True.&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s3">&quot;Sparse ARFF datasets cannot be loaded with as_frame=True.&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_sparse_arff_error(monkeypatch</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_msg):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise the expected error for sparse ARFF datasets and 
    a wrong set of incompatible parameters. 
    &quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">292</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">**params</span><span class="s2">,</span>
        <span class="s1">)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s3">&quot;ignore:Version 1 of dataset Australian is inactive&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data_id, data_type&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s4"># iris dataset version 1</span>
        <span class="s1">(</span><span class="s5">292</span><span class="s2">, </span><span class="s3">&quot;sparse&quot;</span><span class="s1">)</span><span class="s2">,  </span><span class="s4"># Australian dataset version 1</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_auto_mode(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">data_type):</span>
    <span class="s0">&quot;&quot;&quot;Check the auto mode of `fetch_openml`.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>
    <span class="s1">data = fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">as_frame=</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">parser=</span><span class="s3">&quot;auto&quot;</span><span class="s2">, </span><span class="s1">cache=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">klass = pd.DataFrame </span><span class="s2">if </span><span class="s1">data_type == </span><span class="s3">&quot;dataframe&quot; </span><span class="s2">else </span><span class="s1">scipy.sparse.csr_matrix</span>
    <span class="s2">assert </span><span class="s1">isinstance(data.data</span><span class="s2">, </span><span class="s1">klass)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s2">def </span><span class="s1">test_convert_arff_data_dataframe_warning_low_memory_pandas(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a warning regarding the working memory when using 
    LIAC-ARFF parser.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">1119</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>

    <span class="s1">msg = </span><span class="s3">&quot;Could not adhere to working_memory config.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s2">with </span><span class="s1">config_context(working_memory=</span><span class="s5">1e-6</span><span class="s1">):</span>
            <span class="s1">fetch_openml(</span>
                <span class="s1">data_id=data_id</span><span class="s2">,</span>
                <span class="s1">as_frame=</span><span class="s2">True,</span>
                <span class="s1">cache=</span><span class="s2">False,</span>
                <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
            <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_iris_warn_multiple_version(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s0">&quot;&quot;&quot;Check that a warning is raised when multiple versions exist and no version is 
    requested.&quot;&quot;&quot;</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">data_name = </span><span class="s3">&quot;iris&quot;</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>

    <span class="s1">msg = (</span>
        <span class="s3">&quot;Multiple active versions of the dataset matching the name&quot;</span>
        <span class="s3">&quot; iris exist. Versions may be fundamentally different, &quot;</span>
        <span class="s3">&quot;returning version 1.&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">name=data_name</span><span class="s2">,</span>
            <span class="s1">as_frame=</span><span class="s2">False,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_no_target(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can get a dataset without target.&quot;&quot;&quot;</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">target_column = </span><span class="s2">None</span>
    <span class="s1">expected_observations = </span><span class="s5">150</span>
    <span class="s1">expected_features = </span><span class="s5">5</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">data = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">target_column=target_column</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">data.data.shape == (expected_observations</span><span class="s2">, </span><span class="s1">expected_features)</span>
    <span class="s2">assert </span><span class="s1">data.target </span><span class="s2">is None</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_missing_values_pandas(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;check that missing values in categories are compatible with pandas 
    categorical&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">42585</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response=gzip_response)</span>
    <span class="s1">penguins = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">False,</span>
        <span class="s1">as_frame=</span><span class="s2">True,</span>
        <span class="s1">parser=parser</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">cat_dtype = penguins.data.dtypes[</span><span class="s3">&quot;sex&quot;</span><span class="s1">]</span>
    <span class="s4"># there are nans in the categorical</span>
    <span class="s2">assert </span><span class="s1">penguins.data[</span><span class="s3">&quot;sex&quot;</span><span class="s1">].isna().any()</span>
    <span class="s1">assert_array_equal(cat_dtype.categories</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;FEMALE&quot;</span><span class="s2">, </span><span class="s3">&quot;MALE&quot;</span><span class="s2">, </span><span class="s3">&quot;_&quot;</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;dataset_params&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40675</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s2">None, </span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;glass2&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_inactive(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">dataset_params):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a warning when the dataset is inactive.&quot;&quot;&quot;</span>
    <span class="s1">data_id = </span><span class="s5">40675</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">msg = </span><span class="s3">&quot;Version 1 of dataset glass2 is inactive,&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">glass2 = fetch_openml(</span>
            <span class="s1">cache=</span><span class="s2">False, </span><span class="s1">as_frame=</span><span class="s2">False, </span><span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s1">**dataset_params</span>
        <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">glass2.data.shape == (</span><span class="s5">163</span><span class="s2">, </span><span class="s5">9</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">glass2.details[</span><span class="s3">&quot;id&quot;</span><span class="s1">] == </span><span class="s3">&quot;40675&quot;</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data_id, params, err_type, err_msg&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s5">40675</span><span class="s2">, </span><span class="s1">{</span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;glass2&quot;</span><span class="s1">}</span><span class="s2">, </span><span class="s1">ValueError</span><span class="s2">, </span><span class="s3">&quot;No active dataset glass2 found&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">61</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;target_column&quot;</span><span class="s1">: [</span><span class="s3">&quot;sepalwidth&quot;</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;Can only handle homogeneous multi-target datasets&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">40945</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">40945</span><span class="s2">, </span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">False</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s3">&quot;STRING attributes are not supported for array representation. Try&quot;</span>
                <span class="s3">&quot; as_frame=True&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">2</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;target_column&quot;</span><span class="s1">: </span><span class="s3">&quot;family&quot;</span><span class="s2">, </span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;Target column 'family'&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">2</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">2</span><span class="s2">, </span><span class="s3">&quot;target_column&quot;</span><span class="s1">: </span><span class="s3">&quot;family&quot;</span><span class="s2">, </span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">False</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;Target column 'family'&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">61</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;target_column&quot;</span><span class="s1">: </span><span class="s3">&quot;undefined&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">KeyError</span><span class="s2">,</span>
            <span class="s3">&quot;Could not find target_column='undefined'&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s5">61</span><span class="s2">,</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: </span><span class="s5">61</span><span class="s2">, </span><span class="s3">&quot;target_column&quot;</span><span class="s1">: [</span><span class="s3">&quot;undefined&quot;</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]}</span><span class="s2">,</span>
            <span class="s1">KeyError</span><span class="s2">,</span>
            <span class="s3">&quot;Could not find target_column='undefined'&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_error(</span>
    <span class="s1">monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">err_msg</span><span class="s2">, </span><span class="s1">parser</span>
<span class="s1">):</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s2">if </span><span class="s1">params.get(</span><span class="s3">&quot;as_frame&quot;</span><span class="s2">, True</span><span class="s1">) </span><span class="s2">or </span><span class="s1">parser == </span><span class="s3">&quot;pandas&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(err_type</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">fetch_openml(cache=</span><span class="s2">False, </span><span class="s1">parser=parser</span><span class="s2">, </span><span class="s1">**params)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;params, err_type, err_msg&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: -</span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s2">None, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s3">&quot;version&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;The 'version' parameter of fetch_openml must be an int in the range&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: -</span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;nAmE&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;The 'data_id' parameter of fetch_openml must be an int in the range&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{</span><span class="s3">&quot;data_id&quot;</span><span class="s1">: -</span><span class="s5">1</span><span class="s2">, </span><span class="s3">&quot;name&quot;</span><span class="s1">: </span><span class="s3">&quot;nAmE&quot;</span><span class="s2">, </span><span class="s3">&quot;version&quot;</span><span class="s1">: </span><span class="s3">&quot;version&quot;</span><span class="s1">}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;The 'version' parameter of fetch_openml must be an int&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">{}</span><span class="s2">,</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s3">&quot;Neither name nor data_id are provided. Please provide name or data_id.&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_raises_illegal_argument(params</span><span class="s2">, </span><span class="s1">err_type</span><span class="s2">, </span><span class="s1">err_msg):</span>
    <span class="s2">with </span><span class="s1">pytest.raises(err_type</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">fetch_openml(**params)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_warn_ignore_attribute(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s1">data_id = </span><span class="s5">40966</span>
    <span class="s1">expected_row_id_msg = </span><span class="s3">&quot;target_column='{}' has flag is_row_identifier.&quot;</span>
    <span class="s1">expected_ignore_msg = </span><span class="s3">&quot;target_column='{}' has flag is_ignore.&quot;</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s4"># single column test</span>
    <span class="s1">target_col = </span><span class="s3">&quot;MouseID&quot;</span>
    <span class="s1">msg = expected_row_id_msg.format(target_col)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">,</span>
            <span class="s1">target_column=target_col</span><span class="s2">,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">as_frame=</span><span class="s2">False,</span>
            <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s1">target_col = </span><span class="s3">&quot;Genotype&quot;</span>
    <span class="s1">msg = expected_ignore_msg.format(target_col)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">,</span>
            <span class="s1">target_column=target_col</span><span class="s2">,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">as_frame=</span><span class="s2">False,</span>
            <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s4"># multi column test</span>
    <span class="s1">target_col = </span><span class="s3">&quot;MouseID&quot;</span>
    <span class="s1">msg = expected_row_id_msg.format(target_col)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">,</span>
            <span class="s1">target_column=[target_col</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">as_frame=</span><span class="s2">False,</span>
            <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
    <span class="s1">target_col = </span><span class="s3">&quot;Genotype&quot;</span>
    <span class="s1">msg = expected_ignore_msg.format(target_col)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">,</span>
            <span class="s1">target_column=[target_col</span><span class="s2">, </span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">cache=</span><span class="s2">False,</span>
            <span class="s1">as_frame=</span><span class="s2">False,</span>
            <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_dataset_with_openml_error(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s1">data_id = </span><span class="s5">1</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">msg = </span><span class="s3">&quot;OpenML registered a problem with the dataset. It might be unusable. Error:&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">cache=</span><span class="s2">False, </span><span class="s1">as_frame=</span><span class="s2">False, </span><span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_dataset_with_openml_warning(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response):</span>
    <span class="s1">data_id = </span><span class="s5">3</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">msg = </span><span class="s3">&quot;OpenML raised a warning on the dataset. It might be unusable. Warning:&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">fetch_openml(data_id=data_id</span><span class="s2">, </span><span class="s1">cache=</span><span class="s2">False, </span><span class="s1">as_frame=</span><span class="s2">False, </span><span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_overwrite_default_params_read_csv(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can overwrite the default parameters of `read_csv`.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">1590</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">common_params = {</span>
        <span class="s3">&quot;data_id&quot;</span><span class="s1">: data_id</span><span class="s2">,</span>
        <span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s3">&quot;cache&quot;</span><span class="s1">: </span><span class="s2">False,</span>
        <span class="s3">&quot;parser&quot;</span><span class="s1">: </span><span class="s3">&quot;pandas&quot;</span><span class="s2">,</span>
    <span class="s1">}</span>

    <span class="s4"># By default, the initial spaces are skipped. We checked that setting the parameter</span>
    <span class="s4"># `skipinitialspace` to False will have an effect.</span>
    <span class="s1">adult_without_spaces = fetch_openml(**common_params)</span>
    <span class="s1">adult_with_spaces = fetch_openml(</span>
        <span class="s1">**common_params</span><span class="s2">, </span><span class="s1">read_csv_kwargs={</span><span class="s3">&quot;skipinitialspace&quot;</span><span class="s1">: </span><span class="s2">False</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">all(</span>
        <span class="s1">cat.startswith(</span><span class="s3">&quot; &quot;</span><span class="s1">) </span><span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">adult_with_spaces.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">].cat.categories</span>
    <span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">any(</span>
        <span class="s1">cat.startswith(</span><span class="s3">&quot; &quot;</span><span class="s1">)</span>
        <span class="s2">for </span><span class="s1">cat </span><span class="s2">in </span><span class="s1">adult_without_spaces.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">].cat.categories</span>
    <span class="s1">)</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Test cache, retry mechanisms, checksum, etc.</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_open_openml_url_cache(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s1">data_id = </span><span class="s5">61</span>

    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">openml_path = sklearn.datasets._openml._DATA_FILE.format(data_id)</span>
    <span class="s1">cache_directory = str(tmpdir.mkdir(</span><span class="s3">&quot;scikit_learn_data&quot;</span><span class="s1">))</span>
    <span class="s4"># first fill the cache</span>
    <span class="s1">response1 = _open_openml_url(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s4"># assert file exists</span>
    <span class="s1">location = _get_local_path(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s2">assert </span><span class="s1">os.path.isfile(location)</span>
    <span class="s4"># redownload, to utilize cache</span>
    <span class="s1">response2 = _open_openml_url(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s2">assert </span><span class="s1">response1.read() == response2.read()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;write_to_disk&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_open_openml_url_unlinks_local_path(monkeypatch</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">write_to_disk):</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">openml_path = sklearn.datasets._openml._DATA_FILE.format(data_id)</span>
    <span class="s1">cache_directory = str(tmpdir.mkdir(</span><span class="s3">&quot;scikit_learn_data&quot;</span><span class="s1">))</span>
    <span class="s1">location = _get_local_path(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>

    <span class="s2">def </span><span class="s1">_mock_urlopen(request</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s2">if </span><span class="s1">write_to_disk:</span>
            <span class="s2">with </span><span class="s1">open(location</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">f.write(</span><span class="s3">&quot;&quot;</span><span class="s1">)</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s3">&quot;Invalid request&quot;</span><span class="s1">)</span>

    <span class="s1">monkeypatch.setattr(sklearn.datasets._openml</span><span class="s2">, </span><span class="s3">&quot;urlopen&quot;</span><span class="s2">, </span><span class="s1">_mock_urlopen)</span>

    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s3">&quot;Invalid request&quot;</span><span class="s1">):</span>
        <span class="s1">_open_openml_url(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>

    <span class="s2">assert not </span><span class="s1">os.path.exists(location)</span>


<span class="s2">def </span><span class="s1">test_retry_with_clean_cache(tmpdir):</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">openml_path = sklearn.datasets._openml._DATA_FILE.format(data_id)</span>
    <span class="s1">cache_directory = str(tmpdir.mkdir(</span><span class="s3">&quot;scikit_learn_data&quot;</span><span class="s1">))</span>
    <span class="s1">location = _get_local_path(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s1">os.makedirs(os.path.dirname(location))</span>

    <span class="s2">with </span><span class="s1">open(location</span><span class="s2">, </span><span class="s3">&quot;w&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
        <span class="s1">f.write(</span><span class="s3">&quot;&quot;</span><span class="s1">)</span>

    <span class="s1">@_retry_with_clean_cache(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s2">def </span><span class="s1">_load_data():</span>
        <span class="s4"># The first call will raise an error since location exists</span>
        <span class="s2">if </span><span class="s1">os.path.exists(location):</span>
            <span class="s2">raise </span><span class="s1">Exception(</span><span class="s3">&quot;File exist!&quot;</span><span class="s1">)</span>
        <span class="s2">return </span><span class="s5">1</span>

    <span class="s1">warn_msg = </span><span class="s3">&quot;Invalid cache, redownloading file&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.warns(RuntimeWarning</span><span class="s2">, </span><span class="s1">match=warn_msg):</span>
        <span class="s1">result = _load_data()</span>
    <span class="s2">assert </span><span class="s1">result == </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">test_retry_with_clean_cache_http_error(tmpdir):</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">openml_path = sklearn.datasets._openml._DATA_FILE.format(data_id)</span>
    <span class="s1">cache_directory = str(tmpdir.mkdir(</span><span class="s3">&quot;scikit_learn_data&quot;</span><span class="s1">))</span>

    <span class="s1">@_retry_with_clean_cache(openml_path</span><span class="s2">, </span><span class="s1">cache_directory)</span>
    <span class="s2">def </span><span class="s1">_load_data():</span>
        <span class="s2">raise </span><span class="s1">HTTPError(</span>
            <span class="s1">url=</span><span class="s2">None, </span><span class="s1">code=</span><span class="s5">412</span><span class="s2">, </span><span class="s1">msg=</span><span class="s3">&quot;Simulated mock error&quot;</span><span class="s2">, </span><span class="s1">hdrs=</span><span class="s2">None, </span><span class="s1">fp=</span><span class="s2">None</span>
        <span class="s1">)</span>

    <span class="s1">error_msg = </span><span class="s3">&quot;Simulated mock error&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(HTTPError</span><span class="s2">, </span><span class="s1">match=error_msg):</span>
        <span class="s1">_load_data()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_cache(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">tmpdir):</span>
    <span class="s2">def </span><span class="s1">_mock_urlopen_raise(request</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span>
            <span class="s3">&quot;This mechanism intends to test correct cache&quot;</span>
            <span class="s3">&quot;handling. As such, urlopen should never be &quot;</span>
            <span class="s3">&quot;accessed. URL: %s&quot;</span>
            <span class="s1">% request.get_full_url()</span>
        <span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">cache_directory = str(tmpdir.mkdir(</span><span class="s3">&quot;scikit_learn_data&quot;</span><span class="s1">))</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>
    <span class="s1">X_fetched</span><span class="s2">, </span><span class="s1">y_fetched = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">True,</span>
        <span class="s1">data_home=cache_directory</span><span class="s2">,</span>
        <span class="s1">return_X_y=</span><span class="s2">True,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">monkeypatch.setattr(sklearn.datasets._openml</span><span class="s2">, </span><span class="s3">&quot;urlopen&quot;</span><span class="s2">, </span><span class="s1">_mock_urlopen_raise)</span>

    <span class="s1">X_cached</span><span class="s2">, </span><span class="s1">y_cached = fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">,</span>
        <span class="s1">cache=</span><span class="s2">True,</span>
        <span class="s1">data_home=cache_directory</span><span class="s2">,</span>
        <span class="s1">return_X_y=</span><span class="s2">True,</span>
        <span class="s1">as_frame=</span><span class="s2">False,</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">np.testing.assert_array_equal(X_fetched</span><span class="s2">, </span><span class="s1">X_cached)</span>
    <span class="s1">np.testing.assert_array_equal(y_fetched</span><span class="s2">, </span><span class="s1">y_cached)</span>


<span class="s4"># Known failure of PyPy for OpenML. See the following issue:</span>
<span class="s4"># https://github.com/scikit-learn/scikit-learn/issues/18906</span>
<span class="s1">@fails_if_pypy</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;as_frame, parser&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">True, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s2">False, </span><span class="s3">&quot;liac-arff&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s2">True, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span><span class="s2">False, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_verify_checksum(monkeypatch</span><span class="s2">, </span><span class="s1">as_frame</span><span class="s2">, </span><span class="s1">cache</span><span class="s2">, </span><span class="s1">tmpdir</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check that the checksum is working as expected.&quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">as_frame </span><span class="s2">or </span><span class="s1">parser == </span><span class="s3">&quot;pandas&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">data_id = </span><span class="s5">2</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, True</span><span class="s1">)</span>

    <span class="s4"># create a temporary modified arff file</span>
    <span class="s1">original_data_module = OPENML_TEST_DATA_MODULE + </span><span class="s3">&quot;.&quot; </span><span class="s1">+ </span><span class="s3">f&quot;id_</span><span class="s2">{</span><span class="s1">data_id</span><span class="s2">}</span><span class="s3">&quot;</span>
    <span class="s1">original_data_file_name = </span><span class="s3">&quot;data-v1-dl-1666876.arff.gz&quot;</span>
    <span class="s1">corrupt_copy_path = tmpdir / </span><span class="s3">&quot;test_invalid_checksum.arff&quot;</span>
    <span class="s2">with </span><span class="s1">_open_binary(original_data_module</span><span class="s2">, </span><span class="s1">original_data_file_name) </span><span class="s2">as </span><span class="s1">orig_file:</span>
        <span class="s1">orig_gzip = gzip.open(orig_file</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">)</span>
        <span class="s1">data = bytearray(orig_gzip.read())</span>
        <span class="s1">data[len(data) - </span><span class="s5">1</span><span class="s1">] = </span><span class="s5">37</span>

    <span class="s2">with </span><span class="s1">gzip.GzipFile(corrupt_copy_path</span><span class="s2">, </span><span class="s3">&quot;wb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">modified_gzip:</span>
        <span class="s1">modified_gzip.write(data)</span>

    <span class="s4"># Requests are already mocked by monkey_patch_webbased_functions.</span>
    <span class="s4"># We want to reuse that mock for all requests except file download,</span>
    <span class="s4"># hence creating a thin mock over the original mock</span>
    <span class="s1">mocked_openml_url = sklearn.datasets._openml.urlopen</span>

    <span class="s2">def </span><span class="s1">swap_file_mock(request</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s1">url = request.get_full_url()</span>
        <span class="s2">if </span><span class="s1">url.endswith(</span><span class="s3">&quot;data/v1/download/1666876&quot;</span><span class="s1">):</span>
            <span class="s2">with </span><span class="s1">open(corrupt_copy_path</span><span class="s2">, </span><span class="s3">&quot;rb&quot;</span><span class="s1">) </span><span class="s2">as </span><span class="s1">f:</span>
                <span class="s1">corrupted_data = f.read()</span>
            <span class="s2">return </span><span class="s1">_MockHTTPResponse(BytesIO(corrupted_data)</span><span class="s2">, </span><span class="s1">is_gzip=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">mocked_openml_url(request)</span>

    <span class="s1">monkeypatch.setattr(sklearn.datasets._openml</span><span class="s2">, </span><span class="s3">&quot;urlopen&quot;</span><span class="s2">, </span><span class="s1">swap_file_mock)</span>

    <span class="s4"># validate failed checksum</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s2">as </span><span class="s1">exc:</span>
        <span class="s1">sklearn.datasets.fetch_openml(</span>
            <span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">cache=</span><span class="s2">False, </span><span class="s1">as_frame=as_frame</span><span class="s2">, </span><span class="s1">parser=parser</span>
        <span class="s1">)</span>
    <span class="s4"># exception message should have file-path</span>
    <span class="s2">assert </span><span class="s1">exc.match(</span><span class="s3">&quot;1666876&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_open_openml_url_retry_on_network_error(monkeypatch):</span>
    <span class="s2">def </span><span class="s1">_mock_urlopen_network_error(request</span><span class="s2">, </span><span class="s1">*args</span><span class="s2">, </span><span class="s1">**kwargs):</span>
        <span class="s2">raise </span><span class="s1">HTTPError(</span><span class="s3">&quot;&quot;</span><span class="s2">, </span><span class="s5">404</span><span class="s2">, </span><span class="s3">&quot;Simulated network error&quot;</span><span class="s2">, None, None</span><span class="s1">)</span>

    <span class="s1">monkeypatch.setattr(</span>
        <span class="s1">sklearn.datasets._openml</span><span class="s2">, </span><span class="s3">&quot;urlopen&quot;</span><span class="s2">, </span><span class="s1">_mock_urlopen_network_error</span>
    <span class="s1">)</span>

    <span class="s1">invalid_openml_url = </span><span class="s3">&quot;invalid-url&quot;</span>

    <span class="s2">with </span><span class="s1">pytest.warns(</span>
        <span class="s1">UserWarning</span><span class="s2">,</span>
        <span class="s1">match=re.escape(</span>
            <span class="s3">&quot;A network error occurred while downloading&quot;</span>
            <span class="s3">f&quot; </span><span class="s2">{</span><span class="s1">_OPENML_PREFIX + invalid_openml_url</span><span class="s2">}</span><span class="s3">. Retrying...&quot;</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">) </span><span class="s2">as </span><span class="s1">record:</span>
        <span class="s2">with </span><span class="s1">pytest.raises(HTTPError</span><span class="s2">, </span><span class="s1">match=</span><span class="s3">&quot;Simulated network error&quot;</span><span class="s1">):</span>
            <span class="s1">_open_openml_url(invalid_openml_url</span><span class="s2">, None, </span><span class="s1">delay=</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">len(record) == </span><span class="s5">3</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Non-regressiont tests</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;gzip_response&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;parser&quot;</span><span class="s2">, </span><span class="s1">(</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s3">&quot;pandas&quot;</span><span class="s1">))</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_with_ignored_feature(monkeypatch</span><span class="s2">, </span><span class="s1">gzip_response</span><span class="s2">, </span><span class="s1">parser):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can load the &quot;zoo&quot; dataset. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/14340 
    &quot;&quot;&quot;</span>
    <span class="s2">if </span><span class="s1">parser == </span><span class="s3">&quot;pandas&quot;</span><span class="s1">:</span>
        <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">62</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id</span><span class="s2">, </span><span class="s1">gzip_response)</span>

    <span class="s1">dataset = sklearn.datasets.fetch_openml(</span>
        <span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">cache=</span><span class="s2">False, </span><span class="s1">as_frame=</span><span class="s2">False, </span><span class="s1">parser=parser</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">dataset </span><span class="s2">is not None</span>
    <span class="s4"># The dataset has 17 features, including 1 ignored (animal),</span>
    <span class="s4"># so we assert that we don't have the ignored feature in the final Bunch</span>
    <span class="s2">assert </span><span class="s1">dataset[</span><span class="s3">&quot;data&quot;</span><span class="s1">].shape == (</span><span class="s5">101</span><span class="s2">, </span><span class="s5">16</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s3">&quot;animal&quot; </span><span class="s2">not in </span><span class="s1">dataset[</span><span class="s3">&quot;feature_names&quot;</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_strip_quotes(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we strip the single quotes when used as a string delimiter. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/23381 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">40966</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">common_params = {</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True, </span><span class="s3">&quot;cache&quot;</span><span class="s1">: </span><span class="s2">False, </span><span class="s3">&quot;data_id&quot;</span><span class="s1">: data_id}</span>
    <span class="s1">mice_pandas = fetch_openml(parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">mice_liac_arff = fetch_openml(parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">pd.testing.assert_series_equal(mice_pandas.target</span><span class="s2">, </span><span class="s1">mice_liac_arff.target)</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas.target.str.startswith(</span><span class="s3">&quot;'&quot;</span><span class="s1">).any()</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas.target.str.endswith(</span><span class="s3">&quot;'&quot;</span><span class="s1">).any()</span>

    <span class="s4"># similar behaviour should be observed when the column is not the target</span>
    <span class="s1">mice_pandas = fetch_openml(parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">target_column=</span><span class="s3">&quot;NUMB_N&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">mice_liac_arff = fetch_openml(</span>
        <span class="s1">parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s1">target_column=</span><span class="s3">&quot;NUMB_N&quot;</span><span class="s2">, </span><span class="s1">**common_params</span>
    <span class="s1">)</span>
    <span class="s1">pd.testing.assert_series_equal(</span>
        <span class="s1">mice_pandas.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">mice_liac_arff.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">].str.startswith(</span><span class="s3">&quot;'&quot;</span><span class="s1">).any()</span>
    <span class="s2">assert not </span><span class="s1">mice_pandas.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">].str.endswith(</span><span class="s3">&quot;'&quot;</span><span class="s1">).any()</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_leading_whitespace(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can strip leading whitespace in pandas parser. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/25311 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">1590</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">common_params = {</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True, </span><span class="s3">&quot;cache&quot;</span><span class="s1">: </span><span class="s2">False, </span><span class="s3">&quot;data_id&quot;</span><span class="s1">: data_id}</span>
    <span class="s1">adult_pandas = fetch_openml(parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">adult_liac_arff = fetch_openml(parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">pd.testing.assert_series_equal(</span>
        <span class="s1">adult_pandas.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">adult_liac_arff.frame[</span><span class="s3">&quot;class&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_fetch_openml_quotechar_escapechar(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we can handle escapechar and single/double quotechar. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/25478 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">42074</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">common_params = {</span><span class="s3">&quot;as_frame&quot;</span><span class="s1">: </span><span class="s2">True, </span><span class="s3">&quot;cache&quot;</span><span class="s1">: </span><span class="s2">False, </span><span class="s3">&quot;data_id&quot;</span><span class="s1">: data_id}</span>
    <span class="s1">adult_pandas = fetch_openml(parser=</span><span class="s3">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">adult_liac_arff = fetch_openml(parser=</span><span class="s3">&quot;liac-arff&quot;</span><span class="s2">, </span><span class="s1">**common_params)</span>
    <span class="s1">pd.testing.assert_frame_equal(adult_pandas.frame</span><span class="s2">, </span><span class="s1">adult_liac_arff.frame)</span>


<span class="s4">###############################################################################</span>
<span class="s4"># Deprecation-changed parameters</span>


<span class="s4"># TODO(1.4): remove this test</span>
<span class="s2">def </span><span class="s1">test_fetch_openml_deprecation_parser(monkeypatch):</span>
    <span class="s0">&quot;&quot;&quot;Check that we raise a deprecation warning for parser parameter.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">data_id = </span><span class="s5">61</span>
    <span class="s1">_monkey_patch_webbased_functions(monkeypatch</span><span class="s2">, </span><span class="s1">data_id=data_id</span><span class="s2">, </span><span class="s1">gzip_response=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s2">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s2">, </span><span class="s1">match=</span><span class="s3">&quot;The default value of `parser` will change&quot;</span><span class="s1">):</span>
        <span class="s1">sklearn.datasets.fetch_openml(data_id=data_id)</span>
</pre>
</body>
</html>