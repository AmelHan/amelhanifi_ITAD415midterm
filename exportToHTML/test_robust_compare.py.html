<html>
<head>
<title>test_robust_compare.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_robust_compare.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>

<span class="s2">&quot;&quot;&quot; 
 
Created on Fri Aug 16 13:41:12 2013 
 
Author: Josef Perktold 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_raises</span>

<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">statsmodels.stats.robust_compare </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">TrimmedMean</span><span class="s3">, </span><span class="s1">trim_mean</span><span class="s3">, </span><span class="s1">trimboth)</span>
<span class="s3">import </span><span class="s1">statsmodels.stats.oneway </span><span class="s3">as </span><span class="s1">smo</span>

<span class="s3">from </span><span class="s1">statsmodels.tools.testing </span><span class="s3">import </span><span class="s1">Holder</span>

<span class="s0"># TODO: scipy trim1 is not compatible anymore with my old unit tests</span>
<span class="s3">from </span><span class="s1">scipy.stats </span><span class="s3">import </span><span class="s1">trim1</span>


<span class="s3">class </span><span class="s1">Test_Trim:</span>
    <span class="s0"># test trim functions</span>
    <span class="s0"># taken from scipy and adjusted</span>
    <span class="s3">def </span><span class="s1">t_est_trim1(self):</span>
        <span class="s1">a = np.arange(</span><span class="s4">11</span><span class="s1">)</span>
        <span class="s1">assert_equal(trim1(a</span><span class="s3">, </span><span class="s4">0.1</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s4">10</span><span class="s1">))</span>
        <span class="s1">assert_equal(trim1(a</span><span class="s3">, </span><span class="s4">0.2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s4">9</span><span class="s1">))</span>
        <span class="s1">assert_equal(trim1(a</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">, </span><span class="s1">tail=</span><span class="s5">'left'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s4">2</span><span class="s3">, </span><span class="s4">11</span><span class="s1">))</span>
        <span class="s1">assert_equal(trim1(a</span><span class="s3">, </span><span class="s4">3 </span><span class="s1">/ </span><span class="s4">11.</span><span class="s3">, </span><span class="s1">tail=</span><span class="s5">'left'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">11</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_trimboth(self):</span>
        <span class="s1">a = np.arange(</span><span class="s4">11</span><span class="s1">)</span>
        <span class="s1">a2 = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">a3 = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s1">order=</span><span class="s5">'F'</span><span class="s1">)</span>
        <span class="s1">assert_equal(trimboth(a</span><span class="s3">, </span><span class="s4">3 </span><span class="s1">/ </span><span class="s4">11.</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s4">3</span><span class="s3">, </span><span class="s4">8</span><span class="s1">))</span>
        <span class="s1">assert_equal(trimboth(a</span><span class="s3">, </span><span class="s4">0.2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">np.array([</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]))</span>

        <span class="s1">assert_equal(trimboth(a2</span><span class="s3">, </span><span class="s4">0.2</span><span class="s1">)</span><span class="s3">,</span>
                     <span class="s1">np.arange(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">20</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">assert_equal(trimboth(a3</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">,</span>
                     <span class="s1">np.array([[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">14</span><span class="s3">, </span><span class="s4">20</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">15</span><span class="s3">, </span><span class="s4">21</span><span class="s1">]]))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s3">, </span><span class="s1">trimboth</span><span class="s3">,</span>
                      <span class="s1">np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">6</span><span class="s1">).T</span><span class="s3">, </span><span class="s4">4 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_trim_mean(self):</span>
        <span class="s0"># a = np.array([4, 8, 2, 0, 9, 5, 10, 1, 7, 3, 6])</span>
        <span class="s1">idx = np.array([</span><span class="s4">3</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span>
        <span class="s1">a2 = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)[idx</span><span class="s3">, </span><span class="s1">:]</span>
        <span class="s1">a3 = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s1">order=</span><span class="s5">'F'</span><span class="s1">)[idx</span><span class="s3">, </span><span class="s1">:]</span>
        <span class="s1">assert_equal(trim_mean(a3</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">,</span>
                     <span class="s1">np.array([</span><span class="s4">2.5</span><span class="s3">, </span><span class="s4">8.5</span><span class="s3">, </span><span class="s4">14.5</span><span class="s3">, </span><span class="s4">20.5</span><span class="s1">]))</span>
        <span class="s1">assert_equal(trim_mean(a2</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">,</span>
                     <span class="s1">np.array([</span><span class="s4">10.</span><span class="s3">, </span><span class="s4">11.</span><span class="s3">, </span><span class="s4">12.</span><span class="s3">, </span><span class="s4">13.</span><span class="s1">]))</span>
        <span class="s1">idx4 = np.array([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">a4 = np.arange(</span><span class="s4">24</span><span class="s1">).reshape(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">6</span><span class="s1">)[idx4</span><span class="s3">, </span><span class="s1">:]</span>
        <span class="s1">assert_equal(trim_mean(a4</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">,</span>
                     <span class="s1">np.array([</span><span class="s4">9.</span><span class="s3">, </span><span class="s4">10.</span><span class="s3">, </span><span class="s4">11.</span><span class="s3">, </span><span class="s4">12.</span><span class="s3">, </span><span class="s4">13.</span><span class="s3">, </span><span class="s4">14.</span><span class="s1">]))</span>
        <span class="s0"># shuffled arange(24)</span>
        <span class="s1">a = np.array([</span><span class="s4">7</span><span class="s3">, </span><span class="s4">11</span><span class="s3">, </span><span class="s4">12</span><span class="s3">, </span><span class="s4">21</span><span class="s3">, </span><span class="s4">16</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">22</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">18</span><span class="s3">, </span><span class="s4">10</span><span class="s3">, </span><span class="s4">17</span><span class="s3">, </span><span class="s4">9</span><span class="s3">,</span>
                      <span class="s4">19</span><span class="s3">, </span><span class="s4">15</span><span class="s3">, </span><span class="s4">23</span><span class="s3">, </span><span class="s4">20</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">14</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">13</span><span class="s3">, </span><span class="s4">8</span><span class="s3">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(trim_mean(a</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">, </span><span class="s4">11.5</span><span class="s1">)</span>
        <span class="s1">assert_equal(trim_mean([</span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span><span class="s3">, </span><span class="s4">2.5</span><span class="s1">)</span>

        <span class="s0"># check axis argument</span>
        <span class="s1">np.random.seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s1">a = np.random.randint(</span><span class="s4">20</span><span class="s3">, </span><span class="s1">size=(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">6</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">7</span><span class="s1">))</span>
        <span class="s3">for </span><span class="s1">axis </span><span class="s3">in </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]:</span>
            <span class="s1">res1 = trim_mean(a</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s3">, </span><span class="s1">axis=axis)</span>
            <span class="s1">res2 = trim_mean(np.rollaxis(a</span><span class="s3">, </span><span class="s1">axis)</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span>
            <span class="s1">assert_equal(res1</span><span class="s3">, </span><span class="s1">res2)</span>

        <span class="s1">res1 = trim_mean(a</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s3">, </span><span class="s1">axis=</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s1">res2 = trim_mean(a.ravel()</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">6.</span><span class="s1">)</span>
        <span class="s1">assert_equal(res1</span><span class="s3">, </span><span class="s1">res2)</span>


<span class="s3">class </span><span class="s1">TestTrimmedR1:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">x = np.array([</span><span class="s4">77</span><span class="s3">, </span><span class="s4">87</span><span class="s3">, </span><span class="s4">88</span><span class="s3">, </span><span class="s4">114</span><span class="s3">, </span><span class="s4">151</span><span class="s3">, </span><span class="s4">210</span><span class="s3">, </span><span class="s4">219</span><span class="s3">, </span><span class="s4">246</span><span class="s3">, </span><span class="s4">253</span><span class="s3">, </span><span class="s4">262</span><span class="s3">, </span><span class="s4">296</span><span class="s3">, </span><span class="s4">299</span><span class="s3">,</span>
                      <span class="s4">306</span><span class="s3">, </span><span class="s4">376</span><span class="s3">, </span><span class="s4">428</span><span class="s3">, </span><span class="s4">515</span><span class="s3">, </span><span class="s4">666</span><span class="s3">, </span><span class="s4">1310</span><span class="s3">, </span><span class="s4">2611</span><span class="s1">])</span>

        <span class="s1">cls.get_results()  </span><span class="s0"># attach k and results</span>
        <span class="s1">cls.tm = TrimmedMean(x</span><span class="s3">, </span><span class="s1">cls.k / </span><span class="s4">19</span><span class="s1">)</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">get_results(cls):</span>
        <span class="s1">cls.k = </span><span class="s4">1</span>
        <span class="s0"># results from R WRS2</span>
        <span class="s1">cls.res_basic = np.array([</span>
            <span class="s4">342.705882352941</span><span class="s3">, </span><span class="s4">92.3342348150314</span><span class="s3">, </span><span class="s4">380.157894736842</span><span class="s3">,</span>
            <span class="s4">92.9416968861829</span><span class="s3">, </span><span class="s4">129679.029239766</span><span class="s1">])</span>

        <span class="s0"># results from R PairedData</span>
        <span class="s1">ytt1 = Holder()</span>
        <span class="s1">ytt1.statistic = </span><span class="s4">3.71157981694944</span>
        <span class="s1">ytt1.parameter = </span><span class="s4">16</span>
        <span class="s1">ytt1.p_value = </span><span class="s4">0.00189544440273015</span>
        <span class="s1">ytt1.conf_int = np.array([</span><span class="s4">146.966048669017</span><span class="s3">, </span><span class="s4">538.445716036866</span><span class="s1">])</span>
        <span class="s1">ytt1.estimate = </span><span class="s4">342.705882352941</span>
        <span class="s1">ytt1.null_value = </span><span class="s4">0</span>
        <span class="s1">ytt1.alternative = </span><span class="s5">'two.sided'</span>
        <span class="s1">ytt1.method = </span><span class="s5">'One sample Yuen test, trim=0.0526315789473684'</span>
        <span class="s1">ytt1.data_name = </span><span class="s5">'x'</span>
        <span class="s1">cls.ytt1 = ytt1</span>

    <span class="s3">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">tm = self.tm</span>
        <span class="s1">assert_equal(tm.nobs</span><span class="s3">, </span><span class="s4">19</span><span class="s1">)</span>
        <span class="s1">assert_equal(tm.nobs_reduced</span><span class="s3">, </span><span class="s4">17</span><span class="s1">)</span>
        <span class="s1">assert_equal(tm.fraction</span><span class="s3">, </span><span class="s1">self.k / </span><span class="s4">19</span><span class="s1">)</span>
        <span class="s1">assert_equal(tm.data_trimmed.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">tm.nobs_reduced)</span>

        <span class="s1">res = [tm.mean_trimmed</span><span class="s3">, </span><span class="s1">tm.std_mean_trimmed</span><span class="s3">, </span><span class="s1">tm.mean_winsorized</span><span class="s3">,</span>
               <span class="s1">tm.std_mean_winsorized</span><span class="s3">, </span><span class="s1">tm.var_winsorized]</span>
        <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">self.res_basic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-15</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_inference(self):</span>
        <span class="s1">ytt1 = self.ytt1</span>
        <span class="s1">tm = self.tm</span>

        <span class="s1">ttt = tm.ttest_mean()</span>
        <span class="s1">assert_allclose(ttt[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ytt1.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ttt[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ytt1.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(ttt[</span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ytt1.parameter)</span>
        <span class="s1">assert_allclose(tm.mean_trimmed</span><span class="s3">, </span><span class="s1">ytt1.estimate</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s0"># regression test for Winsorized t-test,</span>
        <span class="s0"># mean, std for it are separately unit tested,</span>
        <span class="s0"># df is nobs_reduced-1 in references</span>
        <span class="s1">ttw_statistic</span><span class="s3">, </span><span class="s1">ttw_pvalue</span><span class="s3">, </span><span class="s1">tt_w_df = (</span><span class="s4">4.090283559190728</span><span class="s3">,</span>
                                              <span class="s4">0.0008537789444194812</span><span class="s3">, </span><span class="s4">16</span><span class="s1">)</span>
        <span class="s1">ttw = tm.ttest_mean(transform=</span><span class="s5">'winsorized'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ttw[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ttw_statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(ttw[</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ttw_pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(ttw[</span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">tt_w_df)</span>

    <span class="s3">def </span><span class="s1">test_other(self):</span>
        <span class="s1">tm = self.tm</span>
        <span class="s1">tm2 = tm.reset_fraction(</span><span class="s4">0.</span><span class="s1">)</span>
        <span class="s1">assert_equal(tm2.nobs_reduced</span><span class="s3">, </span><span class="s1">tm2.nobs)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'axis'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s3">def </span><span class="s1">test_vectorized(self</span><span class="s3">, </span><span class="s1">axis):</span>
        <span class="s1">tm = self.tm</span>

        <span class="s1">x = tm.data</span>
        <span class="s1">x2 = np.column_stack((x</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* x))</span>
        <span class="s3">if </span><span class="s1">axis == </span><span class="s4">0</span><span class="s1">:</span>
            <span class="s1">tm2d = TrimmedMean(x2</span><span class="s3">, </span><span class="s1">self.k / </span><span class="s4">19</span><span class="s3">, </span><span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">tm2d = TrimmedMean(x2.T</span><span class="s3">, </span><span class="s1">self.k / </span><span class="s4">19</span><span class="s3">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">t1 = [tm.mean_trimmed</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* tm.mean_trimmed]</span>
        <span class="s1">assert_allclose(tm2d.mean_trimmed</span><span class="s3">, </span><span class="s1">t1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">t1 = [tm.var_winsorized</span><span class="s3">, </span><span class="s4">4 </span><span class="s1">* tm.var_winsorized]</span>
        <span class="s1">assert_allclose(tm2d.var_winsorized</span><span class="s3">, </span><span class="s1">t1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">t1 = [tm.std_mean_trimmed</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* tm.std_mean_trimmed]</span>
        <span class="s1">assert_allclose(tm2d.std_mean_trimmed</span><span class="s3">, </span><span class="s1">t1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">t1 = [tm.mean_winsorized</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* tm.mean_winsorized]</span>
        <span class="s1">assert_allclose(tm2d.mean_winsorized</span><span class="s3">, </span><span class="s1">t1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">t1 = [tm.std_mean_winsorized</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* tm.std_mean_winsorized]</span>
        <span class="s1">assert_allclose(tm2d.std_mean_winsorized</span><span class="s3">, </span><span class="s1">t1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">s2</span><span class="s3">, </span><span class="s1">pv2</span><span class="s3">, </span><span class="s1">df2 = tm2d.ttest_mean()</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">pv</span><span class="s3">, </span><span class="s1">df = tm.ttest_mean()</span>
        <span class="s1">assert_allclose(s2</span><span class="s3">, </span><span class="s1">[s</span><span class="s3">, </span><span class="s1">s]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv2</span><span class="s3">, </span><span class="s1">[pv</span><span class="s3">, </span><span class="s1">pv]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df2</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">s2</span><span class="s3">, </span><span class="s1">pv2</span><span class="s3">, </span><span class="s1">df2 = tm2d.ttest_mean(transform=</span><span class="s5">'winsorized'</span><span class="s1">)</span>
        <span class="s1">s</span><span class="s3">, </span><span class="s1">pv</span><span class="s3">, </span><span class="s1">df = tm.ttest_mean(transform=</span><span class="s5">'winsorized'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(s2</span><span class="s3">, </span><span class="s1">[s</span><span class="s3">, </span><span class="s1">s]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv2</span><span class="s3">, </span><span class="s1">[pv</span><span class="s3">, </span><span class="s1">pv]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(df2</span><span class="s3">, </span><span class="s1">df</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestTrimmedRAnova:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">x = [np.array([</span><span class="s4">452.</span><span class="s3">, </span><span class="s4">874.</span><span class="s3">, </span><span class="s4">554.</span><span class="s3">, </span><span class="s4">447.</span><span class="s3">, </span><span class="s4">356.</span><span class="s3">, </span><span class="s4">754.</span><span class="s3">, </span><span class="s4">558.</span><span class="s3">, </span><span class="s4">574.</span><span class="s3">, </span><span class="s4">664.</span><span class="s3">,</span>
                       <span class="s4">682.</span><span class="s3">, </span><span class="s4">547.</span><span class="s3">, </span><span class="s4">435.</span><span class="s3">, </span><span class="s4">245.</span><span class="s1">])</span><span class="s3">,</span>
             <span class="s1">np.array([</span><span class="s4">546.</span><span class="s3">, </span><span class="s4">547.</span><span class="s3">, </span><span class="s4">774.</span><span class="s3">, </span><span class="s4">465.</span><span class="s3">, </span><span class="s4">459.</span><span class="s3">, </span><span class="s4">665.</span><span class="s3">, </span><span class="s4">467.</span><span class="s3">, </span><span class="s4">365.</span><span class="s3">, </span><span class="s4">589.</span><span class="s3">,</span>
                       <span class="s4">534.</span><span class="s3">, </span><span class="s4">456.</span><span class="s3">, </span><span class="s4">651.</span><span class="s3">, </span><span class="s4">654.</span><span class="s3">, </span><span class="s4">665.</span><span class="s3">, </span><span class="s4">546.</span><span class="s3">, </span><span class="s4">537.</span><span class="s1">])</span><span class="s3">,</span>
             <span class="s1">np.array([</span><span class="s4">785.</span><span class="s3">, </span><span class="s4">458.</span><span class="s3">, </span><span class="s4">886.</span><span class="s3">, </span><span class="s4">536.</span><span class="s3">, </span><span class="s4">669.</span><span class="s3">, </span><span class="s4">857.</span><span class="s3">, </span><span class="s4">821.</span><span class="s3">, </span><span class="s4">772.</span><span class="s3">, </span><span class="s4">732.</span><span class="s3">,</span>
                       <span class="s4">689.</span><span class="s3">, </span><span class="s4">654.</span><span class="s3">, </span><span class="s4">597.</span><span class="s3">, </span><span class="s4">830.</span><span class="s3">, </span><span class="s4">827.</span><span class="s1">])]</span>

        <span class="s1">cls.x = x</span>
        <span class="s1">cls.get_results()  </span><span class="s0"># attach k and results</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">get_results(cls):</span>
        <span class="s1">cls.res_m = [</span><span class="s4">549.3846153846154</span><span class="s3">, </span><span class="s4">557.5</span><span class="s3">, </span><span class="s4">722.3571428571429</span><span class="s1">]</span>
        <span class="s0"># results from R WRS2</span>
        <span class="s0"># &gt; t1w = t1way(y ~ g, df3, tr=1/13)</span>
        <span class="s1">cls.res_oneway = Holder(test=</span><span class="s4">8.81531710400927</span><span class="s3">,</span>
                                <span class="s1">df1=</span><span class="s4">2</span><span class="s3">,</span>
                                <span class="s1">df2=</span><span class="s4">19.8903710685394</span><span class="s3">,</span>
                                <span class="s1">p_value=</span><span class="s4">0.00181464966984701</span><span class="s3">,</span>
                                <span class="s1">effsize=</span><span class="s4">0.647137153056774</span><span class="s3">,</span>
                                <span class="s1">)</span>

        <span class="s0"># &gt; yt = yuen(y ~ g, df3[1:29, ], tr=1/13)  # WRS2</span>
        <span class="s1">cls.res_2s = Holder(test=</span><span class="s4">0.161970203096559</span><span class="s3">,</span>
                            <span class="s1">conf_int=np.array([-</span><span class="s4">116.437383793431</span><span class="s3">,</span>
                                               <span class="s4">99.9568643129114</span><span class="s1">])</span><span class="s3">,</span>
                            <span class="s1">p_value=</span><span class="s4">0.873436269777141</span><span class="s3">,</span>
                            <span class="s1">df=</span><span class="s4">15.3931262881751</span><span class="s3">,</span>
                            <span class="s1">diff=-</span><span class="s4">8.24025974025983</span><span class="s3">,</span>
                            <span class="s1">effsize=</span><span class="s4">0.0573842557922749</span><span class="s3">,</span>
                            <span class="s1">)</span>

        <span class="s0"># from library onewaytests</span>
        <span class="s0"># &gt; bft = bf.test(y ~ g, df3)</span>
        <span class="s1">cls.res_bfm = Holder(statistic=</span><span class="s4">7.10900606421182</span><span class="s3">,</span>
                             <span class="s1">parameter=np.array([</span><span class="s4">2</span><span class="s3">, </span><span class="s4">31.4207256105052</span><span class="s1">])</span><span class="s3">,</span>
                             <span class="s1">p_value=</span><span class="s4">0.00283841965791224</span><span class="s3">,</span>
                             <span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                             <span class="s1">method=</span><span class="s5">'Brown-Forsythe Test'</span>
                             <span class="s1">)</span>

        <span class="s0"># &gt; oww = oneway.test(y ~ g, df3, var.equal = FALSE)</span>
        <span class="s1">cls.res_wa = Holder(statistic=</span><span class="s4">8.02355212103924</span><span class="s3">,</span>
                            <span class="s1">parameter=np.array([</span><span class="s4">2</span><span class="s3">, </span><span class="s4">24.272320628139</span><span class="s1">])</span><span class="s3">,</span>
                            <span class="s1">p_value=</span><span class="s4">0.00211423625518082</span><span class="s3">,</span>
                            <span class="s1">method=(</span><span class="s5">'One-way analysis of means '</span>
                                    <span class="s5">'(not assuming equal variances)'</span><span class="s1">)</span>
                            <span class="s1">)</span>

        <span class="s0"># &gt; ow = oneway.test(y ~ g, df3, var.equal = TRUE)</span>
        <span class="s1">cls.res_fa = Holder(statistic=</span><span class="s4">7.47403193349076</span><span class="s3">,</span>
                            <span class="s1">parameter=np.array([</span><span class="s4">2</span><span class="s3">, </span><span class="s4">40</span><span class="s1">])</span><span class="s3">,</span>
                            <span class="s1">p_value=</span><span class="s4">0.00174643304119871</span><span class="s3">,</span>
                            <span class="s1">method=</span><span class="s5">'One-way analysis of means'</span>
                            <span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_oneway(self):</span>
        <span class="s1">r1 = self.res_oneway</span>
        <span class="s1">r2s = self.res_2s</span>
        <span class="s1">res_bfm = self.res_bfm</span>
        <span class="s1">res_wa = self.res_wa</span>
        <span class="s1">res_fa = self.res_fa</span>

        <span class="s0"># check we got the correct data</span>
        <span class="s1">m = [x_i.mean() </span><span class="s3">for </span><span class="s1">x_i </span><span class="s3">in </span><span class="s1">self.x]</span>
        <span class="s1">assert_allclose(m</span><span class="s3">, </span><span class="s1">self.res_m</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s0"># 3 sample case</span>
        <span class="s1">resg = smo.anova_oneway(self.x</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s3">, </span><span class="s1">trim_frac=</span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">13</span><span class="s1">)</span>
        <span class="s0"># assert_allclose(res.statistic, res_bfm.statistic, rtol=1e-13)</span>
        <span class="s1">assert_allclose(resg.pvalue</span><span class="s3">, </span><span class="s1">r1.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(resg.df</span><span class="s3">, </span><span class="s1">[r1.df1</span><span class="s3">, </span><span class="s1">r1.df2]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)  </span><span class="s0"># df</span>

        <span class="s0"># 2-sample against yuen t-test</span>
        <span class="s1">resg = smo.anova_oneway(self.x[:</span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s3">,</span>
                                <span class="s1">trim_frac=</span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">13</span><span class="s1">)</span>
        <span class="s0"># assert_allclose(res.statistic, res_bfm.statistic, rtol=1e-13)</span>
        <span class="s1">assert_allclose(resg.pvalue</span><span class="s3">, </span><span class="s1">r2s.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(resg.df</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s1">r2s.df]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)  </span><span class="s0"># df</span>

        <span class="s0"># no trimming bfm</span>
        <span class="s1">res = smo.anova_oneway(self.x</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;bf&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res_bfm.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue2</span><span class="s3">, </span><span class="s1">res_bfm.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df2</span><span class="s3">, </span><span class="s1">res_bfm.parameter</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)  </span><span class="s0"># df</span>

        <span class="s0"># no trimming welch</span>
        <span class="s1">res = smo.anova_oneway(self.x</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res_wa.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res_wa.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res_wa.parameter</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)  </span><span class="s0"># df</span>

        <span class="s0"># no trimming standard anova</span>
        <span class="s1">res = smo.anova_oneway(self.x</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res_fa.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res_fa.p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res_fa.parameter</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)  </span><span class="s0"># df</span>
</pre>
</body>
</html>