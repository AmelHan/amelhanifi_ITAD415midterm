<html>
<head>
<title>test_highlevel.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_highlevel.py</font>
</center></td></tr></table>
<pre><span class="s0"># This file is part of Patsy</span>
<span class="s0"># Copyright (C) 2012-2013 Nathaniel Smith &lt;njs@pobox.com&gt;</span>
<span class="s0"># See file LICENSE.txt for license information.</span>

<span class="s0"># Exhaustive end-to-end tests of the top-level API.</span>

<span class="s2">import </span><span class="s1">sys</span>
<span class="s2">import </span><span class="s1">__future__</span>
<span class="s2">import </span><span class="s1">six</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">patsy </span><span class="s2">import </span><span class="s1">PatsyError</span>
<span class="s2">from </span><span class="s1">patsy.design_info </span><span class="s2">import </span><span class="s1">DesignMatrix</span><span class="s2">, </span><span class="s1">DesignInfo</span>
<span class="s2">from </span><span class="s1">patsy.eval </span><span class="s2">import </span><span class="s1">EvalEnvironment</span>
<span class="s2">from </span><span class="s1">patsy.desc </span><span class="s2">import </span><span class="s1">ModelDesc</span><span class="s2">, </span><span class="s1">Term</span><span class="s2">, </span><span class="s1">INTERCEPT</span>
<span class="s2">from </span><span class="s1">patsy.categorical </span><span class="s2">import </span><span class="s1">C</span>
<span class="s2">from </span><span class="s1">patsy.contrasts </span><span class="s2">import </span><span class="s1">Helmert</span>
<span class="s2">from </span><span class="s1">patsy.user_util </span><span class="s2">import </span><span class="s1">balanced</span><span class="s2">, </span><span class="s1">LookupFactor</span>
<span class="s2">from </span><span class="s1">patsy.build </span><span class="s2">import </span><span class="s1">(design_matrix_builders</span><span class="s2">,</span>
                         <span class="s1">build_design_matrices)</span>
<span class="s2">from </span><span class="s1">patsy.highlevel </span><span class="s2">import </span><span class="s1">*</span>
<span class="s2">from </span><span class="s1">patsy.util </span><span class="s2">import </span><span class="s1">(have_pandas</span><span class="s2">,</span>
                        <span class="s1">have_pandas_categorical</span><span class="s2">,</span>
                        <span class="s1">have_pandas_categorical_dtype</span><span class="s2">,</span>
                        <span class="s1">pandas_Categorical_from_codes)</span>
<span class="s2">from </span><span class="s1">patsy.origin </span><span class="s2">import </span><span class="s1">Origin</span>

<span class="s2">if </span><span class="s1">have_pandas:</span>
    <span class="s2">import </span><span class="s1">pandas</span>

<span class="s2">def </span><span class="s1">check_result(expect_full_designs</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">data</span><span class="s2">,</span>
                 <span class="s1">expected_rhs_values</span><span class="s2">, </span><span class="s1">expected_rhs_names</span><span class="s2">,</span>
                 <span class="s1">expected_lhs_values</span><span class="s2">, </span><span class="s1">expected_lhs_names): </span><span class="s0"># pragma: no cover</span>
    <span class="s2">assert </span><span class="s1">np.allclose(rhs</span><span class="s2">, </span><span class="s1">expected_rhs_values)</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.column_names == expected_rhs_names</span>
    <span class="s2">if </span><span class="s1">lhs </span><span class="s2">is not None</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">np.allclose(lhs</span><span class="s2">, </span><span class="s1">expected_lhs_values)</span>
        <span class="s2">assert </span><span class="s1">lhs.design_info.column_names == expected_lhs_names</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">expected_lhs_values </span><span class="s2">is None</span>
        <span class="s2">assert </span><span class="s1">expected_lhs_names </span><span class="s2">is None</span>

    <span class="s2">if </span><span class="s1">expect_full_designs:</span>
        <span class="s2">if </span><span class="s1">lhs </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s1">new_rhs</span><span class="s2">, </span><span class="s1">= build_design_matrices([rhs.design_info]</span><span class="s2">, </span><span class="s1">data)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">new_lhs</span><span class="s2">, </span><span class="s1">new_rhs = build_design_matrices([lhs.design_info</span><span class="s2">,</span>
                                                      <span class="s1">rhs.design_info]</span><span class="s2">,</span>
                                                     <span class="s1">data)</span>
            <span class="s2">assert </span><span class="s1">np.allclose(new_lhs</span><span class="s2">, </span><span class="s1">lhs)</span>
            <span class="s2">assert </span><span class="s1">new_lhs.design_info.column_names == expected_lhs_names</span>
        <span class="s2">assert </span><span class="s1">np.allclose(new_rhs</span><span class="s2">, </span><span class="s1">rhs)</span>
        <span class="s2">assert </span><span class="s1">new_rhs.design_info.column_names == expected_rhs_names</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">rhs.design_info.terms </span><span class="s2">is None</span>
        <span class="s2">assert </span><span class="s1">lhs </span><span class="s2">is None or </span><span class="s1">lhs.design_info.terms </span><span class="s2">is None</span>

<span class="s2">def </span><span class="s1">dmatrix_pandas(formula_like</span><span class="s2">, </span><span class="s1">data={}</span><span class="s2">, </span><span class="s1">depth=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;matrix&quot;</span><span class="s1">):</span>
    <span class="s1">return_type = </span><span class="s4">&quot;dataframe&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance(depth</span><span class="s2">, </span><span class="s1">int):</span>
        <span class="s1">depth += </span><span class="s3">1</span>
    <span class="s2">return </span><span class="s1">dmatrix(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">, </span><span class="s1">return_type=return_type)</span>

<span class="s2">def </span><span class="s1">dmatrices_pandas(formula_like</span><span class="s2">, </span><span class="s1">data={}</span><span class="s2">, </span><span class="s1">depth=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;matrix&quot;</span><span class="s1">):</span>
    <span class="s1">return_type = </span><span class="s4">&quot;dataframe&quot;</span>
    <span class="s2">if </span><span class="s1">isinstance(depth</span><span class="s2">, </span><span class="s1">int):</span>
        <span class="s1">depth += </span><span class="s3">1</span>
    <span class="s2">return </span><span class="s1">dmatrices(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">, </span><span class="s1">return_type=return_type)</span>

<span class="s2">def </span><span class="s1">t(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">,</span>
      <span class="s1">expect_full_designs</span><span class="s2">,</span>
      <span class="s1">expected_rhs_values</span><span class="s2">, </span><span class="s1">expected_rhs_names</span><span class="s2">,</span>
      <span class="s1">expected_lhs_values=</span><span class="s2">None, </span><span class="s1">expected_lhs_names=</span><span class="s2">None</span><span class="s1">): </span><span class="s0"># pragma: no cover</span>
    <span class="s2">if </span><span class="s1">isinstance(depth</span><span class="s2">, </span><span class="s1">int):</span>
        <span class="s1">depth += </span><span class="s3">1</span>
    <span class="s2">def </span><span class="s1">data_iter_maker():</span>
        <span class="s2">return </span><span class="s1">iter([data])</span>
    <span class="s2">if </span><span class="s1">(isinstance(formula_like</span><span class="s2">, </span><span class="s1">six.string_types + (ModelDesc</span><span class="s2">, </span><span class="s1">DesignInfo))</span>
        <span class="s2">or </span><span class="s1">(isinstance(formula_like</span><span class="s2">, </span><span class="s1">tuple)</span>
            <span class="s2">and </span><span class="s1">isinstance(formula_like[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">DesignInfo))</span>
        <span class="s2">or </span><span class="s1">hasattr(formula_like</span><span class="s2">, </span><span class="s4">&quot;__patsy_get_model_desc__&quot;</span><span class="s1">)):</span>
        <span class="s2">if </span><span class="s1">expected_lhs_values </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s1">builder = incr_dbuilder(formula_like</span><span class="s2">, </span><span class="s1">data_iter_maker</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s1">lhs = </span><span class="s2">None</span>
            <span class="s1">(rhs</span><span class="s2">,</span><span class="s1">) = build_design_matrices([builder]</span><span class="s2">, </span><span class="s1">data)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">builders = incr_dbuilders(formula_like</span><span class="s2">, </span><span class="s1">data_iter_maker</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs = build_design_matrices(builders</span><span class="s2">, </span><span class="s1">data)</span>
        <span class="s1">check_result(expect_full_designs</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">data</span><span class="s2">,</span>
                     <span class="s1">expected_rhs_values</span><span class="s2">, </span><span class="s1">expected_rhs_names</span><span class="s2">,</span>
                     <span class="s1">expected_lhs_values</span><span class="s2">, </span><span class="s1">expected_lhs_names)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">incr_dbuilders</span><span class="s2">,</span>
                      <span class="s1">formula_like</span><span class="s2">, </span><span class="s1">data_iter_maker)</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">incr_dbuilder</span><span class="s2">,</span>
                      <span class="s1">formula_like</span><span class="s2">, </span><span class="s1">data_iter_maker)</span>
    <span class="s1">one_mat_fs = [dmatrix]</span>
    <span class="s1">two_mat_fs = [dmatrices]</span>
    <span class="s2">if </span><span class="s1">have_pandas:</span>
        <span class="s1">one_mat_fs.append(dmatrix_pandas)</span>
        <span class="s1">two_mat_fs.append(dmatrices_pandas)</span>
    <span class="s2">if </span><span class="s1">expected_lhs_values </span><span class="s2">is None</span><span class="s1">:</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">one_mat_fs:</span>
            <span class="s1">rhs = f(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s1">check_result(expect_full_designs</span><span class="s2">, None, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">data</span><span class="s2">,</span>
                         <span class="s1">expected_rhs_values</span><span class="s2">, </span><span class="s1">expected_rhs_names</span><span class="s2">,</span>
                         <span class="s1">expected_lhs_values</span><span class="s2">, </span><span class="s1">expected_lhs_names)</span>

        <span class="s0"># We inline assert_raises here to avoid complications with the</span>
        <span class="s0"># depth argument.</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">two_mat_fs:</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">f(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s2">except </span><span class="s1">PatsyError:</span>
                <span class="s2">pass</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s2">raise </span><span class="s1">AssertionError</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">one_mat_fs:</span>
            <span class="s2">try</span><span class="s1">:</span>
                <span class="s1">f(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s2">except </span><span class="s1">PatsyError:</span>
                <span class="s2">pass</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s2">raise </span><span class="s1">AssertionError</span>

        <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">two_mat_fs:</span>
            <span class="s1">(lhs</span><span class="s2">, </span><span class="s1">rhs) = f(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth)</span>
            <span class="s1">check_result(expect_full_designs</span><span class="s2">, </span><span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs</span><span class="s2">, </span><span class="s1">data</span><span class="s2">,</span>
                         <span class="s1">expected_rhs_values</span><span class="s2">, </span><span class="s1">expected_rhs_names</span><span class="s2">,</span>
                         <span class="s1">expected_lhs_values</span><span class="s2">, </span><span class="s1">expected_lhs_names)</span>

<span class="s2">def </span><span class="s1">t_invalid(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth</span><span class="s2">, </span><span class="s1">exc=PatsyError): </span><span class="s0"># pragma: no cover</span>
    <span class="s2">if </span><span class="s1">isinstance(depth</span><span class="s2">, </span><span class="s1">int):</span>
        <span class="s1">depth += </span><span class="s3">1</span>
    <span class="s1">fs = [dmatrix</span><span class="s2">, </span><span class="s1">dmatrices]</span>
    <span class="s2">if </span><span class="s1">have_pandas:</span>
        <span class="s1">fs += [dmatrix_pandas</span><span class="s2">, </span><span class="s1">dmatrices_pandas]</span>
    <span class="s2">for </span><span class="s1">f </span><span class="s2">in </span><span class="s1">fs:</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s1">f(formula_like</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s1">depth)</span>
        <span class="s2">except </span><span class="s1">exc:</span>
            <span class="s2">pass</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">raise </span><span class="s1">AssertionError</span>

<span class="s0"># Exercise all the different calling conventions for the high-level API</span>
<span class="s2">def </span><span class="s1">test_formula_likes():</span>
    <span class="s0"># Plain array-like, rhs only</span>
    <span class="s1">t([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t((</span><span class="s2">None, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t(np.asarray([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t((</span><span class="s2">None, </span><span class="s1">np.asarray([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">dm = DesignMatrix([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">default_column_prefix=</span><span class="s4">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">t(dm</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;foo0&quot;</span><span class="s2">, </span><span class="s4">&quot;foo1&quot;</span><span class="s2">, </span><span class="s4">&quot;foo2&quot;</span><span class="s1">])</span>
    <span class="s1">t((</span><span class="s2">None, </span><span class="s1">dm)</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;foo0&quot;</span><span class="s2">, </span><span class="s4">&quot;foo1&quot;</span><span class="s2">, </span><span class="s4">&quot;foo2&quot;</span><span class="s1">])</span>

    <span class="s0"># Plain array-likes, lhs and rhs</span>
    <span class="s1">t(([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y0&quot;</span><span class="s1">])</span>
    <span class="s1">t(([[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y0&quot;</span><span class="s1">])</span>
    <span class="s1">t((np.asarray([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">])</span><span class="s2">, </span><span class="s1">np.asarray([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y0&quot;</span><span class="s1">])</span>
    <span class="s1">t((np.asarray([[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">np.asarray([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y0&quot;</span><span class="s1">])</span>
    <span class="s1">x_dm = DesignMatrix([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">default_column_prefix=</span><span class="s4">&quot;foo&quot;</span><span class="s1">)</span>
    <span class="s1">y_dm = DesignMatrix([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">default_column_prefix=</span><span class="s4">&quot;bar&quot;</span><span class="s1">)</span>
    <span class="s1">t((y_dm</span><span class="s2">, </span><span class="s1">x_dm)</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">False,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;foo0&quot;</span><span class="s2">, </span><span class="s4">&quot;foo1&quot;</span><span class="s2">, </span><span class="s4">&quot;foo2&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;bar0&quot;</span><span class="s1">])</span>
    <span class="s0"># number of rows must match</span>
    <span class="s1">t_invalid(([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0"># tuples must have the right size</span>
    <span class="s1">t_invalid(([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">,</span><span class="s1">)</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">t_invalid(([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0"># plain Series and DataFrames</span>
    <span class="s2">if </span><span class="s1">have_pandas:</span>
        <span class="s0"># Names are extracted</span>
        <span class="s1">t(pandas.DataFrame({</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]})</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
        <span class="s1">t(pandas.Series([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;asdf&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;asdf&quot;</span><span class="s1">])</span>
        <span class="s1">t((pandas.DataFrame({</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]})</span><span class="s2">,</span>
           <span class="s1">pandas.DataFrame({</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]}))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
          <span class="s1">[[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s1">t((pandas.Series([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;y&quot;</span><span class="s1">)</span><span class="s2">,</span>
           <span class="s1">pandas.Series([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;x&quot;</span><span class="s1">))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
          <span class="s1">[[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s0"># Or invented</span>
        <span class="s1">t((pandas.DataFrame([[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]])</span><span class="s2">,</span>
           <span class="s1">pandas.DataFrame([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s1">]))</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x7&quot;</span><span class="s2">, </span><span class="s4">&quot;x8&quot;</span><span class="s2">, </span><span class="s4">&quot;x9&quot;</span><span class="s1">]</span><span class="s2">,</span>
          <span class="s1">[[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y0&quot;</span><span class="s2">, </span><span class="s4">&quot;y1&quot;</span><span class="s2">, </span><span class="s4">&quot;y2&quot;</span><span class="s1">])</span>
        <span class="s1">t(pandas.Series([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">])</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">False,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x0&quot;</span><span class="s1">])</span>
        <span class="s0"># indices must match</span>
        <span class="s1">t_invalid((pandas.DataFrame([[</span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s1">])</span><span class="s2">,</span>
                   <span class="s1">pandas.DataFrame([[</span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s3">2</span><span class="s1">]))</span><span class="s2">,</span>
                  <span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0"># Foreign ModelDesc factories</span>
    <span class="s2">class </span><span class="s1">ForeignModelSource(object):</span>
        <span class="s2">def </span><span class="s1">__patsy_get_model_desc__(self</span><span class="s2">, </span><span class="s1">data):</span>
            <span class="s2">return </span><span class="s1">ModelDesc([Term([LookupFactor(</span><span class="s4">&quot;Y&quot;</span><span class="s1">)])]</span><span class="s2">,</span>
                             <span class="s1">[Term([LookupFactor(</span><span class="s4">&quot;X&quot;</span><span class="s1">)])])</span>
    <span class="s1">foreign_model = ForeignModelSource()</span>
    <span class="s1">t(foreign_model</span><span class="s2">,</span>
      <span class="s1">{</span><span class="s4">&quot;Y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s4">&quot;X&quot;</span><span class="s1">: [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]}</span><span class="s2">,</span>
      <span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;X[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;X[1]&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Y&quot;</span><span class="s1">])</span>
    <span class="s2">class </span><span class="s1">BadForeignModelSource(object):</span>
        <span class="s2">def </span><span class="s1">__patsy_get_model_desc__(self</span><span class="s2">, </span><span class="s1">data):</span>
            <span class="s2">return </span><span class="s1">data</span>
    <span class="s1">t_invalid(BadForeignModelSource()</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0"># string formulas</span>
    <span class="s1">t(</span><span class="s4">&quot;y ~ x&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ x&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;x + y&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>

    <span class="s0"># unicode objects on py2 (must be ascii only)</span>
    <span class="s2">if not </span><span class="s1">six.PY3:</span>
        <span class="s0"># ascii is fine</span>
        <span class="s1">t(unicode(</span><span class="s4">&quot;y ~ x&quot;</span><span class="s1">)</span><span class="s2">,</span>
          <span class="s1">{</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
          <span class="s2">True,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>
        <span class="s0"># non-ascii is not (even if this would be valid on py3 with its less</span>
        <span class="s0"># restrict variable naming rules)</span>
        <span class="s1">eacute = </span><span class="s4">&quot;</span><span class="s2">\xc3\xa9</span><span class="s4">&quot;</span><span class="s1">.decode(</span><span class="s4">&quot;utf-8&quot;</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">isinstance(eacute</span><span class="s2">, </span><span class="s1">unicode)</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">dmatrix</span><span class="s2">, </span><span class="s1">eacute</span><span class="s2">, </span><span class="s1">data={eacute: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]})</span>

    <span class="s0"># ModelDesc</span>
    <span class="s1">desc = ModelDesc([]</span><span class="s2">, </span><span class="s1">[Term([LookupFactor(</span><span class="s4">&quot;x&quot;</span><span class="s1">)])])</span>
    <span class="s1">t(desc</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3.5</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s1">desc = ModelDesc([]</span><span class="s2">, </span><span class="s1">[Term([])</span><span class="s2">, </span><span class="s1">Term([LookupFactor(</span><span class="s4">&quot;x&quot;</span><span class="s1">)])])</span>
    <span class="s1">t(desc</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3.5</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s1">desc = ModelDesc([Term([LookupFactor(</span><span class="s4">&quot;y&quot;</span><span class="s1">)])]</span><span class="s2">,</span>
                     <span class="s1">[Term([])</span><span class="s2">, </span><span class="s1">Term([LookupFactor(</span><span class="s4">&quot;x&quot;</span><span class="s1">)])])</span>
    <span class="s1">t(desc</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1.5</span><span class="s2">, </span><span class="s3">2.5</span><span class="s2">, </span><span class="s3">3.5</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3.5</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;y&quot;</span><span class="s1">])</span>

    <span class="s0"># builders</span>
    <span class="s1">termlists = ([]</span><span class="s2">,</span>
                 <span class="s1">[Term([LookupFactor(</span><span class="s4">&quot;x&quot;</span><span class="s1">)])]</span><span class="s2">,</span>
                 <span class="s1">[Term([])</span><span class="s2">, </span><span class="s1">Term([LookupFactor(</span><span class="s4">&quot;x&quot;</span><span class="s1">)])]</span><span class="s2">,</span>
                 <span class="s1">)</span>
    <span class="s1">builders = design_matrix_builders(termlists</span><span class="s2">,</span>
                                      <span class="s2">lambda</span><span class="s1">: iter([{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]}])</span><span class="s2">,</span>
                                      <span class="s1">eval_env=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0"># twople but with no LHS</span>
    <span class="s1">t((builders[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">builders[</span><span class="s3">2</span><span class="s1">])</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s0"># single DesignInfo</span>
    <span class="s1">t(builders[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>
    <span class="s0"># twople with LHS</span>
    <span class="s1">t((builders[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">builders[</span><span class="s3">2</span><span class="s1">])</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s1">]</span><span class="s2">,</span>
      <span class="s1">[[</span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;x&quot;</span><span class="s1">])</span>

    <span class="s0"># check depth arguments</span>
    <span class="s1">x_in_env = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">t(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x_in_env&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x_in_env&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x_in_env&quot;</span><span class="s1">])</span>
    <span class="s0"># Trying to pull x_in_env out of our *caller* shouldn't work.</span>
    <span class="s1">t_invalid(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">exc=(NameError</span><span class="s2">, </span><span class="s1">PatsyError))</span>
    <span class="s0"># But then again it should, if called from one down on the stack:</span>
    <span class="s2">def </span><span class="s1">check_nested_call():</span>
        <span class="s1">x_in_env = </span><span class="s4">&quot;asdf&quot;</span>
        <span class="s1">t(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
          <span class="s2">True,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x_in_env&quot;</span><span class="s1">])</span>
    <span class="s1">check_nested_call()</span>
    <span class="s0"># passing in an explicit EvalEnvironment also works:</span>
    <span class="s1">e = EvalEnvironment.capture(</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">t_invalid(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s1">e</span><span class="s2">, </span><span class="s1">exc=(NameError</span><span class="s2">, </span><span class="s1">PatsyError))</span>
    <span class="s1">e = EvalEnvironment.capture(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s2">def </span><span class="s1">check_nested_call_2():</span>
        <span class="s1">x_in_env = </span><span class="s4">&quot;asdf&quot;</span>
        <span class="s1">t(</span><span class="s4">&quot;~ x_in_env&quot;</span><span class="s2">, </span><span class="s1">{}</span><span class="s2">, </span><span class="s1">e</span><span class="s2">,</span>
          <span class="s2">True,</span>
          <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;x_in_env&quot;</span><span class="s1">])</span>
    <span class="s1">check_nested_call_2()</span>

<span class="s2">def </span><span class="s1">test_return_pandas():</span>
    <span class="s2">if not </span><span class="s1">have_pandas:</span>
        <span class="s2">return</span>
    <span class="s0"># basic check of pulling a Series out of the environment</span>
    <span class="s1">s1 = pandas.Series([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;AA&quot;</span><span class="s2">, </span><span class="s1">index=[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s1">s2 = pandas.Series([</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">&quot;BB&quot;</span><span class="s2">, </span><span class="s1">index=[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s1">df1 = dmatrix(</span><span class="s4">&quot;s1&quot;</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df1</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df1.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df1.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df1.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s1">df2</span><span class="s2">, </span><span class="s1">df3 = dmatrices(</span><span class="s4">&quot;s2 ~ s1&quot;</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df2</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df2.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;s2&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df2.design_info.column_names == [</span><span class="s4">&quot;s2&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df2.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df3</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df3.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df3.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;s1&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df3.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s0"># indices are preserved if pandas is passed in directly</span>
    <span class="s1">df4 = dmatrix(s1</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df4</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df4.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;AA&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df4.design_info.column_names == [</span><span class="s4">&quot;AA&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df4.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s1">df5</span><span class="s2">, </span><span class="s1">df6 = dmatrices((s2</span><span class="s2">, </span><span class="s1">s1)</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df5</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df5.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;BB&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df5.design_info.column_names == [</span><span class="s4">&quot;BB&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df5.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">np.allclose(df6</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df6.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;AA&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">df6.design_info.column_names == [</span><span class="s4">&quot;AA&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df6.index</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">])</span>
    <span class="s0"># Both combinations of with-index and without-index</span>
    <span class="s1">df7</span><span class="s2">, </span><span class="s1">df8 = dmatrices((s1</span><span class="s2">, </span><span class="s1">[</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">12</span><span class="s1">])</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df7.index</span><span class="s2">, </span><span class="s1">s1.index)</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df8.index</span><span class="s2">, </span><span class="s1">s1.index)</span>
    <span class="s1">df9</span><span class="s2">, </span><span class="s1">df10 = dmatrices(([</span><span class="s3">10</span><span class="s2">, </span><span class="s3">11</span><span class="s2">, </span><span class="s3">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">s1)</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df9.index</span><span class="s2">, </span><span class="s1">s1.index)</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(df10.index</span><span class="s2">, </span><span class="s1">s1.index)</span>
    <span class="s0"># pandas must be available</span>
    <span class="s2">import </span><span class="s1">patsy.highlevel</span>
    <span class="s1">had_pandas = patsy.highlevel.have_pandas</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">patsy.highlevel.have_pandas = </span><span class="s2">False</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">,</span>
                      <span class="s1">dmatrix</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">,</span>
                      <span class="s1">dmatrices</span><span class="s2">, </span><span class="s4">&quot;y ~ x&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">2</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
                      <span class="s1">return_type=</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>
    <span class="s2">finally</span><span class="s1">:</span>
        <span class="s1">patsy.highlevel.have_pandas = had_pandas</span>

<span class="s2">def </span><span class="s1">test_term_info():</span>
    <span class="s1">data = balanced(a=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">b=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">rhs = dmatrix(</span><span class="s4">&quot;a:b&quot;</span><span class="s2">, </span><span class="s1">data)</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;b[T.b2]&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;a[T.a2]:b[b1]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[T.a2]:b[b2]&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.term_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a:b&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">len(rhs.design_info.terms) == </span><span class="s3">2</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.terms[</span><span class="s3">0</span><span class="s1">] == INTERCEPT</span>

<span class="s2">def </span><span class="s1">test_data_types():</span>
    <span class="s1">data = {</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">2.0</span><span class="s2">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;c&quot;</span><span class="s1">: np.asarray([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=np.float32)</span><span class="s2">,</span>
            <span class="s4">&quot;d&quot;</span><span class="s1">: [</span><span class="s2">True, False, True</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;e&quot;</span><span class="s1">: [</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;baz&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;f&quot;</span><span class="s1">: C([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s4">&quot;g&quot;</span><span class="s1">: C([</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s4">&quot;bar&quot;</span><span class="s2">, </span><span class="s4">&quot;baz&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s4">&quot;h&quot;</span><span class="s1">: np.array([</span><span class="s4">&quot;foo&quot;</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">(</span><span class="s3">1</span><span class="s2">, </span><span class="s4">&quot;hi&quot;</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
            <span class="s1">}</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + a&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + b&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + c&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + d&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d[False]&quot;</span><span class="s2">, </span><span class="s4">&quot;d[True]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + e&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;e[bar]&quot;</span><span class="s2">, </span><span class="s4">&quot;e[baz]&quot;</span><span class="s2">, </span><span class="s4">&quot;e[foo]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + f&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;f[1]&quot;</span><span class="s2">, </span><span class="s4">&quot;f[2]&quot;</span><span class="s2">, </span><span class="s4">&quot;f[3]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + g&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;g[bar]&quot;</span><span class="s2">, </span><span class="s4">&quot;g[baz]&quot;</span><span class="s2">, </span><span class="s4">&quot;g[foo]&quot;</span><span class="s1">])</span>
    <span class="s0"># This depends on Python's sorting behavior:</span>
    <span class="s1">t(</span><span class="s4">&quot;~ 0 + h&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, True,</span>
      <span class="s1">[[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;h[1]&quot;</span><span class="s2">, </span><span class="s4">&quot;h[foo]&quot;</span><span class="s2">, </span><span class="s4">&quot;h[(1, 'hi')]&quot;</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_categorical():</span>
    <span class="s1">data = balanced(a=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">b=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0"># There are more exhaustive tests for all the different coding options in</span>
    <span class="s0"># test_build; let's just make sure that C() and stuff works.</span>
    <span class="s1">t(</span><span class="s4">&quot;~ C(a)&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;C(a)[T.a2]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ C(a, levels=['a2', 'a1'])&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;C(a, levels=['a2', 'a1'])[T.a1]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;~ C(a, Treatment(reference=-1))&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;C(a, Treatment(reference=-1))[T.a1]&quot;</span><span class="s1">])</span>

    <span class="s0"># Different interactions</span>
    <span class="s1">t(</span><span class="s4">&quot;a*b&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a[T.a2]&quot;</span><span class="s2">, </span><span class="s4">&quot;b[T.b2]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[T.a2]:b[T.b2]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;0 + a:b&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;a[a1]:b[b1]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a2]:b[b1]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a1]:b[b2]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a2]:b[b2]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;1 + a + a:b&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a[T.a2]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a1]:b[T.b2]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a2]:b[T.b2]&quot;</span><span class="s1">])</span>

    <span class="s0"># Changing contrast with C()</span>
    <span class="s1">data[</span><span class="s4">&quot;a&quot;</span><span class="s1">] = C(data[</span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">Helmert)</span>
    <span class="s1">t(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a[H.a2]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;C(a, Treatment)&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;C(a, Treatment)[T.a2]&quot;</span><span class="s1">])</span>
    <span class="s0"># That didn't affect the original object</span>
    <span class="s1">t(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a[H.a2]&quot;</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_builtins():</span>
    <span class="s1">data = {</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;a b c&quot;</span><span class="s1">: [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]}</span>
    <span class="s1">t(</span><span class="s4">&quot;0 + I(x + y)&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;I(x + y)&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;Q('a b c')&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;Q('a b c')&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;center(x)&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;center(x)&quot;</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_incremental():</span>
    <span class="s0"># incr_dbuilder(s)</span>
    <span class="s0"># stateful transformations</span>
    <span class="s1">datas = [</span>
        <span class="s1">{</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">&quot;a2&quot;</span><span class="s2">, </span><span class="s4">&quot;a2&quot;</span><span class="s2">, </span><span class="s4">&quot;a2&quot;</span><span class="s1">]</span><span class="s2">,</span>
         <span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]}</span><span class="s2">,</span>
        <span class="s1">{</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">&quot;a2&quot;</span><span class="s2">, </span><span class="s4">&quot;a2&quot;</span><span class="s2">, </span><span class="s4">&quot;a1&quot;</span><span class="s1">]</span><span class="s2">,</span>
         <span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">x = np.asarray([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">])</span>
    <span class="s1">sin_center_x = np.sin(x - np.mean(x))</span>
    <span class="s1">x_col = sin_center_x - np.mean(sin_center_x)</span>
    <span class="s2">def </span><span class="s1">data_iter_maker():</span>
        <span class="s2">return </span><span class="s1">iter(datas)</span>
    <span class="s1">builders = incr_dbuilders(</span><span class="s4">&quot;1 ~ a + center(np.sin(center(x)))&quot;</span><span class="s2">,</span>
                              <span class="s1">data_iter_maker)</span>
    <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs = build_design_matrices(builders</span><span class="s2">, </span><span class="s1">datas[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">lhs.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;a[T.a2]&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;center(np.sin(center(x)))&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.allclose(lhs</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.allclose(rhs</span><span class="s2">, </span><span class="s1">np.column_stack(([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                                             <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                                             <span class="s1">x_col[</span><span class="s3">3</span><span class="s1">:])))</span>

    <span class="s1">builder = incr_dbuilder(</span><span class="s4">&quot;~ a + center(np.sin(center(x)))&quot;</span><span class="s2">,</span>
                            <span class="s1">data_iter_maker)</span>
    <span class="s1">(rhs</span><span class="s2">,</span><span class="s1">) = build_design_matrices([builder]</span><span class="s2">, </span><span class="s1">datas[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.column_names == [</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;a[T.a2]&quot;</span><span class="s2">,</span>
                                            <span class="s4">&quot;center(np.sin(center(x)))&quot;</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.allclose(lhs</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.allclose(rhs</span><span class="s2">, </span><span class="s1">np.column_stack(([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                                             <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                                             <span class="s1">x_col[</span><span class="s3">3</span><span class="s1">:])))</span>

    <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">incr_dbuilder</span><span class="s2">, </span><span class="s4">&quot;x ~ x&quot;</span><span class="s2">, </span><span class="s1">data_iter_maker)</span>
    <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">incr_dbuilders</span><span class="s2">, </span><span class="s4">&quot;x&quot;</span><span class="s2">, </span><span class="s1">data_iter_maker)</span>

<span class="s2">def </span><span class="s1">test_env_transform():</span>
    <span class="s1">t(</span><span class="s4">&quot;~ np.sin(x)&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]}</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np.sin(</span><span class="s3">1</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np.sin(</span><span class="s3">2</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s1">np.sin(</span><span class="s3">3</span><span class="s1">)]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;np.sin(x)&quot;</span><span class="s1">])</span>

<span class="s0"># Term ordering:</span>
<span class="s0">#   1) all 0-order no-numeric</span>
<span class="s0">#   2) all 1st-order no-numeric</span>
<span class="s0">#   3) all 2nd-order no-numeric</span>
<span class="s0">#   4) ...</span>
<span class="s0">#   5) all 0-order with the first numeric interaction encountered</span>
<span class="s0">#   6) all 1st-order with the first numeric interaction encountered</span>
<span class="s0">#   7) ...</span>
<span class="s0">#   8) all 0-order with the second numeric interaction encountered</span>
<span class="s0">#   9) ...</span>
<span class="s2">def </span><span class="s1">test_term_order():</span>
    <span class="s1">data = balanced(a=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">b=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">data[</span><span class="s4">&quot;x1&quot;</span><span class="s1">] = np.linspace(</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">data[</span><span class="s4">&quot;x2&quot;</span><span class="s1">] = data[</span><span class="s4">&quot;x1&quot;</span><span class="s1">] ** </span><span class="s3">2</span>

    <span class="s2">def </span><span class="s1">t_terms(formula</span><span class="s2">, </span><span class="s1">order):</span>
        <span class="s1">m = dmatrix(formula</span><span class="s2">, </span><span class="s1">data)</span>
        <span class="s2">assert </span><span class="s1">m.design_info.term_names == order</span>

    <span class="s1">t_terms(</span><span class="s4">&quot;a + b + x1 + x2&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t_terms(</span><span class="s4">&quot;b + a + x2 + x1&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s1">])</span>
    <span class="s1">t_terms(</span><span class="s4">&quot;0 + x1 + a + x2 + b + 1&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t_terms(</span><span class="s4">&quot;0 + a:b + a + b + 1&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a:b&quot;</span><span class="s1">])</span>
    <span class="s1">t_terms(</span><span class="s4">&quot;a + a:x1 + x2 + x1 + b&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;x1&quot;</span><span class="s2">, </span><span class="s4">&quot;a:x1&quot;</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">])</span>
    <span class="s1">t_terms(</span><span class="s4">&quot;0 + a:x1:x2 + a + x2:x1:b + x2 + x1 + a:x1 + x1:x2 + x1:a:x2:a:b&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">,</span>
             <span class="s4">&quot;x1:x2&quot;</span><span class="s2">, </span><span class="s4">&quot;a:x1:x2&quot;</span><span class="s2">, </span><span class="s4">&quot;x2:x1:b&quot;</span><span class="s2">, </span><span class="s4">&quot;x1:a:x2:b&quot;</span><span class="s2">,</span>
             <span class="s4">&quot;x2&quot;</span><span class="s2">,</span>
             <span class="s4">&quot;x1&quot;</span><span class="s2">,</span>
             <span class="s4">&quot;a:x1&quot;</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">_check_division(expect_true_division): </span><span class="s0"># pragma: no cover</span>
    <span class="s0"># We evaluate the formula &quot;I(x / y)&quot; in our *caller's* scope, so the</span>
    <span class="s0"># result depends on whether our caller has done 'from __future__ import</span>
    <span class="s0"># division'.</span>
    <span class="s1">data = {</span><span class="s4">&quot;x&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span>
    <span class="s1">m = dmatrix(</span><span class="s4">&quot;0 + I(x / y)&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">expect_true_division:</span>
        <span class="s2">assert </span><span class="s1">np.allclose(m</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">2.5</span><span class="s1">]])</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert </span><span class="s1">np.allclose(m</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">2</span><span class="s1">]])</span>

<span class="s2">def </span><span class="s1">test_future():</span>
    <span class="s2">if </span><span class="s1">__future__.division.getMandatoryRelease() &lt; sys.version_info:</span>
        <span class="s0"># This is Python 3, where division is already default</span>
        <span class="s2">return</span>
    <span class="s0"># no __future__.division in this module's scope</span>
    <span class="s1">_check_division(</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s0"># create an execution context where __future__.division is in effect</span>
    <span class="s1">exec (</span><span class="s4">&quot;from __future__ import division</span><span class="s2">\n</span><span class="s4">&quot;</span>
          <span class="s4">&quot;_check_division(True)</span><span class="s2">\n</span><span class="s4">&quot;</span><span class="s1">)</span>

<span class="s2">def </span><span class="s1">test_multicolumn():</span>
    <span class="s1">data = {</span>
        <span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">&quot;a1&quot;</span><span class="s2">, </span><span class="s4">&quot;a2&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;X&quot;</span><span class="s1">: [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s4">&quot;Y&quot;</span><span class="s1">: [[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">t(</span><span class="s4">&quot;X*Y&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">1 </span><span class="s1">* </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2 </span><span class="s1">* </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1 </span><span class="s1">* </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4 </span><span class="s1">* </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">, </span><span class="s4">&quot;X[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;X[1]&quot;</span><span class="s2">, </span><span class="s4">&quot;Y[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;Y[1]&quot;</span><span class="s2">,</span>
       <span class="s4">&quot;X[0]:Y[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;X[1]:Y[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;X[0]:Y[1]&quot;</span><span class="s2">, </span><span class="s4">&quot;X[1]:Y[1]&quot;</span><span class="s1">])</span>
    <span class="s1">t(</span><span class="s4">&quot;a:X + Y&quot;</span><span class="s2">, </span><span class="s1">data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">,</span>
      <span class="s2">True,</span>
      <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
       <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
      <span class="s1">[</span><span class="s4">&quot;Intercept&quot;</span><span class="s2">,</span>
       <span class="s4">&quot;a[a1]:X[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a2]:X[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a1]:X[1]&quot;</span><span class="s2">, </span><span class="s4">&quot;a[a2]:X[1]&quot;</span><span class="s2">,</span>
       <span class="s4">&quot;Y[0]&quot;</span><span class="s2">, </span><span class="s4">&quot;Y[1]&quot;</span><span class="s1">])</span>

<span class="s2">def </span><span class="s1">test_dmatrix_dmatrices_no_data():</span>
    <span class="s1">x = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(</span><span class="s4">&quot;x&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs = dmatrices(</span><span class="s4">&quot;y ~ x&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.allclose(lhs</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">6</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.allclose(rhs</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span>

<span class="s2">def </span><span class="s1">test_designinfo_describe():</span>
    <span class="s1">lhs</span><span class="s2">, </span><span class="s1">rhs = dmatrices(</span><span class="s4">&quot;y ~ x + a&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;y&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
                                       <span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">,</span>
                                       <span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s4">&quot;a1&quot;</span><span class="s2">, </span><span class="s4">&quot;a2&quot;</span><span class="s2">, </span><span class="s4">&quot;a3&quot;</span><span class="s1">]})</span>
    <span class="s2">assert </span><span class="s1">lhs.design_info.describe() == </span><span class="s4">&quot;y&quot;</span>
    <span class="s2">assert </span><span class="s1">rhs.design_info.describe() == </span><span class="s4">&quot;1 + a + x&quot;</span>

<span class="s2">def </span><span class="s1">test_evalfactor_reraise():</span>
    <span class="s0"># This will produce a PatsyError, but buried inside the factor evaluation,</span>
    <span class="s0"># so the original code has no way to give it an appropriate origin=</span>
    <span class="s0"># attribute. EvalFactor should notice this, and add a useful origin:</span>
    <span class="s2">def </span><span class="s1">raise_patsy_error(x):</span>
        <span class="s2">raise </span><span class="s1">PatsyError(</span><span class="s4">&quot;WHEEEEEE&quot;</span><span class="s1">)</span>
    <span class="s1">formula = </span><span class="s4">&quot;raise_patsy_error(X) + Y&quot;</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">dmatrix(formula</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;X&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;Y&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s2">except </span><span class="s1">PatsyError </span><span class="s2">as </span><span class="s1">e:</span>
        <span class="s2">assert </span><span class="s1">e.origin == Origin(formula</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">formula.index(</span><span class="s4">&quot; &quot;</span><span class="s1">))</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert False</span>
    <span class="s0"># This will produce a KeyError, which on Python 3 we can do wrap without</span>
    <span class="s0"># destroying the traceback, so we do so. On Python 2 we let the original</span>
    <span class="s0"># exception escape.</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s1">dmatrix(</span><span class="s4">&quot;1 + x[1]&quot;</span><span class="s2">, </span><span class="s1">{</span><span class="s4">&quot;x&quot;</span><span class="s1">: {}})</span>
    <span class="s2">except </span><span class="s1">Exception </span><span class="s2">as </span><span class="s1">e:</span>
        <span class="s2">if </span><span class="s1">sys.version_info[</span><span class="s3">0</span><span class="s1">] &gt;= </span><span class="s3">3</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">isinstance(e</span><span class="s2">, </span><span class="s1">PatsyError)</span>
            <span class="s2">assert </span><span class="s1">e.origin == Origin(</span><span class="s4">&quot;1 + x[1]&quot;</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">isinstance(e</span><span class="s2">, </span><span class="s1">KeyError)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s2">assert False</span>

<span class="s2">def </span><span class="s1">test_dmatrix_NA_action():</span>
    <span class="s1">data = {</span><span class="s4">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">np.nan]</span><span class="s2">, </span><span class="s4">&quot;y&quot;</span><span class="s1">: [np.nan</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s2">, </span><span class="s3">40</span><span class="s1">]}</span>

    <span class="s1">return_types = [</span><span class="s4">&quot;matrix&quot;</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">have_pandas:</span>
        <span class="s1">return_types.append(</span><span class="s4">&quot;dataframe&quot;</span><span class="s1">)</span>

    <span class="s2">for </span><span class="s1">return_type </span><span class="s2">in </span><span class="s1">return_types:</span>
        <span class="s1">mat = dmatrix(</span><span class="s4">&quot;x + y&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">return_type=return_type)</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(mat</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">20</span><span class="s1">]</span><span class="s2">,</span>
                                    <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]])</span>
        <span class="s2">if </span><span class="s1">return_type == </span><span class="s4">&quot;dataframe&quot;</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">mat.index.equals(pandas.Index([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">, </span><span class="s1">dmatrix</span><span class="s2">, </span><span class="s4">&quot;x + y&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">,</span>
                      <span class="s1">return_type=return_type</span><span class="s2">,</span>
                      <span class="s1">NA_action=</span><span class="s4">&quot;raise&quot;</span><span class="s1">)</span>

        <span class="s1">lmat</span><span class="s2">, </span><span class="s1">rmat = dmatrices(</span><span class="s4">&quot;y ~ x&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">return_type=return_type)</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(lmat</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">30</span><span class="s1">]])</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(rmat</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s2">if </span><span class="s1">return_type == </span><span class="s4">&quot;dataframe&quot;</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">lmat.index.equals(pandas.Index([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]))</span>
            <span class="s2">assert </span><span class="s1">rmat.index.equals(pandas.Index([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">,</span>
                      <span class="s1">dmatrices</span><span class="s2">, </span><span class="s4">&quot;y ~ x&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">return_type=return_type</span><span class="s2">,</span>
                      <span class="s1">NA_action=</span><span class="s4">&quot;raise&quot;</span><span class="s1">)</span>

        <span class="s0"># Initial release for the NA handling code had problems with</span>
        <span class="s0"># non-data-dependent matrices like &quot;~ 1&quot;.</span>
        <span class="s1">lmat</span><span class="s2">, </span><span class="s1">rmat = dmatrices(</span><span class="s4">&quot;y ~ 1&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">return_type=return_type)</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(lmat</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">30</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">40</span><span class="s1">]])</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(rmat</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s2">if </span><span class="s1">return_type == </span><span class="s4">&quot;dataframe&quot;</span><span class="s1">:</span>
            <span class="s2">assert </span><span class="s1">lmat.index.equals(pandas.Index([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]))</span>
            <span class="s2">assert </span><span class="s1">rmat.index.equals(pandas.Index([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]))</span>
        <span class="s1">pytest.raises(PatsyError</span><span class="s2">,</span>
                      <span class="s1">dmatrices</span><span class="s2">, </span><span class="s4">&quot;y ~ 1&quot;</span><span class="s2">, </span><span class="s1">data=data</span><span class="s2">, </span><span class="s1">return_type=return_type</span><span class="s2">,</span>
                      <span class="s1">NA_action=</span><span class="s4">&quot;raise&quot;</span><span class="s1">)</span>

<span class="s2">def </span><span class="s1">test_0d_data():</span>
    <span class="s0"># Use case from statsmodels/statsmodels#1881</span>
    <span class="s1">data_0d = {</span><span class="s4">&quot;x1&quot;</span><span class="s1">: </span><span class="s3">1.1</span><span class="s2">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">1.2</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s4">&quot;a1&quot;</span><span class="s1">}</span>

    <span class="s2">for </span><span class="s1">formula</span><span class="s2">, </span><span class="s1">expected </span><span class="s2">in </span><span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;x1 + x2&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1.1</span><span class="s2">, </span><span class="s3">1.2</span><span class="s1">]])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;C(a, levels=('a1', 'a2')) + x1&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1.1</span><span class="s1">]])</span><span class="s2">,</span>
            <span class="s1">]:</span>
        <span class="s1">mat = dmatrix(formula</span><span class="s2">, </span><span class="s1">data_0d)</span>
        <span class="s2">assert </span><span class="s1">np.allclose(mat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s2">assert </span><span class="s1">np.allclose(build_design_matrices([mat.design_info]</span><span class="s2">,</span>
                                                 <span class="s1">data_0d)[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                           <span class="s1">expected)</span>
        <span class="s2">if </span><span class="s1">have_pandas:</span>
            <span class="s1">data_series = pandas.Series(data_0d)</span>
            <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(formula</span><span class="s2">, </span><span class="s1">data_series)</span><span class="s2">, </span><span class="s1">expected)</span>

            <span class="s2">assert </span><span class="s1">np.allclose(build_design_matrices([mat.design_info]</span><span class="s2">,</span>
                                                     <span class="s1">data_series)[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                               <span class="s1">expected)</span>

<span class="s2">def </span><span class="s1">test_env_not_saved_in_builder():</span>
    <span class="s1">x_in_env = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">design_matrix = dmatrix(</span><span class="s4">&quot;x_in_env&quot;</span><span class="s2">, </span><span class="s1">{})</span>

    <span class="s1">x_in_env = [</span><span class="s3">10</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s3">30</span><span class="s1">]</span>
    <span class="s1">design_matrix2 = dmatrix(design_matrix.design_info</span><span class="s2">, </span><span class="s1">{})</span>

    <span class="s2">assert </span><span class="s1">np.allclose(design_matrix</span><span class="s2">, </span><span class="s1">design_matrix2)</span>

<span class="s2">def </span><span class="s1">test_C_and_pandas_categorical():</span>
    <span class="s2">if not </span><span class="s1">have_pandas_categorical:</span>
        <span class="s2">return</span>

    <span class="s1">objs = [pandas_Categorical_from_codes([</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">])]</span>
    <span class="s2">if </span><span class="s1">have_pandas_categorical_dtype:</span>
        <span class="s1">objs.append(pandas.Series(objs[</span><span class="s3">0</span><span class="s1">]))</span>
    <span class="s2">for </span><span class="s1">obj </span><span class="s2">in </span><span class="s1">objs:</span>
        <span class="s1">d = {</span><span class="s4">&quot;obj&quot;</span><span class="s1">: obj}</span>
        <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(</span><span class="s4">&quot;obj&quot;</span><span class="s2">, </span><span class="s1">d)</span><span class="s2">,</span>
                           <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(</span><span class="s4">&quot;C(obj)&quot;</span><span class="s2">, </span><span class="s1">d)</span><span class="s2">,</span>
                           <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(</span><span class="s4">&quot;C(obj, levels=['b', 'a'])&quot;</span><span class="s2">, </span><span class="s1">d)</span><span class="s2">,</span>
                           <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]])</span>

        <span class="s2">assert </span><span class="s1">np.allclose(dmatrix(</span><span class="s4">&quot;C(obj, levels=['a', 'b'])&quot;</span><span class="s2">, </span><span class="s1">d)</span><span class="s2">,</span>
                           <span class="s1">[[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]])</span>
</pre>
</body>
</html>