<html>
<head>
<title>test_blas.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_blas.py</font>
</center></td></tr></table>
<pre><span class="s0">#</span>
<span class="s0"># Created by: Pearu Peterson, April 2002</span>
<span class="s0">#</span>

<span class="s1">__usage__ = </span><span class="s2">&quot;&quot;&quot; 
Build linalg: 
  python setup.py build 
Run tests if scipy is installed: 
  python -c 'import scipy;scipy.linalg.test()' 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">math</span>
<span class="s3">import </span><span class="s1">pytest</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">(assert_equal</span><span class="s3">, </span><span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_</span><span class="s3">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s3">, </span><span class="s1">assert_allclose)</span>
<span class="s3">from </span><span class="s1">pytest </span><span class="s3">import </span><span class="s1">raises </span><span class="s3">as </span><span class="s1">assert_raises</span>

<span class="s3">from </span><span class="s1">numpy </span><span class="s3">import </span><span class="s1">float32</span><span class="s3">, </span><span class="s1">float64</span><span class="s3">, </span><span class="s1">complex64</span><span class="s3">, </span><span class="s1">complex128</span><span class="s3">, </span><span class="s1">arange</span><span class="s3">, </span><span class="s1">triu</span><span class="s3">, </span><span class="s1">\</span>
                  <span class="s1">tril</span><span class="s3">, </span><span class="s1">zeros</span><span class="s3">, </span><span class="s1">tril_indices</span><span class="s3">, </span><span class="s1">ones</span><span class="s3">, </span><span class="s1">mod</span><span class="s3">, </span><span class="s1">diag</span><span class="s3">, </span><span class="s1">append</span><span class="s3">, </span><span class="s1">eye</span><span class="s3">, </span><span class="s1">\</span>
                  <span class="s1">nonzero</span>

<span class="s3">from </span><span class="s1">numpy.random </span><span class="s3">import </span><span class="s1">rand</span><span class="s3">, </span><span class="s1">seed</span>
<span class="s3">from </span><span class="s1">scipy.linalg </span><span class="s3">import </span><span class="s1">_fblas </span><span class="s3">as </span><span class="s1">fblas</span><span class="s3">, </span><span class="s1">get_blas_funcs</span><span class="s3">, </span><span class="s1">toeplitz</span><span class="s3">, </span><span class="s1">solve</span>

<span class="s3">try</span><span class="s1">:</span>
    <span class="s3">from </span><span class="s1">scipy.linalg </span><span class="s3">import </span><span class="s1">_cblas </span><span class="s3">as </span><span class="s1">cblas</span>
<span class="s3">except </span><span class="s1">ImportError:</span>
    <span class="s1">cblas = </span><span class="s3">None</span>

<span class="s1">REAL_DTYPES = [float32</span><span class="s3">, </span><span class="s1">float64]</span>
<span class="s1">COMPLEX_DTYPES = [complex64</span><span class="s3">, </span><span class="s1">complex128]</span>
<span class="s1">DTYPES = REAL_DTYPES + COMPLEX_DTYPES</span>


<span class="s3">def </span><span class="s1">test_get_blas_funcs():</span>
    <span class="s0"># check that it returns Fortran code for arrays that are</span>
    <span class="s0"># fortran-ordered</span>
    <span class="s1">f1</span><span class="s3">, </span><span class="s1">f2</span><span class="s3">, </span><span class="s1">f3 = get_blas_funcs(</span>
        <span class="s1">(</span><span class="s2">'axpy'</span><span class="s3">, </span><span class="s2">'axpy'</span><span class="s3">, </span><span class="s2">'axpy'</span><span class="s1">)</span><span class="s3">,</span>
        <span class="s1">(np.empty((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.complex64</span><span class="s3">, </span><span class="s1">order=</span><span class="s2">'F'</span><span class="s1">)</span><span class="s3">,</span>
         <span class="s1">np.empty((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.complex128</span><span class="s3">, </span><span class="s1">order=</span><span class="s2">'C'</span><span class="s1">))</span>
        <span class="s1">)</span>

    <span class="s0"># get_blas_funcs will choose libraries depending on most generic</span>
    <span class="s0"># array</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'z'</span><span class="s1">)</span>
    <span class="s1">assert_equal(f2.typecode</span><span class="s3">, </span><span class="s2">'z'</span><span class="s1">)</span>
    <span class="s3">if </span><span class="s1">cblas </span><span class="s3">is not None</span><span class="s1">:</span>
        <span class="s1">assert_equal(f1.module_name</span><span class="s3">, </span><span class="s2">'cblas'</span><span class="s1">)</span>
        <span class="s1">assert_equal(f2.module_name</span><span class="s3">, </span><span class="s2">'cblas'</span><span class="s1">)</span>

    <span class="s0"># check defaults.</span>
    <span class="s1">f1 = get_blas_funcs(</span><span class="s2">'rotg'</span><span class="s1">)</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'d'</span><span class="s1">)</span>

    <span class="s0"># check also dtype interface</span>
    <span class="s1">f1 = get_blas_funcs(</span><span class="s2">'gemm'</span><span class="s3">, </span><span class="s1">dtype=np.complex64)</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'c'</span><span class="s1">)</span>
    <span class="s1">f1 = get_blas_funcs(</span><span class="s2">'gemm'</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'F'</span><span class="s1">)</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'c'</span><span class="s1">)</span>

    <span class="s0"># extended precision complex</span>
    <span class="s1">f1 = get_blas_funcs(</span><span class="s2">'gemm'</span><span class="s3">, </span><span class="s1">dtype=np.longcomplex)</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'z'</span><span class="s1">)</span>

    <span class="s0"># check safe complex upcasting</span>
    <span class="s1">f1 = get_blas_funcs(</span><span class="s2">'axpy'</span><span class="s3">,</span>
                        <span class="s1">(np.empty((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span><span class="s3">,</span>
                         <span class="s1">np.empty((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.complex64))</span>
                        <span class="s1">)</span>
    <span class="s1">assert_equal(f1.typecode</span><span class="s3">, </span><span class="s2">'z'</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_get_blas_funcs_alias():</span>
    <span class="s0"># check alias for get_blas_funcs</span>
    <span class="s1">f</span><span class="s3">, </span><span class="s1">g = get_blas_funcs((</span><span class="s2">'nrm2'</span><span class="s3">, </span><span class="s2">'dot'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.complex64)</span>
    <span class="s3">assert </span><span class="s1">f.typecode == </span><span class="s2">'c'</span>
    <span class="s3">assert </span><span class="s1">g.typecode == </span><span class="s2">'c'</span>

    <span class="s1">f</span><span class="s3">, </span><span class="s1">g</span><span class="s3">, </span><span class="s1">h = get_blas_funcs((</span><span class="s2">'dot'</span><span class="s3">, </span><span class="s2">'dotc'</span><span class="s3">, </span><span class="s2">'dotu'</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
    <span class="s3">assert </span><span class="s1">f </span><span class="s3">is </span><span class="s1">g</span>
    <span class="s3">assert </span><span class="s1">f </span><span class="s3">is </span><span class="s1">h</span>


<span class="s3">class </span><span class="s1">TestCBLAS1Simple:</span>

    <span class="s3">def </span><span class="s1">test_axpy(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(cblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'axpy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">a=</span><span class="s4">5</span><span class="s1">)</span><span class="s3">,</span>
                                      <span class="s1">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">18</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(cblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'axpy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2j</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">a=</span><span class="s4">5</span><span class="s1">)</span><span class="s3">,</span>
                                      <span class="s1">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">10j</span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">18</span><span class="s1">])</span>


<span class="s3">class </span><span class="s1">TestFBLAS1Simple:</span>

    <span class="s3">def </span><span class="s1">test_axpy(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'axpy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">a=</span><span class="s4">5</span><span class="s1">)</span><span class="s3">,</span>
                                      <span class="s1">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">18</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'axpy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2j</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">a=</span><span class="s4">5</span><span class="s1">)</span><span class="s3">,</span>
                                      <span class="s1">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">10j</span><span class="s1">-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">18</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_copy(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'copy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">8</span><span class="s1">]*</span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'copy'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f([</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4j</span><span class="s3">, </span><span class="s4">5</span><span class="s1">+</span><span class="s4">3j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">8</span><span class="s1">]*</span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4j</span><span class="s3">, </span><span class="s4">5</span><span class="s1">+</span><span class="s4">3j</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_asum(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'asum'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">])</span><span class="s3">, </span><span class="s4">12</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">[</span><span class="s2">'sc'</span><span class="s3">, </span><span class="s2">'dz'</span><span class="s1">]:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'asum'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">])</span><span class="s3">, </span><span class="s4">14</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_dot(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'dot'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s4">1</span><span class="s1">])</span><span class="s3">, </span><span class="s1">-</span><span class="s4">9</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_complex_dotu(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'dotu'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s1">])</span><span class="s3">, </span><span class="s1">-</span><span class="s4">9</span><span class="s1">+</span><span class="s4">2j</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_complex_dotc(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'dotc'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3j</span><span class="s3">, </span><span class="s4">1</span><span class="s1">])</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">14j</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_nrm2(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'nrm2'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">])</span><span class="s3">, </span><span class="s1">math.sqrt(</span><span class="s4">50</span><span class="s1">))</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">[</span><span class="s2">'c'</span><span class="s3">, </span><span class="s2">'z'</span><span class="s3">, </span><span class="s2">'sc'</span><span class="s3">, </span><span class="s2">'dz'</span><span class="s1">]:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'nrm2'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_almost_equal(f([</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">])</span><span class="s3">, </span><span class="s1">math.sqrt(</span><span class="s4">50</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_scal(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'scal'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[</span><span class="s4">6</span><span class="s3">, </span><span class="s1">-</span><span class="s4">8</span><span class="s3">, </span><span class="s4">10</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'scal'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">9</span><span class="s3">, </span><span class="s1">-</span><span class="s4">12j</span><span class="s3">, </span><span class="s4">12</span><span class="s1">+</span><span class="s4">9j</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">[</span><span class="s2">'cs'</span><span class="s3">, </span><span class="s2">'zd'</span><span class="s1">]:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'scal'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[</span><span class="s4">9j</span><span class="s3">, </span><span class="s1">-</span><span class="s4">12</span><span class="s3">, </span><span class="s4">9</span><span class="s1">-</span><span class="s4">12j</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_swap(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'swap'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y = [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">7</span><span class="s1">]</span>
            <span class="s1">x1</span><span class="s3">, </span><span class="s1">y1 = f(x</span><span class="s3">, </span><span class="s1">y)</span>
            <span class="s1">assert_array_almost_equal(x1</span><span class="s3">, </span><span class="s1">y)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">x)</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'swap'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">x</span><span class="s3">, </span><span class="s1">y = [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3j</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">7</span><span class="s1">-</span><span class="s4">3j</span><span class="s1">]</span>
            <span class="s1">x1</span><span class="s3">, </span><span class="s1">y1 = f(x</span><span class="s3">, </span><span class="s1">y)</span>
            <span class="s1">assert_array_almost_equal(x1</span><span class="s3">, </span><span class="s1">y)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">x)</span>

    <span class="s3">def </span><span class="s1">test_amax(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'i'</span><span class="s1">+p+</span><span class="s2">'amax'</span><span class="s1">)</span>
            <span class="s1">assert_equal(f([-</span><span class="s4">2</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">3</span><span class="s1">])</span><span class="s3">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'i'</span><span class="s1">+p+</span><span class="s2">'amax'</span><span class="s1">)</span>
            <span class="s1">assert_equal(f([-</span><span class="s4">5</span><span class="s3">, </span><span class="s4">4</span><span class="s1">+</span><span class="s4">3j</span><span class="s3">, </span><span class="s4">6</span><span class="s1">])</span><span class="s3">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0"># XXX: need tests for rot,rotm,rotg,rotmg</span>


<span class="s3">class </span><span class="s1">TestFBLAS2Simple:</span>

    <span class="s3">def </span><span class="s1">test_gemv(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'gemv'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">3</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">36</span><span class="s1">])</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">3</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">5</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">21</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'gemv'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">48</span><span class="s1">-</span><span class="s4">36j</span><span class="s1">])</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">5j</span><span class="s1">])</span><span class="s3">,</span>
                                      <span class="s1">[-</span><span class="s4">48</span><span class="s1">-</span><span class="s4">21j</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_ger(self):</span>

        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'ger'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]])</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span><span class="s3">,</span>
                                      <span class="s1">[[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">12</span><span class="s3">, </span><span class="s4">16</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">18</span><span class="s3">, </span><span class="s4">24</span><span class="s1">]])</span>

            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]</span><span class="s3">,</span>
                                        <span class="s1">a=[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]])</span><span class="s3">, </span><span class="s1">[[</span><span class="s4">4</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">9</span><span class="s3">, </span><span class="s4">12</span><span class="s1">]])</span>

        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'geru'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1j</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span><span class="s3">,</span>
                                      <span class="s1">[[</span><span class="s4">3j</span><span class="s3">, </span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]])</span>
            <span class="s1">assert_array_almost_equal(f(-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1j</span><span class="s3">, </span><span class="s4">2j</span><span class="s3">, </span><span class="s4">3j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3j</span><span class="s3">, </span><span class="s4">4j</span><span class="s1">])</span><span class="s3">,</span>
                                      <span class="s1">[[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">12</span><span class="s3">, </span><span class="s4">16</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">18</span><span class="s3">, </span><span class="s4">24</span><span class="s1">]])</span>

        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s3">for </span><span class="s1">name </span><span class="s3">in </span><span class="s1">(</span><span class="s2">'ger'</span><span class="s3">, </span><span class="s2">'gerc'</span><span class="s1">):</span>
                <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+name</span><span class="s3">, None</span><span class="s1">)</span>
                <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                    <span class="s3">continue</span>
                <span class="s1">assert_array_almost_equal(f(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1j</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span><span class="s3">,</span>
                                          <span class="s1">[[</span><span class="s4">3j</span><span class="s3">, </span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]])</span>
                <span class="s1">assert_array_almost_equal(f(</span><span class="s4">2</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1j</span><span class="s3">, </span><span class="s4">2j</span><span class="s3">, </span><span class="s4">3j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3j</span><span class="s3">, </span><span class="s4">4j</span><span class="s1">])</span><span class="s3">,</span>
                                          <span class="s1">[[</span><span class="s4">6</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">12</span><span class="s3">, </span><span class="s4">16</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">18</span><span class="s3">, </span><span class="s4">24</span><span class="s1">]])</span>

    <span class="s3">def </span><span class="s1">test_syr_her(self):</span>
        <span class="s1">x = np.arange(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">)</span>
        <span class="s1">resx = np.triu(x[:</span><span class="s3">, </span><span class="s1">np.newaxis] * x)</span>
        <span class="s1">resx_reverse = np.triu(x[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * x[::-</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">y = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">8.5</span><span class="s3">, </span><span class="s4">17</span><span class="s3">, </span><span class="s1">endpoint=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s1">z = np.arange(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">).view(</span><span class="s2">'D'</span><span class="s1">)</span>
        <span class="s1">resz = np.triu(z[:</span><span class="s3">, </span><span class="s1">np.newaxis] * z)</span>
        <span class="s1">resz_reverse = np.triu(z[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * z[::-</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">rehz = np.triu(z[:</span><span class="s3">, </span><span class="s1">np.newaxis] * z.conj())</span>
        <span class="s1">rehz_reverse = np.triu(z[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * z[::-</span><span class="s4">1</span><span class="s1">].conj())</span>

        <span class="s1">w = np.c_[np.zeros(</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">np.zeros(</span><span class="s4">4</span><span class="s1">)].ravel()</span>

        <span class="s3">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">rtol </span><span class="s3">in </span><span class="s1">zip(</span><span class="s2">'sd'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s1">]):</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'syr'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x)</span><span class="s3">, </span><span class="s1">resx</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resx.T</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resx</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s0"># negative increments imply reversed vectors in blas</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incx=-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resx_reverse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'f' </span><span class="s3">if </span><span class="s1">p == </span><span class="s2">'s' </span><span class="s3">else </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">b = f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a=a</span><span class="s3">, </span><span class="s1">overwrite_a=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">resx</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">b = f(</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a=a)</span>
            <span class="s1">assert_(a </span><span class="s3">is not </span><span class="s1">b)</span>
            <span class="s1">assert_allclose(b</span><span class="s3">, </span><span class="s4">3</span><span class="s1">*resx</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a=np.zeros((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">))</span>

        <span class="s3">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">rtol </span><span class="s3">in </span><span class="s1">zip(</span><span class="s2">'cz'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s1">]):</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'syr'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z)</span><span class="s3">, </span><span class="s1">resz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resz.T</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s0"># negative increments imply reversed vectors in blas</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">incx=-</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resz_reverse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'F' </span><span class="s3">if </span><span class="s1">p == </span><span class="s2">'c' </span><span class="s3">else </span><span class="s2">'D'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">b = f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">a=a</span><span class="s3">, </span><span class="s1">overwrite_a=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">resz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">b = f(</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">a=a)</span>
            <span class="s1">assert_(a </span><span class="s3">is not </span><span class="s1">b)</span>
            <span class="s1">assert_allclose(b</span><span class="s3">, </span><span class="s4">3</span><span class="s1">*resz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a=np.zeros((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">))</span>

        <span class="s3">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">rtol </span><span class="s3">in </span><span class="s1">zip(</span><span class="s2">'cz'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s1">]):</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'her'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z)</span><span class="s3">, </span><span class="s1">rehz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">rehz.T.conj()</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">rehz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s0"># negative increments imply reversed vectors in blas</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">w</span><span class="s3">, </span><span class="s1">incx=-</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">4</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">rehz_reverse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'F' </span><span class="s3">if </span><span class="s1">p == </span><span class="s2">'c' </span><span class="s3">else </span><span class="s2">'D'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">b = f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">a=a</span><span class="s3">, </span><span class="s1">overwrite_a=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">rehz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">b = f(</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">z</span><span class="s3">, </span><span class="s1">a=a)</span>
            <span class="s1">assert_(a </span><span class="s3">is not </span><span class="s1">b)</span>
            <span class="s1">assert_allclose(b</span><span class="s3">, </span><span class="s4">3</span><span class="s1">*rehz</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">offx=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">a=np.zeros((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_syr2(self):</span>
        <span class="s1">x = np.arange(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">5</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">)</span>
        <span class="s1">y = np.arange(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">)</span>
        <span class="s1">resxy = np.triu(x[:</span><span class="s3">, </span><span class="s1">np.newaxis] * y + y[:</span><span class="s3">, </span><span class="s1">np.newaxis] * x)</span>
        <span class="s1">resxy_reverse = np.triu(x[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * y[::-</span><span class="s4">1</span><span class="s1">]</span>
                                <span class="s1">+ y[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * x[::-</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">q = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">8.5</span><span class="s3">, </span><span class="s4">17</span><span class="s3">, </span><span class="s1">endpoint=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s3">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">rtol </span><span class="s3">in </span><span class="s1">zip(</span><span class="s2">'sd'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s1">]):</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'syr2'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y)</span><span class="s3">, </span><span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resxy[:</span><span class="s4">3</span><span class="s3">, </span><span class="s1">:</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resxy.T</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">10</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">10</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">3</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy[:</span><span class="s4">3</span><span class="s3">, </span><span class="s1">:</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s0"># negative increments imply reversed vectors in blas</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">q</span><span class="s3">, </span><span class="s1">incx=-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">incy=-</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">10</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy_reverse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'f' </span><span class="s3">if </span><span class="s1">p == </span><span class="s2">'s' </span><span class="s3">else </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">b = f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a=a</span><span class="s3">, </span><span class="s1">overwrite_a=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">b = f(</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a=a)</span>
            <span class="s1">assert_(a </span><span class="s3">is not </span><span class="s1">b)</span>
            <span class="s1">assert_allclose(b</span><span class="s3">, </span><span class="s4">3</span><span class="s1">*resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offx=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offy=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">,</span>
                          <span class="s1">a=np.zeros((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_her2(self):</span>
        <span class="s1">x = np.arange(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">).view(</span><span class="s2">'D'</span><span class="s1">)</span>
        <span class="s1">y = np.arange(</span><span class="s4">9</span><span class="s3">, </span><span class="s4">17</span><span class="s3">, </span><span class="s1">dtype=</span><span class="s2">'d'</span><span class="s1">).view(</span><span class="s2">'D'</span><span class="s1">)</span>
        <span class="s1">resxy = x[:</span><span class="s3">, </span><span class="s1">np.newaxis] * y.conj() + y[:</span><span class="s3">, </span><span class="s1">np.newaxis] * x.conj()</span>
        <span class="s1">resxy = np.triu(resxy)</span>

        <span class="s1">resxy_reverse = x[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * y[::-</span><span class="s4">1</span><span class="s1">].conj()</span>
        <span class="s1">resxy_reverse += y[::-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">np.newaxis] * x[::-</span><span class="s4">1</span><span class="s1">].conj()</span>
        <span class="s1">resxy_reverse = np.triu(resxy_reverse)</span>

        <span class="s1">u = np.c_[np.zeros(</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">np.zeros(</span><span class="s4">4</span><span class="s1">)].ravel()</span>
        <span class="s1">v = np.c_[np.zeros(</span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">np.zeros(</span><span class="s4">4</span><span class="s1">)].ravel()</span>

        <span class="s3">for </span><span class="s1">p</span><span class="s3">, </span><span class="s1">rtol </span><span class="s3">in </span><span class="s1">zip(</span><span class="s2">'cz'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s4">1e-14</span><span class="s1">]):</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'her2'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y)</span><span class="s3">, </span><span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resxy[:</span><span class="s4">3</span><span class="s3">, </span><span class="s1">:</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">, </span><span class="s1">resxy.T.conj()</span><span class="s3">,</span>
                            <span class="s1">rtol=rtol)</span>

            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">u</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">1</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">u</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">3</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy[:</span><span class="s4">3</span><span class="s3">, </span><span class="s1">:</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
            <span class="s0"># negative increments imply reversed vectors in blas</span>
            <span class="s1">assert_allclose(f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">u</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">incx=-</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">incy=-</span><span class="s4">3</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">1</span><span class="s1">)</span><span class="s3">,</span>
                            <span class="s1">resxy_reverse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">a = np.zeros((</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'F' </span><span class="s3">if </span><span class="s1">p == </span><span class="s2">'c' </span><span class="s3">else </span><span class="s2">'D'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">)</span>
            <span class="s1">b = f(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a=a</span><span class="s3">, </span><span class="s1">overwrite_a=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">b = f(</span><span class="s4">2.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">a=a)</span>
            <span class="s1">assert_(a </span><span class="s3">is not </span><span class="s1">b)</span>
            <span class="s1">assert_allclose(b</span><span class="s3">, </span><span class="s4">3</span><span class="s1">*resxy</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>

            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incx=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offx=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offx=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">0</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offy=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">offy=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=-</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">n=</span><span class="s4">5</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">,</span>
                          <span class="s1">a=np.zeros((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">)</span><span class="s3">, </span><span class="s2">'d'</span><span class="s3">, </span><span class="s2">'F'</span><span class="s1">))</span>

    <span class="s3">def </span><span class="s1">test_gbmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">7</span>
            <span class="s1">m = </span><span class="s4">5</span>
            <span class="s1">kl = </span><span class="s4">1</span>
            <span class="s1">ku = </span><span class="s4">2</span>
            <span class="s0"># fake a banded matrix via toeplitz</span>
            <span class="s1">A = toeplitz(append(rand(kl+</span><span class="s4">1</span><span class="s1">)</span><span class="s3">, </span><span class="s1">zeros(m-kl-</span><span class="s4">1</span><span class="s1">))</span><span class="s3">,</span>
                         <span class="s1">append(rand(ku+</span><span class="s4">1</span><span class="s1">)</span><span class="s3">, </span><span class="s1">zeros(n-ku-</span><span class="s4">1</span><span class="s1">)))</span>
            <span class="s1">A = A.astype(dtype)</span>
            <span class="s1">Ab = zeros((kl+ku+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s0"># Form the banded storage</span>
            <span class="s1">Ab[</span><span class="s4">2</span><span class="s3">, </span><span class="s1">:</span><span class="s4">5</span><span class="s1">] = A[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]  </span><span class="s0"># diag</span>
            <span class="s1">Ab[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">:</span><span class="s4">6</span><span class="s1">] = A[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]  </span><span class="s0"># sup1</span>
            <span class="s1">Ab[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s1">:</span><span class="s4">7</span><span class="s1">] = A[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]  </span><span class="s0"># sup2</span>
            <span class="s1">Ab[</span><span class="s4">3</span><span class="s3">, </span><span class="s1">:</span><span class="s4">4</span><span class="s1">] = A[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]  </span><span class="s0"># sub1</span>

            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">y = rand(m).astype(dtype)</span>
            <span class="s1">alpha</span><span class="s3">, </span><span class="s1">beta = dtype(</span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype(-</span><span class="s4">5</span><span class="s1">)</span>

            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'gbmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">y1 = func(m=m</span><span class="s3">, </span><span class="s1">n=n</span><span class="s3">, </span><span class="s1">ku=ku</span><span class="s3">, </span><span class="s1">kl=kl</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">,</span>
                      <span class="s1">x=x</span><span class="s3">, </span><span class="s1">y=y</span><span class="s3">, </span><span class="s1">beta=beta)</span>
            <span class="s1">y2 = alpha * A.dot(x) + beta * y</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_sbmv_hbmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">6</span>
            <span class="s1">k = </span><span class="s4">2</span>
            <span class="s1">A = zeros((n</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">Ab = zeros((k+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s0"># Form the array and its packed banded storage</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = rand(n)</span>
            <span class="s3">for </span><span class="s1">ind2 </span><span class="s3">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s3">, </span><span class="s1">k+</span><span class="s4">1</span><span class="s1">):</span>
                <span class="s1">temp = rand(n-ind2)</span>
                <span class="s1">A[arange(n-ind2)</span><span class="s3">, </span><span class="s1">arange(ind2</span><span class="s3">, </span><span class="s1">n)] = temp</span>
                <span class="s1">Ab[-</span><span class="s4">1</span><span class="s1">-ind2</span><span class="s3">, </span><span class="s1">ind2:] = temp</span>
            <span class="s1">A = A.astype(dtype)</span>
            <span class="s1">A = A + A.T </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">2 </span><span class="s3">else </span><span class="s1">A + A.conj().T</span>
            <span class="s1">Ab[-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">:] = diag(A)</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">y = rand(n).astype(dtype)</span>
            <span class="s1">alpha</span><span class="s3">, </span><span class="s1">beta = dtype(</span><span class="s4">1.25</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype(</span><span class="s4">3</span><span class="s1">)</span>

            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'hbmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'sbmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">y=y</span><span class="s3">, </span><span class="s1">beta=beta)</span>
            <span class="s1">y2 = alpha * A.dot(x) + beta * y</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_spmv_hpmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES+COMPLEX_DTYPES):</span>
            <span class="s1">n = </span><span class="s4">3</span>
            <span class="s1">A = rand(n</span><span class="s3">, </span><span class="s1">n).astype(dtype)</span>
            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">A += rand(n</span><span class="s3">, </span><span class="s1">n)*</span><span class="s4">1j</span>
            <span class="s1">A = A.astype(dtype)</span>
            <span class="s1">A = A + A.T </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">4 </span><span class="s3">else </span><span class="s1">A + A.conj().T</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">r = tril_indices(n)</span>
            <span class="s1">Ap = A[r</span><span class="s3">, </span><span class="s1">c]</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">y = rand(n).astype(dtype)</span>
            <span class="s1">xlong = arange(</span><span class="s4">2</span><span class="s1">*n).astype(dtype)</span>
            <span class="s1">ylong = ones(</span><span class="s4">2</span><span class="s1">*n).astype(dtype)</span>
            <span class="s1">alpha</span><span class="s3">, </span><span class="s1">beta = dtype(</span><span class="s4">1.25</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype(</span><span class="s4">2</span><span class="s1">)</span>

            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">3</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'hpmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'spmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">y=y</span><span class="s3">, </span><span class="s1">beta=beta)</span>
            <span class="s1">y2 = alpha * A.dot(x) + beta * y</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s0"># Test inc and offsets</span>
            <span class="s1">y1 = func(n=n-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">beta=beta</span><span class="s3">, </span><span class="s1">x=xlong</span><span class="s3">, </span><span class="s1">y=ylong</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">,</span>
                      <span class="s1">incx=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">incy=</span><span class="s4">2</span><span class="s3">, </span><span class="s1">offx=n</span><span class="s3">, </span><span class="s1">offy=n)</span>
            <span class="s1">y2 = (alpha * A[:-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">:-</span><span class="s4">1</span><span class="s1">]).dot(xlong[</span><span class="s4">3</span><span class="s1">::</span><span class="s4">2</span><span class="s1">]) + beta * ylong[</span><span class="s4">3</span><span class="s1">::</span><span class="s4">2</span><span class="s1">]</span>
            <span class="s1">assert_array_almost_equal(y1[</span><span class="s4">3</span><span class="s1">::</span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">y2)</span>
            <span class="s1">assert_almost_equal(y1[</span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ylong[</span><span class="s4">4</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_spr_hpr(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES+COMPLEX_DTYPES):</span>
            <span class="s1">n = </span><span class="s4">3</span>
            <span class="s1">A = rand(n</span><span class="s3">, </span><span class="s1">n).astype(dtype)</span>
            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">A += rand(n</span><span class="s3">, </span><span class="s1">n)*</span><span class="s4">1j</span>
            <span class="s1">A = A.astype(dtype)</span>
            <span class="s1">A = A + A.T </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">4 </span><span class="s3">else </span><span class="s1">A + A.conj().T</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">r = tril_indices(n)</span>
            <span class="s1">Ap = A[r</span><span class="s3">, </span><span class="s1">c]</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">alpha = (DTYPES+COMPLEX_DTYPES)[mod(ind</span><span class="s3">, </span><span class="s4">4</span><span class="s1">)](</span><span class="s4">2.5</span><span class="s1">)</span>

            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">3</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'hpr'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">y2 = alpha * x[:</span><span class="s3">, None</span><span class="s1">].dot(x[</span><span class="s3">None, </span><span class="s1">:].conj()) + A</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'spr'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
                <span class="s1">y2 = alpha * x[:</span><span class="s3">, None</span><span class="s1">].dot(x[</span><span class="s3">None, </span><span class="s1">:]) + A</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y1f = zeros((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">y1f[r</span><span class="s3">, </span><span class="s1">c] = y1</span>
            <span class="s1">y1f[c</span><span class="s3">, </span><span class="s1">r] = y1.conj() </span><span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">3 </span><span class="s3">else </span><span class="s1">y1</span>
            <span class="s1">assert_array_almost_equal(y1f</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_spr2_hpr2(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">3</span>
            <span class="s1">A = rand(n</span><span class="s3">, </span><span class="s1">n).astype(dtype)</span>
            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">A += rand(n</span><span class="s3">, </span><span class="s1">n)*</span><span class="s4">1j</span>
            <span class="s1">A = A.astype(dtype)</span>
            <span class="s1">A = A + A.T </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">2 </span><span class="s3">else </span><span class="s1">A + A.conj().T</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">r = tril_indices(n)</span>
            <span class="s1">Ap = A[r</span><span class="s3">, </span><span class="s1">c]</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">y = rand(n).astype(dtype)</span>
            <span class="s1">alpha = dtype(</span><span class="s4">2</span><span class="s1">)</span>

            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'hpr2'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s3">else</span><span class="s1">:</span>
                <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'spr2'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">u = alpha.conj() * x[:</span><span class="s3">, None</span><span class="s1">].dot(y[</span><span class="s3">None, </span><span class="s1">:].conj())</span>
            <span class="s1">y2 = A + u + u.conj().T</span>
            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">y=y</span><span class="s3">, </span><span class="s1">ap=Ap)</span>
            <span class="s1">y1f = zeros((</span><span class="s4">3</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">y1f[r</span><span class="s3">, </span><span class="s1">c] = y1</span>
            <span class="s1">y1f[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]] = y1[[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]].conj()</span>
            <span class="s1">assert_array_almost_equal(y1f</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_tbmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">10</span>
            <span class="s1">k = </span><span class="s4">3</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">A = zeros((n</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s0"># Banded upper triangular array</span>
            <span class="s3">for </span><span class="s1">sup </span><span class="s3">in </span><span class="s1">range(k+</span><span class="s4">1</span><span class="s1">):</span>
                <span class="s1">A[arange(n-sup)</span><span class="s3">, </span><span class="s1">arange(sup</span><span class="s3">, </span><span class="s1">n)] = rand(n-sup)</span>

            <span class="s0"># Add complex parts for c,z</span>
            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">A[nonzero(A)] += </span><span class="s4">1j </span><span class="s1">* rand((k+</span><span class="s4">1</span><span class="s1">)*n-(k*(k+</span><span class="s4">1</span><span class="s1">)//</span><span class="s4">2</span><span class="s1">)).astype(dtype)</span>

            <span class="s0"># Form the banded storage</span>
            <span class="s1">Ab = zeros((k+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">range(k+</span><span class="s4">1</span><span class="s1">):</span>
                <span class="s1">Ab[-row-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">row:] = diag(A</span><span class="s3">, </span><span class="s1">k=row)</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'tbmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = A.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = A.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = A.T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = A.conj().T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_tbsv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">6</span>
            <span class="s1">k = </span><span class="s4">3</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">A = zeros((n</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s0"># Banded upper triangular array</span>
            <span class="s3">for </span><span class="s1">sup </span><span class="s3">in </span><span class="s1">range(k+</span><span class="s4">1</span><span class="s1">):</span>
                <span class="s1">A[arange(n-sup)</span><span class="s3">, </span><span class="s1">arange(sup</span><span class="s3">, </span><span class="s1">n)] = rand(n-sup)</span>

            <span class="s0"># Add complex parts for c,z</span>
            <span class="s3">if </span><span class="s1">ind &gt; </span><span class="s4">1</span><span class="s1">:</span>
                <span class="s1">A[nonzero(A)] += </span><span class="s4">1j </span><span class="s1">* rand((k+</span><span class="s4">1</span><span class="s1">)*n-(k*(k+</span><span class="s4">1</span><span class="s1">)//</span><span class="s4">2</span><span class="s1">)).astype(dtype)</span>

            <span class="s0"># Form the banded storage</span>
            <span class="s1">Ab = zeros((k+</span><span class="s4">1</span><span class="s3">, </span><span class="s1">n)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>
            <span class="s3">for </span><span class="s1">row </span><span class="s3">in </span><span class="s1">range(k+</span><span class="s4">1</span><span class="s1">):</span>
                <span class="s1">Ab[-row-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">row:] = diag(A</span><span class="s3">, </span><span class="s1">k=row)</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'tbsv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = solve(A</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A.T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(k=k</span><span class="s3">, </span><span class="s1">a=Ab</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A.conj().T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_tpmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">10</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s0"># Upper triangular array</span>
            <span class="s1">A = triu(rand(n</span><span class="s3">, </span><span class="s1">n)) </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">2 </span><span class="s3">else </span><span class="s1">triu(rand(n</span><span class="s3">, </span><span class="s1">n)+rand(n</span><span class="s3">, </span><span class="s1">n)*</span><span class="s4">1j</span><span class="s1">)</span>
            <span class="s0"># Form the packed storage</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">r = tril_indices(n)</span>
            <span class="s1">Ap = A[r</span><span class="s3">, </span><span class="s1">c]</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'tpmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = A.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = A.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = A.T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = A.conj().T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_tpsv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">10</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s0"># Upper triangular array</span>
            <span class="s1">A = triu(rand(n</span><span class="s3">, </span><span class="s1">n)) </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">2 </span><span class="s3">else </span><span class="s1">triu(rand(n</span><span class="s3">, </span><span class="s1">n)+rand(n</span><span class="s3">, </span><span class="s1">n)*</span><span class="s4">1j</span><span class="s1">)</span>
            <span class="s1">A += eye(n)</span>
            <span class="s0"># Form the packed storage</span>
            <span class="s1">c</span><span class="s3">, </span><span class="s1">r = tril_indices(n)</span>
            <span class="s1">Ap = A[r</span><span class="s3">, </span><span class="s1">c]</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'tpsv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = solve(A</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A.T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(n=n</span><span class="s3">, </span><span class="s1">ap=Ap</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = solve(A.conj().T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_trmv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">3</span>
            <span class="s1">A = (rand(n</span><span class="s3">, </span><span class="s1">n)+eye(n)).astype(dtype)</span>
            <span class="s1">x = rand(</span><span class="s4">3</span><span class="s1">).astype(dtype)</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'trmv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = triu(A).dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = triu(A).dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = triu(A).T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = triu(A).conj().T.dot(x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

    <span class="s3">def </span><span class="s1">test_trsv(self):</span>
        <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
            <span class="s1">n = </span><span class="s4">15</span>
            <span class="s1">A = (rand(n</span><span class="s3">, </span><span class="s1">n)+eye(n)).astype(dtype)</span>
            <span class="s1">x = rand(n).astype(dtype)</span>
            <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'trsv'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x)</span>
            <span class="s1">y2 = solve(triu(A)</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(tril(A)</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">A[arange(n)</span><span class="s3">, </span><span class="s1">arange(n)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(triu(A)</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">y2 = solve(triu(A).T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>

            <span class="s1">y1 = func(a=A</span><span class="s3">, </span><span class="s1">x=x</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s1">y2 = solve(triu(A).conj().T</span><span class="s3">, </span><span class="s1">x)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s3">, </span><span class="s1">y2)</span>


<span class="s3">class </span><span class="s1">TestFBLAS3Simple:</span>

    <span class="s3">def </span><span class="s1">test_gemm(self):</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'sd'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'gemm'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[[-</span><span class="s4">36</span><span class="s1">]])</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">5</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">21</span><span class="s1">])</span>
        <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s2">'cz'</span><span class="s1">:</span>
            <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+</span><span class="s2">'gemm'</span><span class="s3">, None</span><span class="s1">)</span>
            <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
                <span class="s3">continue</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[[-</span><span class="s4">48</span><span class="s1">-</span><span class="s4">36j</span><span class="s1">]])</span>
            <span class="s1">assert_array_almost_equal(f(</span><span class="s4">3j</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">-</span><span class="s4">4j</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s1">[</span><span class="s4">5j</span><span class="s1">])</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">48</span><span class="s1">-</span><span class="s4">21j</span><span class="s1">])</span>


<span class="s3">def </span><span class="s1">_get_func(func</span><span class="s3">, </span><span class="s1">ps=</span><span class="s2">'sdzc'</span><span class="s1">):</span>
    <span class="s5">&quot;&quot;&quot;Just a helper: return a specified BLAS function w/typecode.&quot;&quot;&quot;</span>
    <span class="s3">for </span><span class="s1">p </span><span class="s3">in </span><span class="s1">ps:</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s1">p+func</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is None</span><span class="s1">:</span>
            <span class="s3">continue</span>
        <span class="s3">yield </span><span class="s1">f</span>


<span class="s3">class </span><span class="s1">TestBLAS3Symm:</span>

    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.a = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">]])</span>
        <span class="s1">self.b = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">2.</span><span class="s1">]])</span>
        <span class="s1">self.c = np.ones((</span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s1">self.t = np.array([[</span><span class="s4">2.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">8.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">3.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">9.</span><span class="s1">]])</span>

    <span class="s3">def </span><span class="s1">test_symm(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'symm'</span><span class="s1">):</span>
            <span class="s1">res = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">c=self.c</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(res</span><span class="s3">, </span><span class="s1">self.t)</span>

            <span class="s1">res = f(a=self.a.T</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">c=self.c</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(res</span><span class="s3">, </span><span class="s1">self.t)</span>

            <span class="s1">res = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b.T</span><span class="s3">, </span><span class="s1">side=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">c=self.c.T</span><span class="s3">,</span>
                    <span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(res</span><span class="s3">, </span><span class="s1">self.t.T)</span>

    <span class="s3">def </span><span class="s1">test_summ_wrong_side(self):</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dsymm'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">**{</span><span class="s2">'a'</span><span class="s1">: self.a</span><span class="s3">, </span><span class="s2">'b'</span><span class="s1">: self.b</span><span class="s3">,</span>
                                           <span class="s2">'alpha'</span><span class="s1">: </span><span class="s4">1</span><span class="s3">, </span><span class="s2">'side'</span><span class="s1">: </span><span class="s4">1</span><span class="s1">})</span>
            <span class="s0"># `side=1` means C &lt;- B*A, hence shapes of A and B are to be</span>
            <span class="s0">#  compatible. Otherwise, f2py exception is raised</span>

    <span class="s3">def </span><span class="s1">test_symm_wrong_uplo(self):</span>
        <span class="s5">&quot;&quot;&quot;SYMM only considers the upper/lower part of A. Hence setting 
        wrong value for `lower` (default is lower=0, meaning upper triangle) 
        gives a wrong result. 
        &quot;&quot;&quot;</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dsymm'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">res = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">c=self.c</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s3">assert </span><span class="s1">np.allclose(res</span><span class="s3">, </span><span class="s1">self.t)</span>

            <span class="s1">res = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">c=self.c</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s3">assert not </span><span class="s1">np.allclose(res</span><span class="s3">, </span><span class="s1">self.t)</span>


<span class="s3">class </span><span class="s1">TestBLAS3Syrk:</span>
    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.a = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">2.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s3">, </span><span class="s4">3.</span><span class="s1">]])</span>
        <span class="s1">self.t = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">2.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">4.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">6.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">6.</span><span class="s3">, </span><span class="s4">13.</span><span class="s1">]])</span>
        <span class="s1">self.tt = np.array([[</span><span class="s4">5.</span><span class="s3">, </span><span class="s4">6.</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">[</span><span class="s4">6.</span><span class="s3">, </span><span class="s4">13.</span><span class="s1">]])</span>

    <span class="s3">def </span><span class="s1">test_syrk(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'syrk'</span><span class="s1">):</span>
            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.t))</span>

            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.tril(c)</span><span class="s3">, </span><span class="s1">np.tril(self.t))</span>

            <span class="s1">c0 = np.ones(self.t.shape)</span>
            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">c=c0)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.t+c0))</span>

            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.tt))</span>

    <span class="s0"># prints '0-th dimension must be fixed to 3 but got 5',</span>
    <span class="s0"># FIXME: suppress?</span>
    <span class="s0"># FIXME: how to catch the _fblas.error?</span>
    <span class="s3">def </span><span class="s1">test_syrk_wrong_c(self):</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dsyrk'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">**{</span><span class="s2">'a'</span><span class="s1">: self.a</span><span class="s3">, </span><span class="s2">'alpha'</span><span class="s1">: </span><span class="s4">1.</span><span class="s3">,</span>
                                           <span class="s2">'c'</span><span class="s1">: np.ones((</span><span class="s4">5</span><span class="s3">, </span><span class="s4">8</span><span class="s1">))})</span>
        <span class="s0"># if C is supplied, it must have compatible dimensions</span>


<span class="s3">class </span><span class="s1">TestBLAS3Syr2k:</span>
    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.a = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">2.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">2.</span><span class="s3">, </span><span class="s4">3.</span><span class="s1">]])</span>
        <span class="s1">self.b = np.array([[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">]])</span>
        <span class="s1">self.t = np.array([[</span><span class="s4">0.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">3.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[-</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">3.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">6.</span><span class="s1">]])</span>
        <span class="s1">self.tt = np.array([[</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]])</span>

    <span class="s3">def </span><span class="s1">test_syr2k(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'syr2k'</span><span class="s1">):</span>
            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.t))</span>

            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.tril(c)</span><span class="s3">, </span><span class="s1">np.tril(self.t))</span>

            <span class="s1">c0 = np.ones(self.t.shape)</span>
            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">beta=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">c=c0)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.t+c0))</span>

            <span class="s1">c = f(a=self.a</span><span class="s3">, </span><span class="s1">b=self.b</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">trans=</span><span class="s4">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(c)</span><span class="s3">, </span><span class="s1">np.triu(self.tt))</span>

    <span class="s0"># prints '0-th dimension must be fixed to 3 but got 5', FIXME: suppress?</span>
    <span class="s3">def </span><span class="s1">test_syr2k_wrong_c(self):</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dsyr2k'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">f</span><span class="s3">, </span><span class="s1">**{</span><span class="s2">'a'</span><span class="s1">: self.a</span><span class="s3">,</span>
                                           <span class="s2">'b'</span><span class="s1">: self.b</span><span class="s3">,</span>
                                           <span class="s2">'alpha'</span><span class="s1">: </span><span class="s4">1.</span><span class="s3">,</span>
                                           <span class="s2">'c'</span><span class="s1">: np.zeros((</span><span class="s4">15</span><span class="s3">, </span><span class="s4">8</span><span class="s1">))})</span>
        <span class="s0"># if C is supplied, it must have compatible dimensions</span>


<span class="s3">class </span><span class="s1">TestSyHe:</span>
    <span class="s5">&quot;&quot;&quot;Quick and simple tests for (zc)-symm, syrk, syr2k.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.sigma_y = np.array([[</span><span class="s4">0.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.j</span><span class="s1">]</span><span class="s3">,</span>
                                 <span class="s1">[</span><span class="s4">1.j</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]])</span>

    <span class="s3">def </span><span class="s1">test_symm_zc(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'symm'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s0"># NB: a is symmetric w/upper diag of ONLY</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">b=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s1">np.diag([</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">test_hemm_zc(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'hemm'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s0"># NB: a is hermitian w/upper diag of ONLY</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">b=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s1">np.diag([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">test_syrk_zr(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'syrk'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s1">np.diag([-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">test_herk_zr(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'herk'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s1">np.diag([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">test_syr2k_zr(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'syr2k'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">b=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s4">2.</span><span class="s1">*np.diag([-</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">]))</span>

    <span class="s3">def </span><span class="s1">test_her2k_zr(self):</span>
        <span class="s3">for </span><span class="s1">f </span><span class="s3">in </span><span class="s1">_get_func(</span><span class="s2">'her2k'</span><span class="s3">, </span><span class="s2">'zc'</span><span class="s1">):</span>
            <span class="s1">res = f(a=self.sigma_y</span><span class="s3">, </span><span class="s1">b=self.sigma_y</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">1.</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.triu(res)</span><span class="s3">, </span><span class="s4">2.</span><span class="s1">*np.diag([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]))</span>


<span class="s3">class </span><span class="s1">TestTRMM:</span>
    <span class="s5">&quot;&quot;&quot;Quick and simple tests for dtrmm.&quot;&quot;&quot;</span>

    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.a = np.array([[</span><span class="s4">1.</span><span class="s3">, </span><span class="s4">2.</span><span class="s3">, </span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[-</span><span class="s4">2.</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">]])</span>
        <span class="s1">self.b = np.array([[</span><span class="s4">3.</span><span class="s3">, </span><span class="s4">4.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s1">]</span><span class="s3">,</span>
                           <span class="s1">[</span><span class="s4">5.</span><span class="s3">, </span><span class="s4">6.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">2.</span><span class="s1">]])</span>

        <span class="s1">self.a2 = np.array([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s3">, </span><span class="s1">order=</span><span class="s2">&quot;f&quot;</span><span class="s1">)</span>
        <span class="s1">self.b2 = np.array([[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">4</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">2</span><span class="s3">, </span><span class="s4">5</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">6</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">7</span><span class="s3">, </span><span class="s4">8</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s4">9</span><span class="s3">, </span><span class="s4">10</span><span class="s1">]]</span><span class="s3">,</span>
                           <span class="s1">order=</span><span class="s2">&quot;f&quot;</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype_&quot;</span><span class="s3">, </span><span class="s1">DTYPES)</span>
    <span class="s3">def </span><span class="s1">test_side(self</span><span class="s3">, </span><span class="s1">dtype_):</span>
        <span class="s1">trmm = get_blas_funcs(</span><span class="s2">&quot;trmm&quot;</span><span class="s3">, </span><span class="s1">dtype=dtype_)</span>
        <span class="s0"># Provide large A array that works for side=1 but not 0 (see gh-10841)</span>
        <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">trmm</span><span class="s3">, </span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">self.a2</span><span class="s3">, </span><span class="s1">self.b2)</span>
        <span class="s1">res = trmm(</span><span class="s4">1.0</span><span class="s3">, </span><span class="s1">self.a2.astype(dtype_)</span><span class="s3">, </span><span class="s1">self.b2.astype(dtype_)</span><span class="s3">,</span>
                   <span class="s1">side=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">k = self.b2.shape[</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">assert_allclose(res</span><span class="s3">, </span><span class="s1">self.b2 @ self.a2[:k</span><span class="s3">, </span><span class="s1">:k]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.</span><span class="s3">,</span>
                        <span class="s1">atol=</span><span class="s4">100</span><span class="s1">*np.finfo(dtype_).eps)</span>

    <span class="s3">def </span><span class="s1">test_ab(self):</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dtrmm'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">result = f(</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">self.a</span><span class="s3">, </span><span class="s1">self.b)</span>
            <span class="s0"># default a is upper triangular</span>
            <span class="s1">expected = np.array([[</span><span class="s4">13.</span><span class="s3">, </span><span class="s4">16.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">5.</span><span class="s1">]</span><span class="s3">,</span>
                                 <span class="s1">[</span><span class="s4">5.</span><span class="s3">, </span><span class="s4">6.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">2.</span><span class="s1">]])</span>
            <span class="s1">assert_array_almost_equal(result</span><span class="s3">, </span><span class="s1">expected)</span>

    <span class="s3">def </span><span class="s1">test_ab_lower(self):</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dtrmm'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s1">result = f(</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">self.a</span><span class="s3">, </span><span class="s1">self.b</span><span class="s3">, </span><span class="s1">lower=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">expected = np.array([[</span><span class="s4">3.</span><span class="s3">, </span><span class="s4">4.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">1.</span><span class="s1">]</span><span class="s3">,</span>
                                 <span class="s1">[-</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">-</span><span class="s4">2.</span><span class="s3">, </span><span class="s4">0.</span><span class="s1">]])  </span><span class="s0"># now a is lower triangular</span>
            <span class="s1">assert_array_almost_equal(result</span><span class="s3">, </span><span class="s1">expected)</span>

    <span class="s3">def </span><span class="s1">test_b_overwrites(self):</span>
        <span class="s0"># BLAS dtrmm modifies B argument in-place.</span>
        <span class="s0"># Here the default is to copy, but this can be overridden</span>
        <span class="s1">f = getattr(fblas</span><span class="s3">, </span><span class="s2">'dtrmm'</span><span class="s3">, None</span><span class="s1">)</span>
        <span class="s3">if </span><span class="s1">f </span><span class="s3">is not None</span><span class="s1">:</span>
            <span class="s3">for </span><span class="s1">overwr </span><span class="s3">in </span><span class="s1">[</span><span class="s3">True, False</span><span class="s1">]:</span>
                <span class="s1">bcopy = self.b.copy()</span>
                <span class="s1">result = f(</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">self.a</span><span class="s3">, </span><span class="s1">bcopy</span><span class="s3">, </span><span class="s1">overwrite_b=overwr)</span>
                <span class="s0"># C-contiguous arrays are copied</span>
                <span class="s1">assert_(bcopy.flags.f_contiguous </span><span class="s3">is False and</span>
                        <span class="s1">np.may_share_memory(bcopy</span><span class="s3">, </span><span class="s1">result) </span><span class="s3">is False</span><span class="s1">)</span>
                <span class="s1">assert_equal(bcopy</span><span class="s3">, </span><span class="s1">self.b)</span>

            <span class="s1">bcopy = np.asfortranarray(self.b.copy())  </span><span class="s0"># or just transpose it</span>
            <span class="s1">result = f(</span><span class="s4">1.</span><span class="s3">, </span><span class="s1">self.a</span><span class="s3">, </span><span class="s1">bcopy</span><span class="s3">, </span><span class="s1">overwrite_b=</span><span class="s3">True</span><span class="s1">)</span>
            <span class="s1">assert_(bcopy.flags.f_contiguous </span><span class="s3">is True and</span>
                    <span class="s1">np.may_share_memory(bcopy</span><span class="s3">, </span><span class="s1">result) </span><span class="s3">is True</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(bcopy</span><span class="s3">, </span><span class="s1">result)</span>


<span class="s3">def </span><span class="s1">test_trsm():</span>
    <span class="s1">seed(</span><span class="s4">1234</span><span class="s1">)</span>
    <span class="s3">for </span><span class="s1">ind</span><span class="s3">, </span><span class="s1">dtype </span><span class="s3">in </span><span class="s1">enumerate(DTYPES):</span>
        <span class="s1">tol = np.finfo(dtype).eps*</span><span class="s4">1000</span>
        <span class="s1">func</span><span class="s3">, </span><span class="s1">= get_blas_funcs((</span><span class="s2">'trsm'</span><span class="s3">,</span><span class="s1">)</span><span class="s3">, </span><span class="s1">dtype=dtype)</span>

        <span class="s0"># Test protection against size mismatches</span>
        <span class="s1">A = rand(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">5</span><span class="s1">).astype(dtype)</span>
        <span class="s1">B = rand(</span><span class="s4">4</span><span class="s3">, </span><span class="s4">4</span><span class="s1">).astype(dtype)</span>
        <span class="s1">alpha = dtype(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">A</span><span class="s3">, </span><span class="s1">B)</span>
        <span class="s1">assert_raises(Exception</span><span class="s3">, </span><span class="s1">func</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">A.T</span><span class="s3">, </span><span class="s1">B)</span>

        <span class="s1">n = </span><span class="s4">8</span>
        <span class="s1">m = </span><span class="s4">7</span>
        <span class="s1">alpha = dtype(-</span><span class="s4">2.5</span><span class="s1">)</span>
        <span class="s1">A = (rand(m</span><span class="s3">, </span><span class="s1">m) </span><span class="s3">if </span><span class="s1">ind &lt; </span><span class="s4">2 </span><span class="s3">else </span><span class="s1">rand(m</span><span class="s3">, </span><span class="s1">m) + rand(m</span><span class="s3">, </span><span class="s1">m)*</span><span class="s4">1j</span><span class="s1">) + eye(m)</span>
        <span class="s1">A = A.astype(dtype)</span>
        <span class="s1">Au = triu(A)</span>
        <span class="s1">Al = tril(A)</span>
        <span class="s1">B1 = rand(m</span><span class="s3">, </span><span class="s1">n).astype(dtype)</span>
        <span class="s1">B2 = rand(n</span><span class="s3">, </span><span class="s1">m).astype(dtype)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B1)</span>
        <span class="s1">assert_equal(B1.shape</span><span class="s3">, </span><span class="s1">x1.shape)</span>
        <span class="s1">x2 = solve(Au</span><span class="s3">, </span><span class="s1">alpha*B1)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">atol=tol)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B1</span><span class="s3">, </span><span class="s1">trans_a=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">x2 = solve(Au.T</span><span class="s3">, </span><span class="s1">alpha*B1)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">atol=tol)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B1</span><span class="s3">, </span><span class="s1">trans_a=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">x2 = solve(Au.conj().T</span><span class="s3">, </span><span class="s1">alpha*B1)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">atol=tol)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B1</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">Au[arange(m)</span><span class="s3">, </span><span class="s1">arange(m)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">x2 = solve(Au</span><span class="s3">, </span><span class="s1">alpha*B1)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2</span><span class="s3">, </span><span class="s1">atol=tol)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B2</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">side=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">x2 = solve(Au.conj().T</span><span class="s3">, </span><span class="s1">alpha*B2.conj().T)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2.conj().T</span><span class="s3">, </span><span class="s1">atol=tol)</span>

        <span class="s1">x1 = func(alpha=alpha</span><span class="s3">, </span><span class="s1">a=A</span><span class="s3">, </span><span class="s1">b=B2</span><span class="s3">, </span><span class="s1">diag=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">side=</span><span class="s4">1</span><span class="s3">, </span><span class="s1">lower=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">Al[arange(m)</span><span class="s3">, </span><span class="s1">arange(m)] = dtype(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">x2 = solve(Al.conj().T</span><span class="s3">, </span><span class="s1">alpha*B2.conj().T)</span>
        <span class="s1">assert_allclose(x1</span><span class="s3">, </span><span class="s1">x2.conj().T</span><span class="s3">, </span><span class="s1">atol=tol)</span>
</pre>
</body>
</html>