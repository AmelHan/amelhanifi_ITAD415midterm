<html>
<head>
<title>test_ranking.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ranking.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">re</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">stats</span>
<span class="s0">from </span><span class="s1">scipy.sparse </span><span class="s0">import </span><span class="s1">csr_matrix</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">datasets</span><span class="s0">, </span><span class="s1">svm</span>
<span class="s0">from </span><span class="s1">sklearn.datasets </span><span class="s0">import </span><span class="s1">make_multilabel_classification</span>
<span class="s0">from </span><span class="s1">sklearn.exceptions </span><span class="s0">import </span><span class="s1">UndefinedMetricWarning</span>
<span class="s0">from </span><span class="s1">sklearn.linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn.metrics </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">accuracy_score</span><span class="s0">,</span>
    <span class="s1">auc</span><span class="s0">,</span>
    <span class="s1">average_precision_score</span><span class="s0">,</span>
    <span class="s1">coverage_error</span><span class="s0">,</span>
    <span class="s1">dcg_score</span><span class="s0">,</span>
    <span class="s1">det_curve</span><span class="s0">,</span>
    <span class="s1">label_ranking_average_precision_score</span><span class="s0">,</span>
    <span class="s1">label_ranking_loss</span><span class="s0">,</span>
    <span class="s1">ndcg_score</span><span class="s0">,</span>
    <span class="s1">precision_recall_curve</span><span class="s0">,</span>
    <span class="s1">roc_auc_score</span><span class="s0">,</span>
    <span class="s1">roc_curve</span><span class="s0">,</span>
    <span class="s1">top_k_accuracy_score</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">sklearn.metrics._ranking </span><span class="s0">import </span><span class="s1">_dcg_sample_scores</span><span class="s0">, </span><span class="s1">_ndcg_sample_scores</span>
<span class="s0">from </span><span class="s1">sklearn.model_selection </span><span class="s0">import </span><span class="s1">train_test_split</span>
<span class="s0">from </span><span class="s1">sklearn.preprocessing </span><span class="s0">import </span><span class="s1">label_binarize</span>
<span class="s0">from </span><span class="s1">sklearn.random_projection </span><span class="s0">import </span><span class="s1">_sparse_random_matrix</span>
<span class="s0">from </span><span class="s1">sklearn.utils._testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_allclose</span><span class="s0">,</span>
    <span class="s1">assert_almost_equal</span><span class="s0">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s0">,</span>
    <span class="s1">assert_array_equal</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">sklearn.utils.extmath </span><span class="s0">import </span><span class="s1">softmax</span>
<span class="s0">from </span><span class="s1">sklearn.utils.validation </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">check_array</span><span class="s0">,</span>
    <span class="s1">check_consistent_length</span><span class="s0">,</span>
    <span class="s1">check_random_state</span><span class="s0">,</span>
<span class="s1">)</span>

<span class="s2">###############################################################################</span>
<span class="s2"># Utilities for testing</span>

<span class="s1">CURVE_FUNCS = [</span>
    <span class="s1">det_curve</span><span class="s0">,</span>
    <span class="s1">precision_recall_curve</span><span class="s0">,</span>
    <span class="s1">roc_curve</span><span class="s0">,</span>
<span class="s1">]</span>


<span class="s0">def </span><span class="s1">make_prediction(dataset=</span><span class="s0">None, </span><span class="s1">binary=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s3">&quot;&quot;&quot;Make some classification predictions on a toy dataset using a SVC 
 
    If binary is True restrict to a binary classification problem instead of a 
    multiclass classification problem 
    &quot;&quot;&quot;</span>

    <span class="s0">if </span><span class="s1">dataset </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s2"># import some data to play with</span>
        <span class="s1">dataset = datasets.load_iris()</span>

    <span class="s1">X = dataset.data</span>
    <span class="s1">y = dataset.target</span>

    <span class="s0">if </span><span class="s1">binary:</span>
        <span class="s2"># restrict to a binary classification task</span>
        <span class="s1">X</span><span class="s0">, </span><span class="s1">y = X[y &lt; </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[y &lt; </span><span class="s4">2</span><span class="s1">]</span>

    <span class="s1">n_samples</span><span class="s0">, </span><span class="s1">n_features = X.shape</span>
    <span class="s1">p = np.arange(n_samples)</span>

    <span class="s1">rng = check_random_state(</span><span class="s4">37</span><span class="s1">)</span>
    <span class="s1">rng.shuffle(p)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = X[p]</span><span class="s0">, </span><span class="s1">y[p]</span>
    <span class="s1">half = int(n_samples / </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s2"># add noisy features to make the problem harder and avoid perfect results</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">X = np.c_[X</span><span class="s0">, </span><span class="s1">rng.randn(n_samples</span><span class="s0">, </span><span class="s4">200 </span><span class="s1">* n_features)]</span>

    <span class="s2"># run classifier, get class probabilities and label predictions</span>
    <span class="s1">clf = svm.SVC(kernel=</span><span class="s5">&quot;linear&quot;</span><span class="s0">, </span><span class="s1">probability=</span><span class="s0">True, </span><span class="s1">random_state=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">y_score = clf.fit(X[:half]</span><span class="s0">, </span><span class="s1">y[:half]).predict_proba(X[half:])</span>

    <span class="s0">if </span><span class="s1">binary:</span>
        <span class="s2"># only interested in probabilities of the positive case</span>
        <span class="s2"># XXX: do we really want a special API for the binary case?</span>
        <span class="s1">y_score = y_score[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>

    <span class="s1">y_pred = clf.predict(X[half:])</span>
    <span class="s1">y_true = y[half:]</span>
    <span class="s0">return </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">y_score</span>


<span class="s2">###############################################################################</span>
<span class="s2"># Tests</span>


<span class="s0">def </span><span class="s1">_auc(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s3">&quot;&quot;&quot;Alternative implementation to check for correctness of 
    `roc_auc_score`.&quot;&quot;&quot;</span>
    <span class="s1">pos_label = np.unique(y_true)[</span><span class="s4">1</span><span class="s1">]</span>

    <span class="s2"># Count the number of times positive samples are correctly ranked above</span>
    <span class="s2"># negative samples.</span>
    <span class="s1">pos = y_score[y_true == pos_label]</span>
    <span class="s1">neg = y_score[y_true != pos_label]</span>
    <span class="s1">diff_matrix = pos.reshape(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">) - neg.reshape(-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">n_correct = np.sum(diff_matrix &gt; </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s0">return </span><span class="s1">n_correct / float(len(pos) * len(neg))</span>


<span class="s0">def </span><span class="s1">_average_precision(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s3">&quot;&quot;&quot;Alternative implementation to check for correctness of 
    `average_precision_score`. 
 
    Note that this implementation fails on some edge cases. 
    For example, for constant predictions e.g. [0.5, 0.5, 0.5], 
    y_true = [1, 0, 0] returns an average precision of 0.33... 
    but y_true = [0, 0, 1] returns 1.0. 
    &quot;&quot;&quot;</span>
    <span class="s1">pos_label = np.unique(y_true)[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">n_pos = np.sum(y_true == pos_label)</span>
    <span class="s1">order = np.argsort(y_score)[::-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = y_score[order]</span>
    <span class="s1">y_true = y_true[order]</span>

    <span class="s1">score = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(y_score)):</span>
        <span class="s0">if </span><span class="s1">y_true[i] == pos_label:</span>
            <span class="s2"># Compute precision up to document i</span>
            <span class="s2"># i.e, percentage of relevant documents up to document i.</span>
            <span class="s1">prec = </span><span class="s4">0</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">i + </span><span class="s4">1</span><span class="s1">):</span>
                <span class="s0">if </span><span class="s1">y_true[j] == pos_label:</span>
                    <span class="s1">prec += </span><span class="s4">1.0</span>
            <span class="s1">prec /= i + </span><span class="s4">1.0</span>
            <span class="s1">score += prec</span>

    <span class="s0">return </span><span class="s1">score / n_pos</span>


<span class="s0">def </span><span class="s1">_average_precision_slow(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s3">&quot;&quot;&quot;A second alternative implementation of average precision that closely 
    follows the Wikipedia article's definition (see References). This should 
    give identical results as `average_precision_score` for all inputs. 
 
    References 
    ---------- 
    .. [1] `Wikipedia entry for the Average precision 
       &lt;https://en.wikipedia.org/wiki/Average_precision&gt;`_ 
    &quot;&quot;&quot;</span>
    <span class="s1">precision</span><span class="s0">, </span><span class="s1">recall</span><span class="s0">, </span><span class="s1">threshold = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">precision = list(reversed(precision))</span>
    <span class="s1">recall = list(reversed(recall))</span>
    <span class="s1">average_precision = </span><span class="s4">0</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">len(precision)):</span>
        <span class="s1">average_precision += precision[i] * (recall[i] - recall[i - </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s0">return </span><span class="s1">average_precision</span>


<span class="s0">def </span><span class="s1">_partial_roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_predict</span><span class="s0">, </span><span class="s1">max_fpr):</span>
    <span class="s3">&quot;&quot;&quot;Alternative implementation to check for correctness of `roc_auc_score` 
    with `max_fpr` set. 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">_partial_roc(y_true</span><span class="s0">, </span><span class="s1">y_predict</span><span class="s0">, </span><span class="s1">max_fpr):</span>
        <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_predict)</span>
        <span class="s1">new_fpr = fpr[fpr &lt;= max_fpr]</span>
        <span class="s1">new_fpr = np.append(new_fpr</span><span class="s0">, </span><span class="s1">max_fpr)</span>
        <span class="s1">new_tpr = tpr[fpr &lt;= max_fpr]</span>
        <span class="s1">idx_out = np.argmax(fpr &gt; max_fpr)</span>
        <span class="s1">idx_in = idx_out - </span><span class="s4">1</span>
        <span class="s1">x_interp = [fpr[idx_in]</span><span class="s0">, </span><span class="s1">fpr[idx_out]]</span>
        <span class="s1">y_interp = [tpr[idx_in]</span><span class="s0">, </span><span class="s1">tpr[idx_out]]</span>
        <span class="s1">new_tpr = np.append(new_tpr</span><span class="s0">, </span><span class="s1">np.interp(max_fpr</span><span class="s0">, </span><span class="s1">x_interp</span><span class="s0">, </span><span class="s1">y_interp))</span>
        <span class="s0">return </span><span class="s1">(new_fpr</span><span class="s0">, </span><span class="s1">new_tpr)</span>

    <span class="s1">new_fpr</span><span class="s0">, </span><span class="s1">new_tpr = _partial_roc(y_true</span><span class="s0">, </span><span class="s1">y_predict</span><span class="s0">, </span><span class="s1">max_fpr)</span>
    <span class="s1">partial_auc = auc(new_fpr</span><span class="s0">, </span><span class="s1">new_tpr)</span>

    <span class="s2"># Formula (5) from McClish 1989</span>
    <span class="s1">fpr1 = </span><span class="s4">0</span>
    <span class="s1">fpr2 = max_fpr</span>
    <span class="s1">min_area = </span><span class="s4">0.5 </span><span class="s1">* (fpr2 - fpr1) * (fpr2 + fpr1)</span>
    <span class="s1">max_area = fpr2 - fpr1</span>
    <span class="s0">return </span><span class="s4">0.5 </span><span class="s1">* (</span><span class="s4">1 </span><span class="s1">+ (partial_auc - min_area) / (max_area - min_area))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;drop&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_roc_curve(drop):</span>
    <span class="s2"># Test Area under Receiver Operating Characteristic (ROC) curve</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">expected_auc = _auc(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
    <span class="s1">roc_auc = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">assert_array_almost_equal(roc_auc</span><span class="s0">, </span><span class="s1">expected_auc</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score))</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_end_points():</span>
    <span class="s2"># Make sure that roc_curve returns a curve start at 0 and ending and</span>
    <span class="s2"># 1 even in corner cases</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">y_true = np.array([</span><span class="s4">0</span><span class="s1">] * </span><span class="s4">50 </span><span class="s1">+ [</span><span class="s4">1</span><span class="s1">] * </span><span class="s4">50</span><span class="s1">)</span>
    <span class="s1">y_pred = rng.randint(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thr = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr[</span><span class="s4">0</span><span class="s1">] == </span><span class="s4">0</span>
    <span class="s0">assert </span><span class="s1">fpr[-</span><span class="s4">1</span><span class="s1">] == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thr.shape</span>


<span class="s0">def </span><span class="s1">test_roc_returns_consistency():</span>
    <span class="s2"># Test whether the returned threshold matches up with tpr</span>
    <span class="s2"># make small toy dataset</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s2"># use the given thresholds to determine the tpr</span>
    <span class="s1">tpr_correct = []</span>
    <span class="s0">for </span><span class="s1">t </span><span class="s0">in </span><span class="s1">thresholds:</span>
        <span class="s1">tp = np.sum((y_score &gt;= t) &amp; y_true)</span>
        <span class="s1">p = np.sum(y_true)</span>
        <span class="s1">tpr_correct.append(</span><span class="s4">1.0 </span><span class="s1">* tp / p)</span>

    <span class="s2"># compare tpr and tpr_correct to see if the thresholds' order was correct</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">tpr_correct</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_multi():</span>
    <span class="s2"># roc_curve not applicable for multi-class problems</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>


<span class="s0">def </span><span class="s1">test_roc_curve_confidence():</span>
    <span class="s2"># roc_curve for confidence scores</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score - </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">roc_auc = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">assert_array_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.90</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_hard():</span>
    <span class="s2"># roc_curve for hard decisions</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">pred</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s2"># always predict one</span>
    <span class="s1">trivial_pred = np.ones(y_true.shape)</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">trivial_pred)</span>
    <span class="s1">roc_auc = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">assert_array_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.50</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>

    <span class="s2"># always predict zero</span>
    <span class="s1">trivial_pred = np.zeros(y_true.shape)</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">trivial_pred)</span>
    <span class="s1">roc_auc = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">assert_array_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.50</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>

    <span class="s2"># hard decisions</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">pred)</span>
    <span class="s1">roc_auc = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">assert_array_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.78</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_one_label():</span>
    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_pred = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s2"># assert there are warnings</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">&quot;No negative samples in y_true, false positive value should be meaningless&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UndefinedMetricWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>

    <span class="s2"># all true labels, all fpr should be nan</span>
    <span class="s1">assert_array_equal(fpr</span><span class="s0">, </span><span class="s1">np.full(len(thresholds)</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>

    <span class="s2"># assert there are warnings</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">&quot;No positive samples in y_true, true positive value should be meaningless&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UndefinedMetricWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve([</span><span class="s4">1 </span><span class="s1">- x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">y_true]</span><span class="s0">, </span><span class="s1">y_pred)</span>
    <span class="s2"># all negative labels, all tpr should be nan</span>
    <span class="s1">assert_array_equal(tpr</span><span class="s0">, </span><span class="s1">np.full(len(thresholds)</span><span class="s0">, </span><span class="s1">np.nan))</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == tpr.shape</span>
    <span class="s0">assert </span><span class="s1">fpr.shape == thresholds.shape</span>


<span class="s0">def </span><span class="s1">test_roc_curve_toydata():</span>
    <span class="s2"># Binary classification</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">)</span>

    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(roc_auc</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span>
    <span class="s2"># assert UndefinedMetricWarning because of no positive sample in y_true</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">&quot;No positive samples in y_true, true positive value should be meaningless&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UndefinedMetricWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>

    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span>
    <span class="s2"># assert UndefinedMetricWarning because of no negative sample in y_true</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">&quot;No negative samples in y_true, false positive value should be meaningless&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UndefinedMetricWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(tpr</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s1">assert_array_almost_equal(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s2"># Multi-label classification task</span>
    <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

    <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

    <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_roc_curve_drop_intermediate():</span>
    <span class="s2"># Test that drop_intermediate drops the correct thresholds</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(thresholds</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>

    <span class="s2"># Test dropping thresholds with repeating scores</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span>
    <span class="s1">tpr</span><span class="s0">, </span><span class="s1">fpr</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(thresholds</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_roc_curve_fpr_tpr_increasing():</span>
    <span class="s2"># Ensure that fpr and tpr returned by roc_curve are increasing.</span>
    <span class="s2"># Construct an edge case with float y_score and sample_weight</span>
    <span class="s2"># when some adjacent values of fpr and tpr are actually the same.</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span>
    <span class="s1">sample_weight = np.repeat(</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight)</span>
    <span class="s0">assert </span><span class="s1">(np.diff(fpr) &lt; </span><span class="s4">0</span><span class="s1">).sum() == </span><span class="s4">0</span>
    <span class="s0">assert </span><span class="s1">(np.diff(tpr) &lt; </span><span class="s4">0</span><span class="s1">).sum() == </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_auc():</span>
    <span class="s2"># Test Area Under Curve (AUC) computation</span>
    <span class="s1">x = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(auc(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">x = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(auc(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">x = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(auc(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">x = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(auc(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">x = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(auc(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_auc_errors():</span>
    <span class="s2"># Incompatible shapes</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">auc([</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">])</span>

    <span class="s2"># Too few x values</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">auc([</span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s1">])</span>

    <span class="s2"># x is not in order</span>
    <span class="s1">x = [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
    <span class="s1">y = [</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span>
    <span class="s1">error_message = </span><span class="s5">&quot;x is neither increasing nor decreasing : {}&quot;</span><span class="s1">.format(np.array(x))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=re.escape(error_message)):</span>
        <span class="s1">auc(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, labels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovo_roc_auc_toydata(y_true</span><span class="s0">, </span><span class="s1">labels):</span>
    <span class="s2"># Tests the one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s2"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores = np.array(</span>
        <span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.35</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s2"># Used to compute the expected output.</span>
    <span class="s2"># Consider labels 0 and 1:</span>
    <span class="s2"># positive label is 0, negative label is 1</span>
    <span class="s1">score_01 = roc_auc_score([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.35</span><span class="s1">])</span>
    <span class="s2"># positive label is 1, negative label is 0</span>
    <span class="s1">score_10 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span>
    <span class="s1">average_score_01 = (score_01 + score_10) / </span><span class="s4">2</span>

    <span class="s2"># Consider labels 0 and 2:</span>
    <span class="s1">score_02 = roc_auc_score([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.35</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">score_20 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.15</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">])</span>
    <span class="s1">average_score_02 = (score_02 + score_20) / </span><span class="s4">2</span>

    <span class="s2"># Consider labels 1 and 2:</span>
    <span class="s1">score_12 = roc_auc_score([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">])</span>
    <span class="s1">score_21 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">])</span>
    <span class="s1">average_score_12 = (score_12 + score_21) / </span><span class="s4">2</span>

    <span class="s2"># Unweighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s1">ovo_unweighted_score = (average_score_01 + average_score_02 + average_score_12) / </span><span class="s4">3</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovo&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">ovo_unweighted_score</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Weighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s2"># Each term is weighted by the prevalence for the positive label.</span>
    <span class="s1">pair_scores = [average_score_01</span><span class="s0">, </span><span class="s1">average_score_02</span><span class="s0">, </span><span class="s1">average_score_12]</span>
    <span class="s1">prevalence = [</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.50</span><span class="s1">]</span>
    <span class="s1">ovo_weighted_score = np.average(pair_scores</span><span class="s0">, </span><span class="s1">weights=prevalence)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(</span>
            <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">ovo_weighted_score</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Check that average=None raises NotImplemented error</span>
    <span class="s1">error_message = </span><span class="s5">&quot;average=None is not implemented for multi_class='ovo'.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=error_message):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">None</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, labels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovo_roc_auc_toydata_binary(y_true</span><span class="s0">, </span><span class="s1">labels):</span>
    <span class="s2"># Tests the one-vs-one multiclass ROC AUC algorithm for binary y_true</span>
    <span class="s2">#</span>
    <span class="s2"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores = np.array(</span>
        <span class="s1">[[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.55</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.45</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s2"># Used to compute the expected output.</span>
    <span class="s2"># Consider labels 0 and 1:</span>
    <span class="s2"># positive label is 0, negative label is 1</span>
    <span class="s1">score_01 = roc_auc_score([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.55</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">])</span>
    <span class="s2"># positive label is 1, negative label is 0</span>
    <span class="s1">score_10 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.45</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">])</span>
    <span class="s1">ovo_score = (score_01 + score_10) / </span><span class="s4">2</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovo&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ovo_score</span>
    <span class="s1">)</span>

    <span class="s2"># Weighted, one-vs-one multiclass ROC AUC algorithm</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(</span>
            <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">ovo_score</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, labels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_multiclass_ovr_roc_auc_toydata(y_true</span><span class="s0">, </span><span class="s1">labels):</span>
    <span class="s2"># Tests the unweighted, one-vs-rest multiclass ROC AUC algorithm</span>
    <span class="s2"># on a small example, representative of an expected use case.</span>
    <span class="s1">y_scores = np.array(</span>
        <span class="s1">[[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">]]</span>
    <span class="s1">)</span>
    <span class="s2"># Compute the expected result by individually computing the 'one-vs-rest'</span>
    <span class="s2"># ROC AUC scores for classes 0, 1, and 2.</span>
    <span class="s1">out_0 = roc_auc_score([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_scores[:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">out_1 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_scores[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">out_2 = roc_auc_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_scores[:</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[out_0</span><span class="s0">, </span><span class="s1">out_1</span><span class="s0">, </span><span class="s1">out_2]</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Compute unweighted results (default behaviour is average=&quot;macro&quot;)</span>
    <span class="s1">result_unweighted = (out_0 + out_1 + out_2) / </span><span class="s4">3.0</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s1">labels=labels)</span><span class="s0">,</span>
        <span class="s1">result_unweighted</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Tests the weighted, one-vs-rest multiclass ROC AUC algorithm</span>
    <span class="s2"># on the same input (Provost &amp; Domingos, 2000)</span>
    <span class="s1">result_weighted = out_0 * </span><span class="s4">0.25 </span><span class="s1">+ out_1 * </span><span class="s4">0.25 </span><span class="s1">+ out_2 * </span><span class="s4">0.5</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(</span>
            <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">result_weighted</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;multi_class, average&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_perfect_imperfect_chance_multiclass_roc_auc(multi_class</span><span class="s0">, </span><span class="s1">average):</span>
    <span class="s1">y_true = np.array([</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

    <span class="s2"># Perfect classifier (from a ranking point of view) has roc_auc_score = 1.0</span>
    <span class="s1">y_perfect = [</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.05</span><span class="s0">, </span><span class="s4">0.05</span><span class="s0">, </span><span class="s4">0.15</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_perfect</span><span class="s0">, </span><span class="s1">multi_class=multi_class</span><span class="s0">, </span><span class="s1">average=average)</span><span class="s0">,</span>
        <span class="s4">1.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Imperfect classifier has roc_auc_score &lt; 1.0</span>
    <span class="s1">y_imperfect = [</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_imperfect</span><span class="s0">, </span><span class="s1">multi_class=multi_class</span><span class="s0">, </span><span class="s1">average=average)</span>
        <span class="s1">&lt; </span><span class="s4">1.0</span>
    <span class="s1">)</span>

    <span class="s2"># Chance level classifier has roc_auc_score = 5.0</span>
    <span class="s1">y_chance = </span><span class="s4">0.25 </span><span class="s1">* np.ones((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_chance</span><span class="s0">, </span><span class="s1">multi_class=multi_class</span><span class="s0">, </span><span class="s1">average=average</span>
    <span class="s1">) == pytest.approx(</span><span class="s4">0.5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_micro_averaged_ovr_roc_auc(global_random_seed):</span>
    <span class="s1">seed = global_random_seed</span>
    <span class="s2"># Let's generate a set of random predictions and matching true labels such</span>
    <span class="s2"># that the predictions are not perfect. To make the problem more interesting,</span>
    <span class="s2"># we use an imbalanced class distribution (by using different parameters</span>
    <span class="s2"># in the Dirichlet prior (conjugate prior of the multinomial distribution).</span>
    <span class="s1">y_pred = stats.dirichlet.rvs([</span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">random_state=seed)</span>
    <span class="s1">y_true = np.asarray(</span>
        <span class="s1">[</span>
            <span class="s1">stats.multinomial.rvs(n=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">p=y_pred_i</span><span class="s0">, </span><span class="s1">random_state=seed).argmax()</span>
            <span class="s0">for </span><span class="s1">y_pred_i </span><span class="s0">in </span><span class="s1">y_pred</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">y_onehot = label_binarize(y_true</span><span class="s0">, </span><span class="s1">classes=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">tpr</span><span class="s0">, </span><span class="s1">_ = roc_curve(y_onehot.ravel()</span><span class="s0">, </span><span class="s1">y_pred.ravel())</span>
    <span class="s1">roc_auc_by_hand = auc(fpr</span><span class="s0">, </span><span class="s1">tpr)</span>
    <span class="s1">roc_auc_auto = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">multi_class=</span><span class="s5">&quot;ovr&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">roc_auc_by_hand == pytest.approx(roc_auc_auto)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;msg, y_true, labels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s5">&quot;Parameter 'labels' must be unique&quot;</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s5">&quot;Parameter 'labels' must be unique&quot;</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">&quot;Number of classes in y_true not equal to the number of columns &quot;</span>
                <span class="s5">&quot;in 'y_score'&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s0">None,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s5">&quot;Parameter 'labels' must be ordered&quot;</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">&quot;Number of given labels, 2, not equal to the number of columns in &quot;</span>
                <span class="s5">&quot;'y_score', 3&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">&quot;Number of given labels, 2, not equal to the number of columns in &quot;</span>
                <span class="s5">&quot;'y_score', 3&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">&quot;Number of given labels, 4, not equal to the number of columns in &quot;</span>
                <span class="s5">&quot;'y_score', 3&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">&quot;Number of given labels, 4, not equal to the number of columns in &quot;</span>
                <span class="s5">&quot;'y_score', 3&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s5">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;e&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s5">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s5">&quot;'y_true' contains labels not in parameter 'labels'&quot;</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;multi_class&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s5">&quot;ovr&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_roc_auc_score_multiclass_labels_error(msg</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">labels</span><span class="s0">, </span><span class="s1">multi_class):</span>
    <span class="s1">y_scores = np.array(</span>
        <span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.35</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">labels=labels</span><span class="s0">, </span><span class="s1">multi_class=multi_class)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;msg, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">r&quot;average must be one of \('macro', 'weighted', None\) for &quot;</span>
                <span class="s5">r&quot;multiclass problems&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s5">&quot;average&quot;</span><span class="s1">: </span><span class="s5">&quot;samples&quot;</span><span class="s0">, </span><span class="s5">&quot;multi_class&quot;</span><span class="s1">: </span><span class="s5">&quot;ovo&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">r&quot;average must be one of \('micro', 'macro', 'weighted', None\) for &quot;</span>
                <span class="s5">r&quot;multiclass problems&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s5">&quot;average&quot;</span><span class="s1">: </span><span class="s5">&quot;samples&quot;</span><span class="s0">, </span><span class="s5">&quot;multi_class&quot;</span><span class="s1">: </span><span class="s5">&quot;ovr&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">r&quot;sample_weight is not supported for multiclass one-vs-one &quot;</span>
                <span class="s5">r&quot;ROC AUC, 'sample_weight' must be None in this case&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s5">&quot;multi_class&quot;</span><span class="s1">: </span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s5">&quot;sample_weight&quot;</span><span class="s1">: []}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span>
                <span class="s5">r&quot;Partial AUC computation not available in multiclass setting, &quot;</span>
                <span class="s5">r&quot;'max_fpr' must be set to `None`, received `max_fpr=0.5` &quot;</span>
                <span class="s5">r&quot;instead&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s5">&quot;multi_class&quot;</span><span class="s1">: </span><span class="s5">&quot;ovo&quot;</span><span class="s0">, </span><span class="s5">&quot;max_fpr&quot;</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">r&quot;multi_class must be in \('ovo', 'ovr'\)&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_roc_auc_score_multiclass_error(msg</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s2"># Test that roc_auc_score function returns an error when trying</span>
    <span class="s2"># to compute multiclass AUC for parameters where an output</span>
    <span class="s2"># is not defined.</span>
    <span class="s1">rng = check_random_state(</span><span class="s4">404</span><span class="s1">)</span>
    <span class="s1">y_score = rng.rand(</span><span class="s4">20</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">y_prob = softmax(y_score)</span>
    <span class="s1">y_true = rng.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_prob</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">test_auc_score_non_binary_class():</span>
    <span class="s2"># Test that roc_auc_score function returns an error when trying</span>
    <span class="s2"># to compute AUC for non-binary class values.</span>
    <span class="s1">rng = check_random_state(</span><span class="s4">404</span><span class="s1">)</span>
    <span class="s1">y_pred = rng.rand(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s2"># y_true contains only one class value</span>
    <span class="s1">y_true = np.zeros(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
    <span class="s1">err_msg = </span><span class="s5">&quot;ROC AUC score is not defined&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>
    <span class="s1">y_true = np.ones(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>
    <span class="s1">y_true = np.full(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s1">rng = check_random_state(</span><span class="s4">404</span><span class="s1">)</span>
        <span class="s1">y_pred = rng.rand(</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s2"># y_true contains only one class value</span>
        <span class="s1">y_true = np.zeros(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
            <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>
        <span class="s1">y_true = np.ones(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
            <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>
        <span class="s1">y_true = np.full(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;int&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
            <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;curve_func&quot;</span><span class="s0">, </span><span class="s1">CURVE_FUNCS)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_multiclass_error(curve_func):</span>
    <span class="s1">rng = check_random_state(</span><span class="s4">404</span><span class="s1">)</span>
    <span class="s1">y_true = rng.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">y_pred = rng.rand(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">msg = </span><span class="s5">&quot;multiclass format is not supported&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">curve_func(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;curve_func&quot;</span><span class="s0">, </span><span class="s1">CURVE_FUNCS)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_implicit_pos_label(curve_func):</span>
    <span class="s2"># Check that using string class labels raises an informative</span>
    <span class="s2"># error for any supported string dtype:</span>
    <span class="s1">msg = (</span>
        <span class="s5">&quot;y_true takes value in {'a', 'b'} and pos_label is &quot;</span>
        <span class="s5">&quot;not specified: either make y_true take &quot;</span>
        <span class="s5">&quot;value in {0, 1} or {-1, 1} or pass pos_label &quot;</span>
        <span class="s5">&quot;explicitly.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">curve_func(np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;&lt;U1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">curve_func(np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s2"># The error message is slightly different for bytes-encoded</span>
    <span class="s2"># class labels, but otherwise the behavior is the same:</span>
    <span class="s1">msg = (</span>
        <span class="s5">&quot;y_true takes value in {b'a', b'b'} and pos_label is &quot;</span>
        <span class="s5">&quot;not specified: either make y_true take &quot;</span>
        <span class="s5">&quot;value in {0, 1} or {-1, 1} or pass pos_label &quot;</span>
        <span class="s5">&quot;explicitly.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">curve_func(np.array([</span><span class="s6">b&quot;a&quot;</span><span class="s0">, </span><span class="s6">b&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s5">&quot;&lt;S1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s2"># Check that it is possible to use floating point class labels</span>
    <span class="s2"># that are interpreted similarly to integer class labels:</span>
    <span class="s1">y_pred = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.42</span><span class="s1">]</span>
    <span class="s1">int_curve = curve_func([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_pred)</span>
    <span class="s1">float_curve = curve_func([</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_pred)</span>
    <span class="s0">for </span><span class="s1">int_curve_part</span><span class="s0">, </span><span class="s1">float_curve_part </span><span class="s0">in </span><span class="s1">zip(int_curve</span><span class="s0">, </span><span class="s1">float_curve):</span>
        <span class="s1">np.testing.assert_allclose(int_curve_part</span><span class="s0">, </span><span class="s1">float_curve_part)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;curve_func&quot;</span><span class="s0">, </span><span class="s1">CURVE_FUNCS)</span>
<span class="s0">def </span><span class="s1">test_binary_clf_curve_zero_sample_weight(curve_func):</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span>
    <span class="s1">sample_weight = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s1">result_1 = curve_func(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight)</span>
    <span class="s1">result_2 = curve_func(y_true[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_score[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight[:-</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s0">for </span><span class="s1">arr_1</span><span class="s0">, </span><span class="s1">arr_2 </span><span class="s0">in </span><span class="s1">zip(result_1</span><span class="s0">, </span><span class="s1">result_2):</span>
        <span class="s1">assert_allclose(arr_1</span><span class="s0">, </span><span class="s1">arr_2)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;drop&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_precision_recall_curve(drop):</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">_test_precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop)</span>

    <span class="s2"># Make sure the first point of the Precision-Recall on the right is:</span>
    <span class="s2"># (p=1.0, r=class balance) on a non-balanced dataset [1:]</span>
    <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">t = precision_recall_curve(y_true[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">y_score[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
    <span class="s0">assert </span><span class="s1">r[</span><span class="s4">0</span><span class="s1">] == </span><span class="s4">1.0</span>
    <span class="s0">assert </span><span class="s1">p[</span><span class="s4">0</span><span class="s1">] == y_true[</span><span class="s4">1</span><span class="s1">:].mean()</span>

    <span class="s2"># Use {-1, 1} for labels; make sure original labels aren't modified</span>
    <span class="s1">y_true[np.where(y_true == </span><span class="s4">0</span><span class="s1">)] = -</span><span class="s4">1</span>
    <span class="s1">y_true_copy = y_true.copy()</span>
    <span class="s1">_test_precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop)</span>
    <span class="s1">assert_array_equal(y_true_copy</span><span class="s0">, </span><span class="s1">y_true)</span>

    <span class="s1">labels = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">predict_probas = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
    <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">t = precision_recall_curve(labels</span><span class="s0">, </span><span class="s1">predict_probas</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
    <span class="s0">if </span><span class="s1">drop:</span>
        <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.33333333</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(t</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.33333333</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(t</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">p.size == r.size</span>
    <span class="s0">assert </span><span class="s1">p.size == t.size + </span><span class="s4">1</span>


<span class="s0">def </span><span class="s1">_test_precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop):</span>
    <span class="s2"># Test Precision-Recall and area under PR curve</span>
    <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
    <span class="s1">precision_recall_auc = _average_precision_slow(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_array_almost_equal(precision_recall_auc</span><span class="s0">, </span><span class="s4">0.859</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(</span>
        <span class="s1">precision_recall_auc</span><span class="s0">, </span><span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">)</span>
    <span class="s2"># `_average_precision` is not very precise in case of 0.5 ties: be tolerant</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">_average_precision(y_true</span><span class="s0">, </span><span class="s1">y_score)</span><span class="s0">, </span><span class="s1">precision_recall_auc</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">p.size == r.size</span>
    <span class="s0">assert </span><span class="s1">p.size == thresholds.size + </span><span class="s4">1</span>
    <span class="s2"># Smoke test in the case of proba having only one value</span>
    <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">np.zeros_like(y_score)</span><span class="s0">, </span><span class="s1">drop_intermediate=drop</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">p.size == r.size</span>
    <span class="s0">assert </span><span class="s1">p.size == thresholds.size + </span><span class="s4">1</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;drop&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_precision_recall_curve_toydata(drop):</span>
    <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">&quot;raise&quot;</span><span class="s1">):</span>
        <span class="s2"># Binary classification</span>
        <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(auc_prc</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>
        <span class="s2"># Here we are doing a terrible prediction: we are always getting</span>
        <span class="s2"># it wrong, hence the average_precision_score is the accuracy at</span>
        <span class="s2"># chance: 50%</span>
        <span class="s1">assert_almost_equal(auc_prc</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(auc_prc</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(auc_prc</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(auc_prc</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">auc_prc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
        <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_allclose(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(auc_prc</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

        <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">y_score = [</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">_ = precision_recall_curve(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=drop)</span>
        <span class="s1">assert_almost_equal(average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(p</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>

        <span class="s2"># Multi-label classification task</span>
        <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span>
            <span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span>
        <span class="s1">)</span>
        <span class="s1">assert_allclose(average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

        <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span>
            <span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.75</span>
        <span class="s1">)</span>
        <span class="s1">assert_allclose(average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>

        <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>

        <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.0</span>
            <span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.0</span>
        <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.0</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.0</span>
            <span class="s1">)</span>

        <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">assert_allclose(average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span>
        <span class="s1">)</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span>
        <span class="s1">)</span>
        <span class="s1">assert_allclose(average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span>

        <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;macro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;samples&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;micro&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0.5</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">&quot;ignore&quot;</span><span class="s1">):</span>
        <span class="s2"># if one class is never present weighted should not be NaN</span>
        <span class="s1">y_true = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s1">y_score = np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">&quot;No positive class found in y_true&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(</span>
                <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">average=</span><span class="s5">&quot;weighted&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span>
            <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_precision_recall_curve_drop_intermediate():</span>
    <span class="s3">&quot;&quot;&quot;Check the behaviour of the `drop_intermediate` parameter.&quot;&quot;&quot;</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span>
    <span class="s1">precision</span><span class="s0">, </span><span class="s1">recall</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(thresholds</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s2"># Test dropping thresholds with repeating scores</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">]</span>
    <span class="s1">precision</span><span class="s0">, </span><span class="s1">recall</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(thresholds</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s2"># Test all false keeps only endpoints</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span>
    <span class="s1">precision</span><span class="s0">, </span><span class="s1">recall</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(thresholds</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">])</span>

    <span class="s2"># Test all true keeps all thresholds</span>
    <span class="s1">y_true = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_score = [</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span>
    <span class="s1">precision</span><span class="s0">, </span><span class="s1">recall</span><span class="s0">, </span><span class="s1">thresholds = precision_recall_curve(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">drop_intermediate=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(thresholds</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_average_precision_constant_values():</span>
    <span class="s2"># Check the average_precision_score of a constant predictor is</span>
    <span class="s2"># the TPR</span>

    <span class="s2"># Generate a dataset with 25% of positives</span>
    <span class="s1">y_true = np.zeros(</span><span class="s4">100</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">y_true[::</span><span class="s4">4</span><span class="s1">] = </span><span class="s4">1</span>
    <span class="s2"># And a constant score</span>
    <span class="s1">y_score = np.ones(</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s2"># The precision is then the fraction of positive whatever the recall</span>
    <span class="s2"># is, as there is only one threshold:</span>
    <span class="s0">assert </span><span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score) == </span><span class="s4">0.25</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_binary_pos_label_errors():</span>
    <span class="s2"># Raise an error when pos_label is not in binary y_true</span>
    <span class="s1">y_true = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">y_pred = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">err_msg = </span><span class="s5">r&quot;pos_label=2 is not a valid label. It should be one of \[0, 1\]&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">pos_label=</span><span class="s4">2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_multilabel_pos_label_errors():</span>
    <span class="s2"># Raise an error for multilabel-indicator y_true with</span>
    <span class="s2"># pos_label other than 1</span>
    <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]])</span>
    <span class="s1">y_pred = np.array([[</span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]])</span>
    <span class="s1">err_msg = (</span>
        <span class="s5">&quot;Parameter pos_label is fixed to 1 for multilabel-indicator y_true. &quot;</span>
        <span class="s5">&quot;Do not set pos_label or set pos_label to 1.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">pos_label=</span><span class="s4">0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_average_precision_score_multiclass_pos_label_errors():</span>
    <span class="s2"># Raise an error for multiclass y_true with pos_label other than 1</span>
    <span class="s1">y_true = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">y_pred = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">err_msg = (</span>
        <span class="s5">&quot;Parameter pos_label is fixed to 1 for multiclass y_true. &quot;</span>
        <span class="s5">&quot;Do not set pos_label or set pos_label to 1.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">pos_label=</span><span class="s4">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_score_scale_invariance():</span>
    <span class="s2"># Test that average_precision_score and roc_auc_score are invariant by</span>
    <span class="s2"># the scaling or shifting of probabilities</span>
    <span class="s2"># This test was expanded (added scaled_down) in response to github</span>
    <span class="s2"># issue #3864 (and others), where overly aggressive rounding was causing</span>
    <span class="s2"># problems for users with very small y_score values</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">y_score = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">roc_auc_scaled_up = roc_auc_score(y_true</span><span class="s0">, </span><span class="s4">100 </span><span class="s1">* y_score)</span>
    <span class="s1">roc_auc_scaled_down = roc_auc_score(y_true</span><span class="s0">, </span><span class="s4">1e-6 </span><span class="s1">* y_score)</span>
    <span class="s1">roc_auc_shifted = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_score - </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">roc_auc == roc_auc_scaled_up</span>
    <span class="s0">assert </span><span class="s1">roc_auc == roc_auc_scaled_down</span>
    <span class="s0">assert </span><span class="s1">roc_auc == roc_auc_shifted</span>

    <span class="s1">pr_auc = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">pr_auc_scaled_up = average_precision_score(y_true</span><span class="s0">, </span><span class="s4">100 </span><span class="s1">* y_score)</span>
    <span class="s1">pr_auc_scaled_down = average_precision_score(y_true</span><span class="s0">, </span><span class="s4">1e-6 </span><span class="s1">* y_score)</span>
    <span class="s1">pr_auc_shifted = average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score - </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">pr_auc == pr_auc_scaled_up</span>
    <span class="s0">assert </span><span class="s1">pr_auc == pr_auc_scaled_down</span>
    <span class="s0">assert </span><span class="s1">pr_auc == pr_auc_shifted</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true,y_score,expected_fpr,expected_fnr&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_toydata(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">expected_fpr</span><span class="s0">, </span><span class="s1">expected_fnr):</span>
    <span class="s2"># Check on a batch of small examples.</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">fnr</span><span class="s0">, </span><span class="s1">_ = det_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s1">assert_allclose(fpr</span><span class="s0">, </span><span class="s1">expected_fpr)</span>
    <span class="s1">assert_allclose(fnr</span><span class="s0">, </span><span class="s1">expected_fnr)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true,y_score,expected_fpr,expected_fnr&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_tie_handling(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">expected_fpr</span><span class="s0">, </span><span class="s1">expected_fnr):</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">fnr</span><span class="s0">, </span><span class="s1">_ = det_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>

    <span class="s1">assert_allclose(fpr</span><span class="s0">, </span><span class="s1">expected_fpr)</span>
    <span class="s1">assert_allclose(fnr</span><span class="s0">, </span><span class="s1">expected_fnr)</span>


<span class="s0">def </span><span class="s1">test_det_curve_sanity_check():</span>
    <span class="s2"># Exactly duplicated inputs yield the same result.</span>
    <span class="s1">assert_allclose(</span>
        <span class="s1">det_curve([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">det_curve([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;y_score&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0.25</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0.75</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_det_curve_constant_scores(y_score):</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">fnr</span><span class="s0">, </span><span class="s1">threshold = det_curve(</span>
        <span class="s1">y_true=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y_score=np.full(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">)</span>

    <span class="s1">assert_allclose(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(fnr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(threshold</span><span class="s0">, </span><span class="s1">[y_score])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_perfect_scores(y_true):</span>
    <span class="s1">fpr</span><span class="s0">, </span><span class="s1">fnr</span><span class="s0">, </span><span class="s1">_ = det_curve(y_true=y_true</span><span class="s0">, </span><span class="s1">y_score=y_true)</span>

    <span class="s1">assert_allclose(fpr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(fnr</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, y_pred, err_msg&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">&quot;inconsistent numbers of samples&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s5">&quot;inconsistent numbers of samples&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">&quot;Only one class present in y_true&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">&quot;Only one class present in y_true&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s5">&quot;cancer&quot;</span><span class="s0">, </span><span class="s5">&quot;cancer&quot;</span><span class="s0">, </span><span class="s5">&quot;not cancer&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s5">&quot;pos_label is not specified&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_det_curve_bad_input(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">err_msg):</span>
    <span class="s2"># input variables with inconsistent numbers of samples</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">det_curve(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>


<span class="s0">def </span><span class="s1">test_det_curve_pos_label():</span>
    <span class="s1">y_true = [</span><span class="s5">&quot;cancer&quot;</span><span class="s1">] * </span><span class="s4">3 </span><span class="s1">+ [</span><span class="s5">&quot;not cancer&quot;</span><span class="s1">] * </span><span class="s4">7</span>
    <span class="s1">y_pred_pos_not_cancer = np.array([</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.9</span><span class="s1">])</span>
    <span class="s1">y_pred_pos_cancer = </span><span class="s4">1 </span><span class="s1">- y_pred_pos_not_cancer</span>

    <span class="s1">fpr_pos_cancer</span><span class="s0">, </span><span class="s1">fnr_pos_cancer</span><span class="s0">, </span><span class="s1">th_pos_cancer = det_curve(</span>
        <span class="s1">y_true</span><span class="s0">,</span>
        <span class="s1">y_pred_pos_cancer</span><span class="s0">,</span>
        <span class="s1">pos_label=</span><span class="s5">&quot;cancer&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">fpr_pos_not_cancer</span><span class="s0">, </span><span class="s1">fnr_pos_not_cancer</span><span class="s0">, </span><span class="s1">th_pos_not_cancer = det_curve(</span>
        <span class="s1">y_true</span><span class="s0">,</span>
        <span class="s1">y_pred_pos_not_cancer</span><span class="s0">,</span>
        <span class="s1">pos_label=</span><span class="s5">&quot;not cancer&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># check that the first threshold will change depending which label we</span>
    <span class="s2"># consider positive</span>
    <span class="s0">assert </span><span class="s1">th_pos_cancer[</span><span class="s4">0</span><span class="s1">] == pytest.approx(</span><span class="s4">0.4</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">th_pos_not_cancer[</span><span class="s4">0</span><span class="s1">] == pytest.approx(</span><span class="s4">0.2</span><span class="s1">)</span>

    <span class="s2"># check for the symmetry of the fpr and fnr</span>
    <span class="s1">assert_allclose(fpr_pos_cancer</span><span class="s0">, </span><span class="s1">fnr_pos_not_cancer[::-</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(fnr_pos_cancer</span><span class="s0">, </span><span class="s1">fpr_pos_not_cancer[::-</span><span class="s4">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">check_lrap_toy(lrap_score):</span>
    <span class="s2"># Check on several small example that it works</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">1</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s2"># Tie handling</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2</span>
    <span class="s1">)</span>
    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(lrap_score([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3 </span><span class="s1">/ </span><span class="s4">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">check_zero_or_all_relevant_labels(lrap_score):</span>
    <span class="s1">random_state = check_random_state(</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">):</span>
        <span class="s1">y_score = random_state.uniform(size=(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
        <span class="s1">y_score_ties = np.zeros_like(y_score)</span>

        <span class="s2"># No relevant labels</span>
        <span class="s1">y_true = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
        <span class="s0">assert </span><span class="s1">lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score) == </span><span class="s4">1.0</span>
        <span class="s0">assert </span><span class="s1">lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score_ties) == </span><span class="s4">1.0</span>

        <span class="s2"># Only relevant labels</span>
        <span class="s1">y_true = np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
        <span class="s0">assert </span><span class="s1">lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score) == </span><span class="s4">1.0</span>
        <span class="s0">assert </span><span class="s1">lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score_ties) == </span><span class="s4">1.0</span>

    <span class="s2"># Degenerate case: only one label</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">lrap_score([[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1.0</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">check_lrap_error_raised(lrap_score):</span>
    <span class="s2"># Raise value error if not appropriate format</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score(</span>
            <span class="s1">[(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]]</span>
        <span class="s1">)</span>

    <span class="s2"># Check that y_true.shape != y_score.shape raise the proper exception</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">lrap_score([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">check_lrap_only_ties(lrap_score):</span>
    <span class="s2"># Check tie handling in score</span>
    <span class="s2"># Basic check with only ties and increasing label space</span>
    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">10</span><span class="s1">):</span>
        <span class="s1">y_score = np.ones((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>

        <span class="s2"># Check for growing number of consecutive relevant</span>
        <span class="s0">for </span><span class="s1">n_relevant </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels):</span>
            <span class="s2"># Check for a bunch of positions</span>
            <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range(n_labels - n_relevant):</span>
                <span class="s1">y_true = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
                <span class="s1">y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">pos : pos + n_relevant] = </span><span class="s4">1</span>
                <span class="s1">assert_almost_equal(lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span><span class="s0">, </span><span class="s1">n_relevant / n_labels)</span>


<span class="s0">def </span><span class="s1">check_lrap_without_tie_and_increasing_score(lrap_score):</span>
    <span class="s2"># Check that Label ranking average precision works for various</span>
    <span class="s2"># Basic check with increasing label space size and decreasing score</span>
    <span class="s0">for </span><span class="s1">n_labels </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">10</span><span class="s1">):</span>
        <span class="s1">y_score = n_labels - (np.arange(n_labels).reshape((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels)) + </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s2"># First and last</span>
        <span class="s1">y_true = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
        <span class="s1">y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">assert_almost_equal(lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2 </span><span class="s1">/ n_labels + </span><span class="s4">1</span><span class="s1">) / </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s2"># Check for growing number of consecutive relevant label</span>
        <span class="s0">for </span><span class="s1">n_relevant </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels):</span>
            <span class="s2"># Check for a bunch of position</span>
            <span class="s0">for </span><span class="s1">pos </span><span class="s0">in </span><span class="s1">range(n_labels - n_relevant):</span>
                <span class="s1">y_true = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">n_labels))</span>
                <span class="s1">y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">pos : pos + n_relevant] = </span><span class="s4">1</span>
                <span class="s1">assert_almost_equal(</span>
                    <span class="s1">lrap_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span><span class="s0">,</span>
                    <span class="s1">sum(</span>
                        <span class="s1">(r + </span><span class="s4">1</span><span class="s1">) / ((pos + r + </span><span class="s4">1</span><span class="s1">) * n_relevant)</span>
                        <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">range(n_relevant)</span>
                    <span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span>


<span class="s0">def </span><span class="s1">_my_lrap(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s3">&quot;&quot;&quot;Simple implementation of label ranking average precision&quot;&quot;&quot;</span>
    <span class="s1">check_consistent_length(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">y_true = check_array(y_true)</span>
    <span class="s1">y_score = check_array(y_score)</span>
    <span class="s1">n_samples</span><span class="s0">, </span><span class="s1">n_labels = y_true.shape</span>
    <span class="s1">score = np.empty((n_samples</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(n_samples):</span>
        <span class="s2"># The best rank correspond to 1. Rank higher than 1 are worse.</span>
        <span class="s2"># The best inverse ranking correspond to n_labels.</span>
        <span class="s1">unique_rank</span><span class="s0">, </span><span class="s1">inv_rank = np.unique(y_score[i]</span><span class="s0">, </span><span class="s1">return_inverse=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">n_ranks = unique_rank.size</span>
        <span class="s1">rank = n_ranks - inv_rank</span>

        <span class="s2"># Rank need to be corrected to take into account ties</span>
        <span class="s2"># ex: rank 1 ex aequo means that both label are rank 2.</span>
        <span class="s1">corr_rank = np.bincount(rank</span><span class="s0">, </span><span class="s1">minlength=n_ranks + </span><span class="s4">1</span><span class="s1">).cumsum()</span>
        <span class="s1">rank = corr_rank[rank]</span>

        <span class="s1">relevant = y_true[i].nonzero()[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">relevant.size == </span><span class="s4">0 </span><span class="s0">or </span><span class="s1">relevant.size == n_labels:</span>
            <span class="s1">score[i] = </span><span class="s4">1</span>
            <span class="s0">continue</span>

        <span class="s1">score[i] = </span><span class="s4">0.0</span>
        <span class="s0">for </span><span class="s1">label </span><span class="s0">in </span><span class="s1">relevant:</span>
            <span class="s2"># Let's count the number of relevant label with better rank</span>
            <span class="s2"># (smaller rank).</span>
            <span class="s1">n_ranked_above = sum(rank[r] &lt;= rank[label] </span><span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">relevant)</span>

            <span class="s2"># Weight by the rank of the actual label</span>
            <span class="s1">score[i] += n_ranked_above / rank[label]</span>

        <span class="s1">score[i] /= relevant.size</span>

    <span class="s0">return </span><span class="s1">score.mean()</span>


<span class="s0">def </span><span class="s1">check_alternative_lrap_implementation(</span>
    <span class="s1">lrap_score</span><span class="s0">, </span><span class="s1">n_classes=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">n_samples=</span><span class="s4">20</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s4">0</span>
<span class="s1">):</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">y_true = make_multilabel_classification(</span>
        <span class="s1">n_features=</span><span class="s4">1</span><span class="s0">,</span>
        <span class="s1">allow_unlabeled=</span><span class="s0">False,</span>
        <span class="s1">random_state=random_state</span><span class="s0">,</span>
        <span class="s1">n_classes=n_classes</span><span class="s0">,</span>
        <span class="s1">n_samples=n_samples</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Score with ties</span>
    <span class="s1">y_score = _sparse_random_matrix(</span>
        <span class="s1">n_components=y_true.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">n_features=y_true.shape[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">random_state=random_state</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">hasattr(y_score</span><span class="s0">, </span><span class="s5">&quot;toarray&quot;</span><span class="s1">):</span>
        <span class="s1">y_score = y_score.toarray()</span>
    <span class="s1">score_lrap = label_ranking_average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">score_my_lrap = _my_lrap(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_almost_equal(score_lrap</span><span class="s0">, </span><span class="s1">score_my_lrap)</span>

    <span class="s2"># Uniform score</span>
    <span class="s1">random_state = check_random_state(random_state)</span>
    <span class="s1">y_score = random_state.uniform(size=(n_samples</span><span class="s0">, </span><span class="s1">n_classes))</span>
    <span class="s1">score_lrap = label_ranking_average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">score_my_lrap = _my_lrap(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">assert_almost_equal(score_lrap</span><span class="s0">, </span><span class="s1">score_my_lrap)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;check&quot;</span><span class="s0">,</span>
    <span class="s1">(</span>
        <span class="s1">check_lrap_toy</span><span class="s0">,</span>
        <span class="s1">check_lrap_without_tie_and_increasing_score</span><span class="s0">,</span>
        <span class="s1">check_lrap_only_ties</span><span class="s0">,</span>
        <span class="s1">check_zero_or_all_relevant_labels</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;func&quot;</span><span class="s0">, </span><span class="s1">(label_ranking_average_precision_score</span><span class="s0">, </span><span class="s1">_my_lrap))</span>
<span class="s0">def </span><span class="s1">test_label_ranking_avp(check</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">check(func)</span>


<span class="s0">def </span><span class="s1">test_lrap_error_raised():</span>
    <span class="s1">check_lrap_error_raised(label_ranking_average_precision_score)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;n_samples&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;n_classes&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;random_state&quot;</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">1</span><span class="s1">))</span>
<span class="s0">def </span><span class="s1">test_alternative_lrap_implementation(n_samples</span><span class="s0">, </span><span class="s1">n_classes</span><span class="s0">, </span><span class="s1">random_state):</span>
    <span class="s1">check_alternative_lrap_implementation(</span>
        <span class="s1">label_ranking_average_precision_score</span><span class="s0">, </span><span class="s1">n_classes</span><span class="s0">, </span><span class="s1">n_samples</span><span class="s0">, </span><span class="s1">random_state</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_lrap_sample_weighting_zero_labels():</span>
    <span class="s2"># Degenerate sample labeling (e.g., zero labels for a sample) is a valid</span>
    <span class="s2"># special case for lrap (the sample is considered to achieve perfect</span>
    <span class="s2"># precision), but this case is not tested in test_common.</span>
    <span class="s2"># For these test samples, the APs are 0.5, 0.75, and 1.0 (default for zero</span>
    <span class="s2"># labels).</span>
    <span class="s1">y_true = np.array([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
    <span class="s1">y_score = np.array(</span>
        <span class="s1">[[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]]</span>
    <span class="s1">)</span>
    <span class="s1">samplewise_lraps = np.array([</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">])</span>
    <span class="s1">sample_weight = np.array([</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">])</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">label_ranking_average_precision_score(</span>
            <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.sum(sample_weight * samplewise_lraps) / np.sum(sample_weight)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_coverage_error():</span>
    <span class="s2"># Toy case</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>

    <span class="s2"># Non trivial case</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">2.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">coverage_error(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">3.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">coverage_error(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">3</span><span class="s1">) / </span><span class="s4">3.0</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_coverage_tie_handling():</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(coverage_error([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, y_score&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_coverage_1d_error_message(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s2"># Non-regression test for:</span>
    <span class="s2"># https://github.com/scikit-learn/scikit-learn/issues/23368</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s5">r&quot;Expected 2D array, got 1D array instead&quot;</span><span class="s1">):</span>
        <span class="s1">coverage_error(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>


<span class="s0">def </span><span class="s1">test_label_ranking_loss():</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s2"># Undefined metrics -  the ranking doesn't matter</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>

    <span class="s2"># Non trivial case</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">0 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">label_ranking_loss(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">0 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">3.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_almost_equal(</span>
        <span class="s1">label_ranking_loss(</span>
            <span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">0 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">3.0</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s2"># Sparse csr matrices</span>
    <span class="s1">assert_almost_equal(</span>
        <span class="s1">label_ranking_loss(</span>
            <span class="s1">csr_matrix(np.array([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]))</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">0 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2.0</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ranking_appropriate_input_shape():</span>
    <span class="s2"># Check that y_true.shape != y_score.shape raise the proper exception</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_ranking_loss_ties_handling():</span>
    <span class="s2"># Tie handling</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1 </span><span class="s1">/ </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(label_ranking_loss([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">]])</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_dcg_score():</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">y_true = make_multilabel_classification(random_state=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">n_classes=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">y_score = -y_true + </span><span class="s4">1</span>
    <span class="s1">_test_dcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score = np.random.RandomState(</span><span class="s4">0</span><span class="s1">).random_sample((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">_test_dcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>


<span class="s0">def </span><span class="s1">_test_dcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s1">discount = np.log2(np.arange(y_true.shape[</span><span class="s4">1</span><span class="s1">]) + </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">ideal = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_true)</span>
    <span class="s1">score = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s0">assert </span><span class="s1">(score &lt;= ideal).all()</span>
    <span class="s0">assert </span><span class="s1">(_dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">k=</span><span class="s4">5</span><span class="s1">) &lt;= ideal).all()</span>
    <span class="s0">assert </span><span class="s1">ideal.shape == (y_true.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">score.shape == (y_true.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ideal == pytest.approx((np.sort(y_true)[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">] / discount).sum(axis=</span><span class="s4">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_dcg_ties():</span>
    <span class="s1">y_true = np.asarray([np.arange(</span><span class="s4">5</span><span class="s1">)])</span>
    <span class="s1">y_score = np.zeros(y_true.shape)</span>
    <span class="s1">dcg = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">dcg_ignore_ties = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">discounts = </span><span class="s4">1 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">dcg == pytest.approx([discounts.sum() * y_true.mean()])</span>
    <span class="s0">assert </span><span class="s1">dcg_ignore_ties == pytest.approx([(discounts * y_true[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]).sum()])</span>
    <span class="s1">y_score[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">:] = </span><span class="s4">1</span>
    <span class="s1">dcg = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">dcg_ignore_ties = _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">dcg_ignore_ties == pytest.approx([(discounts * y_true[:</span><span class="s0">, </span><span class="s1">::-</span><span class="s4">1</span><span class="s1">]).sum()])</span>
    <span class="s0">assert </span><span class="s1">dcg == pytest.approx(</span>
        <span class="s1">[</span>
            <span class="s1">discounts[:</span><span class="s4">2</span><span class="s1">].sum() * y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s1">:].mean()</span>
            <span class="s1">+ discounts[</span><span class="s4">2</span><span class="s1">:].sum() * y_true[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">:</span><span class="s4">3</span><span class="s1">].mean()</span>
        <span class="s1">]</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_ignore_ties_with_k():</span>
    <span class="s1">a = np.arange(</span><span class="s4">12</span><span class="s1">).reshape((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">ndcg_score(a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">k=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">ignore_ties=</span><span class="s0">True</span><span class="s1">) == pytest.approx(</span>
        <span class="s1">ndcg_score(a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">k=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">ignore_ties=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">)</span>


<span class="s2"># TODO(1.4): Replace warning w/ ValueError</span>
<span class="s0">def </span><span class="s1">test_ndcg_negative_ndarray_warn():</span>
    <span class="s1">y_true = np.array([[-</span><span class="s4">0.89</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.53</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.47</span><span class="s0">, </span><span class="s4">0.39</span><span class="s0">, </span><span class="s4">0.56</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0.07</span><span class="s0">, </span><span class="s4">0.31</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.33</span><span class="s0">, </span><span class="s4">0.27</span><span class="s1">]])</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">&quot;ndcg_score should not be used on negative y_true values. ndcg_score will raise&quot;</span>
        <span class="s5">&quot; a ValueError on negative y_true values starting from version 1.4.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s0">assert </span><span class="s1">ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score) == pytest.approx(</span><span class="s4">396.0329</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_invariant():</span>
    <span class="s1">y_true = np.arange(</span><span class="s4">70</span><span class="s1">).reshape(</span><span class="s4">7</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">y_score = y_true + np.random.RandomState(</span><span class="s4">0</span><span class="s1">).uniform(-</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s1">size=y_true.shape)</span>
    <span class="s1">ndcg = ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">ndcg_no_ties = ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ndcg == pytest.approx(ndcg_no_ties)</span>
    <span class="s0">assert </span><span class="s1">ndcg == pytest.approx(</span><span class="s4">1.0</span><span class="s1">)</span>
    <span class="s1">y_score += </span><span class="s4">1000</span>
    <span class="s0">assert </span><span class="s1">ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score) == pytest.approx(</span><span class="s4">1.0</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;ignore_ties&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_ndcg_toy_examples(ignore_ties):</span>
    <span class="s1">y_true = </span><span class="s4">3 </span><span class="s1">* np.eye(</span><span class="s4">7</span><span class="s1">)[:</span><span class="s4">5</span><span class="s1">]</span>
    <span class="s1">y_score = np.tile(np.arange(</span><span class="s4">6</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">y_score_noisy = y_score + np.random.RandomState(</span><span class="s4">0</span><span class="s1">).uniform(</span>
        <span class="s1">-</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s1">size=y_score.shape</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(</span><span class="s4">3 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score_noisy</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(</span><span class="s4">3 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">_ndcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(</span><span class="s4">1 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">log_base=</span><span class="s4">10</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(</span><span class="s4">3 </span><span class="s1">/ np.log10(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties) == pytest.approx(</span>
        <span class="s1">(</span><span class="s4">1 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))).mean()</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">dcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties) == pytest.approx(</span>
        <span class="s1">(</span><span class="s4">3 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))).mean()</span>
    <span class="s1">)</span>
    <span class="s1">y_true = </span><span class="s4">3 </span><span class="s1">* np.ones((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s1">))</span>
    <span class="s1">expected_dcg_score = (</span><span class="s4">3 </span><span class="s1">/ np.log2(np.arange(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">9</span><span class="s1">))).sum()</span>
    <span class="s0">assert </span><span class="s1">_dcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(expected_dcg_score * np.ones(</span><span class="s4">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">_ndcg_sample_scores(</span>
        <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties</span>
    <span class="s1">) == pytest.approx(np.ones(</span><span class="s4">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">dcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties) == pytest.approx(</span>
        <span class="s1">expected_dcg_score</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ndcg_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">ignore_ties=ignore_ties) == pytest.approx(</span><span class="s4">1.0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ndcg_error_single_document():</span>
    <span class="s3">&quot;&quot;&quot;Check that we raise an informative error message when trying to 
    compute NDCG with a single document.&quot;&quot;&quot;</span>
    <span class="s1">err_msg = (</span>
        <span class="s5">&quot;Computing NDCG is only meaningful when there is more than 1 document. &quot;</span>
        <span class="s5">&quot;Got 1 instead.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">ndcg_score([[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s4">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_ndcg_score():</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">y_true = make_multilabel_classification(random_state=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">n_classes=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">y_score = -y_true + </span><span class="s4">1</span>
    <span class="s1">_test_ndcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_score = np.random.RandomState(</span><span class="s4">0</span><span class="s1">).random_sample((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">_test_ndcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>


<span class="s0">def </span><span class="s1">_test_ndcg_score_for(y_true</span><span class="s0">, </span><span class="s1">y_score):</span>
    <span class="s1">ideal = _ndcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_true)</span>
    <span class="s1">score = _ndcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s0">assert </span><span class="s1">(score &lt;= ideal).all()</span>
    <span class="s1">all_zero = (y_true == </span><span class="s4">0</span><span class="s1">).all(axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ideal[~all_zero] == pytest.approx(np.ones((~all_zero).sum()))</span>
    <span class="s0">assert </span><span class="s1">ideal[all_zero] == pytest.approx(np.zeros(all_zero.sum()))</span>
    <span class="s0">assert </span><span class="s1">score[~all_zero] == pytest.approx(</span>
        <span class="s1">_dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_score)[~all_zero]</span>
        <span class="s1">/ _dcg_sample_scores(y_true</span><span class="s0">, </span><span class="s1">y_true)[~all_zero]</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">score[all_zero] == pytest.approx(np.zeros(all_zero.sum()))</span>
    <span class="s0">assert </span><span class="s1">ideal.shape == (y_true.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">score.shape == (y_true.shape[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_partial_roc_auc_score():</span>
    <span class="s2"># Check `roc_auc_score` for max_fpr != `None`</span>
    <span class="s1">y_true = np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">1</span><span class="s1">) == </span><span class="s4">1</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">0.001</span><span class="s1">) == </span><span class="s4">1</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">max_fpr=-</span><span class="s4">0.1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">1.1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">y_scores = np.array([</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.01</span><span class="s1">])</span>
    <span class="s1">roc_auc_with_max_fpr_one = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">unconstrained_roc_auc = roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores)</span>
    <span class="s0">assert </span><span class="s1">roc_auc_with_max_fpr_one == unconstrained_roc_auc</span>
    <span class="s0">assert </span><span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_scores</span><span class="s0">, </span><span class="s1">max_fpr=</span><span class="s4">0.3</span><span class="s1">) == </span><span class="s4">0.5</span>

    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">_ = make_prediction(binary=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">max_fpr </span><span class="s0">in </span><span class="s1">np.linspace(</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s1">):</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">max_fpr=max_fpr)</span><span class="s0">,</span>
            <span class="s1">_partial_roc_auc_score(y_true</span><span class="s0">, </span><span class="s1">y_pred</span><span class="s0">, </span><span class="s1">max_fpr)</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, k, true_score&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0.75</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">true_score):</span>
    <span class="s1">y_score = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">score = top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=k)</span>
    <span class="s0">assert </span><span class="s1">score == pytest.approx(true_score)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_score, k, true_score&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.array([-</span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">])</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">])</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">])</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_binary(y_score</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">true_score):</span>
    <span class="s1">y_true = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>

    <span class="s1">threshold = </span><span class="s4">0.5 </span><span class="s0">if </span><span class="s1">y_score.min() &gt;= </span><span class="s4">0 </span><span class="s0">and </span><span class="s1">y_score.max() &lt;= </span><span class="s4">1 </span><span class="s0">else </span><span class="s4">0</span>
    <span class="s1">y_pred = (y_score &gt; threshold).astype(np.int64) </span><span class="s0">if </span><span class="s1">k == </span><span class="s4">1 </span><span class="s0">else </span><span class="s1">y_true</span>

    <span class="s1">score = top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=k)</span>
    <span class="s1">score_acc = accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_pred)</span>

    <span class="s0">assert </span><span class="s1">score == score_acc == pytest.approx(true_score)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, true_score, labels&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;e&quot;</span><span class="s0">, </span><span class="s5">&quot;e&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s1">])</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;d&quot;</span><span class="s0">, </span><span class="s5">&quot;e&quot;</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;labels_as_ndarray&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_multiclass_with_labels(</span>
    <span class="s1">y_true</span><span class="s0">, </span><span class="s1">true_score</span><span class="s0">, </span><span class="s1">labels</span><span class="s0">, </span><span class="s1">labels_as_ndarray</span>
<span class="s1">):</span>
    <span class="s3">&quot;&quot;&quot;Test when labels and y_score are multiclass.&quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">labels_as_ndarray:</span>
        <span class="s1">labels = np.asarray(labels)</span>
    <span class="s1">y_score = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">score = top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">labels=labels)</span>
    <span class="s0">assert </span><span class="s1">score == pytest.approx(true_score)</span>


<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_increasing():</span>
    <span class="s2"># Make sure increasing k leads to a higher score</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = datasets.make_classification(</span>
        <span class="s1">n_classes=</span><span class="s4">10</span><span class="s0">, </span><span class="s1">n_samples=</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">n_informative=</span><span class="s4">10</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s4">0</span>
    <span class="s1">)</span>

    <span class="s1">X_train</span><span class="s0">, </span><span class="s1">X_test</span><span class="s0">, </span><span class="s1">y_train</span><span class="s0">, </span><span class="s1">y_test = train_test_split(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s4">0</span><span class="s1">)</span>

    <span class="s1">clf = LogisticRegression(random_state=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">clf.fit(X_train</span><span class="s0">, </span><span class="s1">y_train)</span>

    <span class="s0">for </span><span class="s1">X</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip((X_train</span><span class="s0">, </span><span class="s1">X_test)</span><span class="s0">, </span><span class="s1">(y_train</span><span class="s0">, </span><span class="s1">y_test)):</span>
        <span class="s1">scores = [</span>
            <span class="s1">top_k_accuracy_score(y</span><span class="s0">, </span><span class="s1">clf.predict_proba(X)</span><span class="s0">, </span><span class="s1">k=k) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
        <span class="s1">]</span>

        <span class="s0">assert </span><span class="s1">np.all(np.diff(scores) &gt; </span><span class="s4">0</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, k, true_score&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.25</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_ties(y_true</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">true_score):</span>
    <span class="s2"># Make sure highest indices labels are chosen first in case of ties</span>
    <span class="s1">y_score = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=k) == pytest.approx(true_score)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, k&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_warning(y_true</span><span class="s0">, </span><span class="s1">k):</span>
    <span class="s1">y_score = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">expected_message = (</span>
        <span class="s5">r&quot;'k' \(\d+\) greater than or equal to 'n_classes' \(\d+\) will result in a &quot;</span>
        <span class="s5">&quot;perfect score and is therefore meaningless.&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UndefinedMetricWarning</span><span class="s0">, </span><span class="s1">match=expected_message):</span>
        <span class="s1">score = top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=k)</span>
    <span class="s0">assert </span><span class="s1">score == </span><span class="s4">1</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;y_true, y_score, labels, msg&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.57</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s5">&quot;y type must be 'binary' or 'multiclass', got 'continuous'&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s5">r&quot;Number of classes in 'y_true' \(4\) not equal to the number of &quot;</span>
            <span class="s5">r&quot;classes in 'y_score' \(3\).&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s5">&quot;Parameter 'labels' must be unique.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">&quot;a&quot;</span><span class="s0">, </span><span class="s5">&quot;c&quot;</span><span class="s0">, </span><span class="s5">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s5">&quot;Parameter 'labels' must be ordered.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s5">r&quot;Number of given labels \(4\) not equal to the number of classes in &quot;</span>
            <span class="s5">r&quot;'y_score' \(3\).&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s5">&quot;'y_true' contains labels not in parameter 'labels'.&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.2</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0.3</span><span class="s0">, </span><span class="s4">0.4</span><span class="s0">, </span><span class="s4">0.2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s0">None,</span>
            <span class="s1">(</span>
                <span class="s5">&quot;`y_true` is binary while y_score is 2d with 3 classes. If&quot;</span>
                <span class="s5">&quot; `y_true` does not contain all the labels, `labels` must be provided&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_top_k_accuracy_score_error(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">labels</span><span class="s0">, </span><span class="s1">msg):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">top_k_accuracy_score(y_true</span><span class="s0">, </span><span class="s1">y_score</span><span class="s0">, </span><span class="s1">k=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">labels=labels)</span>


<span class="s0">def </span><span class="s1">test_label_ranking_avg_precision_score_should_allow_csr_matrix_for_y_true_input():</span>
    <span class="s2"># Test that label_ranking_avg_precision_score accept sparse y_true.</span>
    <span class="s2"># Non-regression test for #22575</span>
    <span class="s1">y_true = csr_matrix([[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">y_score = np.array([[</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]])</span>
    <span class="s1">result = label_ranking_average_precision_score(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s0">assert </span><span class="s1">result == pytest.approx(</span><span class="s4">2 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;metric&quot;</span><span class="s0">, </span><span class="s1">[average_precision_score</span><span class="s0">, </span><span class="s1">det_curve</span><span class="s0">, </span><span class="s1">precision_recall_curve</span><span class="s0">, </span><span class="s1">roc_curve]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s5">&quot;classes&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">False, True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">&quot;zero&quot;</span><span class="s0">, </span><span class="s5">&quot;one&quot;</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_ranking_metric_pos_label_types(metric</span><span class="s0">, </span><span class="s1">classes):</span>
    <span class="s3">&quot;&quot;&quot;Check that the metric works with different types of `pos_label`. 
 
    We can expect `pos_label` to be a bool, an integer, a float, a string. 
    No error should be raised for those types. 
    &quot;&quot;&quot;</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s4">42</span><span class="s1">)</span>
    <span class="s1">n_samples</span><span class="s0">, </span><span class="s1">pos_label = </span><span class="s4">10</span><span class="s0">, </span><span class="s1">classes[-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">y_true = rng.choice(classes</span><span class="s0">, </span><span class="s1">size=n_samples</span><span class="s0">, </span><span class="s1">replace=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">y_proba = rng.rand(n_samples)</span>
    <span class="s1">result = metric(y_true</span><span class="s0">, </span><span class="s1">y_proba</span><span class="s0">, </span><span class="s1">pos_label=pos_label)</span>
    <span class="s0">if </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">float):</span>
        <span class="s0">assert not </span><span class="s1">np.isnan(result)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">metric_1</span><span class="s0">, </span><span class="s1">metric_2</span><span class="s0">, </span><span class="s1">thresholds = result</span>
        <span class="s0">assert not </span><span class="s1">np.isnan(metric_1).any()</span>
        <span class="s0">assert not </span><span class="s1">np.isnan(metric_2).any()</span>
        <span class="s0">assert not </span><span class="s1">np.isnan(thresholds).any()</span>


<span class="s0">def </span><span class="s1">test_roc_curve_with_probablity_estimates(global_random_seed):</span>
    <span class="s3">&quot;&quot;&quot;Check that thresholds do not exceed 1.0 when `y_score` is a probability 
    estimate. 
 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/issues/26193 
    &quot;&quot;&quot;</span>
    <span class="s1">rng = np.random.RandomState(global_random_seed)</span>
    <span class="s1">y_true = rng.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">y_score = rng.rand(</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">thresholds = roc_curve(y_true</span><span class="s0">, </span><span class="s1">y_score)</span>
    <span class="s0">assert </span><span class="s1">np.isinf(thresholds[</span><span class="s4">0</span><span class="s1">])</span>
</pre>
</body>
</html>