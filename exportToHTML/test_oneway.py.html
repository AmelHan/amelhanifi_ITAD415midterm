<html>
<head>
<title>test_oneway.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_oneway.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
Created on Wed Mar 18 17:45:51 2020 
 
Author: Josef Perktold 
License: BSD-3 
 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span>

<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">statsmodels.regression.linear_model </span><span class="s3">import </span><span class="s1">OLS</span>
<span class="s3">import </span><span class="s1">statsmodels.stats.power </span><span class="s3">as </span><span class="s1">smpwr</span>
<span class="s3">import </span><span class="s1">statsmodels.stats.oneway </span><span class="s3">as </span><span class="s1">smo  </span><span class="s0"># needed for function with `test`</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.oneway </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">confint_effectsize_oneway</span><span class="s3">, </span><span class="s1">confint_noncentrality</span><span class="s3">, </span><span class="s1">effectsize_oneway</span><span class="s3">,</span>
    <span class="s1">anova_oneway</span><span class="s3">,</span>
    <span class="s1">anova_generic</span><span class="s3">, </span><span class="s1">equivalence_oneway</span><span class="s3">, </span><span class="s1">equivalence_oneway_generic</span><span class="s3">,</span>
    <span class="s1">power_equivalence_oneway</span><span class="s3">, </span><span class="s1">_power_equivalence_oneway_emp</span><span class="s3">,</span>
    <span class="s1">f2_to_wellek</span><span class="s3">, </span><span class="s1">fstat_to_wellek</span><span class="s3">, </span><span class="s1">wellek_to_f2)</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.robust_compare </span><span class="s3">import </span><span class="s1">scale_transform</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.contrast </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">wald_test_noncent_generic</span><span class="s3">, </span><span class="s1">wald_test_noncent</span><span class="s3">, </span><span class="s1">_offset_constraint)</span>


<span class="s3">def </span><span class="s1">test_oneway_effectsize():</span>
    <span class="s0"># examole 3 in Steiger 2004 Beyond the F-test, p. 169</span>
    <span class="s1">F = </span><span class="s4">5</span>
    <span class="s1">df1 = </span><span class="s4">3</span>
    <span class="s1">df2 = </span><span class="s4">76</span>
    <span class="s1">nobs = </span><span class="s4">80</span>

    <span class="s1">ci = confint_noncentrality(F</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2)</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                               <span class="s1">alternative=</span><span class="s5">&quot;two-sided&quot;</span><span class="s1">)</span>

    <span class="s1">ci_es = confint_effectsize_oneway(F</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2)</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s1">)</span>
    <span class="s1">ci_steiger = ci_es.ci_f * np.sqrt(</span><span class="s4">4 </span><span class="s1">/ </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">res_ci_steiger = [</span><span class="s4">0.1764</span><span class="s3">, </span><span class="s4">0.7367</span><span class="s1">]</span>
    <span class="s1">res_ci_nc = np.asarray([</span><span class="s4">1.8666</span><span class="s3">, </span><span class="s4">32.563</span><span class="s1">])</span>

    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">res_ci_nc</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0001</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.ci_f_corrected</span><span class="s3">, </span><span class="s1">res_ci_steiger</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.00006</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_steiger</span><span class="s3">, </span><span class="s1">res_ci_steiger</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.00006</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.ci_f**</span><span class="s4">2</span><span class="s3">, </span><span class="s1">res_ci_nc / nobs</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.00006</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.ci_nc</span><span class="s3">, </span><span class="s1">res_ci_nc</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0001</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_effectsize_power():</span>
    <span class="s0"># example and results from PASS documentation</span>
    <span class="s1">n_groups = </span><span class="s4">3</span>
    <span class="s1">means = [</span><span class="s4">527.86</span><span class="s3">, </span><span class="s4">660.43</span><span class="s3">, </span><span class="s4">649.14</span><span class="s1">]</span>
    <span class="s1">vars_ = </span><span class="s4">107.4304</span><span class="s1">**</span><span class="s4">2</span>
    <span class="s1">nobs = </span><span class="s4">12</span>
    <span class="s1">es = effectsize_oneway(means</span><span class="s3">, </span><span class="s1">vars_</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s3">, </span><span class="s1">ddof_between=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">es = np.sqrt(es)</span>

    <span class="s1">alpha = </span><span class="s4">0.05</span>
    <span class="s1">power = </span><span class="s4">0.8</span>
    <span class="s1">nobs_t = nobs * n_groups</span>
    <span class="s1">kwds = {</span><span class="s5">'effect_size'</span><span class="s1">: es</span><span class="s3">, </span><span class="s5">'nobs'</span><span class="s1">: nobs_t</span><span class="s3">, </span><span class="s5">'alpha'</span><span class="s1">: alpha</span><span class="s3">, </span><span class="s5">'power'</span><span class="s1">: power</span><span class="s3">,</span>
            <span class="s5">'k_groups'</span><span class="s1">: n_groups}</span>

    <span class="s3">from </span><span class="s1">statsmodels.stats.power </span><span class="s3">import </span><span class="s1">FTestAnovaPower</span>

    <span class="s1">res_pow = </span><span class="s4">0.8251</span>
    <span class="s1">res_es = </span><span class="s4">0.559</span>
    <span class="s1">kwds_ = kwds.copy()</span>
    <span class="s3">del </span><span class="s1">kwds_[</span><span class="s5">'power'</span><span class="s1">]</span>
    <span class="s1">p = FTestAnovaPower().power(**kwds_)</span>
    <span class="s1">assert_allclose(p</span><span class="s3">, </span><span class="s1">res_pow</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0001</span><span class="s1">)</span>
    <span class="s1">assert_allclose(es</span><span class="s3">, </span><span class="s1">res_es</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0006</span><span class="s1">)</span>

    <span class="s0"># example unequal sample sizes</span>
    <span class="s1">nobs = np.array([</span><span class="s4">15</span><span class="s3">, </span><span class="s4">9</span><span class="s3">, </span><span class="s4">9</span><span class="s1">])</span>
    <span class="s1">kwds[</span><span class="s5">'nobs'</span><span class="s1">] = nobs</span>
    <span class="s1">es = effectsize_oneway(means</span><span class="s3">, </span><span class="s1">vars_</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s3">, </span><span class="s1">ddof_between=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">es = np.sqrt(es)</span>
    <span class="s1">kwds[</span><span class="s5">'effect_size'</span><span class="s1">] = es</span>
    <span class="s1">p = FTestAnovaPower().power(**kwds_)</span>

    <span class="s1">res_pow = </span><span class="s4">0.8297</span>
    <span class="s1">res_es = </span><span class="s4">0.590</span>
    <span class="s1">assert_allclose(p</span><span class="s3">, </span><span class="s1">res_pow</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.005</span><span class="s1">)  </span><span class="s0"># lower than print precision</span>
    <span class="s1">assert_allclose(es</span><span class="s3">, </span><span class="s1">res_es</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0006</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_effectsize_fstat():</span>
    <span class="s0"># results from R package `effectsize`, confint is 0.9 confidence</span>
    <span class="s0"># &gt; es = F_to_eta2(45.8, 3, 35)</span>
    <span class="s1">Eta_Sq_partial = </span><span class="s4">0.796983758700696</span>
    <span class="s1">CI_eta2 = </span><span class="s4">0.685670133284926</span><span class="s3">, </span><span class="s4">0.855981325777856  </span><span class="s0"># reformated from output</span>
    <span class="s0"># &gt; es = F_to_epsilon2(45.8, 3, 35)</span>
    <span class="s1">Epsilon_Sq_partial = </span><span class="s4">0.779582366589327</span>
    <span class="s1">CI_eps2 = </span><span class="s4">0.658727573280777</span><span class="s3">, </span><span class="s4">0.843636867987386</span>
    <span class="s0"># &gt; es = F_to_omega2(45.8, 3, 35)</span>
    <span class="s1">Omega_Sq_partial = </span><span class="s4">0.775086505190311</span>
    <span class="s1">CI_omega2 = </span><span class="s4">0.65286429480169</span><span class="s3">, </span><span class="s4">0.840179680453464</span>
    <span class="s0"># &gt; es = F_to_f(45.8, 3, 35)</span>
    <span class="s1">Cohens_f_partial = </span><span class="s4">1.98134153686695</span>
    <span class="s1">CI_f = </span><span class="s4">1.47694659580859</span><span class="s3">, </span><span class="s4">2.43793847155554</span>

    <span class="s1">f_stat</span><span class="s3">, </span><span class="s1">df1</span><span class="s3">, </span><span class="s1">df2 = </span><span class="s4">45.8</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">35</span>
    <span class="s0"># nobs = df1 + df2 + 1  # not directly used in the following, only df</span>
    <span class="s1">fes = smo._fstat2effectsize(f_stat</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2))</span>
    <span class="s1">assert_allclose(np.sqrt(fes.f2)</span><span class="s3">, </span><span class="s1">Cohens_f_partial</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(fes.eta2</span><span class="s3">, </span><span class="s1">Eta_Sq_partial</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(fes.eps2</span><span class="s3">, </span><span class="s1">Epsilon_Sq_partial</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(fes.omega2</span><span class="s3">, </span><span class="s1">Omega_Sq_partial</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s1">ci_nc = confint_noncentrality(f_stat</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2)</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.1</span><span class="s1">)</span>
    <span class="s0"># the following replicates R package effectsize</span>
    <span class="s1">ci_es = smo._fstat2effectsize(ci_nc / df1</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2))</span>
    <span class="s1">assert_allclose(ci_es.eta2</span><span class="s3">, </span><span class="s1">CI_eta2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">2e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.eps2</span><span class="s3">, </span><span class="s1">CI_eps2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">2e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.omega2</span><span class="s3">, </span><span class="s1">CI_omega2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">2e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(np.sqrt(ci_es.f2)</span><span class="s3">, </span><span class="s1">CI_f</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">2e-4</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_effectsize_fstat_stata():</span>
    <span class="s0"># reference numbers computed with Stata 14</span>
    <span class="s0"># Stata 16 does not seem to have confint for omega2</span>

    <span class="s0"># esizei 2 40 7.47403193349075, level(90)</span>
    <span class="s1">eta2 = </span><span class="s4">0.2720398648288652</span>
    <span class="s1">lb_eta2 = </span><span class="s4">0.0742092468714613</span>
    <span class="s1">ub_eta2 = </span><span class="s4">0.4156116886974804</span>
    <span class="s1">omega2 = </span><span class="s4">0.2356418580703085</span>
    <span class="s1">lb_omega2 = </span><span class="s4">0.0279197092150344</span>
    <span class="s1">ub_omega2 = </span><span class="s4">0.3863922731323545</span>
    <span class="s0"># level = 90</span>

    <span class="s1">f_stat</span><span class="s3">, </span><span class="s1">df1</span><span class="s3">, </span><span class="s1">df2 = </span><span class="s4">7.47403193349075</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">40</span>
    <span class="s1">fes = smo._fstat2effectsize(f_stat</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2))</span>
    <span class="s1">assert_allclose(fes.eta2</span><span class="s3">, </span><span class="s1">eta2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(fes.omega2</span><span class="s3">, </span><span class="s1">omega2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.02</span><span class="s1">)  </span><span class="s0"># low agreement</span>
    <span class="s1">ci_es = smo.confint_effectsize_oneway(f_stat</span><span class="s3">, </span><span class="s1">(df1</span><span class="s3">, </span><span class="s1">df2)</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.eta2</span><span class="s3">, </span><span class="s1">(lb_eta2</span><span class="s3">, </span><span class="s1">ub_eta2)</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_es.ci_omega2</span><span class="s3">, </span><span class="s1">(lb_omega2</span><span class="s3">, </span><span class="s1">ub_omega2)</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.025</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;center&quot;</span><span class="s3">, </span><span class="s1">[</span><span class="s5">'median'</span><span class="s3">, </span><span class="s5">'mean'</span><span class="s3">, </span><span class="s5">'trimmed'</span><span class="s1">])</span>
<span class="s3">def </span><span class="s1">test_scale_transform(center):</span>
    <span class="s1">x = np.random.randn(</span><span class="s4">5</span><span class="s3">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">xt = scale_transform(x</span><span class="s3">, </span><span class="s1">center=center</span><span class="s3">, </span><span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac=</span><span class="s4">0.2</span><span class="s3">,</span>
                         <span class="s1">axis=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">xtt = scale_transform(x.T</span><span class="s3">, </span><span class="s1">center=center</span><span class="s3">, </span><span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac=</span><span class="s4">0.2</span><span class="s3">,</span>
                          <span class="s1">axis=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(xt.T</span><span class="s3">, </span><span class="s1">xtt</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">xt0 = scale_transform(x[:</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">center=center</span><span class="s3">, </span><span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">,</span>
                          <span class="s1">trim_frac=</span><span class="s4">0.2</span><span class="s1">)</span>
    <span class="s1">assert_allclose(xt0</span><span class="s3">, </span><span class="s1">xt[:</span><span class="s3">, </span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose(xt0</span><span class="s3">, </span><span class="s1">xtt[</span><span class="s4">0</span><span class="s3">, </span><span class="s1">:]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestOnewayEquivalenc:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">y0 = [</span><span class="s4">112.488</span><span class="s3">, </span><span class="s4">103.738</span><span class="s3">, </span><span class="s4">86.344</span><span class="s3">, </span><span class="s4">101.708</span><span class="s3">, </span><span class="s4">95.108</span><span class="s3">, </span><span class="s4">105.931</span><span class="s3">,</span>
              <span class="s4">95.815</span><span class="s3">, </span><span class="s4">91.864</span><span class="s3">, </span><span class="s4">102.479</span><span class="s3">, </span><span class="s4">102.644</span><span class="s1">]</span>
        <span class="s1">y1 = [</span><span class="s4">100.421</span><span class="s3">, </span><span class="s4">101.966</span><span class="s3">, </span><span class="s4">99.636</span><span class="s3">, </span><span class="s4">105.983</span><span class="s3">, </span><span class="s4">88.377</span><span class="s3">, </span><span class="s4">102.618</span><span class="s3">,</span>
              <span class="s4">105.486</span><span class="s3">, </span><span class="s4">98.662</span><span class="s3">, </span><span class="s4">94.137</span><span class="s3">, </span><span class="s4">98.626</span><span class="s3">, </span><span class="s4">89.367</span><span class="s3">, </span><span class="s4">106.204</span><span class="s1">]</span>
        <span class="s1">y2 = [</span><span class="s4">84.846</span><span class="s3">, </span><span class="s4">100.488</span><span class="s3">, </span><span class="s4">119.763</span><span class="s3">, </span><span class="s4">103.736</span><span class="s3">, </span><span class="s4">93.141</span><span class="s3">, </span><span class="s4">108.254</span><span class="s3">,</span>
              <span class="s4">99.510</span><span class="s3">, </span><span class="s4">89.005</span><span class="s3">, </span><span class="s4">108.200</span><span class="s3">, </span><span class="s4">82.209</span><span class="s3">, </span><span class="s4">100.104</span><span class="s3">, </span><span class="s4">103.706</span><span class="s3">,</span>
              <span class="s4">107.067</span><span class="s1">]</span>
        <span class="s1">y3 = [</span><span class="s4">100.825</span><span class="s3">, </span><span class="s4">100.255</span><span class="s3">, </span><span class="s4">103.363</span><span class="s3">, </span><span class="s4">93.230</span><span class="s3">, </span><span class="s4">95.325</span><span class="s3">, </span><span class="s4">100.288</span><span class="s3">,</span>
              <span class="s4">94.750</span><span class="s3">, </span><span class="s4">107.129</span><span class="s3">, </span><span class="s4">98.246</span><span class="s3">, </span><span class="s4">96.365</span><span class="s3">, </span><span class="s4">99.740</span><span class="s3">, </span><span class="s4">106.049</span><span class="s3">,</span>
              <span class="s4">92.691</span><span class="s3">, </span><span class="s4">93.111</span><span class="s3">, </span><span class="s4">98.243</span><span class="s1">]</span>

        <span class="s1">n_groups = </span><span class="s4">4</span>
        <span class="s1">arrs_w = [np.asarray(yi) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">[y0</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">y3]]</span>
        <span class="s1">nobs = np.asarray([len(yi) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">arrs_w])</span>
        <span class="s1">nobs_mean = np.mean(nobs)</span>
        <span class="s1">means = np.asarray([yi.mean() </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">arrs_w])</span>
        <span class="s1">stds = np.asarray([yi.std(ddof=</span><span class="s4">1</span><span class="s1">) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">arrs_w])</span>
        <span class="s1">cls.data = arrs_w  </span><span class="s0"># TODO use `data`</span>
        <span class="s1">cls.means = means</span>
        <span class="s1">cls.nobs = nobs</span>
        <span class="s1">cls.stds = stds</span>
        <span class="s1">cls.n_groups = n_groups</span>
        <span class="s1">cls.nobs_mean = nobs_mean</span>

    <span class="s3">def </span><span class="s1">test_equivalence_equal(self):</span>
        <span class="s0"># reference numbers from Jan and Shieh 2019, p. 5</span>
        <span class="s1">means = self.means</span>
        <span class="s1">nobs = self.nobs</span>
        <span class="s1">stds = self.stds</span>
        <span class="s1">n_groups = self.n_groups</span>

        <span class="s1">eps = </span><span class="s4">0.5</span>
        <span class="s1">res0 = anova_generic(means</span><span class="s3">, </span><span class="s1">stds**</span><span class="s4">2</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s1">)</span>
        <span class="s1">f = res0.statistic</span>
        <span class="s1">res = equivalence_oneway_generic(f</span><span class="s3">, </span><span class="s1">n_groups</span><span class="s3">, </span><span class="s1">nobs.sum()</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">,</span>
                                         <span class="s1">res0.df</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                                         <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s4">0.0083</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.001</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.df</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">46</span><span class="s1">])</span>

        <span class="s0"># the agreement for f-stat looks too low</span>
        <span class="s1">assert_allclose(f</span><span class="s3">, </span><span class="s4">0.0926</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0006</span><span class="s1">)</span>

        <span class="s1">res = equivalence_oneway(self.data</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s3">,</span>
                                 <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s4">0.0083</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.001</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.df</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3</span><span class="s3">, </span><span class="s4">46</span><span class="s1">])</span>

    <span class="s3">def </span><span class="s1">test_equivalence_welch(self):</span>
        <span class="s0"># reference numbers from Jan and Shieh 2019, p. 6</span>
        <span class="s1">means = self.means</span>
        <span class="s1">nobs = self.nobs</span>
        <span class="s1">stds = self.stds</span>
        <span class="s1">n_groups = self.n_groups</span>
        <span class="s1">vars_ = stds**</span><span class="s4">2</span>

        <span class="s1">eps = </span><span class="s4">0.5</span>
        <span class="s1">res0 = anova_generic(means</span><span class="s3">, </span><span class="s1">vars_</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s3">,</span>
                             <span class="s1">welch_correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">f_stat = res0.statistic</span>
        <span class="s1">res = equivalence_oneway_generic(f_stat</span><span class="s3">, </span><span class="s1">n_groups</span><span class="s3">, </span><span class="s1">nobs.sum()</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">,</span>
                                         <span class="s1">res0.df</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                                         <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s4">0.0110</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.001</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">22.6536</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0006</span><span class="s1">)</span>

        <span class="s0"># agreement for Welch f-stat looks too low b/c welch_correction=False</span>
        <span class="s1">assert_allclose(f_stat</span><span class="s3">, </span><span class="s4">0.1102</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>

        <span class="s1">res = equivalence_oneway(self.data</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s3">,</span>
                                 <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s4">0.0110</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">[</span><span class="s4">3.0</span><span class="s3">, </span><span class="s4">22.6536</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.0006</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.f_stat</span><span class="s3">, </span><span class="s4">0.1102</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s1">)  </span><span class="s0"># 0.007)</span>

        <span class="s0"># check post-hoc power, JS p. 6</span>
        <span class="s1">pow_ = _power_equivalence_oneway_emp(f_stat</span><span class="s3">, </span><span class="s1">n_groups</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">,</span>
                                             <span class="s1">res0.df)</span>
        <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s4">0.1552</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>

        <span class="s1">pow_ = power_equivalence_oneway(eps</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">nobs.sum()</span><span class="s3">,</span>
                                        <span class="s1">n_groups=n_groups</span><span class="s3">, </span><span class="s1">df=</span><span class="s3">None, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                                        <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s4">0.05</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">nobs_t = nobs.sum()</span>
        <span class="s1">es = effectsize_oneway(means</span><span class="s3">, </span><span class="s1">vars_</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s1">)</span>
        <span class="s1">es = np.sqrt(es)</span>
        <span class="s1">es_w0 = f2_to_wellek(es**</span><span class="s4">2</span><span class="s3">, </span><span class="s1">n_groups)</span>
        <span class="s1">es_w = np.sqrt(fstat_to_wellek(f_stat</span><span class="s3">, </span><span class="s1">n_groups</span><span class="s3">, </span><span class="s1">nobs_t / n_groups))</span>

        <span class="s1">pow_ = power_equivalence_oneway(es_w</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">nobs_t</span><span class="s3">,</span>
                                        <span class="s1">n_groups=n_groups</span><span class="s3">, </span><span class="s1">df=</span><span class="s3">None, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                                        <span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s4">0.1552</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>
        <span class="s1">assert_allclose(es_w0</span><span class="s3">, </span><span class="s1">es_w</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>

        <span class="s1">margin = wellek_to_f2(eps</span><span class="s3">, </span><span class="s1">n_groups)</span>
        <span class="s1">pow_ = power_equivalence_oneway(es**</span><span class="s4">2</span><span class="s3">, </span><span class="s1">margin</span><span class="s3">, </span><span class="s1">nobs_t</span><span class="s3">,</span>
                                        <span class="s1">n_groups=n_groups</span><span class="s3">, </span><span class="s1">df=</span><span class="s3">None, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
                                        <span class="s1">margin_type=</span><span class="s5">&quot;f2&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s4">0.1552</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestOnewayScale:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">yt0 = np.array([</span><span class="s4">102.</span><span class="s3">, </span><span class="s4">320.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">107.</span><span class="s3">, </span><span class="s4">198.</span><span class="s3">, </span><span class="s4">200.</span><span class="s3">, </span><span class="s4">4.</span><span class="s3">, </span><span class="s4">20.</span><span class="s3">, </span><span class="s4">110.</span><span class="s3">, </span><span class="s4">128.</span><span class="s3">,</span>
                       <span class="s4">7.</span><span class="s3">, </span><span class="s4">119.</span><span class="s3">, </span><span class="s4">309.</span><span class="s1">])</span>

        <span class="s1">yt1 = np.array([</span><span class="s4">0.</span><span class="s3">, </span><span class="s4">1.</span><span class="s3">, </span><span class="s4">228.</span><span class="s3">, </span><span class="s4">81.</span><span class="s3">, </span><span class="s4">87.</span><span class="s3">, </span><span class="s4">119.</span><span class="s3">, </span><span class="s4">79.</span><span class="s3">, </span><span class="s4">181.</span><span class="s3">, </span><span class="s4">43.</span><span class="s3">, </span><span class="s4">12.</span><span class="s3">, </span><span class="s4">90.</span><span class="s3">,</span>
                       <span class="s4">105.</span><span class="s3">, </span><span class="s4">108.</span><span class="s3">, </span><span class="s4">119.</span><span class="s3">, </span><span class="s4">0.</span><span class="s3">, </span><span class="s4">9.</span><span class="s1">])</span>
        <span class="s1">yt2 = np.array([</span><span class="s4">33.</span><span class="s3">, </span><span class="s4">294.</span><span class="s3">, </span><span class="s4">134.</span><span class="s3">, </span><span class="s4">216.</span><span class="s3">, </span><span class="s4">83.</span><span class="s3">, </span><span class="s4">105.</span><span class="s3">, </span><span class="s4">69.</span><span class="s3">, </span><span class="s4">20.</span><span class="s3">, </span><span class="s4">20.</span><span class="s3">, </span><span class="s4">63.</span><span class="s3">,</span>
                       <span class="s4">98.</span><span class="s3">, </span><span class="s4">155.</span><span class="s3">, </span><span class="s4">78.</span><span class="s3">, </span><span class="s4">75.</span><span class="s1">])</span>

        <span class="s1">y0 = np.array([</span><span class="s4">452.</span><span class="s3">, </span><span class="s4">874.</span><span class="s3">, </span><span class="s4">554.</span><span class="s3">, </span><span class="s4">447.</span><span class="s3">, </span><span class="s4">356.</span><span class="s3">, </span><span class="s4">754.</span><span class="s3">, </span><span class="s4">558.</span><span class="s3">, </span><span class="s4">574.</span><span class="s3">, </span><span class="s4">664.</span><span class="s3">,</span>
                       <span class="s4">682.</span><span class="s3">, </span><span class="s4">547.</span><span class="s3">, </span><span class="s4">435.</span><span class="s3">, </span><span class="s4">245.</span><span class="s1">])</span>
        <span class="s1">y1 = np.array([</span><span class="s4">546.</span><span class="s3">, </span><span class="s4">547.</span><span class="s3">, </span><span class="s4">774.</span><span class="s3">, </span><span class="s4">465.</span><span class="s3">, </span><span class="s4">459.</span><span class="s3">, </span><span class="s4">665.</span><span class="s3">, </span><span class="s4">467.</span><span class="s3">, </span><span class="s4">365.</span><span class="s3">, </span><span class="s4">589.</span><span class="s3">,</span>
                       <span class="s4">534.</span><span class="s3">, </span><span class="s4">456.</span><span class="s3">, </span><span class="s4">651.</span><span class="s3">, </span><span class="s4">654.</span><span class="s3">, </span><span class="s4">665.</span><span class="s3">, </span><span class="s4">546.</span><span class="s3">, </span><span class="s4">537.</span><span class="s1">])</span>
        <span class="s1">y2 = np.array([</span><span class="s4">785.</span><span class="s3">, </span><span class="s4">458.</span><span class="s3">, </span><span class="s4">886.</span><span class="s3">, </span><span class="s4">536.</span><span class="s3">, </span><span class="s4">669.</span><span class="s3">, </span><span class="s4">857.</span><span class="s3">, </span><span class="s4">821.</span><span class="s3">, </span><span class="s4">772.</span><span class="s3">, </span><span class="s4">732.</span><span class="s3">,</span>
                       <span class="s4">689.</span><span class="s3">, </span><span class="s4">654.</span><span class="s3">, </span><span class="s4">597.</span><span class="s3">, </span><span class="s4">830.</span><span class="s3">, </span><span class="s4">827.</span><span class="s1">])</span>

        <span class="s1">n_groups = </span><span class="s4">3</span>
        <span class="s1">data = [y0</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2]</span>
        <span class="s1">nobs = np.asarray([len(yi) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">data])</span>
        <span class="s1">nobs_mean = np.mean(nobs)</span>
        <span class="s1">means = np.asarray([yi.mean() </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">data])</span>
        <span class="s1">stds = np.asarray([yi.std(ddof=</span><span class="s4">1</span><span class="s1">) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">data])</span>
        <span class="s1">cls.data = data</span>
        <span class="s1">cls.data_transformed = [yt0</span><span class="s3">, </span><span class="s1">yt1</span><span class="s3">, </span><span class="s1">yt2]</span>
        <span class="s1">cls.means = means</span>
        <span class="s1">cls.nobs = nobs</span>
        <span class="s1">cls.stds = stds</span>
        <span class="s1">cls.n_groups = n_groups</span>
        <span class="s1">cls.nobs_mean = nobs_mean</span>

    <span class="s3">def </span><span class="s1">test_means(self):</span>

        <span class="s0"># library onewaystats, BF test for equality of means</span>
        <span class="s0"># st = bf.test(y ~ g, df3)</span>
        <span class="s1">statistic = </span><span class="s4">7.10900606421182</span>
        <span class="s1">parameter = [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">31.4207256105052</span><span class="s1">]</span>
        <span class="s1">p_value = </span><span class="s4">0.00283841965791224</span>
        <span class="s0"># method = 'Brown-Forsythe Test'</span>
        <span class="s1">res = anova_oneway(self.data</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;bf&quot;</span><span class="s1">)</span>

        <span class="s0"># R bf.test uses original BF df_num</span>
        <span class="s1">assert_allclose(res.pvalue2</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose([res.df_num2</span><span class="s3">, </span><span class="s1">res.df_denom]</span><span class="s3">, </span><span class="s1">parameter)</span>

    <span class="s3">def </span><span class="s1">test_levene(self):</span>
        <span class="s1">data = self.data</span>

        <span class="s0"># lawstat: Test Statistic = 1.0866123063642, p-value = 0.3471072204516</span>
        <span class="s1">statistic = </span><span class="s4">1.0866123063642</span>
        <span class="s1">p_value = </span><span class="s4">0.3471072204516</span>
        <span class="s1">res0 = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'equal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'median'</span><span class="s3">,</span>
                                     <span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s0"># library car</span>
        <span class="s0"># &gt; lt = leveneTest(y ~ g, df3, center=mean, trim=0.2)</span>
        <span class="s1">statistic = </span><span class="s4">1.10732113109744</span>
        <span class="s1">p_value = </span><span class="s4">0.340359251994645</span>
        <span class="s1">df = [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">40</span><span class="s1">]</span>
        <span class="s1">res0 = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'equal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'trimmed'</span><span class="s3">,</span>
                                     <span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.df</span><span class="s3">, </span><span class="s1">df)</span>

        <span class="s0"># library(onewaytests)</span>
        <span class="s0"># test uses mean as center</span>
        <span class="s0"># &gt; st = homog.test(y ~ g, df3)</span>
        <span class="s1">statistic = </span><span class="s4">1.07894485177512</span>
        <span class="s1">parameter = [</span><span class="s4">2</span><span class="s3">, </span><span class="s4">40</span><span class="s1">]  </span><span class="s0"># df</span>
        <span class="s1">p_value = </span><span class="s4">0.349641166869223</span>
        <span class="s0"># method = &quot;Levene's Homogeneity Test&quot;</span>
        <span class="s1">res0 = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'equal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'mean'</span><span class="s3">,</span>
                                     <span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res0.df</span><span class="s3">, </span><span class="s1">parameter)</span>

        <span class="s0"># &gt; st = homog.test(y ~ g, df3, method = &quot;Bartlett&quot;)</span>
        <span class="s1">statistic = </span><span class="s4">3.01982414477323</span>
        <span class="s0"># parameter = 2  # scipy bartlett does not return df</span>
        <span class="s1">p_value = </span><span class="s4">0.220929402900495</span>
        <span class="s0"># method = &quot;Bartlett's Homogeneity Test&quot;</span>
        <span class="s0"># Bartlett is in scipy.stats</span>
        <span class="s3">from </span><span class="s1">scipy </span><span class="s3">import </span><span class="s1">stats</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">pv = stats.bartlett(*data)</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(stat</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_options(self):</span>
        <span class="s0"># regression tests for options,</span>
        <span class="s0"># many might not be implemented in other packages</span>
        <span class="s1">data = self.data</span>

        <span class="s0"># regression numbers from initial run</span>
        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">p_value = </span><span class="s4">1.0173464626246675</span><span class="s3">, </span><span class="s4">0.3763806150460239</span>
        <span class="s1">df = (</span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">24.40374758005409</span><span class="s1">)</span>
        <span class="s1">res = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'unequal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'median'</span><span class="s3">,</span>
                                    <span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">df)</span>

        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">p_value = </span><span class="s4">1.0329722145270606</span><span class="s3">, </span><span class="s4">0.3622778213868562</span>
        <span class="s1">df = (</span><span class="s4">1.83153791573948</span><span class="s3">, </span><span class="s4">30.6733640949525</span><span class="s1">)</span>
        <span class="s1">p_value2 = </span><span class="s4">0.3679999679787619</span>
        <span class="s1">df2 = (</span><span class="s4">2</span><span class="s3">, </span><span class="s4">30.6733640949525</span><span class="s1">)</span>
        <span class="s1">res = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'bf'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'median'</span><span class="s3">,</span>
                                    <span class="s1">transform=</span><span class="s5">'abs'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">df)</span>
        <span class="s1">assert_allclose(res.pvalue2</span><span class="s3">, </span><span class="s1">p_value2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df2</span><span class="s3">, </span><span class="s1">df2)</span>

        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">p_value = </span><span class="s4">1.7252431333701745</span><span class="s3">, </span><span class="s4">0.19112038168209514</span>
        <span class="s1">df = (</span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">40.0</span><span class="s1">)</span>
        <span class="s1">res = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'equal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'mean'</span><span class="s3">,</span>
                                    <span class="s1">transform=</span><span class="s5">'square'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.df</span><span class="s3">, </span><span class="s1">df)</span>

        <span class="s1">statistic</span><span class="s3">, </span><span class="s1">p_value = </span><span class="s4">0.4129696057329463</span><span class="s3">, </span><span class="s4">0.6644711582864451</span>
        <span class="s1">df = (</span><span class="s4">2.0</span><span class="s3">, </span><span class="s4">40.0</span><span class="s1">)</span>
        <span class="s1">res = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'equal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s5">'mean'</span><span class="s3">,</span>
                                    <span class="s1">transform=</span><span class="s3">lambda </span><span class="s1">x: np.log(x * x)</span><span class="s3">,  </span><span class="s0"># noqa</span>
                                    <span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">p_value</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">df)</span>

        <span class="s0"># compare no transform with standard anova</span>
        <span class="s1">res = smo.test_scale_oneway(data</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'unequal'</span><span class="s3">, </span><span class="s1">center=</span><span class="s4">0</span><span class="s3">,</span>
                                    <span class="s1">transform=</span><span class="s5">'identity'</span><span class="s3">, </span><span class="s1">trim_frac_mean=</span><span class="s4">0.2</span><span class="s1">)</span>
        <span class="s1">res2 = anova_oneway(self.data</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res2.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res2.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res2.df)</span>

    <span class="s3">def </span><span class="s1">test_equivalence(self):</span>
        <span class="s1">data = self.data</span>

        <span class="s0"># compare no transform with standard anova</span>
        <span class="s1">res = smo.equivalence_scale_oneway(data</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'unequal'</span><span class="s3">,</span>
                                           <span class="s1">center=</span><span class="s4">0</span><span class="s3">,</span>
                                           <span class="s1">transform=</span><span class="s5">'identity'</span><span class="s1">)</span>
        <span class="s1">res2 = equivalence_oneway(self.data</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;unequal&quot;</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res2.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res2.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res2.df)</span>

        <span class="s1">res = smo.equivalence_scale_oneway(data</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'bf'</span><span class="s3">,</span>
                                           <span class="s1">center=</span><span class="s4">0</span><span class="s3">,</span>
                                           <span class="s1">transform=</span><span class="s5">'identity'</span><span class="s1">)</span>
        <span class="s1">res2 = equivalence_oneway(self.data</span><span class="s3">, </span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;bf&quot;</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">res2.pvalue</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.statistic</span><span class="s3">, </span><span class="s1">res2.statistic</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.df</span><span class="s3">, </span><span class="s1">res2.df)</span>


<span class="s3">class </span><span class="s1">TestOnewayOLS:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">y0 = [</span><span class="s4">112.488</span><span class="s3">, </span><span class="s4">103.738</span><span class="s3">, </span><span class="s4">86.344</span><span class="s3">, </span><span class="s4">101.708</span><span class="s3">, </span><span class="s4">95.108</span><span class="s3">, </span><span class="s4">105.931</span><span class="s3">,</span>
              <span class="s4">95.815</span><span class="s3">, </span><span class="s4">91.864</span><span class="s3">, </span><span class="s4">102.479</span><span class="s3">, </span><span class="s4">102.644</span><span class="s1">]</span>
        <span class="s1">y1 = [</span><span class="s4">100.421</span><span class="s3">, </span><span class="s4">101.966</span><span class="s3">, </span><span class="s4">99.636</span><span class="s3">, </span><span class="s4">105.983</span><span class="s3">, </span><span class="s4">88.377</span><span class="s3">, </span><span class="s4">102.618</span><span class="s3">,</span>
              <span class="s4">105.486</span><span class="s3">, </span><span class="s4">98.662</span><span class="s3">, </span><span class="s4">94.137</span><span class="s3">, </span><span class="s4">98.626</span><span class="s3">, </span><span class="s4">89.367</span><span class="s3">, </span><span class="s4">106.204</span><span class="s1">]</span>
        <span class="s1">y2 = [</span><span class="s4">84.846</span><span class="s3">, </span><span class="s4">100.488</span><span class="s3">, </span><span class="s4">119.763</span><span class="s3">, </span><span class="s4">103.736</span><span class="s3">, </span><span class="s4">93.141</span><span class="s3">, </span><span class="s4">108.254</span><span class="s3">,</span>
              <span class="s4">99.510</span><span class="s3">, </span><span class="s4">89.005</span><span class="s3">, </span><span class="s4">108.200</span><span class="s3">, </span><span class="s4">82.209</span><span class="s3">, </span><span class="s4">100.104</span><span class="s3">, </span><span class="s4">103.706</span><span class="s3">,</span>
              <span class="s4">107.067</span><span class="s1">]</span>
        <span class="s1">y3 = [</span><span class="s4">100.825</span><span class="s3">, </span><span class="s4">100.255</span><span class="s3">, </span><span class="s4">103.363</span><span class="s3">, </span><span class="s4">93.230</span><span class="s3">, </span><span class="s4">95.325</span><span class="s3">, </span><span class="s4">100.288</span><span class="s3">,</span>
              <span class="s4">94.750</span><span class="s3">, </span><span class="s4">107.129</span><span class="s3">, </span><span class="s4">98.246</span><span class="s3">, </span><span class="s4">96.365</span><span class="s3">, </span><span class="s4">99.740</span><span class="s3">, </span><span class="s4">106.049</span><span class="s3">,</span>
              <span class="s4">92.691</span><span class="s3">, </span><span class="s4">93.111</span><span class="s3">, </span><span class="s4">98.243</span><span class="s1">]</span>

        <span class="s1">cls.k_groups = k = </span><span class="s4">4</span>
        <span class="s1">cls.data = data = [y0</span><span class="s3">, </span><span class="s1">y1</span><span class="s3">, </span><span class="s1">y2</span><span class="s3">, </span><span class="s1">y3]</span>
        <span class="s1">cls.nobs = nobs = np.asarray([len(yi) </span><span class="s3">for </span><span class="s1">yi </span><span class="s3">in </span><span class="s1">data])</span>
        <span class="s1">groups = np.repeat(np.arange(k)</span><span class="s3">, </span><span class="s1">nobs)</span>
        <span class="s1">cls.ex = (groups[:</span><span class="s3">, None</span><span class="s1">] == np.arange(k)).astype(np.int64)</span>
        <span class="s1">cls.y = np.concatenate(data)</span>

    <span class="s3">def </span><span class="s1">test_ols_noncentrality(self):</span>
        <span class="s1">k = self.k_groups</span>

        <span class="s1">res_ols = OLS(self.y</span><span class="s3">, </span><span class="s1">self.ex).fit()</span>
        <span class="s1">nobs_t = res_ols.model.nobs</span>

        <span class="s0"># constraint</span>
        <span class="s1">c_equal = -np.eye(k)[</span><span class="s4">1</span><span class="s1">:]</span>
        <span class="s1">c_equal[:</span><span class="s3">, </span><span class="s4">0</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">v = np.zeros(c_equal.shape[</span><span class="s4">0</span><span class="s1">])</span>

        <span class="s0"># noncentrality at estimated parameters</span>
        <span class="s1">wt = res_ols.wald_test(c_equal</span><span class="s3">, </span><span class="s1">scalar=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">df_num</span><span class="s3">, </span><span class="s1">df_denom = wt.df_num</span><span class="s3">, </span><span class="s1">wt.df_denom</span>

        <span class="s1">cov_p = res_ols.cov_params()</span>

        <span class="s1">nc_wt = wald_test_noncent_generic(res_ols.params</span><span class="s3">, </span><span class="s1">c_equal</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">cov_p</span><span class="s3">,</span>
                                          <span class="s1">diff=</span><span class="s3">None, </span><span class="s1">joint=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(nc_wt</span><span class="s3">, </span><span class="s1">wt.statistic * wt.df_num</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">nc_wt2 = wald_test_noncent(res_ols.params</span><span class="s3">, </span><span class="s1">c_equal</span><span class="s3">, </span><span class="s1">v</span><span class="s3">, </span><span class="s1">res_ols</span><span class="s3">,</span>
                                   <span class="s1">diff=</span><span class="s3">None, </span><span class="s1">joint=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(nc_wt2</span><span class="s3">, </span><span class="s1">nc_wt</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">es_ols = nc_wt / nobs_t</span>
        <span class="s1">es_oneway = smo.effectsize_oneway(res_ols.params</span><span class="s3">, </span><span class="s1">res_ols.scale</span><span class="s3">,</span>
                                          <span class="s1">self.nobs</span><span class="s3">, </span><span class="s1">use_var=</span><span class="s5">&quot;equal&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(es_ols</span><span class="s3">, </span><span class="s1">es_oneway</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">alpha = </span><span class="s4">0.05</span>
        <span class="s1">pow_ols = smpwr.ftest_power(np.sqrt(es_ols)</span><span class="s3">, </span><span class="s1">df_denom</span><span class="s3">, </span><span class="s1">df_num</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">,</span>
                                    <span class="s1">ncc=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">pow_oneway = smpwr.ftest_anova_power(np.sqrt(es_oneway)</span><span class="s3">, </span><span class="s1">nobs_t</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">,</span>
                                             <span class="s1">k_groups=k</span><span class="s3">, </span><span class="s1">df=</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pow_ols</span><span class="s3">, </span><span class="s1">pow_oneway</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s0"># noncentrality at other params</span>
        <span class="s1">params_alt = res_ols.params * </span><span class="s4">0.75</span>
        <span class="s0"># compute constraint value so we can get noncentrality from wald_test</span>
        <span class="s1">v_off = _offset_constraint(c_equal</span><span class="s3">, </span><span class="s1">res_ols.params</span><span class="s3">, </span><span class="s1">params_alt)</span>
        <span class="s1">wt_off = res_ols.wald_test((c_equal</span><span class="s3">, </span><span class="s1">v + v_off)</span><span class="s3">, </span><span class="s1">scalar=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">nc_wt_off = wald_test_noncent_generic(params_alt</span><span class="s3">, </span><span class="s1">c_equal</span><span class="s3">, </span><span class="s1">v</span><span class="s3">,</span>
                                              <span class="s1">cov_p</span><span class="s3">, </span><span class="s1">diff=</span><span class="s3">None, </span><span class="s1">joint=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(nc_wt_off</span><span class="s3">, </span><span class="s1">wt_off.statistic * wt_off.df_num</span><span class="s3">,</span>
                        <span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s0"># check vectorized version, joint=False</span>
        <span class="s1">nc_wt_vec = wald_test_noncent_generic(params_alt</span><span class="s3">, </span><span class="s1">c_equal</span><span class="s3">, </span><span class="s1">v</span><span class="s3">,</span>
                                              <span class="s1">cov_p</span><span class="s3">, </span><span class="s1">diff=</span><span class="s3">None, </span><span class="s1">joint=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">i </span><span class="s3">in </span><span class="s1">range(c_equal.shape[</span><span class="s4">0</span><span class="s1">]):</span>
            <span class="s1">nc_wt_i = wald_test_noncent_generic(params_alt</span><span class="s3">, </span><span class="s1">c_equal[i : i + </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,  </span><span class="s0"># noqa</span>
                                                <span class="s1">v[i : i + </span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">cov_p</span><span class="s3">, </span><span class="s1">diff=</span><span class="s3">None,  </span><span class="s0"># noqa</span>
                                                <span class="s1">joint=</span><span class="s3">False</span><span class="s1">)</span>
            <span class="s1">assert_allclose(nc_wt_vec[i]</span><span class="s3">, </span><span class="s1">nc_wt_i</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_simulate_equivalence():</span>
    <span class="s0"># regression test, needs large k_mc to be reliable</span>

    <span class="s1">k_groups = </span><span class="s4">4</span>
    <span class="s1">k_repl = </span><span class="s4">10</span>
    <span class="s1">nobs = np.array([</span><span class="s4">10</span><span class="s3">, </span><span class="s4">12</span><span class="s3">, </span><span class="s4">13</span><span class="s3">, </span><span class="s4">15</span><span class="s1">]) * k_repl</span>
    <span class="s1">means = np.array([-</span><span class="s4">1</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]) * </span><span class="s4">0.12</span>
    <span class="s1">vars_ = np.array([</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s4">3</span><span class="s3">, </span><span class="s4">4</span><span class="s1">])</span>
    <span class="s1">nobs_t = nobs.sum()</span>

    <span class="s1">eps = </span><span class="s4">0.0191 </span><span class="s1">* </span><span class="s4">10</span>
    <span class="s1">opt_var = [</span><span class="s5">&quot;unequal&quot;</span><span class="s3">, </span><span class="s5">&quot;equal&quot;</span><span class="s3">, </span><span class="s5">&quot;bf&quot;</span><span class="s1">]</span>
    <span class="s1">k_mc = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">987126</span><span class="s1">)</span>
    <span class="s1">res_mc = smo.simulate_power_equivalence_oneway(</span>
        <span class="s1">means</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">eps</span><span class="s3">, </span><span class="s1">vars_=vars_</span><span class="s3">, </span><span class="s1">k_mc=k_mc</span><span class="s3">, </span><span class="s1">trim_frac=</span><span class="s4">0.1</span><span class="s3">,</span>
        <span class="s1">options_var=opt_var</span><span class="s3">, </span><span class="s1">margin_type=</span><span class="s5">&quot;wellek&quot;</span><span class="s1">)</span>

    <span class="s1">frac_reject = (res_mc.pvalue &lt;= </span><span class="s4">0.05</span><span class="s1">).sum(</span><span class="s4">0</span><span class="s1">) / k_mc</span>
    <span class="s1">assert_allclose(frac_reject</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0.17</span><span class="s3">, </span><span class="s4">0.18</span><span class="s3">, </span><span class="s4">0.14</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.001</span><span class="s1">)</span>
    <span class="s0"># result with k_mc = 10000 is [0.1466, 0.1871, 0.1606]</span>
    <span class="s0"># similar to asy below, but not very close for all</span>

    <span class="s1">es_alt_li = []</span>
    <span class="s3">for </span><span class="s1">uv </span><span class="s3">in </span><span class="s1">opt_var:</span>
        <span class="s1">es = effectsize_oneway(means</span><span class="s3">, </span><span class="s1">vars_</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">use_var=uv)</span>
        <span class="s1">es_alt_li.append(es)</span>

    <span class="s0"># compute asy power as comparison</span>
    <span class="s1">margin = wellek_to_f2(eps</span><span class="s3">, </span><span class="s1">k_groups)</span>
    <span class="s1">pow_ = [power_equivalence_oneway(</span>
        <span class="s1">es_</span><span class="s3">, </span><span class="s1">margin</span><span class="s3">, </span><span class="s1">nobs_t</span><span class="s3">, </span><span class="s1">n_groups=k_groups</span><span class="s3">, </span><span class="s1">df=</span><span class="s3">None, </span><span class="s1">alpha=</span><span class="s4">0.05</span><span class="s3">,</span>
        <span class="s1">margin_type=</span><span class="s5">&quot;f2&quot;</span><span class="s1">) </span><span class="s3">for </span><span class="s1">es_ </span><span class="s3">in </span><span class="s1">es_alt_li]</span>
    <span class="s0"># regression test numbers</span>
    <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0.147749</span><span class="s3">, </span><span class="s4">0.173358</span><span class="s3">, </span><span class="s4">0.177412</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">0.007</span><span class="s1">)</span>
</pre>
</body>
</html>