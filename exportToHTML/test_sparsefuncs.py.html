<html>
<head>
<title>test_sparsefuncs.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sparsefuncs.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">scipy.sparse </span><span class="s0">as </span><span class="s1">sp</span>
<span class="s0">from </span><span class="s1">numpy.random </span><span class="s0">import </span><span class="s1">RandomState</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_array_almost_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">linalg</span>

<span class="s0">from </span><span class="s1">sklearn.datasets </span><span class="s0">import </span><span class="s1">make_classification</span>
<span class="s0">from </span><span class="s1">sklearn.utils._testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">sklearn.utils.sparsefuncs </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">count_nonzero</span><span class="s0">,</span>
    <span class="s1">csc_median_axis_0</span><span class="s0">,</span>
    <span class="s1">incr_mean_variance_axis</span><span class="s0">,</span>
    <span class="s1">inplace_column_scale</span><span class="s0">,</span>
    <span class="s1">inplace_row_scale</span><span class="s0">,</span>
    <span class="s1">inplace_swap_column</span><span class="s0">,</span>
    <span class="s1">inplace_swap_row</span><span class="s0">,</span>
    <span class="s1">mean_variance_axis</span><span class="s0">,</span>
    <span class="s1">min_max_axis</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">sklearn.utils.sparsefuncs_fast </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assign_rows_csr</span><span class="s0">,</span>
    <span class="s1">csr_row_norms</span><span class="s0">,</span>
    <span class="s1">inplace_csr_row_normalize_l1</span><span class="s0">,</span>
    <span class="s1">inplace_csr_row_normalize_l2</span><span class="s0">,</span>
<span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_mean_variance_axis0():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">_ = make_classification(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s3"># Sparsify the array a little bit</span>
    <span class="s1">X[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">3</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X_lil = sp.lil_matrix(X)</span>
    <span class="s1">X_lil[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">mean_variance_axis(X_lil</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">X_csr = sp.csr_matrix(X_lil)</span>
    <span class="s1">X_csc = sp.csc_matrix(X_lil)</span>

    <span class="s1">expected_dtypes = [</span>
        <span class="s1">(np.float32</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">,</span>
        <span class="s1">(np.float64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
        <span class="s1">(np.int32</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
        <span class="s1">(np.int64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">input_dtype</span><span class="s0">, </span><span class="s1">output_dtype </span><span class="s0">in </span><span class="s1">expected_dtypes:</span>
        <span class="s1">X_test = X.astype(input_dtype)</span>
        <span class="s0">for </span><span class="s1">X_sparse </span><span class="s0">in </span><span class="s1">(X_csr</span><span class="s0">, </span><span class="s1">X_csc):</span>
            <span class="s1">X_sparse = X_sparse.astype(input_dtype)</span>
            <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars = mean_variance_axis(X_sparse</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">X_means.dtype == output_dtype</span>
            <span class="s0">assert </span><span class="s1">X_vars.dtype == output_dtype</span>
            <span class="s1">assert_array_almost_equal(X_means</span><span class="s0">, </span><span class="s1">np.mean(X_test</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">))</span>
            <span class="s1">assert_array_almost_equal(X_vars</span><span class="s0">, </span><span class="s1">np.var(X_test</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_constructor&quot;</span><span class="s0">, </span><span class="s1">[sp.csr_matrix</span><span class="s0">, </span><span class="s1">sp.csc_matrix])</span>
<span class="s0">def </span><span class="s1">test_mean_variance_axis0_precision(dtype</span><span class="s0">, </span><span class="s1">sparse_constructor):</span>
    <span class="s3"># Check that there's no big loss of precision when the real variance is</span>
    <span class="s3"># exactly 0. (#19766)</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">X = np.full(fill_value=</span><span class="s2">100.0</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s2">1000</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s3"># Add some missing records which should be ignored:</span>
    <span class="s1">missing_indices = rng.choice(np.arange(X.shape[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s1">replace=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">X[missing_indices</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = np.nan</span>
    <span class="s1">X = sparse_constructor(X)</span>

    <span class="s3"># Random positive weights:</span>
    <span class="s1">sample_weight = rng.rand(X.shape[</span><span class="s2">0</span><span class="s1">]).astype(dtype)</span>

    <span class="s1">_</span><span class="s0">, </span><span class="s1">var = mean_variance_axis(X</span><span class="s0">, </span><span class="s1">weights=sample_weight</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">var &lt; np.finfo(dtype).eps</span>


<span class="s0">def </span><span class="s1">test_mean_variance_axis1():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">_ = make_classification(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s3"># Sparsify the array a little bit</span>
    <span class="s1">X[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">3</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X_lil = sp.lil_matrix(X)</span>
    <span class="s1">X_lil[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">mean_variance_axis(X_lil</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s1">X_csr = sp.csr_matrix(X_lil)</span>
    <span class="s1">X_csc = sp.csc_matrix(X_lil)</span>

    <span class="s1">expected_dtypes = [</span>
        <span class="s1">(np.float32</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">,</span>
        <span class="s1">(np.float64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
        <span class="s1">(np.int32</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
        <span class="s1">(np.int64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">input_dtype</span><span class="s0">, </span><span class="s1">output_dtype </span><span class="s0">in </span><span class="s1">expected_dtypes:</span>
        <span class="s1">X_test = X.astype(input_dtype)</span>
        <span class="s0">for </span><span class="s1">X_sparse </span><span class="s0">in </span><span class="s1">(X_csr</span><span class="s0">, </span><span class="s1">X_csc):</span>
            <span class="s1">X_sparse = X_sparse.astype(input_dtype)</span>
            <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars = mean_variance_axis(X_sparse</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">X_means.dtype == output_dtype</span>
            <span class="s0">assert </span><span class="s1">X_vars.dtype == output_dtype</span>
            <span class="s1">assert_array_almost_equal(X_means</span><span class="s0">, </span><span class="s1">np.mean(X_test</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">))</span>
            <span class="s1">assert_array_almost_equal(X_vars</span><span class="s0">, </span><span class="s1">np.var(X_test</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">[</span><span class="s4">&quot;Xw&quot;</span><span class="s0">, </span><span class="s4">&quot;X&quot;</span><span class="s0">, </span><span class="s4">&quot;weights&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_constructor&quot;</span><span class="s0">, </span><span class="s1">[sp.csc_matrix</span><span class="s0">, </span><span class="s1">sp.csr_matrix])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>
<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis_weighted_axis1(</span>
    <span class="s1">Xw</span><span class="s0">, </span><span class="s1">X</span><span class="s0">, </span><span class="s1">weights</span><span class="s0">, </span><span class="s1">sparse_constructor</span><span class="s0">, </span><span class="s1">dtype</span>
<span class="s1">):</span>
    <span class="s1">axis = </span><span class="s2">1</span>
    <span class="s1">Xw_sparse = sparse_constructor(Xw).astype(dtype)</span>
    <span class="s1">X_sparse = sparse_constructor(X).astype(dtype)</span>

    <span class="s1">last_mean = np.zeros(np.shape(Xw)[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">last_var = np.zeros_like(last_mean</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">last_n = np.zeros_like(last_mean</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">means0</span><span class="s0">, </span><span class="s1">vars0</span><span class="s0">, </span><span class="s1">n_incr0 = incr_mean_variance_axis(</span>
        <span class="s1">X=X_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=last_mean</span><span class="s0">,</span>
        <span class="s1">last_var=last_var</span><span class="s0">,</span>
        <span class="s1">last_n=last_n</span><span class="s0">,</span>
        <span class="s1">weights=</span><span class="s0">None,</span>
    <span class="s1">)</span>

    <span class="s1">means_w0</span><span class="s0">, </span><span class="s1">vars_w0</span><span class="s0">, </span><span class="s1">n_incr_w0 = incr_mean_variance_axis(</span>
        <span class="s1">X=Xw_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=last_mean</span><span class="s0">,</span>
        <span class="s1">last_var=last_var</span><span class="s0">,</span>
        <span class="s1">last_n=last_n</span><span class="s0">,</span>
        <span class="s1">weights=weights</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">means_w0.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">vars_w0.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">n_incr_w0.dtype == dtype</span>

    <span class="s1">means_simple</span><span class="s0">, </span><span class="s1">vars_simple = mean_variance_axis(X=X_sparse</span><span class="s0">, </span><span class="s1">axis=axis)</span>

    <span class="s1">assert_array_almost_equal(means0</span><span class="s0">, </span><span class="s1">means_w0)</span>
    <span class="s1">assert_array_almost_equal(means0</span><span class="s0">, </span><span class="s1">means_simple)</span>
    <span class="s1">assert_array_almost_equal(vars0</span><span class="s0">, </span><span class="s1">vars_w0)</span>
    <span class="s1">assert_array_almost_equal(vars0</span><span class="s0">, </span><span class="s1">vars_simple)</span>
    <span class="s1">assert_array_almost_equal(n_incr0</span><span class="s0">, </span><span class="s1">n_incr_w0)</span>

    <span class="s3"># check second round for incremental</span>
    <span class="s1">means1</span><span class="s0">, </span><span class="s1">vars1</span><span class="s0">, </span><span class="s1">n_incr1 = incr_mean_variance_axis(</span>
        <span class="s1">X=X_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=means0</span><span class="s0">,</span>
        <span class="s1">last_var=vars0</span><span class="s0">,</span>
        <span class="s1">last_n=n_incr0</span><span class="s0">,</span>
        <span class="s1">weights=</span><span class="s0">None,</span>
    <span class="s1">)</span>

    <span class="s1">means_w1</span><span class="s0">, </span><span class="s1">vars_w1</span><span class="s0">, </span><span class="s1">n_incr_w1 = incr_mean_variance_axis(</span>
        <span class="s1">X=Xw_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=means_w0</span><span class="s0">,</span>
        <span class="s1">last_var=vars_w0</span><span class="s0">,</span>
        <span class="s1">last_n=n_incr_w0</span><span class="s0">,</span>
        <span class="s1">weights=weights</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_array_almost_equal(means1</span><span class="s0">, </span><span class="s1">means_w1)</span>
    <span class="s1">assert_array_almost_equal(vars1</span><span class="s0">, </span><span class="s1">vars_w1)</span>
    <span class="s1">assert_array_almost_equal(n_incr1</span><span class="s0">, </span><span class="s1">n_incr_w1)</span>

    <span class="s0">assert </span><span class="s1">means_w1.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">vars_w1.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">n_incr_w1.dtype == dtype</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">[</span><span class="s4">&quot;Xw&quot;</span><span class="s0">, </span><span class="s4">&quot;X&quot;</span><span class="s0">, </span><span class="s4">&quot;weights&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan]]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_constructor&quot;</span><span class="s0">, </span><span class="s1">[sp.csc_matrix</span><span class="s0">, </span><span class="s1">sp.csr_matrix])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>
<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis_weighted_axis0(</span>
    <span class="s1">Xw</span><span class="s0">, </span><span class="s1">X</span><span class="s0">, </span><span class="s1">weights</span><span class="s0">, </span><span class="s1">sparse_constructor</span><span class="s0">, </span><span class="s1">dtype</span>
<span class="s1">):</span>
    <span class="s1">axis = </span><span class="s2">0</span>
    <span class="s1">Xw_sparse = sparse_constructor(Xw).astype(dtype)</span>
    <span class="s1">X_sparse = sparse_constructor(X).astype(dtype)</span>

    <span class="s1">last_mean = np.zeros(np.size(Xw</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">last_var = np.zeros_like(last_mean)</span>
    <span class="s1">last_n = np.zeros_like(last_mean</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">means0</span><span class="s0">, </span><span class="s1">vars0</span><span class="s0">, </span><span class="s1">n_incr0 = incr_mean_variance_axis(</span>
        <span class="s1">X=X_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=last_mean</span><span class="s0">,</span>
        <span class="s1">last_var=last_var</span><span class="s0">,</span>
        <span class="s1">last_n=last_n</span><span class="s0">,</span>
        <span class="s1">weights=</span><span class="s0">None,</span>
    <span class="s1">)</span>

    <span class="s1">means_w0</span><span class="s0">, </span><span class="s1">vars_w0</span><span class="s0">, </span><span class="s1">n_incr_w0 = incr_mean_variance_axis(</span>
        <span class="s1">X=Xw_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=last_mean</span><span class="s0">,</span>
        <span class="s1">last_var=last_var</span><span class="s0">,</span>
        <span class="s1">last_n=last_n</span><span class="s0">,</span>
        <span class="s1">weights=weights</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">means_w0.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">vars_w0.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">n_incr_w0.dtype == dtype</span>

    <span class="s1">means_simple</span><span class="s0">, </span><span class="s1">vars_simple = mean_variance_axis(X=X_sparse</span><span class="s0">, </span><span class="s1">axis=axis)</span>

    <span class="s1">assert_array_almost_equal(means0</span><span class="s0">, </span><span class="s1">means_w0)</span>
    <span class="s1">assert_array_almost_equal(means0</span><span class="s0">, </span><span class="s1">means_simple)</span>
    <span class="s1">assert_array_almost_equal(vars0</span><span class="s0">, </span><span class="s1">vars_w0)</span>
    <span class="s1">assert_array_almost_equal(vars0</span><span class="s0">, </span><span class="s1">vars_simple)</span>
    <span class="s1">assert_array_almost_equal(n_incr0</span><span class="s0">, </span><span class="s1">n_incr_w0)</span>

    <span class="s3"># check second round for incremental</span>
    <span class="s1">means1</span><span class="s0">, </span><span class="s1">vars1</span><span class="s0">, </span><span class="s1">n_incr1 = incr_mean_variance_axis(</span>
        <span class="s1">X=X_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=means0</span><span class="s0">,</span>
        <span class="s1">last_var=vars0</span><span class="s0">,</span>
        <span class="s1">last_n=n_incr0</span><span class="s0">,</span>
        <span class="s1">weights=</span><span class="s0">None,</span>
    <span class="s1">)</span>

    <span class="s1">means_w1</span><span class="s0">, </span><span class="s1">vars_w1</span><span class="s0">, </span><span class="s1">n_incr_w1 = incr_mean_variance_axis(</span>
        <span class="s1">X=Xw_sparse</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=means_w0</span><span class="s0">,</span>
        <span class="s1">last_var=vars_w0</span><span class="s0">,</span>
        <span class="s1">last_n=n_incr_w0</span><span class="s0">,</span>
        <span class="s1">weights=weights</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_array_almost_equal(means1</span><span class="s0">, </span><span class="s1">means_w1)</span>
    <span class="s1">assert_array_almost_equal(vars1</span><span class="s0">, </span><span class="s1">vars_w1)</span>
    <span class="s1">assert_array_almost_equal(n_incr1</span><span class="s0">, </span><span class="s1">n_incr_w1)</span>

    <span class="s0">assert </span><span class="s1">means_w1.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">vars_w1.dtype == dtype</span>
    <span class="s0">assert </span><span class="s1">n_incr_w1.dtype == dtype</span>


<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis():</span>
    <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]:</span>
        <span class="s1">rng = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">n_features = </span><span class="s2">50</span>
        <span class="s1">n_samples = </span><span class="s2">10</span>
        <span class="s0">if </span><span class="s1">axis == </span><span class="s2">0</span><span class="s1">:</span>
            <span class="s1">data_chunks = [rng.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">size=n_features) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(n_samples)]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">data_chunks = [rng.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">size=n_samples) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(n_features)]</span>

        <span class="s3"># default params for incr_mean_variance</span>
        <span class="s1">last_mean = np.zeros(n_features) </span><span class="s0">if </span><span class="s1">axis == </span><span class="s2">0 </span><span class="s0">else </span><span class="s1">np.zeros(n_samples)</span>
        <span class="s1">last_var = np.zeros_like(last_mean)</span>
        <span class="s1">last_n = np.zeros_like(last_mean</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

        <span class="s3"># Test errors</span>
        <span class="s1">X = np.array(data_chunks[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">X = np.atleast_2d(X)</span>
        <span class="s1">X = X.T </span><span class="s0">if </span><span class="s1">axis == </span><span class="s2">1 </span><span class="s0">else </span><span class="s1">X</span>
        <span class="s1">X_lil = sp.lil_matrix(X)</span>
        <span class="s1">X_csr = sp.csr_matrix(X_lil)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
            <span class="s1">incr_mean_variance_axis(</span>
                <span class="s1">X=axis</span><span class="s0">, </span><span class="s1">axis=last_mean</span><span class="s0">, </span><span class="s1">last_mean=last_var</span><span class="s0">, </span><span class="s1">last_var=last_n</span>
            <span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
            <span class="s1">incr_mean_variance_axis(</span>
                <span class="s1">X_lil</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
            <span class="s1">)</span>

        <span class="s3"># Test _incr_mean_and_var with a 1 row input</span>
        <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars = mean_variance_axis(X_csr</span><span class="s0">, </span><span class="s1">axis)</span>
        <span class="s1">X_means_incr</span><span class="s0">, </span><span class="s1">X_vars_incr</span><span class="s0">, </span><span class="s1">n_incr = incr_mean_variance_axis(</span>
            <span class="s1">X_csr</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(X_means</span><span class="s0">, </span><span class="s1">X_means_incr)</span>
        <span class="s1">assert_array_almost_equal(X_vars</span><span class="s0">, </span><span class="s1">X_vars_incr)</span>
        <span class="s3"># X.shape[axis] picks # samples</span>
        <span class="s1">assert_array_equal(X.shape[axis]</span><span class="s0">, </span><span class="s1">n_incr)</span>

        <span class="s1">X_csc = sp.csc_matrix(X_lil)</span>
        <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars = mean_variance_axis(X_csc</span><span class="s0">, </span><span class="s1">axis)</span>
        <span class="s1">assert_array_almost_equal(X_means</span><span class="s0">, </span><span class="s1">X_means_incr)</span>
        <span class="s1">assert_array_almost_equal(X_vars</span><span class="s0">, </span><span class="s1">X_vars_incr)</span>
        <span class="s1">assert_array_equal(X.shape[axis]</span><span class="s0">, </span><span class="s1">n_incr)</span>

        <span class="s3"># Test _incremental_mean_and_var with whole data</span>
        <span class="s1">X = np.vstack(data_chunks)</span>
        <span class="s1">X = X.T </span><span class="s0">if </span><span class="s1">axis == </span><span class="s2">1 </span><span class="s0">else </span><span class="s1">X</span>
        <span class="s1">X_lil = sp.lil_matrix(X)</span>
        <span class="s1">X_csr = sp.csr_matrix(X_lil)</span>
        <span class="s1">X_csc = sp.csc_matrix(X_lil)</span>

        <span class="s1">expected_dtypes = [</span>
            <span class="s1">(np.float32</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">,</span>
            <span class="s1">(np.float64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
            <span class="s1">(np.int32</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
            <span class="s1">(np.int64</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">,</span>
        <span class="s1">]</span>

        <span class="s0">for </span><span class="s1">input_dtype</span><span class="s0">, </span><span class="s1">output_dtype </span><span class="s0">in </span><span class="s1">expected_dtypes:</span>
            <span class="s0">for </span><span class="s1">X_sparse </span><span class="s0">in </span><span class="s1">(X_csr</span><span class="s0">, </span><span class="s1">X_csc):</span>
                <span class="s1">X_sparse = X_sparse.astype(input_dtype)</span>
                <span class="s1">last_mean = last_mean.astype(output_dtype)</span>
                <span class="s1">last_var = last_var.astype(output_dtype)</span>
                <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars = mean_variance_axis(X_sparse</span><span class="s0">, </span><span class="s1">axis)</span>
                <span class="s1">X_means_incr</span><span class="s0">, </span><span class="s1">X_vars_incr</span><span class="s0">, </span><span class="s1">n_incr = incr_mean_variance_axis(</span>
                    <span class="s1">X_sparse</span><span class="s0">,</span>
                    <span class="s1">axis=axis</span><span class="s0">,</span>
                    <span class="s1">last_mean=last_mean</span><span class="s0">,</span>
                    <span class="s1">last_var=last_var</span><span class="s0">,</span>
                    <span class="s1">last_n=last_n</span><span class="s0">,</span>
                <span class="s1">)</span>
                <span class="s0">assert </span><span class="s1">X_means_incr.dtype == output_dtype</span>
                <span class="s0">assert </span><span class="s1">X_vars_incr.dtype == output_dtype</span>
                <span class="s1">assert_array_almost_equal(X_means</span><span class="s0">, </span><span class="s1">X_means_incr)</span>
                <span class="s1">assert_array_almost_equal(X_vars</span><span class="s0">, </span><span class="s1">X_vars_incr)</span>
                <span class="s1">assert_array_equal(X.shape[axis]</span><span class="s0">, </span><span class="s1">n_incr)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_constructor&quot;</span><span class="s0">, </span><span class="s1">[sp.csc_matrix</span><span class="s0">, </span><span class="s1">sp.csr_matrix])</span>
<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis_dim_mismatch(sparse_constructor):</span>
    <span class="s5">&quot;&quot;&quot;Check that we raise proper error when axis=1 and the dimension mismatch. 
    Non-regression test for: 
    https://github.com/scikit-learn/scikit-learn/pull/18655 
    &quot;&quot;&quot;</span>
    <span class="s1">n_samples</span><span class="s0">, </span><span class="s1">n_features = </span><span class="s2">60</span><span class="s0">, </span><span class="s2">4</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">42</span><span class="s1">)</span>
    <span class="s1">X = sparse_constructor(rng.rand(n_samples</span><span class="s0">, </span><span class="s1">n_features))</span>

    <span class="s1">last_mean = np.zeros(n_features)</span>
    <span class="s1">last_var = np.zeros_like(last_mean)</span>
    <span class="s1">last_n = np.zeros(last_mean.shape</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

    <span class="s1">kwargs = dict(last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n)</span>
    <span class="s1">mean0</span><span class="s0">, </span><span class="s1">var0</span><span class="s0">, </span><span class="s1">_ = incr_mean_variance_axis(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">assert_allclose(np.mean(X.toarray()</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">mean0)</span>
    <span class="s1">assert_allclose(np.var(X.toarray()</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">var0)</span>

    <span class="s3"># test ValueError if axis=1 and last_mean.size == n_features</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">incr_mean_variance_axis(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s3"># test inconsistent shapes of last_mean, last_var, last_n</span>
    <span class="s1">kwargs = dict(last_mean=last_mean[:-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">incr_mean_variance_axis(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;X1, X2&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">sp.random(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">format=</span><span class="s4">&quot;csr&quot;</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">sp.random(</span><span class="s2">13</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">format=</span><span class="s4">&quot;csr&quot;</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">sp.random(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">format=</span><span class="s4">&quot;csr&quot;</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">sp.hstack(</span>
                <span class="s1">[</span>
                    <span class="s1">sp.csr_matrix(np.full((</span><span class="s2">13</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">fill_value=np.nan))</span><span class="s0">,</span>
                    <span class="s1">sp.random(</span><span class="s2">13</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">42</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">]</span><span class="s0">,</span>
                <span class="s1">format=</span><span class="s4">&quot;csr&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis_equivalence_mean_variance(X1</span><span class="s0">, </span><span class="s1">X2):</span>
    <span class="s3"># non-regression test for:</span>
    <span class="s3"># https://github.com/scikit-learn/scikit-learn/issues/16448</span>
    <span class="s3"># check that computing the incremental mean and variance is equivalent to</span>
    <span class="s3"># computing the mean and variance on the stacked dataset.</span>
    <span class="s1">axis = </span><span class="s2">0</span>
    <span class="s1">last_mean</span><span class="s0">, </span><span class="s1">last_var = np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">last_n = np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">updated_mean</span><span class="s0">, </span><span class="s1">updated_var</span><span class="s0">, </span><span class="s1">updated_n = incr_mean_variance_axis(</span>
        <span class="s1">X1</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
    <span class="s1">)</span>
    <span class="s1">updated_mean</span><span class="s0">, </span><span class="s1">updated_var</span><span class="s0">, </span><span class="s1">updated_n = incr_mean_variance_axis(</span>
        <span class="s1">X2</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=updated_mean</span><span class="s0">, </span><span class="s1">last_var=updated_var</span><span class="s0">, </span><span class="s1">last_n=updated_n</span>
    <span class="s1">)</span>
    <span class="s1">X = sp.vstack([X1</span><span class="s0">, </span><span class="s1">X2])</span>
    <span class="s1">assert_allclose(updated_mean</span><span class="s0">, </span><span class="s1">np.nanmean(X.toarray()</span><span class="s0">, </span><span class="s1">axis=axis))</span>
    <span class="s1">assert_allclose(updated_var</span><span class="s0">, </span><span class="s1">np.nanvar(X.toarray()</span><span class="s0">, </span><span class="s1">axis=axis))</span>
    <span class="s1">assert_allclose(updated_n</span><span class="s0">, </span><span class="s1">np.count_nonzero(~np.isnan(X.toarray())</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_incr_mean_variance_no_new_n():</span>
    <span class="s3"># check the behaviour when we update the variance with an empty matrix</span>
    <span class="s1">axis = </span><span class="s2">0</span>
    <span class="s1">X1 = sp.random(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">).tocsr()</span>
    <span class="s1">X2 = sp.random(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">).tocsr()</span>
    <span class="s1">last_mean</span><span class="s0">, </span><span class="s1">last_var = np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">last_n = np.zeros(X1.shape[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">last_mean</span><span class="s0">, </span><span class="s1">last_var</span><span class="s0">, </span><span class="s1">last_n = incr_mean_variance_axis(</span>
        <span class="s1">X1</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
    <span class="s1">)</span>
    <span class="s3"># update statistic with a column which should ignored</span>
    <span class="s1">updated_mean</span><span class="s0">, </span><span class="s1">updated_var</span><span class="s0">, </span><span class="s1">updated_n = incr_mean_variance_axis(</span>
        <span class="s1">X2</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(updated_mean</span><span class="s0">, </span><span class="s1">last_mean)</span>
    <span class="s1">assert_allclose(updated_var</span><span class="s0">, </span><span class="s1">last_var)</span>
    <span class="s1">assert_allclose(updated_n</span><span class="s0">, </span><span class="s1">last_n)</span>


<span class="s0">def </span><span class="s1">test_incr_mean_variance_n_float():</span>
    <span class="s3"># check the behaviour when last_n is just a number</span>
    <span class="s1">axis = </span><span class="s2">0</span>
    <span class="s1">X = sp.random(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">density=</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">).tocsr()</span>
    <span class="s1">last_mean</span><span class="s0">, </span><span class="s1">last_var = np.zeros(X.shape[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.zeros(X.shape[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">last_n = </span><span class="s2">0</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">new_n = incr_mean_variance_axis(</span>
        <span class="s1">X</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">last_mean=last_mean</span><span class="s0">, </span><span class="s1">last_var=last_var</span><span class="s0">, </span><span class="s1">last_n=last_n</span>
    <span class="s1">)</span>
    <span class="s1">assert_allclose(new_n</span><span class="s0">, </span><span class="s1">np.full(X.shape[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X.shape[</span><span class="s2">0</span><span class="s1">]))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_constructor&quot;</span><span class="s0">, </span><span class="s1">[sp.csc_matrix</span><span class="s0">, </span><span class="s1">sp.csr_matrix])</span>
<span class="s0">def </span><span class="s1">test_incr_mean_variance_axis_ignore_nan(axis</span><span class="s0">, </span><span class="s1">sparse_constructor):</span>
    <span class="s1">old_means = np.array([</span><span class="s2">535.0</span><span class="s0">, </span><span class="s2">535.0</span><span class="s0">, </span><span class="s2">535.0</span><span class="s0">, </span><span class="s2">535.0</span><span class="s1">])</span>
    <span class="s1">old_variances = np.array([</span><span class="s2">4225.0</span><span class="s0">, </span><span class="s2">4225.0</span><span class="s0">, </span><span class="s2">4225.0</span><span class="s0">, </span><span class="s2">4225.0</span><span class="s1">])</span>
    <span class="s1">old_sample_count = np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>

    <span class="s1">X = sparse_constructor(</span>
        <span class="s1">np.array([[</span><span class="s2">170</span><span class="s0">, </span><span class="s2">170</span><span class="s0">, </span><span class="s2">170</span><span class="s0">, </span><span class="s2">170</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">430</span><span class="s0">, </span><span class="s2">430</span><span class="s0">, </span><span class="s2">430</span><span class="s0">, </span><span class="s2">430</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">300</span><span class="s0">, </span><span class="s2">300</span><span class="s0">, </span><span class="s2">300</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]])</span>
    <span class="s1">)</span>

    <span class="s1">X_nan = sparse_constructor(</span>
        <span class="s1">np.array(</span>
            <span class="s1">[</span>
                <span class="s1">[</span><span class="s2">170</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">170</span><span class="s0">, </span><span class="s2">170</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[np.nan</span><span class="s0">, </span><span class="s2">170</span><span class="s0">, </span><span class="s2">430</span><span class="s0">, </span><span class="s2">430</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">430</span><span class="s0">, </span><span class="s2">430</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s2">300</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">[</span><span class="s2">300</span><span class="s0">, </span><span class="s2">300</span><span class="s0">, </span><span class="s2">300</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">,</span>
            <span class="s1">]</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s3"># we avoid creating specific data for axis 0 and 1: translating the data is</span>
    <span class="s3"># enough.</span>
    <span class="s0">if </span><span class="s1">axis:</span>
        <span class="s1">X = X.T</span>
        <span class="s1">X_nan = X_nan.T</span>

    <span class="s3"># take a copy of the old statistics since they are modified in place.</span>
    <span class="s1">X_means</span><span class="s0">, </span><span class="s1">X_vars</span><span class="s0">, </span><span class="s1">X_sample_count = incr_mean_variance_axis(</span>
        <span class="s1">X</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=old_means.copy()</span><span class="s0">,</span>
        <span class="s1">last_var=old_variances.copy()</span><span class="s0">,</span>
        <span class="s1">last_n=old_sample_count.copy()</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">X_nan_means</span><span class="s0">, </span><span class="s1">X_nan_vars</span><span class="s0">, </span><span class="s1">X_nan_sample_count = incr_mean_variance_axis(</span>
        <span class="s1">X_nan</span><span class="s0">,</span>
        <span class="s1">axis=axis</span><span class="s0">,</span>
        <span class="s1">last_mean=old_means.copy()</span><span class="s0">,</span>
        <span class="s1">last_var=old_variances.copy()</span><span class="s0">,</span>
        <span class="s1">last_n=old_sample_count.copy()</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_allclose(X_nan_means</span><span class="s0">, </span><span class="s1">X_means)</span>
    <span class="s1">assert_allclose(X_nan_vars</span><span class="s0">, </span><span class="s1">X_vars)</span>
    <span class="s1">assert_allclose(X_nan_sample_count</span><span class="s0">, </span><span class="s1">X_sample_count)</span>


<span class="s0">def </span><span class="s1">test_mean_variance_illegal_axis():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">_ = make_classification(</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s3"># Sparsify the array a little bit</span>
    <span class="s1">X[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">3</span><span class="s1">] = </span><span class="s2">0</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">mean_variance_axis(X_csr</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s2">3</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">mean_variance_axis(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">mean_variance_axis(X_csr</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">incr_mean_variance_axis(</span>
            <span class="s1">X_csr</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s2">3</span><span class="s0">, </span><span class="s1">last_mean=</span><span class="s0">None, </span><span class="s1">last_var=</span><span class="s0">None, </span><span class="s1">last_n=</span><span class="s0">None</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">incr_mean_variance_axis(</span>
            <span class="s1">X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s0">, </span><span class="s1">last_mean=</span><span class="s0">None, </span><span class="s1">last_var=</span><span class="s0">None, </span><span class="s1">last_n=</span><span class="s0">None</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">incr_mean_variance_axis(</span>
            <span class="s1">X_csr</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">last_mean=</span><span class="s0">None, </span><span class="s1">last_var=</span><span class="s0">None, </span><span class="s1">last_n=</span><span class="s0">None</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_densify_rows():</span>
    <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">(np.float32</span><span class="s0">, </span><span class="s1">np.float64):</span>
        <span class="s1">X = sp.csr_matrix(</span>
            <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=dtype</span>
        <span class="s1">)</span>
        <span class="s1">X_rows = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.intp)</span>
        <span class="s1">out = np.ones((</span><span class="s2">6</span><span class="s0">, </span><span class="s1">X.shape[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
        <span class="s1">out_rows = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.intp)</span>

        <span class="s1">expect = np.ones_like(out)</span>
        <span class="s1">expect[out_rows] = X[X_rows</span><span class="s0">, </span><span class="s1">:].toarray()</span>

        <span class="s1">assign_rows_csr(X</span><span class="s0">, </span><span class="s1">X_rows</span><span class="s0">, </span><span class="s1">out_rows</span><span class="s0">, </span><span class="s1">out)</span>
        <span class="s1">assert_array_equal(out</span><span class="s0">, </span><span class="s1">expect)</span>


<span class="s0">def </span><span class="s1">test_inplace_column_scale():</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">X = sp.rand(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">0.05</span><span class="s1">)</span>
    <span class="s1">Xr = X.tocsr()</span>
    <span class="s1">Xc = X.tocsc()</span>
    <span class="s1">XA = X.toarray()</span>
    <span class="s1">scale = rng.rand(</span><span class="s2">200</span><span class="s1">)</span>
    <span class="s1">XA *= scale</span>

    <span class="s1">inplace_column_scale(Xc</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">inplace_column_scale(Xr</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">assert_array_almost_equal(Xr.toarray()</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_column_scale(X.tolil()</span><span class="s0">, </span><span class="s1">scale)</span>

    <span class="s1">X = X.astype(np.float32)</span>
    <span class="s1">scale = scale.astype(np.float32)</span>
    <span class="s1">Xr = X.tocsr()</span>
    <span class="s1">Xc = X.tocsc()</span>
    <span class="s1">XA = X.toarray()</span>
    <span class="s1">XA *= scale</span>
    <span class="s1">inplace_column_scale(Xc</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">inplace_column_scale(Xr</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">assert_array_almost_equal(Xr.toarray()</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_column_scale(X.tolil()</span><span class="s0">, </span><span class="s1">scale)</span>


<span class="s0">def </span><span class="s1">test_inplace_row_scale():</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">X = sp.rand(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">200</span><span class="s0">, </span><span class="s2">0.05</span><span class="s1">)</span>
    <span class="s1">Xr = X.tocsr()</span>
    <span class="s1">Xc = X.tocsc()</span>
    <span class="s1">XA = X.toarray()</span>
    <span class="s1">scale = rng.rand(</span><span class="s2">100</span><span class="s1">)</span>
    <span class="s1">XA *= scale.reshape(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>

    <span class="s1">inplace_row_scale(Xc</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">inplace_row_scale(Xr</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">assert_array_almost_equal(Xr.toarray()</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_column_scale(X.tolil()</span><span class="s0">, </span><span class="s1">scale)</span>

    <span class="s1">X = X.astype(np.float32)</span>
    <span class="s1">scale = scale.astype(np.float32)</span>
    <span class="s1">Xr = X.tocsr()</span>
    <span class="s1">Xc = X.tocsc()</span>
    <span class="s1">XA = X.toarray()</span>
    <span class="s1">XA *= scale.reshape(-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_row_scale(Xc</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">inplace_row_scale(Xr</span><span class="s0">, </span><span class="s1">scale)</span>
    <span class="s1">assert_array_almost_equal(Xr.toarray()</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xc.toarray())</span>
    <span class="s1">assert_array_almost_equal(XA</span><span class="s0">, </span><span class="s1">Xr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_column_scale(X.tolil()</span><span class="s0">, </span><span class="s1">scale)</span>


<span class="s0">def </span><span class="s1">test_inplace_swap_row():</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>

    <span class="s1">swap = linalg.get_blas_funcs((</span><span class="s4">&quot;swap&quot;</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(X</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">swap = swap[</span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">X[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[-</span><span class="s2">1</span><span class="s1">] = swap(X[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_row(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_row(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>

    <span class="s1">X[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[</span><span class="s2">3</span><span class="s1">] = swap(X[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[</span><span class="s2">3</span><span class="s1">])</span>
    <span class="s1">inplace_swap_row(X_csr</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">inplace_swap_row(X_csc</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_swap_row(X_csr.tolil())</span>

    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float32</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>
    <span class="s1">swap = linalg.get_blas_funcs((</span><span class="s4">&quot;swap&quot;</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(X</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">swap = swap[</span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">X[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[-</span><span class="s2">1</span><span class="s1">] = swap(X[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_row(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_row(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s1">X[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[</span><span class="s2">3</span><span class="s1">] = swap(X[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[</span><span class="s2">3</span><span class="s1">])</span>
    <span class="s1">inplace_swap_row(X_csr</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">inplace_swap_row(X_csc</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_swap_row(X_csr.tolil())</span>


<span class="s0">def </span><span class="s1">test_inplace_swap_column():</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>

    <span class="s1">swap = linalg.get_blas_funcs((</span><span class="s4">&quot;swap&quot;</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(X</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">swap = swap[</span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">] = swap(X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_column(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_column(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>

    <span class="s1">X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = swap(X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_column(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_column(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_swap_column(X_csr.tolil())</span>

    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float32</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>
    <span class="s1">swap = linalg.get_blas_funcs((</span><span class="s4">&quot;swap&quot;</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(X</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">swap = swap[</span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">] = swap(X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_column(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_column(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s1">X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = swap(X[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">X[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">inplace_swap_column(X_csr</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">inplace_swap_column(X_csc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_csr.toarray()</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csc.toarray())</span>
    <span class="s1">assert_array_equal(X</span><span class="s0">, </span><span class="s1">X_csr.toarray())</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">inplace_swap_column(X_csr.tolil())</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, None</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;sparse_format&quot;</span><span class="s0">, </span><span class="s1">[sp.csr_matrix</span><span class="s0">, </span><span class="s1">sp.csc_matrix])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;missing_values, min_func, max_func, ignore_nan&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.min</span><span class="s0">, </span><span class="s1">np.max</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, </span><span class="s1">np.nanmin</span><span class="s0">, </span><span class="s1">np.nanmax</span><span class="s0">, True</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;large_indices&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_min_max(</span>
    <span class="s1">dtype</span><span class="s0">,</span>
    <span class="s1">axis</span><span class="s0">,</span>
    <span class="s1">sparse_format</span><span class="s0">,</span>
    <span class="s1">missing_values</span><span class="s0">,</span>
    <span class="s1">min_func</span><span class="s0">,</span>
    <span class="s1">max_func</span><span class="s0">,</span>
    <span class="s1">ignore_nan</span><span class="s0">,</span>
    <span class="s1">large_indices</span><span class="s0">,</span>
<span class="s1">):</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">missing_values]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s1">missing_values</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">dtype=dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">X_sparse = sparse_format(X)</span>
    <span class="s0">if </span><span class="s1">large_indices:</span>
        <span class="s1">X_sparse.indices = X_sparse.indices.astype(</span><span class="s4">&quot;int64&quot;</span><span class="s1">)</span>
        <span class="s1">X_sparse.indptr = X_sparse.indptr.astype(</span><span class="s4">&quot;int64&quot;</span><span class="s1">)</span>

    <span class="s1">mins_sparse</span><span class="s0">, </span><span class="s1">maxs_sparse = min_max_axis(X_sparse</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">ignore_nan=ignore_nan)</span>
    <span class="s1">assert_array_equal(mins_sparse</span><span class="s0">, </span><span class="s1">min_func(X</span><span class="s0">, </span><span class="s1">axis=axis))</span>
    <span class="s1">assert_array_equal(maxs_sparse</span><span class="s0">, </span><span class="s1">max_func(X</span><span class="s0">, </span><span class="s1">axis=axis))</span>


<span class="s0">def </span><span class="s1">test_min_max_axis_errors():</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">min_max_axis(X_csr.tolil()</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">min_max_axis(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">min_max_axis(X_csc</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s2">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_count_nonzero():</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">9</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
    <span class="s1">)</span>
    <span class="s1">X_csr = sp.csr_matrix(X)</span>
    <span class="s1">X_csc = sp.csc_matrix(X)</span>
    <span class="s1">X_nonzero = X != </span><span class="s2">0</span>
    <span class="s1">sample_weight = [</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.2</span><span class="s0">, </span><span class="s2">0.3</span><span class="s0">, </span><span class="s2">0.1</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">]</span>
    <span class="s1">X_nonzero_weighted = X_nonzero * np.array(sample_weight)[:</span><span class="s0">, None</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, None</span><span class="s1">]:</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">X_nonzero.sum(axis=axis)</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight)</span><span class="s0">,</span>
            <span class="s1">X_nonzero_weighted.sum(axis=axis)</span><span class="s0">,</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">count_nonzero(X_csc)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">2</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">).dtype == count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">).dtype</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight).dtype</span>
        <span class="s1">== count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight).dtype</span>
    <span class="s1">)</span>

    <span class="s3"># Check dtypes with large sparse matrices too</span>
    <span class="s3"># XXX: test fails on 32bit (Windows/Linux)</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">X_csr.indices = X_csr.indices.astype(np.int64)</span>
        <span class="s1">X_csr.indptr = X_csr.indptr.astype(np.int64)</span>
        <span class="s0">assert </span><span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">).dtype == count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">).dtype</span>
        <span class="s0">assert </span><span class="s1">(</span>
            <span class="s1">count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight).dtype</span>
            <span class="s1">== count_nonzero(X_csr</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s0">, </span><span class="s1">sample_weight=sample_weight).dtype</span>
        <span class="s1">)</span>
    <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">assert </span><span class="s4">&quot;according to the rule 'safe'&quot; </span><span class="s0">in </span><span class="s1">e.args[</span><span class="s2">0</span><span class="s1">] </span><span class="s0">and </span><span class="s1">np.intp().nbytes &lt; </span><span class="s2">8</span><span class="s0">, </span><span class="s1">e</span>


<span class="s0">def </span><span class="s1">test_csc_row_median():</span>
    <span class="s3"># Test csc_row_median actually calculates the median.</span>

    <span class="s3"># Test that it gives the same output when X is dense.</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">X = rng.rand(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">50</span><span class="s1">)</span>
    <span class="s1">dense_median = np.median(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">csc = sp.csc_matrix(X)</span>
    <span class="s1">sparse_median = csc_median_axis_0(csc)</span>
    <span class="s1">assert_array_equal(sparse_median</span><span class="s0">, </span><span class="s1">dense_median)</span>

    <span class="s3"># Test that it gives the same output when X is sparse</span>
    <span class="s1">X = rng.rand(</span><span class="s2">51</span><span class="s0">, </span><span class="s2">100</span><span class="s1">)</span>
    <span class="s1">X[X &lt; </span><span class="s2">0.7</span><span class="s1">] = </span><span class="s2">0.0</span>
    <span class="s1">ind = rng.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">50</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">X[ind] = -X[ind]</span>
    <span class="s1">csc = sp.csc_matrix(X)</span>
    <span class="s1">dense_median = np.median(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">sparse_median = csc_median_axis_0(csc)</span>
    <span class="s1">assert_array_equal(sparse_median</span><span class="s0">, </span><span class="s1">dense_median)</span>

    <span class="s3"># Test for toy data.</span>
    <span class="s1">X = [[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span>
    <span class="s1">csc = sp.csc_matrix(X)</span>
    <span class="s1">assert_array_equal(csc_median_axis_0(csc)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.5</span><span class="s1">]))</span>
    <span class="s1">X = [[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">]]</span>
    <span class="s1">csc = sp.csc_matrix(X)</span>
    <span class="s1">assert_array_equal(csc_median_axis_0(csc)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">]))</span>

    <span class="s3"># Test that it raises an Error for non-csc matrices.</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">csc_median_axis_0(sp.csr_matrix(X))</span>


<span class="s0">def </span><span class="s1">test_inplace_normalize():</span>
    <span class="s1">ones = np.ones((</span><span class="s2">10</span><span class="s0">, </span><span class="s2">1</span><span class="s1">))</span>
    <span class="s1">rs = RandomState(</span><span class="s2">10</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">inplace_csr_row_normalize </span><span class="s0">in </span><span class="s1">(</span>
        <span class="s1">inplace_csr_row_normalize_l1</span><span class="s0">,</span>
        <span class="s1">inplace_csr_row_normalize_l2</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">(np.float64</span><span class="s0">, </span><span class="s1">np.float32):</span>
            <span class="s1">X = rs.randn(</span><span class="s2">10</span><span class="s0">, </span><span class="s2">5</span><span class="s1">).astype(dtype)</span>
            <span class="s1">X_csr = sp.csr_matrix(X)</span>
            <span class="s0">for </span><span class="s1">index_dtype </span><span class="s0">in </span><span class="s1">[np.int32</span><span class="s0">, </span><span class="s1">np.int64]:</span>
                <span class="s3"># csr_matrix will use int32 indices by default,</span>
                <span class="s3"># up-casting those to int64 when necessary</span>
                <span class="s0">if </span><span class="s1">index_dtype </span><span class="s0">is </span><span class="s1">np.int64:</span>
                    <span class="s1">X_csr.indptr = X_csr.indptr.astype(index_dtype)</span>
                    <span class="s1">X_csr.indices = X_csr.indices.astype(index_dtype)</span>
                <span class="s0">assert </span><span class="s1">X_csr.indices.dtype == index_dtype</span>
                <span class="s0">assert </span><span class="s1">X_csr.indptr.dtype == index_dtype</span>
                <span class="s1">inplace_csr_row_normalize(X_csr)</span>
                <span class="s0">assert </span><span class="s1">X_csr.dtype == dtype</span>
                <span class="s0">if </span><span class="s1">inplace_csr_row_normalize </span><span class="s0">is </span><span class="s1">inplace_csr_row_normalize_l2:</span>
                    <span class="s1">X_csr.data **= </span><span class="s2">2</span>
                <span class="s1">assert_array_almost_equal(np.abs(X_csr).sum(axis=</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ones)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>
<span class="s0">def </span><span class="s1">test_csr_row_norms(dtype):</span>
    <span class="s3"># checks that csr_row_norms returns the same output as</span>
    <span class="s3"># scipy.sparse.linalg.norm, and that the dype is the same as X.dtype.</span>
    <span class="s1">X = sp.random(</span><span class="s2">100</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s1">format=</span><span class="s4">&quot;csr&quot;</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">42</span><span class="s1">)</span>

    <span class="s1">scipy_norms = sp.linalg.norm(X</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">1</span><span class="s1">) ** </span><span class="s2">2</span>
    <span class="s1">norms = csr_row_norms(X)</span>

    <span class="s0">assert </span><span class="s1">norms.dtype == dtype</span>
    <span class="s1">rtol = </span><span class="s2">1e-6 </span><span class="s0">if </span><span class="s1">dtype == np.float32 </span><span class="s0">else </span><span class="s2">1e-7</span>
    <span class="s1">assert_allclose(norms</span><span class="s0">, </span><span class="s1">scipy_norms</span><span class="s0">, </span><span class="s1">rtol=rtol)</span>
</pre>
</body>
</html>