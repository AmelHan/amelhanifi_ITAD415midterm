<html>
<head>
<title>test_lsq_common.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_lsq_common.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_allclose</span><span class="s0">, </span><span class="s1">assert_equal</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">scipy.optimize._lsq.common </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">step_size_to_bound</span><span class="s0">, </span><span class="s1">find_active_constraints</span><span class="s0">, </span><span class="s1">make_strictly_feasible</span><span class="s0">,</span>
    <span class="s1">CL_scaling_vector</span><span class="s0">, </span><span class="s1">intersect_trust_region</span><span class="s0">, </span><span class="s1">build_quadratic_1d</span><span class="s0">,</span>
    <span class="s1">minimize_quadratic_1d</span><span class="s0">, </span><span class="s1">evaluate_quadratic</span><span class="s0">, </span><span class="s1">reflective_transformation</span><span class="s0">,</span>
    <span class="s1">left_multiplied_operator</span><span class="s0">, </span><span class="s1">right_multiplied_operator)</span>


<span class="s0">class </span><span class="s1">TestBounds:</span>
    <span class="s0">def </span><span class="s1">test_step_size_to_bounds(self):</span>
        <span class="s1">lb = np.array([-</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">10.0</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">100.0</span><span class="s1">])</span>
        <span class="s1">x = np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">12.0</span><span class="s1">])</span>

        <span class="s1">s = np.array([</span><span class="s2">0.1</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">step</span><span class="s0">, </span><span class="s1">hits = step_size_to_bound(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(step</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">assert_equal(hits</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">s = np.array([</span><span class="s2">0.01</span><span class="s0">, </span><span class="s2">0.05</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">step</span><span class="s0">, </span><span class="s1">hits = step_size_to_bound(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(step</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(hits</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>

        <span class="s1">s = np.array([</span><span class="s2">10.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.0001</span><span class="s0">, </span><span class="s2">100.0</span><span class="s1">])</span>
        <span class="s1">step</span><span class="s0">, </span><span class="s1">hits = step_size_to_bound(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(step</span><span class="s0">, </span><span class="s1">np.array(-</span><span class="s2">0</span><span class="s1">))</span>
        <span class="s1">assert_equal(hits</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">s = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2.0</span><span class="s1">])</span>
        <span class="s1">step</span><span class="s0">, </span><span class="s1">hits = step_size_to_bound(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(step</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">)</span>
        <span class="s1">assert_equal(hits</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>

        <span class="s1">s = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">step</span><span class="s0">, </span><span class="s1">hits = step_size_to_bound(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(step</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(hits</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_find_active_constraints(self):</span>
        <span class="s1">lb = np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">100.0</span><span class="s1">])</span>

        <span class="s1">x = np.array([</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">])</span>
        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">x = np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">10.0</span><span class="s1">])</span>
        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">x = np.array([</span><span class="s2">1e-9</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1e-8</span><span class="s0">, </span><span class="s2">100 </span><span class="s1">- </span><span class="s2">1e-9</span><span class="s1">])</span>
        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>

        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1.5e-9</span><span class="s1">)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>

        <span class="s1">lb = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf])</span>
        <span class="s1">ub = np.array([np.inf</span><span class="s0">, </span><span class="s2">10.0</span><span class="s0">, </span><span class="s1">np.inf])</span>

        <span class="s1">x = np.ones(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s3"># Handles out-of-bound cases.</span>
        <span class="s1">x = np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">11.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">active = find_active_constraints(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(active</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_make_strictly_feasible(self):</span>
        <span class="s1">lb = np.array([-</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.8</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">0.8</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">3.0</span><span class="s1">])</span>

        <span class="s1">x = np.array([-</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">+ </span><span class="s2">1e-10</span><span class="s1">])</span>

        <span class="s1">x_new = make_strictly_feasible(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rstep=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(x_new[</span><span class="s2">0</span><span class="s1">] &gt; -</span><span class="s2">0.5</span><span class="s1">)</span>
        <span class="s1">assert_equal(x_new[</span><span class="s2">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[</span><span class="s2">1</span><span class="s1">:])</span>

        <span class="s1">x_new = make_strictly_feasible(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rstep=</span><span class="s2">1e-4</span><span class="s1">)</span>
        <span class="s1">assert_equal(x_new</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">0.5 </span><span class="s1">+ </span><span class="s2">1e-4</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">* (</span><span class="s2">1 </span><span class="s1">+ </span><span class="s2">1e-4</span><span class="s1">)])</span>

        <span class="s1">x = np.array([-</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3.1</span><span class="s1">])</span>
        <span class="s1">x_new = make_strictly_feasible(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_(np.all((x_new &gt;= lb) &amp; (x_new &lt;= ub)))</span>

        <span class="s1">x_new = make_strictly_feasible(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rstep=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(np.all((x_new &gt;= lb) &amp; (x_new &lt;= ub)))</span>

        <span class="s1">lb = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">100.0</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">100.0 </span><span class="s1">+ </span><span class="s2">1e-10</span><span class="s1">])</span>
        <span class="s1">x = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100.0</span><span class="s1">])</span>
        <span class="s1">x_new = make_strictly_feasible(x</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub</span><span class="s0">, </span><span class="s1">rstep=</span><span class="s2">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_equal(x_new</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">100.0 </span><span class="s1">+ </span><span class="s2">0.5e-10</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_scaling_vector(self):</span>
        <span class="s1">lb = np.array([-np.inf</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-np.inf])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s2">10.0</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">x = np.array([</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">g = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">v</span><span class="s0">, </span><span class="s1">dv = CL_scaling_vector(x</span><span class="s0">, </span><span class="s1">g</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">assert_equal(v</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">7.0</span><span class="s0">, </span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">assert_equal(dv</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">TestQuadraticFunction:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.J = np.array([</span>
            <span class="s1">[</span><span class="s2">0.1</span><span class="s0">, </span><span class="s2">0.2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[-</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.2</span><span class="s1">]])</span>
        <span class="s1">self.g = np.array([</span><span class="s2">0.8</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2.0</span><span class="s1">])</span>
        <span class="s1">self.diag = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_build_quadratic_1d(self):</span>
        <span class="s1">s = np.zeros(</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = build_quadratic_1d(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = build_quadratic_1d(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">diag=self.diag)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">s = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = build_quadratic_1d(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s2">2.05</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s2">2.8</span><span class="s1">)</span>

        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = build_quadratic_1d(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">diag=self.diag)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s2">3.55</span><span class="s1">)</span>
        <span class="s1">assert_equal(b</span><span class="s0">, </span><span class="s2">2.8</span><span class="s1">)</span>

        <span class="s1">s0 = np.array([</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0.5</span><span class="s1">])</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c = build_quadratic_1d(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">diag=self.diag</span><span class="s0">, </span><span class="s1">s0=s0)</span>
        <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s2">3.55</span><span class="s1">)</span>
        <span class="s1">assert_allclose(b</span><span class="s0">, </span><span class="s2">2.39</span><span class="s1">)</span>
        <span class="s1">assert_allclose(c</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.1525</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_minimize_quadratic_1d(self):</span>
        <span class="s1">a = </span><span class="s2">5</span>
        <span class="s1">b = -</span><span class="s2">1</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t**</span><span class="s2">2 </span><span class="s1">+ b * t</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t**</span><span class="s2">2 </span><span class="s1">+ b * t</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t**</span><span class="s2">2 </span><span class="s1">+ b * t</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">c = </span><span class="s2">10</span>
        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">c=c)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t**</span><span class="s2">2 </span><span class="s1">+ b * t + c</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">c=c)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t ** </span><span class="s2">2 </span><span class="s1">+ b * t + c</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">c=c)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t ** </span><span class="s2">2 </span><span class="s1">+ b * t + c</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">c=c)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(y</span><span class="s0">, </span><span class="s1">a * t ** </span><span class="s2">2 </span><span class="s1">+ b * t + c</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>

        <span class="s1">a = -</span><span class="s2">1</span>
        <span class="s1">b = </span><span class="s2">0.2</span>
        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(y</span><span class="s0">, </span><span class="s1">-np.inf)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(y</span><span class="s0">, </span><span class="s1">-np.inf)</span>

        <span class="s1">t</span><span class="s0">, </span><span class="s1">y = minimize_quadratic_1d(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(t</span><span class="s0">, </span><span class="s1">-np.inf)</span>
        <span class="s1">assert_equal(y</span><span class="s0">, </span><span class="s1">-np.inf)</span>

    <span class="s0">def </span><span class="s1">test_evaluate_quadratic(self):</span>
        <span class="s1">s = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s1">])</span>

        <span class="s1">value = evaluate_quadratic(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s)</span>
        <span class="s1">assert_equal(value</span><span class="s0">, </span><span class="s2">4.85</span><span class="s1">)</span>

        <span class="s1">value = evaluate_quadratic(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">diag=self.diag)</span>
        <span class="s1">assert_equal(value</span><span class="s0">, </span><span class="s2">6.35</span><span class="s1">)</span>

        <span class="s1">s = np.array([[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">[</span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]])</span>

        <span class="s1">values = evaluate_quadratic(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s)</span>
        <span class="s1">assert_allclose(values</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4.85</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.91</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>

        <span class="s1">values = evaluate_quadratic(self.J</span><span class="s0">, </span><span class="s1">self.g</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">diag=self.diag)</span>
        <span class="s1">assert_allclose(values</span><span class="s0">, </span><span class="s1">[</span><span class="s2">6.35</span><span class="s0">, </span><span class="s2">0.59</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">TestTrustRegion:</span>
    <span class="s0">def </span><span class="s1">test_intersect(self):</span>
        <span class="s1">Delta = </span><span class="s2">1.0</span>

        <span class="s1">x = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">s = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">t_neg</span><span class="s0">, </span><span class="s1">t_pos = intersect_trust_region(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">Delta)</span>
        <span class="s1">assert_equal(t_neg</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(t_pos</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>

        <span class="s1">s = np.array([-</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">t_neg</span><span class="s0">, </span><span class="s1">t_pos = intersect_trust_region(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">Delta)</span>
        <span class="s1">assert_allclose(t_neg</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">**-</span><span class="s2">0.5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(t_pos</span><span class="s0">, </span><span class="s2">3</span><span class="s1">**-</span><span class="s2">0.5</span><span class="s1">)</span>

        <span class="s1">x = np.array([</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.5</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">s = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">t_neg</span><span class="s0">, </span><span class="s1">t_pos = intersect_trust_region(x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">Delta)</span>
        <span class="s1">assert_allclose(t_neg</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">**-</span><span class="s2">0.5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(t_pos</span><span class="s0">, </span><span class="s2">2</span><span class="s1">**-</span><span class="s2">0.5</span><span class="s1">)</span>

        <span class="s1">x = np.ones(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">intersect_trust_region</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">Delta)</span>

        <span class="s1">x = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">s = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">intersect_trust_region</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">Delta)</span>


<span class="s0">def </span><span class="s1">test_reflective_transformation():</span>
    <span class="s1">lb = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">ub = np.array([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>

    <span class="s1">y = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">g = reflective_transformation(y</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
    <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_equal(g</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s2">2</span><span class="s1">))</span>

    <span class="s1">y = np.array([-</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">g = reflective_transformation(y</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">np.array([np.inf</span><span class="s0">, </span><span class="s1">np.inf]))</span>
    <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
    <span class="s1">assert_equal(g</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">g = reflective_transformation(y</span><span class="s0">, </span><span class="s1">np.array([-np.inf</span><span class="s0">, </span><span class="s1">-np.inf])</span><span class="s0">, </span><span class="s1">ub)</span>
    <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(g</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s1">x</span><span class="s0">, </span><span class="s1">g = reflective_transformation(y</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
    <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(g</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s1">lb = np.array([-np.inf</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">ub = np.array([</span><span class="s2">5</span><span class="s0">, </span><span class="s1">np.inf])</span>
    <span class="s1">y = np.array([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">g = reflective_transformation(y</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">ub)</span>
    <span class="s1">assert_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">assert_equal(g</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_linear_operators():</span>
    <span class="s1">A = np.arange(</span><span class="s2">6</span><span class="s1">).reshape((</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>

    <span class="s1">d_left = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">])</span>
    <span class="s1">DA = np.diag(d_left).dot(A)</span>
    <span class="s1">J_left = left_multiplied_operator(A</span><span class="s0">, </span><span class="s1">d_left)</span>

    <span class="s1">d_right = np.array([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">AD = A.dot(np.diag(d_right))</span>
    <span class="s1">J_right = right_multiplied_operator(A</span><span class="s0">, </span><span class="s1">d_right)</span>

    <span class="s1">x = np.array([-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
    <span class="s1">X = -</span><span class="s2">2 </span><span class="s1">* np.arange(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">8</span><span class="s1">).reshape((</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>
    <span class="s1">xt = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">15</span><span class="s1">])</span>

    <span class="s1">assert_allclose(DA.dot(x)</span><span class="s0">, </span><span class="s1">J_left.matvec(x))</span>
    <span class="s1">assert_allclose(DA.dot(X)</span><span class="s0">, </span><span class="s1">J_left.matmat(X))</span>
    <span class="s1">assert_allclose(DA.T.dot(xt)</span><span class="s0">, </span><span class="s1">J_left.rmatvec(xt))</span>

    <span class="s1">assert_allclose(AD.dot(x)</span><span class="s0">, </span><span class="s1">J_right.matvec(x))</span>
    <span class="s1">assert_allclose(AD.dot(X)</span><span class="s0">, </span><span class="s1">J_right.matmat(X))</span>
    <span class="s1">assert_allclose(AD.T.dot(xt)</span><span class="s0">, </span><span class="s1">J_right.rmatvec(xt))</span>
</pre>
</body>
</html>