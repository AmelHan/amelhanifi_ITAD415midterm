<html>
<head>
<title>test_hessian_update_strategy.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_hessian_update_strategy.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">copy </span><span class="s0">import </span><span class="s1">deepcopy</span>
<span class="s0">from </span><span class="s1">numpy.linalg </span><span class="s0">import </span><span class="s1">norm</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(TestCase</span><span class="s0">, </span><span class="s1">assert_array_almost_equal</span><span class="s0">,</span>
                           <span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_array_less)</span>
<span class="s0">from </span><span class="s1">scipy.optimize </span><span class="s0">import </span><span class="s1">(BFGS</span><span class="s0">, </span><span class="s1">SR1)</span>


<span class="s0">class </span><span class="s1">Rosenbrock:</span>
    <span class="s2">&quot;&quot;&quot;Rosenbrock function. 
 
    The following optimization problem: 
        minimize sum(100.0*(x[1:] - x[:-1]**2.0)**2.0 + (1 - x[:-1])**2.0) 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">n=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s1">rng = np.random.RandomState(random_state)</span>
        <span class="s1">self.x0 = rng.uniform(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">self.x_opt = np.ones(n)</span>

    <span class="s0">def </span><span class="s1">fun(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">x = np.asarray(x)</span>
        <span class="s1">r = np.sum(</span><span class="s3">100.0 </span><span class="s1">* (x[</span><span class="s3">1</span><span class="s1">:] - x[:-</span><span class="s3">1</span><span class="s1">]**</span><span class="s3">2.0</span><span class="s1">)**</span><span class="s3">2.0 </span><span class="s1">+ (</span><span class="s3">1 </span><span class="s1">- x[:-</span><span class="s3">1</span><span class="s1">])**</span><span class="s3">2.0</span><span class="s0">,</span>
                   <span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">r</span>

    <span class="s0">def </span><span class="s1">grad(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">x = np.asarray(x)</span>
        <span class="s1">xm = x[</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">xm_m1 = x[:-</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">xm_p1 = x[</span><span class="s3">2</span><span class="s1">:]</span>
        <span class="s1">der = np.zeros_like(x)</span>
        <span class="s1">der[</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">] = (</span><span class="s3">200 </span><span class="s1">* (xm - xm_m1**</span><span class="s3">2</span><span class="s1">) -</span>
                     <span class="s3">400 </span><span class="s1">* (xm_p1 - xm**</span><span class="s3">2</span><span class="s1">) * xm - </span><span class="s3">2 </span><span class="s1">* (</span><span class="s3">1 </span><span class="s1">- xm))</span>
        <span class="s1">der[</span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">400 </span><span class="s1">* x[</span><span class="s3">0</span><span class="s1">] * (x[</span><span class="s3">1</span><span class="s1">] - x[</span><span class="s3">0</span><span class="s1">]**</span><span class="s3">2</span><span class="s1">) - </span><span class="s3">2 </span><span class="s1">* (</span><span class="s3">1 </span><span class="s1">- x[</span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">der[-</span><span class="s3">1</span><span class="s1">] = </span><span class="s3">200 </span><span class="s1">* (x[-</span><span class="s3">1</span><span class="s1">] - x[-</span><span class="s3">2</span><span class="s1">]**</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">der</span>

    <span class="s0">def </span><span class="s1">hess(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">x = np.atleast_1d(x)</span>
        <span class="s1">H = np.diag(-</span><span class="s3">400 </span><span class="s1">* x[:-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) - np.diag(</span><span class="s3">400 </span><span class="s1">* x[:-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">diagonal = np.zeros(len(x)</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
        <span class="s1">diagonal[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">1200 </span><span class="s1">* x[</span><span class="s3">0</span><span class="s1">]**</span><span class="s3">2 </span><span class="s1">- </span><span class="s3">400 </span><span class="s1">* x[</span><span class="s3">1</span><span class="s1">] + </span><span class="s3">2</span>
        <span class="s1">diagonal[-</span><span class="s3">1</span><span class="s1">] = </span><span class="s3">200</span>
        <span class="s1">diagonal[</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">] = </span><span class="s3">202 </span><span class="s1">+ </span><span class="s3">1200 </span><span class="s1">* x[</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]**</span><span class="s3">2 </span><span class="s1">- </span><span class="s3">400 </span><span class="s1">* x[</span><span class="s3">2</span><span class="s1">:]</span>
        <span class="s1">H = H + np.diag(diagonal)</span>
        <span class="s0">return </span><span class="s1">H</span>


<span class="s0">class </span><span class="s1">TestHessianUpdateStrategy(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_hessian_initialization(self):</span>
        <span class="s1">quasi_newton = (BFGS()</span><span class="s0">, </span><span class="s1">SR1())</span>

        <span class="s0">for </span><span class="s1">qn </span><span class="s0">in </span><span class="s1">quasi_newton:</span>
            <span class="s1">qn.initialize(</span><span class="s3">5</span><span class="s0">, </span><span class="s4">'hess'</span><span class="s1">)</span>
            <span class="s1">B = qn.get_matrix()</span>

            <span class="s1">assert_array_equal(B</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">5</span><span class="s1">))</span>

    <span class="s5"># For this list of points, it is known</span>
    <span class="s5"># that no exception occur during the</span>
    <span class="s5"># Hessian update. Hence no update is</span>
    <span class="s5"># skiped or damped.</span>
    <span class="s0">def </span><span class="s1">test_rosenbrock_with_no_exception(self):</span>
        <span class="s5"># Define auxiliar problem</span>
        <span class="s1">prob = Rosenbrock(n=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s5"># Define iteration points</span>
        <span class="s1">x_list = [[</span><span class="s3">0.0976270</span><span class="s0">, </span><span class="s3">0.4303787</span><span class="s0">, </span><span class="s3">0.2055267</span><span class="s0">, </span><span class="s3">0.0897663</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.15269040</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1847239</span><span class="s0">, </span><span class="s3">0.0505757</span><span class="s0">, </span><span class="s3">0.2123832</span><span class="s0">, </span><span class="s3">0.0255081</span><span class="s0">, </span><span class="s3">0.00083286</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2142498</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0188480</span><span class="s0">, </span><span class="s3">0.0503822</span><span class="s0">, </span><span class="s3">0.0347033</span><span class="s0">, </span><span class="s3">0.03323606</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2071680</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0185071</span><span class="s0">, </span><span class="s3">0.0341337</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0139298</span><span class="s0">, </span><span class="s3">0.02881750</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1533055</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0322935</span><span class="s0">, </span><span class="s3">0.0280418</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0083592</span><span class="s0">, </span><span class="s3">0.01503699</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1382378</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0276671</span><span class="s0">, </span><span class="s3">0.0266161</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0074060</span><span class="s0">, </span><span class="s3">0.02801610</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1651957</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0049124</span><span class="s0">, </span><span class="s3">0.0269665</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0040025</span><span class="s0">, </span><span class="s3">0.02138184</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2354930</span><span class="s0">, </span><span class="s3">0.0443711</span><span class="s0">, </span><span class="s3">0.0173959</span><span class="s0">, </span><span class="s3">0.0041872</span><span class="s0">, </span><span class="s3">0.00794563</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.4168118</span><span class="s0">, </span><span class="s3">0.1433867</span><span class="s0">, </span><span class="s3">0.0111714</span><span class="s0">, </span><span class="s3">0.0126265</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00658537</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.4681972</span><span class="s0">, </span><span class="s3">0.2153273</span><span class="s0">, </span><span class="s3">0.0225249</span><span class="s0">, </span><span class="s3">0.0152704</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00463809</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.6023068</span><span class="s0">, </span><span class="s3">0.3346815</span><span class="s0">, </span><span class="s3">0.0731108</span><span class="s0">, </span><span class="s3">0.0186618</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00371541</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.6415743</span><span class="s0">, </span><span class="s3">0.3985468</span><span class="s0">, </span><span class="s3">0.1324422</span><span class="s0">, </span><span class="s3">0.0214160</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00062401</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.7503690</span><span class="s0">, </span><span class="s3">0.5447616</span><span class="s0">, </span><span class="s3">0.2804541</span><span class="s0">, </span><span class="s3">0.0539851</span><span class="s0">, </span><span class="s3">0.00242230</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.7452626</span><span class="s0">, </span><span class="s3">0.5644594</span><span class="s0">, </span><span class="s3">0.3324679</span><span class="s0">, </span><span class="s3">0.0865153</span><span class="s0">, </span><span class="s3">0.00454960</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8059782</span><span class="s0">, </span><span class="s3">0.6586838</span><span class="s0">, </span><span class="s3">0.4229577</span><span class="s0">, </span><span class="s3">0.1452990</span><span class="s0">, </span><span class="s3">0.00976702</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8549542</span><span class="s0">, </span><span class="s3">0.7226562</span><span class="s0">, </span><span class="s3">0.4991309</span><span class="s0">, </span><span class="s3">0.2420093</span><span class="s0">, </span><span class="s3">0.02772661</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8571332</span><span class="s0">, </span><span class="s3">0.7285741</span><span class="s0">, </span><span class="s3">0.5279076</span><span class="s0">, </span><span class="s3">0.2824549</span><span class="s0">, </span><span class="s3">0.06030276</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8835633</span><span class="s0">, </span><span class="s3">0.7727077</span><span class="s0">, </span><span class="s3">0.5957984</span><span class="s0">, </span><span class="s3">0.3411303</span><span class="s0">, </span><span class="s3">0.09652185</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9071558</span><span class="s0">, </span><span class="s3">0.8299587</span><span class="s0">, </span><span class="s3">0.6771400</span><span class="s0">, </span><span class="s3">0.4402896</span><span class="s0">, </span><span class="s3">0.17469338</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9190793</span><span class="s0">, </span><span class="s3">0.8486480</span><span class="s0">, </span><span class="s3">0.7163332</span><span class="s0">, </span><span class="s3">0.5083780</span><span class="s0">, </span><span class="s3">0.26107691</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9371223</span><span class="s0">, </span><span class="s3">0.8762177</span><span class="s0">, </span><span class="s3">0.7653702</span><span class="s0">, </span><span class="s3">0.5773109</span><span class="s0">, </span><span class="s3">0.32181041</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9554613</span><span class="s0">, </span><span class="s3">0.9119893</span><span class="s0">, </span><span class="s3">0.8282687</span><span class="s0">, </span><span class="s3">0.6776178</span><span class="s0">, </span><span class="s3">0.43162744</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9545744</span><span class="s0">, </span><span class="s3">0.9099264</span><span class="s0">, </span><span class="s3">0.8270244</span><span class="s0">, </span><span class="s3">0.6822220</span><span class="s0">, </span><span class="s3">0.45237623</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9688112</span><span class="s0">, </span><span class="s3">0.9351710</span><span class="s0">, </span><span class="s3">0.8730961</span><span class="s0">, </span><span class="s3">0.7546601</span><span class="s0">, </span><span class="s3">0.56622448</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9743227</span><span class="s0">, </span><span class="s3">0.9491953</span><span class="s0">, </span><span class="s3">0.9005150</span><span class="s0">, </span><span class="s3">0.8086497</span><span class="s0">, </span><span class="s3">0.64505437</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9807345</span><span class="s0">, </span><span class="s3">0.9638853</span><span class="s0">, </span><span class="s3">0.9283012</span><span class="s0">, </span><span class="s3">0.8631675</span><span class="s0">, </span><span class="s3">0.73812581</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9886746</span><span class="s0">, </span><span class="s3">0.9777760</span><span class="s0">, </span><span class="s3">0.9558950</span><span class="s0">, </span><span class="s3">0.9123417</span><span class="s0">, </span><span class="s3">0.82726553</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9899096</span><span class="s0">, </span><span class="s3">0.9803828</span><span class="s0">, </span><span class="s3">0.9615592</span><span class="s0">, </span><span class="s3">0.9255600</span><span class="s0">, </span><span class="s3">0.85822149</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9969510</span><span class="s0">, </span><span class="s3">0.9935441</span><span class="s0">, </span><span class="s3">0.9864657</span><span class="s0">, </span><span class="s3">0.9726775</span><span class="s0">, </span><span class="s3">0.94358663</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9979533</span><span class="s0">, </span><span class="s3">0.9960274</span><span class="s0">, </span><span class="s3">0.9921724</span><span class="s0">, </span><span class="s3">0.9837415</span><span class="s0">, </span><span class="s3">0.96626288</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9995981</span><span class="s0">, </span><span class="s3">0.9989171</span><span class="s0">, </span><span class="s3">0.9974178</span><span class="s0">, </span><span class="s3">0.9949954</span><span class="s0">, </span><span class="s3">0.99023356</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">1.0002640</span><span class="s0">, </span><span class="s3">1.0005088</span><span class="s0">, </span><span class="s3">1.0010594</span><span class="s0">, </span><span class="s3">1.0021161</span><span class="s0">, </span><span class="s3">1.00386912</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9998903</span><span class="s0">, </span><span class="s3">0.9998459</span><span class="s0">, </span><span class="s3">0.9997795</span><span class="s0">, </span><span class="s3">0.9995484</span><span class="s0">, </span><span class="s3">0.99916305</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">1.0000008</span><span class="s0">, </span><span class="s3">0.9999905</span><span class="s0">, </span><span class="s3">0.9999481</span><span class="s0">, </span><span class="s3">0.9998903</span><span class="s0">, </span><span class="s3">0.99978047</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">1.0000004</span><span class="s0">, </span><span class="s3">0.9999983</span><span class="s0">, </span><span class="s3">1.0000001</span><span class="s0">, </span><span class="s3">1.0000031</span><span class="s0">, </span><span class="s3">1.00000297</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9999995</span><span class="s0">, </span><span class="s3">1.0000003</span><span class="s0">, </span><span class="s3">1.0000005</span><span class="s0">, </span><span class="s3">1.0000001</span><span class="s0">, </span><span class="s3">1.00000032</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9999999</span><span class="s0">, </span><span class="s3">0.9999997</span><span class="s0">, </span><span class="s3">0.9999994</span><span class="s0">, </span><span class="s3">0.9999989</span><span class="s0">, </span><span class="s3">0.99999786</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9999999</span><span class="s0">, </span><span class="s3">0.9999999</span><span class="s0">, </span><span class="s3">0.9999999</span><span class="s0">, </span><span class="s3">0.9999999</span><span class="s0">, </span><span class="s3">0.99999991</span><span class="s1">]]</span>
        <span class="s5"># Get iteration points</span>
        <span class="s1">grad_list = [prob.grad(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">x_list]</span>
        <span class="s1">delta_x = [np.array(x_list[i+</span><span class="s3">1</span><span class="s1">])-np.array(x_list[i])</span>
                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">delta_grad = [grad_list[i+</span><span class="s3">1</span><span class="s1">]-grad_list[i]</span>
                      <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(grad_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s5"># Check curvature condition</span>
        <span class="s0">for </span><span class="s1">s</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip(delta_x</span><span class="s0">, </span><span class="s1">delta_grad):</span>
            <span class="s0">if </span><span class="s1">np.dot(s</span><span class="s0">, </span><span class="s1">y) &lt;= </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s0">raise </span><span class="s1">ArithmeticError()</span>
        <span class="s5"># Define QuasiNewton update</span>
        <span class="s0">for </span><span class="s1">quasi_newton </span><span class="s0">in </span><span class="s1">(BFGS(init_scale=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_curvature=</span><span class="s3">1e-4</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">SR1(init_scale=</span><span class="s3">1</span><span class="s1">)):</span>
            <span class="s1">hess = deepcopy(quasi_newton)</span>
            <span class="s1">inv_hess = deepcopy(quasi_newton)</span>
            <span class="s1">hess.initialize(len(x_list[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s4">'hess'</span><span class="s1">)</span>
            <span class="s1">inv_hess.initialize(len(x_list[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s4">'inv_hess'</span><span class="s1">)</span>
            <span class="s5"># Compare the hessian and its inverse</span>
            <span class="s0">for </span><span class="s1">s</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">zip(delta_x</span><span class="s0">, </span><span class="s1">delta_grad):</span>
                <span class="s1">hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
                <span class="s1">inv_hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
                <span class="s1">B = hess.get_matrix()</span>
                <span class="s1">H = inv_hess.get_matrix()</span>
                <span class="s1">assert_array_almost_equal(np.linalg.inv(B)</span><span class="s0">, </span><span class="s1">H</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">10</span><span class="s1">)</span>
            <span class="s1">B_true = prob.hess(x_list[len(delta_x)])</span>
            <span class="s1">assert_array_less(norm(B - B_true)/norm(B_true)</span><span class="s0">, </span><span class="s3">0.1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_SR1_skip_update(self):</span>
        <span class="s5"># Define auxiliary problem</span>
        <span class="s1">prob = Rosenbrock(n=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s5"># Define iteration points</span>
        <span class="s1">x_list = [[</span><span class="s3">0.0976270</span><span class="s0">, </span><span class="s3">0.4303787</span><span class="s0">, </span><span class="s3">0.2055267</span><span class="s0">, </span><span class="s3">0.0897663</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.15269040</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1847239</span><span class="s0">, </span><span class="s3">0.0505757</span><span class="s0">, </span><span class="s3">0.2123832</span><span class="s0">, </span><span class="s3">0.0255081</span><span class="s0">, </span><span class="s3">0.00083286</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2142498</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0188480</span><span class="s0">, </span><span class="s3">0.0503822</span><span class="s0">, </span><span class="s3">0.0347033</span><span class="s0">, </span><span class="s3">0.03323606</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2071680</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0185071</span><span class="s0">, </span><span class="s3">0.0341337</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0139298</span><span class="s0">, </span><span class="s3">0.02881750</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1533055</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0322935</span><span class="s0">, </span><span class="s3">0.0280418</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0083592</span><span class="s0">, </span><span class="s3">0.01503699</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1382378</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0276671</span><span class="s0">, </span><span class="s3">0.0266161</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0074060</span><span class="s0">, </span><span class="s3">0.02801610</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1651957</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0049124</span><span class="s0">, </span><span class="s3">0.0269665</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0040025</span><span class="s0">, </span><span class="s3">0.02138184</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2354930</span><span class="s0">, </span><span class="s3">0.0443711</span><span class="s0">, </span><span class="s3">0.0173959</span><span class="s0">, </span><span class="s3">0.0041872</span><span class="s0">, </span><span class="s3">0.00794563</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.4168118</span><span class="s0">, </span><span class="s3">0.1433867</span><span class="s0">, </span><span class="s3">0.0111714</span><span class="s0">, </span><span class="s3">0.0126265</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00658537</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.4681972</span><span class="s0">, </span><span class="s3">0.2153273</span><span class="s0">, </span><span class="s3">0.0225249</span><span class="s0">, </span><span class="s3">0.0152704</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00463809</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.6023068</span><span class="s0">, </span><span class="s3">0.3346815</span><span class="s0">, </span><span class="s3">0.0731108</span><span class="s0">, </span><span class="s3">0.0186618</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00371541</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.6415743</span><span class="s0">, </span><span class="s3">0.3985468</span><span class="s0">, </span><span class="s3">0.1324422</span><span class="s0">, </span><span class="s3">0.0214160</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.00062401</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.7503690</span><span class="s0">, </span><span class="s3">0.5447616</span><span class="s0">, </span><span class="s3">0.2804541</span><span class="s0">, </span><span class="s3">0.0539851</span><span class="s0">, </span><span class="s3">0.00242230</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.7452626</span><span class="s0">, </span><span class="s3">0.5644594</span><span class="s0">, </span><span class="s3">0.3324679</span><span class="s0">, </span><span class="s3">0.0865153</span><span class="s0">, </span><span class="s3">0.00454960</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8059782</span><span class="s0">, </span><span class="s3">0.6586838</span><span class="s0">, </span><span class="s3">0.4229577</span><span class="s0">, </span><span class="s3">0.1452990</span><span class="s0">, </span><span class="s3">0.00976702</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8549542</span><span class="s0">, </span><span class="s3">0.7226562</span><span class="s0">, </span><span class="s3">0.4991309</span><span class="s0">, </span><span class="s3">0.2420093</span><span class="s0">, </span><span class="s3">0.02772661</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8571332</span><span class="s0">, </span><span class="s3">0.7285741</span><span class="s0">, </span><span class="s3">0.5279076</span><span class="s0">, </span><span class="s3">0.2824549</span><span class="s0">, </span><span class="s3">0.06030276</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.8835633</span><span class="s0">, </span><span class="s3">0.7727077</span><span class="s0">, </span><span class="s3">0.5957984</span><span class="s0">, </span><span class="s3">0.3411303</span><span class="s0">, </span><span class="s3">0.09652185</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.9071558</span><span class="s0">, </span><span class="s3">0.8299587</span><span class="s0">, </span><span class="s3">0.6771400</span><span class="s0">, </span><span class="s3">0.4402896</span><span class="s0">, </span><span class="s3">0.17469338</span><span class="s1">]]</span>
        <span class="s5"># Get iteration points</span>
        <span class="s1">grad_list = [prob.grad(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">x_list]</span>
        <span class="s1">delta_x = [np.array(x_list[i+</span><span class="s3">1</span><span class="s1">])-np.array(x_list[i])</span>
                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">delta_grad = [grad_list[i+</span><span class="s3">1</span><span class="s1">]-grad_list[i]</span>
                      <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(grad_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">hess = SR1(init_scale=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_denominator=</span><span class="s3">1e-2</span><span class="s1">)</span>
        <span class="s1">hess.initialize(len(x_list[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s4">'hess'</span><span class="s1">)</span>
        <span class="s5"># Compare the Hessian and its inverse</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(delta_x)-</span><span class="s3">1</span><span class="s1">):</span>
            <span class="s1">s = delta_x[i]</span>
            <span class="s1">y = delta_grad[i]</span>
            <span class="s1">hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s5"># Test skip update</span>
        <span class="s1">B = np.copy(hess.get_matrix())</span>
        <span class="s1">s = delta_x[</span><span class="s3">17</span><span class="s1">]</span>
        <span class="s1">y = delta_grad[</span><span class="s3">17</span><span class="s1">]</span>
        <span class="s1">hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s1">B_updated = np.copy(hess.get_matrix())</span>
        <span class="s1">assert_array_equal(B</span><span class="s0">, </span><span class="s1">B_updated)</span>

    <span class="s0">def </span><span class="s1">test_BFGS_skip_update(self):</span>
        <span class="s5"># Define auxiliar problem</span>
        <span class="s1">prob = Rosenbrock(n=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s5"># Define iteration points</span>
        <span class="s1">x_list = [[</span><span class="s3">0.0976270</span><span class="s0">, </span><span class="s3">0.4303787</span><span class="s0">, </span><span class="s3">0.2055267</span><span class="s0">, </span><span class="s3">0.0897663</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.15269040</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1847239</span><span class="s0">, </span><span class="s3">0.0505757</span><span class="s0">, </span><span class="s3">0.2123832</span><span class="s0">, </span><span class="s3">0.0255081</span><span class="s0">, </span><span class="s3">0.00083286</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2142498</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0188480</span><span class="s0">, </span><span class="s3">0.0503822</span><span class="s0">, </span><span class="s3">0.0347033</span><span class="s0">, </span><span class="s3">0.03323606</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.2071680</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0185071</span><span class="s0">, </span><span class="s3">0.0341337</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0139298</span><span class="s0">, </span><span class="s3">0.02881750</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1533055</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0322935</span><span class="s0">, </span><span class="s3">0.0280418</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0083592</span><span class="s0">, </span><span class="s3">0.01503699</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1382378</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0276671</span><span class="s0">, </span><span class="s3">0.0266161</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0074060</span><span class="s0">, </span><span class="s3">0.02801610</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0.1651957</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0049124</span><span class="s0">, </span><span class="s3">0.0269665</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0040025</span><span class="s0">, </span><span class="s3">0.02138184</span><span class="s1">]]</span>
        <span class="s5"># Get iteration points</span>
        <span class="s1">grad_list = [prob.grad(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">x_list]</span>
        <span class="s1">delta_x = [np.array(x_list[i+</span><span class="s3">1</span><span class="s1">])-np.array(x_list[i])</span>
                   <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">delta_grad = [grad_list[i+</span><span class="s3">1</span><span class="s1">]-grad_list[i]</span>
                      <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(grad_list)-</span><span class="s3">1</span><span class="s1">)]</span>
        <span class="s1">hess = BFGS(init_scale=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">min_curvature=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">hess.initialize(len(x_list[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s4">'hess'</span><span class="s1">)</span>
        <span class="s5"># Compare the Hessian and its inverse</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(delta_x)-</span><span class="s3">1</span><span class="s1">):</span>
            <span class="s1">s = delta_x[i]</span>
            <span class="s1">y = delta_grad[i]</span>
            <span class="s1">hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s5"># Test skip update</span>
        <span class="s1">B = np.copy(hess.get_matrix())</span>
        <span class="s1">s = delta_x[</span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">y = delta_grad[</span><span class="s3">5</span><span class="s1">]</span>
        <span class="s1">hess.update(s</span><span class="s0">, </span><span class="s1">y)</span>
        <span class="s1">B_updated = np.copy(hess.get_matrix())</span>
        <span class="s1">assert_array_equal(B</span><span class="s0">, </span><span class="s1">B_updated)</span>
</pre>
</body>
</html>