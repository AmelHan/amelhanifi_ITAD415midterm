<html>
<head>
<title>test_rates_poisson.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #a9b7c6;}
.s1 { color: #cc7832;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_rates_poisson.py</font>
</center></td></tr></table>
<pre>

<span class="s1">import </span><span class="s0">pytest</span>
<span class="s1">import </span><span class="s0">warnings</span>
<span class="s1">import </span><span class="s0">numpy </span><span class="s1">as </span><span class="s0">np</span>
<span class="s1">from </span><span class="s0">numpy </span><span class="s1">import </span><span class="s0">arange</span>
<span class="s1">from </span><span class="s0">numpy.testing </span><span class="s1">import </span><span class="s0">assert_allclose</span><span class="s1">, </span><span class="s0">assert_equal</span>
<span class="s1">from </span><span class="s0">scipy </span><span class="s1">import </span><span class="s0">stats</span>

<span class="s2"># we cannot import test_poisson_2indep directly, pytest treats that as test</span>
<span class="s1">import </span><span class="s0">statsmodels.stats.rates </span><span class="s1">as </span><span class="s0">smr</span>
<span class="s1">from </span><span class="s0">statsmodels.stats.rates </span><span class="s1">import </span><span class="s0">(</span>
    <span class="s2"># test_poisson, # cannot import functions that start with test</span>
    <span class="s0">confint_poisson</span><span class="s1">,</span>
    <span class="s0">tolerance_int_poisson</span><span class="s1">,</span>
    <span class="s0">confint_quantile_poisson</span><span class="s1">,</span>
    <span class="s0">etest_poisson_2indep</span><span class="s1">,</span>
    <span class="s0">confint_poisson_2indep</span><span class="s1">,</span>
    <span class="s0">nonequivalence_poisson_2indep</span><span class="s1">,</span>
    <span class="s0">power_poisson_ratio_2indep</span><span class="s1">,</span>
    <span class="s0">power_equivalence_poisson_2indep</span><span class="s1">,</span>
    <span class="s0">power_poisson_diff_2indep</span><span class="s1">,</span>
    <span class="s0">power_equivalence_neginb_2indep</span><span class="s1">,</span>
    <span class="s0">power_negbin_ratio_2indep</span><span class="s1">,</span>
    <span class="s0">method_names_poisson_1samp</span><span class="s1">,</span>
    <span class="s0">method_names_poisson_2indep</span><span class="s1">,</span>
    <span class="s0">)</span>

<span class="s0">methods = [</span><span class="s3">&quot;wald&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s3">&quot;exact-c&quot;</span><span class="s1">, </span><span class="s3">&quot;waldccv&quot;</span><span class="s1">, </span><span class="s3">&quot;sqrt-a&quot;</span><span class="s1">, </span><span class="s3">&quot;sqrt-v&quot;</span><span class="s1">, </span><span class="s3">&quot;midp-c&quot;</span><span class="s1">,</span>
           <span class="s3">&quot;sqrt&quot;</span><span class="s1">,</span>
           <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s1">, </span><span class="s0">methods)</span>
<span class="s1">def </span><span class="s0">test_rate_poisson_consistency(method):</span>
    <span class="s2"># check consistency between test and confint for one poisson rate</span>
    <span class="s0">count</span><span class="s1">, </span><span class="s0">nobs = </span><span class="s4">15</span><span class="s1">, </span><span class="s4">400</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=method)</span>
    <span class="s0">pv1 = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">method=method).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">method=method).pvalue</span>

    <span class="s0">rtol = </span><span class="s4">1e-10</span>
    <span class="s1">if </span><span class="s0">method </span><span class="s1">in </span><span class="s0">[</span><span class="s3">&quot;midp-c&quot;</span><span class="s0">]:</span>
        <span class="s2"># numerical root finding, lower precision</span>
        <span class="s0">rtol = </span><span class="s4">1e-6</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>

    <span class="s2"># check one-sided, note all confint are central</span>
    <span class="s0">pv1 = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">method=method</span><span class="s1">,</span>
                           <span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">method=method</span><span class="s1">,</span>
                           <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">).pvalue</span>

    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>


<span class="s1">def </span><span class="s0">test_rate_poisson_r():</span>
    <span class="s0">count</span><span class="s1">, </span><span class="s0">nobs = </span><span class="s4">15</span><span class="s1">, </span><span class="s4">400</span>

    <span class="s2"># DescTools</span>
    <span class="s2"># PoissonCI(x=15, n=400, method = c(&quot;exact&quot;,&quot;score&quot;, &quot;wald&quot;, &quot;byar&quot;))</span>
    <span class="s2"># exact 0.0375 0.0209884653319583 0.0618505471787146</span>
    <span class="s2"># score 0.0375 0.0227264749053794 0.0618771721463559</span>
    <span class="s2"># wald  0.0375 0.0185227303217751 0.0564772696782249</span>
    <span class="s2"># byar  0.0375 0.0219084369245707 0.0602933510943048</span>

    <span class="s2"># &gt; rr = poisson.exact(15, 400, r=0.05, tsmethod=&quot;central&quot;)</span>
    <span class="s2"># &gt; rr$p.value</span>
    <span class="s2"># &gt; rr$conf.int</span>
    <span class="s0">pv2 = </span><span class="s4">0.313026269279486</span>
    <span class="s0">ci2 = (</span><span class="s4">0.0209884653319583</span><span class="s1">, </span><span class="s4">0.0618505471787146</span><span class="s0">)</span>
    <span class="s0">rt = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;exact-c&quot;</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;exact-c&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rt.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>

    <span class="s2"># R package ratesci</span>
    <span class="s2"># sr = scoreci(15, 400, contrast=&quot;p&quot;, distrib = &quot;poi&quot;, skew=FALSE,</span>
    <span class="s2">#      theta0=0.05)</span>
    <span class="s2"># pval computed from 2 * min(pval_left, pval_right)</span>
    <span class="s0">pv2 = </span><span class="s4">0.263552477282973</span>
    <span class="s2"># ci2 = (0.022726, 0.061877)  # no additional digits available</span>
    <span class="s0">ci2 = (</span><span class="s4">0.0227264749053794</span><span class="s1">, </span><span class="s4">0.0618771721463559</span><span class="s0">)  </span><span class="s2"># from DescTools</span>
    <span class="s0">rt = smr.test_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">value=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;score&quot;</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;score&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rt.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>

    <span class="s2"># &gt; jeffreysci(15, 400, distrib = &quot;poi&quot;)</span>
    <span class="s0">ci2 = (</span><span class="s4">0.0219234232268444</span><span class="s1">, </span><span class="s4">0.0602898619930649</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;jeff&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>

    <span class="s2"># from DescTools</span>
    <span class="s0">ci2 = (</span><span class="s4">0.0185227303217751</span><span class="s1">, </span><span class="s4">0.0564772696782249</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;wald&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>

    <span class="s2"># from ratesci</span>
    <span class="s2"># rateci(15, 400, distrib = &quot;poi&quot;)</span>
    <span class="s2"># I think their lower ci is wrong, it also doesn't match for exact_c</span>
    <span class="s0">ci2 = (</span><span class="s4">0.0243357599260795</span><span class="s1">, </span><span class="s4">0.0604627555786095</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson(count</span><span class="s1">, </span><span class="s0">nobs</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">&quot;midp-c&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">ci2[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-5</span><span class="s0">)</span>


<span class="s0">cases_tolint = [</span>
    <span class="s0">(</span><span class="s3">&quot;wald&quot;</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s0">(</span><span class="s4">3</span><span class="s1">, </span><span class="s4">32</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">3</span><span class="s1">, </span><span class="s0">np.inf)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">31</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s0">(</span><span class="s4">4</span><span class="s1">, </span><span class="s4">35</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">4</span><span class="s1">, </span><span class="s0">np.inf)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">33</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;wald&quot;</span><span class="s1">, </span><span class="s4">150</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s0">(</span><span class="s4">104</span><span class="s1">, </span><span class="s4">200</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">108</span><span class="s1">, </span><span class="s0">np.inf)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">196</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s4">150</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s0">(</span><span class="s4">106</span><span class="s1">, </span><span class="s4">202</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">109</span><span class="s1">, </span><span class="s0">np.inf)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">198</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;exact-c&quot;</span><span class="s1">, </span><span class="s4">150</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s0">(</span><span class="s4">105</span><span class="s1">, </span><span class="s4">202</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">109</span><span class="s1">, </span><span class="s0">np.inf)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">0</span><span class="s1">, </span><span class="s4">198</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'case'</span><span class="s1">, </span><span class="s0">cases_tolint)</span>
<span class="s1">def </span><span class="s0">test_tol_int(case):</span>
    <span class="s2"># results values are from R package `tolerance, e.g.</span>
    <span class="s2"># poistol.int(15, 1, m = 1, alpha = 0.05, P = 0.975, side = 1, method=&quot;LS&quot;)</span>
    <span class="s2"># poistol.int(150, 100, m = 100, alpha = 0.05, P = 0.95, side = 2,</span>
    <span class="s2">#     method=&quot;SC&quot;)</span>
    <span class="s2"># exact-c is method=&quot;TAB&quot;</span>

    <span class="s0">prob = </span><span class="s4">0.95</span>
    <span class="s0">prob_one = </span><span class="s4">0.975</span>
    <span class="s0">meth</span><span class="s1">, </span><span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">exposure_new</span><span class="s1">, </span><span class="s0">r2</span><span class="s1">, </span><span class="s0">rs</span><span class="s1">, </span><span class="s0">rl = case</span>
    <span class="s0">ti = tolerance_int_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
    <span class="s0">assert_equal(ti</span><span class="s1">, </span><span class="s0">r2)</span>
    <span class="s0">ti = tolerance_int_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_one</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>
    <span class="s0">assert_equal(ti</span><span class="s1">, </span><span class="s0">rl)</span>
    <span class="s0">ti = tolerance_int_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_one</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">)</span>
    <span class="s0">assert_equal(ti</span><span class="s1">, </span><span class="s0">rs)</span>

    <span class="s2"># check without parameter uncertainty, confint at alpha=1</span>
    <span class="s1">if </span><span class="s0">meth </span><span class="s1">not in </span><span class="s0">[</span><span class="s3">&quot;exact-c&quot;</span><span class="s0">]:</span>
        <span class="s2"># confint for &quot;exact-c&quot; does not collapse to point if alpha=1, check</span>
        <span class="s0">ti = tolerance_int_poisson(</span>
            <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
            <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.99999</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
        <span class="s0">ci = stats.poisson.interval(prob</span><span class="s1">, </span><span class="s0">count / exposure * exposure_new)</span>
        <span class="s0">assert_equal(ti</span><span class="s1">, </span><span class="s0">ci)</span>

    <span class="s2"># check confint_quantile_poisson,</span>
    <span class="s2"># should same as upper tol_int</span>
    <span class="s0">ciq = confint_quantile_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_one</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>

    <span class="s0">assert_equal(ciq[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">r2[</span><span class="s4">1</span><span class="s0">])</span>

    <span class="s0">ciq = confint_quantile_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_one</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>

    <span class="s0">assert_equal(ciq[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">rl[</span><span class="s4">1</span><span class="s0">])</span>

    <span class="s2"># should same as lower tol_int</span>
    <span class="s0">prob_low = </span><span class="s4">0.025</span>
    <span class="s0">ciq = confint_quantile_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_low</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>

    <span class="s0">assert_equal(ciq[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">r2[</span><span class="s4">0</span><span class="s0">])</span>

    <span class="s0">ciq = confint_quantile_poisson(</span>
        <span class="s0">count</span><span class="s1">, </span><span class="s0">exposure</span><span class="s1">, </span><span class="s0">prob_low</span><span class="s1">, </span><span class="s0">exposure_new=exposure_new</span><span class="s1">,</span>
        <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">)</span>

    <span class="s0">assert_equal(ciq[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">rs[</span><span class="s4">0</span><span class="s0">])</span>


<span class="s1">class </span><span class="s0">TestMethodsCompar1samp():</span>
    <span class="s2"># check that all methods for test and confint produce similar results</span>

    <span class="s0">@pytest.mark.parametrize(</span><span class="s3">'meth'</span><span class="s1">, </span><span class="s0">method_names_poisson_1samp[</span><span class="s3">&quot;test&quot;</span><span class="s0">])</span>
    <span class="s1">def </span><span class="s0">test_test(self</span><span class="s1">, </span><span class="s0">meth):</span>
        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">514.775</span>
        <span class="s0">tst = smr.test_poisson(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">, </span><span class="s0">value=</span><span class="s4">0.1</span><span class="s1">,</span>
                               <span class="s0">alternative=</span><span class="s3">'two-sided'</span><span class="s0">)</span>

        <span class="s0">assert_allclose(tst.pvalue</span><span class="s1">, </span><span class="s4">0.25</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0.1</span><span class="s0">)</span>

    <span class="s0">@pytest.mark.parametrize(</span><span class="s3">'meth'</span><span class="s1">, </span><span class="s0">method_names_poisson_1samp[</span><span class="s3">&quot;confint&quot;</span><span class="s0">])</span>
    <span class="s1">def </span><span class="s0">test_confint(self</span><span class="s1">, </span><span class="s0">meth):</span>
        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">514.775</span>
        <span class="s0">ci = confint_poisson(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s0">)</span>
        <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">[</span><span class="s4">0.089</span><span class="s1">, </span><span class="s4">0.158</span><span class="s0">]</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0.1</span><span class="s0">)</span>


<span class="s2"># ######## below are 2indep tests</span>


<span class="s0">methods_diff = [</span><span class="s3">&quot;wald&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s3">&quot;waldccv&quot;</span><span class="s1">,</span>
                <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s1">, </span><span class="s0">methods_diff)</span>
<span class="s1">def </span><span class="s0">test_rate_poisson_diff_consistency(method):</span>
    <span class="s2"># check consistency between test and confint for diff of poisson rates</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">30</span><span class="s1">, </span><span class="s4">400 </span><span class="s0">/ </span><span class="s4">10</span><span class="s1">, </span><span class="s4">7</span><span class="s1">, </span><span class="s4">300 </span><span class="s0">/ </span><span class="s4">10   </span><span class="s2"># avoid low=0</span>
    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=method</span><span class="s1">,</span>
                                <span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s0">)</span>
    <span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s0">).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s0">).pvalue</span>

    <span class="s0">rtol = </span><span class="s4">1e-10</span>
    <span class="s1">if </span><span class="s0">method </span><span class="s1">in </span><span class="s0">[</span><span class="s3">&quot;score&quot;</span><span class="s0">]:</span>
        <span class="s2"># numerical root finding, lower precision</span>
        <span class="s0">rtol = </span><span class="s4">1e-6</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>

    <span class="s2"># check one-sided, note all confint are central</span>
    <span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">,</span>
                                  <span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s1">,</span>
                                  <span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">,</span>
                                  <span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s1">,</span>
                                  <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">).pvalue</span>

    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>


<span class="s0">methods_ratio = [</span><span class="s3">&quot;wald-log&quot;</span><span class="s1">, </span><span class="s3">&quot;score-log&quot;</span><span class="s1">,  </span><span class="s2"># &quot;waldccv&quot;,</span>
                 <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s1">, </span><span class="s0">methods_ratio)</span>
<span class="s1">def </span><span class="s0">test_rate_poisson_ratio_consistency(method):</span>
    <span class="s0">compare = </span><span class="s3">&quot;ratio&quot;</span>
    <span class="s2"># check consistency between test and confint for ratio of poisson rates</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">30</span><span class="s1">, </span><span class="s4">400 </span><span class="s0">/ </span><span class="s4">10</span><span class="s1">, </span><span class="s4">7</span><span class="s1">, </span><span class="s4">300 </span><span class="s0">/ </span><span class="s4">10   </span><span class="s2"># avoid low=0</span>
    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=method</span><span class="s1">,</span>
                                <span class="s0">compare=compare)</span>
    <span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=compare).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=compare).pvalue</span>

    <span class="s0">rtol = </span><span class="s4">1e-10</span>
    <span class="s1">if </span><span class="s0">method </span><span class="s1">in </span><span class="s0">[</span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s3">&quot;score-log&quot;</span><span class="s0">]:</span>
        <span class="s2"># numerical root finding, lower precision</span>
        <span class="s0">rtol = </span><span class="s4">1e-6</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>

    <span class="s2"># check one-sided, note all confint are central</span>
    <span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">,</span>
                                  <span class="s0">compare=compare</span><span class="s1">,</span>
                                  <span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">).pvalue</span>
    <span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">value=ci[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">,</span>
                                  <span class="s0">method=method</span><span class="s1">,</span>
                                  <span class="s0">compare=compare</span><span class="s1">,</span>
                                  <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">).pvalue</span>

    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>


<span class="s0">methods_diff_ratio = [</span><span class="s3">&quot;wald&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s3">&quot;etest&quot;</span><span class="s1">, </span><span class="s3">&quot;etest-wald&quot;</span><span class="s1">,</span>
                      <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s1">, </span><span class="s0">methods_diff_ratio)</span>
<span class="s1">def </span><span class="s0">test_rate_poisson_diff_ratio_consistency(method):</span>
    <span class="s2"># check consistency between test for rate and diff for equality null</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">30</span><span class="s1">, </span><span class="s4">400 </span><span class="s0">/ </span><span class="s4">10</span><span class="s1">, </span><span class="s4">7</span><span class="s1">, </span><span class="s4">300 </span><span class="s0">/ </span><span class="s4">10   </span><span class="s2"># avoid low=0</span>
    <span class="s0">t1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;ratio&quot;</span><span class="s0">)</span>
    <span class="s0">t2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s0">)</span>

    <span class="s0">assert_allclose(t1.tuple</span><span class="s1">, </span><span class="s0">t2.tuple</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>

    <span class="s0">t1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;ratio&quot;</span><span class="s1">,</span>
                                 <span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>
    <span class="s0">t2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s1">,</span>
                                 <span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>

    <span class="s0">assert_allclose(t1.tuple</span><span class="s1">, </span><span class="s0">t2.tuple</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>

    <span class="s0">t1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;ratio&quot;</span><span class="s1">,</span>
                                 <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">)</span>
    <span class="s0">t2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                 <span class="s0">method=method</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">&quot;diff&quot;</span><span class="s1">,</span>
                                 <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">)</span>

    <span class="s0">assert_allclose(t1.tuple</span><span class="s1">, </span><span class="s0">t2.tuple</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_twosample_poisson():</span>
    <span class="s2"># testing against two examples in Gu et al</span>

    <span class="s2"># example 1</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span>

    <span class="s0">s1</span><span class="s1">, </span><span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'wald'</span><span class="s0">)</span>
    <span class="s0">pv1r = </span><span class="s4">0.000356</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s0">pv1r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s1</span><span class="s1">, </span><span class="s4">3.384913</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'score'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000316</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">3.417402</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'wald-log'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000420</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">3.3393</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'score-log'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000200</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">3.5406</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'sqrt'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000285</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">3.445485</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s2"># two-sided</span>
    <span class="s2"># example2</span>
    <span class="s2"># I don't know why it's only 2.5 decimal agreement, rounding?</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">41</span><span class="s1">, </span><span class="s4">28010</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">19017</span>
    <span class="s0">s1</span><span class="s1">, </span><span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'wald'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s0">)</span>
    <span class="s0">pv1r = </span><span class="s4">0.2309</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s0">pv1r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s1</span><span class="s1">, </span><span class="s4">0.735447</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'score'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2398</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">0.706631</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'wald-log'</span><span class="s1">, </span><span class="s0">value=</span><span class="s4">1.5</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2402</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">0.7056</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s1">with </span><span class="s0">pytest.warns(FutureWarning):</span>
        <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                          <span class="s0">method=</span><span class="s3">'score-log'</span><span class="s1">, </span><span class="s0">ratio_null=</span><span class="s4">1.5</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2303</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">0.7380</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'sqrt'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2499</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r*</span><span class="s4">2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-3</span><span class="s0">)</span>
    <span class="s0">assert_allclose(s2</span><span class="s1">, </span><span class="s4">0.674401</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-6</span><span class="s0">)  </span><span class="s2"># regression test</span>

    <span class="s2"># one-sided</span>
    <span class="s2"># example 1 onesided</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span>

    <span class="s0">s1</span><span class="s1">, </span><span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'wald'</span><span class="s1">,</span>
                                      <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv1r = </span><span class="s4">0.000356</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s0">pv1r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'score'</span><span class="s1">,</span>
                                      <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000316</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'sqrt'</span><span class="s1">,</span>
                                      <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000285</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s2"># 'exact-cond', 'cond-midp'</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'exact-cond'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000428  </span><span class="s2"># typo in Gu et al, switched pvalues between C and M</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'cond-midp'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.000310</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pve1 = etest_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                   <span class="s0">method=</span><span class="s3">'score'</span><span class="s1">,</span>
                                   <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pve1r = </span><span class="s4">0.000298</span>
    <span class="s0">assert_allclose(pve1</span><span class="s1">, </span><span class="s0">pve1r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pve1 = etest_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                   <span class="s0">method=</span><span class="s3">'wald'</span><span class="s1">,</span>
                                   <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pve1r = </span><span class="s4">0.000298</span>
    <span class="s0">assert_allclose(pve1</span><span class="s1">, </span><span class="s0">pve1r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s2"># example2 onesided</span>
    <span class="s2"># I don't know why it's only 2.5 decimal agreement, rounding?</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">41</span><span class="s1">, </span><span class="s4">28010</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">19017</span>
    <span class="s0">s1</span><span class="s1">, </span><span class="s0">pv1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'wald'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv1r = </span><span class="s4">0.2309</span>
    <span class="s0">assert_allclose(pv1</span><span class="s1">, </span><span class="s0">pv1r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'score'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2398</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'sqrt'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2499</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s2"># 'exact-cond', 'cond-midp'</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'exact-cond'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2913</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">s2</span><span class="s1">, </span><span class="s0">pv2 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                      <span class="s0">method=</span><span class="s3">'cond-midp'</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pv2r = </span><span class="s4">0.2450</span>
    <span class="s0">assert_allclose(pv2</span><span class="s1">, </span><span class="s0">pv2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pve2 = etest_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                   <span class="s0">method=</span><span class="s3">'score'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pve2r = </span><span class="s4">0.2453</span>
    <span class="s0">assert_allclose(pve2</span><span class="s1">, </span><span class="s0">pve2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pve2 = etest_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">,</span>
                                   <span class="s0">method=</span><span class="s3">'wald'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.5</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">pve2r = </span><span class="s4">0.2453</span>
    <span class="s0">assert_allclose(pve2</span><span class="s1">, </span><span class="s0">pve2r</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-4</span><span class="s0">)</span>


<span class="s0">cases_diff_ng = [</span>
    <span class="s0">(</span><span class="s3">&quot;wald&quot;</span><span class="s1">,  </span><span class="s0">(</span><span class="s4">2.2047</span><span class="s1">, </span><span class="s4">0.0137</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">1.5514</span><span class="s1">, </span><span class="s4">0.06040</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;score&quot;</span><span class="s1">, </span><span class="s0">(</span><span class="s4">2.0818</span><span class="s1">, </span><span class="s4">0.0187</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">1.5023</span><span class="s1">, </span><span class="s4">0.06651</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;etest-wald&quot;</span><span class="s1">,  </span><span class="s0">(</span><span class="s4">2.2047</span><span class="s1">, </span><span class="s4">0.0184</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">1.5514</span><span class="s1">, </span><span class="s4">0.06626</span><span class="s0">))</span><span class="s1">,</span>
    <span class="s2"># Ng reports 0.07088 at value=0.0002, looks strange</span>
    <span class="s0">(</span><span class="s3">&quot;etest-score&quot;</span><span class="s1">, </span><span class="s0">(</span><span class="s4">2.0818</span><span class="s1">, </span><span class="s4">0.0179</span><span class="s0">)</span><span class="s1">, </span><span class="s0">(</span><span class="s4">1.5023</span><span class="s1">, </span><span class="s4">0.06626</span><span class="s0">))</span><span class="s1">,  </span><span class="s2"># 0.07088)),</span>
    <span class="s0">]</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'case'</span><span class="s1">, </span><span class="s0">cases_diff_ng)</span>
<span class="s1">def </span><span class="s0">test_twosample_poisson_diff(case):</span>
    <span class="s2"># testing against two examples Ng et al 2007</span>
    <span class="s2"># methods_diff = [&quot;wald&quot;, &quot;score&quot;, &quot;etest-wald&quot;, &quot;etest&quot;]</span>

    <span class="s0">meth</span><span class="s1">, </span><span class="s0">res1</span><span class="s1">, </span><span class="s0">res2 = case</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2 = </span><span class="s4">41</span><span class="s1">, </span><span class="s4">28010</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">19017</span>

    <span class="s0">value = </span><span class="s4">0</span>
    <span class="s0">t = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">value=value</span><span class="s1">,</span>
                                <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">,</span>
                                <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s1">, </span><span class="s0">etest_kwds=</span><span class="s1">None</span><span class="s0">)</span>
    <span class="s0">assert_allclose((t.statistic</span><span class="s1">, </span><span class="s0">t.pvalue)</span><span class="s1">, </span><span class="s0">res1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.0006</span><span class="s0">)</span>

    <span class="s0">value = </span><span class="s4">0.0002</span>
    <span class="s0">t = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">value=value</span><span class="s1">,</span>
                                <span class="s0">method=meth</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">,</span>
                                <span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s1">, </span><span class="s0">etest_kwds=</span><span class="s1">None</span><span class="s0">)</span>
    <span class="s0">assert_allclose((t.statistic</span><span class="s1">, </span><span class="s0">t.pvalue)</span><span class="s1">, </span><span class="s0">res2</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.0007</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_twosample_poisson_r():</span>
    <span class="s2"># testing against R package `exactci</span>
    <span class="s1">from </span><span class="s0">.results.results_rates </span><span class="s1">import </span><span class="s0">res_pexact_cond</span><span class="s1">, </span><span class="s0">res_pexact_cond_midp</span>

    <span class="s2"># example 1 from Gu</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span>

    <span class="s0">res2 = res_pexact_cond</span>
    <span class="s0">res1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'exact-cond'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(res1.pvalue</span><span class="s1">, </span><span class="s0">res2.p_value</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>
    <span class="s0">assert_allclose(res1.ratio</span><span class="s1">, </span><span class="s0">res2.estimate</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>
    <span class="s0">assert_equal(res1.ratio_null</span><span class="s1">, </span><span class="s0">res2.null_value)</span>

    <span class="s0">res2 = res_pexact_cond_midp</span>
    <span class="s0">res1 = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'cond-midp'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(res1.pvalue</span><span class="s1">, </span><span class="s0">res2.p_value</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>
    <span class="s0">assert_allclose(res1.ratio</span><span class="s1">, </span><span class="s0">res2.estimate</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>
    <span class="s0">assert_equal(res1.ratio_null</span><span class="s1">, </span><span class="s0">res2.null_value)</span>

    <span class="s2"># one-sided</span>
    <span class="s2"># &gt; pe = poisson.exact(c(60, 30), c(51477.5, 54308.7), r=1.2,</span>
    <span class="s2">#                      alternative=&quot;less&quot;, tsmethod=&quot;minlike&quot;, midp=TRUE)</span>
    <span class="s2"># &gt; pe$p.value</span>
    <span class="s0">pv2 = </span><span class="s4">0.9949053964701466</span>
    <span class="s0">rest = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'cond-midp'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.2</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'smaller'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rest.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s2"># &gt; pe = poisson.exact(c(60, 30), c(51477.5, 54308.7), r=1.2,</span>
    <span class="s2">#           alternative=&quot;greater&quot;, tsmethod=&quot;minlike&quot;, midp=TRUE)</span>
    <span class="s2"># &gt; pe$p.value</span>
    <span class="s0">pv2 = </span><span class="s4">0.005094603529853279</span>
    <span class="s0">rest = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'cond-midp'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.2</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rest.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s2"># &gt; pe = poisson.exact(c(60, 30), c(51477.5, 54308.7), r=1.2,</span>
    <span class="s2">#           alternative=&quot;greater&quot;, tsmethod=&quot;minlike&quot;, midp=FALSE)</span>
    <span class="s2"># &gt; pe$p.value</span>
    <span class="s0">pv2 = </span><span class="s4">0.006651774552714537</span>
    <span class="s0">rest = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'exact-cond'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.2</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rest.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s2"># &gt; pe = poisson.exact(c(60, 30), c(51477.5, 54308.7), r=1.2,</span>
    <span class="s2">#                      alternative=&quot;less&quot;, tsmethod=&quot;minlike&quot;, midp=FALSE)</span>
    <span class="s2"># &gt; pe$p.value</span>
    <span class="s0">pv2 = </span><span class="s4">0.9964625674930079</span>
    <span class="s0">rest = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=</span><span class="s3">'exact-cond'</span><span class="s1">,</span>
                                   <span class="s0">value=</span><span class="s4">1.2</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'smaller'</span><span class="s0">)</span>
    <span class="s0">assert_allclose(rest.pvalue</span><span class="s1">, </span><span class="s0">pv2</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_confint_poisson_2indep():</span>
    <span class="s2"># test other confint methods</span>

    <span class="s0">count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span>

    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'mover'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'ratio'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.1</span><span class="s1">,</span>
                                <span class="s0">method_mover=</span><span class="s3">&quot;jeff&quot;</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s0">ci1 = (</span><span class="s4">1.4667</span><span class="s1">, </span><span class="s4">3.0608</span><span class="s0">)  </span><span class="s2"># LTW 2014</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.05</span><span class="s0">)</span>
    <span class="s2"># moverci(60, 51477.5, 30, 54308.7, type = &quot;jeff&quot;, distrib=&quot;poi&quot;,</span>
    <span class="s2"># contrast=&quot;RR&quot;, cc=0, level=0.9)</span>
    <span class="s2">#   Lower Estimate    Upper</span>
    <span class="s2"># est 1.466768 2.104135 3.058634</span>
    <span class="s2"># ratesci uses different center for mover-jeffreys</span>
    <span class="s0">ci1 = (</span><span class="s4">1.466768</span><span class="s1">, </span><span class="s4">3.058634</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0.001</span><span class="s0">)</span>

    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'mover'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'ratio'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.1</span><span class="s1">,</span>
                                <span class="s0">method_mover=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s0">ci1 = (</span><span class="s4">1.4611</span><span class="s1">, </span><span class="s4">3.0424</span><span class="s0">)  </span><span class="s2"># LTW 2014</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.05</span><span class="s0">)</span>

    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'waldcc'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'ratio'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.1</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s0">ci1 = (</span><span class="s4">1.4523</span><span class="s1">, </span><span class="s4">3.0154</span><span class="s0">)  </span><span class="s2"># LTW 2014</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.0005</span><span class="s0">)</span>

    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'score'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'ratio'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s0">ci1 = (</span><span class="s4">1.365962</span><span class="s1">, </span><span class="s4">3.259306</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s2"># with diff</span>
    <span class="s2"># use larger rates for diff</span>
    <span class="s0">exposure1 /= </span><span class="s4">1000</span>
    <span class="s0">exposure2 /= </span><span class="s4">1000</span>
    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'mover'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
                                <span class="s0">method_mover=</span><span class="s3">&quot;jeff&quot;</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s2"># moverci(60, 51477.5/1000, 30, 54308.7/1000, type = &quot;jeff&quot;, distrib=&quot;poi&quot;,</span>
    <span class="s2"># contrast=&quot;RD&quot;, cc=0, level=0.95)</span>
    <span class="s0">ci1 = (</span><span class="s4">0.2629322</span><span class="s1">, </span><span class="s4">0.9786493</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.005</span><span class="s0">)</span>
    <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'score'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s2"># scoreci(60, 51477.5/1000, 30, 54308.7/1000, distrib=&quot;poi&quot;, contrast=&quot;RD&quot;,</span>
    <span class="s2"># skew=FALSE, cc=0, level=0.95)</span>
    <span class="s0">ci1 = (</span><span class="s4">0.265796</span><span class="s1">, </span><span class="s4">0.989192</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-6</span><span class="s0">)</span>

    <span class="s2"># example in Li et al 2011, scaled</span>
    <span class="s0">ci = confint_poisson_2indep(count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">, </span><span class="s0">count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'mover'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.1</span><span class="s1">,</span>
                                <span class="s0">method_mover=</span><span class="s3">&quot;jeff&quot;</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s2"># moverci(30, 54308.7/1000, 60, 51477.5/1000, type = &quot;jeff&quot;, distrib=&quot;poi&quot;,</span>
    <span class="s2"># contrast=&quot;RD&quot;, cc=0, level=0.90)</span>
    <span class="s0">ci1 = (-</span><span class="s4">0.9183272231752</span><span class="s1">, </span><span class="s0">-</span><span class="s4">0.3188611692202</span><span class="s0">)</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.005</span><span class="s0">)</span>
    <span class="s0">ci1 = (-</span><span class="s4">0.9195</span><span class="s1">, </span><span class="s0">-</span><span class="s4">0.3193</span><span class="s0">)  </span><span class="s2"># from Li et al 2011</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.005</span><span class="s0">)</span>

    <span class="s0">ci = confint_poisson_2indep(count2</span><span class="s1">, </span><span class="s0">exposure2</span><span class="s1">, </span><span class="s0">count1</span><span class="s1">, </span><span class="s0">exposure1</span><span class="s1">,</span>
                                <span class="s0">method=</span><span class="s3">'mover'</span><span class="s1">, </span><span class="s0">compare=</span><span class="s3">'diff'</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.1</span><span class="s1">,</span>
                                <span class="s0">method_mover=</span><span class="s3">&quot;jeff&quot;</span><span class="s1">,</span>
                                <span class="s0">)</span>
    <span class="s2"># scoreci(30, 54308.7/1000, 60, 51477.5/1000, distrib=&quot;poi&quot;, contrast=&quot;RD&quot;,</span>
    <span class="s2"># skew=FALSE, cc=0, level=0.90)</span>
    <span class="s0">ci1 = (-</span><span class="s4">0.9232</span><span class="s1">, </span><span class="s0">-</span><span class="s4">0.3188</span><span class="s0">)  </span><span class="s2"># from Li et al 2011</span>
    <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.006</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_tost_poisson():</span>

    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span>
    <span class="s2"># # central conf_int from R exactci</span>
    <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">1.339735721772650</span><span class="s1">, </span><span class="s4">3.388365573616252</span>

    <span class="s0">res = smr.tost_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                  <span class="s0">method=</span><span class="s3">&quot;exact-cond&quot;</span><span class="s0">)</span>

    <span class="s0">assert_allclose(res.pvalue</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
    <span class="s0">methods = [</span><span class="s3">'wald'</span><span class="s1">, </span><span class="s3">'score'</span><span class="s1">, </span><span class="s3">'sqrt'</span><span class="s1">, </span><span class="s3">'exact-cond'</span><span class="s1">, </span><span class="s3">'cond-midp'</span><span class="s0">]</span>

    <span class="s2"># test that we are in the correct range for other methods</span>
    <span class="s1">for </span><span class="s0">meth </span><span class="s1">in </span><span class="s0">methods:</span>
        <span class="s0">res = smr.tost_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                      <span class="s0">method=meth)</span>
        <span class="s0">assert_allclose(res.pvalue</span><span class="s1">, </span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">0.01</span><span class="s0">)</span>


<span class="s0">cases_alt = {</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;wald&quot;</span><span class="s0">): </span><span class="s4">0.07136366497984171</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s0">): </span><span class="s4">0.0840167525117227</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;sqrt&quot;</span><span class="s0">): </span><span class="s4">0.0804675114297235</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;exact-cond&quot;</span><span class="s0">): </span><span class="s4">0.1301269270479679</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;cond-midp&quot;</span><span class="s0">): </span><span class="s4">0.09324590196774807</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;etest&quot;</span><span class="s0">): </span><span class="s4">0.09054824785458056</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">, </span><span class="s3">&quot;etest-wald&quot;</span><span class="s0">): </span><span class="s4">0.06895289560607239</span><span class="s1">,</span>

    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;wald&quot;</span><span class="s0">): </span><span class="s4">0.03568183248992086</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s0">): </span><span class="s4">0.04200837625586135</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;sqrt&quot;</span><span class="s0">): </span><span class="s4">0.04023375571486175</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;exact-cond&quot;</span><span class="s0">): </span><span class="s4">0.08570447732927276</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;cond-midp&quot;</span><span class="s0">): </span><span class="s4">0.04882345224905293</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;etest&quot;</span><span class="s0">): </span><span class="s4">0.043751060642682936</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;larger&quot;</span><span class="s1">, </span><span class="s3">&quot;etest-wald&quot;</span><span class="s0">): </span><span class="s4">0.043751050280207024</span><span class="s1">,</span>

    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;wald&quot;</span><span class="s0">): </span><span class="s4">0.9643181675100791</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;score&quot;</span><span class="s0">): </span><span class="s4">0.9579916237441386</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;sqrt&quot;</span><span class="s0">): </span><span class="s4">0.9597662442851382</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;exact-cond&quot;</span><span class="s0">): </span><span class="s4">0.9880575728311669</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;cond-midp&quot;</span><span class="s0">): </span><span class="s4">0.9511765477509471</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;etest&quot;</span><span class="s0">): </span><span class="s4">0.9672396898656999</span><span class="s1">,</span>
    <span class="s0">(</span><span class="s3">&quot;smaller&quot;</span><span class="s1">, </span><span class="s3">&quot;etest-wald&quot;</span><span class="s0">): </span><span class="s4">0.9672397002281757</span>
    <span class="s0">}</span>


<span class="s0">@pytest.mark.parametrize(</span><span class="s3">'case'</span><span class="s1">, </span><span class="s0">list(cases_alt.keys()))</span>
<span class="s1">def </span><span class="s0">test_alternative(case):</span>
    <span class="s2"># regression test numbers, but those are close to each other</span>
    <span class="s0">alt</span><span class="s1">, </span><span class="s0">meth = case</span>
    <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">6</span><span class="s1">, </span><span class="s4">51.</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">54.</span>
    <span class="s0">_</span><span class="s1">, </span><span class="s0">pv = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">,</span>
                                    <span class="s0">value=</span><span class="s4">1.2</span><span class="s1">, </span><span class="s0">alternative=alt)</span>
    <span class="s0">assert_allclose(pv</span><span class="s1">, </span><span class="s0">cases_alt[case]</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>


<span class="s1">class </span><span class="s0">TestMethodsCompare2indep():</span>
    <span class="s2"># check that all methods for test and confint produce similar results</span>

    <span class="s0">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;compare, meth&quot;</span><span class="s1">,</span>
        <span class="s0">[(</span><span class="s3">&quot;ratio&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;test&quot;</span><span class="s0">][</span><span class="s3">&quot;ratio&quot;</span><span class="s0">]] +</span>
        <span class="s0">[(</span><span class="s3">&quot;diff&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;test&quot;</span><span class="s0">][</span><span class="s3">&quot;diff&quot;</span><span class="s0">]]</span>
        <span class="s0">)</span>
    <span class="s1">def </span><span class="s0">test_test(self</span><span class="s1">, </span><span class="s0">meth</span><span class="s1">, </span><span class="s0">compare):</span>
        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">514.775</span><span class="s1">, </span><span class="s4">40</span><span class="s1">, </span><span class="s4">543.0870000</span>
        <span class="s0">tst = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">,</span>
                                      <span class="s0">compare=compare</span><span class="s1">,</span>
                                      <span class="s0">value=</span><span class="s1">None, </span><span class="s0">alternative=</span><span class="s3">'two-sided'</span><span class="s0">)</span>

        <span class="s0">assert_allclose(tst.pvalue</span><span class="s1">, </span><span class="s4">0.0245</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0.2</span><span class="s0">)</span>

        <span class="s2"># compare with degenerate interval for nonequivalence</span>
        <span class="s1">if </span><span class="s0">compare == </span><span class="s3">&quot;ratio&quot;</span><span class="s0">:</span>
            <span class="s0">f = </span><span class="s4">1.00</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">1 </span><span class="s0">/ f</span><span class="s1">, </span><span class="s0">f</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">v = </span><span class="s4">0.00</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = -v</span><span class="s1">, </span><span class="s0">v</span>

        <span class="s0">tst2 = nonequivalence_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                             <span class="s0">method=meth</span><span class="s1">,</span>
                                             <span class="s0">compare=compare)</span>
        <span class="s1">if </span><span class="s3">&quot;cond&quot; </span><span class="s1">in </span><span class="s0">meth </span><span class="s1">or </span><span class="s3">&quot;etest&quot; </span><span class="s1">in </span><span class="s0">meth:</span>
            <span class="s2"># comparison is not exact for noncentral methods</span>
            <span class="s0">rtol = </span><span class="s4">0.1</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">rtol = </span><span class="s4">1e-12</span>
        <span class="s0">assert_allclose(tst2.pvalue</span><span class="s1">, </span><span class="s0">tst.pvalue</span><span class="s1">, </span><span class="s0">rtol=rtol)</span>

        <span class="s2"># check corner case count2 = 0, see issue #8313</span>
        <span class="s1">with </span><span class="s0">pytest.warns(RuntimeWarning):</span>
            <span class="s0">tst = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s4">0</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">,</span>
                                          <span class="s0">compare=compare</span><span class="s1">,</span>
                                          <span class="s0">value=</span><span class="s1">None, </span><span class="s0">alternative=</span><span class="s3">'two-sided'</span><span class="s0">)</span>

    <span class="s0">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;compare, meth&quot;</span><span class="s1">,</span>
        <span class="s0">[(</span><span class="s3">&quot;ratio&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;confint&quot;</span><span class="s0">][</span><span class="s3">&quot;ratio&quot;</span><span class="s0">]] +</span>
        <span class="s0">[(</span><span class="s3">&quot;diff&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;confint&quot;</span><span class="s0">][</span><span class="s3">&quot;diff&quot;</span><span class="s0">]]</span>
        <span class="s0">)</span>
    <span class="s1">def </span><span class="s0">test_confint(self</span><span class="s1">, </span><span class="s0">meth</span><span class="s1">, </span><span class="s0">compare):</span>
        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">514.775</span><span class="s1">, </span><span class="s4">40</span><span class="s1">, </span><span class="s4">543.0870000</span>
        <span class="s1">if </span><span class="s0">compare == </span><span class="s3">&quot;ratio&quot;</span><span class="s0">:</span>
            <span class="s0">ci_val = [</span><span class="s4">1.04</span><span class="s1">, </span><span class="s4">2.34</span><span class="s0">]</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">ci_val = [</span><span class="s4">0.0057</span><span class="s1">, </span><span class="s4">0.081</span><span class="s0">]</span>

        <span class="s0">ci = confint_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">,</span>
                                    <span class="s0">compare=compare</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s0">)</span>
        <span class="s0">assert_allclose(ci</span><span class="s1">, </span><span class="s0">ci_val</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">0.1</span><span class="s0">)</span>

    <span class="s0">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;compare, meth&quot;</span><span class="s1">,</span>
        <span class="s0">[(</span><span class="s3">&quot;ratio&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;test&quot;</span><span class="s0">][</span><span class="s3">&quot;ratio&quot;</span><span class="s0">]] +</span>
        <span class="s0">[(</span><span class="s3">&quot;diff&quot;</span><span class="s1">, </span><span class="s0">meth) </span><span class="s1">for </span><span class="s0">meth</span>
         <span class="s1">in </span><span class="s0">method_names_poisson_2indep[</span><span class="s3">&quot;test&quot;</span><span class="s0">][</span><span class="s3">&quot;diff&quot;</span><span class="s0">]]</span>
        <span class="s0">)</span>
    <span class="s1">def </span><span class="s0">test_test_vectorized(self</span><span class="s1">, </span><span class="s0">meth</span><span class="s1">, </span><span class="s0">compare):</span>
        <span class="s1">if </span><span class="s3">&quot;etest&quot; </span><span class="s1">in </span><span class="s0">meth:</span>
            <span class="s0">pytest.skip(</span><span class="s3">&quot;nonequivalence etest not vectorized&quot;</span><span class="s0">)</span>

        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = </span><span class="s4">60</span><span class="s1">, </span><span class="s4">514.775</span><span class="s1">, </span><span class="s4">40</span><span class="s1">, </span><span class="s4">543.0870000</span>
        <span class="s0">count1v = np.array([count1</span><span class="s1">, </span><span class="s0">count2])</span>
        <span class="s0">n1v = np.array([n1</span><span class="s1">, </span><span class="s0">n2])</span>
        <span class="s0">nfact = </span><span class="s4">1.</span>
        <span class="s2"># scipy binom test requires int dtype</span>
        <span class="s0">count2v = np.array([count2</span><span class="s1">, </span><span class="s0">count1 * nfact]</span><span class="s1">, </span><span class="s0">dtype=int)</span>
        <span class="s0">n2v = np.array([n2</span><span class="s1">, </span><span class="s0">n1 * nfact])</span>
        <span class="s0">count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2 = count1v</span><span class="s1">, </span><span class="s0">n1v</span><span class="s1">, </span><span class="s0">count2v</span><span class="s1">, </span><span class="s0">n2v</span>

        <span class="s2"># compare with degenerate interval for nonequivalence</span>
        <span class="s1">if </span><span class="s0">compare == </span><span class="s3">&quot;ratio&quot;</span><span class="s0">:</span>
            <span class="s0">f = </span><span class="s4">1.00</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">1 </span><span class="s0">/ f</span><span class="s1">, </span><span class="s0">f</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">v = </span><span class="s4">0.00</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = -v</span><span class="s1">, </span><span class="s0">v</span>

        <span class="s0">tst2 = nonequivalence_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                             <span class="s0">method=meth</span><span class="s1">,</span>
                                             <span class="s0">compare=compare)</span>
        <span class="s1">assert </span><span class="s0">tst2.statistic.shape == (</span><span class="s4">2</span><span class="s1">,</span><span class="s0">)</span>
        <span class="s1">assert </span><span class="s0">tst2.pvalue.shape == (</span><span class="s4">2</span><span class="s1">,</span><span class="s0">)</span>

        <span class="s1">if not </span><span class="s0">(</span><span class="s3">&quot;cond&quot; </span><span class="s1">in </span><span class="s0">meth </span><span class="s1">or </span><span class="s3">&quot;etest&quot; </span><span class="s1">in </span><span class="s0">meth):</span>
            <span class="s2"># not all methods are vectorized for smr.test_poisson_2indep</span>
            <span class="s0">tst = smr.test_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">method=meth</span><span class="s1">,</span>
                                          <span class="s0">compare=compare</span><span class="s1">,</span>
                                          <span class="s0">value=</span><span class="s1">None, </span><span class="s0">alternative=</span><span class="s3">'two-sided'</span><span class="s0">)</span>

            <span class="s0">assert_allclose(tst2.pvalue</span><span class="s1">, </span><span class="s0">tst.pvalue</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>

        <span class="s2"># check vectorized equivalence test</span>
        <span class="s1">if </span><span class="s0">compare == </span><span class="s3">&quot;ratio&quot;</span><span class="s0">:</span>
            <span class="s0">f = </span><span class="s4">1.5</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">1 </span><span class="s0">/ f</span><span class="s1">, </span><span class="s0">f</span>
        <span class="s1">else</span><span class="s0">:</span>
            <span class="s0">v = </span><span class="s4">0.5</span>
            <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = -v</span><span class="s1">, </span><span class="s0">v</span>

        <span class="s0">tst0 = smr.tost_poisson_2indep(count1[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">n1[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">count2[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">n2[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">,</span>
                                       <span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                       <span class="s0">method=meth</span><span class="s1">,</span>
                                       <span class="s0">compare=compare)</span>
        <span class="s0">tst1 = smr.tost_poisson_2indep(count1[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">n1[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">count2[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">n2[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">,</span>
                                       <span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                       <span class="s0">method=meth</span><span class="s1">,</span>
                                       <span class="s0">compare=compare)</span>

        <span class="s0">tst2 = smr.tost_poisson_2indep(count1</span><span class="s1">, </span><span class="s0">n1</span><span class="s1">, </span><span class="s0">count2</span><span class="s1">, </span><span class="s0">n2</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
                                       <span class="s0">method=meth</span><span class="s1">,</span>
                                       <span class="s0">compare=compare)</span>
        <span class="s1">assert </span><span class="s0">tst2.statistic.shape == (</span><span class="s4">2</span><span class="s1">,</span><span class="s0">)</span>
        <span class="s1">assert </span><span class="s0">tst2.pvalue.shape == (</span><span class="s4">2</span><span class="s1">,</span><span class="s0">)</span>

        <span class="s0">assert_allclose(tst2.statistic[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">tst0.statistic</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
        <span class="s0">assert_allclose(tst2.pvalue[</span><span class="s4">0</span><span class="s0">]</span><span class="s1">, </span><span class="s0">tst0.pvalue</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
        <span class="s0">assert_allclose(tst2.statistic[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">tst1.statistic</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>
        <span class="s0">assert_allclose(tst2.pvalue[</span><span class="s4">1</span><span class="s0">]</span><span class="s1">, </span><span class="s0">tst1.pvalue</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-12</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_y_grid_regression():</span>
    <span class="s0">y_grid = arange(</span><span class="s4">1000</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pv = etest_poisson_2indep(</span><span class="s4">60</span><span class="s1">, </span><span class="s4">51477.5</span><span class="s1">, </span><span class="s4">30</span><span class="s1">, </span><span class="s4">54308.7</span><span class="s1">, </span><span class="s0">y_grid=y_grid)</span>
    <span class="s0">assert_allclose(pv</span><span class="s1">, </span><span class="s4">0.000567261758250953</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">1e-15</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pv = etest_poisson_2indep(</span><span class="s4">41</span><span class="s1">, </span><span class="s4">28010</span><span class="s1">, </span><span class="s4">15</span><span class="s1">, </span><span class="s4">19017</span><span class="s1">, </span><span class="s0">y_grid=y_grid)</span>
    <span class="s0">assert_allclose(pv</span><span class="s1">, </span><span class="s4">0.03782053187021494</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">1e-15</span><span class="s0">)</span>

    <span class="s0">_</span><span class="s1">, </span><span class="s0">pv = etest_poisson_2indep(</span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s0">y_grid=[</span><span class="s4">1</span><span class="s0">])</span>
    <span class="s0">assert_allclose(pv</span><span class="s1">, </span><span class="s4">0.1353352832366127</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">1e-15</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_invalid_y_grid():</span>
    <span class="s2"># check ygrid deprecation</span>
    <span class="s0">warnings.simplefilter(</span><span class="s3">&quot;always&quot;</span><span class="s0">)</span>
    <span class="s1">with </span><span class="s0">warnings.catch_warnings(record=</span><span class="s1">True</span><span class="s0">) </span><span class="s1">as </span><span class="s0">w:</span>
        <span class="s0">etest_poisson_2indep(</span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s0">ygrid=[</span><span class="s4">1</span><span class="s0">])</span>
    <span class="s1">assert </span><span class="s0">len(w) == </span><span class="s4">1</span>
    <span class="s1">assert </span><span class="s0">issubclass(w[</span><span class="s4">0</span><span class="s0">].category</span><span class="s1">, </span><span class="s0">FutureWarning)</span>
    <span class="s1">assert </span><span class="s3">&quot;ygrid&quot; </span><span class="s1">in </span><span class="s0">str(w[</span><span class="s4">0</span><span class="s0">].message)</span>

    <span class="s2"># check y_grid validity</span>
    <span class="s1">with </span><span class="s0">pytest.raises(ValueError) </span><span class="s1">as </span><span class="s0">e:</span>
        <span class="s0">etest_poisson_2indep(</span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s4">1</span><span class="s1">, </span><span class="s0">y_grid=</span><span class="s4">1</span><span class="s0">)</span>
    <span class="s1">assert </span><span class="s3">&quot;y_grid&quot; </span><span class="s1">in </span><span class="s0">str(e.value)</span>


<span class="s1">def </span><span class="s0">test_poisson_power_2ratio():</span>
    <span class="s2"># power compared to PASS documentation</span>

    <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2 = </span><span class="s4">2.2</span><span class="s1">, </span><span class="s4">2.2</span>
    <span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2 = </span><span class="s4">95</span><span class="s1">, </span><span class="s4">95</span>
    <span class="s2"># nobs_ratio = 1</span>
    <span class="s0">alpha = </span><span class="s4">0.025</span>
    <span class="s0">exposure = </span><span class="s4">2.5</span>
    <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">0.8</span><span class="s1">, </span><span class="s4">1.25</span>
    <span class="s0">dispersion = </span><span class="s4">1</span>

    <span class="s2"># check power of equivalence test</span>
    <span class="s0">cases = [</span>
        <span class="s0">(</span><span class="s4">1.9</span><span class="s1">, </span><span class="s4">704</span><span class="s1">, </span><span class="s4">704</span><span class="s1">, </span><span class="s4">0.90012</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.0</span><span class="s1">, </span><span class="s4">246</span><span class="s1">, </span><span class="s4">246</span><span class="s1">, </span><span class="s4">0.90057</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.2</span><span class="s1">, </span><span class="s4">95</span><span class="s1">, </span><span class="s4">95</span><span class="s1">, </span><span class="s4">0.90039</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.5</span><span class="s1">, </span><span class="s4">396</span><span class="s1">, </span><span class="s4">396</span><span class="s1">, </span><span class="s4">0.90045</span><span class="s0">)</span><span class="s1">,</span>
    <span class="s0">]</span>

    <span class="s1">for </span><span class="s0">case </span><span class="s1">in </span><span class="s0">cases:</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">, </span><span class="s0">p = case</span>
        <span class="s0">pow_ = power_equivalence_poisson_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
            <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">alpha=alpha</span><span class="s1">,</span>
            <span class="s0">dispersion=dispersion)</span>
        <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

        <span class="s2"># compare other method_var for similar results</span>
        <span class="s0">pow_2 = power_equivalence_poisson_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
            <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">,</span>
            <span class="s0">alpha=alpha</span><span class="s1">,</span>
            <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
            <span class="s0">dispersion=dispersion)</span>

        <span class="s0">assert_allclose(pow_2</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-3</span><span class="s0">)</span>

    <span class="s2"># check power of onesided test, smaller with a margin</span>
    <span class="s2"># non-inferiority</span>
    <span class="s2"># alternative smaller H1: rate1 / rate2 &lt; R</span>
    <span class="s0">cases = [</span>
        <span class="s0">(</span><span class="s4">1.8</span><span class="s1">, </span><span class="s4">29</span><span class="s1">, </span><span class="s4">29</span><span class="s1">, </span><span class="s4">0.90056</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">1.9</span><span class="s1">, </span><span class="s4">39</span><span class="s1">, </span><span class="s4">39</span><span class="s1">, </span><span class="s4">0.90649</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.2</span><span class="s1">, </span><span class="s4">115</span><span class="s1">, </span><span class="s4">115</span><span class="s1">, </span><span class="s4">0.90014</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.4</span><span class="s1">, </span><span class="s4">404</span><span class="s1">, </span><span class="s4">404</span><span class="s1">, </span><span class="s4">0.90064</span><span class="s0">)</span><span class="s1">,</span>
    <span class="s0">]</span>

    <span class="s0">low = </span><span class="s4">1.2</span>
    <span class="s1">for </span><span class="s0">case </span><span class="s1">in </span><span class="s0">cases:</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">, </span><span class="s0">p = case</span>
        <span class="s0">pow_ = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.025</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">,</span>
            <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s0">)</span>

        <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

        <span class="s0">pow_ = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
            <span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
        <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s2"># check size, power at null</span>
    <span class="s0">pow_ = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=rate1 / rate2</span><span class="s1">,</span>
            <span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s2"># check power of onesided test, larger with a margin (superiority)</span>
    <span class="s2"># alternative larger H1: rate1 / rate2 &gt; R</span>
    <span class="s2"># here I just reverse the case of smaller alternative</span>

    <span class="s0">cases = [</span>
        <span class="s0">(</span><span class="s4">1.8</span><span class="s1">, </span><span class="s4">29</span><span class="s1">, </span><span class="s4">29</span><span class="s1">, </span><span class="s4">0.90056</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">1.9</span><span class="s1">, </span><span class="s4">39</span><span class="s1">, </span><span class="s4">39</span><span class="s1">, </span><span class="s4">0.90649</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.2</span><span class="s1">, </span><span class="s4">115</span><span class="s1">, </span><span class="s4">115</span><span class="s1">, </span><span class="s4">0.90014</span><span class="s0">)</span><span class="s1">,</span>
        <span class="s0">(</span><span class="s4">2.4</span><span class="s1">, </span><span class="s4">404</span><span class="s1">, </span><span class="s4">404</span><span class="s1">, </span><span class="s4">0.90064</span><span class="s0">)</span><span class="s1">,</span>
    <span class="s0">]</span>

    <span class="s0">rate1 = </span><span class="s4">2.2</span>
    <span class="s0">low = </span><span class="s4">1 </span><span class="s0">/ </span><span class="s4">1.2</span>
    <span class="s1">for </span><span class="s0">case </span><span class="s1">in </span><span class="s0">cases:</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">, </span><span class="s0">p = case</span>
        <span class="s0">pow_ = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.025</span><span class="s1">,</span>
            <span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>
        <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

        <span class="s2"># compare other method_var for similar results</span>
        <span class="s0">pow_2 = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.025</span><span class="s1">,</span>
            <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
            <span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s0">)</span>
        <span class="s0">assert_allclose(pow_2</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-3</span><span class="s0">)</span>

        <span class="s0">pow_ = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
            <span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
        <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

        <span class="s2"># compare other method_var for similar results</span>
        <span class="s0">pow_2 = power_poisson_ratio_2indep(</span>
            <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
            <span class="s0">exposure=exposure</span><span class="s1">, </span><span class="s0">value=low</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">,</span>
            <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
            <span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">)</span>
        <span class="s0">assert_allclose(pow_2</span><span class="s1">, </span><span class="s0">p</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">5e-3</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_power_poisson_equal():</span>

    <span class="s2"># Example from Chapter 436: Tests for the Difference Between Two Poisson</span>
    <span class="s2"># Rates</span>
    <span class="s2"># equality null H0: rate1 = rate2</span>
    <span class="s2">#</span>
    <span class="s2"># Power N1 N2 N rate1 rate2 diff(rate2-rate1) ratio(rate2/rate1) Alpha</span>
    <span class="s2"># 0.82566 8 6 14 10.00 15.00 5.00 1.5000 0.050</span>
    <span class="s2">#</span>
    <span class="s2"># &quot;1&quot; is reference group</span>
    <span class="s2"># we use group 2 reference</span>

    <span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2 = </span><span class="s4">6</span><span class="s1">, </span><span class="s4">8</span>
    <span class="s0">nobs_ratio = nobs2 / nobs1</span>
    <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2 = </span><span class="s4">15</span><span class="s1">, </span><span class="s4">10</span>

    <span class="s0">pow_ = power_poisson_diff_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs_ratio=nobs_ratio</span><span class="s1">, </span><span class="s0">alpha=</span><span class="s4">0.05</span><span class="s1">, </span><span class="s0">value=</span><span class="s4">0</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;alt&quot;</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">'larger'</span><span class="s1">, </span><span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_.power</span><span class="s1">, </span><span class="s4">0.82566</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s2"># This supports now nonzero value</span>
    <span class="s2"># example in table 1 of Stucke, Kieser (2013)</span>
    <span class="s2"># regression numbers but close to exact power in table</span>

    <span class="s0">pow_ = power_poisson_diff_2indep(</span>
        <span class="s4">0.6</span><span class="s1">, </span><span class="s4">0.6</span><span class="s1">, </span><span class="s4">97</span><span class="s1">, </span><span class="s4">3 </span><span class="s0">/ </span><span class="s4">2</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">0.3</span><span class="s1">,</span>
        <span class="s0">alpha=</span><span class="s4">0.025</span><span class="s1">,</span>
        <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_.power</span><span class="s1">, </span><span class="s4">0.802596</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s0">pow_ = power_poisson_diff_2indep(</span>
        <span class="s4">0.6</span><span class="s1">, </span><span class="s4">0.6</span><span class="s1">, </span><span class="s4">128</span><span class="s1">, </span><span class="s4">2 </span><span class="s0">/ </span><span class="s4">3</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">0.3</span><span class="s1">,</span>
        <span class="s0">alpha=</span><span class="s4">0.025</span><span class="s1">,</span>
        <span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_.power</span><span class="s1">, </span><span class="s4">0.80194</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>


<span class="s1">def </span><span class="s0">test_power_negbin():</span>

    <span class="s2"># example from PASS ch. 468, last example Zhu 2016</span>
    <span class="s2"># Note, the table has wrong RU, does not correspond to text</span>
    <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2 = </span><span class="s4">2.5</span><span class="s1">, </span><span class="s4">2.5</span>
    <span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2 = </span><span class="s4">965</span><span class="s1">, </span><span class="s4">965</span>
    <span class="s0">alpha = </span><span class="s4">0.05</span>
    <span class="s0">exposure = </span><span class="s4">0.9</span>
    <span class="s0">low</span><span class="s1">, </span><span class="s0">upp = </span><span class="s4">0.875</span><span class="s1">, </span><span class="s4">1 </span><span class="s0">/ </span><span class="s4">0.875</span>
    <span class="s0">dispersion = </span><span class="s4">0.35</span>

    <span class="s0">pow1 = </span><span class="s4">0.90022</span>
    <span class="s0">pow_ = power_equivalence_neginb_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">,</span>
        <span class="s0">dispersion=dispersion</span><span class="s1">, </span><span class="s0">method_var=</span><span class="s3">&quot;alt&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2 = </span><span class="s4">966</span><span class="s1">, </span><span class="s4">966</span>

    <span class="s0">pow1 = </span><span class="s4">0.90015</span>
    <span class="s0">pow_ = power_equivalence_neginb_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">,</span>
        <span class="s0">dispersion=dispersion</span><span class="s1">, </span><span class="s0">method_var=</span><span class="s3">&quot;ftotal&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s0">pow1 = </span><span class="s4">0.90034</span>
    <span class="s0">pow_ = power_equivalence_neginb_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">low</span><span class="s1">, </span><span class="s0">upp</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">,</span>
        <span class="s0">dispersion=dispersion</span><span class="s1">, </span><span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-5</span><span class="s0">)</span>

    <span class="s2"># test with unequal sample size agains R</span>
    <span class="s2"># R packages MKmisc and PASSED have only equality test, ratio=1, for negbin</span>
    <span class="s2"># package PASSED has same results as MKmisc but different signature</span>
    <span class="s2"># in R: treatment and control are reversed, theta = 1 / dispersion</span>
    <span class="s2"># &gt; power_NegativeBinomial(n1 = 100, n2=50, mu1 = 0.5, mu2 = 0.3, theta=2,</span>
    <span class="s2">#   duration = 2, approach = 3))</span>

    <span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">, </span><span class="s0">exposure = </span><span class="s4">0.3</span><span class="s1">, </span><span class="s4">50</span><span class="s1">, </span><span class="s4">0.5</span><span class="s1">, </span><span class="s4">100</span><span class="s1">, </span><span class="s4">2</span>
    <span class="s0">pow1 = </span><span class="s4">0.6207448</span>
    <span class="s0">pow_ = power_negbin_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">0.5</span><span class="s1">,</span>
        <span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">False,</span>
        <span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>

    <span class="s2"># flip nobs ratio</span>
    <span class="s0">pow1 = </span><span class="s4">0.5825763</span>
    <span class="s0">nobs1</span><span class="s1">, </span><span class="s0">nobs2 = nobs2</span><span class="s1">, </span><span class="s0">nobs1</span>
    <span class="s0">pow_ = power_negbin_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">0.5</span><span class="s1">,</span>
        <span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">False</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>

    <span class="s2"># corner case poisson</span>
    <span class="s2"># &gt; power_NegativeBinomial(n1 = 50, n2=100, mu1 = 0.5, mu2 = 0.3,</span>
    <span class="s2">#   theta=200000, duration = 2, approach = 3)</span>
    <span class="s0">pow1 = </span><span class="s4">0.7248956</span>
    <span class="s0">pow_ = power_negbin_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">False</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>

    <span class="s0">pow_p = power_poisson_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;two-sided&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow_</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>

    <span class="s2"># test one-sided</span>
    <span class="s0">pow1 = </span><span class="s4">0.823889</span>
    <span class="s0">pow_ = power_negbin_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">False</span><span class="s0">)</span>

    <span class="s0">pow_p = power_poisson_ratio_2indep(</span>
        <span class="s0">rate2</span><span class="s1">, </span><span class="s0">rate1</span><span class="s1">, </span><span class="s0">nobs2</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs1 / nobs2</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;smaller&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow_</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>

    <span class="s2"># reverse 2 samples</span>
    <span class="s0">pow_ = power_negbin_ratio_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">0</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">False</span><span class="s0">)</span>

    <span class="s0">pow_p = power_poisson_ratio_2indep(</span>
        <span class="s0">rate1</span><span class="s1">, </span><span class="s0">rate2</span><span class="s1">, </span><span class="s0">nobs1</span><span class="s1">,</span>
        <span class="s0">nobs_ratio=nobs2 / nobs1</span><span class="s1">,</span>
        <span class="s0">exposure=exposure</span><span class="s1">,</span>
        <span class="s0">value=</span><span class="s4">1</span><span class="s1">,</span>
        <span class="s0">alpha=alpha</span><span class="s1">, </span><span class="s0">dispersion=</span><span class="s4">1</span><span class="s1">, </span><span class="s0">alternative=</span><span class="s3">&quot;larger&quot;</span><span class="s1">,</span>
        <span class="s0">method_var=</span><span class="s3">&quot;score&quot;</span><span class="s1">,</span>
        <span class="s0">return_results=</span><span class="s1">True</span><span class="s0">)</span>

    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow1</span><span class="s1">, </span><span class="s0">atol=</span><span class="s4">5e-2</span><span class="s0">)</span>
    <span class="s0">assert_allclose(pow_p</span><span class="s1">, </span><span class="s0">pow_</span><span class="s1">, </span><span class="s0">rtol=</span><span class="s4">1e-13</span><span class="s0">)</span>
</pre>
</body>
</html>