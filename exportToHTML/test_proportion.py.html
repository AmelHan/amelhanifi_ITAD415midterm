<html>
<head>
<title>test_proportion.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_proportion.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
 
Created on Fri Mar 01 14:56:56 2013 
 
Author: Josef Perktold 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">assert_allclose</span><span class="s3">,</span>
    <span class="s1">assert_almost_equal</span><span class="s3">,</span>
    <span class="s1">assert_array_less</span><span class="s3">,</span>
    <span class="s1">assert_equal</span><span class="s3">,</span>
    <span class="s1">assert_raises</span><span class="s3">,</span>
<span class="s1">)</span>
<span class="s3">import </span><span class="s1">pandas </span><span class="s3">as </span><span class="s1">pd</span>
<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">import </span><span class="s1">statsmodels.stats.proportion </span><span class="s3">as </span><span class="s1">smprop</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.proportion </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">confint_proportions_2indep</span><span class="s3">,</span>
    <span class="s1">multinomial_proportions_confint</span><span class="s3">,</span>
    <span class="s1">power_proportions_2indep</span><span class="s3">,</span>
    <span class="s1">proportion_confint</span><span class="s3">,</span>
    <span class="s1">samplesize_proportions_2indep_onetail</span><span class="s3">,</span>
    <span class="s1">score_test_proportions_2indep</span><span class="s3">,</span>
<span class="s1">)</span>
<span class="s3">from </span><span class="s1">statsmodels.tools.sm_exceptions </span><span class="s3">import </span><span class="s1">HypothesisTestWarning</span>
<span class="s3">from </span><span class="s1">statsmodels.tools.testing </span><span class="s3">import </span><span class="s1">Holder</span>
<span class="s3">from </span><span class="s1">statsmodels.stats.tests.results.results_proportion </span><span class="s3">import </span><span class="s1">res_binom</span><span class="s3">, </span><span class="s1">res_binom_methods</span>

<span class="s1">probci_methods = {</span><span class="s4">'agresti_coull'</span><span class="s1">: </span><span class="s4">'agresti-coull'</span><span class="s3">,</span>
                  <span class="s4">'normal'</span><span class="s1">: </span><span class="s4">'asymptotic'</span><span class="s3">,</span>
                  <span class="s4">'beta'</span><span class="s1">: </span><span class="s4">'exact'</span><span class="s3">,</span>
                  <span class="s4">'wilson'</span><span class="s1">: </span><span class="s4">'wilson'</span><span class="s3">,</span>
                  <span class="s4">'jeffreys'</span><span class="s1">: </span><span class="s4">'bayes'</span>
                  <span class="s1">}</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;case&quot;</span><span class="s3">,</span><span class="s1">res_binom)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;method&quot;</span><span class="s3">,</span><span class="s1">probci_methods)</span>
<span class="s3">def </span><span class="s1">test_confint_proportion(method</span><span class="s3">, </span><span class="s1">case):</span>
    <span class="s1">count</span><span class="s3">, </span><span class="s1">nobs = case</span>
    <span class="s1">idx = res_binom_methods.index(probci_methods[method])</span>
    <span class="s1">res_low = res_binom[case].ci_low[idx]</span>
    <span class="s1">res_upp = res_binom[case].ci_upp[idx]</span>
    <span class="s3">if </span><span class="s1">np.isnan(res_low) </span><span class="s3">or </span><span class="s1">np.isnan(res_upp):</span>
        <span class="s1">pytest.skip(</span><span class="s4">&quot;Skipping due to NaN value&quot;</span><span class="s1">)</span>
    <span class="s3">if </span><span class="s1">(count == </span><span class="s5">0 </span><span class="s3">or </span><span class="s1">count == nobs) </span><span class="s3">and </span><span class="s1">method == </span><span class="s4">'jeffreys'</span><span class="s1">:</span>
        <span class="s0"># maybe a bug or different corner case definition</span>
        <span class="s1">pytest.skip(</span><span class="s4">&quot;Skipping nobs 0 or count and jeffreys&quot;</span><span class="s1">)</span>
    <span class="s3">if </span><span class="s1">method == </span><span class="s4">'jeffreys' </span><span class="s3">and </span><span class="s1">nobs == </span><span class="s5">30</span><span class="s1">:</span>
        <span class="s0"># something is strange in extreme case e.g 0/30 or 1/30</span>
        <span class="s1">pytest.skip(</span><span class="s4">&quot;Skipping nobs is 30 and jeffreys due to extreme case problem&quot;</span><span class="s1">)</span>
    <span class="s1">ci = proportion_confint(count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s0"># we impose that confint is in [0, 1]</span>
    <span class="s1">res_low = max(res_low</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">res_upp = min(res_upp</span><span class="s3">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(ci</span><span class="s3">, </span><span class="s1">[res_low</span><span class="s3">, </span><span class="s1">res_upp]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">6</span><span class="s3">,</span>
                        <span class="s1">err_msg=repr(case) + method)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'method'</span><span class="s3">, </span><span class="s1">probci_methods)</span>
<span class="s3">def </span><span class="s1">test_confint_proportion_ndim(method):</span>
    <span class="s0"># check that it works with 1-D, 2-D and pandas</span>

    <span class="s1">count = np.arange(</span><span class="s5">6</span><span class="s1">).reshape(</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">nobs = </span><span class="s5">10 </span><span class="s1">* np.ones((</span><span class="s5">2</span><span class="s3">, </span><span class="s5">3</span><span class="s1">))</span>

    <span class="s1">count_pd = pd.DataFrame(count)</span>
    <span class="s1">nobs_pd =  pd.DataFrame(nobs)</span>

    <span class="s1">ci_arr = proportion_confint(count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">ci_pd = proportion_confint(count_pd</span><span class="s3">, </span><span class="s1">nobs_pd</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                               <span class="s1">method=method)</span>
    <span class="s1">assert_allclose(ci_arr</span><span class="s3">, </span><span class="s1">(ci_pd[</span><span class="s5">0</span><span class="s1">].values</span><span class="s3">, </span><span class="s1">ci_pd[</span><span class="s5">1</span><span class="s1">].values)</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
    <span class="s0"># spot checking one value</span>
    <span class="s1">ci12 = proportion_confint(count[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">nobs[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                              <span class="s1">method=method)</span>
    <span class="s1">assert_allclose((ci_pd[</span><span class="s5">0</span><span class="s1">].values[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_pd[</span><span class="s5">1</span><span class="s1">].values[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">])</span><span class="s3">, </span><span class="s1">ci12</span><span class="s3">,</span>
                    <span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>
    <span class="s1">assert_allclose((ci_arr[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_arr[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">])</span><span class="s3">, </span><span class="s1">ci12</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s0"># check that lists work as input</span>
    <span class="s1">ci_li = proportion_confint(count.tolist()</span><span class="s3">, </span><span class="s1">nobs.tolist()</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                               <span class="s1">method=method)</span>
    <span class="s1">assert_allclose(ci_arr</span><span class="s3">, </span><span class="s1">(ci_li[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_li[</span><span class="s5">1</span><span class="s1">])</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s0"># check pandas Series, 1-D</span>
    <span class="s1">ci_pds = proportion_confint(count_pd.iloc[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">nobs_pd.iloc[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">,</span>
                                <span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">assert_allclose((ci_pds[</span><span class="s5">0</span><span class="s1">].values</span><span class="s3">, </span><span class="s1">ci_pds[</span><span class="s5">1</span><span class="s1">].values)</span><span class="s3">,</span>
                    <span class="s1">(ci_pd[</span><span class="s5">0</span><span class="s1">].values[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_pd[</span><span class="s5">1</span><span class="s1">].values[</span><span class="s5">0</span><span class="s1">])</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s0"># check scalar nobs, verifying one value</span>
    <span class="s1">ci_arr2 = proportion_confint(count</span><span class="s3">, </span><span class="s1">nobs[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                                 <span class="s1">method=method)</span>
    <span class="s1">assert_allclose((ci_arr2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_arr[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">])</span><span class="s3">, </span><span class="s1">ci12</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s0"># check floating point values</span>
    <span class="s1">ci_arr2 = proportion_confint(count + </span><span class="s5">1e-4</span><span class="s3">, </span><span class="s1">nobs[</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                                 <span class="s1">method=method)</span>
    <span class="s0"># should be close to values with integer values</span>
    <span class="s1">assert_allclose((ci_arr2[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci_arr[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s3">, </span><span class="s5">2</span><span class="s1">])</span><span class="s3">, </span><span class="s1">ci12</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-4</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_samplesize_confidenceinterval_prop():</span>
    <span class="s0">#consistency test for samplesize to achieve confidence_interval</span>
    <span class="s1">nobs = </span><span class="s5">20</span>
    <span class="s1">ci = smprop.proportion_confint(</span><span class="s5">12</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">'normal'</span><span class="s1">)</span>
    <span class="s1">res = smprop.samplesize_confint_proportion(</span><span class="s5">12.</span><span class="s1">/nobs</span><span class="s3">, </span><span class="s1">(ci[</span><span class="s5">1</span><span class="s1">] - ci[</span><span class="s5">0</span><span class="s1">]) / </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">test_proportion_effect_size():</span>
    <span class="s0"># example from blog</span>
    <span class="s1">es = smprop.proportion_effectsize(</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.4</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(es</span><span class="s3">, </span><span class="s5">0.2013579207903309</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">test_confint_multinomial_proportions():</span>
    <span class="s3">from </span><span class="s1">.results.results_multinomial_proportions </span><span class="s3">import </span><span class="s1">res_multinomial</span>

    <span class="s3">for </span><span class="s1">((method</span><span class="s3">, </span><span class="s1">description)</span><span class="s3">, </span><span class="s1">values) </span><span class="s3">in </span><span class="s1">res_multinomial.items():</span>
        <span class="s1">cis = multinomial_proportions_confint(values.proportions</span><span class="s3">, </span><span class="s5">0.05</span><span class="s3">,</span>
                                              <span class="s1">method=method)</span>
        <span class="s1">assert_almost_equal(</span>
            <span class="s1">values.cis</span><span class="s3">, </span><span class="s1">cis</span><span class="s3">, </span><span class="s1">decimal=values.precision</span><span class="s3">,</span>
            <span class="s1">err_msg=</span><span class="s4">'&quot;%s&quot; method, %s' </span><span class="s1">% (method</span><span class="s3">, </span><span class="s1">description))</span>

<span class="s3">def </span><span class="s1">test_multinomial_proportions_errors():</span>
    <span class="s0"># Out-of-bounds values for alpha raise a ValueError</span>
    <span class="s3">for </span><span class="s1">alpha </span><span class="s3">in </span><span class="s1">[-</span><span class="s5">.1</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">1.1</span><span class="s1">]:</span>
        <span class="s1">assert_raises(ValueError</span><span class="s3">, </span><span class="s1">multinomial_proportions_confint</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s5">5</span><span class="s1">] * </span><span class="s5">50</span><span class="s3">, </span><span class="s1">alpha=alpha)</span>

    <span class="s1">assert_raises(ValueError</span><span class="s3">, </span><span class="s1">multinomial_proportions_confint</span><span class="s3">,</span>
                  <span class="s1">np.arange(</span><span class="s5">50</span><span class="s1">) - </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s0"># Any unknown method is reported.</span>
    <span class="s3">for </span><span class="s1">method </span><span class="s3">in </span><span class="s1">[</span><span class="s4">'unknown_method'</span><span class="s3">, </span><span class="s4">'sisok_method'</span><span class="s3">, </span><span class="s4">'unknown-glaz'</span><span class="s1">]:</span>
        <span class="s1">assert_raises(NotImplementedError</span><span class="s3">, </span><span class="s1">multinomial_proportions_confint</span><span class="s3">,</span>
                      <span class="s1">[</span><span class="s5">5</span><span class="s1">] * </span><span class="s5">50</span><span class="s3">, </span><span class="s1">method=method)</span>

<span class="s3">def </span><span class="s1">test_confint_multinomial_proportions_zeros():</span>
    <span class="s0"># test when a count is zero or close to zero</span>
    <span class="s0"># values from R MultinomialCI</span>
    <span class="s1">ci01 = np.array([</span>
     <span class="s5">0.09364718</span><span class="s3">, </span><span class="s5">0.1898413</span><span class="s3">,</span>
     <span class="s5">0.00000000</span><span class="s3">, </span><span class="s5">0.0483581</span><span class="s3">,</span>
     <span class="s5">0.13667426</span><span class="s3">, </span><span class="s5">0.2328684</span><span class="s3">,</span>
     <span class="s5">0.10124019</span><span class="s3">, </span><span class="s5">0.1974343</span><span class="s3">,</span>
     <span class="s5">0.10883321</span><span class="s3">, </span><span class="s5">0.2050273</span><span class="s3">,</span>
     <span class="s5">0.17210833</span><span class="s3">, </span><span class="s5">0.2683024</span><span class="s3">,</span>
     <span class="s5">0.09870919</span><span class="s3">, </span><span class="s5">0.1949033</span><span class="s1">]).reshape(-</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">ci0 = np.array([</span>
    <span class="s5">0.09620253</span><span class="s3">, </span><span class="s5">0.19238867</span><span class="s3">,</span>
    <span class="s5">0.00000000</span><span class="s3">, </span><span class="s5">0.05061652</span><span class="s3">,</span>
    <span class="s5">0.13924051</span><span class="s3">, </span><span class="s5">0.23542664</span><span class="s3">,</span>
    <span class="s5">0.10379747</span><span class="s3">, </span><span class="s5">0.19998360</span><span class="s3">,</span>
    <span class="s5">0.11139241</span><span class="s3">, </span><span class="s5">0.20757854</span><span class="s3">,</span>
    <span class="s5">0.17468354</span><span class="s3">, </span><span class="s5">0.27086968</span><span class="s3">,</span>
    <span class="s5">0.10126582</span><span class="s3">, </span><span class="s5">0.19745196</span><span class="s1">]).reshape(-</span><span class="s5">1</span><span class="s3">,</span><span class="s5">2</span><span class="s1">)</span>

    <span class="s0"># the shifts are the differences between &quot;LOWER(SG)&quot;  &quot;UPPER(SG)&quot; and</span>
    <span class="s0"># &quot;LOWER(C+1)&quot; &quot;UPPER(C+1)&quot; in verbose printout</span>
    <span class="s0"># ci01_shift = np.array([0.002531008, -0.002515122])  # not needed</span>
    <span class="s1">ci0_shift = np.array([</span><span class="s5">0.002531642</span><span class="s3">, </span><span class="s5">0.002515247</span><span class="s1">])</span>

    <span class="s1">p = [</span><span class="s5">56</span><span class="s3">, </span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">73</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">87</span><span class="s3">, </span><span class="s5">58</span><span class="s1">]</span>
    <span class="s1">ci_01 = smprop.multinomial_proportions_confint(p</span><span class="s3">, </span><span class="s5">0.05</span><span class="s3">,</span>
                                                   <span class="s1">method=</span><span class="s4">'sison_glaz'</span><span class="s1">)</span>
    <span class="s1">p = [</span><span class="s5">56</span><span class="s3">, </span><span class="s5">0</span><span class="s3">, </span><span class="s5">73</span><span class="s3">, </span><span class="s5">59</span><span class="s3">, </span><span class="s5">62</span><span class="s3">, </span><span class="s5">87</span><span class="s3">, </span><span class="s5">58</span><span class="s1">]</span>
    <span class="s1">ci_0 = smprop.multinomial_proportions_confint(p</span><span class="s3">, </span><span class="s5">0.05</span><span class="s3">,</span>
                                                  <span class="s1">method=</span><span class="s4">'sison_glaz'</span><span class="s1">)</span>

    <span class="s1">assert_allclose(ci_01</span><span class="s3">, </span><span class="s1">ci01</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_0</span><span class="s3">, </span><span class="s1">np.maximum(ci0 - ci0_shift</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci_01</span><span class="s3">, </span><span class="s1">ci_0</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">5e-4</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">CheckProportionMixin:</span>
    <span class="s3">def </span><span class="s1">test_proptest(self):</span>
        <span class="s0"># equality of k-samples</span>
        <span class="s1">pt = smprop.proportions_chisquare(self.n_success</span><span class="s3">, </span><span class="s1">self.nobs</span><span class="s3">, </span><span class="s1">value=</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test.statistic</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test.p_value</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

        <span class="s0"># several against value</span>
        <span class="s1">pt = smprop.proportions_chisquare(self.n_success</span><span class="s3">, </span><span class="s1">self.nobs</span><span class="s3">,</span>
                                    <span class="s1">value=self.res_prop_test_val.null_value[</span><span class="s5">0</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test_val.statistic</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test_val.p_value</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

        <span class="s0"># one proportion against value</span>
        <span class="s1">pt = smprop.proportions_chisquare(self.n_success[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.nobs[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">,</span>
                                    <span class="s1">value=self.res_prop_test_1.null_value)</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test_1.statistic</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pt[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">self.res_prop_test_1.p_value</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_pairwiseproptest(self):</span>
        <span class="s1">ppt = smprop.proportions_chisquare_allpairs(self.n_success</span><span class="s3">, </span><span class="s1">self.nobs</span><span class="s3">,</span>
                                  <span class="s1">multitest_method=</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(ppt.pvals_raw</span><span class="s3">, </span><span class="s1">self.res_ppt_pvals_raw)</span>
        <span class="s1">ppt = smprop.proportions_chisquare_allpairs(self.n_success</span><span class="s3">, </span><span class="s1">self.nobs</span><span class="s3">,</span>
                                  <span class="s1">multitest_method=</span><span class="s4">'h'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(ppt.pval_corrected()</span><span class="s3">, </span><span class="s1">self.res_ppt_pvals_holm)</span>

        <span class="s1">pptd = smprop.proportions_chisquare_pairscontrol(self.n_success</span><span class="s3">,</span>
                                  <span class="s1">self.nobs</span><span class="s3">, </span><span class="s1">multitest_method=</span><span class="s4">'hommel'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pptd.pvals_raw</span><span class="s3">, </span><span class="s1">ppt.pvals_raw[:len(self.nobs) - </span><span class="s5">1</span><span class="s1">]</span><span class="s3">,</span>
                            <span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>


    <span class="s3">def </span><span class="s1">test_number_pairs_1493(self):</span>
        <span class="s1">ppt = smprop.proportions_chisquare_allpairs(self.n_success[:</span><span class="s5">3</span><span class="s1">]</span><span class="s3">,</span>
                                                    <span class="s1">self.nobs[:</span><span class="s5">3</span><span class="s1">]</span><span class="s3">,</span>
                                                    <span class="s1">multitest_method=</span><span class="s3">None</span><span class="s1">)</span>

        <span class="s1">assert_equal(len(ppt.pvals_raw)</span><span class="s3">, </span><span class="s5">3</span><span class="s1">)</span>
        <span class="s1">idx = [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">1</span><span class="s3">, </span><span class="s5">3</span><span class="s1">]</span>
        <span class="s1">assert_almost_equal(ppt.pvals_raw</span><span class="s3">, </span><span class="s1">self.res_ppt_pvals_raw[idx])</span>


<span class="s3">class </span><span class="s1">TestProportion(CheckProportionMixin):</span>
    <span class="s3">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.n_success = np.array([ </span><span class="s5">73</span><span class="s3">,  </span><span class="s5">90</span><span class="s3">, </span><span class="s5">114</span><span class="s3">,  </span><span class="s5">75</span><span class="s1">])</span>
        <span class="s1">self.nobs = np.array([ </span><span class="s5">86</span><span class="s3">,  </span><span class="s5">93</span><span class="s3">, </span><span class="s5">136</span><span class="s3">,  </span><span class="s5">82</span><span class="s1">])</span>

        <span class="s1">self.res_ppt_pvals_raw = np.array([</span>
                 <span class="s5">0.00533824886503131</span><span class="s3">, </span><span class="s5">0.8327574849753566</span><span class="s3">, </span><span class="s5">0.1880573726722516</span><span class="s3">,</span>
                 <span class="s5">0.002026764254350234</span><span class="s3">, </span><span class="s5">0.1309487516334318</span><span class="s3">, </span><span class="s5">0.1076118730631731</span>
                <span class="s1">])</span>
        <span class="s1">self.res_ppt_pvals_holm = np.array([</span>
                 <span class="s5">0.02669124432515654</span><span class="s3">, </span><span class="s5">0.8327574849753566</span><span class="s3">, </span><span class="s5">0.4304474922526926</span><span class="s3">,</span>
                 <span class="s5">0.0121605855261014</span><span class="s3">, </span><span class="s5">0.4304474922526926</span><span class="s3">, </span><span class="s5">0.4304474922526926</span>
                <span class="s1">])</span>

        <span class="s1">res_prop_test = Holder()</span>
        <span class="s1">res_prop_test.statistic = </span><span class="s5">11.11938768628861</span>
        <span class="s1">res_prop_test.parameter = </span><span class="s5">3</span>
        <span class="s1">res_prop_test.p_value = </span><span class="s5">0.011097511366581344</span>
        <span class="s1">res_prop_test.estimate = np.array([</span>
             <span class="s5">0.848837209302326</span><span class="s3">, </span><span class="s5">0.967741935483871</span><span class="s3">, </span><span class="s5">0.838235294117647</span><span class="s3">,</span>
             <span class="s5">0.9146341463414634</span>
            <span class="s1">]).reshape(</span><span class="s5">4</span><span class="s3">,</span><span class="s5">1</span><span class="s3">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
        <span class="s1">res_prop_test.null_value = </span><span class="s4">'''NULL'''</span>
        <span class="s1">res_prop_test.conf_int = </span><span class="s4">'''NULL'''</span>
        <span class="s1">res_prop_test.alternative = </span><span class="s4">'two.sided'</span>
        <span class="s1">res_prop_test.method = </span><span class="s4">'4-sample test for equality of proportions ' </span><span class="s1">+ \</span>
                               <span class="s4">'without continuity correction'</span>
        <span class="s1">res_prop_test.data_name = </span><span class="s4">'smokers2 out of patients'</span>
        <span class="s1">self.res_prop_test = res_prop_test</span>

        <span class="s0">#&gt; pt = prop.test(smokers2, patients, p=rep(c(0.9), 4), correct=FALSE)</span>
        <span class="s0">#&gt; cat_items(pt, &quot;res_prop_test_val.&quot;)</span>
        <span class="s1">res_prop_test_val = Holder()</span>
        <span class="s1">res_prop_test_val.statistic = np.array([</span>
             <span class="s5">13.20305530710751</span>
            <span class="s1">]).reshape(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
        <span class="s1">res_prop_test_val.parameter = np.array([</span>
             <span class="s5">4</span>
            <span class="s1">]).reshape(</span><span class="s5">1</span><span class="s3">,</span><span class="s5">1</span><span class="s3">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
        <span class="s1">res_prop_test_val.p_value = </span><span class="s5">0.010325090041836</span>
        <span class="s1">res_prop_test_val.estimate = np.array([</span>
             <span class="s5">0.848837209302326</span><span class="s3">, </span><span class="s5">0.967741935483871</span><span class="s3">, </span><span class="s5">0.838235294117647</span><span class="s3">,</span>
             <span class="s5">0.9146341463414634</span>
            <span class="s1">]).reshape(</span><span class="s5">4</span><span class="s3">,</span><span class="s5">1</span><span class="s3">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
        <span class="s1">res_prop_test_val.null_value = np.array([</span>
             <span class="s5">0.9</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s5">0.9</span>
            <span class="s1">]).reshape(</span><span class="s5">4</span><span class="s3">,</span><span class="s5">1</span><span class="s3">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
        <span class="s1">res_prop_test_val.conf_int = </span><span class="s4">'''NULL'''</span>
        <span class="s1">res_prop_test_val.alternative = </span><span class="s4">'two.sided'</span>
        <span class="s1">res_prop_test_val.method = </span><span class="s4">'4-sample test for given proportions without continuity correction'</span>
        <span class="s1">res_prop_test_val.data_name = </span><span class="s4">'smokers2 out of patients, null probabilities rep(c(0.9), 4)'</span>
        <span class="s1">self.res_prop_test_val = res_prop_test_val</span>

        <span class="s0">#&gt; pt = prop.test(smokers2[1], patients[1], p=0.9, correct=FALSE)</span>
        <span class="s0">#&gt; cat_items(pt, &quot;res_prop_test_1.&quot;)</span>
        <span class="s1">res_prop_test_1 = Holder()</span>
        <span class="s1">res_prop_test_1.statistic = </span><span class="s5">2.501291989664086</span>
        <span class="s1">res_prop_test_1.parameter = </span><span class="s5">1</span>
        <span class="s1">res_prop_test_1.p_value = </span><span class="s5">0.113752943640092</span>
        <span class="s1">res_prop_test_1.estimate = </span><span class="s5">0.848837209302326</span>
        <span class="s1">res_prop_test_1.null_value = </span><span class="s5">0.9</span>
        <span class="s1">res_prop_test_1.conf_int = np.array([</span><span class="s5">0.758364348004061</span><span class="s3">,</span>
                                             <span class="s5">0.9094787701686766</span><span class="s1">])</span>
        <span class="s1">res_prop_test_1.alternative = </span><span class="s4">'two.sided'</span>
        <span class="s1">res_prop_test_1.method = </span><span class="s4">'1-sample proportions test without continuity correction'</span>
        <span class="s1">res_prop_test_1.data_name = </span><span class="s4">'smokers2[1] out of patients[1], null probability 0.9'</span>
        <span class="s1">self.res_prop_test_1 = res_prop_test_1</span>

    <span class="s0"># GH 2969</span>
    <span class="s3">def </span><span class="s1">test_default_values(self):</span>
        <span class="s1">count = np.array([</span><span class="s5">5</span><span class="s3">, </span><span class="s5">12</span><span class="s1">])</span>
        <span class="s1">nobs = np.array([</span><span class="s5">83</span><span class="s3">, </span><span class="s5">99</span><span class="s1">])</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">pval = smprop.proportions_ztest(count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">value=</span><span class="s3">None</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(stat</span><span class="s3">, </span><span class="s1">-</span><span class="s5">1.4078304151258787</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pval</span><span class="s3">, </span><span class="s5">0.15918129181156992</span><span class="s1">)</span>

    <span class="s0"># GH 2779</span>
    <span class="s3">def </span><span class="s1">test_scalar(self):</span>
        <span class="s1">count = </span><span class="s5">5</span>
        <span class="s1">nobs = </span><span class="s5">83</span>
        <span class="s1">value = </span><span class="s5">0.05</span>
        <span class="s1">stat</span><span class="s3">, </span><span class="s1">pval = smprop.proportions_ztest(count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">value=value)</span>
        <span class="s1">assert_almost_equal(stat</span><span class="s3">, </span><span class="s5">0.392126026314</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(pval</span><span class="s3">, </span><span class="s5">0.694965098115</span><span class="s1">)</span>

        <span class="s1">assert_raises(ValueError</span><span class="s3">, </span><span class="s1">smprop.proportions_ztest</span><span class="s3">, </span><span class="s1">count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">value=</span><span class="s3">None</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_binom_test():</span>
    <span class="s0">#&gt; bt = binom.test(51,235,(1/6),alternative=&quot;less&quot;)</span>
    <span class="s0">#&gt; cat_items(bt, &quot;binom_test_less.&quot;)</span>
    <span class="s1">binom_test_less = Holder()</span>
    <span class="s1">binom_test_less.statistic = </span><span class="s5">51</span>
    <span class="s1">binom_test_less.parameter = </span><span class="s5">235</span>
    <span class="s1">binom_test_less.p_value = </span><span class="s5">0.982022657605858</span>
    <span class="s1">binom_test_less.conf_int = [</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.2659460862574313</span><span class="s1">]</span>
    <span class="s1">binom_test_less.estimate = </span><span class="s5">0.2170212765957447</span>
    <span class="s1">binom_test_less.null_value = </span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">6</span>
    <span class="s1">binom_test_less.alternative = </span><span class="s4">'less'</span>
    <span class="s1">binom_test_less.method = </span><span class="s4">'Exact binomial test'</span>
    <span class="s1">binom_test_less.data_name = </span><span class="s4">'51 and 235'</span>

    <span class="s0">#&gt; bt = binom.test(51,235,(1/6),alternative=&quot;greater&quot;)</span>
    <span class="s0">#&gt; cat_items(bt, &quot;binom_test_greater.&quot;)</span>
    <span class="s1">binom_test_greater = Holder()</span>
    <span class="s1">binom_test_greater.statistic = </span><span class="s5">51</span>
    <span class="s1">binom_test_greater.parameter = </span><span class="s5">235</span>
    <span class="s1">binom_test_greater.p_value = </span><span class="s5">0.02654424571169085</span>
    <span class="s1">binom_test_greater.conf_int = [</span><span class="s5">0.1735252778065201</span><span class="s3">, </span><span class="s5">1</span><span class="s1">]</span>
    <span class="s1">binom_test_greater.estimate = </span><span class="s5">0.2170212765957447</span>
    <span class="s1">binom_test_greater.null_value = </span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">6</span>
    <span class="s1">binom_test_greater.alternative = </span><span class="s4">'greater'</span>
    <span class="s1">binom_test_greater.method = </span><span class="s4">'Exact binomial test'</span>
    <span class="s1">binom_test_greater.data_name = </span><span class="s4">'51 and 235'</span>

    <span class="s0">#&gt; bt = binom.test(51,235,(1/6),alternative=&quot;t&quot;)</span>
    <span class="s0">#&gt; cat_items(bt, &quot;binom_test_2sided.&quot;)</span>
    <span class="s1">binom_test_2sided = Holder()</span>
    <span class="s1">binom_test_2sided.statistic = </span><span class="s5">51</span>
    <span class="s1">binom_test_2sided.parameter = </span><span class="s5">235</span>
    <span class="s1">binom_test_2sided.p_value = </span><span class="s5">0.0437479701823997</span>
    <span class="s1">binom_test_2sided.conf_int = [</span><span class="s5">0.1660633298083073</span><span class="s3">, </span><span class="s5">0.2752683640289254</span><span class="s1">]</span>
    <span class="s1">binom_test_2sided.estimate = </span><span class="s5">0.2170212765957447</span>
    <span class="s1">binom_test_2sided.null_value = </span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">6</span>
    <span class="s1">binom_test_2sided.alternative = </span><span class="s4">'two.sided'</span>
    <span class="s1">binom_test_2sided.method = </span><span class="s4">'Exact binomial test'</span>
    <span class="s1">binom_test_2sided.data_name = </span><span class="s4">'51 and 235'</span>

    <span class="s1">alltests = [(</span><span class="s4">'larger'</span><span class="s3">, </span><span class="s1">binom_test_greater)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'smaller'</span><span class="s3">, </span><span class="s1">binom_test_less)</span><span class="s3">,</span>
                <span class="s1">(</span><span class="s4">'two-sided'</span><span class="s3">, </span><span class="s1">binom_test_2sided)]</span>

    <span class="s3">for </span><span class="s1">alt</span><span class="s3">, </span><span class="s1">res0 </span><span class="s3">in </span><span class="s1">alltests:</span>
        <span class="s0"># only p-value is returned</span>
        <span class="s1">res = smprop.binom_test(</span><span class="s5">51</span><span class="s3">, </span><span class="s5">235</span><span class="s3">, </span><span class="s1">prop=</span><span class="s5">1. </span><span class="s1">/ </span><span class="s5">6</span><span class="s3">, </span><span class="s1">alternative=alt)</span>
        <span class="s0">#assert_almost_equal(res[0], res0.statistic)</span>
        <span class="s1">assert_almost_equal(res</span><span class="s3">, </span><span class="s1">res0.p_value</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

    <span class="s0"># R binom_test returns Copper-Pearson confint</span>
    <span class="s1">ci_2s = smprop.proportion_confint(</span><span class="s5">51</span><span class="s3">, </span><span class="s5">235</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">'beta'</span><span class="s1">)</span>
    <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_upp = smprop.proportion_confint(</span><span class="s5">51</span><span class="s3">, </span><span class="s5">235</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.1</span><span class="s3">,</span>
                                               <span class="s1">method=</span><span class="s4">'beta'</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(ci_2s</span><span class="s3">, </span><span class="s1">binom_test_2sided.conf_int</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(ci_upp</span><span class="s3">, </span><span class="s1">binom_test_less.conf_int[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(ci_low</span><span class="s3">, </span><span class="s1">binom_test_greater.conf_int[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_binom_rejection_interval():</span>
    <span class="s0"># consistency check with binom_test</span>
    <span class="s0"># some code duplication but limit checks are different</span>
    <span class="s1">alpha = </span><span class="s5">0.05</span>
    <span class="s1">nobs = </span><span class="s5">200</span>
    <span class="s1">prop = </span><span class="s5">12.</span><span class="s1">/</span><span class="s5">20</span>
    <span class="s1">alternative=</span><span class="s4">'smaller'</span>
    <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_upp = smprop.binom_test_reject_interval(prop</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">,</span>
                                                       <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_equal(ci_upp</span><span class="s3">, </span><span class="s1">nobs)</span>
    <span class="s1">pval = smprop.binom_test(ci_low</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                                  <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(pval</span><span class="s3">, </span><span class="s1">alpha)</span>
    <span class="s1">pval = smprop.binom_test(ci_low + </span><span class="s5">1</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                                  <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(alpha</span><span class="s3">, </span><span class="s1">pval)</span>

    <span class="s1">alternative=</span><span class="s4">'larger'</span>
    <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_upp = smprop.binom_test_reject_interval(prop</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">,</span>
                                                       <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_equal(ci_low</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">pval = smprop.binom_test(ci_upp</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                                  <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(pval</span><span class="s3">, </span><span class="s1">alpha)</span>
    <span class="s1">pval = smprop.binom_test(ci_upp - </span><span class="s5">1</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                                  <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(alpha</span><span class="s3">, </span><span class="s1">pval)</span>

    <span class="s1">alternative=</span><span class="s4">'two-sided'</span>
    <span class="s1">ci_low</span><span class="s3">, </span><span class="s1">ci_upp = smprop.binom_test_reject_interval(prop</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">alpha=alpha</span><span class="s3">,</span>
                                                       <span class="s1">alternative=alternative)</span>
    <span class="s1">pval = smprop.binom_test(ci_upp</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                             <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(pval</span><span class="s3">, </span><span class="s1">alpha)</span>
    <span class="s1">pval = smprop.binom_test(ci_upp - </span><span class="s5">1</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                             <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(alpha</span><span class="s3">, </span><span class="s1">pval)</span>
    <span class="s1">pval = smprop.binom_test(ci_upp</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                             <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(pval</span><span class="s3">, </span><span class="s1">alpha)</span>

    <span class="s1">pval = smprop.binom_test(ci_upp - </span><span class="s5">1</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">prop=prop</span><span class="s3">,</span>
                             <span class="s1">alternative=alternative)</span>
    <span class="s1">assert_array_less(alpha</span><span class="s3">, </span><span class="s1">pval)</span>



<span class="s3">def </span><span class="s1">test_binom_tost():</span>
    <span class="s0"># consistency check with two different implementation,</span>
    <span class="s0"># proportion_confint is tested against R</span>
    <span class="s0"># no reference case from other package available</span>
    <span class="s1">ci = smprop.proportion_confint(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">'beta'</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.1</span><span class="s1">)</span>
    <span class="s1">bt = smprop.binom_tost(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">*ci)</span>
    <span class="s1">assert_almost_equal(bt</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.05</span><span class="s1">] * </span><span class="s5">3</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">12</span><span class="s1">)</span>

    <span class="s1">ci = smprop.proportion_confint(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">'beta'</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.1</span><span class="s1">)</span>
    <span class="s1">bt = smprop.binom_tost(</span><span class="s5">5</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">*ci)</span>
    <span class="s1">assert_almost_equal(bt</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.05</span><span class="s1">] * </span><span class="s5">3</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">12</span><span class="s1">)</span>

    <span class="s0"># vectorized, TODO: observed proportion = 0 returns nan</span>
    <span class="s1">ci = smprop.proportion_confint(np.arange(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">'beta'</span><span class="s3">,</span>
                                   <span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">bt = smprop.binom_tost(np.arange(</span><span class="s5">1</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">ci[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">ci[</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">bt = np.asarray(bt)</span>
    <span class="s1">assert_almost_equal(bt</span><span class="s3">, </span><span class="s5">0.025 </span><span class="s1">* np.ones(bt.shape)</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">12</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">test_power_binom_tost():</span>
    <span class="s0"># comparison numbers from PASS manual</span>
    <span class="s1">p_alt = </span><span class="s5">0.6 </span><span class="s1">+ np.linspace(</span><span class="s5">0</span><span class="s3">, </span><span class="s5">0.09</span><span class="s3">, </span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">power = smprop.power_binom_tost(</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">500</span><span class="s3">, </span><span class="s1">p_alt=p_alt</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">res_power = np.array([</span><span class="s5">0.9965</span><span class="s3">,  </span><span class="s5">0.9940</span><span class="s3">,  </span><span class="s5">0.9815</span><span class="s3">,  </span><span class="s5">0.9482</span><span class="s3">,  </span><span class="s5">0.8783</span><span class="s3">,  </span><span class="s5">0.7583</span><span class="s3">,</span>
                          <span class="s5">0.5914</span><span class="s3">,  </span><span class="s5">0.4041</span><span class="s3">,  </span><span class="s5">0.2352</span><span class="s3">,  </span><span class="s5">0.1139</span><span class="s1">])</span>
    <span class="s1">assert_almost_equal(power</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

    <span class="s1">rej_int = smprop.binom_tost_reject_interval(</span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">0.7</span><span class="s3">, </span><span class="s5">500</span><span class="s1">)</span>
    <span class="s1">res_rej_int = (</span><span class="s5">269</span><span class="s3">, </span><span class="s5">332</span><span class="s1">)</span>
    <span class="s1">assert_equal(rej_int</span><span class="s3">, </span><span class="s1">res_rej_int)</span>

    <span class="s0"># TODO: actual alpha=0.0489  for all p_alt above</span>

    <span class="s0"># another case</span>
    <span class="s1">nobs = np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span>
    <span class="s1">power = smprop.power_binom_tost(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">res_power = np.array([ </span><span class="s5">0.</span><span class="s3">,  </span><span class="s5">0.</span><span class="s3">,  </span><span class="s5">0.</span><span class="s3">,  </span><span class="s5">0.0889</span><span class="s3">,  </span><span class="s5">0.2356</span><span class="s3">,  </span><span class="s5">0.3517</span><span class="s3">,  </span><span class="s5">0.4457</span><span class="s3">,</span>
                           <span class="s5">0.6154</span><span class="s3">,  </span><span class="s5">0.6674</span><span class="s3">,  </span><span class="s5">0.7708</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

<span class="s3">def </span><span class="s1">test_power_ztost_prop():</span>
    <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s5">10</span><span class="s3">, </span><span class="s1">p_alt=</span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">,</span>
                         <span class="s1">discrete=</span><span class="s3">True, </span><span class="s1">dist=</span><span class="s4">'binom'</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">assert_almost_equal(power</span><span class="s3">, </span><span class="s5">0.8204</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">) </span><span class="s0"># PASS example</span>

    <span class="s3">with </span><span class="s1">warnings.catch_warnings():  </span><span class="s0"># python &gt;= 2.6</span>
        <span class="s1">warnings.simplefilter(</span><span class="s4">&quot;ignore&quot;</span><span class="s3">, </span><span class="s1">HypothesisTestWarning)</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">False,</span>
                                        <span class="s1">dist=</span><span class="s4">'binom'</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

        <span class="s1">res_power = np.array([ </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.0889</span><span class="s3">, </span><span class="s5">0.2356</span><span class="s3">, </span><span class="s5">0.4770</span><span class="s3">, </span><span class="s5">0.5530</span><span class="s3">,</span>
            <span class="s5">0.6154</span><span class="s3">,  </span><span class="s5">0.7365</span><span class="s3">,  </span><span class="s5">0.7708</span><span class="s1">])</span>
        <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
        <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

        <span class="s0"># with critval_continuity correction</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">False,</span>
                                        <span class="s1">dist=</span><span class="s4">'binom'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s3">None,</span>
                                        <span class="s1">continuity=</span><span class="s5">2</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

        <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.0889</span><span class="s3">, </span><span class="s5">0.2356</span><span class="s3">, </span><span class="s5">0.3517</span><span class="s3">, </span><span class="s5">0.4457</span><span class="s3">,</span>
                              <span class="s5">0.6154</span><span class="s3">, </span><span class="s5">0.6674</span><span class="s3">, </span><span class="s5">0.7708</span><span class="s1">])</span>
        <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
        <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">False,</span>
                                        <span class="s1">dist=</span><span class="s4">'binom'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s5">0.5</span><span class="s3">,</span>
                                        <span class="s1">critval_continuity=</span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

        <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.0889</span><span class="s3">, </span><span class="s5">0.2356</span><span class="s3">, </span><span class="s5">0.3517</span><span class="s3">, </span><span class="s5">0.4457</span><span class="s3">,</span>
                              <span class="s5">0.6154</span><span class="s3">, </span><span class="s5">0.6674</span><span class="s3">, </span><span class="s5">0.7112</span><span class="s1">])</span>
        <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
        <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_ztost():</span>
    <span class="s1">xfair = np.repeat([</span><span class="s5">1</span><span class="s3">, </span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[</span><span class="s5">228</span><span class="s3">, </span><span class="s5">762</span><span class="s1">-</span><span class="s5">228</span><span class="s1">])</span>

    <span class="s0"># comparing to SAS last output at</span>
    <span class="s0"># http://support.sas.com/documentation/cdl/en/procstat/63104/HTML/default/viewer.htm#procstat_freq_sect028.htm</span>
    <span class="s0"># confidence interval for tost</span>
    <span class="s0"># generic ztost is moved to weightstats</span>
    <span class="s3">from </span><span class="s1">statsmodels.stats.weightstats </span><span class="s3">import </span><span class="s1">zconfint</span><span class="s3">, </span><span class="s1">ztost</span>
    <span class="s1">ci01 = zconfint(xfair</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.1</span><span class="s3">, </span><span class="s1">ddof=</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(ci01</span><span class="s3">,  </span><span class="s1">[</span><span class="s5">0.2719</span><span class="s3">, </span><span class="s5">0.3265</span><span class="s1">]</span><span class="s3">, </span><span class="s5">4</span><span class="s1">)</span>
    <span class="s1">res = ztost(xfair</span><span class="s3">, </span><span class="s5">0.18</span><span class="s3">, </span><span class="s5">0.38</span><span class="s3">, </span><span class="s1">ddof=</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_almost_equal(res[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s5">7.1865</span><span class="s3">, </span><span class="s5">4</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res[</span><span class="s5">2</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">-</span><span class="s5">4.8701</span><span class="s3">, </span><span class="s5">4</span><span class="s1">)</span>
    <span class="s1">assert_array_less(res[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s5">0.0001</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_power_ztost_prop_norm():</span>
    <span class="s0"># regression test for normal distribution</span>
    <span class="s0"># from a rough comparison, the results and variations look reasonable</span>
    <span class="s3">with </span><span class="s1">pytest.warns(HypothesisTestWarning):</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">False,</span>
                                        <span class="s1">dist=</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s5">0.5</span><span class="s3">,</span>
                                        <span class="s1">continuity=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">0</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.11450013</span><span class="s3">, </span><span class="s5">0.27752006</span><span class="s3">, </span><span class="s5">0.41495922</span><span class="s3">,</span>
                          <span class="s5">0.52944621</span><span class="s3">, </span><span class="s5">0.62382638</span><span class="s3">, </span><span class="s5">0.70092914</span><span class="s3">, </span><span class="s5">0.76341806</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

    <span class="s0"># regression test for normal distribution</span>
    <span class="s3">with </span><span class="s1">pytest.warns(HypothesisTestWarning):</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">False,</span>
                                        <span class="s1">dist=</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s5">0.5</span><span class="s3">,</span>
                                        <span class="s1">continuity=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">0</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.02667562</span><span class="s3">, </span><span class="s5">0.20189793</span><span class="s3">, </span><span class="s5">0.35099606</span><span class="s3">,</span>
                          <span class="s5">0.47608598</span><span class="s3">, </span><span class="s5">0.57981118</span><span class="s3">, </span><span class="s5">0.66496683</span><span class="s3">, </span><span class="s5">0.73427591</span><span class="s3">,</span>
                          <span class="s5">0.79026127</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

    <span class="s0"># regression test for normal distribution</span>
    <span class="s3">with </span><span class="s1">pytest.warns(HypothesisTestWarning):</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">True,</span>
                                        <span class="s1">dist=</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s5">0.5</span><span class="s3">,</span>
                                        <span class="s1">continuity=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">0</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.08902071</span><span class="s3">, </span><span class="s5">0.23582284</span><span class="s3">, </span><span class="s5">0.35192313</span><span class="s3">,</span>
                          <span class="s5">0.55312718</span><span class="s3">, </span><span class="s5">0.61549537</span><span class="s3">, </span><span class="s5">0.66743625</span><span class="s3">, </span><span class="s5">0.77066806</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

    <span class="s0"># regression test for normal distribution</span>
    <span class="s3">with </span><span class="s1">pytest.warns(HypothesisTestWarning):</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">True,</span>
                                        <span class="s1">dist=</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s5">0.5</span><span class="s3">,</span>
                                        <span class="s1">continuity=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">1</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.08902071</span><span class="s3">, </span><span class="s5">0.23582284</span><span class="s3">, </span><span class="s5">0.35192313</span><span class="s3">,</span>
                          <span class="s5">0.44588687</span><span class="s3">, </span><span class="s5">0.61549537</span><span class="s3">, </span><span class="s5">0.66743625</span><span class="s3">, </span><span class="s5">0.71115563</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>

    <span class="s0"># regression test for normal distribution</span>
    <span class="s3">with </span><span class="s1">pytest.warns(HypothesisTestWarning):</span>
        <span class="s1">power = smprop.power_ztost_prop(</span><span class="s5">0.4</span><span class="s3">, </span><span class="s5">0.6</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">20</span><span class="s3">, </span><span class="s5">210</span><span class="s3">, </span><span class="s5">20</span><span class="s1">)</span><span class="s3">,</span>
                                        <span class="s1">p_alt=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">discrete=</span><span class="s3">True,</span>
                                        <span class="s1">dist=</span><span class="s4">'norm'</span><span class="s3">, </span><span class="s1">variance_prop=</span><span class="s3">None,</span>
                                        <span class="s1">continuity=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">critval_continuity=</span><span class="s5">0</span><span class="s1">)[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">res_power = np.array([</span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.</span><span class="s3">, </span><span class="s5">0.15851942</span><span class="s3">, </span><span class="s5">0.41611758</span><span class="s3">,</span>
                          <span class="s5">0.5010377</span><span class="s3">, </span><span class="s5">0.5708047</span><span class="s3">, </span><span class="s5">0.70328247</span><span class="s3">, </span><span class="s5">0.74210096</span><span class="s1">])</span>
    <span class="s0"># TODO: I currently do not impose power&gt;=0, i.e np.maximum(power, 0)</span>
    <span class="s1">assert_almost_equal(np.maximum(power</span><span class="s3">, </span><span class="s5">0</span><span class="s1">)</span><span class="s3">, </span><span class="s1">res_power</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">4</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_proportion_ztests():</span>
    <span class="s0"># currently only consistency test with proportions chisquare</span>
    <span class="s0"># Note: alternative handling is generic</span>

    <span class="s1">res1 = smprop.proportions_ztest(</span><span class="s5">15</span><span class="s3">, </span><span class="s5">20.</span><span class="s3">, </span><span class="s1">value=</span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">prop_var=</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">res2 = smprop.proportions_chisquare(</span><span class="s5">15</span><span class="s3">, </span><span class="s5">20.</span><span class="s3">, </span><span class="s1">value=</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res1[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

    <span class="s1">res1 = smprop.proportions_ztest(np.asarray([</span><span class="s5">15</span><span class="s3">, </span><span class="s5">10</span><span class="s1">])</span><span class="s3">,</span>
                                    <span class="s1">np.asarray([</span><span class="s5">20.</span><span class="s3">, </span><span class="s5">20</span><span class="s1">])</span><span class="s3">,</span>
                                    <span class="s1">value=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">prop_var=</span><span class="s3">None</span><span class="s1">)</span>
    <span class="s1">res2 = smprop.proportions_chisquare(np.asarray([</span><span class="s5">15</span><span class="s3">, </span><span class="s5">10</span><span class="s1">])</span><span class="s3">,</span>
                                        <span class="s1">np.asarray([</span><span class="s5">20.</span><span class="s3">, </span><span class="s5">20</span><span class="s1">]))</span>
    <span class="s0"># test only p-value</span>
    <span class="s1">assert_almost_equal(res1[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>

    <span class="s0"># test with integers, issue #7603</span>
    <span class="s1">res1 = smprop.proportions_ztest(np.asarray([</span><span class="s5">15</span><span class="s3">, </span><span class="s5">10</span><span class="s1">])</span><span class="s3">,</span>
                                    <span class="s1">np.asarray([</span><span class="s5">20</span><span class="s3">, </span><span class="s5">50000</span><span class="s1">])</span><span class="s3">,</span>
                                    <span class="s1">value=</span><span class="s5">0</span><span class="s3">, </span><span class="s1">prop_var=</span><span class="s3">None</span><span class="s1">)</span>
    <span class="s1">res2 = smprop.proportions_chisquare(np.asarray([</span><span class="s5">15</span><span class="s3">, </span><span class="s5">10</span><span class="s1">])</span><span class="s3">,</span>
                                        <span class="s1">np.asarray([</span><span class="s5">20</span><span class="s3">, </span><span class="s5">50000</span><span class="s1">]))</span>
    <span class="s0"># test only p-value</span>
    <span class="s1">assert_almost_equal(res1[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">res2[</span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s5">13</span><span class="s1">)</span>
    <span class="s1">assert_array_less(</span><span class="s5">0</span><span class="s3">, </span><span class="s1">res2[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">])  </span><span class="s0"># expected should be positive</span>


<span class="s3">def </span><span class="s1">test_confint_2indep():</span>
    <span class="s0"># alpha = 0.05</span>
    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1 = </span><span class="s5">7</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">34</span>

    <span class="s0"># result tables from Fagerland et al 2015</span>
    <span class="s4">''' 
    diff: 
    Wald 0.029 0.32 0.29 
    AgrestiCaffo 0.012 0.32 0.31 
    Newcombe hybrid score 0.019 0.34 0.32 
    MiettinenNurminen asymptotic score 0.028 0.34 0.31 
    SantnerSnell exact unconditional -0.069 0.41 0.48 
    ChanZhang exact unconditional 0.019 0.36 0.34 
    AgrestiMin exact unconditional 0.024 0.35 0.33 
 
    ratio: 
    Katz log 0.91 54 4.08 
    Adjusted log 0.92 27 3.38 
    Inverse sinh 1.17 42 3.58 
    Koopman asymptotic score 1.21 43 3.57 
    ChanZhang 1.22 181 5.00 
    AgrestiMin 1.15 89 4.35 
 
    odds-ratio 
    Woolf logit 0.99 74 4.31 
    Gart adjusted logit 0.98 38 3.65 
    Independence-smoothed logit 0.99 60 4.11 
    Cornfield exact conditional 0.97 397 6.01 
    Cornfield mid-p 1.19 200 5.12 
    BaptistaPike exact conditional 1.00 195 5.28 
    BaptistaPike mid-p 1.33 99 4.31 
    AgrestiMin exact unconditional 1.19 72 4.10 
    '''  </span><span class="s0"># pylint: disable=W0105</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'newcomb'</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s0"># one decimal to upp added from regression result</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.019</span><span class="s3">, </span><span class="s5">0.340</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.005</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'wald'</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.029</span><span class="s3">, </span><span class="s5">0.324</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.005</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'agresti-caffo'</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.012</span><span class="s3">, </span><span class="s5">0.322</span><span class="s1">]</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.005</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'diff'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'score'</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.028</span><span class="s3">, </span><span class="s5">0.343</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.03</span><span class="s1">)</span>

    <span class="s0"># ratio</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'ratio'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'log'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.91</span><span class="s3">, </span><span class="s5">54</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'ratio'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'log-adjusted'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.92</span><span class="s3">, </span><span class="s5">27</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'ratio'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'score'</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">1.21</span><span class="s3">, </span><span class="s5">43</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>

    <span class="s0"># odds-ratio</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'or'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'logit'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">74</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'or'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'logit-adjusted'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.98</span><span class="s3">, </span><span class="s5">38</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'or'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'logit-smoothed'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">0.99</span><span class="s3">, </span><span class="s5">60</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>
    <span class="s1">ci = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                    <span class="s1">compare=</span><span class="s4">'odds-ratio'</span><span class="s3">,</span>
                                    <span class="s1">method=</span><span class="s4">'score'</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s0"># regression test</span>
    <span class="s1">assert_allclose(ci</span><span class="s3">, </span><span class="s1">[</span><span class="s5">1.246622</span><span class="s3">, </span><span class="s5">56.461576</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">0.01</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_confint_2indep_propcis():</span>
    <span class="s0"># unit tests compared to R package PropCis</span>
    <span class="s0"># alpha = 0.05</span>
    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1 = </span><span class="s5">7</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">34</span>

    <span class="s0"># &gt; library(PropCIs)</span>
    <span class="s0"># &gt; diffscoreci(7, 34, 1, 34, 0.95)</span>
    <span class="s1">ci = </span><span class="s5">0.0270416</span><span class="s3">, </span><span class="s5">0.3452912</span>
    <span class="s1">ci1 = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                     <span class="s1">compare=</span><span class="s4">&quot;diff&quot;</span><span class="s3">,</span>
                                     <span class="s1">method=</span><span class="s4">&quot;score&quot;</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci1</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.002</span><span class="s1">)  </span><span class="s0"># lower agreement (iterative)</span>
    <span class="s0"># &gt; wald2ci(7, 34, 1, 34, 0.95, adjust=&quot;AC&quot;)</span>
    <span class="s1">ci = </span><span class="s5">0.01161167</span><span class="s3">, </span><span class="s5">0.32172166</span>
    <span class="s1">ci1 = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                     <span class="s1">compare=</span><span class="s4">&quot;diff&quot;</span><span class="s3">,</span>
                                     <span class="s1">method=</span><span class="s4">&quot;agresti-caffo&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci1</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-7</span><span class="s1">)</span>
    <span class="s0"># &gt; wald2ci(7, 34, 1, 34, 0.95, adjust=&quot;Wald&quot;)</span>
    <span class="s1">ci = </span><span class="s5">0.02916942</span><span class="s3">, </span><span class="s5">0.32377176</span>
    <span class="s1">ci1 = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                     <span class="s1">compare=</span><span class="s4">&quot;diff&quot;</span><span class="s3">,</span>
                                     <span class="s1">method=</span><span class="s4">&quot;wald&quot;</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci1</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-7</span><span class="s1">)</span>

    <span class="s0"># &gt; orscoreci(7, 34, 1, 34, 0.95)</span>
    <span class="s1">ci = </span><span class="s5">1.246309</span><span class="s3">, </span><span class="s5">56.486130</span>
    <span class="s1">ci1 = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                     <span class="s1">compare=</span><span class="s4">&quot;odds-ratio&quot;</span><span class="s3">,</span>
                                     <span class="s1">method=</span><span class="s4">&quot;score&quot;</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci1</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">5e-4</span><span class="s1">)  </span><span class="s0"># lower agreement (iterative)</span>

    <span class="s0"># &gt; riskscoreci(7, 34, 1, 34, 0.95)</span>
    <span class="s1">ci = </span><span class="s5">1.220853</span><span class="s3">, </span><span class="s5">42.575718</span>
    <span class="s1">ci1 = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                     <span class="s1">compare=</span><span class="s4">&quot;ratio&quot;</span><span class="s3">,</span>
                                     <span class="s1">method=</span><span class="s4">&quot;score&quot;</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(ci1</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">6e-7</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_score_test_2indep():</span>
    <span class="s0"># this does not verify the statistic and pvalue yet</span>
    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1 = </span><span class="s5">7</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">34</span>

    <span class="s3">for </span><span class="s1">co </span><span class="s3">in </span><span class="s1">[</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'or'</span><span class="s1">]:</span>
        <span class="s1">res = score_test_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                            <span class="s1">compare=co)</span>
        <span class="s1">assert_allclose(res.prop1_null</span><span class="s3">, </span><span class="s1">res.prop2_null</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># check that equality case is handled</span>
        <span class="s1">val = </span><span class="s5">0 </span><span class="s3">if </span><span class="s1">co == </span><span class="s4">'diff' </span><span class="s3">else </span><span class="s5">1.</span>
        <span class="s1">s0</span><span class="s3">, </span><span class="s1">pv0 = score_test_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                                <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">value=val</span><span class="s3">,</span>
                                                <span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)[:</span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">s1</span><span class="s3">, </span><span class="s1">pv1 = score_test_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                                <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">value=val + </span><span class="s5">1e-10</span><span class="s3">,</span>
                                                <span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)[:</span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">assert_allclose(s0</span><span class="s3">, </span><span class="s1">s1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv0</span><span class="s3">, </span><span class="s1">pv1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">s1</span><span class="s3">, </span><span class="s1">pv1 = score_test_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                                <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">value=val - </span><span class="s5">1e-10</span><span class="s3">,</span>
                                                <span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)[:</span><span class="s5">2</span><span class="s1">]</span>
        <span class="s1">assert_allclose(s0</span><span class="s3">, </span><span class="s1">s1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv0</span><span class="s3">, </span><span class="s1">pv1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-8</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_test_2indep():</span>
    <span class="s0"># this checks the pvalue of the hypothesis test at value equal to the</span>
    <span class="s0"># confidence limit</span>
    <span class="s1">alpha = </span><span class="s5">0.05</span>
    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1 = </span><span class="s5">7</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">34</span>

    <span class="s1">methods_both = [</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'agresti-caffo'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s0"># ('diff', 'newcomb'),  # only confint</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'wald'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'log'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'log-adjusted'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit-adjusted'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit-smoothed'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">]</span>

    <span class="s3">for </span><span class="s1">co</span><span class="s3">, </span><span class="s1">method </span><span class="s3">in </span><span class="s1">methods_both:</span>
        <span class="s1">low</span><span class="s3">, </span><span class="s1">upp = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                              <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">method=method</span><span class="s3">,</span>
                                              <span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s1">res = smprop.test_proportions_2indep(</span>
                <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">value=low</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">res = smprop.test_proportions_2indep(</span>
                <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">value=upp</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">_</span><span class="s3">, </span><span class="s1">pv = smprop.test_proportions_2indep(</span>
                    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">value=upp</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                    <span class="s1">method=method</span><span class="s3">, </span><span class="s1">alternative=</span><span class="s4">'smaller'</span><span class="s3">,</span>
                    <span class="s1">correction=</span><span class="s3">False, </span><span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">alpha / </span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">_</span><span class="s3">, </span><span class="s1">pv = smprop.test_proportions_2indep(</span>
                    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">value=low</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                    <span class="s1">method=method</span><span class="s3">, </span><span class="s1">alternative=</span><span class="s4">'larger'</span><span class="s3">,</span>
                    <span class="s1">correction=</span><span class="s3">False, </span><span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(pv</span><span class="s3">, </span><span class="s1">alpha / </span><span class="s5">2</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

    <span class="s0"># test Miettinen/Nurminen small sample correction</span>
    <span class="s1">co</span><span class="s3">, </span><span class="s1">method = </span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'score'</span>
    <span class="s1">low</span><span class="s3">, </span><span class="s1">upp = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                          <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">method=method</span><span class="s3">,</span>
                                          <span class="s1">alpha=alpha</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>

    <span class="s1">res = smprop.test_proportions_2indep(</span>
            <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">value=low</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
            <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_equivalence_2indep():</span>
    <span class="s0"># this checks the pvalue of the equivalence test at value equal to the</span>
    <span class="s0"># confidence limit</span>
    <span class="s1">alpha = </span><span class="s5">0.05</span>
    <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1 = </span><span class="s5">7</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2 = </span><span class="s5">1</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count1v</span><span class="s3">, </span><span class="s1">nobs1v = [</span><span class="s5">7</span><span class="s3">, </span><span class="s5">1</span><span class="s1">]</span><span class="s3">, </span><span class="s5">34</span>
    <span class="s1">count2v</span><span class="s3">, </span><span class="s1">nobs2v = [</span><span class="s5">1</span><span class="s3">, </span><span class="s5">7</span><span class="s1">]</span><span class="s3">, </span><span class="s5">34</span>

    <span class="s1">methods_both = [</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'agresti-caffo'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s0"># ('diff', 'newcomb'),  # only confint</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'diff'</span><span class="s3">, </span><span class="s4">'wald'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'log'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'log-adjusted'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'ratio'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit-adjusted'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'logit-smoothed'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">(</span><span class="s4">'odds-ratio'</span><span class="s3">, </span><span class="s4">'score'</span><span class="s1">)</span><span class="s3">,</span>
                    <span class="s1">]</span>

    <span class="s3">for </span><span class="s1">co</span><span class="s3">, </span><span class="s1">method </span><span class="s3">in </span><span class="s1">methods_both:</span>
        <span class="s1">low</span><span class="s3">, </span><span class="s1">upp = confint_proportions_2indep(count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">,</span>
                                              <span class="s1">compare=co</span><span class="s3">, </span><span class="s1">method=method</span><span class="s3">,</span>
                                              <span class="s1">alpha=</span><span class="s5">2 </span><span class="s1">* alpha</span><span class="s3">,</span>
                                              <span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s0"># Note: test should have only one margin at confint</span>
        <span class="s1">res = smprop.tost_proportions_2indep(</span>
                <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">low</span><span class="s3">, </span><span class="s1">upp * </span><span class="s5">1.05</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">res = smprop.tost_proportions_2indep(</span>
                <span class="s1">count1</span><span class="s3">, </span><span class="s1">nobs1</span><span class="s3">, </span><span class="s1">count2</span><span class="s3">, </span><span class="s1">nobs2</span><span class="s3">, </span><span class="s1">low * </span><span class="s5">0.95</span><span class="s3">, </span><span class="s1">upp</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s0"># vectorized</span>
        <span class="s3">if </span><span class="s1">method == </span><span class="s4">'logit-smoothed'</span><span class="s1">:</span>
            <span class="s0"># not correctly vectorized</span>
            <span class="s3">return</span>
        <span class="s1">res1 = res  </span><span class="s0"># for debugging  # noqa</span>
        <span class="s1">res = smprop.tost_proportions_2indep(</span>
                <span class="s1">count1v</span><span class="s3">, </span><span class="s1">nobs1v</span><span class="s3">, </span><span class="s1">count2v</span><span class="s3">, </span><span class="s1">nobs2v</span><span class="s3">, </span><span class="s1">low * </span><span class="s5">0.95</span><span class="s3">, </span><span class="s1">upp</span><span class="s3">, </span><span class="s1">compare=co</span><span class="s3">,</span>
                <span class="s1">method=method</span><span class="s3">, </span><span class="s1">correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.pvalue[</span><span class="s5">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">alpha</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-10</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_score_confint_koopman_nam():</span>

    <span class="s0"># example Koopman, based on Nam 1995</span>

    <span class="s1">x0</span><span class="s3">, </span><span class="s1">n0 = </span><span class="s5">16</span><span class="s3">, </span><span class="s5">80</span>
    <span class="s1">x1</span><span class="s3">, </span><span class="s1">n1 = </span><span class="s5">36</span><span class="s3">, </span><span class="s5">40</span>
    <span class="s0"># x = x0 + x1</span>
    <span class="s0"># n = n0 + n1</span>
    <span class="s0"># p0 = x0 / n0</span>
    <span class="s0"># p1 = x1 / n1</span>

    <span class="s1">results_nam = Holder()</span>
    <span class="s1">results_nam.p0_roots = [</span><span class="s5">0.1278</span><span class="s3">, </span><span class="s5">0.2939</span><span class="s3">, </span><span class="s5">0.4876</span><span class="s1">]</span>
    <span class="s1">results_nam.conf_int = [</span><span class="s5">2.940</span><span class="s3">, </span><span class="s5">7.152</span><span class="s1">]</span>

    <span class="s1">res = smprop._confint_riskratio_koopman(x1</span><span class="s3">, </span><span class="s1">n1</span><span class="s3">, </span><span class="s1">x0</span><span class="s3">, </span><span class="s1">n0</span><span class="s3">,  </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>

    <span class="s1">assert_allclose(res._p_roots</span><span class="s3">, </span><span class="s1">results_nam.p0_roots</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.confint</span><span class="s3">, </span><span class="s1">results_nam.conf_int</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">3</span><span class="s1">)</span>

    <span class="s1">table = [</span><span class="s5">67</span><span class="s3">, </span><span class="s5">9</span><span class="s3">, </span><span class="s5">7</span><span class="s3">, </span><span class="s5">16</span><span class="s1">]  </span><span class="s0"># [67, 7, 9, 16]</span>
    <span class="s1">resp = smprop._confint_riskratio_paired_nam(table</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s0"># TODO: currently regression test, need verified results</span>
    <span class="s1">ci_old = [</span><span class="s5">0.917832</span><span class="s3">,  </span><span class="s5">1.154177</span><span class="s1">]</span>
    <span class="s1">assert_allclose(resp.confint</span><span class="s3">, </span><span class="s1">ci_old</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">3</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_power_2indep():</span>
    <span class="s0"># test against R</span>
    <span class="s1">pow_ = power_proportions_2indep(-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">76.70692</span><span class="s1">)</span>
    <span class="s1">assert_allclose(pow_.power</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>

    <span class="s1">n = samplesize_proportions_2indep_onetail(-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s1">ratio=</span><span class="s5">1</span><span class="s3">,</span>
                                              <span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">value=</span><span class="s5">0</span><span class="s3">,</span>
                                              <span class="s1">alternative=</span><span class="s4">'two-sided'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(n</span><span class="s3">, </span><span class="s5">76.70692</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-5</span><span class="s1">)</span>

    <span class="s1">power_proportions_2indep(-</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.75</span><span class="s3">, </span><span class="s5">62.33551</span><span class="s3">, </span><span class="s1">alternative=</span><span class="s4">&quot;smaller&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(pow_.power</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>

    <span class="s1">pow_ = power_proportions_2indep(</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">62.33551</span><span class="s3">, </span><span class="s1">alternative=</span><span class="s4">&quot;smaller&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_less(pow_.power</span><span class="s3">, </span><span class="s5">0.05</span><span class="s1">)</span>

    <span class="s1">pow_ = power_proportions_2indep(</span><span class="s5">0.25</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s5">62.33551</span><span class="s3">, </span><span class="s1">alternative=</span><span class="s4">&quot;larger&quot;</span><span class="s3">,</span>
                                    <span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s5">0.9</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>

    <span class="s1">pow_ = power_proportions_2indep(-</span><span class="s5">0.15</span><span class="s3">, </span><span class="s5">0.65</span><span class="s3">, </span><span class="s5">83.4373</span><span class="s3">, </span><span class="s1">return_results=</span><span class="s3">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(pow_</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>

    <span class="s1">n = samplesize_proportions_2indep_onetail(-</span><span class="s5">0.15</span><span class="s3">, </span><span class="s5">0.65</span><span class="s3">, </span><span class="s5">0.5</span><span class="s3">, </span><span class="s1">ratio=</span><span class="s5">1</span><span class="s3">,</span>
                                              <span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">value=</span><span class="s5">0</span><span class="s3">,</span>
                                              <span class="s1">alternative=</span><span class="s4">'two-sided'</span><span class="s1">)</span>

    <span class="s1">assert_allclose(n</span><span class="s3">, </span><span class="s5">83.4373</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.05</span><span class="s1">)</span>

    <span class="s0"># Stata example</span>
    <span class="s3">from </span><span class="s1">statsmodels.stats.power </span><span class="s3">import </span><span class="s1">normal_sample_size_one_tail</span>
    <span class="s1">res = power_proportions_2indep(-</span><span class="s5">0.014</span><span class="s3">, </span><span class="s5">0.015</span><span class="s3">, </span><span class="s5">550</span><span class="s3">, </span><span class="s1">ratio=</span><span class="s5">1.</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.power</span><span class="s3">, </span><span class="s5">0.7415600</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-7</span><span class="s1">)</span>
    <span class="s1">n = normal_sample_size_one_tail(-</span><span class="s5">0.014</span><span class="s3">, </span><span class="s5">0.7415600</span><span class="s3">, </span><span class="s5">0.05 </span><span class="s1">/ </span><span class="s5">2</span><span class="s3">,</span>
                                    <span class="s1">std_null=res.std_null</span><span class="s3">,</span>
                                    <span class="s1">std_alternative=res.std_alt)</span>
    <span class="s1">assert_allclose(n</span><span class="s3">, </span><span class="s5">550</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">0.05</span><span class="s1">)</span>
    <span class="s1">n2 = samplesize_proportions_2indep_onetail(-</span><span class="s5">0.014</span><span class="s3">, </span><span class="s5">0.015</span><span class="s3">, </span><span class="s5">0.7415600</span><span class="s3">,</span>
                                               <span class="s1">ratio=</span><span class="s5">1</span><span class="s3">, </span><span class="s1">alpha=</span><span class="s5">0.05</span><span class="s3">, </span><span class="s1">value=</span><span class="s5">0</span><span class="s3">,</span>
                                               <span class="s1">alternative=</span><span class="s4">'two-sided'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(n2</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

    <span class="s0"># with nobs ratio != 1</span>
    <span class="s0"># note Stata has reversed ratio compared to ours, see #8049</span>
    <span class="s1">pwr_st = </span><span class="s5">0.7995659211532175</span>
    <span class="s1">n = </span><span class="s5">154</span>
    <span class="s1">res = power_proportions_2indep(-</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">ratio=</span><span class="s5">2.</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.power</span><span class="s3">, </span><span class="s1">pwr_st</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-7</span><span class="s1">)</span>

    <span class="s1">n2 = samplesize_proportions_2indep_onetail(-</span><span class="s5">0.1</span><span class="s3">, </span><span class="s5">0.2</span><span class="s3">, </span><span class="s1">pwr_st</span><span class="s3">, </span><span class="s1">ratio=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_allclose(n2</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-4</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;count&quot;</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">90</span><span class="s3">, </span><span class="s5">5</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;method&quot;</span><span class="s3">, </span><span class="s1">list(probci_methods.keys()) + [</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;array_like&quot;</span><span class="s3">, </span><span class="s1">[</span><span class="s3">False, True</span><span class="s1">])</span>
<span class="s3">def </span><span class="s1">test_ci_symmetry(count</span><span class="s3">, </span><span class="s1">method</span><span class="s3">, </span><span class="s1">array_like):</span>
    <span class="s1">_count = [count] * </span><span class="s5">3 </span><span class="s3">if </span><span class="s1">array_like </span><span class="s3">else </span><span class="s1">count</span>
    <span class="s1">n = </span><span class="s5">100</span>
    <span class="s1">a = proportion_confint(count</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">b = proportion_confint(n - count</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">assert_allclose(np.array(a)</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s1">- np.array(b[::-</span><span class="s5">1</span><span class="s1">]))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;nobs&quot;</span><span class="s3">, </span><span class="s1">[</span><span class="s5">47</span><span class="s3">, </span><span class="s5">50</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;count&quot;</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">48</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;array_like&quot;</span><span class="s3">, </span><span class="s1">[</span><span class="s3">False, True</span><span class="s1">])</span>
<span class="s3">def </span><span class="s1">test_ci_symmetry_binom_test(nobs</span><span class="s3">, </span><span class="s1">count</span><span class="s3">, </span><span class="s1">array_like):</span>
    <span class="s1">_count = [count] * </span><span class="s5">3 </span><span class="s3">if </span><span class="s1">array_like </span><span class="s3">else </span><span class="s1">count</span>
    <span class="s1">nobs_m_count = [nobs - count] * </span><span class="s5">3 </span><span class="s3">if </span><span class="s1">array_like </span><span class="s3">else </span><span class="s1">nobs - count</span>
    <span class="s1">a = proportion_confint(_count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s1">b = proportion_confint(nobs_m_count</span><span class="s3">, </span><span class="s1">nobs</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(np.array(a)</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s1">- np.array(b[::-</span><span class="s5">1</span><span class="s1">]))</span>


<span class="s3">def </span><span class="s1">test_int_check():</span>
    <span class="s0"># integer values are required only if method=&quot;binom_test&quot;</span>
    <span class="s3">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">proportion_confint(</span><span class="s5">10.5</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s3">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">proportion_confint(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">20.5</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s3">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">proportion_confint(np.array([</span><span class="s5">10.3</span><span class="s1">])</span><span class="s3">, </span><span class="s5">20</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>

    <span class="s1">a = proportion_confint(</span><span class="s5">21.0</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s1">b = proportion_confint(</span><span class="s5">21</span><span class="s3">, </span><span class="s5">47</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s1">c = proportion_confint(</span><span class="s5">21</span><span class="s3">, </span><span class="s5">47.0</span><span class="s3">, </span><span class="s1">method=</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">b)</span>
    <span class="s1">assert_allclose(a</span><span class="s3">, </span><span class="s1">c)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;count&quot;</span><span class="s3">, </span><span class="s1">np.arange(</span><span class="s5">10</span><span class="s3">, </span><span class="s5">90</span><span class="s3">, </span><span class="s5">5</span><span class="s1">))</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;method&quot;</span><span class="s3">, </span><span class="s1">list(probci_methods.keys()) + [</span><span class="s4">&quot;binom_test&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s3">def </span><span class="s1">test_ci_symmetry_array(count</span><span class="s3">, </span><span class="s1">method):</span>
    <span class="s1">n = </span><span class="s5">100</span>
    <span class="s1">a = proportion_confint([count</span><span class="s3">, </span><span class="s1">count]</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">b = proportion_confint([n - count</span><span class="s3">, </span><span class="s1">n - count]</span><span class="s3">, </span><span class="s1">n</span><span class="s3">, </span><span class="s1">method=method)</span>
    <span class="s1">assert_allclose(np.array(a)</span><span class="s3">, </span><span class="s5">1.0 </span><span class="s1">- np.array(b[::-</span><span class="s5">1</span><span class="s1">]))</span>
</pre>
</body>
</html>