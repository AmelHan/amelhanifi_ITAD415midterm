<html>
<head>
<title>test_column_transformer.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_column_transformer.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Test the ColumnTransformer. 
&quot;&quot;&quot;</span>
<span class="s2">import </span><span class="s1">pickle</span>
<span class="s2">import </span><span class="s1">re</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">assert_allclose</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">sparse</span>

<span class="s2">from </span><span class="s1">sklearn.base </span><span class="s2">import </span><span class="s1">BaseEstimator</span><span class="s2">, </span><span class="s1">TransformerMixin</span>
<span class="s2">from </span><span class="s1">sklearn.compose </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">ColumnTransformer</span><span class="s2">,</span>
    <span class="s1">make_column_selector</span><span class="s2">,</span>
    <span class="s1">make_column_transformer</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">sklearn.exceptions </span><span class="s2">import </span><span class="s1">NotFittedError</span>
<span class="s2">from </span><span class="s1">sklearn.feature_selection </span><span class="s2">import </span><span class="s1">VarianceThreshold</span>
<span class="s2">from </span><span class="s1">sklearn.preprocessing </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">FunctionTransformer</span><span class="s2">,</span>
    <span class="s1">Normalizer</span><span class="s2">,</span>
    <span class="s1">OneHotEncoder</span><span class="s2">,</span>
    <span class="s1">StandardScaler</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">sklearn.utils._testing </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">assert_allclose_dense_sparse</span><span class="s2">,</span>
    <span class="s1">assert_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
<span class="s1">)</span>


<span class="s2">class </span><span class="s1">Trans(TransformerMixin</span><span class="s2">, </span><span class="s1">BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s3"># 1D Series -&gt; 2D DataFrame</span>
        <span class="s2">if </span><span class="s1">hasattr(X</span><span class="s2">, </span><span class="s4">&quot;to_frame&quot;</span><span class="s1">):</span>
            <span class="s2">return </span><span class="s1">X.to_frame()</span>
        <span class="s3"># 1D array -&gt; 2D array</span>
        <span class="s2">if </span><span class="s1">X.ndim == </span><span class="s5">1</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">np.atleast_2d(X).T</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">DoubleTrans(BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X):</span>
        <span class="s2">return </span><span class="s5">2 </span><span class="s1">* X</span>


<span class="s2">class </span><span class="s1">SparseMatrixTrans(BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">n_samples = len(X)</span>
        <span class="s2">return </span><span class="s1">sparse.eye(n_samples</span><span class="s2">, </span><span class="s1">n_samples).tocsr()</span>


<span class="s2">class </span><span class="s1">TransNo2D(BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">return </span><span class="s1">X</span>


<span class="s2">class </span><span class="s1">TransRaise(BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">&quot;specific message&quot;</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">&quot;specific message&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>

    <span class="s1">X_res_first1D = np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>
    <span class="s1">X_res_second1D = np.array([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">])</span>
    <span class="s1">X_res_first = X_res_first1D.reshape(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s1">cases = [</span>
        <span class="s3"># single column 1D / 2D</span>
        <span class="s1">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s3"># list-like</span>
        <span class="s1">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s1">(np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># slice</span>
        <span class="s1">(slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">(slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># boolean mask</span>
        <span class="s1">(np.array([</span><span class="s2">True, False</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s2">True, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">(np.array([</span><span class="s2">True, True</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s2">True, True</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
    <span class="s1">]</span>

    <span class="s2">for </span><span class="s1">selection</span><span class="s2">, </span><span class="s1">res </span><span class="s2">in </span><span class="s1">cases:</span>
        <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">selection)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>
        <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>

        <span class="s3"># callable that returns any of the allowed specifiers</span>
        <span class="s1">ct = ColumnTransformer(</span>
            <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, lambda </span><span class="s1">x: selection)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>
        <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>

    <span class="s3"># test with transformer_weights</span>
    <span class="s1">transformer_weights = {</span><span class="s4">&quot;trans1&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">&quot;trans2&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s1">}</span>
    <span class="s1">both = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
        <span class="s1">transformer_weights=transformer_weights</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">res = np.vstack(</span>
        <span class="s1">[</span>
            <span class="s1">transformer_weights[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">] * X_res_first1D</span><span class="s2">,</span>
            <span class="s1">transformer_weights[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">] * X_res_second1D</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">).T</span>
    <span class="s1">assert_array_equal(both.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>
    <span class="s1">assert_array_equal(both.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">res)</span>
    <span class="s2">assert </span><span class="s1">len(both.transformers_) == </span><span class="s5">2</span>

    <span class="s1">both = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">transformer_weights={</span><span class="s4">&quot;trans&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(both.fit_transform(X_array)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s1">assert_array_equal(both.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(both.transformers_) == </span><span class="s5">1</span>


<span class="s2">def </span><span class="s1">test_column_transformer_tuple_transformers_parameter():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>

    <span class="s1">transformers = [(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span>

    <span class="s1">ct_with_list = ColumnTransformer(transformers)</span>
    <span class="s1">ct_with_tuple = ColumnTransformer(tuple(transformers))</span>

    <span class="s1">assert_array_equal(</span>
        <span class="s1">ct_with_list.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">ct_with_tuple.fit_transform(X_array)</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(</span>
        <span class="s1">ct_with_list.fit(X_array).transform(X_array)</span><span class="s2">,</span>
        <span class="s1">ct_with_tuple.fit(X_array).transform(X_array)</span><span class="s2">,</span>
    <span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_dataframe():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_df = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>

    <span class="s1">X_res_first = np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]).reshape(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s1">cases = [</span>
        <span class="s3"># String keys: label based</span>
        <span class="s3"># scalar</span>
        <span class="s1">(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s3"># list</span>
        <span class="s1">([</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># slice</span>
        <span class="s1">(slice(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># int keys: positional</span>
        <span class="s3"># scalar</span>
        <span class="s1">(</span><span class="s5">0</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s3"># list</span>
        <span class="s1">([</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s1">(np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># slice</span>
        <span class="s1">(slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">(slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">X_res_both)</span><span class="s2">,</span>
        <span class="s3"># boolean mask</span>
        <span class="s1">(np.array([</span><span class="s2">True, False</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">(pd.Series([</span><span class="s2">True, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s2">True, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">,</span>
    <span class="s1">]</span>

    <span class="s2">for </span><span class="s1">selection</span><span class="s2">, </span><span class="s1">res </span><span class="s2">in </span><span class="s1">cases:</span>
        <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">selection)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>
        <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>

        <span class="s3"># callable that returns any of the allowed specifiers</span>
        <span class="s1">ct = ColumnTransformer(</span>
            <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, lambda </span><span class="s1">X: selection)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>
        <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s3"># test with transformer_weights</span>
    <span class="s1">transformer_weights = {</span><span class="s4">&quot;trans1&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s2">, </span><span class="s4">&quot;trans2&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s1">}</span>
    <span class="s1">both = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])]</span><span class="s2">,</span>
        <span class="s1">transformer_weights=transformer_weights</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">res = np.vstack(</span>
        <span class="s1">[</span>
            <span class="s1">transformer_weights[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">] * X_df[</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">transformer_weights[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">] * X_df[</span><span class="s4">&quot;second&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">).T</span>
    <span class="s1">assert_array_equal(both.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>
    <span class="s1">assert_array_equal(both.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">res)</span>
    <span class="s2">assert </span><span class="s1">len(both.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">both.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s3"># test multiple columns</span>
    <span class="s1">both = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">transformer_weights={</span><span class="s4">&quot;trans&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(both.fit_transform(X_df)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s1">assert_array_equal(both.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(both.transformers_) == </span><span class="s5">1</span>
    <span class="s2">assert </span><span class="s1">both.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s1">both = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">transformer_weights={</span><span class="s4">&quot;trans&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(both.fit_transform(X_df)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s1">assert_array_equal(both.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s5">0.1 </span><span class="s1">* X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(both.transformers_) == </span><span class="s5">1</span>
    <span class="s2">assert </span><span class="s1">both.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s3"># ensure pandas object is passed through</span>

    <span class="s2">class </span><span class="s1">TransAssert(BaseEstimator):</span>
        <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">expected_type_transform):</span>
            <span class="s1">self.expected_type_transform = expected_type_transform</span>

        <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
            <span class="s2">assert </span><span class="s1">isinstance(X</span><span class="s2">, </span><span class="s1">self.expected_type_transform)</span>
            <span class="s2">if </span><span class="s1">isinstance(X</span><span class="s2">, </span><span class="s1">pd.Series):</span>
                <span class="s1">X = X.to_frame()</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">TransAssert(expected_type_transform=pd.Series)</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit_transform(X_df)</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s4">&quot;trans&quot;</span><span class="s2">,</span>
                <span class="s1">TransAssert(expected_type_transform=pd.DataFrame)</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit_transform(X_df)</span>

    <span class="s3"># integer column spec + integer column names -&gt; still use positional</span>
    <span class="s1">X_df2 = X_df.copy()</span>
    <span class="s1">X_df2.columns = [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_df2)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s1">assert_array_equal(ct.fit(X_df2).transform(X_df2)</span><span class="s2">, </span><span class="s1">X_res_first)</span>

    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;drop&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">]</span><span class="s2">, </span><span class="s1">ids=[</span><span class="s4">&quot;pandas&quot;</span><span class="s2">, </span><span class="s4">&quot;numpy&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;column_selection&quot;</span><span class="s2">,</span>
    <span class="s1">[[]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">False, False</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, False</span><span class="s1">]]</span><span class="s2">,</span>
    <span class="s1">ids=[</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;bool&quot;</span><span class="s2">, </span><span class="s4">&quot;bool_int&quot;</span><span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;callable_column&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_empty_columns(pandas</span><span class="s2">, </span><span class="s1">column_selection</span><span class="s2">, </span><span class="s1">callable_column):</span>
    <span class="s3"># test case that ensures that the column transformer does also work when</span>
    <span class="s3"># a given transformer doesn't have any columns to work on</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s2">if </span><span class="s1">pandas:</span>
        <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
        <span class="s1">X = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">X = X_array</span>

    <span class="s2">if </span><span class="s1">callable_column:</span>
        <span class="s1">column = </span><span class="s2">lambda </span><span class="s1">X: column_selection  </span><span class="s3"># noqa</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">column = column_selection</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">column)]</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X).transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">TransRaise)</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">column)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X).transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">TransRaise)</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">column)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X).transform(X)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2  </span><span class="s3"># including remainder</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">TransRaise)</span>

    <span class="s1">fixture = np.array([[]</span><span class="s2">, </span><span class="s1">[]</span><span class="s2">, </span><span class="s1">[]])</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">column)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X)</span><span class="s2">, </span><span class="s1">fixture)</span>
    <span class="s1">assert_array_equal(ct.fit(X).transform(X)</span><span class="s2">, </span><span class="s1">fixture)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2  </span><span class="s3"># including remainder</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">TransRaise)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_output_indices():</span>
    <span class="s3"># Checks for the output_indices_ attribute</span>
    <span class="s1">X_array = np.arange(</span><span class="s5">6</span><span class="s1">).reshape(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">]])</span>

    <span class="s3"># test with transformer_weights and multiple columns</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">transformer_weights={</span><span class="s4">&quot;trans&quot;</span><span class="s1">: </span><span class="s5">0.1</span><span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span><span class="s4">&quot;trans&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;remainder&quot;</span><span class="s1">]])</span>

    <span class="s3"># test case that ensures that the attribute does also work when</span>
    <span class="s3"># a given transformer doesn't have any columns to work on</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">[])])</span>
    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;remainder&quot;</span><span class="s1">]])</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s1">[])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span><span class="s4">&quot;trans&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">, </span><span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;remainder&quot;</span><span class="s1">]])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_output_indices_df():</span>
    <span class="s3"># Checks for the output_indices_ attribute with data frames</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_df = pd.DataFrame(np.arange(</span><span class="s5">6</span><span class="s1">).reshape(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s1">X_trans = ct.fit_transform(X_df)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;remainder&quot;</span><span class="s1">]])</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">X_trans = ct.fit_transform(X_df)</span>
    <span class="s2">assert </span><span class="s1">ct.output_indices_ == {</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s1">[]]</span><span class="s2">, </span><span class="s1">X_trans[:</span><span class="s2">, </span><span class="s1">ct.output_indices_[</span><span class="s4">&quot;remainder&quot;</span><span class="s1">]])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_sparse_array():</span>
    <span class="s1">X_sparse = sparse.eye(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">).tocsr()</span>

    <span class="s3"># no distinction between 1D and 2D</span>
    <span class="s1">X_res_first = X_sparse[:</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">X_res_both = X_sparse</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)]:</span>
        <span class="s2">for </span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">res </span><span class="s2">in </span><span class="s1">[(</span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">X_res_first)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">X_res_both)]:</span>
            <span class="s1">ct = ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">col)]</span><span class="s2">, </span><span class="s1">remainder=remainder</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">0.8</span>
            <span class="s1">)</span>
            <span class="s2">assert </span><span class="s1">sparse.issparse(ct.fit_transform(X_sparse))</span>
            <span class="s1">assert_allclose_dense_sparse(ct.fit_transform(X_sparse)</span><span class="s2">, </span><span class="s1">res)</span>
            <span class="s1">assert_allclose_dense_sparse(ct.fit(X_sparse).transform(X_sparse)</span><span class="s2">, </span><span class="s1">res)</span>

    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">[[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)]:</span>
        <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">col)]</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">0.8</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">sparse.issparse(ct.fit_transform(X_sparse))</span>
        <span class="s1">assert_allclose_dense_sparse(ct.fit_transform(X_sparse)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
        <span class="s1">assert_allclose_dense_sparse(ct.fit(X_sparse).transform(X_sparse)</span><span class="s2">, </span><span class="s1">X_res_both)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_list():</span>
    <span class="s1">X_list = [[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">float(</span><span class="s4">&quot;nan&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]]</span>
    <span class="s1">expected_result = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">float(</span><span class="s4">&quot;nan&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;numerical&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;categorical&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">assert_array_equal(ct.fit_transform(X_list)</span><span class="s2">, </span><span class="s1">expected_result)</span>
    <span class="s1">assert_array_equal(ct.fit(X_list).transform(X_list)</span><span class="s2">, </span><span class="s1">expected_result)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_sparse_stacking():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">col_trans = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">SparseMatrixTrans()</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">sparse_threshold=</span><span class="s5">0.8</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">col_trans.fit(X_array)</span>
    <span class="s1">X_trans = col_trans.transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">sparse.issparse(X_trans)</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == (X_trans.shape[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_trans.shape[</span><span class="s5">0</span><span class="s1">] + </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_trans.toarray()[:</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">np.eye(X_trans.shape[</span><span class="s5">0</span><span class="s1">]))</span>
    <span class="s2">assert </span><span class="s1">len(col_trans.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">col_trans.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s1">col_trans = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">SparseMatrixTrans()</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)]</span><span class="s2">,</span>
        <span class="s1">sparse_threshold=</span><span class="s5">0.1</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">col_trans.fit(X_array)</span>
    <span class="s1">X_trans = col_trans.transform(X_array)</span>
    <span class="s2">assert not </span><span class="s1">sparse.issparse(X_trans)</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == (X_trans.shape[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">X_trans.shape[</span><span class="s5">0</span><span class="s1">] + </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_trans[:</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">np.eye(X_trans.shape[</span><span class="s5">0</span><span class="s1">]))</span>


<span class="s2">def </span><span class="s1">test_column_transformer_mixed_cols_sparse():</span>
    <span class="s1">df = np.array([[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, True</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, False</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s4">&quot;O&quot;</span><span class="s1">)</span>

    <span class="s1">ct = make_column_transformer(</span>
        <span class="s1">(OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">1.0</span>
    <span class="s1">)</span>

    <span class="s3"># this shouldn't fail, since boolean can be coerced into a numeric</span>
    <span class="s3"># See: https://github.com/scikit-learn/scikit-learn/issues/11912</span>
    <span class="s1">X_trans = ct.fit_transform(df)</span>
    <span class="s2">assert </span><span class="s1">X_trans.getformat() == </span><span class="s4">&quot;csr&quot;</span>
    <span class="s1">assert_array_equal(X_trans.toarray()</span><span class="s2">, </span><span class="s1">np.array([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]]))</span>

    <span class="s1">ct = make_column_transformer(</span>
        <span class="s1">(OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">1.0</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;For a sparse output, all columns should&quot;</span><span class="s1">):</span>
        <span class="s3"># this fails since strings `a` and `b` cannot be</span>
        <span class="s3"># coerced into a numeric.</span>
        <span class="s1">ct.fit_transform(df)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_sparse_threshold():</span>
    <span class="s1">X_array = np.array([[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;A&quot;</span><span class="s2">, </span><span class="s4">&quot;B&quot;</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">dtype=object).T</span>
    <span class="s3"># above data has sparsity of 4 / 8 = 0.5</span>

    <span class="s3"># apply threshold even if all sparse</span>
    <span class="s1">col_trans = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
        <span class="s1">sparse_threshold=</span><span class="s5">0.2</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">res = col_trans.fit_transform(X_array)</span>
    <span class="s2">assert not </span><span class="s1">sparse.issparse(res)</span>
    <span class="s2">assert not </span><span class="s1">col_trans.sparse_output_</span>

    <span class="s3"># mixed -&gt; sparsity of (4 + 2) / 8 = 0.75</span>
    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s1">[</span><span class="s5">0.75001</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]:</span>
        <span class="s1">col_trans = ColumnTransformer(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s1">sparse_threshold=thres</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">res = col_trans.fit_transform(X_array)</span>
        <span class="s2">assert </span><span class="s1">sparse.issparse(res)</span>
        <span class="s2">assert </span><span class="s1">col_trans.sparse_output_</span>

    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s1">[</span><span class="s5">0.75</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]:</span>
        <span class="s1">col_trans = ColumnTransformer(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s1">sparse_threshold=thres</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">res = col_trans.fit_transform(X_array)</span>
        <span class="s2">assert not </span><span class="s1">sparse.issparse(res)</span>
        <span class="s2">assert not </span><span class="s1">col_trans.sparse_output_</span>

    <span class="s3"># if nothing is sparse -&gt; no sparse</span>
    <span class="s2">for </span><span class="s1">thres </span><span class="s2">in </span><span class="s1">[</span><span class="s5">0.33</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]:</span>
        <span class="s1">col_trans = ColumnTransformer(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s1">sparse_threshold=thres</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">res = col_trans.fit_transform(X_array)</span>
        <span class="s2">assert not </span><span class="s1">sparse.issparse(res)</span>
        <span class="s2">assert not </span><span class="s1">col_trans.sparse_output_</span>


<span class="s2">def </span><span class="s1">test_column_transformer_error_msg_1D():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>

    <span class="s1">col_trans = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)])</span>
    <span class="s1">msg = </span><span class="s4">&quot;1D data passed to a transformer&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">col_trans.fit(X_array)</span>

    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">col_trans.fit_transform(X_array)</span>

    <span class="s1">col_trans = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">TransRaise()</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)])</span>
    <span class="s2">for </span><span class="s1">func </span><span class="s2">in </span><span class="s1">[col_trans.fit</span><span class="s2">, </span><span class="s1">col_trans.fit_transform]:</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;specific message&quot;</span><span class="s1">):</span>
            <span class="s1">func(X_array)</span>


<span class="s2">def </span><span class="s1">test_2D_transformer_output():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>

    <span class="s3"># if one transformer is dropped, test that name is still correct</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">TransNo2D()</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)])</span>

    <span class="s1">msg = </span><span class="s4">&quot;the 'trans2' transformer should be 2D&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit_transform(X_array)</span>
    <span class="s3"># because fit is also doing transform, this raises already on fit</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit(X_array)</span>


<span class="s2">def </span><span class="s1">test_2D_transformer_output_pandas():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_df = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">])</span>

    <span class="s3"># if one transformer is dropped, test that name is still correct</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">TransNo2D()</span><span class="s2">, </span><span class="s4">&quot;col1&quot;</span><span class="s1">)])</span>
    <span class="s1">msg = </span><span class="s4">&quot;the 'trans1' transformer should be 2D&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit_transform(X_df)</span>
    <span class="s3"># because fit is also doing transform, this raises already on fit</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit(X_df)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_invalid_columns(remainder):</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>

    <span class="s3"># general invalid</span>
    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">[</span><span class="s5">1.5</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s4">&quot;s&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">1.0</span><span class="s1">])]:</span>
        <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">col)]</span><span class="s2">, </span><span class="s1">remainder=remainder)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;No valid specification&quot;</span><span class="s1">):</span>
            <span class="s1">ct.fit(X_array)</span>

    <span class="s3"># invalid for arrays</span>
    <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">[</span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;string&quot;</span><span class="s2">, </span><span class="s4">&quot;other&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">)]:</span>
        <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">col)]</span><span class="s2">, </span><span class="s1">remainder=remainder)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;Specifying the columns&quot;</span><span class="s1">):</span>
            <span class="s1">ct.fit(X_array)</span>

    <span class="s3"># transformed n_features does not match fitted n_features</span>
    <span class="s1">col = [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">col)]</span><span class="s2">, </span><span class="s1">remainder=remainder)</span>
    <span class="s1">ct.fit(X_array)</span>
    <span class="s1">X_array_more = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s1">]]).T</span>
    <span class="s1">msg = </span><span class="s4">&quot;X has 3 features, but ColumnTransformer is expecting 2 features as input.&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.transform(X_array_more)</span>
    <span class="s1">X_array_fewer = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">).T</span>
    <span class="s1">err_msg = (</span>
        <span class="s4">&quot;X has 1 features, but ColumnTransformer is expecting 2 features as input.&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
        <span class="s1">ct.transform(X_array_fewer)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_invalid_transformer():</span>
    <span class="s2">class </span><span class="s1">NoTrans(BaseEstimator):</span>
        <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
            <span class="s2">return </span><span class="s1">self</span>

        <span class="s2">def </span><span class="s1">predict(self</span><span class="s2">, </span><span class="s1">X):</span>
            <span class="s2">return </span><span class="s1">X</span>

    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">NoTrans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])])</span>
    <span class="s1">msg = </span><span class="s4">&quot;All estimators should implement fit and transform&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(TypeError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit(X_array)</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer():</span>
    <span class="s1">scaler = StandardScaler()</span>
    <span class="s1">norm = Normalizer()</span>
    <span class="s1">ct = make_column_transformer((scaler</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(norm</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">]))</span>
    <span class="s1">names</span><span class="s2">, </span><span class="s1">transformers</span><span class="s2">, </span><span class="s1">columns = zip(*ct.transformers)</span>
    <span class="s2">assert </span><span class="s1">names == (</span><span class="s4">&quot;standardscaler&quot;</span><span class="s2">, </span><span class="s4">&quot;normalizer&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">transformers == (scaler</span><span class="s2">, </span><span class="s1">norm)</span>
    <span class="s2">assert </span><span class="s1">columns == (</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_pandas():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_df = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s1">norm = Normalizer()</span>
    <span class="s1">ct1 = ColumnTransformer([(</span><span class="s4">&quot;norm&quot;</span><span class="s2">, </span><span class="s1">Normalizer()</span><span class="s2">, </span><span class="s1">X_df.columns)])</span>
    <span class="s1">ct2 = make_column_transformer((norm</span><span class="s2">, </span><span class="s1">X_df.columns))</span>
    <span class="s1">assert_almost_equal(ct1.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">ct2.fit_transform(X_df))</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_kwargs():</span>
    <span class="s1">scaler = StandardScaler()</span>
    <span class="s1">norm = Normalizer()</span>
    <span class="s1">ct = make_column_transformer(</span>
        <span class="s1">(scaler</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(norm</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">n_jobs=</span><span class="s5">3</span><span class="s2">,</span>
        <span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
        <span class="s1">sparse_threshold=</span><span class="s5">0.5</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">(</span>
        <span class="s1">ct.transformers</span>
        <span class="s1">== make_column_transformer((scaler</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(norm</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])).transformers</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">ct.n_jobs == </span><span class="s5">3</span>
    <span class="s2">assert </span><span class="s1">ct.remainder == </span><span class="s4">&quot;drop&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.sparse_threshold == </span><span class="s5">0.5</span>
    <span class="s3"># invalid keyword parameters should raise an error message</span>
    <span class="s1">msg = re.escape(</span>
        <span class="s4">&quot;make_column_transformer() got an unexpected &quot;</span>
        <span class="s4">&quot;keyword argument 'transformer_weights'&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(TypeError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">make_column_transformer(</span>
            <span class="s1">(scaler</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(norm</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">transformer_weights={</span><span class="s4">&quot;pca&quot;</span><span class="s1">: </span><span class="s5">10</span><span class="s2">, </span><span class="s4">&quot;Transf&quot;</span><span class="s1">: </span><span class="s5">1</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_make_column_transformer_remainder_transformer():</span>
    <span class="s1">scaler = StandardScaler()</span>
    <span class="s1">norm = Normalizer()</span>
    <span class="s1">remainder = StandardScaler()</span>
    <span class="s1">ct = make_column_transformer(</span>
        <span class="s1">(scaler</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(norm</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;second&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">remainder=remainder</span>
    <span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">ct.remainder == remainder</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_set_params():</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span>
    <span class="s1">)</span>

    <span class="s1">exp = {</span>
        <span class="s4">&quot;n_jobs&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: </span><span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;sparse_threshold&quot;</span><span class="s1">: </span><span class="s5">0.3</span><span class="s2">,</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;trans1__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans1__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans1__with_std&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: ct.transformers[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;trans2__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans2__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans2__with_std&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;transformers&quot;</span><span class="s1">: ct.transformers</span><span class="s2">,</span>
        <span class="s4">&quot;transformer_weights&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;verbose_feature_names_out&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;verbose&quot;</span><span class="s1">: </span><span class="s2">False,</span>
    <span class="s1">}</span>

    <span class="s2">assert </span><span class="s1">ct.get_params() == exp</span>

    <span class="s1">ct.set_params(trans1__with_mean=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">ct.get_params()[</span><span class="s4">&quot;trans1__with_mean&quot;</span><span class="s1">]</span>

    <span class="s1">ct.set_params(trans1=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">exp = {</span>
        <span class="s4">&quot;n_jobs&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: </span><span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;sparse_threshold&quot;</span><span class="s1">: </span><span class="s5">0.3</span><span class="s2">,</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;trans2&quot;</span><span class="s1">: ct.transformers[</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;trans2__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans2__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans2__with_std&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;transformers&quot;</span><span class="s1">: ct.transformers</span><span class="s2">,</span>
        <span class="s4">&quot;transformer_weights&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;verbose_feature_names_out&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;verbose&quot;</span><span class="s1">: </span><span class="s2">False,</span>
    <span class="s1">}</span>

    <span class="s2">assert </span><span class="s1">ct.get_params() == exp</span>


<span class="s2">def </span><span class="s1">test_column_transformer_named_estimators():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">StandardScaler(with_std=</span><span class="s2">False</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">hasattr(ct</span><span class="s2">, </span><span class="s4">&quot;transformers_&quot;</span><span class="s1">)</span>
    <span class="s1">ct.fit(X_array)</span>
    <span class="s2">assert </span><span class="s1">hasattr(ct</span><span class="s2">, </span><span class="s4">&quot;transformers_&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.named_transformers_[</span><span class="s4">&quot;trans1&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">StandardScaler)</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.named_transformers_.trans1</span><span class="s2">, </span><span class="s1">StandardScaler)</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.named_transformers_[</span><span class="s4">&quot;trans2&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">StandardScaler)</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.named_transformers_.trans2</span><span class="s2">, </span><span class="s1">StandardScaler)</span>
    <span class="s2">assert not </span><span class="s1">ct.named_transformers_.trans2.with_std</span>
    <span class="s3"># check it are fitted transformers</span>
    <span class="s2">assert </span><span class="s1">ct.named_transformers_.trans1.mean_ == </span><span class="s5">1.0</span>


<span class="s2">def </span><span class="s1">test_column_transformer_cloning():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])])</span>
    <span class="s1">ct.fit(X_array)</span>
    <span class="s2">assert not </span><span class="s1">hasattr(ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;mean_&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">hasattr(ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;mean_&quot;</span><span class="s1">)</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])])</span>
    <span class="s1">ct.fit_transform(X_array)</span>
    <span class="s2">assert not </span><span class="s1">hasattr(ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;mean_&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">hasattr(ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;mean_&quot;</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_feature_names():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s3"># raise correct error when not fitted</span>
    <span class="s2">with </span><span class="s1">pytest.raises(NotFittedError):</span>
        <span class="s1">ct.get_feature_names_out()</span>
    <span class="s3"># raise correct error when no feature names are available</span>
    <span class="s1">ct.fit(X_array)</span>
    <span class="s1">msg = re.escape(</span>
        <span class="s4">&quot;Transformer trans (type Trans) does not provide get_feature_names_out&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.get_feature_names_out()</span>


<span class="s2">def </span><span class="s1">test_column_transformer_special_strings():</span>
    <span class="s3"># one 'drop' -&gt; ignore</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">exp = np.array([[</span><span class="s5">0.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s1">]])</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s3"># all 'drop' -&gt; return shape 0 array</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array).shape</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array).shape</span><span class="s2">, </span><span class="s1">(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>

    <span class="s3"># 'passthrough'</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s2">, </span><span class="s5">6.0</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s1">exp = X_array</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">exp)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>


<span class="s2">def </span><span class="s1">test_column_transformer_remainder():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>

    <span class="s1">X_res_first = np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]).reshape(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">X_res_second = np.array([</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]).reshape(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s3"># default drop</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])])</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;drop&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s3"># specify passthrough</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s3"># column order is not preserved (passed through added to end)</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both[:</span><span class="s2">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both[:</span><span class="s2">, </span><span class="s1">::-</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span>

    <span class="s3"># passthrough when all actual transformers are skipped</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_second)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_second)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>

    <span class="s3"># check default for make_column_transformer</span>
    <span class="s1">ct = make_column_transformer((Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]))</span>
    <span class="s2">assert </span><span class="s1">ct.remainder == </span><span class="s4">&quot;drop&quot;</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">True, False</span><span class="s1">])]</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_numpy(key):</span>
    <span class="s3"># test different ways that columns are specified with passthrough</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">key)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;key&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">np.array([</span><span class="s2">True, False</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;pd-index&quot;</span><span class="s2">,</span>
        <span class="s1">np.array([</span><span class="s4">&quot;first&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">np.array([</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=object)</span><span class="s2">,</span>
        <span class="s1">slice(</span><span class="s2">None, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">slice(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_pandas(key):</span>
    <span class="s3"># test different ways that columns are specified with passthrough</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">isinstance(key</span><span class="s2">, </span><span class="s1">str) </span><span class="s2">and </span><span class="s1">key == </span><span class="s4">&quot;pd-index&quot;</span><span class="s1">:</span>
        <span class="s1">key = pd.Index([</span><span class="s4">&quot;first&quot;</span><span class="s1">])</span>

    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_df = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>
    <span class="s1">X_res_both = X_array</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">key)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">] == </span><span class="s4">&quot;passthrough&quot;</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;key&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">True, False, False</span><span class="s1">])]</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_column_transformer_remainder_transformer(key):</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>
    <span class="s1">X_res_both = X_array.copy()</span>

    <span class="s3"># second and third columns are doubled when remainder = DoubleTrans</span>
    <span class="s1">X_res_both[:</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">] *= </span><span class="s5">2</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">key)]</span><span class="s2">, </span><span class="s1">remainder=DoubleTrans())</span>

    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">DoubleTrans)</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_remaining_remainder_transformer():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=DoubleTrans())</span>

    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_array)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_array)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">1</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] != </span><span class="s4">&quot;remainder&quot;</span>


<span class="s2">def </span><span class="s1">test_column_transformer_drops_all_remainder_transformer():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>

    <span class="s3"># columns are doubled when remainder = DoubleTrans</span>
    <span class="s1">X_res_both = </span><span class="s5">2 </span><span class="s1">* X_array.copy()[:</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">]</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=DoubleTrans())</span>

    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_both)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">DoubleTrans)</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_sparse_remainder_transformer():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=SparseMatrixTrans()</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">0.8</span>
    <span class="s1">)</span>

    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">sparse.issparse(X_trans)</span>
    <span class="s3"># SparseMatrixTrans creates 3 features for each column. There is</span>
    <span class="s3"># one column in ``transformers``, thus:</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">+ </span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">exp_array = np.hstack((X_array[:</span><span class="s2">, </span><span class="s5">0</span><span class="s1">].reshape(-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">3</span><span class="s1">)))</span>
    <span class="s1">assert_array_equal(X_trans.toarray()</span><span class="s2">, </span><span class="s1">exp_array)</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SparseMatrixTrans)</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_drop_all_sparse_remainder_transformer():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=SparseMatrixTrans()</span><span class="s2">, </span><span class="s1">sparse_threshold=</span><span class="s5">0.8</span>
    <span class="s1">)</span>

    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">sparse.issparse(X_trans)</span>

    <span class="s3">#  SparseMatrixTrans creates 3 features for each column, thus:</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">3</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(X_trans.toarray()</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">3</span><span class="s1">))</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">2</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">SparseMatrixTrans)</span>
    <span class="s1">assert_array_equal(ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_get_set_params_with_remainder():</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=StandardScaler()</span>
    <span class="s1">)</span>

    <span class="s1">exp = {</span>
        <span class="s4">&quot;n_jobs&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: ct.remainder</span><span class="s2">,</span>
        <span class="s4">&quot;remainder__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;remainder__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;remainder__with_std&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;sparse_threshold&quot;</span><span class="s1">: </span><span class="s5">0.3</span><span class="s2">,</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s4">&quot;trans1__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans1__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;trans1__with_std&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;transformers&quot;</span><span class="s1">: ct.transformers</span><span class="s2">,</span>
        <span class="s4">&quot;transformer_weights&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;verbose_feature_names_out&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;verbose&quot;</span><span class="s1">: </span><span class="s2">False,</span>
    <span class="s1">}</span>

    <span class="s2">assert </span><span class="s1">ct.get_params() == exp</span>

    <span class="s1">ct.set_params(remainder__with_std=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">ct.get_params()[</span><span class="s4">&quot;remainder__with_std&quot;</span><span class="s1">]</span>

    <span class="s1">ct.set_params(trans1=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">exp = {</span>
        <span class="s4">&quot;n_jobs&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;remainder&quot;</span><span class="s1">: ct.remainder</span><span class="s2">,</span>
        <span class="s4">&quot;remainder__copy&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;remainder__with_mean&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;remainder__with_std&quot;</span><span class="s1">: </span><span class="s2">False,</span>
        <span class="s4">&quot;sparse_threshold&quot;</span><span class="s1">: </span><span class="s5">0.3</span><span class="s2">,</span>
        <span class="s4">&quot;trans1&quot;</span><span class="s1">: </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;transformers&quot;</span><span class="s1">: ct.transformers</span><span class="s2">,</span>
        <span class="s4">&quot;transformer_weights&quot;</span><span class="s1">: </span><span class="s2">None,</span>
        <span class="s4">&quot;verbose_feature_names_out&quot;</span><span class="s1">: </span><span class="s2">True,</span>
        <span class="s4">&quot;verbose&quot;</span><span class="s1">: </span><span class="s2">False,</span>
    <span class="s1">}</span>
    <span class="s2">assert </span><span class="s1">ct.get_params() == exp</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_estimators():</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).astype(</span><span class="s4">&quot;float&quot;</span><span class="s1">).T</span>
    <span class="s1">ct = ColumnTransformer([]</span><span class="s2">, </span><span class="s1">remainder=StandardScaler())</span>

    <span class="s1">params = ct.get_params()</span>
    <span class="s2">assert </span><span class="s1">params[</span><span class="s4">&quot;remainder__with_mean&quot;</span><span class="s1">]</span>

    <span class="s1">X_trans = ct.fit_transform(X_array)</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == X_array.shape</span>
    <span class="s2">assert </span><span class="s1">len(ct.transformers_) == </span><span class="s5">1</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">0</span><span class="s1">] == </span><span class="s4">&quot;remainder&quot;</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[-</span><span class="s5">1</span><span class="s1">][</span><span class="s5">2</span><span class="s1">] == [</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">[</span><span class="s4">&quot;est&quot;</span><span class="s2">, </span><span class="s4">&quot;pattern&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
                <span class="s1">remainder=DoubleTrans()</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
                <span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
                <span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">,</span>
                <span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 3\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 3\) Processing trans2.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(3 of 3\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing remainder.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer(</span>
                <span class="s1">[(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;trans2&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 2\) Processing trans1.* total=.*\n&quot;</span>
                <span class="s4">r&quot;\[ColumnTransformer\].*\(2 of 2\) Processing trans2.* total=.*\n$&quot;</span>
            <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">ColumnTransformer([(</span><span class="s4">&quot;trans1&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">r&quot;\[ColumnTransformer\].*\(1 of 1\) Processing trans1.* total=.*\n$&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;method&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;fit&quot;</span><span class="s2">, </span><span class="s4">&quot;fit_transform&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_verbose(est</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">capsys):</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]).T</span>

    <span class="s1">func = getattr(est</span><span class="s2">, </span><span class="s1">method)</span>
    <span class="s1">est.set_params(verbose=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">func(X_array)</span>
    <span class="s2">assert not </span><span class="s1">capsys.readouterr().out</span><span class="s2">, </span><span class="s4">&quot;Got output for verbose=False&quot;</span>

    <span class="s1">est.set_params(verbose=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">func(X_array)</span>
    <span class="s2">assert </span><span class="s1">re.match(pattern</span><span class="s2">, </span><span class="s1">capsys.readouterr()[</span><span class="s5">0</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_column_transformer_no_estimators_set_params():</span>
    <span class="s1">ct = ColumnTransformer([]).set_params(n_jobs=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">ct.n_jobs == </span><span class="s5">2</span>


<span class="s2">def </span><span class="s1">test_column_transformer_callable_specifier():</span>
    <span class="s3"># assert that function gets the full array</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_res_first = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]]).T</span>

    <span class="s2">def </span><span class="s1">func(X):</span>
        <span class="s1">assert_array_equal(X</span><span class="s2">, </span><span class="s1">X_array)</span>
        <span class="s2">return </span><span class="s1">[</span><span class="s5">0</span><span class="s1">]</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">func)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s1">assert_array_equal(ct.fit(X_array).transform(X_array)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s2">assert </span><span class="s1">callable(ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">] == [</span><span class="s5">0</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">test_column_transformer_callable_specifier_dataframe():</span>
    <span class="s3"># assert that function gets the full dataframe</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_res_first = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]]).T</span>

    <span class="s1">X_df = pd.DataFrame(X_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">func(X):</span>
        <span class="s1">assert_array_equal(X.columns</span><span class="s2">, </span><span class="s1">X_df.columns)</span>
        <span class="s1">assert_array_equal(X.values</span><span class="s2">, </span><span class="s1">X_df.values)</span>
        <span class="s2">return </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span>

    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;trans&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">func)]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(ct.fit_transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s1">assert_array_equal(ct.fit(X_df).transform(X_df)</span><span class="s2">, </span><span class="s1">X_res_first)</span>
    <span class="s2">assert </span><span class="s1">callable(ct.transformers[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">ct.transformers_[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">2</span><span class="s1">] == [</span><span class="s4">&quot;first&quot;</span><span class="s1">]</span>


<span class="s2">def </span><span class="s1">test_column_transformer_negative_column_indexes():</span>
    <span class="s1">X = np.random.randn(</span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">X_categories = np.array([[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s1">]])</span>
    <span class="s1">X = np.concatenate([X</span><span class="s2">, </span><span class="s1">X_categories]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s1">ohe = OneHotEncoder()</span>

    <span class="s1">tf_1 = ColumnTransformer([(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">ohe</span><span class="s2">, </span><span class="s1">[-</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">tf_2 = ColumnTransformer([(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">ohe</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(tf_1.fit_transform(X)</span><span class="s2">, </span><span class="s1">tf_2.fit_transform(X))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;array_type&quot;</span><span class="s2">, </span><span class="s1">[np.asarray</span><span class="s2">, </span><span class="s1">sparse.csr_matrix])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_mask_indexing(array_type):</span>
    <span class="s3"># Regression test for #14510</span>
    <span class="s3"># Boolean array-like does not behave as boolean array with sparse matrices.</span>
    <span class="s1">X = np.transpose([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">7</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">9</span><span class="s2">, </span><span class="s5">10</span><span class="s1">]])</span>
    <span class="s1">X = array_type(X)</span>
    <span class="s1">column_transformer = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;identity&quot;</span><span class="s2">, </span><span class="s1">FunctionTransformer()</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True, False, True</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s1">X_trans = column_transformer.fit_transform(X)</span>
    <span class="s2">assert </span><span class="s1">X_trans.shape == (</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_n_features_in():</span>
    <span class="s3"># make sure n_features_in is what is passed as input to the column</span>
    <span class="s3"># transformer.</span>

    <span class="s1">X = [[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s1">DoubleTrans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s1">DoubleTrans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])])</span>
    <span class="s2">assert not </span><span class="s1">hasattr(ct</span><span class="s2">, </span><span class="s4">&quot;n_features_in_&quot;</span><span class="s1">)</span>
    <span class="s1">ct.fit(X)</span>
    <span class="s2">assert </span><span class="s1">ct.n_features_in_ == </span><span class="s5">2</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;cols, pattern, include, exclude&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">np.number</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s1">]</span><span class="s2">, None, None, </span><span class="s1">object)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">[int</span><span class="s2">, </span><span class="s1">float]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">[object]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">object</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_float&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">float</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_float&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;at$&quot;</span><span class="s2">, </span><span class="s1">[np.number]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">[int]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;^col_int&quot;</span><span class="s2">, </span><span class="s1">[np.number]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;float|str&quot;</span><span class="s2">, None, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;^col_s&quot;</span><span class="s2">, None, </span><span class="s1">[int])</span><span class="s2">,</span>
        <span class="s1">([]</span><span class="s2">, </span><span class="s4">&quot;str$&quot;</span><span class="s2">, </span><span class="s1">float</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">([</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">, None, </span><span class="s1">[np.number</span><span class="s2">, </span><span class="s1">object]</span><span class="s2">, None</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_make_column_selector_with_select_dtypes(cols</span><span class="s2">, </span><span class="s1">pattern</span><span class="s2">, </span><span class="s1">include</span><span class="s2">, </span><span class="s1">exclude):</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;col_int&quot;</span><span class="s1">: np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=int)</span><span class="s2">,</span>
            <span class="s4">&quot;col_float&quot;</span><span class="s1">: np.array([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=float)</span><span class="s2">,</span>
            <span class="s4">&quot;col_str&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;three&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">selector = make_column_selector(</span>
        <span class="s1">dtype_include=include</span><span class="s2">, </span><span class="s1">dtype_exclude=exclude</span><span class="s2">, </span><span class="s1">pattern=pattern</span>
    <span class="s1">)</span>

    <span class="s1">assert_array_equal(selector(X_df)</span><span class="s2">, </span><span class="s1">cols)</span>


<span class="s2">def </span><span class="s1">test_column_transformer_with_make_column_selector():</span>
    <span class="s3"># Functional test for column transformer + column selector</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;col_int&quot;</span><span class="s1">: np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=int)</span><span class="s2">,</span>
            <span class="s4">&quot;col_float&quot;</span><span class="s1">: np.array([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=float)</span><span class="s2">,</span>
            <span class="s4">&quot;col_cat&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;one&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;col_str&quot;</span><span class="s1">: [</span><span class="s4">&quot;low&quot;</span><span class="s2">, </span><span class="s4">&quot;middle&quot;</span><span class="s2">, </span><span class="s4">&quot;high&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_cat&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">X_df[</span><span class="s4">&quot;col_str&quot;</span><span class="s1">] = X_df[</span><span class="s4">&quot;col_str&quot;</span><span class="s1">].astype(</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span>

    <span class="s1">cat_selector = make_column_selector(dtype_include=[</span><span class="s4">&quot;category&quot;</span><span class="s2">, </span><span class="s1">object])</span>
    <span class="s1">num_selector = make_column_selector(dtype_include=np.number)</span>

    <span class="s1">ohe = OneHotEncoder()</span>
    <span class="s1">scaler = StandardScaler()</span>

    <span class="s1">ct_selector = make_column_transformer((ohe</span><span class="s2">, </span><span class="s1">cat_selector)</span><span class="s2">, </span><span class="s1">(scaler</span><span class="s2">, </span><span class="s1">num_selector))</span>
    <span class="s1">ct_direct = make_column_transformer(</span>
        <span class="s1">(ohe</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col_cat&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(scaler</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_int&quot;</span><span class="s1">])</span>
    <span class="s1">)</span>

    <span class="s1">X_selector = ct_selector.fit_transform(X_df)</span>
    <span class="s1">X_direct = ct_direct.fit_transform(X_df)</span>

    <span class="s1">assert_allclose(X_selector</span><span class="s2">, </span><span class="s1">X_direct)</span>


<span class="s2">def </span><span class="s1">test_make_column_selector_error():</span>
    <span class="s1">selector = make_column_selector(dtype_include=np.number)</span>
    <span class="s1">X = np.array([[</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s1">]])</span>
    <span class="s1">msg = </span><span class="s4">&quot;make_column_selector can only be applied to pandas dataframes&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">selector(X)</span>


<span class="s2">def </span><span class="s1">test_make_column_selector_pickle():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;col_int&quot;</span><span class="s1">: np.array([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=int)</span><span class="s2">,</span>
            <span class="s4">&quot;col_float&quot;</span><span class="s1">: np.array([</span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=float)</span><span class="s2">,</span>
            <span class="s4">&quot;col_str&quot;</span><span class="s1">: [</span><span class="s4">&quot;one&quot;</span><span class="s2">, </span><span class="s4">&quot;two&quot;</span><span class="s2">, </span><span class="s4">&quot;three&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span><span class="s2">,</span>
        <span class="s1">columns=[</span><span class="s4">&quot;col_int&quot;</span><span class="s2">, </span><span class="s4">&quot;col_float&quot;</span><span class="s2">, </span><span class="s4">&quot;col_str&quot;</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">selector = make_column_selector(dtype_include=[object])</span>
    <span class="s1">selector_picked = pickle.loads(pickle.dumps(selector))</span>

    <span class="s1">assert_array_equal(selector(X_df)</span><span class="s2">, </span><span class="s1">selector_picked(X_df))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;empty_col&quot;</span><span class="s2">,</span>
    <span class="s1">[[]</span><span class="s2">, </span><span class="s1">np.array([]</span><span class="s2">, </span><span class="s1">dtype=int)</span><span class="s2">, lambda </span><span class="s1">x: []]</span><span class="s2">,</span>
    <span class="s1">ids=[</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;array&quot;</span><span class="s2">, </span><span class="s4">&quot;callable&quot;</span><span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_empty_columns(empty_col):</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;col1&quot;</span><span class="s1">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]})</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers=[</span>
            <span class="s1">(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;empty_features&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">empty_col)</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>

    <span class="s1">ct.fit(df)</span>
    <span class="s1">assert_array_equal(</span>
        <span class="s1">ct.get_feature_names_out()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;ohe__col1_a&quot;</span><span class="s2">, </span><span class="s4">&quot;ohe__col1_b&quot;</span><span class="s2">, </span><span class="s4">&quot;ohe__col2_z&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;selector&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s2">lambda </span><span class="s1">x: [</span><span class="s5">1</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s4">&quot;col2&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s2">lambda </span><span class="s1">x: [</span><span class="s4">&quot;col2&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s2">False, True</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s2">lambda </span><span class="s1">x: [</span><span class="s2">False, True</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_out_pandas(selector):</span>
    <span class="s0">&quot;&quot;&quot;Checks name when selecting only the second column&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;col1&quot;</span><span class="s1">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]})</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">selector)])</span>
    <span class="s1">ct.fit(df)</span>

    <span class="s1">assert_array_equal(ct.get_feature_names_out()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;ohe__col2_z&quot;</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;selector&quot;</span><span class="s2">, </span><span class="s1">[[</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, lambda </span><span class="s1">x: [</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, True</span><span class="s1">]</span><span class="s2">, lambda </span><span class="s1">x: [</span><span class="s2">False, True</span><span class="s1">]]</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_feature_names_out_non_pandas(selector):</span>
    <span class="s0">&quot;&quot;&quot;Checks name when selecting the second column with numpy array&quot;&quot;&quot;</span>
    <span class="s1">X = [[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]]</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">OneHotEncoder()</span><span class="s2">, </span><span class="s1">selector)])</span>
    <span class="s1">ct.fit(X)</span>

    <span class="s1">assert_array_equal(ct.get_feature_names_out()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;ohe__x1_z&quot;</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder(remainder):</span>
    <span class="s3"># remainder='passthrough' or an estimator will be shown in repr_html</span>
    <span class="s1">ohe = OneHotEncoder()</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers=[(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">ohe</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=remainder</span>
    <span class="s1">)</span>
    <span class="s1">visual_block = ct._sk_visual_block_()</span>
    <span class="s2">assert </span><span class="s1">visual_block.names == (</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.name_details == ([</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.estimators == (ohe</span><span class="s2">, </span><span class="s1">remainder)</span>


<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_drop():</span>
    <span class="s3"># remainder='drop' is not shown in repr_html</span>
    <span class="s1">ohe = OneHotEncoder()</span>
    <span class="s1">ct = ColumnTransformer(transformers=[(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">ohe</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">])])</span>
    <span class="s1">visual_block = ct._sk_visual_block_()</span>
    <span class="s2">assert </span><span class="s1">visual_block.names == (</span><span class="s4">&quot;ohe&quot;</span><span class="s2">,</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.name_details == ([</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">]</span><span class="s2">,</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.estimators == (ohe</span><span class="s2">,</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_fitted_pandas(remainder):</span>
    <span class="s3"># Remainder shows the columns after fitting</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">ohe = OneHotEncoder()</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers=[(</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s1">ohe</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=remainder</span>
    <span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;col1&quot;</span><span class="s1">: [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;col2&quot;</span><span class="s1">: [</span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s2">, </span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;col3&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;col4&quot;</span><span class="s1">: [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit(df)</span>
    <span class="s1">visual_block = ct._sk_visual_block_()</span>
    <span class="s2">assert </span><span class="s1">visual_block.names == (</span><span class="s4">&quot;ohe&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.name_details == ([</span><span class="s4">&quot;col1&quot;</span><span class="s2">, </span><span class="s4">&quot;col2&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;col3&quot;</span><span class="s2">, </span><span class="s4">&quot;col4&quot;</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">visual_block.estimators == (ohe</span><span class="s2">, </span><span class="s1">remainder)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()])</span>
<span class="s2">def </span><span class="s1">test_sk_visual_block_remainder_fitted_numpy(remainder):</span>
    <span class="s3"># Remainder shows the indices after fitting</span>
    <span class="s1">X = np.array([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">4</span><span class="s2">, </span><span class="s5">5</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">dtype=float)</span>
    <span class="s1">scaler = StandardScaler()</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers=[(</span><span class="s4">&quot;scale&quot;</span><span class="s2">, </span><span class="s1">scaler</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=remainder</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit(X)</span>
    <span class="s1">visual_block = ct._sk_visual_block_()</span>
    <span class="s2">assert </span><span class="s1">visual_block.names == (</span><span class="s4">&quot;scale&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder&quot;</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">visual_block.name_details == ([</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s2">assert </span><span class="s1">visual_block.estimators == (scaler</span><span class="s2">, </span><span class="s1">remainder)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;explicit_colname&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[Trans()</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_reordered_column_names_remainder(</span>
    <span class="s1">explicit_colname</span><span class="s2">, </span><span class="s1">remainder</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Test the interaction between remainder and column transformer&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_fit_array = np.array([[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]]).T</span>
    <span class="s1">X_fit_df = pd.DataFrame(X_fit_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s4">&quot;second&quot;</span><span class="s1">])</span>

    <span class="s1">X_trans_array = np.array([[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">4</span><span class="s2">, </span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]]).T</span>
    <span class="s1">X_trans_df = pd.DataFrame(X_trans_array</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;second&quot;</span><span class="s2">, </span><span class="s4">&quot;first&quot;</span><span class="s1">])</span>

    <span class="s1">tf = ColumnTransformer([(</span><span class="s4">&quot;bycol&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">explicit_colname)]</span><span class="s2">, </span><span class="s1">remainder=remainder)</span>

    <span class="s1">tf.fit(X_fit_df)</span>
    <span class="s1">X_fit_trans = tf.transform(X_fit_df)</span>

    <span class="s3"># Changing the order still works</span>
    <span class="s1">X_trans = tf.transform(X_trans_df)</span>
    <span class="s1">assert_allclose(X_trans</span><span class="s2">, </span><span class="s1">X_fit_trans)</span>

    <span class="s3"># extra columns are ignored</span>
    <span class="s1">X_extended_df = X_fit_df.copy()</span>
    <span class="s1">X_extended_df[</span><span class="s4">&quot;third&quot;</span><span class="s1">] = [</span><span class="s5">3</span><span class="s2">, </span><span class="s5">6</span><span class="s2">, </span><span class="s5">9</span><span class="s1">]</span>
    <span class="s1">X_trans = tf.transform(X_extended_df)</span>
    <span class="s1">assert_allclose(X_trans</span><span class="s2">, </span><span class="s1">X_fit_trans)</span>

    <span class="s2">if </span><span class="s1">isinstance(explicit_colname</span><span class="s2">, </span><span class="s1">str):</span>
        <span class="s3"># Raise error if columns are specified by names but input only allows</span>
        <span class="s3"># to specify by position, e.g. numpy array instead of a pandas df.</span>
        <span class="s1">X_array = X_fit_array.copy()</span>
        <span class="s1">err_msg = </span><span class="s4">&quot;Specifying the columns&quot;</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=err_msg):</span>
            <span class="s1">tf.transform(X_array)</span>


<span class="s2">def </span><span class="s1">test_feature_name_validation_missing_columns_drop_passthough():</span>
    <span class="s0">&quot;&quot;&quot;Test the interaction between {'drop', 'passthrough'} and 
    missing column names.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X = np.ones(shape=(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">df = pd.DataFrame(X</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span>

    <span class="s1">df_dropped = df.drop(</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s1">)</span>

    <span class="s3"># with remainder='passthrough', all columns seen during `fit` must be</span>
    <span class="s3"># present</span>
    <span class="s1">tf = ColumnTransformer([(</span><span class="s4">&quot;bycol&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">tf.fit(df)</span>
    <span class="s1">msg = </span><span class="s4">r&quot;columns are missing: {'c'}&quot;</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">tf.transform(df_dropped)</span>

    <span class="s3"># with remainder='drop', it is allowed to have column 'c' missing</span>
    <span class="s1">tf = ColumnTransformer([(</span><span class="s4">&quot;bycol&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;drop&quot;</span><span class="s1">)</span>
    <span class="s1">tf.fit(df)</span>

    <span class="s1">df_dropped_trans = tf.transform(df_dropped)</span>
    <span class="s1">df_fit_trans = tf.transform(df)</span>
    <span class="s1">assert_allclose(df_dropped_trans</span><span class="s2">, </span><span class="s1">df_fit_trans)</span>

    <span class="s3"># bycol drops 'c', thus it is allowed for 'c' to be missing</span>
    <span class="s1">tf = ColumnTransformer([(</span><span class="s4">&quot;bycol&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>
    <span class="s1">tf.fit(df)</span>
    <span class="s1">df_dropped_trans = tf.transform(df_dropped)</span>
    <span class="s1">df_fit_trans = tf.transform(df)</span>
    <span class="s1">assert_allclose(df_dropped_trans</span><span class="s2">, </span><span class="s1">df_fit_trans)</span>


<span class="s2">def </span><span class="s1">test_feature_names_in_():</span>
    <span class="s0">&quot;&quot;&quot;Feature names are stored in column transformer. 
 
    Column transformer deliberately does not check for column name consistency. 
    It only checks that the non-dropped names seen in `fit` are seen 
    in `transform`. This behavior is already tested in 
    `test_feature_name_validation_missing_columns_drop_passthough`&quot;&quot;&quot;</span>

    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">feature_names = [</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">]</span>
    <span class="s1">df = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=feature_names)</span>
    <span class="s1">ct = ColumnTransformer([(</span><span class="s4">&quot;bycol&quot;</span><span class="s2">, </span><span class="s1">Trans()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">remainder=</span><span class="s4">&quot;passthrough&quot;</span><span class="s1">)</span>

    <span class="s1">ct.fit(df)</span>
    <span class="s1">assert_array_equal(ct.feature_names_in_</span><span class="s2">, </span><span class="s1">feature_names)</span>
    <span class="s2">assert </span><span class="s1">isinstance(ct.feature_names_in_</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">assert </span><span class="s1">ct.feature_names_in_.dtype == object</span>


<span class="s2">class </span><span class="s1">TransWithNames(Trans):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">feature_names_out=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">self.feature_names_out = feature_names_out</span>

    <span class="s2">def </span><span class="s1">get_feature_names_out(self</span><span class="s2">, </span><span class="s1">input_features=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s2">if </span><span class="s1">self.feature_names_out </span><span class="s2">is not None</span><span class="s1">:</span>
            <span class="s2">return </span><span class="s1">np.asarray(self.feature_names_out</span><span class="s2">, </span><span class="s1">dtype=object)</span>
        <span class="s2">return </span><span class="s1">input_features</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;transformers, remainder, expected_names&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__d&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__c&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol2__d&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__a&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__d&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__c&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol2__d&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__a&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;pca1&quot;</span><span class="s2">, </span><span class="s4">&quot;pca2&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__pca1&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__pca2&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__a&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol2__b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span>
                <span class="s4">&quot;bycol1__pca0&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol1__pca1&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol2__pca0&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol2__pca1&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;remainder__a&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;remainder__c&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;remainder__d&quot;</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">3</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__a&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__d&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__c&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol2__d&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__a&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;bycol1__c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;bycol1__b&quot;</span><span class="s2">, </span><span class="s4">&quot;remainder__a&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span>
                <span class="s4">&quot;bycol1__d&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol1__c&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol2__c&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;bycol2__d&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;remainder__a&quot;</span><span class="s2">,</span>
                <span class="s4">&quot;remainder__b&quot;</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_true(transformers</span><span class="s2">, </span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">expected_names):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=True (default)&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit(df)</span>

    <span class="s1">names = ct.get_feature_names_out()</span>
    <span class="s2">assert </span><span class="s1">isinstance(names</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">assert </span><span class="s1">names.dtype == object</span>
    <span class="s1">assert_array_equal(names</span><span class="s2">, </span><span class="s1">expected_names)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;transformers, remainder, expected_names&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;pca1&quot;</span><span class="s2">, </span><span class="s4">&quot;pca2&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;pca1&quot;</span><span class="s2">, </span><span class="s4">&quot;pca2&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;kpca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;pca0&quot;</span><span class="s2">, </span><span class="s4">&quot;pca1&quot;</span><span class="s2">, </span><span class="s4">&quot;kpca0&quot;</span><span class="s2">, </span><span class="s4">&quot;kpca1&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">))</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_false(transformers</span><span class="s2">, </span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">expected_names):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=False&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">False,</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit(df)</span>

    <span class="s1">names = ct.get_feature_names_out()</span>
    <span class="s2">assert </span><span class="s1">isinstance(names</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">assert </span><span class="s1">names.dtype == object</span>
    <span class="s1">assert_array_equal(names</span><span class="s2">, </span><span class="s1">expected_names)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;transformers, remainder, colliding_columns&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['c']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['b', 'c']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">6</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">f&quot;pca</span><span class="s2">{</span><span class="s1">i</span><span class="s2">}</span><span class="s4">&quot; </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">6</span><span class="s1">)])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['pca0', 'pca1', 'pca2', 'pca3', 'pca4', ...]&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s4">&quot;bycol1&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol2&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">slice(</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;a&quot;</span><span class="s1">))</span><span class="s2">,</span>
                <span class="s1">(</span><span class="s4">&quot;bycol3&quot;</span><span class="s2">, </span><span class="s1">TransWithNames([</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s4">&quot;['a', 'b']&quot;</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_verbose_feature_names_out_false_errors(</span>
    <span class="s1">transformers</span><span class="s2">, </span><span class="s1">remainder</span><span class="s2">, </span><span class="s1">colliding_columns</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Check feature_names_out for verbose_feature_names_out=False&quot;&quot;&quot;</span>

    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">])</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">transformers</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">False,</span>
    <span class="s1">)</span>
    <span class="s1">ct.fit(df)</span>

    <span class="s1">msg = re.escape(</span>
        <span class="s4">f&quot;Output feature names: </span><span class="s2">{</span><span class="s1">colliding_columns</span><span class="s2">} </span><span class="s4">are not unique. Please set &quot;</span>
        <span class="s4">&quot;verbose_feature_names_out=True to add prefixes to feature names&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.get_feature_names_out()</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;verbose_feature_names_out&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transformer_set_output(verbose_feature_names_out</span><span class="s2">, </span><span class="s1">remainder):</span>
    <span class="s0">&quot;&quot;&quot;Check column transformer behavior with set_output.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s2">, </span><span class="s4">&quot;d&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">10</span><span class="s1">])</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[(</span><span class="s4">&quot;first&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;c&quot;</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(</span><span class="s4">&quot;second&quot;</span><span class="s2">, </span><span class="s1">TransWithNames()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s1">])]</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=verbose_feature_names_out</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">X_trans = ct.fit_transform(df)</span>
    <span class="s2">assert </span><span class="s1">isinstance(X_trans</span><span class="s2">, </span><span class="s1">np.ndarray)</span>

    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">df_test = pd.DataFrame([[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s2">, </span><span class="s5">4</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=df.columns</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">20</span><span class="s1">])</span>
    <span class="s1">X_trans = ct.transform(df_test)</span>
    <span class="s2">assert </span><span class="s1">isinstance(X_trans</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>

    <span class="s1">feature_names_out = ct.get_feature_names_out()</span>
    <span class="s1">assert_array_equal(X_trans.columns</span><span class="s2">, </span><span class="s1">feature_names_out)</span>
    <span class="s1">assert_array_equal(X_trans.index</span><span class="s2">, </span><span class="s1">df_test.index)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;fit_transform&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transform_set_output_mixed(remainder</span><span class="s2">, </span><span class="s1">fit_transform):</span>
    <span class="s0">&quot;&quot;&quot;Check ColumnTransformer outputs mixed types correctly.&quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;pet&quot;</span><span class="s1">: pd.Series([</span><span class="s4">&quot;dog&quot;</span><span class="s2">, </span><span class="s4">&quot;cat&quot;</span><span class="s2">, </span><span class="s4">&quot;snake&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;color&quot;</span><span class="s1">: pd.Series([</span><span class="s4">&quot;green&quot;</span><span class="s2">, </span><span class="s4">&quot;blue&quot;</span><span class="s2">, </span><span class="s4">&quot;red&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s4">&quot;object&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;age&quot;</span><span class="s1">: [</span><span class="s5">1.4</span><span class="s2">, </span><span class="s5">2.1</span><span class="s2">, </span><span class="s5">4.4</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;height&quot;</span><span class="s1">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">40</span><span class="s2">, </span><span class="s5">10</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;distance&quot;</span><span class="s1">: pd.Series([</span><span class="s5">20</span><span class="s2">, </span><span class="s1">pd.NA</span><span class="s2">, </span><span class="s5">100</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s4">&quot;Int32&quot;</span><span class="s1">)</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s4">&quot;color_encode&quot;</span><span class="s2">,</span>
                <span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False, </span><span class="s1">dtype=</span><span class="s4">&quot;int8&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s4">&quot;color&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;age&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">False,</span>
    <span class="s1">).set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s2">if </span><span class="s1">fit_transform:</span>
        <span class="s1">X_trans = ct.fit_transform(df)</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">X_trans = ct.fit(df).transform(df)</span>

    <span class="s2">assert </span><span class="s1">isinstance(X_trans</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
    <span class="s1">assert_array_equal(X_trans.columns</span><span class="s2">, </span><span class="s1">ct.get_feature_names_out())</span>

    <span class="s1">expected_dtypes = {</span>
        <span class="s4">&quot;color_blue&quot;</span><span class="s1">: </span><span class="s4">&quot;int8&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;color_green&quot;</span><span class="s1">: </span><span class="s4">&quot;int8&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;color_red&quot;</span><span class="s1">: </span><span class="s4">&quot;int8&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;age&quot;</span><span class="s1">: </span><span class="s4">&quot;float64&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pet&quot;</span><span class="s1">: </span><span class="s4">&quot;category&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;height&quot;</span><span class="s1">: </span><span class="s4">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;distance&quot;</span><span class="s1">: </span><span class="s4">&quot;Int32&quot;</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s2">for </span><span class="s1">col</span><span class="s2">, </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">X_trans.dtypes.items():</span>
        <span class="s2">assert </span><span class="s1">dtype == expected_dtypes[col]</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">&quot;remainder&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;drop&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_column_transform_set_output_after_fitting(remainder):</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s4">&quot;pet&quot;</span><span class="s1">: pd.Series([</span><span class="s4">&quot;dog&quot;</span><span class="s2">, </span><span class="s4">&quot;cat&quot;</span><span class="s2">, </span><span class="s4">&quot;snake&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">dtype=</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s4">&quot;age&quot;</span><span class="s1">: [</span><span class="s5">1.4</span><span class="s2">, </span><span class="s5">2.1</span><span class="s2">, </span><span class="s5">4.4</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s4">&quot;height&quot;</span><span class="s1">: [</span><span class="s5">20</span><span class="s2">, </span><span class="s5">40</span><span class="s2">, </span><span class="s5">10</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span>
                <span class="s4">&quot;color_encode&quot;</span><span class="s2">,</span>
                <span class="s1">OneHotEncoder(sparse_output=</span><span class="s2">False, </span><span class="s1">dtype=</span><span class="s4">&quot;int16&quot;</span><span class="s1">)</span><span class="s2">,</span>
                <span class="s1">[</span><span class="s4">&quot;pet&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">)</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;age&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;age&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">remainder=remainder</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">False,</span>
    <span class="s1">)</span>

    <span class="s3"># fit without calling set_output</span>
    <span class="s1">X_trans = ct.fit_transform(df)</span>
    <span class="s2">assert </span><span class="s1">isinstance(X_trans</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
    <span class="s2">assert </span><span class="s1">X_trans.dtype == </span><span class="s4">&quot;float64&quot;</span>

    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_trans_df = ct.transform(df)</span>
    <span class="s1">expected_dtypes = {</span>
        <span class="s4">&quot;pet_cat&quot;</span><span class="s1">: </span><span class="s4">&quot;int16&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pet_dog&quot;</span><span class="s1">: </span><span class="s4">&quot;int16&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;pet_snake&quot;</span><span class="s1">: </span><span class="s4">&quot;int16&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;height&quot;</span><span class="s1">: </span><span class="s4">&quot;int64&quot;</span><span class="s2">,</span>
        <span class="s4">&quot;age&quot;</span><span class="s1">: </span><span class="s4">&quot;float64&quot;</span><span class="s2">,</span>
    <span class="s1">}</span>
    <span class="s2">for </span><span class="s1">col</span><span class="s2">, </span><span class="s1">dtype </span><span class="s2">in </span><span class="s1">X_trans_df.dtypes.items():</span>
        <span class="s2">assert </span><span class="s1">dtype == expected_dtypes[col]</span>


<span class="s3"># PandasOutTransformer that does not define get_feature_names_out and always expects</span>
<span class="s3"># the input to be a DataFrame.</span>
<span class="s2">class </span><span class="s1">PandasOutTransformer(BaseEstimator):</span>
    <span class="s2">def </span><span class="s1">__init__(self</span><span class="s2">, </span><span class="s1">offset=</span><span class="s5">1.0</span><span class="s1">):</span>
        <span class="s1">self.offset = offset</span>

    <span class="s2">def </span><span class="s1">fit(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">isinstance(X</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
        <span class="s2">return </span><span class="s1">self</span>

    <span class="s2">def </span><span class="s1">transform(self</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">y=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">isinstance(X</span><span class="s2">, </span><span class="s1">pd.DataFrame)</span>
        <span class="s2">return </span><span class="s1">X - self.offset</span>

    <span class="s2">def </span><span class="s1">set_output(self</span><span class="s2">, </span><span class="s1">transform=</span><span class="s2">None</span><span class="s1">):</span>
        <span class="s3"># This transformer will always output a DataFrame regardless of the</span>
        <span class="s3"># configuration.</span>
        <span class="s2">return </span><span class="s1">self</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;trans_1, expected_verbose_names, expected_non_verbose_names&quot;</span><span class="s2">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">PandasOutTransformer(offset=</span><span class="s5">2.0</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;trans_0__feat1&quot;</span><span class="s2">, </span><span class="s4">&quot;trans_1__feat0&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;feat1&quot;</span><span class="s2">, </span><span class="s4">&quot;feat0&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s4">&quot;drop&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;trans_0__feat1&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;feat1&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
        <span class="s1">(</span>
            <span class="s4">&quot;passthrough&quot;</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;trans_0__feat1&quot;</span><span class="s2">, </span><span class="s4">&quot;trans_1__feat0&quot;</span><span class="s1">]</span><span class="s2">,</span>
            <span class="s1">[</span><span class="s4">&quot;feat1&quot;</span><span class="s2">, </span><span class="s4">&quot;feat0&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span><span class="s2">,</span>
    <span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_transformers_with_pandas_out_but_not_feature_names_out(</span>
    <span class="s1">trans_1</span><span class="s2">, </span><span class="s1">expected_verbose_names</span><span class="s2">, </span><span class="s1">expected_non_verbose_names</span>
<span class="s1">):</span>
    <span class="s0">&quot;&quot;&quot;Check that set_config(transform=&quot;pandas&quot;) is compatible with more transformers. 
 
    Specifically, if transformers returns a DataFrame, but does not define 
    `get_feature_names_out`. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X_df = pd.DataFrame({</span><span class="s4">&quot;feat0&quot;</span><span class="s1">: [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;feat1&quot;</span><span class="s1">: [</span><span class="s5">2.0</span><span class="s2">, </span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">4.0</span><span class="s1">]})</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;trans_0&quot;</span><span class="s2">, </span><span class="s1">PandasOutTransformer(offset=</span><span class="s5">3.0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;feat1&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;trans_1&quot;</span><span class="s2">, </span><span class="s1">trans_1</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;feat0&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">X_trans_np = ct.fit_transform(X_df)</span>
    <span class="s2">assert </span><span class="s1">isinstance(X_trans_np</span><span class="s2">, </span><span class="s1">np.ndarray)</span>

    <span class="s3"># `ct` does not have `get_feature_names_out` because `PandasOutTransformer` does</span>
    <span class="s3"># not define the method.</span>
    <span class="s2">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;not provide get_feature_names_out&quot;</span><span class="s1">):</span>
        <span class="s1">ct.get_feature_names_out()</span>

    <span class="s3"># The feature names are prefixed because verbose_feature_names_out=True is default</span>
    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_trans_df0 = ct.fit_transform(X_df)</span>
    <span class="s1">assert_array_equal(X_trans_df0.columns</span><span class="s2">, </span><span class="s1">expected_verbose_names)</span>

    <span class="s1">ct.set_params(verbose_feature_names_out=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">X_trans_df1 = ct.fit_transform(X_df)</span>
    <span class="s1">assert_array_equal(X_trans_df1.columns</span><span class="s2">, </span><span class="s1">expected_non_verbose_names)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s4">&quot;empty_selection&quot;</span><span class="s2">,</span>
    <span class="s1">[[]</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s2">False, False</span><span class="s1">])</span><span class="s2">, </span><span class="s1">[</span><span class="s2">False, False</span><span class="s1">]]</span><span class="s2">,</span>
    <span class="s1">ids=[</span><span class="s4">&quot;list&quot;</span><span class="s2">, </span><span class="s4">&quot;bool&quot;</span><span class="s2">, </span><span class="s4">&quot;bool_int&quot;</span><span class="s1">]</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_empty_selection_pandas_output(empty_selection):</span>
    <span class="s0">&quot;&quot;&quot;Check that pandas output works when there is an empty selection. 
 
    Non-regression test for gh-25487 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X = pd.DataFrame([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;categorical&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">empty_selection)</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;numerical&quot;</span><span class="s2">, </span><span class="s1">StandardScaler()</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">True,</span>
    <span class="s1">)</span>
    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">X_out = ct.fit_transform(X)</span>
    <span class="s1">assert_array_equal(X_out.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;numerical__a&quot;</span><span class="s2">, </span><span class="s4">&quot;numerical__b&quot;</span><span class="s1">])</span>

    <span class="s1">ct.set_params(verbose_feature_names_out=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">X_out = ct.fit_transform(X)</span>
    <span class="s1">assert_array_equal(X_out.columns</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_raise_error_if_index_not_aligned():</span>
    <span class="s0">&quot;&quot;&quot;Check column transformer raises error if indices are not aligned. 
 
    Non-regression test for gh-26210. 
    &quot;&quot;&quot;</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">X = pd.DataFrame([[</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">2.2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">3.0</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">&quot;a&quot;</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">8</span><span class="s2">, </span><span class="s5">3</span><span class="s1">])</span>
    <span class="s1">reset_index_transformer = FunctionTransformer(</span>
        <span class="s2">lambda </span><span class="s1">x: x.reset_index(drop=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">, </span><span class="s1">feature_names_out=</span><span class="s4">&quot;one-to-one&quot;</span>
    <span class="s1">)</span>

    <span class="s1">ct = ColumnTransformer(</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">&quot;num1&quot;</span><span class="s2">, </span><span class="s4">&quot;passthrough&quot;</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">])</span><span class="s2">,</span>
            <span class="s1">(</span><span class="s4">&quot;num2&quot;</span><span class="s2">, </span><span class="s1">reset_index_transformer</span><span class="s2">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">])</span><span class="s2">,</span>
        <span class="s1">]</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">msg = (</span>
        <span class="s4">&quot;Concatenating DataFrames from the transformer's output lead to&quot;</span>
        <span class="s4">&quot; an inconsistent number of samples. The output may have Pandas&quot;</span>
        <span class="s4">&quot; Indexes that do not match.&quot;</span>
    <span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">ct.fit_transform(X)</span>


<span class="s2">def </span><span class="s1">test_remainder_set_output():</span>
    <span class="s0">&quot;&quot;&quot;Check that the output is set for the remainder. 
 
    Non-regression test for #26306. 
    &quot;&quot;&quot;</span>

    <span class="s1">pd = pytest.importorskip(</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;a&quot;</span><span class="s1">: [</span><span class="s2">True, False, True</span><span class="s1">]</span><span class="s2">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: [</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">3</span><span class="s1">]})</span>

    <span class="s1">ct = make_column_transformer(</span>
        <span class="s1">(VarianceThreshold()</span><span class="s2">, </span><span class="s1">make_column_selector(dtype_include=bool))</span><span class="s2">,</span>
        <span class="s1">remainder=VarianceThreshold()</span><span class="s2">,</span>
        <span class="s1">verbose_feature_names_out=</span><span class="s2">False,</span>
    <span class="s1">)</span>
    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">out = ct.fit_transform(df)</span>
    <span class="s1">pd.testing.assert_frame_equal(out</span><span class="s2">, </span><span class="s1">df)</span>

    <span class="s1">ct.set_output(transform=</span><span class="s4">&quot;default&quot;</span><span class="s1">)</span>
    <span class="s1">out = ct.fit_transform(df)</span>
    <span class="s2">assert </span><span class="s1">isinstance(out</span><span class="s2">, </span><span class="s1">np.ndarray)</span>
</pre>
</body>
</html>