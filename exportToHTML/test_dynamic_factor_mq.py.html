<html>
<head>
<title>test_dynamic_factor_mq.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_dynamic_factor_mq.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Basic tests for the BM model 
 
These test standard that the state space model is set up as desired, that 
expected exceptions are raised, etc. 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">statsmodels.compat.pandas </span><span class="s2">import </span><span class="s1">assert_frame_equal</span><span class="s2">, </span><span class="s1">assert_series_equal</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_allclose</span><span class="s2">, </span><span class="s1">assert_equal</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">statsmodels.regression.linear_model </span><span class="s2">import </span><span class="s1">OLS</span>
<span class="s2">from </span><span class="s1">statsmodels.tools </span><span class="s2">import </span><span class="s1">add_constant</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.statespace </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">dynamic_factor</span><span class="s2">,</span>
    <span class="s1">dynamic_factor_mq</span><span class="s2">,</span>
    <span class="s1">sarimax</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.statespace.tests </span><span class="s2">import </span><span class="s1">test_dynamic_factor_mq_monte_carlo</span>


<span class="s1">SKIP_MONTE_CARLO_TESTS = </span><span class="s2">True</span>


<span class="s2">def </span><span class="s1">test_default():</span>
    <span class="s3"># Includes 2 monthly and 2 quarterly series</span>
    <span class="s3"># Default is factors=1, factor_orders=1, idiosyncratic_ar1=True</span>

    <span class="s3"># Create the datasets</span>
    <span class="s1">index_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">index_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>

    <span class="s1">dta_M = pd.DataFrame(np.zeros((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_M</span><span class="s2">,</span>
                         <span class="s1">columns=[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s1">])</span>
    <span class="s1">dta_Q = pd.DataFrame(np.zeros((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_Q</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s3"># Add some noise so the variables aren't constants</span>
    <span class="s1">dta_M.iloc[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_Q.iloc[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1.</span>

    <span class="s3"># Create the model instance</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">dta_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_Q</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Test dimensions</span>
    <span class="s1">assert_equal(mod.k_endog</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.k_states</span><span class="s2">, </span><span class="s5">5 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.ssm.k_posdef</span><span class="s2">, </span><span class="s5">1 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># Test names</span>
    <span class="s1">assert_equal(mod.endog_names</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s2">, </span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s1">desired = ([</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'L1.0'</span><span class="s2">, </span><span class="s4">'L2.0'</span><span class="s2">, </span><span class="s4">'L3.0'</span><span class="s2">, </span><span class="s4">'L4.0'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'eps_M.M0'</span><span class="s2">, </span><span class="s4">'eps_M.M1'</span><span class="s2">, </span><span class="s4">'eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L2.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L2.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L3.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L3.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L4.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L4.eps_Q.Q1'</span><span class="s1">])</span>
    <span class="s1">assert_equal(mod.state_names</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = [</span>
        <span class="s4">'loading.0-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;M1'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;Q0'</span><span class="s2">,</span>
        <span class="s4">'loading.0-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;0'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_M.M0'</span><span class="s2">, </span><span class="s4">'L1.eps_M.M1'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s2">,</span>
        <span class="s4">'sigma2.M0'</span><span class="s2">, </span><span class="s4">'sigma2.M1'</span><span class="s2">, </span><span class="s4">'sigma2.Q0'</span><span class="s2">, </span><span class="s4">'sigma2.Q1'</span><span class="s1">]</span>
    <span class="s1">assert_equal(mod.param_names</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test fixed elements of state space representation</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">5</span><span class="s1">:</span><span class="s5">7</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">7</span><span class="s1">:</span><span class="s5">9</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">9</span><span class="s1">:</span><span class="s5">11</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">11</span><span class="s1">:</span><span class="s5">13</span><span class="s1">]</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">13</span><span class="s1">:</span><span class="s5">15</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">15</span><span class="s1">:</span><span class="s5">17</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'design'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">20</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">5</span><span class="s2">, </span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">9</span><span class="s1">:</span><span class="s5">17</span><span class="s2">, </span><span class="s5">7</span><span class="s1">:</span><span class="s5">15</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2 </span><span class="s1">* </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'transition'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">12</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">5</span><span class="s1">:</span><span class="s5">7</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">7</span><span class="s1">:</span><span class="s5">9</span><span class="s2">, </span><span class="s5">3</span><span class="s1">:</span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Test parameter entry</span>
    <span class="s1">mod.update(np.arange(mod.k_params) + </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># -&gt; obs_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; design</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">4.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">5.</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; obs_cov</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; transition</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">11.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; selection</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_cov</span>
    <span class="s1">desired = np.array([[</span><span class="s5">49.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">12.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">13.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">14.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">15.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_k_factors_gt1():</span>
    <span class="s3"># Includes 2 monthly and 2 quarterly series</span>
    <span class="s3"># This case: k_factors=2, factor_orders=1, idiosyncratic_ar1=True</span>

    <span class="s3"># Create the datasets</span>
    <span class="s1">index_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">index_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>

    <span class="s1">dta_M = pd.DataFrame(np.zeros((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_M</span><span class="s2">,</span>
                         <span class="s1">columns=[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s1">])</span>
    <span class="s1">dta_Q = pd.DataFrame(np.zeros((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_Q</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s3"># Add some noise so the variables aren't constants</span>
    <span class="s1">dta_M.iloc[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_Q.iloc[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1.</span>

    <span class="s3"># Create the model instance</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">dta_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_Q</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">factor_orders={(</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s1">): </span><span class="s5">1</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Test dimensions</span>
    <span class="s1">assert_equal(mod.k_endog</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.k_states</span><span class="s2">, </span><span class="s5">5 </span><span class="s1">* </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.ssm.k_posdef</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># Test names</span>
    <span class="s1">assert_equal(mod.endog_names</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s2">, </span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s1">desired = ([</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'L1.0'</span><span class="s2">, </span><span class="s4">'L1.1'</span><span class="s2">, </span><span class="s4">'L2.0'</span><span class="s2">, </span><span class="s4">'L2.1'</span><span class="s2">,</span>
                <span class="s4">'L3.0'</span><span class="s2">, </span><span class="s4">'L3.1'</span><span class="s2">, </span><span class="s4">'L4.0'</span><span class="s2">, </span><span class="s4">'L4.1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'eps_M.M0'</span><span class="s2">, </span><span class="s4">'eps_M.M1'</span><span class="s2">, </span><span class="s4">'eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L2.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L2.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L3.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L3.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L4.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L4.eps_Q.Q1'</span><span class="s1">])</span>
    <span class="s1">assert_equal(mod.state_names</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = [</span>
        <span class="s4">'loading.0-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.0-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L1.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,2]'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_M.M0'</span><span class="s2">, </span><span class="s4">'L1.eps_M.M1'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s2">,</span>
        <span class="s4">'sigma2.M0'</span><span class="s2">, </span><span class="s4">'sigma2.M1'</span><span class="s2">, </span><span class="s4">'sigma2.Q0'</span><span class="s2">, </span><span class="s4">'sigma2.Q1'</span><span class="s1">]</span>
    <span class="s1">assert_equal(mod.param_names</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test fixed elements of state space representation</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">16</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">16</span><span class="s1">:</span><span class="s5">18</span><span class="s1">]</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">18</span><span class="s1">:</span><span class="s5">20</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">20</span><span class="s1">:</span><span class="s5">22</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'design'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">20</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">10</span><span class="s2">, </span><span class="s1">:</span><span class="s5">8</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">8</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">22</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2 </span><span class="s1">* </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'transition'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">16</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s2">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Test parameter entry</span>
    <span class="s1">mod.update(np.arange(mod.k_params) + </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># -&gt; obs_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; design</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">27</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; obs_cov</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; transition</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">12</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">17</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">19</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; selection</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_cov</span>
    <span class="s1">L = np.array([[</span><span class="s5">14.</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
                  <span class="s1">[</span><span class="s5">15.</span><span class="s2">, </span><span class="s5">16.</span><span class="s1">]])</span>
    <span class="s1">desired = np.array([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">22</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">23</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">24</span><span class="s1">]])</span>
    <span class="s1">desired[:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = np.dot(L</span><span class="s2">, </span><span class="s1">L.T)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_factor_order_gt1():</span>
    <span class="s3"># Includes 2 monthly and 2 quarterly series</span>
    <span class="s3"># This case: factors=1, factor_orders=6, idiosyncratic_ar1=True</span>

    <span class="s3"># Create the datasets</span>
    <span class="s1">index_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">index_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>

    <span class="s1">dta_M = pd.DataFrame(np.zeros((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_M</span><span class="s2">,</span>
                         <span class="s1">columns=[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s1">])</span>
    <span class="s1">dta_Q = pd.DataFrame(np.zeros((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_Q</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s3"># Add some noise so the variables aren't constants</span>
    <span class="s1">dta_M.iloc[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_Q.iloc[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1.</span>

    <span class="s3"># Create the model instance</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">dta_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_Q</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">6</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Test dimensions</span>
    <span class="s1">assert_equal(mod.k_endog</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.k_states</span><span class="s2">, </span><span class="s5">6 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.ssm.k_posdef</span><span class="s2">, </span><span class="s5">1 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># Test names</span>
    <span class="s1">assert_equal(mod.endog_names</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s2">, </span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s1">desired = ([</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'L1.0'</span><span class="s2">, </span><span class="s4">'L2.0'</span><span class="s2">, </span><span class="s4">'L3.0'</span><span class="s2">, </span><span class="s4">'L4.0'</span><span class="s2">,</span>
                <span class="s4">'L5.0'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'eps_M.M0'</span><span class="s2">, </span><span class="s4">'eps_M.M1'</span><span class="s2">, </span><span class="s4">'eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L2.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L2.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L3.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L3.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L4.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L4.eps_Q.Q1'</span><span class="s1">])</span>
    <span class="s1">assert_equal(mod.state_names</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = [</span>
        <span class="s4">'loading.0-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;M1'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;Q0'</span><span class="s2">,</span>
        <span class="s4">'loading.0-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L2.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L3.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L4.0-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L5.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L6.0-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_M.M0'</span><span class="s2">, </span><span class="s4">'L1.eps_M.M1'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s2">,</span>
        <span class="s4">'sigma2.M0'</span><span class="s2">, </span><span class="s4">'sigma2.M1'</span><span class="s2">, </span><span class="s4">'sigma2.Q0'</span><span class="s2">, </span><span class="s4">'sigma2.Q1'</span><span class="s1">]</span>
    <span class="s1">assert_equal(mod.param_names</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test fixed elements of state space representation</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">6</span><span class="s1">:</span><span class="s5">8</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">8</span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s1">]</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">16</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">16</span><span class="s1">:</span><span class="s5">18</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'design'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">20</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">6</span><span class="s2">, </span><span class="s1">:</span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">5</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s5">18</span><span class="s2">, </span><span class="s5">8</span><span class="s1">:</span><span class="s5">16</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2 </span><span class="s1">* </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'transition'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">13</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">1</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">6</span><span class="s1">:</span><span class="s5">8</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s5">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">8</span><span class="s1">:</span><span class="s5">10</span><span class="s2">, </span><span class="s5">3</span><span class="s1">:</span><span class="s5">5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Test parameter entry</span>
    <span class="s1">mod.update(np.arange(mod.k_params) + </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># -&gt; obs_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; design</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">4.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">5.</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s5">6</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; obs_cov</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; transition</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; selection</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">5</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_cov</span>
    <span class="s1">desired = np.array([[</span><span class="s5">144</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">17.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">18.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">19.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">20.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_k_factors_gt1_factor_order_gt1():</span>
    <span class="s3"># Includes 2 monthly and 2 quarterly series</span>
    <span class="s3"># This case: kactors=2, factor_orders=6, idiosyncratic_ar1=True</span>

    <span class="s3"># Create the datasets</span>
    <span class="s1">index_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">index_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>

    <span class="s1">dta_M = pd.DataFrame(np.zeros((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_M</span><span class="s2">,</span>
                         <span class="s1">columns=[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s1">])</span>
    <span class="s1">dta_Q = pd.DataFrame(np.zeros((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_Q</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s3"># Add some noise so the variables aren't constants</span>
    <span class="s1">dta_M.iloc[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_Q.iloc[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1.</span>

    <span class="s3"># Create the model instance</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">dta_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_Q</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">factor_orders={(</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s1">): </span><span class="s5">6</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Test dimensions</span>
    <span class="s1">assert_equal(mod.k_endog</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.k_states</span><span class="s2">, </span><span class="s5">6 </span><span class="s1">* </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.ssm.k_posdef</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># Test names</span>
    <span class="s1">assert_equal(mod.endog_names</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s2">, </span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s1">desired = ([</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'L1.0'</span><span class="s2">, </span><span class="s4">'L1.1'</span><span class="s2">, </span><span class="s4">'L2.0'</span><span class="s2">, </span><span class="s4">'L2.1'</span><span class="s2">,</span>
                <span class="s4">'L3.0'</span><span class="s2">, </span><span class="s4">'L3.1'</span><span class="s2">, </span><span class="s4">'L4.0'</span><span class="s2">, </span><span class="s4">'L4.1'</span><span class="s2">, </span><span class="s4">'L5.0'</span><span class="s2">,</span>
                <span class="s4">'L5.1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'eps_M.M0'</span><span class="s2">, </span><span class="s4">'eps_M.M1'</span><span class="s2">, </span><span class="s4">'eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L2.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L2.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L3.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L3.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L4.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L4.eps_Q.Q1'</span><span class="s1">])</span>
    <span class="s1">assert_equal(mod.state_names</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = [</span>
        <span class="s4">'loading.0-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.0-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L2.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L2.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L3.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L3.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L4.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L4.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L5.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L5.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L6.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L6.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L2.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L2.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'L3.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L3.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L4.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L4.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'L5.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L5.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L6.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L6.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,2]'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_M.M0'</span><span class="s2">, </span><span class="s4">'L1.eps_M.M1'</span><span class="s2">,</span>
        <span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s2">,</span>
        <span class="s4">'sigma2.M0'</span><span class="s2">, </span><span class="s4">'sigma2.M1'</span><span class="s2">, </span><span class="s4">'sigma2.Q0'</span><span class="s2">, </span><span class="s4">'sigma2.Q1'</span><span class="s1">]</span>
    <span class="s1">assert_equal(mod.param_names</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test fixed elements of state space representation</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">16</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">16</span><span class="s1">:</span><span class="s5">18</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">18</span><span class="s1">:</span><span class="s5">20</span><span class="s1">]</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">20</span><span class="s1">:</span><span class="s5">22</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">22</span><span class="s1">:</span><span class="s5">24</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'design'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">20</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">10</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">16</span><span class="s1">:</span><span class="s5">24</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">22</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2 </span><span class="s1">* </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'transition'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">18</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">16</span><span class="s2">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Test parameter entry</span>
    <span class="s1">mod.update(np.arange(mod.k_params) + </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># -&gt; obs_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; design</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">27</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; obs_cov</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; transition</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">17</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">19</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">22</span><span class="s2">, </span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">26</span><span class="s2">, </span><span class="s5">27</span><span class="s2">, </span><span class="s5">28</span><span class="s2">, </span><span class="s5">29</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">31</span><span class="s2">, </span><span class="s5">32</span><span class="s2">, </span><span class="s5">33</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">37</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">39</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">40</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; selection</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">6</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_cov</span>
    <span class="s1">L = np.array([[</span><span class="s5">34.</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
                  <span class="s1">[</span><span class="s5">35.</span><span class="s2">, </span><span class="s5">36.</span><span class="s1">]])</span>
    <span class="s1">desired = np.array([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">41</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">42</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">43</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">44</span><span class="s1">]])</span>
    <span class="s1">desired[:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = np.dot(L</span><span class="s2">, </span><span class="s1">L.T)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_k_factors_gt1_factor_order_gt1_no_idiosyncratic_ar1():</span>
    <span class="s3"># Includes 2 monthly and 2 quarterly series</span>
    <span class="s3"># This case: factors=2, factor_orders=6, idiosyncratic_ar1=False</span>

    <span class="s3"># Create the datasets</span>
    <span class="s1">index_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">12</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">index_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">4</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>

    <span class="s1">dta_M = pd.DataFrame(np.zeros((</span><span class="s5">12</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_M</span><span class="s2">,</span>
                         <span class="s1">columns=[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s1">])</span>
    <span class="s1">dta_Q = pd.DataFrame(np.zeros((</span><span class="s5">4</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=index_Q</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s3"># Add some noise so the variables aren't constants</span>
    <span class="s1">dta_M.iloc[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_Q.iloc[</span><span class="s5">1</span><span class="s1">] = </span><span class="s5">1.</span>

    <span class="s3"># Create the model instance</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">dta_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_Q</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">factor_orders={(</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s1">): </span><span class="s5">6</span><span class="s1">}</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Test dimensions</span>
    <span class="s1">assert_equal(mod.k_endog</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.k_states</span><span class="s2">, </span><span class="s5">6 </span><span class="s1">* </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2 </span><span class="s1">* </span><span class="s5">5</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod.ssm.k_posdef</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">+ </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># Test names</span>
    <span class="s1">assert_equal(mod.endog_names</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M0'</span><span class="s2">, </span><span class="s4">'M1'</span><span class="s2">, </span><span class="s4">'Q0'</span><span class="s2">, </span><span class="s4">'Q1'</span><span class="s1">])</span>
    <span class="s1">desired = ([</span><span class="s4">'0'</span><span class="s2">, </span><span class="s4">'1'</span><span class="s2">, </span><span class="s4">'L1.0'</span><span class="s2">, </span><span class="s4">'L1.1'</span><span class="s2">, </span><span class="s4">'L2.0'</span><span class="s2">, </span><span class="s4">'L2.1'</span><span class="s2">,</span>
                <span class="s4">'L3.0'</span><span class="s2">, </span><span class="s4">'L3.1'</span><span class="s2">, </span><span class="s4">'L4.0'</span><span class="s2">, </span><span class="s4">'L4.1'</span><span class="s2">, </span><span class="s4">'L5.0'</span><span class="s2">,</span>
                <span class="s4">'L5.1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L1.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L1.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L2.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L2.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L3.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L3.eps_Q.Q1'</span><span class="s1">] +</span>
               <span class="s1">[</span><span class="s4">'L4.eps_Q.Q0'</span><span class="s2">, </span><span class="s4">'L4.eps_Q.Q1'</span><span class="s1">])</span>
    <span class="s1">assert_equal(mod.state_names</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = [</span>
        <span class="s4">'loading.0-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;M0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;M1'</span><span class="s2">,</span>
        <span class="s4">'loading.0-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.1-&gt;Q0'</span><span class="s2">, </span><span class="s4">'loading.0-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'loading.1-&gt;Q1'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L2.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L2.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L3.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L3.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L4.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L4.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L5.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L5.1-&gt;0'</span><span class="s2">, </span><span class="s4">'L6.0-&gt;0'</span><span class="s2">, </span><span class="s4">'L6.1-&gt;0'</span><span class="s2">,</span>
        <span class="s4">'L1.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L1.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L2.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L2.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'L3.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L3.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L4.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L4.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'L5.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L5.1-&gt;1'</span><span class="s2">, </span><span class="s4">'L6.0-&gt;1'</span><span class="s2">, </span><span class="s4">'L6.1-&gt;1'</span><span class="s2">,</span>
        <span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,1]'</span><span class="s2">, </span><span class="s4">'fb(0).cov.chol[2,2]'</span><span class="s2">,</span>
        <span class="s4">'sigma2.M0'</span><span class="s2">, </span><span class="s4">'sigma2.M1'</span><span class="s2">, </span><span class="s4">'sigma2.Q0'</span><span class="s2">, </span><span class="s4">'sigma2.Q1'</span><span class="s1">]</span>
    <span class="s1">assert_equal(mod.param_names</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test fixed elements of state space representation</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">16</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">16</span><span class="s1">:</span><span class="s5">18</span><span class="s1">]</span><span class="s2">, </span><span class="s5">3 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">18</span><span class="s1">:</span><span class="s5">20</span><span class="s1">]</span><span class="s2">, </span><span class="s5">2 </span><span class="s1">* np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s2">, </span><span class="s5">20</span><span class="s1">:</span><span class="s5">22</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'design'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">18</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s1">:</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">10</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">14</span><span class="s1">:</span><span class="s5">22</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">20</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2 </span><span class="s1">* </span><span class="s5">4</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'transition'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">18</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'selection'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s5">14</span><span class="s2">, </span><span class="s5">2</span><span class="s1">:</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.eye(</span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)</span>

    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Test parameter entry</span>
    <span class="s1">mod.update(np.arange(mod.k_params) + </span><span class="s5">2</span><span class="s1">)</span>

    <span class="s3"># -&gt; obs_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; design</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">2.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">4.</span><span class="s2">, </span><span class="s5">5.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">21</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">6.</span><span class="s2">, </span><span class="s5">7.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">27</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">8.</span><span class="s2">, </span><span class="s5">9.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">3.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">2.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'design'</span><span class="s2">, </span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; obs_cov</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'obs_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.diag([</span><span class="s5">37</span><span class="s2">, </span><span class="s5">38</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]))</span>

    <span class="s3"># -&gt; state_intercept</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_intercept'</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># -&gt; transition</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">10</span><span class="s2">, </span><span class="s5">11</span><span class="s2">, </span><span class="s5">12</span><span class="s2">, </span><span class="s5">13</span><span class="s2">, </span><span class="s5">14</span><span class="s2">, </span><span class="s5">15</span><span class="s2">, </span><span class="s5">16</span><span class="s2">, </span><span class="s5">17</span><span class="s2">, </span><span class="s5">18</span><span class="s2">, </span><span class="s5">19</span><span class="s2">, </span><span class="s5">20</span><span class="s2">, </span><span class="s5">21</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">22</span><span class="s2">, </span><span class="s5">23</span><span class="s2">, </span><span class="s5">24</span><span class="s2">, </span><span class="s5">25</span><span class="s2">, </span><span class="s5">26</span><span class="s2">, </span><span class="s5">27</span><span class="s2">, </span><span class="s5">28</span><span class="s2">, </span><span class="s5">29</span><span class="s2">, </span><span class="s5">30</span><span class="s2">, </span><span class="s5">31</span><span class="s2">, </span><span class="s5">32</span><span class="s2">, </span><span class="s5">33</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">desired = np.array([</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">1.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'transition'</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:</span><span class="s2">, </span><span class="s5">12</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># -&gt; selection</span>
    <span class="s1">assert_allclose(np.sum(mod[</span><span class="s4">'selection'</span><span class="s1">])</span><span class="s2">, </span><span class="s5">4</span><span class="s1">)</span>

    <span class="s3"># -&gt; state_cov</span>
    <span class="s1">L = np.array([[</span><span class="s5">34.</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
                  <span class="s1">[</span><span class="s5">35.</span><span class="s2">, </span><span class="s5">36.</span><span class="s1">]])</span>
    <span class="s1">desired = np.array([[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">39</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span><span class="s2">,</span>
                        <span class="s1">[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">40</span><span class="s1">]])</span>
    <span class="s1">desired[:</span><span class="s5">2</span><span class="s2">, </span><span class="s1">:</span><span class="s5">2</span><span class="s1">] = np.dot(L</span><span class="s2">, </span><span class="s1">L.T)</span>
    <span class="s1">assert_allclose(mod[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_invalid_model_specification():</span>
    <span class="s3"># Test for errors that can be raised for invalid model specifications</span>
    <span class="s3"># during __init__</span>
    <span class="s1">dta = np.zeros((</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">dta[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1.</span>
    <span class="s1">dta_pd = pd.DataFrame(dta)</span>
    <span class="s1">dta_period_W = pd.DataFrame(</span>
        <span class="s1">dta</span><span class="s2">, </span><span class="s1">index=pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'W'</span><span class="s1">))</span>
    <span class="s1">dta_date_W = pd.DataFrame(</span>
        <span class="s1">dta</span><span class="s2">, </span><span class="s1">index=pd.date_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'W'</span><span class="s1">))</span>
    <span class="s1">dta_period_M = pd.DataFrame(</span>
        <span class="s1">dta</span><span class="s2">, </span><span class="s1">index=pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">))</span>
    <span class="s1">dta_date_M = pd.DataFrame(</span>
        <span class="s1">dta</span><span class="s2">, </span><span class="s1">index=pd.date_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">))</span>
    <span class="s1">dta_period_Q = pd.DataFrame(</span>
        <span class="s1">dta</span><span class="s2">, </span><span class="s1">index=pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">))</span>

    <span class="s3"># Error if k_factors == 0</span>
    <span class="s1">msg = </span><span class="s4">'The model must contain at least one factor.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Error if k_factors, factor_multiplicities, or factor_orders is something</span>
    <span class="s3"># besides int or dict</span>
    <span class="s1">msg = (</span><span class="s4">'`factors` argument must an integer number of factors, a list of'</span>
           <span class="s4">' global factor names, or a dictionary, mapping observed variables'</span>
           <span class="s4">' to factors.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factors=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">msg = </span><span class="s4">'`factor_orders` argument must either be an integer or a dictionary.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">msg = (</span><span class="s4">'`factor_multiplicities` argument must either be an integer or a'</span>
           <span class="s4">' dictionary.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factor_multiplicities=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Error if k_factors &gt; k_endog_M</span>
    <span class="s1">msg = </span><span class="s4">fr'Number of factors \(</span><span class="s2">{</span><span class="s1">dta.shape[</span><span class="s5">1</span><span class="s1">] + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">\) cannot be greater than'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factors=dta.shape[</span><span class="s5">1</span><span class="s1">] + </span><span class="s5">1</span><span class="s1">)</span>

    <span class="s3"># Error if factor assigned to more than one block</span>
    <span class="s1">factor_orders = {(</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s1">): </span><span class="s5">1</span><span class="s2">, </span><span class="s4">'b'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
    <span class="s1">msg = (</span><span class="s4">'Each factor can be assigned to at most one block of factors in'</span>
           <span class="s4">' `factor_orders`.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factors=[</span><span class="s4">'a'</span><span class="s2">, </span><span class="s4">'b'</span><span class="s1">]</span><span class="s2">,</span>
                                          <span class="s1">factor_orders=factor_orders)</span>

    <span class="s3"># Error if k_endog_monthly and endog_quarterly both specified</span>
    <span class="s1">msg = (</span><span class="s4">'If `endog_quarterly` is specified, then `endog` must contain only'</span>
           <span class="s4">' monthly variables, and so `k_endog_monthly` cannot be specified'</span>
           <span class="s4">' since it will be inferred from the shape of `endog`.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_period_M</span><span class="s2">, </span><span class="s1">k_endog_monthly=</span><span class="s5">2</span><span class="s2">,</span>
                                          <span class="s1">endog_quarterly=dta)</span>

    <span class="s3"># Error if invalid standardize</span>
    <span class="s1">msg = </span><span class="s4">'Invalid value passed for `standardize`.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_period_M</span><span class="s2">, </span><span class="s1">standardize=</span><span class="s4">'a'</span><span class="s1">)</span>

    <span class="s3"># No factors for one endog</span>
    <span class="s1">msg = (</span><span class="s4">'If a `factors` dictionary is provided, then it must include'</span>
           <span class="s4">' entries for each observed variable.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">factors={</span><span class="s4">'y1'</span><span class="s1">: [</span><span class="s4">'a'</span><span class="s1">]})</span>
    <span class="s1">msg = (</span><span class="s4">'Each observed variable must be mapped to at'</span>
           <span class="s4">' least one factor in the `factors` dictionary.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
            <span class="s1">dta</span><span class="s2">, </span><span class="s1">factors={</span><span class="s4">'y1'</span><span class="s1">: [</span><span class="s4">'a'</span><span class="s1">]</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">: []})</span>

    <span class="s3"># Singular column of data + standardization</span>
    <span class="s1">msg = (</span><span class="s4">r'Constant variable\(s\) found in observed variables, but constants'</span>
           <span class="s4">' cannot be included in this model.'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta * </span><span class="s5">0</span><span class="s1">)</span>

    <span class="s3"># Non-pandas data when given both monthly and quarterly</span>
    <span class="s1">msg = </span><span class="s4">'Given monthly dataset is not a Pandas object.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta</span><span class="s2">, </span><span class="s1">endog_quarterly=dta)</span>
    <span class="s1">msg = </span><span class="s4">'Given quarterly dataset is not a Pandas object.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_period_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta)</span>

    <span class="s3"># Pandas data without date index when given both monthly and quarterly</span>
    <span class="s1">msg = </span><span class="s4">'Given monthly dataset has an index with non-date values.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_pd</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_period_Q)</span>
    <span class="s1">msg = </span><span class="s4">'Given quarterly dataset has an index with non-date values.'</span>
    <span class="s3"># (test once with period index for monthly...)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_period_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_pd)</span>
    <span class="s3"># (...and once with date index for monthly)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(dta_date_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_pd)</span>

    <span class="s3"># Pandas data with date index of wrong freq</span>
    <span class="s1">msg = </span><span class="s4">'Index of given monthly dataset has a non-monthly frequency'</span>
    <span class="s3"># (test once with period index for monthly...)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
            <span class="s1">dta_period_W</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_period_Q)</span>
    <span class="s3"># (...and once with date index for monthly)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
            <span class="s1">dta_date_W</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_period_Q)</span>
    <span class="s1">msg = </span><span class="s4">'Index of given quarterly dataset has a non-quarterly frequency'</span>
    <span class="s3"># (test once with period index for quarterly...)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
            <span class="s1">dta_period_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_period_W)</span>
    <span class="s3"># (and once with date index for quarterly...)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
            <span class="s1">dta_date_M</span><span class="s2">, </span><span class="s1">endog_quarterly=dta_date_W)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'freq_Q'</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'Q'</span><span class="s2">, </span><span class="s4">'Q-DEC'</span><span class="s2">, </span><span class="s4">'Q-JAN'</span><span class="s2">, </span><span class="s4">'QS'</span><span class="s2">,</span>
                                    <span class="s4">'QS-DEC'</span><span class="s2">, </span><span class="s4">'QS-APR'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'freq_M'</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'M'</span><span class="s2">, </span><span class="s4">'MS'</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_date_indexes(reset_randomstate</span><span class="s2">, </span><span class="s1">freq_M</span><span class="s2">, </span><span class="s1">freq_Q):</span>
    <span class="s3"># Test that using either PeriodIndex or DatetimeIndex for monthly or</span>
    <span class="s3"># quarterly data, with a variety of DatetimeIndex frequencies, works</span>

    <span class="s3"># Monthly datasets</span>
    <span class="s1">nobs_M = </span><span class="s5">10</span>
    <span class="s1">dates_M = pd.date_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=nobs_M</span><span class="s2">, </span><span class="s1">freq=freq_M)</span>
    <span class="s1">periods_M = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=nobs_M</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">dta_M = np.random.normal(size=(nobs_M</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">endog_period_M = pd.DataFrame(dta_M.copy()</span><span class="s2">, </span><span class="s1">index=periods_M)</span>
    <span class="s1">endog_date_M = pd.DataFrame(dta_M.copy()</span><span class="s2">, </span><span class="s1">index=dates_M)</span>

    <span class="s3"># Quarterly datasets</span>
    <span class="s1">nobs_Q = </span><span class="s5">3</span>
    <span class="s1">dates_Q = pd.date_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=nobs_Q</span><span class="s2">, </span><span class="s1">freq=freq_Q)</span>
    <span class="s1">periods_Q = pd.period_range(start=</span><span class="s4">'2000'</span><span class="s2">, </span><span class="s1">periods=nobs_Q</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'Q'</span><span class="s1">)</span>
    <span class="s1">dta_Q = np.random.normal(size=(nobs_Q</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">endog_period_Q = pd.DataFrame(dta_Q.copy()</span><span class="s2">, </span><span class="s1">index=periods_Q)</span>
    <span class="s1">endog_date_Q = pd.DataFrame(dta_Q.copy()</span><span class="s2">, </span><span class="s1">index=dates_Q)</span>

    <span class="s3"># Baseline is monthly periods and quarterly periods</span>
    <span class="s1">mod_base = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_period_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_period_Q)</span>

    <span class="s3"># Test against monthly dates and quarterly dates</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_date_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_date_Q)</span>
    <span class="s1">assert_(mod._index.equals(mod_base._index))</span>
    <span class="s1">assert_allclose(mod.endog</span><span class="s2">, </span><span class="s1">mod_base.endog)</span>

    <span class="s3"># Test against monthly dates and quarterly periods</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_date_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_period_Q)</span>
    <span class="s1">assert_(mod._index.equals(mod_base._index))</span>
    <span class="s1">assert_allclose(mod.endog</span><span class="s2">, </span><span class="s1">mod_base.endog)</span>

    <span class="s3"># Test against monthly periods and quarterly dates</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_period_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_date_Q)</span>
    <span class="s1">assert_(mod._index.equals(mod_base._index))</span>
    <span class="s1">assert_allclose(mod.endog</span><span class="s2">, </span><span class="s1">mod_base.endog)</span>


<span class="s2">def </span><span class="s1">gen_dfm_data(k_endog=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">1000</span><span class="s1">):</span>
    <span class="s2">if </span><span class="s1">k_endog &gt; </span><span class="s5">10</span><span class="s1">:</span>
        <span class="s2">raise </span><span class="s1">ValueError(</span><span class="s4">'Only allows for k_endog &lt;= 10'</span><span class="s1">)</span>
    <span class="s1">ix = pd.period_range(start=</span><span class="s4">'1950-01'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">faux = pd.DataFrame([[</span><span class="s5">0</span><span class="s1">] * k_endog]</span><span class="s2">, </span><span class="s1">index=ix)</span>
    <span class="s1">mod = dynamic_factor.DynamicFactor(faux</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">loadings = [</span><span class="s5">0.5</span><span class="s2">, </span><span class="s1">-</span><span class="s5">0.9</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.7</span><span class="s2">, </span><span class="s1">-</span><span class="s5">0.1</span><span class="s2">, </span><span class="s1">-</span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.8</span><span class="s1">][:k_endog]</span>
    <span class="s1">phi = </span><span class="s5">0.5</span>
    <span class="s1">sigma2 = </span><span class="s5">1.0</span>
    <span class="s1">idio_ar1 = [</span><span class="s5">0</span><span class="s1">] * k_endog</span>
    <span class="s1">idio_var = [</span><span class="s5">1.0</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">1.5</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">0.8</span><span class="s2">, </span><span class="s5">1.4</span><span class="s2">, </span><span class="s5">0.1</span><span class="s2">, </span><span class="s5">0.2</span><span class="s2">, </span><span class="s5">0.4</span><span class="s2">, </span><span class="s5">0.5</span><span class="s1">][:k_endog]</span>
    <span class="s1">params = np.r_[loadings</span><span class="s2">, </span><span class="s1">idio_var</span><span class="s2">, </span><span class="s1">phi]</span>
    <span class="s1">endog = mod.simulate(params</span><span class="s2">, </span><span class="s1">nobs)</span>
    <span class="s2">return </span><span class="s1">endog</span><span class="s2">, </span><span class="s1">loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">idio_ar1</span><span class="s2">, </span><span class="s1">idio_var</span>


<span class="s2">def </span><span class="s1">test_results_factors(reset_randomstate):</span>
    <span class="s3"># Tests for the `factors` attribute in the results object</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = gen_dfm_data(k_endog=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">1000</span><span class="s1">)</span>

    <span class="s1">mod_dfm = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=[</span><span class="s4">'global'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">factor_multiplicities=</span><span class="s5">2</span><span class="s2">,</span>
        <span class="s1">standardize=</span><span class="s2">False, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res_dfm = mod_dfm.smooth(mod_dfm.start_params)</span>

    <span class="s1">assert_allclose(res_dfm.factors.smoothed</span><span class="s2">,</span>
                    <span class="s1">res_dfm.states.smoothed[[</span><span class="s4">'global.1'</span><span class="s2">, </span><span class="s4">'global.2'</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(res_dfm.factors.smoothed_cov.values</span><span class="s2">,</span>
                    <span class="s1">res_dfm.states.smoothed_cov.values</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">1e-12</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_coefficient_of_determination(</span>
        <span class="s1">reset_randomstate</span><span class="s2">, </span><span class="s1">close_figures):</span>
    <span class="s3"># Get simulated data, and add in some missing entries</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = gen_dfm_data(k_endog=</span><span class="s5">3</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">1000</span><span class="s1">)</span>
    <span class="s1">endog.iloc[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">10</span><span class="s1">:</span><span class="s5">20</span><span class="s1">] = np.nan</span>
    <span class="s1">endog.iloc[</span><span class="s5">2</span><span class="s2">, </span><span class="s5">15</span><span class="s1">:</span><span class="s5">25</span><span class="s1">] = np.nan</span>

    <span class="s3"># Setup the model and get the results</span>
    <span class="s1">factors = {</span>
        <span class="s5">0</span><span class="s1">: [</span><span class="s4">'global'</span><span class="s2">, </span><span class="s4">'block'</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s5">1</span><span class="s1">: [</span><span class="s4">'global'</span><span class="s2">, </span><span class="s4">'block'</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s5">2</span><span class="s1">: [</span><span class="s4">'global'</span><span class="s1">]</span>
    <span class="s1">}</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=factors</span><span class="s2">, </span><span class="s1">standardize=</span><span class="s2">False, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res = mod.smooth(mod.start_params)</span>

    <span class="s3"># For most of the tests, we'll use smoothed estimates, which are the</span>
    <span class="s3"># default</span>
    <span class="s1">factors = res.factors.smoothed</span>

    <span class="s3"># Test for method='individual'</span>
    <span class="s1">actual = res.get_coefficients_of_determination(method=</span><span class="s4">'individual'</span><span class="s1">)</span>
    <span class="s1">desired = pd.DataFrame(np.zeros((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">,</span>
                           <span class="s1">columns=[</span><span class="s4">'global'</span><span class="s2">, </span><span class="s4">'block'</span><span class="s1">])</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">i == </span><span class="s5">2 </span><span class="s2">and </span><span class="s1">j == </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = np.nan</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">y = endog.iloc[:</span><span class="s2">, </span><span class="s1">i]</span>
                <span class="s1">X = add_constant(factors.iloc[:</span><span class="s2">, </span><span class="s1">j])</span>
                <span class="s1">mod_ols = OLS(y</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing=</span><span class="s4">'drop'</span><span class="s1">)</span>
                <span class="s1">res_ols = mod_ols.fit()</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = res_ols.rsquared</span>
    <span class="s1">assert_(actual.index.equals(desired.index))</span>
    <span class="s1">assert_(actual.columns.equals(desired.columns))</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test for method='joint'</span>
    <span class="s1">actual = res.get_coefficients_of_determination(method=</span><span class="s4">'joint'</span><span class="s1">)</span>
    <span class="s1">desired = pd.Series(np.zeros(</span><span class="s5">3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
        <span class="s1">y = endog.iloc[:</span><span class="s2">, </span><span class="s1">i]</span>
        <span class="s2">if </span><span class="s1">i == </span><span class="s5">2</span><span class="s1">:</span>
            <span class="s1">X = add_constant(factors.iloc[:</span><span class="s2">, </span><span class="s5">0</span><span class="s1">])</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">X = add_constant(factors)</span>
        <span class="s1">mod_ols = OLS(y</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing=</span><span class="s4">'drop'</span><span class="s1">)</span>
        <span class="s1">res_ols = mod_ols.fit()</span>
        <span class="s1">desired.iloc[i] = res_ols.rsquared</span>
    <span class="s1">assert_(actual.index.equals(desired.index))</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test for method='cumulative'</span>
    <span class="s1">actual = res.get_coefficients_of_determination(method=</span><span class="s4">'cumulative'</span><span class="s1">)</span>
    <span class="s1">desired = pd.DataFrame(np.zeros((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">,</span>
                           <span class="s1">columns=[</span><span class="s4">'global'</span><span class="s2">, </span><span class="s4">'block'</span><span class="s1">])</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">i == </span><span class="s5">2 </span><span class="s2">and </span><span class="s1">j == </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = np.nan</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">y = endog.iloc[:</span><span class="s2">, </span><span class="s1">i]</span>
                <span class="s1">X = add_constant(factors.iloc[:</span><span class="s2">, </span><span class="s1">:j + </span><span class="s5">1</span><span class="s1">])</span>
                <span class="s1">mod_ols = OLS(y</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing=</span><span class="s4">'drop'</span><span class="s1">)</span>
                <span class="s1">res_ols = mod_ols.fit()</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = res_ols.rsquared</span>
    <span class="s1">assert_(actual.index.equals(desired.index))</span>
    <span class="s1">assert_(actual.columns.equals(desired.columns))</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test for method='individual', which='filtered'</span>
    <span class="s1">factors = res.factors.filtered</span>
    <span class="s1">actual = res.get_coefficients_of_determination(</span>
        <span class="s1">method=</span><span class="s4">'individual'</span><span class="s2">, </span><span class="s1">which=</span><span class="s4">'filtered'</span><span class="s1">)</span>
    <span class="s1">desired = pd.DataFrame(np.zeros((</span><span class="s5">3</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span><span class="s2">, </span><span class="s1">index=[</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">,</span>
                           <span class="s1">columns=[</span><span class="s4">'global'</span><span class="s2">, </span><span class="s4">'block'</span><span class="s1">])</span>
    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
        <span class="s2">for </span><span class="s1">j </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">i == </span><span class="s5">2 </span><span class="s2">and </span><span class="s1">j == </span><span class="s5">1</span><span class="s1">:</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = np.nan</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">y = endog.iloc[:</span><span class="s2">, </span><span class="s1">i]</span>
                <span class="s1">X = add_constant(factors.iloc[:</span><span class="s2">, </span><span class="s1">j])</span>
                <span class="s1">mod_ols = OLS(y</span><span class="s2">, </span><span class="s1">X</span><span class="s2">, </span><span class="s1">missing=</span><span class="s4">'drop'</span><span class="s1">)</span>
                <span class="s1">res_ols = mod_ols.fit()</span>
                <span class="s1">desired.iloc[i</span><span class="s2">, </span><span class="s1">j] = res_ols.rsquared</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Optional smoke test for plot_coefficient_of_determination</span>
    <span class="s2">try</span><span class="s1">:</span>
        <span class="s2">import </span><span class="s1">matplotlib.pyplot </span><span class="s2">as </span><span class="s1">plt</span>
        <span class="s2">try</span><span class="s1">:</span>
            <span class="s2">from </span><span class="s1">pandas.plotting </span><span class="s2">import </span><span class="s1">register_matplotlib_converters</span>
            <span class="s1">register_matplotlib_converters()</span>
        <span class="s2">except </span><span class="s1">ImportError:</span>
            <span class="s2">pass</span>
        <span class="s1">fig1 = plt.figure()</span>
        <span class="s1">res.plot_coefficients_of_determination(method=</span><span class="s4">'individual'</span><span class="s2">, </span><span class="s1">fig=fig1)</span>
        <span class="s1">fig2 = plt.figure()</span>
        <span class="s1">res.plot_coefficients_of_determination(method=</span><span class="s4">'joint'</span><span class="s2">, </span><span class="s1">fig=fig2)</span>
        <span class="s1">fig3 = plt.figure()</span>
        <span class="s1">res.plot_coefficients_of_determination(method=</span><span class="s4">'cumulative'</span><span class="s2">, </span><span class="s1">fig=fig3)</span>
        <span class="s1">fig4 = plt.figure()</span>
        <span class="s1">res.plot_coefficients_of_determination(which=</span><span class="s4">'filtered'</span><span class="s2">, </span><span class="s1">fig=fig4)</span>
    <span class="s2">except </span><span class="s1">ImportError:</span>
        <span class="s2">pass</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s4">&quot;ignore:Log-likelihood decreased&quot;</span><span class="s1">)</span>
<span class="s2">def </span><span class="s1">test_quasi_newton_fitting(reset_randomstate):</span>
    <span class="s3"># Test that the typical state space quasi-Newton fitting mechanisms work</span>
    <span class="s3"># here too, even if they aren't used much</span>
    <span class="s3"># Note: to match the quasi-Newton results, which use the stationary</span>
    <span class="s3"># initialization, we need to set em_initialization=False</span>
    <span class="s3"># Note: one thing that this test reveals is that there are some numerical</span>
    <span class="s3"># issues with the EM algorithm when em_initialization=False around the</span>
    <span class="s3"># true optimum, where apparently numerical issues case the EM algorithm to</span>
    <span class="s3"># decrease the log-likelihood. In particular, testing updating each block</span>
    <span class="s3"># of parameters shows that it is the updating of the factor autoregressive</span>
    <span class="s3"># coefficients and (it appears) the factor error variance term that are</span>
    <span class="s3"># to blame here.</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = gen_dfm_data(k_endog=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">1000</span><span class="s1">)</span>

    <span class="s3"># Create the test Dynamic Factor MQ models</span>
    <span class="s1">mod_dfm = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                <span class="s1">standardize=</span><span class="s2">False,</span>
                                                <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">mod_dfm_ar1 = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                    <span class="s1">standardize=</span><span class="s2">False,</span>
                                                    <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Check that transform and untransform works</span>
    <span class="s1">x = mod_dfm_ar1.start_params</span>
    <span class="s1">y = mod_dfm_ar1.untransform_params(x)</span>
    <span class="s1">z = mod_dfm_ar1.transform_params(y)</span>
    <span class="s1">assert_allclose(x</span><span class="s2">, </span><span class="s1">z)</span>

    <span class="s3"># Check lbfgs and em converge to the same thing: idiosyncratic_ar1=False</span>
    <span class="s1">res_lbfgs = mod_dfm.fit(method=</span><span class="s4">'lbfgs'</span><span class="s1">)</span>
    <span class="s1">params_lbfgs = res_lbfgs.params.copy()</span>

    <span class="s1">start_params = params_lbfgs.copy()</span>
    <span class="s1">start_params[</span><span class="s4">'L1.0-&gt;0'</span><span class="s1">] += </span><span class="s5">1e-2</span>
    <span class="s1">start_params[</span><span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s1">] += </span><span class="s5">1e-2</span>
    <span class="s1">res_em = mod_dfm.fit(start_params</span><span class="s2">, </span><span class="s1">em_initialization=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">params_em = res_em.params.copy()</span>

    <span class="s1">assert_allclose(res_lbfgs.llf</span><span class="s2">, </span><span class="s1">res_em.llf</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">5e-2</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s5">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(params_lbfgs</span><span class="s2">, </span><span class="s1">params_em</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">5e-2</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s5">1e-5</span><span class="s1">)</span>

    <span class="s3"># Check lbfgs and em converge to the same thing: idiosyncratic_ar1=True</span>
    <span class="s1">res_lbfgs = mod_dfm_ar1.fit(method=</span><span class="s4">'lbfgs'</span><span class="s1">)</span>
    <span class="s1">params_lbfgs = res_lbfgs.params.copy()</span>

    <span class="s1">start_params = params_lbfgs.copy()</span>
    <span class="s1">start_params[</span><span class="s4">'L1.0-&gt;0'</span><span class="s1">] += </span><span class="s5">1e-2</span>
    <span class="s1">start_params[</span><span class="s4">'fb(0).cov.chol[1,1]'</span><span class="s1">] += </span><span class="s5">1e-2</span>
    <span class="s1">res_em = mod_dfm_ar1.fit(params_lbfgs</span><span class="s2">, </span><span class="s1">em_initialization=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">params_em = res_em.params.copy()</span>

    <span class="s1">assert_allclose(res_lbfgs.llf</span><span class="s2">, </span><span class="s1">res_em.llf</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">5e-2</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s5">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(params_lbfgs</span><span class="s2">, </span><span class="s1">params_em</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">5e-2</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s5">1e-5</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_summary(reset_randomstate):</span>
    <span class="s3"># Smoke tests for summaries</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = gen_dfm_data(k_endog=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">100</span><span class="s1">)</span>

    <span class="s3"># Create the test Dynamic Factor MQ models</span>
    <span class="s1">mod_dfm = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                <span class="s1">standardize=</span><span class="s2">False,</span>
                                                <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res_dfm = mod_dfm.smooth(mod_dfm.start_params)</span>
    <span class="s1">mod_dfm_ar1 = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                    <span class="s1">standardize=</span><span class="s2">False,</span>
                                                    <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">res_dfm_ar1 = mod_dfm_ar1.smooth(mod_dfm_ar1.start_params)</span>

    <span class="s1">mod_dfm.summary()</span>
    <span class="s1">assert_equal(str(mod_dfm)</span><span class="s2">, </span><span class="s1">str(mod_dfm.summary()))</span>
    <span class="s1">res_dfm.summary()</span>
    <span class="s1">mod_dfm_ar1.summary()</span>
    <span class="s1">res_dfm_ar1.summary()</span>


<span class="s2">def </span><span class="s1">test_append_extend_apply(reset_randomstate):</span>
    <span class="s3"># Most of `append`, `extend`, and `apply` are tested in</span>
    <span class="s3"># `test_standardized_{monthly,MQ}`, but here we test a couple of minor</span>
    <span class="s3"># things</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">idio_var = (</span>
        <span class="s1">gen_dfm_data(k_endog=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">100</span><span class="s1">))</span>
    <span class="s1">endog1 = endog.iloc[:-</span><span class="s5">10</span><span class="s1">]</span>
    <span class="s1">endog2 = endog.iloc[-</span><span class="s5">10</span><span class="s1">:]</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(endog1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                            <span class="s1">standardize=</span><span class="s2">False,</span>
                                            <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">params = np.r_[loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">idio_var]</span>
    <span class="s1">res = mod.smooth(params)</span>

    <span class="s3"># Test that error is raised if we try to extend the sample with a dataset</span>
    <span class="s3"># of a different dimension</span>
    <span class="s1">msg = </span><span class="s4">'Cannot append data of a different dimension to a model.'</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">res.append(endog2.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">3</span><span class="s1">])</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s1">res.extend(endog2.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s5">3</span><span class="s1">])</span>

    <span class="s3"># Test that copy_initialization works</span>
    <span class="s1">mod.initialize_known([</span><span class="s5">0.1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[[</span><span class="s5">1.0</span><span class="s1">]])</span>
    <span class="s1">res2 = mod.smooth(params)</span>
    <span class="s3"># These asserts just show that the initialization really is different</span>
    <span class="s1">assert_allclose(res.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">4 </span><span class="s1">/ </span><span class="s5">3.</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res2.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0.1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res2.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">)</span>

    <span class="s3"># Check append</span>
    <span class="s1">res3 = res2.append(endog2</span><span class="s2">, </span><span class="s1">copy_initialization=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res3.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res3.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">4 </span><span class="s1">/ </span><span class="s5">3.</span><span class="s1">)</span>

    <span class="s1">res4 = res2.append(endog2</span><span class="s2">, </span><span class="s1">copy_initialization=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res4.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0.1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res4.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">)</span>

    <span class="s3"># Check apply</span>
    <span class="s1">res5 = res2.apply(endog</span><span class="s2">, </span><span class="s1">copy_initialization=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res5.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res5.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">4 </span><span class="s1">/ </span><span class="s5">3.</span><span class="s1">)</span>

    <span class="s1">res6 = res2.apply(endog</span><span class="s2">, </span><span class="s1">copy_initialization=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res6.filter_results.initial_state</span><span class="s2">, </span><span class="s5">0.1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res6.filter_results.initial_state_cov</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_news_monthly(reset_randomstate):</span>
    <span class="s3"># Most of `news` is tested in `test_standardized_{monthly,MQ}`, but here</span>
    <span class="s3"># we test a couple of minor things</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = gen_dfm_data(k_endog=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">100</span><span class="s1">)</span>
    <span class="s1">endog_pre = endog.iloc[:-</span><span class="s5">1</span><span class="s1">].copy()</span>
    <span class="s1">endog_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">] *= </span><span class="s5">1.2</span>
    <span class="s1">endog_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">] = np.nan</span>

    <span class="s3"># Base model</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(endog_pre</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                            <span class="s1">standardize=</span><span class="s2">False,</span>
                                            <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">params = mod.start_params</span>
    <span class="s1">res = mod.smooth(params)</span>

    <span class="s3"># Updated results and desired news output (created using a results object)</span>
    <span class="s1">mod2 = mod.clone(endog)</span>
    <span class="s1">res2 = mod2.smooth(params)</span>
    <span class="s1">desired = res2.news(res</span><span class="s2">, </span><span class="s1">start=endog.index[-</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">comparison_type=</span><span class="s4">'previous'</span><span class="s1">)</span>

    <span class="s3"># Actual news output, created using the updated dataset</span>
    <span class="s1">actual = res.news(endog</span><span class="s2">, </span><span class="s1">start=endog.index[-</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">,</span>
                      <span class="s1">comparison_type=</span><span class="s4">'updated'</span><span class="s1">)</span>

    <span class="s1">attributes = [</span>
        <span class="s4">'total_impacts'</span><span class="s2">, </span><span class="s4">'update_impacts'</span><span class="s2">, </span><span class="s4">'revision_impacts'</span><span class="s2">, </span><span class="s4">'news'</span><span class="s2">,</span>
        <span class="s4">'weights'</span><span class="s2">, </span><span class="s4">'update_forecasts'</span><span class="s2">, </span><span class="s4">'update_realized'</span><span class="s2">,</span>
        <span class="s4">'prev_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'post_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'revisions_iloc'</span><span class="s2">,</span>
        <span class="s4">'revisions_ix'</span><span class="s2">, </span><span class="s4">'updates_iloc'</span><span class="s2">, </span><span class="s4">'updates_ix'</span><span class="s1">]</span>
    <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attributes:</span>
        <span class="s1">w = getattr(actual</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s1">x = getattr(desired</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s2">if </span><span class="s1">isinstance(x</span><span class="s2">, </span><span class="s1">pd.Series):</span>
            <span class="s1">assert_series_equal(w</span><span class="s2">, </span><span class="s1">x)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">assert_frame_equal(w</span><span class="s2">, </span><span class="s1">x)</span>


<span class="s2">def </span><span class="s1">test_news_MQ(reset_randomstate):</span>
    <span class="s3"># Most of `news` is tested in `test_standardized_{monthly,MQ}`, but here</span>
    <span class="s3"># we test a couple of minor things</span>
    <span class="s1">endog_M</span><span class="s2">, </span><span class="s1">endog_Q</span><span class="s2">, </span><span class="s1">f1 = test_dynamic_factor_mq_monte_carlo.gen_k_factor1(</span>
        <span class="s5">100</span><span class="s2">, </span><span class="s1">k=</span><span class="s5">2</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">endog_M_pre = endog_M.iloc[:-</span><span class="s5">1</span><span class="s1">].copy()</span>
    <span class="s1">endog_M_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">] *= </span><span class="s5">1.2</span>
    <span class="s1">endog_M_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">] = np.nan</span>

    <span class="s1">endog_Q_pre = endog_Q.iloc[:-</span><span class="s5">1</span><span class="s1">].copy()</span>
    <span class="s1">endog_Q_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">0</span><span class="s1">] *= </span><span class="s5">1.2</span>
    <span class="s1">endog_Q_pre.iloc[-</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">] = np.nan</span>

    <span class="s3"># Base model</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_M_pre</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q_pre</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">standardize=</span><span class="s2">False, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">params = mod.start_params</span>
    <span class="s1">res = mod.smooth(params)</span>

    <span class="s3"># Updated results and desired news output (created using a results object)</span>
    <span class="s1">mod2 = mod.clone(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q)</span>
    <span class="s1">res2 = mod2.smooth(params)</span>
    <span class="s1">desired = res2.news(res</span><span class="s2">, </span><span class="s1">start=endog_M.index[-</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">,</span>
                        <span class="s1">comparison_type=</span><span class="s4">'previous'</span><span class="s1">)</span>

    <span class="s3"># Actual news output, created using the updated dataset</span>
    <span class="s1">actual = res.news(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q</span><span class="s2">,</span>
                      <span class="s1">start=endog_M.index[-</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">,</span>
                      <span class="s1">comparison_type=</span><span class="s4">'updated'</span><span class="s1">)</span>

    <span class="s1">attributes = [</span>
        <span class="s4">'total_impacts'</span><span class="s2">, </span><span class="s4">'update_impacts'</span><span class="s2">, </span><span class="s4">'revision_impacts'</span><span class="s2">, </span><span class="s4">'news'</span><span class="s2">,</span>
        <span class="s4">'weights'</span><span class="s2">, </span><span class="s4">'update_forecasts'</span><span class="s2">, </span><span class="s4">'update_realized'</span><span class="s2">,</span>
        <span class="s4">'prev_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'post_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'revisions_iloc'</span><span class="s2">,</span>
        <span class="s4">'revisions_ix'</span><span class="s2">, </span><span class="s4">'updates_iloc'</span><span class="s2">, </span><span class="s4">'updates_ix'</span><span class="s1">]</span>
    <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attributes:</span>
        <span class="s1">w = getattr(actual</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s1">x = getattr(desired</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s2">if </span><span class="s1">isinstance(x</span><span class="s2">, </span><span class="s1">pd.Series):</span>
            <span class="s1">assert_series_equal(w</span><span class="s2">, </span><span class="s1">x)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">assert_frame_equal(w</span><span class="s2">, </span><span class="s1">x)</span>


<span class="s2">def </span><span class="s1">test_ar6_no_quarterly(reset_randomstate):</span>
    <span class="s3"># Test to make sure that an example with &gt; 5 lags (which are the number of</span>
    <span class="s3"># lags that are always included in models with quarterly data) works,</span>
    <span class="s3"># for the case without quarterly data</span>

    <span class="s3"># Generate test data</span>
    <span class="s1">ix = pd.period_range(start=</span><span class="s4">'1950-01'</span><span class="s2">, </span><span class="s1">periods=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">freq=</span><span class="s4">'M'</span><span class="s1">)</span>
    <span class="s1">faux = pd.Series([</span><span class="s5">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=ix)</span>
    <span class="s1">mod = sarimax.SARIMAX(faux</span><span class="s2">, </span><span class="s1">order=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s1">params = np.r_[</span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.</span><span class="s2">, </span><span class="s5">0.5</span><span class="s2">, </span><span class="s5">1.0</span><span class="s1">]</span>
    <span class="s1">endog = mod.simulate(params</span><span class="s2">, </span><span class="s5">100</span><span class="s1">)</span>

    <span class="s3"># Create the baseline SARIMAX and the test Dynamic Factor MQ model</span>
    <span class="s1">mod_ar = sarimax.SARIMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s5">6</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">))</span>
    <span class="s1">mod_dfm = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">6</span><span class="s2">,</span>
                                                <span class="s1">standardize=</span><span class="s2">False,</span>
                                                <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Test that SARIMAX and DFM MQ produce the same loglike</span>
    <span class="s1">llf_ar = mod_ar.loglike(params)</span>
    <span class="s1">llf_dfm = mod_dfm.loglike(np.r_[</span><span class="s5">1</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">])</span>
    <span class="s1">assert_allclose(llf_dfm</span><span class="s2">, </span><span class="s1">llf_ar)</span>

    <span class="s3"># Monte Carlo-type test, skipped by default</span>
    <span class="s2">if not </span><span class="s1">SKIP_MONTE_CARLO_TESTS:</span>
        <span class="s3"># Test for MLE fitting: this is a Monte Carlo test, which requires a</span>
        <span class="s3"># large sample size; e.g., use nobs=10000 for atol=1e-2</span>
        <span class="s1">res_dfm = mod_dfm.fit()</span>
        <span class="s1">actual = res_dfm.params</span>
        <span class="s3"># normalize loading = 1, which requires us to multiply std. dev. of</span>
        <span class="s3"># factor (which is `actual[-2]`) by the estimated loading (`actual[0]`)</span>
        <span class="s1">actual[-</span><span class="s5">2</span><span class="s1">] *= actual[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">actual[</span><span class="s5">0</span><span class="s1">] = </span><span class="s5">1</span>
        <span class="s1">assert_allclose(res_dfm.params[</span><span class="s5">1</span><span class="s1">:-</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">params</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">1e-2</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_idiosyncratic_ar1_False(reset_randomstate):</span>
    <span class="s3"># Test the case with idiosyncratic_ar1=False (which is not tested in</span>
    <span class="s3"># the test_dynamic_factor_mq_frbny_nowcast) by comparison to a model with</span>
    <span class="s3"># idiosyncratic_ar1=True but no actual serial correlation in the</span>
    <span class="s3"># idiosyncratic component</span>
    <span class="s1">endog</span><span class="s2">, </span><span class="s1">loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">idio_ar1</span><span class="s2">, </span><span class="s1">idio_var = gen_dfm_data(</span>
        <span class="s1">k_endog=</span><span class="s5">10</span><span class="s2">, </span><span class="s1">nobs=</span><span class="s5">1000</span><span class="s1">)</span>

    <span class="s3"># Create the baseline SARIMAX and the test Dynamic Factor MQ model</span>
    <span class="s1">mod_base = dynamic_factor.DynamicFactor(endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">mod_dfm = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                <span class="s1">standardize=</span><span class="s2">False,</span>
                                                <span class="s1">idiosyncratic_ar1=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">mod_dfm_ar1 = dynamic_factor_mq.DynamicFactorMQ(endog</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
                                                    <span class="s1">standardize=</span><span class="s2">False,</span>
                                                    <span class="s1">idiosyncratic_ar1=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">params = np.r_[loadings</span><span class="s2">, </span><span class="s1">idio_var</span><span class="s2">, </span><span class="s1">phi]</span>
    <span class="s1">params_dfm = np.r_[loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">idio_var]</span>
    <span class="s1">params_dfm_ar1 = np.r_[loadings</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s1">sigma2</span><span class="s2">, </span><span class="s1">idio_ar1</span><span class="s2">, </span><span class="s1">idio_var]</span>

    <span class="s3"># Test that these models all produce the same loglikelihood</span>
    <span class="s1">llf_base = mod_base.loglike(params)</span>
    <span class="s1">llf_dfm = mod_dfm.loglike(params_dfm)</span>
    <span class="s1">llf_dfm_ar1 = mod_dfm_ar1.loglike(params_dfm_ar1)</span>

    <span class="s1">assert_allclose(llf_dfm_ar1</span><span class="s2">, </span><span class="s1">llf_dfm)</span>
    <span class="s1">assert_allclose(llf_dfm</span><span class="s2">, </span><span class="s1">llf_base)</span>
    <span class="s1">assert_allclose(llf_dfm_ar1</span><span class="s2">, </span><span class="s1">llf_base)</span>

    <span class="s3"># Test that these methods produce the same smoothed estimates of the</span>
    <span class="s3"># idiosyncratic disturbance</span>
    <span class="s1">res0_dfm = mod_dfm.smooth(params_dfm)</span>
    <span class="s1">res0_dfm_ar1 = mod_dfm_ar1.smooth(params_dfm_ar1)</span>
    <span class="s1">assert_allclose(res0_dfm.smoothed_measurement_disturbance</span><span class="s2">,</span>
                    <span class="s1">res0_dfm_ar1.smoothed_state[</span><span class="s5">1</span><span class="s1">:])</span>
    <span class="s1">assert_allclose(res0_dfm.smoothed_measurement_disturbance_cov</span><span class="s2">,</span>
                    <span class="s1">res0_dfm_ar1.smoothed_state_cov[</span><span class="s5">1</span><span class="s1">:</span><span class="s2">, </span><span class="s5">1</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:])</span>

    <span class="s3"># Note: it is difficult to test the EM algorithm for the idiosyncratic</span>
    <span class="s3"># variance terms, because actually the EM algorithm is slightly different</span>
    <span class="s3"># depending on whether idiosyncratic_ar1 is True or False.</span>
    <span class="s3"># - If idiosyncratic_ar1=False, then the variance term is computed</span>
    <span class="s3">#   conditional on the *updated estimate for the design matrix*, but the</span>
    <span class="s3">#   smoothed moments that were generated conditional on the *previous*</span>
    <span class="s3">#   estimate for the design matrix.</span>
    <span class="s3"># - If idiosyntratic_ar1=True, then the variance term is computed</span>
    <span class="s3">#   conditional on the *previous estimate for the design matrix* (this is</span>
    <span class="s3">#   because the estimated disturbance is part of the state vector, the</span>
    <span class="s3">#   estimates of which are not modified to account for the updated design</span>
    <span class="s3">#   matrix within this iteration)</span>
    <span class="s3">#</span>
    <span class="s3"># So instead, we'll just use a Monte Carlo-type test</span>

    <span class="s3"># Monte Carlo-type test, skipped by default</span>
    <span class="s2">if not </span><span class="s1">SKIP_MONTE_CARLO_TESTS:</span>
        <span class="s3"># Test for MLE fitting: this is a Monte Carlo test, which requires a</span>
        <span class="s3"># quite large sample size; e.g., use nobs=50000 for atol=1e-1</span>
        <span class="s1">res_dfm = mod_dfm.fit()</span>
        <span class="s1">actual_dfm = res_dfm.params.copy()</span>
        <span class="s3"># normalize loadings and factor std dev.</span>
        <span class="s1">scalar = actual_dfm[</span><span class="s5">0</span><span class="s1">] / params_dfm[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">actual_dfm[</span><span class="s5">11</span><span class="s1">] *= scalar</span>
        <span class="s1">actual_dfm[:</span><span class="s5">10</span><span class="s1">] /= scalar</span>
        <span class="s1">assert_allclose(actual_dfm</span><span class="s2">, </span><span class="s1">params_dfm</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">1e-1</span><span class="s1">)</span>

        <span class="s1">res_dfm_ar1 = mod_dfm_ar1.fit()</span>
        <span class="s1">actual_dfm_ar1 = res_dfm_ar1.params.copy()</span>
        <span class="s3"># normalize loadings and factor std dev.</span>
        <span class="s1">scalar = actual_dfm_ar1[</span><span class="s5">0</span><span class="s1">] / params_dfm[</span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">actual_dfm_ar1[</span><span class="s5">11</span><span class="s1">] *= scalar</span>
        <span class="s1">actual_dfm_ar1[:</span><span class="s5">10</span><span class="s1">] /= scalar</span>
        <span class="s1">assert_allclose(actual_dfm_ar1</span><span class="s2">, </span><span class="s1">params_dfm_ar1</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">1e-1</span><span class="s1">)</span>

        <span class="s3"># Check the methods against each other</span>
        <span class="s1">desired = np.r_[actual_dfm_ar1[:</span><span class="s5">12</span><span class="s1">]</span><span class="s2">, </span><span class="s1">actual_dfm_ar1[-</span><span class="s5">10</span><span class="s1">:]]</span>
        <span class="s1">assert_allclose(actual_dfm</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">, </span><span class="s1">atol=</span><span class="s5">1e-1</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_invalid_standardize_1d():</span>
    <span class="s1">endog = np.zeros(</span><span class="s5">100</span><span class="s1">) + </span><span class="s5">10</span>
    <span class="s1">endog_pd = pd.Series(endog</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">'y1'</span><span class="s1">)</span>

    <span class="s3"># Wrong shape</span>
    <span class="s1">options = [([]</span><span class="s2">, </span><span class="s5">10</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">[])</span><span class="s2">, </span><span class="s1">([]</span><span class="s2">, </span><span class="s1">[])</span><span class="s2">, </span><span class="s1">([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1.</span><span class="s1">])</span><span class="s2">, </span><span class="s1">([</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2.</span><span class="s1">])]</span>
    <span class="s1">msg = </span><span class="s4">'Invalid value passed for `standardize`: each element must be shaped'</span>
    <span class="s2">for </span><span class="s1">standardize </span><span class="s2">in </span><span class="s1">options:</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
                <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False,</span>
                <span class="s1">standardize=standardize)</span>

    <span class="s3"># Wrong index: ndarray</span>
    <span class="s1">options = [</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s1">))</span><span class="s2">,</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s1">]))</span><span class="s2">,</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s1">]))</span><span class="s2">,</span>
        <span class="s1">(pd.Series([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">]))]</span>
    <span class="s1">msg = (</span><span class="s4">'Invalid value passed for `standardize`: if a Pandas Series, must'</span>
           <span class="s4">' have index'</span><span class="s1">)</span>
    <span class="s2">for </span><span class="s1">standardize </span><span class="s2">in </span><span class="s1">options:</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
                <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False,</span>
                <span class="s1">standardize=standardize)</span>

    <span class="s3"># Wrong index: pd.Series</span>
    <span class="s1">options = [</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s1">)</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s1">))</span><span class="s2">,</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s1">]))</span><span class="s2">,</span>
        <span class="s1">(pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">]))</span><span class="s2">,</span>
        <span class="s1">(pd.Series([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">]))]</span>
    <span class="s1">msg = (</span><span class="s4">'Invalid value passed for `standardize`: if a Pandas Series, must'</span>
           <span class="s4">' have index'</span><span class="s1">)</span>
    <span class="s2">for </span><span class="s1">standardize </span><span class="s2">in </span><span class="s1">options:</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
            <span class="s1">dynamic_factor_mq.DynamicFactorMQ(</span>
                <span class="s1">endog_pd</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False,</span>
                <span class="s1">standardize=standardize)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'use_pandas'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'standardize'</span><span class="s2">, </span><span class="s1">[</span>
    <span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s1">)</span><span class="s2">, </span><span class="s1">([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">10</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(np.array(</span><span class="s5">10</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.array(</span><span class="s5">10</span><span class="s1">))</span><span class="s2">,</span>
    <span class="s1">(pd.Series([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">])</span><span class="s2">, </span><span class="s1">pd.Series([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y'</span><span class="s1">]))])</span>
<span class="s2">def </span><span class="s1">test_simulate_standardized_1d(standardize</span><span class="s2">, </span><span class="s1">use_pandas):</span>
    <span class="s1">endog = np.zeros(</span><span class="s5">100</span><span class="s1">) + </span><span class="s5">10</span>
    <span class="s2">if </span><span class="s1">use_pandas:</span>
        <span class="s1">endog = pd.Series(endog</span><span class="s2">, </span><span class="s1">name=</span><span class="s4">'y'</span><span class="s1">)</span>

    <span class="s3"># Create the model, get the results</span>
    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False,</span>
        <span class="s1">standardize=standardize)</span>
    <span class="s1">lambda1 = </span><span class="s5">2.0</span>
    <span class="s1">phi = </span><span class="s5">0.5</span>
    <span class="s1">params = [lambda1</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">res = mod.smooth(params)</span>

    <span class="s3"># Desired value from the simulation</span>
    <span class="s1">mean = np.atleast_1d(standardize[</span><span class="s5">0</span><span class="s1">])[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">std = np.atleast_1d(standardize[</span><span class="s5">1</span><span class="s1">])[</span><span class="s5">0</span><span class="s1">]</span>
    <span class="s1">desired = phi**np.arange(</span><span class="s5">10</span><span class="s1">) * lambda1 * std + mean</span>
    <span class="s1">desired_nd = desired[:</span><span class="s2">, None</span><span class="s1">] </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">desired[:</span><span class="s2">, None, None</span><span class="s1">]</span>

    <span class="s3"># Test without repetitition</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">])</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">(</span><span class="s5">10</span><span class="s2">,</span><span class="s1">))</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test with 1 repetitition</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">repetitions=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">desired_shape = (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s1">) </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">desired_shape)</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired_nd)</span>

    <span class="s3"># Test with 2 repetititions</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">repetitions=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">desired_shape = (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s1">) </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">desired_shape)</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">np.repeat(desired_nd</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">axis=-</span><span class="s5">1</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'use_pandas'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'standardize'</span><span class="s2">, </span><span class="s1">[</span>
    <span class="s1">([</span><span class="s5">10</span><span class="s2">, </span><span class="s1">-</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s5">10.</span><span class="s2">, </span><span class="s5">10.</span><span class="s1">])</span><span class="s2">, </span><span class="s1">(np.array([</span><span class="s5">10</span><span class="s2">, </span><span class="s1">-</span><span class="s5">4</span><span class="s1">])</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s1">]))</span><span class="s2">,</span>
    <span class="s1">(pd.Series([</span><span class="s5">10</span><span class="s2">, </span><span class="s1">-</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">])</span><span class="s2">,</span>
     <span class="s1">pd.Series([</span><span class="s5">10</span><span class="s2">, </span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'y1'</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">]))])</span>
<span class="s2">def </span><span class="s1">test_simulate_standardized_2d(standardize</span><span class="s2">, </span><span class="s1">use_pandas):</span>
    <span class="s1">endog = np.zeros((</span><span class="s5">100</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)) + [</span><span class="s5">10</span><span class="s2">, </span><span class="s1">-</span><span class="s5">4</span><span class="s1">]</span>
    <span class="s2">if </span><span class="s1">use_pandas:</span>
        <span class="s1">endog = pd.DataFrame(endog</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s4">'y1'</span><span class="s2">, </span><span class="s4">'y2'</span><span class="s1">])</span>

    <span class="s1">mod = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=</span><span class="s2">False,</span>
        <span class="s1">standardize=standardize)</span>
    <span class="s1">lambda1 = </span><span class="s5">2.0</span>
    <span class="s1">lambda2 = </span><span class="s5">0.5</span>
    <span class="s1">phi = </span><span class="s5">0.5</span>
    <span class="s1">params = [lambda1</span><span class="s2">, </span><span class="s1">lambda2</span><span class="s2">, </span><span class="s1">phi</span><span class="s2">, </span><span class="s5">0.0</span><span class="s2">, </span><span class="s5">0</span><span class="s2">, </span><span class="s5">0.</span><span class="s1">]</span>
    <span class="s1">res = mod.smooth(params)</span>

    <span class="s3"># Desired value from the simulation</span>
    <span class="s1">means = np.atleast_1d(standardize[</span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">stds = np.atleast_1d(standardize[</span><span class="s5">1</span><span class="s1">])</span>
    <span class="s1">desired = np.c_[phi**np.arange(</span><span class="s5">10</span><span class="s1">) * lambda1 * stds[</span><span class="s5">0</span><span class="s1">] + means[</span><span class="s5">0</span><span class="s1">]</span><span class="s2">,</span>
                    <span class="s1">phi**np.arange(</span><span class="s5">10</span><span class="s1">) * lambda2 * stds[</span><span class="s5">1</span><span class="s1">] + means[</span><span class="s5">1</span><span class="s1">]]</span>
    <span class="s1">desired_nd = desired </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">desired[...</span><span class="s2">, None</span><span class="s1">]</span>

    <span class="s3"># Test without repetitition</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">])</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s1">))</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Test with 1 repetitition</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">repetitions=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">desired_shape = (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s1">) </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">desired_shape)</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired_nd)</span>

    <span class="s3"># Test with 2 repetititions</span>
    <span class="s1">actual = res.simulate(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">initial_state=[</span><span class="s5">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">repetitions=</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">desired_shape = (</span><span class="s5">10</span><span class="s2">, </span><span class="s5">4</span><span class="s1">) </span><span class="s2">if </span><span class="s1">use_pandas </span><span class="s2">else </span><span class="s1">(</span><span class="s5">10</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(actual.shape</span><span class="s2">, </span><span class="s1">desired_shape)</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">np.repeat(desired_nd</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s1">axis=-</span><span class="s5">1</span><span class="s1">))</span>


<span class="s2">def </span><span class="s1">check_standardized_results(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">check_diagnostics=</span><span class="s2">True</span><span class="s1">):</span>
    <span class="s3"># res1 must be the standardized results, while res2 must be the</span>
    <span class="s3"># the &quot;manual standardization&quot; results.</span>
    <span class="s1">mod1 = res1.model</span>
    <span class="s1">mod2 = res2.model</span>

    <span class="s3"># - Test attributes ------------------------------------------------------</span>
    <span class="s3"># The difference in the standard deviation (from standardization) results</span>
    <span class="s3"># in a difference in loglikelihood computation through the determinant</span>
    <span class="s3"># term. If we add that term in to the model that has been standardized, we</span>
    <span class="s3"># get back the loglikelihood from the model with &quot;manual&quot; standardization</span>
    <span class="s1">tmp = ((</span><span class="s5">1 </span><span class="s1">- res1.filter_results.missing.T) *</span>
           <span class="s1">np.array(mod1._endog_std)[</span><span class="s2">None, </span><span class="s1">:]**</span><span class="s5">2</span><span class="s1">)</span>
    <span class="s1">mask = res1.filter_results.missing.T.astype(bool)</span>
    <span class="s1">tmp[mask] = </span><span class="s5">1.0</span>
    <span class="s1">llf_obs_diff = -</span><span class="s5">0.5 </span><span class="s1">* np.log(tmp).sum(axis=</span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res1.llf_obs + llf_obs_diff</span><span class="s2">, </span><span class="s1">res2.llf_obs)</span>

    <span class="s1">assert_allclose(res1.mae</span><span class="s2">, </span><span class="s1">res2.mae)</span>
    <span class="s1">assert_allclose(res1.mse</span><span class="s2">, </span><span class="s1">res2.mse)</span>
    <span class="s1">assert_allclose(res1.sse</span><span class="s2">, </span><span class="s1">res2.sse)</span>

    <span class="s3"># The reverse transformation has not been applied to the fittedvalues and</span>
    <span class="s3"># resid attributes</span>
    <span class="s1">std = np.array(mod1._endog_std)</span>
    <span class="s1">mean = np.array(mod1._endog_mean)</span>
    <span class="s2">if </span><span class="s1">mod1.k_endog &gt; </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s1">std = std[</span><span class="s2">None, </span><span class="s1">:]</span>
        <span class="s1">mean = mean[</span><span class="s2">None, </span><span class="s1">:]</span>

    <span class="s2">if </span><span class="s1">mod1.k_endog == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s1">assert_allclose(res1.fittedvalues.shape</span><span class="s2">, </span><span class="s1">(mod1.nobs</span><span class="s2">,</span><span class="s1">))</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">assert_allclose(res1.fittedvalues.shape</span><span class="s2">, </span><span class="s1">(mod1.nobs</span><span class="s2">, </span><span class="s1">mod1.k_endog))</span>

    <span class="s1">actual = np.array(res1.fittedvalues) * std + mean</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">res2.fittedvalues)</span>
    <span class="s1">actual = np.array(res1.resid) * std</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">res2.resid)</span>

    <span class="s3"># - Test diagnostics -----------------------------------------------------</span>
    <span class="s2">if </span><span class="s1">check_diagnostics:</span>
        <span class="s1">actual = res1.test_normality(method=</span><span class="s4">'jarquebera'</span><span class="s1">)</span>
        <span class="s1">desired = res2.test_normality(method=</span><span class="s4">'jarquebera'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

        <span class="s1">actual = res1.test_heteroskedasticity(method=</span><span class="s4">'breakvar'</span><span class="s1">)</span>
        <span class="s1">desired = res2.test_heteroskedasticity(method=</span><span class="s4">'breakvar'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

        <span class="s1">lags = min(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">res1.nobs_effective // </span><span class="s5">5</span><span class="s1">)</span>
        <span class="s1">actual = res1.test_serial_correlation(method=</span><span class="s4">'ljungbox'</span><span class="s2">, </span><span class="s1">lags=lags)</span>
        <span class="s1">desired = res2.test_serial_correlation(method=</span><span class="s4">'ljungbox'</span><span class="s2">, </span><span class="s1">lags=lags)</span>
        <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># - Test prediction/forecasting ------------------------------------------</span>

    <span class="s3"># Baseline model</span>
    <span class="s1">start = res1.nobs // </span><span class="s5">10</span>
    <span class="s1">dynamic = res1.nobs // </span><span class="s5">10</span>
    <span class="s1">end = res1.nobs + </span><span class="s5">10</span>
    <span class="s1">predict_actual = res1.predict()</span>
    <span class="s1">forecast_actual = res1.forecast(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">predict_dynamic_forecast_actual = res1.predict(</span>
        <span class="s1">start=start</span><span class="s2">, </span><span class="s1">end=end</span><span class="s2">, </span><span class="s1">dynamic=dynamic)</span>

    <span class="s1">get_predict_actual = res1.get_prediction()</span>
    <span class="s1">get_forecast_actual = res1.get_forecast(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">get_predict_dynamic_forecast_actual = res1.get_prediction(</span>
        <span class="s1">start=start</span><span class="s2">, </span><span class="s1">end=end</span><span class="s2">, </span><span class="s1">dynamic=dynamic)</span>

    <span class="s3"># &quot;Manual&quot; standardization</span>
    <span class="s1">predict_desired = res2.predict()</span>
    <span class="s1">forecast_desired = res2.forecast(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">predict_dynamic_forecast_desired = res2.predict(</span>
        <span class="s1">start=start</span><span class="s2">, </span><span class="s1">end=end</span><span class="s2">, </span><span class="s1">dynamic=dynamic)</span>

    <span class="s1">get_predict_desired = res2.get_prediction()</span>
    <span class="s1">get_forecast_desired = res2.get_forecast(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">get_predict_dynamic_forecast_desired = res2.get_prediction(</span>
        <span class="s1">start=start</span><span class="s2">, </span><span class="s1">end=end</span><span class="s2">, </span><span class="s1">dynamic=dynamic)</span>

    <span class="s1">assert_allclose(predict_actual</span><span class="s2">, </span><span class="s1">predict_desired)</span>
    <span class="s1">assert_allclose(forecast_actual</span><span class="s2">, </span><span class="s1">forecast_desired)</span>
    <span class="s1">assert_allclose(predict_dynamic_forecast_actual</span><span class="s2">,</span>
                    <span class="s1">predict_dynamic_forecast_desired)</span>

    <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(mod1.k_endog):</span>
        <span class="s1">assert_allclose(get_predict_actual.summary_frame(endog=i)</span><span class="s2">,</span>
                        <span class="s1">get_predict_desired.summary_frame(endog=i))</span>
        <span class="s1">assert_allclose(get_forecast_actual.summary_frame(endog=i)</span><span class="s2">,</span>
                        <span class="s1">get_forecast_desired.summary_frame(endog=i))</span>
        <span class="s1">assert_allclose(</span>
            <span class="s1">get_predict_dynamic_forecast_actual.summary_frame(endog=i)</span><span class="s2">,</span>
            <span class="s1">get_predict_dynamic_forecast_desired.summary_frame(endog=i))</span>

    <span class="s3"># - Test simulation ------------------------------------------------------</span>

    <span class="s3"># Generate shocks</span>
    <span class="s1">np.random.seed(</span><span class="s5">1234</span><span class="s1">)</span>
    <span class="s1">nsimulations = </span><span class="s5">100</span>
    <span class="s1">initial_state = np.random.multivariate_normal(</span>
        <span class="s1">res1.filter_results.initial_state</span><span class="s2">,</span>
        <span class="s1">res1.filter_results.initial_state_cov)</span>
    <span class="s1">raw_measurement_shocks = np.random.multivariate_normal(</span>
        <span class="s1">np.zeros(mod1.k_endog)</span><span class="s2">, </span><span class="s1">np.eye(mod1.k_endog)</span><span class="s2">, </span><span class="s1">size=nsimulations)</span>
    <span class="s1">state_shocks = np.random.multivariate_normal(</span>
        <span class="s1">np.zeros(mod1.ssm.k_posdef)</span><span class="s2">, </span><span class="s1">mod1[</span><span class="s4">'state_cov'</span><span class="s1">]</span><span class="s2">, </span><span class="s1">size=nsimulations)</span>

    <span class="s1">L1 = np.diag(mod1[</span><span class="s4">'obs_cov'</span><span class="s1">].diagonal()**</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">measurement_shocks1 = (L1 @ raw_measurement_shocks.T).T</span>

    <span class="s1">L2 = np.diag(mod2[</span><span class="s4">'obs_cov'</span><span class="s1">].diagonal()**</span><span class="s5">0.5</span><span class="s1">)</span>
    <span class="s1">measurement_shocks2 = (L2 @ raw_measurement_shocks.T).T</span>

    <span class="s3"># Default simulation</span>
    <span class="s1">sim_actual = res1.simulate(</span>
        <span class="s1">nsimulations=nsimulations</span><span class="s2">, </span><span class="s1">initial_state=initial_state</span><span class="s2">,</span>
        <span class="s1">measurement_shocks=measurement_shocks1</span><span class="s2">, </span><span class="s1">state_shocks=state_shocks)</span>
    <span class="s1">sim_desired = res2.simulate(</span>
        <span class="s1">nsimulations=nsimulations</span><span class="s2">, </span><span class="s1">initial_state=initial_state</span><span class="s2">,</span>
        <span class="s1">measurement_shocks=measurement_shocks2</span><span class="s2">, </span><span class="s1">state_shocks=state_shocks)</span>

    <span class="s1">assert_allclose(sim_actual</span><span class="s2">, </span><span class="s1">sim_desired)</span>

    <span class="s3"># Anchored simulation</span>
    <span class="s1">sim_actual = res1.simulate(</span>
        <span class="s1">nsimulations=nsimulations</span><span class="s2">, </span><span class="s1">initial_state=initial_state</span><span class="s2">,</span>
        <span class="s1">measurement_shocks=measurement_shocks1</span><span class="s2">, </span><span class="s1">state_shocks=state_shocks</span><span class="s2">,</span>
        <span class="s1">anchor=</span><span class="s4">'end'</span><span class="s1">)</span>
    <span class="s1">sim_desired = res2.simulate(</span>
        <span class="s1">nsimulations=nsimulations</span><span class="s2">, </span><span class="s1">initial_state=initial_state</span><span class="s2">,</span>
        <span class="s1">measurement_shocks=measurement_shocks2</span><span class="s2">, </span><span class="s1">state_shocks=state_shocks</span><span class="s2">,</span>
        <span class="s1">anchor=</span><span class="s4">'end'</span><span class="s1">)</span>

    <span class="s1">assert_allclose(sim_actual</span><span class="s2">, </span><span class="s1">sim_desired)</span>

    <span class="s3"># - Test impulse responses -----------------------------------------------</span>

    <span class="s1">irfs_actual = res1.impulse_responses(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">irfs_desired = res2.impulse_responses(</span><span class="s5">10</span><span class="s1">)</span>
    <span class="s1">assert_allclose(irfs_actual</span><span class="s2">, </span><span class="s1">irfs_desired)</span>

    <span class="s1">irfs_actual = res1.impulse_responses(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">irfs_desired = res2.impulse_responses(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(irfs_actual</span><span class="s2">, </span><span class="s1">irfs_desired)</span>

    <span class="s1">irfs_actual = res1.impulse_responses(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">cumulative=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">irfs_desired = res2.impulse_responses(</span><span class="s5">10</span><span class="s2">, </span><span class="s1">cumulative=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(irfs_actual</span><span class="s2">, </span><span class="s1">irfs_desired)</span>

    <span class="s1">irfs_actual = res1.impulse_responses(</span>
        <span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True, </span><span class="s1">cumulative=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">irfs_desired = res2.impulse_responses(</span>
        <span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True, </span><span class="s1">cumulative=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_allclose(irfs_actual</span><span class="s2">, </span><span class="s1">irfs_desired)</span>

    <span class="s1">irfs_actual = res1.impulse_responses(</span>
        <span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True, </span><span class="s1">cumulative=</span><span class="s2">True, </span><span class="s1">anchor=</span><span class="s4">'end'</span><span class="s1">)</span>
    <span class="s1">irfs_desired = res2.impulse_responses(</span>
        <span class="s5">10</span><span class="s2">, </span><span class="s1">orthogonalized=</span><span class="s2">True, </span><span class="s1">cumulative=</span><span class="s2">True, </span><span class="s1">anchor=</span><span class="s4">'end'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(irfs_actual</span><span class="s2">, </span><span class="s1">irfs_desired)</span>


<span class="s2">def </span><span class="s1">check_identical_models(mod1</span><span class="s2">, </span><span class="s1">mod2</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">True</span><span class="s1">):</span>
    <span class="s3"># Dimensions</span>
    <span class="s2">if </span><span class="s1">check_nobs:</span>
        <span class="s1">assert_equal(mod2.nobs</span><span class="s2">, </span><span class="s1">mod1.nobs)</span>
    <span class="s1">assert_equal(mod2.k_endog</span><span class="s2">, </span><span class="s1">mod1.k_endog)</span>
    <span class="s1">assert_equal(mod2.k_endog_M</span><span class="s2">, </span><span class="s1">mod1.k_endog_M)</span>
    <span class="s1">assert_equal(mod2.k_endog_Q</span><span class="s2">, </span><span class="s1">mod1.k_endog_Q)</span>
    <span class="s1">assert_equal(mod2.k_states</span><span class="s2">, </span><span class="s1">mod1.k_states)</span>
    <span class="s1">assert_equal(mod2.ssm.k_posdef</span><span class="s2">, </span><span class="s1">mod1.ssm.k_posdef)</span>

    <span class="s3"># Standardization</span>
    <span class="s1">assert_allclose(mod2._endog_mean</span><span class="s2">, </span><span class="s1">mod1._endog_mean)</span>
    <span class="s1">assert_allclose(mod2._endog_std</span><span class="s2">, </span><span class="s1">mod1._endog_std)</span>
    <span class="s1">assert_allclose(mod2.standardize</span><span class="s2">, </span><span class="s1">mod1.standardize)</span>

    <span class="s3"># Parameterization</span>
    <span class="s1">assert_equal(mod2.factors</span><span class="s2">, </span><span class="s1">mod1.factors)</span>
    <span class="s1">assert_equal(mod2.factor_orders</span><span class="s2">, </span><span class="s1">mod1.factor_orders)</span>
    <span class="s1">assert_equal(mod2.factor_multiplicities</span><span class="s2">, </span><span class="s1">mod1.factor_multiplicities)</span>
    <span class="s1">assert_equal(mod2.idiosyncratic_ar1</span><span class="s2">, </span><span class="s1">mod1.idiosyncratic_ar1)</span>
    <span class="s1">assert_equal(mod2.init_t0</span><span class="s2">, </span><span class="s1">mod1.init_t0)</span>
    <span class="s1">assert_equal(mod2.obs_cov_diag</span><span class="s2">, </span><span class="s1">mod1.obs_cov_diag)</span>

    <span class="s3"># Other attributes</span>
    <span class="s1">assert_allclose(mod2.endog_factor_map</span><span class="s2">, </span><span class="s1">mod1.endog_factor_map)</span>
    <span class="s1">assert_allclose(mod2.factor_block_orders</span><span class="s2">, </span><span class="s1">mod1.factor_block_orders)</span>
    <span class="s1">assert_equal(mod2.endog_names</span><span class="s2">, </span><span class="s1">mod1.endog_names)</span>
    <span class="s1">assert_equal(mod2.factor_names</span><span class="s2">, </span><span class="s1">mod1.factor_names)</span>
    <span class="s1">assert_equal(mod2.k_factors</span><span class="s2">, </span><span class="s1">mod1.k_factors)</span>
    <span class="s1">assert_equal(mod2.k_factor_blocks</span><span class="s2">, </span><span class="s1">mod1.k_factor_blocks)</span>
    <span class="s1">assert_equal(mod2.max_factor_order</span><span class="s2">, </span><span class="s1">mod1.max_factor_order)</span>


<span class="s2">def </span><span class="s1">check_append(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M2</span><span class="s2">, </span><span class="s1">endog_Q2):</span>
    <span class="s3"># res1 is the usual results object</span>
    <span class="s3"># res2 is an &quot;manually standardized&quot; results object</span>
    <span class="s3"># endog_M2 is the monthly data to append</span>
    <span class="s3"># endog_Q2 is the quarterly data to append</span>

    <span class="s3"># Test for appending to the usual results object</span>
    <span class="s1">res1_append = res1.append(endog_M2</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q2)</span>
    <span class="s1">mod1_append = res1_append.model</span>
    <span class="s1">mod1 = res1.model</span>

    <span class="s3"># Check that the models are the same</span>
    <span class="s1">check_identical_models(mod1</span><span class="s2">, </span><span class="s1">mod1_append</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod1_append.nobs</span><span class="s2">, </span><span class="s1">mod1.nobs + len(endog_M2))</span>
    <span class="s1">assert_allclose(mod1_append.endog[:mod1.nobs]</span><span class="s2">, </span><span class="s1">mod1.endog)</span>

    <span class="s3"># Check that the results are the same prior to the appended data</span>
    <span class="s1">assert_allclose(res1_append.filter_results.initial_state_cov</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.initial_state_cov)</span>

    <span class="s1">assert_allclose(res1_append.llf_obs[:mod1.nobs]</span><span class="s2">, </span><span class="s1">res1.llf_obs)</span>
    <span class="s1">assert_allclose(res1_append.filter_results.forecasts[:</span><span class="s2">, </span><span class="s1">:mod1.nobs]</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.forecasts)</span>
    <span class="s1">assert_allclose(res1_append.filter_results.forecasts_error[:</span><span class="s2">, </span><span class="s1">:mod1.nobs]</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.forecasts_error)</span>

    <span class="s1">assert_allclose(res1_append.filter_results.initial_state</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.initial_state)</span>
    <span class="s1">assert_allclose(res1_append.filter_results.initial_state_cov</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.initial_state_cov)</span>

    <span class="s1">assert_allclose(res1_append.filter_results.filtered_state[:</span><span class="s2">, </span><span class="s1">:mod1.nobs]</span><span class="s2">,</span>
                    <span class="s1">res1.filter_results.filtered_state)</span>
    <span class="s1">assert_allclose(</span>
        <span class="s1">res1_append.filter_results.filtered_state_cov[...</span><span class="s2">, </span><span class="s1">:mod1.nobs]</span><span class="s2">,</span>
        <span class="s1">res1.filter_results.filtered_state_cov)</span>

    <span class="s3"># Test that &quot;manual standardization&quot; continues to work with append</span>
    <span class="s1">res2_append = res2.append(endog_M2</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q2)</span>
    <span class="s1">mod2_append = res2_append.model</span>
    <span class="s1">mod2 = res2.model</span>

    <span class="s3"># Because our mod2 has manual changes, we need to copy those over and</span>
    <span class="s3"># re-create the appended results object</span>
    <span class="s1">mod2_append.update(res2_append.params)</span>
    <span class="s1">mod2_append[</span><span class="s4">'obs_intercept'</span><span class="s1">] = mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span>
    <span class="s1">mod2_append[</span><span class="s4">'design'</span><span class="s1">] = mod2[</span><span class="s4">'design'</span><span class="s1">]</span>
    <span class="s1">mod2_append[</span><span class="s4">'obs_cov'</span><span class="s1">] = mod2[</span><span class="s4">'obs_cov'</span><span class="s1">]</span>
    <span class="s1">mod2_append.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>
    <span class="s1">res2_append = mod2_append.smooth(res2_append.params)</span>

    <span class="s3"># Check output</span>
    <span class="s1">check_identical_models(mod2</span><span class="s2">, </span><span class="s1">mod2_append</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check that the results are the same prior to the appended data</span>
    <span class="s1">assert_allclose(res2_append.filter_results.initial_state_cov</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.initial_state_cov)</span>

    <span class="s1">assert_allclose(res2_append.llf_obs[:mod2.nobs]</span><span class="s2">, </span><span class="s1">res2.llf_obs)</span>
    <span class="s1">assert_allclose(res2_append.filter_results.forecasts[:</span><span class="s2">, </span><span class="s1">:mod2.nobs]</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.forecasts)</span>
    <span class="s1">assert_allclose(res2_append.filter_results.forecasts_error[:</span><span class="s2">, </span><span class="s1">:mod2.nobs]</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.forecasts_error)</span>

    <span class="s1">assert_allclose(res2_append.filter_results.initial_state</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.initial_state)</span>
    <span class="s1">assert_allclose(res2_append.filter_results.initial_state_cov</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.initial_state_cov)</span>

    <span class="s1">assert_allclose(res2_append.filter_results.filtered_state[:</span><span class="s2">, </span><span class="s1">:mod2.nobs]</span><span class="s2">,</span>
                    <span class="s1">res2.filter_results.filtered_state)</span>
    <span class="s1">assert_allclose(</span>
        <span class="s1">res2_append.filter_results.filtered_state_cov[...</span><span class="s2">, </span><span class="s1">:mod2.nobs]</span><span class="s2">,</span>
        <span class="s1">res2.filter_results.filtered_state_cov)</span>

    <span class="s3"># Check res1_append vs res2_append</span>
    <span class="s1">check_standardized_results(res1_append</span><span class="s2">, </span><span class="s1">res2_append)</span>


<span class="s2">def </span><span class="s1">check_extend(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M2</span><span class="s2">, </span><span class="s1">endog_Q2):</span>
    <span class="s3"># res1 is the usual results object</span>
    <span class="s3"># endog_M2 is the monthly data to append</span>
    <span class="s3"># endog_Q2 is the, optional, quarterly data to append</span>
    <span class="s3"># res2 is an optional &quot;manually standardized&quot; results object</span>

    <span class="s3"># Test for extending to the usual results object</span>
    <span class="s1">res1_extend = res1.extend(endog_M2</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q2)</span>
    <span class="s1">mod1_extend = res1_extend.model</span>
    <span class="s1">mod1 = res1.model</span>

    <span class="s3"># Check that the models are the same</span>
    <span class="s1">check_identical_models(mod1</span><span class="s2">, </span><span class="s1">mod1_extend</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod1_extend.nobs</span><span class="s2">, </span><span class="s1">len(endog_M2))</span>

    <span class="s3"># Test that &quot;manual standardization&quot; continues to work with extend</span>
    <span class="s1">res2_extend = res2.extend(endog_M2</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q2)</span>
    <span class="s1">mod2_extend = res2_extend.model</span>
    <span class="s1">mod2 = res2.model</span>

    <span class="s3"># Because our mod2 has manual changes, we need to copy those over and</span>
    <span class="s3"># re-create the extended results object</span>
    <span class="s1">mod2_extend.update(res2_extend.params)</span>
    <span class="s1">mod2_extend[</span><span class="s4">'obs_intercept'</span><span class="s1">] = mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span>
    <span class="s1">mod2_extend[</span><span class="s4">'design'</span><span class="s1">] = mod2[</span><span class="s4">'design'</span><span class="s1">]</span>
    <span class="s1">mod2_extend[</span><span class="s4">'obs_cov'</span><span class="s1">] = mod2[</span><span class="s4">'obs_cov'</span><span class="s1">]</span>
    <span class="s1">mod2_extend.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>
    <span class="s1">res2_extend = mod2_extend.smooth(res2_extend.params)</span>

    <span class="s3"># Check that the models are the same</span>
    <span class="s1">check_identical_models(mod2</span><span class="s2">, </span><span class="s1">mod2_extend</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check res1_extend vs res2_extend</span>
    <span class="s1">check_standardized_results(res1_extend</span><span class="s2">, </span><span class="s1">res2_extend</span><span class="s2">,</span>
                               <span class="s1">check_diagnostics=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">check_apply(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M</span><span class="s2">, </span><span class="s1">endog_Q):</span>
    <span class="s3"># res1 is the usual results object</span>
    <span class="s3"># endog_M2 is the monthly data to append</span>
    <span class="s3"># endog_Q2 is the, optional, quarterly data to append</span>
    <span class="s3"># res2 is an optional &quot;manually standardized&quot; results object</span>

    <span class="s3"># Test for applying to the usual results object</span>
    <span class="s1">res1_apply = res1.apply(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q)</span>
    <span class="s1">mod1_apply = res1_apply.model</span>
    <span class="s1">mod1 = res1.model</span>

    <span class="s3"># Check that the models are the same</span>
    <span class="s1">check_identical_models(mod1</span><span class="s2">, </span><span class="s1">mod1_apply</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod1_apply.nobs</span><span class="s2">, </span><span class="s1">len(endog_M))</span>

    <span class="s3"># Test that &quot;manual standardization&quot; continues to work with apply</span>
    <span class="s1">res2_apply = res2.apply(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q)</span>
    <span class="s1">mod2_apply = res2_apply.model</span>
    <span class="s1">mod2 = res2.model</span>

    <span class="s3"># Because our mod2 has manual changes, we need to copy those over and</span>
    <span class="s3"># re-create the applyed results object</span>
    <span class="s1">mod2_apply.update(res2_apply.params)</span>
    <span class="s1">mod2_apply[</span><span class="s4">'obs_intercept'</span><span class="s1">] = mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span>
    <span class="s1">mod2_apply[</span><span class="s4">'design'</span><span class="s1">] = mod2[</span><span class="s4">'design'</span><span class="s1">]</span>
    <span class="s1">mod2_apply[</span><span class="s4">'obs_cov'</span><span class="s1">] = mod2[</span><span class="s4">'obs_cov'</span><span class="s1">]</span>
    <span class="s1">mod2_apply.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>
    <span class="s1">res2_apply = mod2_apply.smooth(res2_apply.params)</span>

    <span class="s3"># Check that the models are the same</span>
    <span class="s1">check_identical_models(mod2</span><span class="s2">, </span><span class="s1">mod2_apply</span><span class="s2">, </span><span class="s1">check_nobs=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check res1_apply vs res2_apply</span>
    <span class="s1">check_standardized_results(res1_apply</span><span class="s2">, </span><span class="s1">res2_apply</span><span class="s2">,</span>
                               <span class="s1">check_diagnostics=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'use_pandas'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'k_endog'</span><span class="s2">, </span><span class="s1">[</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'idiosyncratic_ar1'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_standardized_monthly(reset_randomstate</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1</span><span class="s2">, </span><span class="s1">k_endog</span><span class="s2">,</span>
                              <span class="s1">use_pandas):</span>
    <span class="s1">nobs = </span><span class="s5">100</span>
    <span class="s1">k2 = </span><span class="s5">2</span>
    <span class="s1">_</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">f2 = test_dynamic_factor_mq_monte_carlo.gen_k_factor2(</span>
        <span class="s1">nobs</span><span class="s2">, </span><span class="s1">k=k2</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=idiosyncratic_ar1)</span>

    <span class="s2">if </span><span class="s1">k_endog == </span><span class="s5">1</span><span class="s1">:</span>
        <span class="s1">endog = f2.iloc[:</span><span class="s2">, </span><span class="s5">0</span><span class="s1">]</span>
        <span class="s1">endog_mean = pd.Series([</span><span class="s5">10</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'f1'</span><span class="s1">])</span>
        <span class="s1">endog_std = pd.Series([</span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'f1'</span><span class="s1">])</span>
    <span class="s2">else</span><span class="s1">:</span>
        <span class="s1">endog = f2</span>
        <span class="s1">endog_mean = pd.Series([</span><span class="s5">10</span><span class="s2">, </span><span class="s1">-</span><span class="s5">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'f1'</span><span class="s2">, </span><span class="s4">'f2'</span><span class="s1">])</span>
        <span class="s1">endog_std = pd.Series([</span><span class="s5">1</span><span class="s2">, </span><span class="s5">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">index=[</span><span class="s4">'f1'</span><span class="s2">, </span><span class="s4">'f2'</span><span class="s1">])</span>

    <span class="s2">if not </span><span class="s1">use_pandas:</span>
        <span class="s1">endog = endog.values</span>
        <span class="s1">endog_mean = endog_mean.values</span>
        <span class="s1">endog_std = endog_std.values</span>

    <span class="s3"># - Actual ---------------------------------------------------------------</span>
    <span class="s3"># Baseline model</span>
    <span class="s1">mod1 = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_multiplicities=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=idiosyncratic_ar1</span><span class="s2">,</span>
        <span class="s1">standardize=(endog_mean</span><span class="s2">, </span><span class="s1">endog_std))</span>

    <span class="s1">params = pd.Series(mod1.start_params</span><span class="s2">, </span><span class="s1">index=mod1.param_names)</span>
    <span class="s1">res1 = mod1.smooth(params)</span>

    <span class="s3"># - Desired --------------------------------------------------------------</span>
    <span class="s3"># Create an identical model, but without standardization</span>
    <span class="s1">mod2 = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">factors=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_multiplicities=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">factor_orders=</span><span class="s5">1</span><span class="s2">,</span>
        <span class="s1">idiosyncratic_ar1=idiosyncratic_ar1</span><span class="s2">,</span>
        <span class="s1">standardize=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s3"># Start with the parameters from the standardized model</span>
    <span class="s1">mod2.update(params)</span>

    <span class="s3"># Update the observation equation to manually implement the standardization</span>
    <span class="s1">mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">] = np.array(endog_mean)</span>
    <span class="s1">mod2[</span><span class="s4">'design'</span><span class="s1">] *= np.array(endog_std)[:</span><span class="s2">, None</span><span class="s1">]</span>
    <span class="s1">mod2[</span><span class="s4">'obs_cov'</span><span class="s1">] *= np.array(endog_std)[:</span><span class="s2">, None</span><span class="s1">]**</span><span class="s5">2</span>

    <span class="s3"># Prevent the model from overwriting our changes</span>
    <span class="s1">mod2.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>

    <span class="s3"># Create the results object based on the model with manual standardization</span>
    <span class="s1">res2 = mod2.smooth(params)</span>

    <span class="s3"># - Test results ---------------------------------------------------------</span>
    <span class="s1">check_standardized_results(res1</span><span class="s2">, </span><span class="s1">res2)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'idiosyncratic_ar1'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_standardized_MQ(reset_randomstate</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1):</span>
    <span class="s1">nobs = </span><span class="s5">100</span>
    <span class="s1">idiosyncratic_ar1 = </span><span class="s2">False</span>
    <span class="s1">k1 = </span><span class="s5">2</span>
    <span class="s1">k2 = </span><span class="s5">2</span>
    <span class="s1">endog1_M</span><span class="s2">, </span><span class="s1">endog1_Q</span><span class="s2">, </span><span class="s1">f1 = test_dynamic_factor_mq_monte_carlo.gen_k_factor1(</span>
        <span class="s1">nobs</span><span class="s2">, </span><span class="s1">k=k1</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=idiosyncratic_ar1)</span>
    <span class="s1">endog2_M</span><span class="s2">, </span><span class="s1">endog2_Q</span><span class="s2">, </span><span class="s1">f2 = test_dynamic_factor_mq_monte_carlo.gen_k_factor2(</span>
        <span class="s1">nobs</span><span class="s2">, </span><span class="s1">k=k2</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=idiosyncratic_ar1)</span>

    <span class="s1">endog_M = pd.concat([endog1_M</span><span class="s2">, </span><span class="s1">f2</span><span class="s2">, </span><span class="s1">endog2_M]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">sort=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">endog_Q = pd.concat([endog1_Q</span><span class="s2">, </span><span class="s1">endog2_Q]</span><span class="s2">, </span><span class="s1">axis=</span><span class="s5">1</span><span class="s2">, </span><span class="s1">sort=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">endog_M1 = endog_M.loc[:</span><span class="s4">'1957-12'</span><span class="s1">]</span>
    <span class="s1">endog_Q1 = endog_Q.loc[:</span><span class="s4">'1957Q4'</span><span class="s1">]</span>
    <span class="s1">endog_M2 = endog_M.loc[</span><span class="s4">'1958-01'</span><span class="s1">:]</span>
    <span class="s1">endog_Q2 = endog_Q.loc[</span><span class="s4">'1958Q1'</span><span class="s1">:]</span>

    <span class="s1">factors = {</span><span class="s4">f'yM</span><span class="s2">{</span><span class="s1">i + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">_f1'</span><span class="s1">: [</span><span class="s4">'a'</span><span class="s1">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(k1)}</span>
    <span class="s1">factors.update({</span><span class="s4">f'f</span><span class="s2">{</span><span class="s1">i + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">'</span><span class="s1">: [</span><span class="s4">'b'</span><span class="s1">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">)})</span>
    <span class="s1">factors.update({</span><span class="s4">f'yM</span><span class="s2">{</span><span class="s1">i + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">_f2'</span><span class="s1">: [</span><span class="s4">'b'</span><span class="s1">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(k2)})</span>
    <span class="s1">factors.update({</span><span class="s4">f'yQ</span><span class="s2">{</span><span class="s1">i + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">_f1'</span><span class="s1">: [</span><span class="s4">'a'</span><span class="s1">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(k1)})</span>
    <span class="s1">factors.update({</span><span class="s4">f'yQ</span><span class="s2">{</span><span class="s1">i + </span><span class="s5">1</span><span class="s2">}</span><span class="s4">_f2'</span><span class="s1">: [</span><span class="s4">'b'</span><span class="s1">] </span><span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(k2)})</span>
    <span class="s1">factor_multiplicities = {</span><span class="s4">'b'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>

    <span class="s3"># - Actual ---------------------------------------------------------------</span>
    <span class="s3"># Baseline model</span>
    <span class="s1">endog_mean = pd.Series(</span>
        <span class="s1">np.random.normal(size=len(factors))</span><span class="s2">, </span><span class="s1">index=factors.keys())</span>
    <span class="s1">endog_std = pd.Series(</span>
        <span class="s1">np.abs(np.random.normal(size=len(factors)))</span><span class="s2">, </span><span class="s1">index=factors.keys())</span>

    <span class="s1">mod1 = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_M1</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q1</span><span class="s2">,</span>
        <span class="s1">factors=factors</span><span class="s2">, </span><span class="s1">factor_multiplicities=factor_multiplicities</span><span class="s2">,</span>
        <span class="s1">factor_orders=</span><span class="s5">6</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=idiosyncratic_ar1</span><span class="s2">,</span>
        <span class="s1">standardize=(endog_mean</span><span class="s2">, </span><span class="s1">endog_std))</span>

    <span class="s1">params = pd.Series(mod1.start_params</span><span class="s2">, </span><span class="s1">index=mod1.param_names)</span>
    <span class="s1">res1 = mod1.smooth(params)</span>

    <span class="s3"># - Desired --------------------------------------------------------------</span>
    <span class="s3"># Create an identical model, but without standardization</span>
    <span class="s1">mod2 = dynamic_factor_mq.DynamicFactorMQ(</span>
        <span class="s1">endog_M1</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q1</span><span class="s2">,</span>
        <span class="s1">factors=factors</span><span class="s2">, </span><span class="s1">factor_multiplicities=factor_multiplicities</span><span class="s2">,</span>
        <span class="s1">factor_orders=</span><span class="s5">6</span><span class="s2">, </span><span class="s1">idiosyncratic_ar1=idiosyncratic_ar1</span><span class="s2">,</span>
        <span class="s1">standardize=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s3"># Start with the parameters from the standardized model</span>
    <span class="s1">mod2.update(params)</span>

    <span class="s3"># Update the observation equation to manually implement the standardization</span>
    <span class="s1">mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">] = endog_mean</span>
    <span class="s1">mod2[</span><span class="s4">'design'</span><span class="s1">] *= np.array(endog_std)[:</span><span class="s2">, None</span><span class="s1">]</span>
    <span class="s1">mod2[</span><span class="s4">'obs_cov'</span><span class="s1">] *= np.array(endog_std)[:</span><span class="s2">, None</span><span class="s1">]**</span><span class="s5">2</span>

    <span class="s3"># Prevent the model from overwriting our changes</span>
    <span class="s1">mod2.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>

    <span class="s3"># Create the results object based on the model with manual standardization</span>
    <span class="s1">res2 = mod2.smooth(params)</span>

    <span class="s3"># - Test results ---------------------------------------------------------</span>
    <span class="s1">check_standardized_results(res1</span><span class="s2">, </span><span class="s1">res2)</span>

    <span class="s3"># - Test append, extend, apply -------------------------------------------</span>
    <span class="s1">check_append(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M2</span><span class="s2">, </span><span class="s1">endog_Q2)</span>
    <span class="s1">check_extend(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M2</span><span class="s2">, </span><span class="s1">endog_Q2)</span>
    <span class="s1">check_apply(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">endog_M</span><span class="s2">, </span><span class="s1">endog_Q)</span>

    <span class="s3"># - Test news ------------------------------------------------------------</span>
    <span class="s1">res1_apply = res1.apply(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q)</span>

    <span class="s1">res2_apply = res2.apply(endog_M</span><span class="s2">, </span><span class="s1">endog_quarterly=endog_Q)</span>
    <span class="s1">mod2_apply = res2_apply.model</span>
    <span class="s3"># Because our mod2 has manual changes, we need to copy those over and</span>
    <span class="s3"># re-create the applyed results object</span>
    <span class="s1">mod2_apply.update(res2_apply.params)</span>
    <span class="s1">mod2_apply[</span><span class="s4">'obs_intercept'</span><span class="s1">] = mod2[</span><span class="s4">'obs_intercept'</span><span class="s1">]</span>
    <span class="s1">mod2_apply[</span><span class="s4">'design'</span><span class="s1">] = mod2[</span><span class="s4">'design'</span><span class="s1">]</span>
    <span class="s1">mod2_apply[</span><span class="s4">'obs_cov'</span><span class="s1">] = mod2[</span><span class="s4">'obs_cov'</span><span class="s1">]</span>
    <span class="s1">mod2_apply.update = </span><span class="s2">lambda </span><span class="s1">params</span><span class="s2">, </span><span class="s1">**kwargs: params</span>
    <span class="s1">res2_apply = mod2_apply.smooth(res2_apply.params)</span>

    <span class="s1">news1 = res1_apply.news(res1</span><span class="s2">, </span><span class="s1">start=</span><span class="s4">'1958-01'</span><span class="s2">, </span><span class="s1">end=</span><span class="s4">'1958-03'</span><span class="s2">,</span>
                            <span class="s1">comparison_type=</span><span class="s4">'previous'</span><span class="s1">)</span>
    <span class="s1">news2 = res2_apply.news(res2</span><span class="s2">, </span><span class="s1">start=</span><span class="s4">'1958-01'</span><span class="s2">, </span><span class="s1">end=</span><span class="s4">'1958-03'</span><span class="s2">,</span>
                            <span class="s1">comparison_type=</span><span class="s4">'previous'</span><span class="s1">)</span>
    <span class="s1">attributes = [</span>
        <span class="s4">'total_impacts'</span><span class="s2">, </span><span class="s4">'update_impacts'</span><span class="s2">, </span><span class="s4">'revision_impacts'</span><span class="s2">, </span><span class="s4">'news'</span><span class="s2">,</span>
        <span class="s4">'weights'</span><span class="s2">, </span><span class="s4">'update_forecasts'</span><span class="s2">, </span><span class="s4">'update_realized'</span><span class="s2">,</span>
        <span class="s4">'prev_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'post_impacted_forecasts'</span><span class="s2">, </span><span class="s4">'revisions_iloc'</span><span class="s2">,</span>
        <span class="s4">'revisions_ix'</span><span class="s2">, </span><span class="s4">'updates_iloc'</span><span class="s2">, </span><span class="s4">'updates_ix'</span><span class="s1">]</span>
    <span class="s2">for </span><span class="s1">attr </span><span class="s2">in </span><span class="s1">attributes:</span>
        <span class="s1">w = getattr(news1</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s1">x = getattr(news2</span><span class="s2">, </span><span class="s1">attr)</span>
        <span class="s2">if </span><span class="s1">isinstance(x</span><span class="s2">, </span><span class="s1">pd.Series):</span>
            <span class="s1">assert_series_equal(w</span><span class="s2">, </span><span class="s1">x)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">assert_frame_equal(w</span><span class="s2">, </span><span class="s1">x)</span>
</pre>
</body>
</html>