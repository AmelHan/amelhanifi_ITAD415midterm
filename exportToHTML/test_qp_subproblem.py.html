<html>
<head>
<title>test_qp_subproblem.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_qp_subproblem.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">scipy.sparse </span><span class="s0">import </span><span class="s1">csc_matrix</span>
<span class="s0">from </span><span class="s1">scipy.optimize._trustregion_constr.qp_subproblem \</span>
    <span class="s0">import </span><span class="s1">(eqp_kktfact</span><span class="s0">,</span>
            <span class="s1">projected_cg</span><span class="s0">,</span>
            <span class="s1">box_intersections</span><span class="s0">,</span>
            <span class="s1">sphere_intersections</span><span class="s0">,</span>
            <span class="s1">box_sphere_intersections</span><span class="s0">,</span>
            <span class="s1">modified_dogleg)</span>
<span class="s0">from </span><span class="s1">scipy.optimize._trustregion_constr.projections \</span>
    <span class="s0">import </span><span class="s1">projections</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">TestCase</span><span class="s0">, </span><span class="s1">assert_array_almost_equal</span><span class="s0">, </span><span class="s1">assert_equal</span>
<span class="s0">import </span><span class="s1">pytest</span>


<span class="s0">class </span><span class="s1">TestEQPDirectFactorization(TestCase):</span>

    <span class="s2"># From Example 16.2 Nocedal/Wright &quot;Numerical</span>
    <span class="s2"># Optimization&quot; p.452.</span>
    <span class="s0">def </span><span class="s1">test_nocedal_example(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">lagrange_multipliers = eqp_kktfact(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(lagrange_multipliers</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">TestSphericalBoundariesIntersections(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_2d_sphere_constraints(self):</span>
        <span class="s2"># Interior inicial point</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># No intersection between line and circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Outside initial point pointing toward outside the circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Outside initial point pointing toward inside the circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_2d_sphere_constraints_line_intersections(self):</span>
        <span class="s2"># Interior initial point</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">,</span>
                                                 <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># No intersection between line and circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">,</span>
                                                 <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Outside initial point pointing toward outside the circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">,</span>
                                                 <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Outside initial point pointing toward inside the circle</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">,</span>
                                                 <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">3.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                 <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestBoxBoundariesIntersections(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints(self):</span>
        <span class="s2"># Box constraint in the direction of vector d</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Negative direction</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Some constraints are absent (set to +/- inf)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-np.inf</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Intersect on the face of the box</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Interior initial point</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># No intersection between line and box constraints</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0.99</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                                         <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints_entire_line(self):</span>
        <span class="s2"># Box constraint in the direction of vector d</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Negative direction</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Some constraints are absent (set to +/- inf)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-np.inf</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Intersect on the face of the box</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Interior initial pointoint</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># No intersection between line and box constraints</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">0.99</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Initial point on the boundary</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_3d_box_constraints(self):</span>
        <span class="s2"># Simple case</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Negative direction</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

        <span class="s2"># Interior point</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_3d_box_constraints_entire_line(self):</span>
        <span class="s2"># Simple case</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Negative direction</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Interior point</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                                              <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestBoxSphereBoundariesIntersections(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints(self):</span>
        <span class="s2"># Both constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># None of the constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">10</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Box constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">10</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Spherical constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Infeasible problems</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_2d_box_constraints_entire_line(self):</span>
        <span class="s2"># Both constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># None of the constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">10</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Box constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">10</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Spherical constraints are active</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal([ta</span><span class="s0">, </span><span class="s1">tb]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s1">])</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, True</span><span class="s1">)</span>

        <span class="s2"># Infeasible problems</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">ta</span><span class="s0">, </span><span class="s1">tb</span><span class="s0">, </span><span class="s1">intersect = box_sphere_intersections([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                                                     <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s0">,</span>
                                                     <span class="s1">entire_line=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(intersect</span><span class="s0">, False</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestModifiedDogleg(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_cauchypoint_equalsto_newtonpoint(self):</span>
        <span class="s1">A = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]])</span>
        <span class="s1">b = np.array([-</span><span class="s3">16</span><span class="s1">])</span>
        <span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">newton_point = np.array([</span><span class="s3">0.24615385</span><span class="s0">, </span><span class="s3">1.96923077</span><span class="s1">])</span>

        <span class="s2"># Newton point inside boundaries</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">newton_point)</span>

        <span class="s2"># Spherical constraint active</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">newton_point/np.linalg.norm(newton_point))</span>

        <span class="s2"># Box constraints active</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">(newton_point/newton_point[</span><span class="s3">0</span><span class="s1">]) * </span><span class="s3">0.1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_3d_example(self):</span>
        <span class="s1">A = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
        <span class="s1">b = np.array([-</span><span class="s3">16</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">LS</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>

        <span class="s1">newton_point = np.array([-</span><span class="s3">1.37090909</span><span class="s0">, </span><span class="s3">2.23272727</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.49090909</span><span class="s1">])</span>
        <span class="s1">cauchy_point = np.array([</span><span class="s3">0.11165723</span><span class="s0">, </span><span class="s3">1.73068711</span><span class="s0">, </span><span class="s3">0.16748585</span><span class="s1">])</span>
        <span class="s1">origin = np.zeros_like(newton_point)</span>

        <span class="s2"># newton_point inside boundaries</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">newton_point)</span>

        <span class="s2"># line between cauchy_point and newton_point contains best point</span>
        <span class="s2"># (spherical constraint is active).</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">z = cauchy_point</span>
        <span class="s1">d = newton_point-cauchy_point</span>
        <span class="s1">t = ((x-z)/(d))</span>
        <span class="s1">assert_array_almost_equal(t</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.40807330</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(np.linalg.norm(x)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

        <span class="s2"># line between cauchy_point and newton_point contains best point</span>
        <span class="s2"># (box constraint is active).</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">z = cauchy_point</span>
        <span class="s1">d = newton_point-cauchy_point</span>
        <span class="s1">t = ((x-z)/(d))</span>
        <span class="s1">assert_array_almost_equal(t</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.7498195</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s2"># line between origin and cauchy_point contains best point</span>
        <span class="s2"># (spherical constraint is active).</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">z = origin</span>
        <span class="s1">d = cauchy_point</span>
        <span class="s1">t = ((x-z)/(d))</span>
        <span class="s1">assert_array_almost_equal(t</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.573936265</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(np.linalg.norm(x)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s2"># line between origin and newton_point contains best point</span>
        <span class="s2"># (box constraint is active).</span>
        <span class="s1">x = modified_dogleg(A</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">[-np.inf</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s1">z = origin</span>
        <span class="s1">d = newton_point</span>
        <span class="s1">t = ((x-z)/(d))</span>
        <span class="s1">assert_array_almost_equal(t</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0.4478827364</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestProjectCG(TestCase):</span>

    <span class="s2"># From Example 16.2 Nocedal/Wright &quot;Numerical</span>
    <span class="s2"># Optimization&quot; p.452.</span>
    <span class="s0">def </span><span class="s1">test_nocedal_example(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_compare_with_direct_fact(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">tol=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">x_kkt</span><span class="s0">, </span><span class="s1">_ = eqp_kktfact(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">x_kkt)</span>

    <span class="s0">def </span><span class="s1">test_trust_region_infeasible(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">trust_radius = </span><span class="s3">1</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">trust_radius=trust_radius)</span>

    <span class="s0">def </span><span class="s1">test_trust_region_barely_feasible(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">trust_radius = </span><span class="s3">2.32379000772445021283</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(np.linalg.norm(x)</span><span class="s0">, </span><span class="s1">trust_radius)</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">-Y.dot(b))</span>

    <span class="s0">def </span><span class="s1">test_hits_boundary(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">trust_radius = </span><span class="s3">3</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(np.linalg.norm(x)</span><span class="s0">, </span><span class="s1">trust_radius)</span>

    <span class="s0">def </span><span class="s1">test_negative_curvature_unconstrained(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">tol=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_negative_curvature(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">trust_radius = </span><span class="s3">1000</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(np.linalg.norm(x)</span><span class="s0">, </span><span class="s1">trust_radius)</span>

    <span class="s2"># The box constraints are inactive at the solution but</span>
    <span class="s2"># are active during the iterations.</span>
    <span class="s0">def </span><span class="s1">test_inactive_box_constraints(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">lb=[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">,</span>
                                   <span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                               <span class="s1">return_all=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">x_kkt</span><span class="s0">, </span><span class="s1">_ = eqp_kktfact(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x</span><span class="s0">, </span><span class="s1">x_kkt)</span>

    <span class="s2"># The box constraints active and the termination is</span>
    <span class="s2"># by maximum iterations (infeasible iteraction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_maximum_iterations_reached(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">lb=[</span><span class="s3">0.8</span><span class="s0">, </span><span class="s1">-np.inf</span><span class="s0">,</span>
                                   <span class="s1">-np.inf</span><span class="s0">, </span><span class="s1">-np.inf]</span><span class="s0">,</span>
                               <span class="s1">return_all=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(A.dot(x)</span><span class="s0">, </span><span class="s1">-b)</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">)</span>

    <span class="s2"># The box constraints are active and the termination is</span>
    <span class="s2"># because it hits boundary (without infeasible iteraction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_hits_boundaries(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">trust_radius = </span><span class="s3">3</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">ub=[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s3">1.6</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius</span><span class="s0">,</span>
                               <span class="s1">return_all=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1.6</span><span class="s1">)</span>

    <span class="s2"># The box constraints are active and the termination is</span>
    <span class="s2"># because it hits boundary (infeasible iteraction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_hits_boundaries_infeasible_iter(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">trust_radius = </span><span class="s3">4</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">ub=[np.inf</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius</span><span class="s0">,</span>
                               <span class="s1">return_all=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0.1</span><span class="s1">)</span>

    <span class="s2"># The box constraints are active and the termination is</span>
    <span class="s2"># because it hits boundary (no infeasible iteraction).</span>
    <span class="s0">def </span><span class="s1">test_active_box_constraints_negative_curvature(self):</span>
        <span class="s1">H = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span>
        <span class="s1">A = csc_matrix([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">c = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">b = -np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">Z</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">Y = projections(A)</span>
        <span class="s1">trust_radius = </span><span class="s3">1000</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">info = projected_cg(H</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">Y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">,</span>
                               <span class="s1">tol=</span><span class="s3">0</span><span class="s0">,</span>
                               <span class="s1">ub=[np.inf</span><span class="s0">, </span><span class="s1">np.inf</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">,</span>
                               <span class="s1">trust_radius=trust_radius)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;stop_cond&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(info[</span><span class="s4">&quot;hits_boundary&quot;</span><span class="s1">]</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(x[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
</pre>
</body>
</html>