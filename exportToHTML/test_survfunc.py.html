<html>
<head>
<title>test_survfunc.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_survfunc.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">statsmodels.duration.survfunc </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">SurvfuncRight</span><span class="s0">, </span><span class="s1">survdiff</span><span class="s0">, </span><span class="s1">plot_survfunc</span><span class="s0">,</span>
    <span class="s1">CumIncidenceRight)</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s2"># If true, the output is written to a multi-page pdf file.</span>
<span class="s1">pdf_output = </span><span class="s0">False</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig):</span>
    <span class="s0">if </span><span class="s1">pdf_output:</span>
        <span class="s1">pdf.savefig(fig)</span>


<span class="s3">&quot;&quot;&quot; 
library(survival) 
ti1 = c(3, 1, 2, 3, 2, 1, 5, 3) 
st1 = c(0, 1, 1, 1, 0, 0, 1, 0) 
ti2 = c(1, 1, 2, 3, 7, 1, 5, 3, 9) 
st2 = c(0, 1, 0, 0, 1, 0, 1, 0, 1) 
 
ti = c(ti1, ti2) 
st = c(st1, st2) 
ix = c(rep(1, length(ti1)), rep(2, length(ti2))) 
sd = survdiff(Surv(ti, st) ~ ix) 
&quot;&quot;&quot;</span>

<span class="s1">ti1 = np.r_[</span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
<span class="s1">st1 = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
<span class="s1">times1 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span>
<span class="s1">surv_prob1 = np.r_[</span><span class="s4">0.8750000</span><span class="s0">, </span><span class="s4">0.7291667</span><span class="s0">, </span><span class="s4">0.5468750</span><span class="s0">, </span><span class="s4">0.0000000</span><span class="s1">]</span>
<span class="s1">surv_prob_se1 = np.r_[</span><span class="s4">0.1169268</span><span class="s0">, </span><span class="s4">0.1649762</span><span class="s0">, </span><span class="s4">0.2005800</span><span class="s0">, </span><span class="s1">np.nan]</span>
<span class="s1">n_risk1 = np.r_[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
<span class="s1">n_events1 = np.r_[</span><span class="s4">1.</span><span class="s0">,  </span><span class="s4">1.</span><span class="s0">,  </span><span class="s4">1.</span><span class="s0">,  </span><span class="s4">1.</span><span class="s1">]</span>

<span class="s1">ti2 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
<span class="s1">st2 = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
<span class="s1">times2 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
<span class="s1">surv_prob2 = np.r_[</span><span class="s4">0.8888889</span><span class="s0">, </span><span class="s4">0.5925926</span><span class="s0">, </span><span class="s4">0.2962963</span><span class="s0">, </span><span class="s4">0.0000000</span><span class="s1">]</span>
<span class="s1">surv_prob_se2 = np.r_[</span><span class="s4">0.1047566</span><span class="s0">, </span><span class="s4">0.2518034</span><span class="s0">, </span><span class="s4">0.2444320</span><span class="s0">, </span><span class="s1">np.nan]</span>
<span class="s1">n_risk2 = np.r_[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
<span class="s1">n_events2 = np.r_[</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s1">]</span>

<span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
<span class="s1">fp = os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">'bmt.csv'</span><span class="s1">)</span>
<span class="s1">bmt = pd.read_csv(fp)</span>


<span class="s0">def </span><span class="s1">test_survfunc1():</span>
    <span class="s2"># Test where all times have at least 1 event.</span>

    <span class="s1">sr = SurvfuncRight(ti1</span><span class="s0">, </span><span class="s1">st1)</span>
    <span class="s1">assert_allclose(sr.surv_prob</span><span class="s0">, </span><span class="s1">surv_prob1</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sr.surv_prob_se</span><span class="s0">, </span><span class="s1">surv_prob_se1</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sr.surv_times</span><span class="s0">, </span><span class="s1">times1)</span>
    <span class="s1">assert_allclose(sr.n_risk</span><span class="s0">, </span><span class="s1">n_risk1)</span>
    <span class="s1">assert_allclose(sr.n_events</span><span class="s0">, </span><span class="s1">n_events1)</span>


<span class="s0">def </span><span class="s1">test_survfunc2():</span>
    <span class="s2"># Test where some times have no events.</span>

    <span class="s1">sr = SurvfuncRight(ti2</span><span class="s0">, </span><span class="s1">st2)</span>
    <span class="s1">assert_allclose(sr.surv_prob</span><span class="s0">, </span><span class="s1">surv_prob2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sr.surv_prob_se</span><span class="s0">, </span><span class="s1">surv_prob_se2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sr.surv_times</span><span class="s0">, </span><span class="s1">times2)</span>
    <span class="s1">assert_allclose(sr.n_risk</span><span class="s0">, </span><span class="s1">n_risk2)</span>
    <span class="s1">assert_allclose(sr.n_events</span><span class="s0">, </span><span class="s1">n_events2)</span>


<span class="s0">def </span><span class="s1">test_survdiff_basic():</span>

    <span class="s2"># Constants taken from R, code above</span>
    <span class="s1">ti = np.concatenate((ti1</span><span class="s0">, </span><span class="s1">ti2))</span>
    <span class="s1">st = np.concatenate((st1</span><span class="s0">, </span><span class="s1">st2))</span>
    <span class="s1">groups = np.ones(len(ti))</span>
    <span class="s1">groups[</span><span class="s4">0</span><span class="s1">:len(ti1)] = </span><span class="s4">0</span>
    <span class="s1">z</span><span class="s0">, </span><span class="s1">p = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">groups)</span>
    <span class="s1">assert_allclose(z</span><span class="s0">, </span><span class="s4">2.14673</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s4">0.14287</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_simultaneous_cb():</span>

    <span class="s2"># The exact numbers here are regression tests, but they are close</span>
    <span class="s2"># to page 103 of Klein and Moeschberger.</span>

    <span class="s1">df = bmt.loc[bmt[</span><span class="s3">&quot;Group&quot;</span><span class="s1">] == </span><span class="s3">&quot;ALL&quot;</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">sf = SurvfuncRight(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df[</span><span class="s3">&quot;Status&quot;</span><span class="s1">])</span>
    <span class="s1">lcb1</span><span class="s0">, </span><span class="s1">ucb1 = sf.simultaneous_cb(transform=</span><span class="s3">&quot;log&quot;</span><span class="s1">)</span>
    <span class="s1">lcb2</span><span class="s0">, </span><span class="s1">ucb2 = sf.simultaneous_cb(transform=</span><span class="s3">&quot;arcsin&quot;</span><span class="s1">)</span>

    <span class="s1">ti = sf.surv_times.tolist()</span>
    <span class="s1">ix = [ti.index(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">(</span><span class="s4">110</span><span class="s0">, </span><span class="s4">122</span><span class="s0">, </span><span class="s4">129</span><span class="s0">, </span><span class="s4">172</span><span class="s1">)]</span>
    <span class="s1">assert_allclose(lcb1[ix]</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.43590582</span><span class="s0">, </span><span class="s4">0.42115592</span><span class="s0">,</span>
                                    <span class="s4">0.4035897</span><span class="s0">, </span><span class="s4">0.38785927</span><span class="s1">])</span>
    <span class="s1">assert_allclose(ucb1[ix]</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.93491636</span><span class="s0">, </span><span class="s4">0.89776803</span><span class="s0">,</span>
                                    <span class="s4">0.87922239</span><span class="s0">, </span><span class="s4">0.85894181</span><span class="s1">])</span>

    <span class="s1">assert_allclose(lcb2[ix]</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.52115708</span><span class="s0">, </span><span class="s4">0.48079378</span><span class="s0">,</span>
                                    <span class="s4">0.45595321</span><span class="s0">, </span><span class="s4">0.43341115</span><span class="s1">])</span>
    <span class="s1">assert_allclose(ucb2[ix]</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.96465636</span><span class="s0">,  </span><span class="s4">0.92745068</span><span class="s0">,</span>
                                    <span class="s4">0.90885428</span><span class="s0">, </span><span class="s4">0.88796708</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_bmt():</span>
    <span class="s2"># All tests against SAS</span>
    <span class="s2"># Results taken from here:</span>
    <span class="s2"># http://support.sas.com/documentation/cdl/en/statug/68162/HTML/default/viewer.htm#statug_lifetest_details03.htm</span>

    <span class="s2"># Confidence intervals for 25% percentile of the survival</span>
    <span class="s2"># distribution (for &quot;ALL&quot; subjects), taken from the SAS web site</span>
    <span class="s1">cb = {</span><span class="s3">&quot;linear&quot;</span><span class="s1">: [</span><span class="s4">107</span><span class="s0">, </span><span class="s4">276</span><span class="s1">]</span><span class="s0">,</span>
          <span class="s3">&quot;cloglog&quot;</span><span class="s1">: [</span><span class="s4">86</span><span class="s0">, </span><span class="s4">230</span><span class="s1">]</span><span class="s0">,</span>
          <span class="s3">&quot;log&quot;</span><span class="s1">: [</span><span class="s4">107</span><span class="s0">, </span><span class="s4">332</span><span class="s1">]</span><span class="s0">,</span>
          <span class="s3">&quot;asinsqrt&quot;</span><span class="s1">: [</span><span class="s4">104</span><span class="s0">, </span><span class="s4">276</span><span class="s1">]</span><span class="s0">,</span>
          <span class="s3">&quot;logit&quot;</span><span class="s1">: [</span><span class="s4">104</span><span class="s0">, </span><span class="s4">230</span><span class="s1">]}</span>

    <span class="s1">dfa = bmt[bmt.Group == </span><span class="s3">&quot;ALL&quot;</span><span class="s1">]</span>

    <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
    <span class="s1">fp = os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">'bmt_results.csv'</span><span class="s1">)</span>
    <span class="s1">rslt = pd.read_csv(fp)</span>

    <span class="s1">sf = SurvfuncRight(dfa[</span><span class="s3">&quot;T&quot;</span><span class="s1">].values</span><span class="s0">, </span><span class="s1">dfa.Status.values)</span>

    <span class="s1">assert_allclose(sf.surv_times</span><span class="s0">, </span><span class="s1">rslt.t)</span>
    <span class="s1">assert_allclose(sf.surv_prob</span><span class="s0">, </span><span class="s1">rslt.s</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sf.surv_prob_se</span><span class="s0">, </span><span class="s1">rslt.se</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s3">&quot;linear&quot;</span><span class="s0">, </span><span class="s3">&quot;cloglog&quot;</span><span class="s0">, </span><span class="s3">&quot;log&quot;</span><span class="s0">, </span><span class="s3">&quot;logit&quot;</span><span class="s0">, </span><span class="s3">&quot;asinsqrt&quot;</span><span class="s1">:</span>
        <span class="s1">lcb</span><span class="s0">, </span><span class="s1">ucb = sf.quantile_ci(</span><span class="s4">0.25</span><span class="s0">, </span><span class="s1">method=method)</span>
        <span class="s1">assert_allclose(cb[method]</span><span class="s0">, </span><span class="s1">np.r_[lcb</span><span class="s0">, </span><span class="s1">ucb])</span>


<span class="s0">def </span><span class="s1">test_survdiff():</span>
    <span class="s2"># Results come from R survival and survMisc packages (survMisc is</span>
    <span class="s2"># used for non G-rho family tests but does not seem to support</span>
    <span class="s2"># stratification)</span>

    <span class="s1">full_df = bmt.copy()</span>
    <span class="s1">df = bmt[bmt.Group != </span><span class="s3">&quot;ALL&quot;</span><span class="s1">].copy()</span>

    <span class="s2"># Not stratified</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">13.44556</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">weight_type=</span><span class="s3">&quot;gb&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">15.38787</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">weight_type=</span><span class="s3">&quot;tw&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">14.98382</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">,</span>
                       <span class="s1">fh_p=</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">14.46866</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">,</span>
                       <span class="s1">fh_p=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">14.84500</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2"># Not stratified, &gt;2 groups</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(full_df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">full_df.Status</span><span class="s0">, </span><span class="s1">full_df.Group</span><span class="s0">,</span>
                       <span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">15.67247</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2"># 5 strata</span>
    <span class="s1">strata = np.arange(df.shape[</span><span class="s4">0</span><span class="s1">]) % </span><span class="s4">5</span>
    <span class="s1">df[</span><span class="s3">&quot;strata&quot;</span><span class="s1">] = strata</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">11.97799</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata</span><span class="s0">,</span>
                       <span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">12.6257</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata</span><span class="s0">,</span>
                       <span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">12.73565</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2"># 5 strata, &gt;2 groups</span>
    <span class="s1">full_strata = np.arange(full_df.shape[</span><span class="s4">0</span><span class="s1">]) % </span><span class="s4">5</span>
    <span class="s1">full_df[</span><span class="s3">&quot;strata&quot;</span><span class="s1">] = full_strata</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(full_df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">full_df.Status</span><span class="s0">, </span><span class="s1">full_df.Group</span><span class="s0">,</span>
                       <span class="s1">strata=full_df.strata</span><span class="s0">, </span><span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">13.56793</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2"># 8 strata</span>
    <span class="s1">df[</span><span class="s3">&quot;strata&quot;</span><span class="s1">] = np.arange(df.shape[</span><span class="s4">0</span><span class="s1">]) % </span><span class="s4">8</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">12.12631</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata</span><span class="s0">,</span>
                       <span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">12.9633</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">stat</span><span class="s0">, </span><span class="s1">p = survdiff(df[</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">df.Status</span><span class="s0">, </span><span class="s1">df.Group</span><span class="s0">, </span><span class="s1">strata=df.strata</span><span class="s0">,</span>
                       <span class="s1">weight_type=</span><span class="s3">&quot;fh&quot;</span><span class="s0">, </span><span class="s1">fh_p=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_allclose(stat</span><span class="s0">, </span><span class="s4">13.35259</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-4</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>


<span class="s1">@pytest.mark.matplotlib</span>
<span class="s0">def </span><span class="s1">test_plot_km(close_figures):</span>

    <span class="s0">if </span><span class="s1">pdf_output:</span>
        <span class="s0">from </span><span class="s1">matplotlib.backends.backend_pdf </span><span class="s0">import </span><span class="s1">PdfPages</span>
        <span class="s1">pdf = PdfPages(</span><span class="s3">&quot;test_survfunc.pdf&quot;</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">pdf = </span><span class="s0">None</span>

    <span class="s1">sr1 = SurvfuncRight(ti1</span><span class="s0">, </span><span class="s1">st1)</span>
    <span class="s1">sr2 = SurvfuncRight(ti2</span><span class="s0">, </span><span class="s1">st2)</span>

    <span class="s1">fig = plot_survfunc(sr1)</span>
    <span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig)</span>

    <span class="s1">fig = plot_survfunc(sr2)</span>
    <span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig)</span>

    <span class="s1">fig = plot_survfunc([sr1</span><span class="s0">, </span><span class="s1">sr2])</span>
    <span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig)</span>

    <span class="s2"># Plot the SAS BMT data</span>
    <span class="s1">gb = bmt.groupby(</span><span class="s3">&quot;Group&quot;</span><span class="s1">)</span>
    <span class="s1">sv = []</span>
    <span class="s0">for </span><span class="s1">g </span><span class="s0">in </span><span class="s1">gb:</span>
        <span class="s1">s0 = SurvfuncRight(g[</span><span class="s4">1</span><span class="s1">][</span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">g[</span><span class="s4">1</span><span class="s1">][</span><span class="s3">&quot;Status&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">title=g[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">sv.append(s0)</span>
    <span class="s1">fig = plot_survfunc(sv)</span>
    <span class="s1">ax = fig.get_axes()[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">ax.set_position([</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.64</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">])</span>
    <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
    <span class="s1">fig.legend([ha[k] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">,</span>
               <span class="s1">[lb[k] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)]</span><span class="s0">,</span>
               <span class="s1">loc=</span><span class="s3">'center right'</span><span class="s1">)</span>
    <span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig)</span>

    <span class="s2"># Simultaneous CB for BMT data</span>
    <span class="s1">ii = bmt.Group == </span><span class="s3">&quot;ALL&quot;</span>
    <span class="s1">sf = SurvfuncRight(bmt.loc[ii</span><span class="s0">, </span><span class="s3">&quot;T&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">bmt.loc[ii</span><span class="s0">, </span><span class="s3">&quot;Status&quot;</span><span class="s1">])</span>
    <span class="s1">fig = sf.plot()</span>
    <span class="s1">ax = fig.get_axes()[</span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">ax.set_position([</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.64</span><span class="s0">, </span><span class="s4">0.8</span><span class="s1">])</span>
    <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
    <span class="s1">lcb</span><span class="s0">, </span><span class="s1">ucb = sf.simultaneous_cb(transform=</span><span class="s3">&quot;log&quot;</span><span class="s1">)</span>
    <span class="s1">plt.fill_between(sf.surv_times</span><span class="s0">, </span><span class="s1">lcb</span><span class="s0">, </span><span class="s1">ucb</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">&quot;lightgrey&quot;</span><span class="s1">)</span>
    <span class="s1">lcb</span><span class="s0">, </span><span class="s1">ucb = sf.simultaneous_cb(transform=</span><span class="s3">&quot;arcsin&quot;</span><span class="s1">)</span>
    <span class="s1">plt.plot(sf.surv_times</span><span class="s0">, </span><span class="s1">lcb</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">&quot;darkgrey&quot;</span><span class="s1">)</span>
    <span class="s1">plt.plot(sf.surv_times</span><span class="s0">, </span><span class="s1">ucb</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">&quot;darkgrey&quot;</span><span class="s1">)</span>
    <span class="s1">plt.plot(sf.surv_times</span><span class="s0">, </span><span class="s1">sf.surv_prob - </span><span class="s4">2</span><span class="s1">*sf.surv_prob_se</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">&quot;red&quot;</span><span class="s1">)</span>
    <span class="s1">plt.plot(sf.surv_times</span><span class="s0">, </span><span class="s1">sf.surv_prob + </span><span class="s4">2</span><span class="s1">*sf.surv_prob_se</span><span class="s0">, </span><span class="s1">color=</span><span class="s3">&quot;red&quot;</span><span class="s1">)</span>
    <span class="s1">plt.xlim(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">600</span><span class="s1">)</span>
    <span class="s1">close_or_save(pdf</span><span class="s0">, </span><span class="s1">fig)</span>

    <span class="s0">if </span><span class="s1">pdf_output:</span>
        <span class="s1">pdf.close()</span>


<span class="s0">def </span><span class="s1">test_weights1():</span>
    <span class="s2"># tm = c(1, 3, 5, 6, 7, 8, 8, 9, 3, 4, 1, 3, 2)</span>
    <span class="s2"># st = c(1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 0)</span>
    <span class="s2"># wt = c(1, 2, 3, 2, 3, 1, 2, 1, 1, 2, 2, 3, 1)</span>
    <span class="s2"># library(survival)</span>
    <span class="s2"># sf = survfit(Surv(tm, st) ~ 1, weights=wt, err='tsiatis')</span>

    <span class="s1">tm = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">st = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">wt = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>

    <span class="s1">sf = SurvfuncRight(tm</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">freq_weights=wt)</span>
    <span class="s1">assert_allclose(sf.surv_times</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">9</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_prob</span><span class="s0">,</span>
                    <span class="s1">np.r_[</span><span class="s4">0.875</span><span class="s0">, </span><span class="s4">0.65625</span><span class="s0">, </span><span class="s4">0.51041667</span><span class="s0">, </span><span class="s4">0.29166667</span><span class="s0">, </span><span class="s4">0.</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_prob_se</span><span class="s0">,</span>
                    <span class="s1">np.r_[</span><span class="s4">0.07216878</span><span class="s0">, </span><span class="s4">0.13307266</span><span class="s0">, </span><span class="s4">0.20591185</span><span class="s0">, </span><span class="s4">0.3219071</span><span class="s0">,</span>
                          <span class="s4">1.05053519</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_weights2():</span>
    <span class="s2"># tm = c(1, 3, 5, 6, 7, 2, 4, 6, 8, 10)</span>
    <span class="s2"># st = c(1, 1, 0, 1, 1, 1, 1, 0, 1, 1)</span>
    <span class="s2"># wt = c(1, 1, 1, 1, 1, 2, 2, 2, 2, 2)</span>
    <span class="s2"># library(survival)</span>
    <span class="s2"># sf =s urvfit(Surv(tm, st) ~ 1, weights=wt, err='tsiatis')</span>

    <span class="s1">tm = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
    <span class="s1">st = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">wt = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span>
    <span class="s1">tm0 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
    <span class="s1">st0 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>

    <span class="s1">sf0 = SurvfuncRight(tm</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">freq_weights=wt)</span>
    <span class="s1">sf1 = SurvfuncRight(tm0</span><span class="s0">, </span><span class="s1">st0)</span>

    <span class="s1">assert_allclose(sf0.surv_times</span><span class="s0">, </span><span class="s1">sf1.surv_times)</span>
    <span class="s1">assert_allclose(sf0.surv_prob</span><span class="s0">, </span><span class="s1">sf1.surv_prob)</span>

    <span class="s1">assert_allclose(sf0.surv_prob_se</span><span class="s0">,</span>
                    <span class="s1">np.r_[</span><span class="s4">0.06666667</span><span class="s0">, </span><span class="s4">0.1210311</span><span class="s0">, </span><span class="s4">0.14694547</span><span class="s0">,</span>
                          <span class="s4">0.19524829</span><span class="s0">, </span><span class="s4">0.23183377</span><span class="s0">,</span>
                          <span class="s4">0.30618115</span><span class="s0">, </span><span class="s4">0.46770386</span><span class="s0">, </span><span class="s4">0.84778942</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_incidence():</span>
    <span class="s2"># Check estimates in R:</span>
    <span class="s2"># ftime = c(1, 1, 2, 4, 4, 4, 6, 6, 7, 8, 9, 9, 9, 1, 2, 2, 4, 4)</span>
    <span class="s2"># fstat = c(1, 1, 1, 2, 2, 2, 3, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0)</span>
    <span class="s2"># cuminc(ftime, fstat)</span>
    <span class="s2">#</span>
    <span class="s2"># The standard errors agree with Stata, not with R (cmprisk</span>
    <span class="s2"># package), which uses a different SE formula from Aalen (1978)</span>
    <span class="s2">#</span>
    <span class="s2"># To check with Stata:</span>
    <span class="s2"># stset ftime failure(fstat==1)</span>
    <span class="s2"># stcompet ci=ci, compet1(2)</span>

    <span class="s1">ftime = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
    <span class="s1">fstat = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s1">ci = CumIncidenceRight(ftime</span><span class="s0">, </span><span class="s1">fstat)</span>

    <span class="s1">cinc = [np.array([</span><span class="s4">0.11111111</span><span class="s0">, </span><span class="s4">0.17037037</span><span class="s0">, </span><span class="s4">0.17037037</span><span class="s0">, </span><span class="s4">0.17037037</span><span class="s0">,</span>
                      <span class="s4">0.17037037</span><span class="s0">, </span><span class="s4">0.17037037</span><span class="s0">, </span><span class="s4">0.17037037</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.20740741</span><span class="s0">, </span><span class="s4">0.20740741</span><span class="s0">,</span>
                      <span class="s4">0.20740741</span><span class="s0">, </span><span class="s4">0.20740741</span><span class="s0">, </span><span class="s4">0.20740741</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">np.array([</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.17777778</span><span class="s0">,</span>
                      <span class="s4">0.26666667</span><span class="s0">, </span><span class="s4">0.26666667</span><span class="s0">, </span><span class="s4">0.26666667</span><span class="s1">])]</span>
    <span class="s1">assert_allclose(cinc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(cinc[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(cinc[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc[</span><span class="s4">2</span><span class="s1">])</span>

    <span class="s1">cinc_se = [np.array([</span><span class="s4">0.07407407</span><span class="s0">, </span><span class="s4">0.08976251</span><span class="s0">, </span><span class="s4">0.08976251</span><span class="s0">, </span><span class="s4">0.08976251</span><span class="s0">,</span>
                         <span class="s4">0.08976251</span><span class="s0">, </span><span class="s4">0.08976251</span><span class="s0">, </span><span class="s4">0.08976251</span><span class="s1">])</span><span class="s0">,</span>
               <span class="s1">np.array([</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.10610391</span><span class="s0">, </span><span class="s4">0.10610391</span><span class="s0">, </span><span class="s4">0.10610391</span><span class="s0">,</span>
                         <span class="s4">0.10610391</span><span class="s0">, </span><span class="s4">0.10610391</span><span class="s1">])</span><span class="s0">,</span>
               <span class="s1">np.array([</span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.11196147</span><span class="s0">, </span><span class="s4">0.12787781</span><span class="s0">,</span>
                         <span class="s4">0.12787781</span><span class="s0">, </span><span class="s4">0.12787781</span><span class="s1">])]</span>
    <span class="s1">assert_allclose(cinc_se[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc_se[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(cinc_se[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc_se[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(cinc_se[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci.cinc_se[</span><span class="s4">2</span><span class="s1">])</span>

    <span class="s2"># Simple check for frequency weights</span>
    <span class="s1">weights = np.ones(len(ftime))</span>
    <span class="s1">ciw = CumIncidenceRight(ftime</span><span class="s0">, </span><span class="s1">fstat</span><span class="s0">, </span><span class="s1">freq_weights=weights)</span>
    <span class="s1">assert_allclose(ci.cinc[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ciw.cinc[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(ci.cinc[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ciw.cinc[</span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(ci.cinc[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ciw.cinc[</span><span class="s4">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_survfunc_entry_1():</span>
    <span class="s2"># times = c(1, 3, 3, 5, 5, 7, 7, 8, 8, 9, 10, 10)</span>
    <span class="s2"># status = c(1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 1)</span>
    <span class="s2"># entry = c(0, 1, 1, 2, 2, 2, 3, 4, 4, 4, 4, 0)</span>
    <span class="s2"># sv = Surv(entry, times, event=status)</span>
    <span class="s2"># sdf = survfit(coxph(sv ~ 1), type='kaplan-meier')</span>

    <span class="s1">times = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
    <span class="s1">status = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s1">sf = SurvfuncRight(times</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry)</span>

    <span class="s1">assert_allclose(sf.n_risk</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_times</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_prob</span><span class="s0">, </span><span class="s1">np.r_[</span>
        <span class="s4">0.5000</span><span class="s0">, </span><span class="s4">0.4167</span><span class="s0">, </span><span class="s4">0.3241</span><span class="s0">, </span><span class="s4">0.2778</span><span class="s0">, </span><span class="s4">0.2222</span><span class="s0">, </span><span class="s4">0.1481</span><span class="s0">, </span><span class="s4">0.0741</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">atol=</span><span class="s4">1e-4</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sf.surv_prob_se</span><span class="s0">, </span><span class="s1">np.r_[</span>
        <span class="s4">0.3536</span><span class="s0">, </span><span class="s4">0.3043</span><span class="s0">, </span><span class="s4">0.2436</span><span class="s0">, </span><span class="s4">0.2132</span><span class="s0">, </span><span class="s4">0.1776</span><span class="s0">, </span><span class="s4">0.1330</span><span class="s0">, </span><span class="s4">0.0846</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">atol=</span><span class="s4">1e-4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_survfunc_entry_2():</span>
    <span class="s2"># entry = 0 is equivalent to no entry time</span>

    <span class="s1">times = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">]</span>
    <span class="s1">status = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s1">sf = SurvfuncRight(times</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry)</span>
    <span class="s1">sf0 = SurvfuncRight(times</span><span class="s0">, </span><span class="s1">status)</span>

    <span class="s1">assert_allclose(sf.n_risk</span><span class="s0">, </span><span class="s1">sf0.n_risk)</span>
    <span class="s1">assert_allclose(sf.surv_times</span><span class="s0">, </span><span class="s1">sf0.surv_times)</span>
    <span class="s1">assert_allclose(sf.surv_prob</span><span class="s0">, </span><span class="s1">sf0.surv_prob)</span>
    <span class="s1">assert_allclose(sf.surv_prob_se</span><span class="s0">, </span><span class="s1">sf0.surv_prob_se)</span>


<span class="s0">def </span><span class="s1">test_survfunc_entry_3():</span>
    <span class="s2"># times = c(1, 2, 5, 6, 6, 6, 6, 6, 9)</span>
    <span class="s2"># status = c(0, 0, 1, 1, 1, 0, 1, 1, 0)</span>
    <span class="s2"># entry = c(0, 1, 1, 2, 2, 2, 3, 4, 4)</span>
    <span class="s2"># sv = Surv(entry, times, event=status)</span>
    <span class="s2"># sdf = survfit(coxph(sv ~ 1), type='kaplan-meier')</span>

    <span class="s1">times = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
    <span class="s1">status = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>

    <span class="s1">sf = SurvfuncRight(times</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry)</span>

    <span class="s1">assert_allclose(sf.n_risk</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_times</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sf.surv_prob</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.857143</span><span class="s0">, </span><span class="s4">0.285714</span><span class="s1">]</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(sf.surv_prob_se</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0.13226</span><span class="s0">, </span><span class="s4">0.170747</span><span class="s1">]</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_survdiff_entry_1():</span>
    <span class="s2"># entry times = 0 is equivalent to no entry times</span>
    <span class="s1">ti = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
    <span class="s1">st = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">gr = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">z1</span><span class="s0">, </span><span class="s1">p1 = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr</span><span class="s0">, </span><span class="s1">entry=entry)</span>
    <span class="s1">z2</span><span class="s0">, </span><span class="s1">p2 = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr)</span>
    <span class="s1">assert_allclose(z1</span><span class="s0">, </span><span class="s1">z2)</span>
    <span class="s1">assert_allclose(p1</span><span class="s0">, </span><span class="s1">p2)</span>


<span class="s0">def </span><span class="s1">test_survdiff_entry_2():</span>
    <span class="s2"># Tests against Stata:</span>
    <span class="s2">#</span>
    <span class="s2"># stset time, failure(status) entry(entry)</span>
    <span class="s2"># sts test group, logrank</span>

    <span class="s1">ti = np.r_[</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
    <span class="s1">st = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">gr = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span>

    <span class="s2"># Check with no entry times</span>
    <span class="s1">z</span><span class="s0">, </span><span class="s1">p = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr)</span>
    <span class="s1">assert_allclose(z</span><span class="s0">, </span><span class="s4">6.694424</span><span class="s1">)</span>
    <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s4">0.00967149</span><span class="s1">)</span>

    <span class="s2"># Check with entry times</span>
    <span class="s1">z</span><span class="s0">, </span><span class="s1">p = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr</span><span class="s0">, </span><span class="s1">entry=entry)</span>
    <span class="s1">assert_allclose(z</span><span class="s0">, </span><span class="s4">3.0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s4">0.083264516</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_survdiff_entry_3():</span>
    <span class="s2"># Tests against Stata:</span>
    <span class="s2">#</span>
    <span class="s2"># stset time, failure(status) entry(entry)</span>
    <span class="s2"># sts test group, logrank</span>

    <span class="s1">ti = np.r_[</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
    <span class="s1">st = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">gr = np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">entry = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>

    <span class="s2"># Check with no entry times</span>
    <span class="s1">z</span><span class="s0">, </span><span class="s1">p = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr)</span>
    <span class="s1">assert_allclose(z</span><span class="s0">, </span><span class="s4">6.9543024</span><span class="s1">)</span>
    <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s4">0.008361789</span><span class="s1">)</span>

    <span class="s2"># Check with entry times</span>
    <span class="s1">z</span><span class="s0">, </span><span class="s1">p = survdiff(ti</span><span class="s0">, </span><span class="s1">st</span><span class="s0">, </span><span class="s1">gr</span><span class="s0">, </span><span class="s1">entry=entry)</span>
    <span class="s1">assert_allclose(z</span><span class="s0">, </span><span class="s4">6.75082959</span><span class="s1">)</span>
    <span class="s1">assert_allclose(p</span><span class="s0">, </span><span class="s4">0.00937041</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_incidence2():</span>
    <span class="s2"># Check that the cumulative incidence functions for all competing</span>
    <span class="s2"># risks sum to the complementary survival function.</span>

    <span class="s1">np.random.seed(</span><span class="s4">2423</span><span class="s1">)</span>
    <span class="s1">n = </span><span class="s4">200</span>
    <span class="s1">time = -np.log(np.random.uniform(size=n))</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">ii = np.argsort(time)</span>
    <span class="s1">time = time[ii]</span>
    <span class="s1">status = status[ii]</span>
    <span class="s1">ci = CumIncidenceRight(time</span><span class="s0">, </span><span class="s1">status)</span>
    <span class="s1">statusa = </span><span class="s4">1</span><span class="s1">*(status &gt;= </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">sf = SurvfuncRight(time</span><span class="s0">, </span><span class="s1">statusa)</span>
    <span class="s1">x = </span><span class="s4">1 </span><span class="s1">- sf.surv_prob</span>
    <span class="s1">y = (ci.cinc[</span><span class="s4">0</span><span class="s1">] + ci.cinc[</span><span class="s4">1</span><span class="s1">])[np.flatnonzero(statusa)]</span>
    <span class="s1">assert_allclose(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_kernel_survfunc1():</span>
    <span class="s2"># Regression test</span>
    <span class="s1">n = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">3434</span><span class="s1">)</span>
    <span class="s1">x = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">time = np.random.uniform(size=n)</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=n)</span>

    <span class="s1">result = SurvfuncRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x)</span>

    <span class="s1">timex = np.r_[</span><span class="s4">0.30721103</span><span class="s0">, </span><span class="s4">0.0515439</span><span class="s0">, </span><span class="s4">0.69246897</span><span class="s0">, </span><span class="s4">0.16446079</span><span class="s0">, </span><span class="s4">0.31308528</span><span class="s1">]</span>
    <span class="s1">sprob = np.r_[</span><span class="s4">0.98948277</span><span class="s0">, </span><span class="s4">0.98162275</span><span class="s0">, </span><span class="s4">0.97129237</span><span class="s0">, </span><span class="s4">0.96044668</span><span class="s0">, </span><span class="s4">0.95030368</span><span class="s1">]</span>

    <span class="s1">assert_allclose(result.time[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">timex)</span>
    <span class="s1">assert_allclose(result.surv_prob[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sprob)</span>


<span class="s0">def </span><span class="s1">test_kernel_survfunc2():</span>
    <span class="s2"># Check that when bandwidth is very large, the kernel procedure</span>
    <span class="s2"># agrees with standard KM. (Note: the results do not agree</span>
    <span class="s2"># perfectly when there are tied times).</span>

    <span class="s1">n = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">3434</span><span class="s1">)</span>
    <span class="s1">x = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">time = np.random.uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=n)</span>

    <span class="s1">resultkm = SurvfuncRight(time</span><span class="s0">, </span><span class="s1">status)</span>
    <span class="s1">result = SurvfuncRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x</span><span class="s0">, </span><span class="s1">bw_factor=</span><span class="s4">10000</span><span class="s1">)</span>

    <span class="s1">assert_allclose(resultkm.surv_times</span><span class="s0">, </span><span class="s1">result.surv_times)</span>
    <span class="s1">assert_allclose(resultkm.surv_prob</span><span class="s0">, </span><span class="s1">result.surv_prob</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s1">@pytest.mark.smoke</span>
<span class="s0">def </span><span class="s1">test_kernel_survfunc3():</span>
    <span class="s2"># cases with tied times</span>

    <span class="s1">n = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">3434</span><span class="s1">)</span>
    <span class="s1">x = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">time = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">SurvfuncRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x</span><span class="s0">, </span><span class="s1">bw_factor=</span><span class="s4">10000</span><span class="s1">)</span>
    <span class="s1">SurvfuncRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x</span><span class="s0">, </span><span class="s1">bw_factor=np.r_[</span><span class="s4">10000</span><span class="s0">, </span><span class="s4">10000</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_kernel_cumincidence1():</span>
    <span class="s2"># Check that when the bandwidth is very large, the kernel</span>
    <span class="s2"># procedure agrees with standard cumulative incidence</span>
    <span class="s2"># calculations. (Note: the results do not agree perfectly when</span>
    <span class="s2"># there are tied times).</span>

    <span class="s1">n = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">3434</span><span class="s1">)</span>
    <span class="s1">x = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">time = np.random.uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=n)</span>

    <span class="s1">result1 = CumIncidenceRight(time</span><span class="s0">, </span><span class="s1">status)</span>

    <span class="s0">for </span><span class="s1">dimred </span><span class="s0">in False, True</span><span class="s1">:</span>
        <span class="s1">result2 = CumIncidenceRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x</span><span class="s0">, </span><span class="s1">bw_factor=</span><span class="s4">10000</span><span class="s0">,</span>
                                    <span class="s1">dimred=dimred)</span>

        <span class="s1">assert_allclose(result1.times</span><span class="s0">, </span><span class="s1">result2.times)</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:</span>
            <span class="s1">assert_allclose(result1.cinc[k]</span><span class="s0">, </span><span class="s1">result2.cinc[k]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>


<span class="s1">@pytest.mark.smoke</span>
<span class="s0">def </span><span class="s1">test_kernel_cumincidence2():</span>
    <span class="s2"># cases with tied times</span>

    <span class="s1">n = </span><span class="s4">100</span>
    <span class="s1">np.random.seed(</span><span class="s4">3434</span><span class="s1">)</span>
    <span class="s1">x = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">time = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">CumIncidenceRight(time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">exog=x</span><span class="s0">, </span><span class="s1">bw_factor=</span><span class="s4">10000</span><span class="s1">)</span>
</pre>
</body>
</html>