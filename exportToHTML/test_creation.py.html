<html>
<head>
<title>test_creation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_creation.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">tlz </span><span class="s0">import </span><span class="s1">concat</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.core </span><span class="s0">import </span><span class="s1">normalize_chunks</span>
<span class="s0">from </span><span class="s1">dask.array.numpy_compat </span><span class="s0">import </span><span class="s1">AxisError</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">same_keys</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;backend&quot;</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s2">&quot;numpy&quot;</span><span class="s0">, </span><span class="s1">pytest.param(</span><span class="s2">&quot;cupy&quot;</span><span class="s0">, </span><span class="s1">marks=pytest.mark.gpu)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;funcname&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s2">&quot;empty_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;empty&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ones_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ones&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;zeros_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;zeros&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;full_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;full&quot;</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;cast_shape&quot;</span><span class="s0">, </span><span class="s1">[tuple</span><span class="s0">, </span><span class="s1">list</span><span class="s0">, </span><span class="s1">np.asarray])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;cast_chunks&quot;</span><span class="s0">, </span><span class="s1">[tuple</span><span class="s0">, </span><span class="s1">list</span><span class="s0">, </span><span class="s1">np.asarray])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s2">&quot;my-name&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;order&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;F&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;i4&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_arr_like(</span>
    <span class="s1">funcname</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">cast_shape</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">cast_chunks</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">order</span><span class="s0">, </span><span class="s1">backend</span>
<span class="s1">):</span>
    <span class="s1">backend_lib = pytest.importorskip(backend)</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.backend&quot;</span><span class="s1">: backend}):</span>
        <span class="s1">np_func = getattr(backend_lib</span><span class="s0">, </span><span class="s1">funcname)</span>
        <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>
        <span class="s1">shape = cast_shape(shape)</span>
        <span class="s1">chunks = cast_chunks(chunks)</span>

        <span class="s0">if </span><span class="s2">&quot;full&quot; </span><span class="s0">in </span><span class="s1">funcname:</span>
            <span class="s1">old_np_func = np_func</span>
            <span class="s1">old_da_func = da_func</span>

            <span class="s1">np_func = </span><span class="s0">lambda </span><span class="s1">*a</span><span class="s0">, </span><span class="s1">**k: old_np_func(*a</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">**k)</span>
            <span class="s1">da_func = </span><span class="s0">lambda </span><span class="s1">*a</span><span class="s0">, </span><span class="s1">**k: old_da_func(*a</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">**k)</span>

        <span class="s1">dtype = np.dtype(dtype)</span>

        <span class="s0">if </span><span class="s2">&quot;like&quot; </span><span class="s0">in </span><span class="s1">funcname:</span>
            <span class="s1">a = backend_lib.random.randint(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape).astype(dtype)</span>

            <span class="s1">np_r = np_func(a</span><span class="s0">, </span><span class="s1">order=order)</span>
            <span class="s1">da_r = da_func(a</span><span class="s0">, </span><span class="s1">order=order</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">name=name)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">np_r = np_func(shape</span><span class="s0">, </span><span class="s1">order=order</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
            <span class="s1">da_r = da_func(shape</span><span class="s0">, </span><span class="s1">order=order</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">name=name)</span>

        <span class="s0">assert </span><span class="s1">np_r.shape == da_r.shape</span>
        <span class="s0">assert </span><span class="s1">np_r.dtype == da_r.dtype</span>

        <span class="s4"># Make sure we are using the desired backend</span>
        <span class="s0">assert </span><span class="s1">isinstance(da_r._meta</span><span class="s0">, </span><span class="s1">backend_lib.ndarray)</span>
        <span class="s0">assert </span><span class="s1">isinstance(da_r.compute()</span><span class="s0">, </span><span class="s1">backend_lib.ndarray)</span>

        <span class="s0">if </span><span class="s2">&quot;empty&quot; </span><span class="s0">not in </span><span class="s1">funcname:</span>
            <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>

        <span class="s0">if </span><span class="s1">name </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">funcname.split(</span><span class="s2">&quot;_&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">] </span><span class="s0">in </span><span class="s1">da_r.name</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">da_r.name == name</span>

        <span class="s0">if </span><span class="s2">&quot;order&quot; </span><span class="s1">== </span><span class="s2">&quot;F&quot;</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">np.isfortran(da_r.compute())</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert not </span><span class="s1">np.isfortran(da_r.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;funcname, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;empty_like&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;ones_like&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;zeros_like&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;full_like&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;fill_value&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s1">})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks, out_shape&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">,</span><span class="s1">) + (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;i4&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_arr_like_shape(funcname</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">out_shape):</span>
    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">a = np.random.randint(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape).astype(dtype)</span>
    <span class="s1">np_r = np_func(a</span><span class="s0">, </span><span class="s1">shape=out_shape</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">da_r = da_func(a</span><span class="s0">, </span><span class="s1">chunks=chunks</span><span class="s0">, </span><span class="s1">shape=out_shape</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">assert </span><span class="s1">np_r.shape == da_r.shape</span>
    <span class="s0">assert </span><span class="s1">np_r.dtype == da_r.dtype</span>

    <span class="s0">if </span><span class="s2">&quot;empty&quot; </span><span class="s0">not in </span><span class="s1">funcname:</span>
        <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;endpoint&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_linspace(endpoint):</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">nparr = np.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">nparr = np.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">nparr = np.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr</span><span class="s0">, </span><span class="s1">dstep = da.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">retstep=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">nparr</span><span class="s0">, </span><span class="s1">npstep = np.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">retstep=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.allclose(dstep</span><span class="s0">, </span><span class="s1">npstep)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">nparr = np.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>
    <span class="s0">assert </span><span class="s1">sorted(</span>
        <span class="s1">da.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s1">).dask</span>
    <span class="s1">) == sorted(da.linspace(</span><span class="s3">1.4</span><span class="s0">, </span><span class="s3">4.9</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">num=</span><span class="s3">13</span><span class="s1">).dask)</span>
    <span class="s0">assert </span><span class="s1">sorted(</span>
        <span class="s1">da.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=float).dask</span>
    <span class="s1">) == sorted(da.linspace(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s1">endpoint=endpoint</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=float).dask)</span>

    <span class="s1">x = da.array([</span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">6.4</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">1.6</span><span class="s1">])</span>
    <span class="s1">nparr = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(da.argmin(x)</span><span class="s0">, </span><span class="s1">da.argmax(x) + </span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">nparr = np.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">darr = da.linspace(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">endpoint=endpoint)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>


<span class="s0">def </span><span class="s1">test_arange():</span>
    <span class="s1">darr = da.arange(</span><span class="s3">77</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">77</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s4"># negative steps</span>
    <span class="s1">darr = da.arange(</span><span class="s3">53</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">53</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">77</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">77</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>
    <span class="s0">assert </span><span class="s1">sorted(da.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">).dask) == sorted(</span>
        <span class="s1">da.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">).dask</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">sorted(da.arange(</span><span class="s3">77</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">dtype=float).dask) == sorted(</span>
        <span class="s1">da.arange(</span><span class="s3">77</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">13</span><span class="s0">, </span><span class="s1">dtype=float).dask</span>
    <span class="s1">)</span>

    <span class="s4"># 0 size output</span>
    <span class="s1">darr = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s4"># Unexpected or missing kwargs</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;whatsthis&quot;</span><span class="s1">):</span>
        <span class="s1">da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">whatsthis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">da.arange(</span><span class="s3">10</span><span class="s1">).chunks == ((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;start,stop,step,dtype&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># int64</span>
        <span class="s1">(</span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># float64</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2.5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># float64</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># float64</span>
        <span class="s1">(np.float32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># promoted to float64</span>
        <span class="s1">(np.int32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># promoted to int64</span>
        <span class="s1">(np.uint32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint32(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># promoted to int64</span>
        <span class="s1">(np.uint64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint64(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># promoted to float64</span>
        <span class="s1">(np.uint32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint32(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint32(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint32)</span><span class="s0">,</span>
        <span class="s1">(np.uint64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint64(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.uint64)</span><span class="s0">,</span>
        <span class="s4"># numpy.arange gives unexpected results</span>
        <span class="s4"># https://github.com/numpy/numpy/issues/11505</span>
        <span class="s4"># (1j, 2, 1, None),</span>
        <span class="s4"># (1, 2j, 1, None),</span>
        <span class="s4"># (1, 2, 1j, None),</span>
        <span class="s4"># (1+2j, 2+3j, 1+.1j, None),</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_arange_dtypes(start</span><span class="s0">, </span><span class="s1">stop</span><span class="s0">, </span><span class="s1">step</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">a_np = np.arange(start</span><span class="s0">, </span><span class="s1">stop</span><span class="s0">, </span><span class="s1">step</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">a_da = da.arange(start</span><span class="s0">, </span><span class="s1">stop</span><span class="s0">, </span><span class="s1">step</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(a_np</span><span class="s0">, </span><span class="s1">a_da)</span>


<span class="s1">@pytest.mark.xfail(</span>
    <span class="s1">reason=</span><span class="s2">&quot;Casting floats to ints is not supported since edge&quot;</span>
    <span class="s2">&quot;behavior is not specified or guaranteed by NumPy.&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_arange_cast_float_int_step():</span>
    <span class="s1">darr = da.arange(</span><span class="s3">3.3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9.1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.25</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">3.3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9.1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.25</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>


<span class="s0">def </span><span class="s1">test_arange_float_step():</span>
    <span class="s1">darr = da.arange(</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">0.3</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">13.0</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">7.7</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.8</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">7.7</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.8</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.01</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.01</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.03</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">nparr = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.03</span><span class="s1">)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>


<span class="s0">def </span><span class="s1">test_indices_wrong_chunks():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.indices((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=tuple())</span>


<span class="s0">def </span><span class="s1">test_indices_dimensions_chunks():</span>
    <span class="s1">chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">darr = da.indices((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s0">assert </span><span class="s1">darr.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) + chunks</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;50 MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">shape = (</span><span class="s3">10000</span><span class="s0">, </span><span class="s3">10000</span><span class="s1">)</span>
        <span class="s1">expected = normalize_chunks(</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">shape=shape</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">result = da.indices(shape</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s4"># indices prepends a dimension</span>
        <span class="s1">actual = result.chunks[</span><span class="s3">1</span><span class="s1">:]</span>
        <span class="s0">assert </span><span class="s1">expected == actual</span>


<span class="s0">def </span><span class="s1">test_empty_indices():</span>
    <span class="s1">darr = da.indices(tuple()</span><span class="s0">, </span><span class="s1">chunks=tuple())</span>
    <span class="s1">nparr = np.indices(tuple())</span>
    <span class="s0">assert </span><span class="s1">darr.shape == nparr.shape</span>
    <span class="s0">assert </span><span class="s1">darr.dtype == nparr.dtype</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices(tuple()</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">chunks=tuple())</span>
    <span class="s1">nparr = np.indices(tuple()</span><span class="s0">, </span><span class="s1">float)</span>
    <span class="s0">assert </span><span class="s1">darr.shape == nparr.shape</span>
    <span class="s0">assert </span><span class="s1">darr.dtype == nparr.dtype</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float)</span>
    <span class="s0">assert </span><span class="s1">darr.shape == nparr.shape</span>
    <span class="s0">assert </span><span class="s1">darr.dtype == nparr.dtype</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float)</span>
    <span class="s0">assert </span><span class="s1">darr.shape == nparr.shape</span>
    <span class="s0">assert </span><span class="s1">darr.dtype == nparr.dtype</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>


<span class="s0">def </span><span class="s1">test_indices():</span>
    <span class="s1">darr = da.indices((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">darr = da.indices((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">nparr = np.indices((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shapes, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">([()]</span><span class="s0">, </span><span class="s1">[()])</span><span class="s0">,</span>
        <span class="s1">([(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">([(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">([(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">([(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">([(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;indexing&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s2">&quot;xy&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;sparse&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_meshgrid(shapes</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">indexing</span><span class="s0">, </span><span class="s1">sparse):</span>
    <span class="s1">xi_a = []</span>
    <span class="s1">xi_d = []</span>
    <span class="s1">xi_dc = []</span>
    <span class="s0">for </span><span class="s1">each_shape</span><span class="s0">, </span><span class="s1">each_chunk </span><span class="s0">in </span><span class="s1">zip(shapes</span><span class="s0">, </span><span class="s1">chunks):</span>
        <span class="s1">xi_a.append(np.random.random(each_shape))</span>
        <span class="s1">xi_d_e = da.from_array(xi_a[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=each_chunk)</span>
        <span class="s1">xi_d.append(xi_d_e)</span>
        <span class="s1">xi_d_ef = xi_d_e.flatten()</span>
        <span class="s1">xi_dc.append(xi_d_ef.chunks[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">do = list(range(len(xi_dc)))</span>
    <span class="s0">if </span><span class="s1">indexing == </span><span class="s2">&quot;xy&quot; </span><span class="s0">and </span><span class="s1">len(xi_dc) &gt; </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s1">do[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">do[</span><span class="s3">1</span><span class="s1">] = do[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">do[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">xi_dc[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">xi_dc[</span><span class="s3">1</span><span class="s1">] = xi_dc[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">xi_dc[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">xi_dc = tuple(xi_dc)</span>

    <span class="s1">r_a = np.meshgrid(*xi_a</span><span class="s0">, </span><span class="s1">indexing=indexing</span><span class="s0">, </span><span class="s1">sparse=sparse)</span>
    <span class="s1">r_d = da.meshgrid(*xi_d</span><span class="s0">, </span><span class="s1">indexing=indexing</span><span class="s0">, </span><span class="s1">sparse=sparse)</span>

    <span class="s0">assert </span><span class="s1">isinstance(r_d</span><span class="s0">, </span><span class="s1">list)</span>
    <span class="s0">assert </span><span class="s1">len(r_a) == len(r_d)</span>

    <span class="s0">for </span><span class="s1">e_r_a</span><span class="s0">, </span><span class="s1">e_r_d</span><span class="s0">, </span><span class="s1">i </span><span class="s0">in </span><span class="s1">zip(r_a</span><span class="s0">, </span><span class="s1">r_d</span><span class="s0">, </span><span class="s1">do):</span>
        <span class="s1">assert_eq(e_r_a</span><span class="s0">, </span><span class="s1">e_r_d)</span>
        <span class="s0">if </span><span class="s1">sparse:</span>
            <span class="s0">assert </span><span class="s1">e_r_d.chunks[i] == xi_dc[i]</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">e_r_d.chunks == xi_dc</span>


<span class="s0">def </span><span class="s1">test_meshgrid_inputcoercion():</span>
    <span class="s1">a = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">b = np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span>
    <span class="s1">x</span><span class="s0">, </span><span class="s1">y = np.meshgrid(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">indexing=</span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span>
    <span class="s1">z = x * y</span>

    <span class="s1">x_d</span><span class="s0">, </span><span class="s1">y_d = da.meshgrid(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">indexing=</span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span>
    <span class="s1">z_d = x_d * y_d</span>

    <span class="s0">assert </span><span class="s1">z_d.shape == (len(a)</span><span class="s0">, </span><span class="s1">len(b))</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">z_d)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;N, M, k, dtype, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">4</span><span class="s0">, None, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">float</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">bool</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">int</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_tri(N</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">assert_eq(da.tri(N</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">chunks)</span><span class="s0">, </span><span class="s1">np.tri(N</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">dtype))</span>


<span class="s0">def </span><span class="s1">test_eye():</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">9</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">7</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">7</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">7</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">7</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">7</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">11</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">7</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">7</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">9</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">9</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">7</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">12</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">6</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">12</span><span class="s0">, </span><span class="s1">M=</span><span class="s3">6</span><span class="s0">, </span><span class="s1">k=-</span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=int)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">dtype=int))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=int)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=int))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=int)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=int))</span>
    <span class="s1">assert_eq(da.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">9</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;50 MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.eye(</span><span class="s3">10000</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s3">4 </span><span class="s1">&lt; x.npartitions &lt; </span><span class="s3">32</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;k&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diag_bad_input(k):</span>
    <span class="s4"># when input numpy array is neither 1d nor 2d:</span>
    <span class="s1">v = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Array must be 1d or 2d only&quot;</span><span class="s1">):</span>
        <span class="s1">da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>

    <span class="s4"># when input dask array is neither 1d nor 2d:</span>
    <span class="s1">v = da.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Array must be 1d or 2d only&quot;</span><span class="s1">):</span>
        <span class="s1">da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>

    <span class="s4"># when input is not an array:</span>
    <span class="s1">v = </span><span class="s3">1</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;v must be a dask array or numpy array&quot;</span><span class="s1">):</span>
        <span class="s1">da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;k&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diag_2d_array_creation(k):</span>
    <span class="s4"># when input 1d-array is a numpy array:</span>
    <span class="s1">v = np.arange(</span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diag(v</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(v</span><span class="s0">, </span><span class="s1">k))</span>

    <span class="s4"># when input 1d-array is a dask array:</span>
    <span class="s1">v = da.arange(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">darr = da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">nparr = np.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>
    <span class="s0">assert </span><span class="s1">sorted(da.diag(v</span><span class="s0">, </span><span class="s1">k).dask) == sorted(da.diag(v</span><span class="s0">, </span><span class="s1">k).dask)</span>

    <span class="s1">v = v + v + </span><span class="s3">3</span>
    <span class="s1">darr = da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">nparr = np.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>

    <span class="s1">v = da.arange(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">darr = da.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">nparr = np.diag(v</span><span class="s0">, </span><span class="s1">k)</span>
    <span class="s1">assert_eq(darr</span><span class="s0">, </span><span class="s1">nparr)</span>
    <span class="s0">assert </span><span class="s1">sorted(da.diag(v</span><span class="s0">, </span><span class="s1">k).dask) == sorted(da.diag(v</span><span class="s0">, </span><span class="s1">k).dask)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;k&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diag_extraction(k):</span>
    <span class="s4"># when input 2d-array is a square numpy array:</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diag(x</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(x</span><span class="s0">, </span><span class="s1">k))</span>
    <span class="s4"># when input 2d-array is a square dask array:</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diag(d</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(x</span><span class="s0">, </span><span class="s1">k))</span>
    <span class="s4"># heterogeneous chunks:</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>
    <span class="s1">assert_eq(da.diag(d</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(x</span><span class="s0">, </span><span class="s1">k))</span>

    <span class="s4"># when input 2d-array is a rectangular numpy array:</span>
    <span class="s1">y = np.arange(</span><span class="s3">5 </span><span class="s1">* </span><span class="s3">8</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diag(y</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(y</span><span class="s0">, </span><span class="s1">k))</span>
    <span class="s4"># when input 2d-array is a rectangular dask array:</span>
    <span class="s1">d = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diag(d</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(y</span><span class="s0">, </span><span class="s1">k))</span>
    <span class="s4"># heterogeneous chunks:</span>
    <span class="s1">d = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>
    <span class="s1">assert_eq(da.diag(d</span><span class="s0">, </span><span class="s1">k)</span><span class="s0">, </span><span class="s1">np.diag(y</span><span class="s0">, </span><span class="s1">k))</span>


<span class="s0">def </span><span class="s1">test_diagonal():</span>
    <span class="s1">v = np.arange(</span><span class="s3">11</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.diagonal(v)</span>

    <span class="s1">v = np.arange(</span><span class="s3">4</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">axis2=-</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s1">v = np.arange(</span><span class="s3">4 </span><span class="s1">* </span><span class="s3">5 </span><span class="s1">* </span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">v = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diagonal(v)</span><span class="s0">, </span><span class="s1">np.diagonal(v))</span>
    <span class="s4"># Empty diagonal.</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s4"># Negative axis.</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s4"># Heterogeneous chunks.</span>
    <span class="s1">v = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4 </span><span class="s1">* </span><span class="s3">5 </span><span class="s1">* </span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">v = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>

    <span class="s1">assert_eq(da.diagonal(v)</span><span class="s0">, </span><span class="s1">np.diagonal(v))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s4"># Positional arguments</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">v = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4 </span><span class="s1">* </span><span class="s3">5 </span><span class="s1">* </span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">axis1=-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">v = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">v = np.arange(</span><span class="s3">384</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">v = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diagonal(v</span><span class="s0">, </span><span class="s1">offset=-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis1=</span><span class="s3">2</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s2">&quot;f8&quot;</span><span class="s0">, </span><span class="s2">&quot;i8&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">1</span><span class="s1">: x + c * y</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">c=</span><span class="s3">1</span><span class="s1">: x + c * y</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">3</span><span class="s1">})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_fromfunction(func</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">a = np.fromfunction(func</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">d = da.fromfunction(func</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s1">d2 = da.fromfunction(func</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">assert </span><span class="s1">same_keys(d</span><span class="s0">, </span><span class="s1">d2)</span>


<span class="s0">def </span><span class="s1">test_repeat():</span>
    <span class="s1">x = np.random.random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">repeats = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>
    <span class="s1">axes = [-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">repeats:</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">axes:</span>
            <span class="s1">assert_eq(x.repeat(r</span><span class="s0">, </span><span class="s1">axis=a)</span><span class="s0">, </span><span class="s1">d.repeat(r</span><span class="s0">, </span><span class="s1">axis=a))</span>

    <span class="s1">assert_eq(d.repeat(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.repeat(d</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.repeat(d</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.repeat(d</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.repeat(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">invalid_axis </span><span class="s0">in </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">da.repeat(d</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">axis=invalid_axis)</span>

    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">d = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(x.repeat(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.repeat(</span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">r </span><span class="s0">in </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]:</span>
        <span class="s0">assert </span><span class="s1">all(concat(d.repeat(r).chunks))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tile_basic(reps):</span>
    <span class="s1">a = da.asarray([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">b = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span>

    <span class="s1">assert_eq(np.tile(a.compute()</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(a</span><span class="s0">, </span><span class="s1">reps))</span>
    <span class="s1">assert_eq(np.tile(b</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(b</span><span class="s0">, </span><span class="s1">reps))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tile_chunks(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reps):</span>
    <span class="s1">x = np.random.random(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">assert_eq(np.tile(x</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(d</span><span class="s0">, </span><span class="s1">reps))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_tile_neg_reps(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reps):</span>
    <span class="s1">x = np.random.random(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.tile(d</span><span class="s0">, </span><span class="s1">reps)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tile_zero_reps(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reps):</span>
    <span class="s1">x = np.random.random(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">assert_eq(np.tile(x</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(d</span><span class="s0">, </span><span class="s1">reps))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tile_empty_array(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">reps):</span>
    <span class="s1">x = np.empty(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">assert_eq(np.tile(x</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(d</span><span class="s0">, </span><span class="s1">reps))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reps&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tile_np_kroncompare_examples(shape</span><span class="s0">, </span><span class="s1">reps):</span>
    <span class="s1">x = np.random.random(shape)</span>
    <span class="s1">d = da.asarray(x)</span>

    <span class="s1">assert_eq(np.tile(x</span><span class="s0">, </span><span class="s1">reps)</span><span class="s0">, </span><span class="s1">da.tile(d</span><span class="s0">, </span><span class="s1">reps))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks, pad_width, mode, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;constant_values&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;edge&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;linear_ramp&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;end_values&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;symmetric&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;wrap&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;empty&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pad_0_width(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">np_a = np.random.random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">np_r = np.pad(np_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">da_r = da.pad(da_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">assert </span><span class="s1">da_r </span><span class="s0">is </span><span class="s1">da_a</span>

    <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks, pad_width, mode, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;constant_values&quot;</span><span class="s1">: -</span><span class="s3">1</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;constant_values&quot;</span><span class="s1">: np.array(-</span><span class="s3">1</span><span class="s1">)})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;constant_values&quot;</span><span class="s1">: (-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)})</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s2">&quot;constant&quot;</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;constant_values&quot;</span><span class="s1">: ((-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;edge&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;linear_ramp&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;linear_ramp&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;end_values&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s2">&quot;linear_ramp&quot;</span><span class="s0">,</span>
            <span class="s1">{</span><span class="s2">&quot;end_values&quot;</span><span class="s1">: ((-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))}</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;symmetric&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;wrap&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;maximum&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;stat_length&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;stat_length&quot;</span><span class="s1">: ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;minimum&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;stat_length&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)})</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;empty&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pad(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">np_a = np.random.random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">np_r = np.pad(np_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">da_r = da.pad(da_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">if </span><span class="s1">mode == </span><span class="s2">&quot;empty&quot;</span><span class="s1">:</span>
        <span class="s4"># empty pads lead to undefined values which may be different</span>
        <span class="s1">assert_eq(np_r[pad_width:-pad_width]</span><span class="s0">, </span><span class="s1">da_r[pad_width:-pad_width])</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s1">[</span><span class="s2">&quot;np_a&quot;</span><span class="s0">, </span><span class="s2">&quot;pad_value&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">(</span>
        <span class="s1">(np.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.int64(</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float64(</span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span><span class="s2">&quot;2000-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-03&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-04&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">dtype=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.datetime64(</span><span class="s2">&quot;1972-01-01&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s0">True, False, True, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.bool_)</span><span class="s0">, </span><span class="s1">np.bool_(</span><span class="s0">False</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s2">&quot;bc&quot;</span><span class="s0">, </span><span class="s2">&quot;de&quot;</span><span class="s0">, </span><span class="s2">&quot;ef&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.str_)</span><span class="s0">, </span><span class="s1">np.str_(</span><span class="s2">&quot;00&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">np.array(</span>
                <span class="s1">[</span><span class="s2">&quot;2000-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-03&quot;</span><span class="s0">, </span><span class="s2">&quot;2000-01-04&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">dtype=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.array(</span><span class="s2">&quot;1972-01-01&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">np.array([</span><span class="s0">True, False, True, True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.bool_)</span><span class="s0">,</span>
            <span class="s1">np.array(</span><span class="s0">False, </span><span class="s1">dtype=np.bool_)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">np.array([</span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s2">&quot;bc&quot;</span><span class="s0">, </span><span class="s2">&quot;de&quot;</span><span class="s0">, </span><span class="s2">&quot;ef&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.str_)</span><span class="s0">,</span>
            <span class="s1">np.array(</span><span class="s2">&quot;00&quot;</span><span class="s0">, </span><span class="s1">dtype=np.str_)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pad_constant_values(np_a</span><span class="s0">, </span><span class="s1">pad_value):</span>
    <span class="s1">pad_width = (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">np_r = np.pad(np_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">constant_values=pad_value)</span>
    <span class="s1">da_r = da.pad(da_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;constant&quot;</span><span class="s0">, </span><span class="s1">constant_values=pad_value)</span>

    <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[np.uint8</span><span class="s0">, </span><span class="s1">np.int16</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, </span><span class="s1">bool])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;pad_widths&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;mode&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s2">&quot;constant&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;edge&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;linear_ramp&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;maximum&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;mean&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;minimum&quot;</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;reflect&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Bug when pad_width is larger than dimension: https://github.com/dask/dask/issues/5303&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;symmetric&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Bug when pad_width is larger than dimension: https://github.com/dask/dask/issues/5303&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;wrap&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Bug when pad_width is larger than dimension: https://github.com/dask/dask/issues/5303&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;median&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Not implemented&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s2">&quot;empty&quot;</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Empty leads to undefined values, which may be different&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_pad_3d_data(dtype</span><span class="s0">, </span><span class="s1">pad_widths</span><span class="s0">, </span><span class="s1">mode):</span>
    <span class="s1">np_a = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">).astype(dtype)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>

    <span class="s1">np_r = np.pad(np_a</span><span class="s0">, </span><span class="s1">pad_widths</span><span class="s0">, </span><span class="s1">mode=mode)</span>
    <span class="s1">da_r = da.pad(da_a</span><span class="s0">, </span><span class="s1">pad_widths</span><span class="s0">, </span><span class="s1">mode=mode)</span>

    <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;kwargs&quot;</span><span class="s0">, </span><span class="s1">[{}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;scaler&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}])</span>
<span class="s0">def </span><span class="s1">test_pad_udf(kwargs):</span>
    <span class="s0">def </span><span class="s1">udf_pad(vector</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">iaxis</span><span class="s0">, </span><span class="s1">inner_kwargs):</span>
        <span class="s0">assert </span><span class="s1">kwargs == inner_kwargs</span>
        <span class="s1">scaler = inner_kwargs.get(</span><span class="s2">&quot;scaler&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">vector[: pad_width[</span><span class="s3">0</span><span class="s1">]] = -scaler * pad_width[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">vector[-pad_width[</span><span class="s3">1</span><span class="s1">] :] = scaler * pad_width[</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s0">return </span><span class="s1">vector</span>

    <span class="s1">shape = (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">chunks = (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">pad_width = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">np_a = np.random.random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">np_r = np.pad(np_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">udf_pad</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">da_r = da.pad(da_a</span><span class="s0">, </span><span class="s1">pad_width</span><span class="s0">, </span><span class="s1">udf_pad</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s0">def </span><span class="s1">test_auto_chunks():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;50 MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.ones((</span><span class="s3">10000</span><span class="s0">, </span><span class="s3">10000</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s3">4 </span><span class="s1">&lt; x.npartitions &lt; </span><span class="s3">32</span>


<span class="s0">def </span><span class="s1">test_string_auto_chunk():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.full((</span><span class="s3">10000</span><span class="s0">, </span><span class="s3">10000</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;auto_chunk&quot;</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_diagonal_zero_chunks():</span>
    <span class="s1">x = da.ones((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">dd = da.ones((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">d = da.diagonal(dd)</span>

    <span class="s1">expected = np.ones((</span><span class="s3">8</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">assert_eq(d + d</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* expected)</span>
    <span class="s1">A = d + x</span>
    <span class="s1">assert_eq(A</span><span class="s0">, </span><span class="s1">np.full((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fn&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;zeros_like&quot;</span><span class="s0">, </span><span class="s2">&quot;ones_like&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape_chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">50</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">50</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;u4&quot;</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, None, </span><span class="s1">np.int64])</span>
<span class="s0">def </span><span class="s1">test_nan_zeros_ones_like(fn</span><span class="s0">, </span><span class="s1">shape_chunks</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">dafn = getattr(da</span><span class="s0">, </span><span class="s1">fn)</span>
    <span class="s1">npfn = getattr(np</span><span class="s0">, </span><span class="s1">fn)</span>
    <span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks = shape_chunks</span>
    <span class="s1">x1 = da.random.standard_normal(size=shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">y1 = x1[x1 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">x2 = x1.compute()</span>
    <span class="s1">y2 = x2[x2 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">dafn(y1</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
        <span class="s1">npfn(y2</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape_chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">50</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">50</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;u4&quot;</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, None, </span><span class="s1">np.int64])</span>
<span class="s0">def </span><span class="s1">test_nan_empty_like(shape_chunks</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks = shape_chunks</span>
    <span class="s1">x1 = da.random.standard_normal(size=shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">y1 = x1[x1 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">x2 = x1.compute()</span>
    <span class="s1">y2 = x2[x2 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">a_da = da.empty_like(y1</span><span class="s0">, </span><span class="s1">dtype=dtype).compute()</span>
    <span class="s1">a_np = np.empty_like(y2</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s0">assert </span><span class="s1">a_da.shape == a_np.shape</span>
    <span class="s0">assert </span><span class="s1">a_da.dtype == a_np.dtype</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">99</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape_chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">50</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">50</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;u4&quot;</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, None, </span><span class="s1">np.int64])</span>
<span class="s0">def </span><span class="s1">test_nan_full_like(val</span><span class="s0">, </span><span class="s1">shape_chunks</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks = shape_chunks</span>
    <span class="s1">x1 = da.random.standard_normal(size=shape</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">y1 = x1[x1 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">x2 = x1.compute()</span>
    <span class="s1">y2 = x2[x2 &lt; </span><span class="s3">0.5</span><span class="s1">]</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.full_like(y1</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
        <span class="s1">np.full_like(y2</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s1">dtype=dtype)</span><span class="s0">,</span>
    <span class="s1">)</span>
</pre>
</body>
</html>