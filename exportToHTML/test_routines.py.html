<html>
<head>
<title>test_routines.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_routines.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">contextlib</span>
<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">sys</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">numbers </span><span class="s0">import </span><span class="s1">Number</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">from </span><span class="s1">dask.delayed </span><span class="s0">import </span><span class="s1">delayed</span>

<span class="s1">np = pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.numpy_compat </span><span class="s0">import </span><span class="s1">AxisError</span><span class="s0">, </span><span class="s1">_numpy_123</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">same_keys</span>


<span class="s0">def </span><span class="s1">test_array():</span>
    <span class="s1">x = np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">d = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.array(d</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array(x</span><span class="s0">, </span><span class="s1">ndmin=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i8&quot;</span><span class="s1">))</span>

    <span class="s4"># regression #1847 this shall not raise an exception.</span>
    <span class="s1">x = da.ones((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.array(x)</span>
    <span class="s0">assert </span><span class="s1">isinstance(y</span><span class="s0">, </span><span class="s1">da.Array)</span>


<span class="s0">def </span><span class="s1">test_array_return_type():</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/5426</span>
    <span class="s1">x = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">dx = da.array(x)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dx</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_derived_docstrings():</span>
    <span class="s0">assert </span><span class="s2">&quot;This docstring was copied from numpy.array&quot; </span><span class="s0">in </span><span class="s1">da.routines.array.__doc__</span>
    <span class="s0">assert </span><span class="s2">&quot;Create an array.&quot; </span><span class="s0">in </span><span class="s1">da.routines.array.__doc__</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;funcname&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;atleast_1d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_2d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_3d&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_atleast_nd_no_args(funcname):</span>
    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>

    <span class="s1">np_r_n = np_func()</span>
    <span class="s1">da_r_n = da_func()</span>

    <span class="s0">assert </span><span class="s1">np_r_n == da_r_n</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;funcname&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;atleast_1d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_2d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_3d&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(tuple()</span><span class="s0">, </span><span class="s1">tuple())</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_atleast_nd_one_arg(funcname</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">np_a = np.random.default_rng().random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>

    <span class="s1">np_r = np_func(np_a)</span>
    <span class="s1">da_r = da_func(da_a)</span>

    <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;funcname&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;atleast_1d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_2d&quot;</span><span class="s0">, </span><span class="s2">&quot;atleast_3d&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape1, shape2&quot;</span><span class="s0">,</span>
    <span class="s1">list(</span>
        <span class="s1">itertools.combinations_with_replacement(</span>
            <span class="s1">[tuple()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">2</span>
        <span class="s1">)</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_atleast_nd_two_args(funcname</span><span class="s0">, </span><span class="s1">shape1</span><span class="s0">, </span><span class="s1">shape2):</span>
    <span class="s1">np_a_1 = np.random.default_rng().random(shape1)</span>
    <span class="s1">da_a_1 = da.from_array(np_a_1</span><span class="s0">, </span><span class="s1">chunks=tuple(c // </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">shape1))</span>

    <span class="s1">np_a_2 = np.random.default_rng().random(shape2)</span>
    <span class="s1">da_a_2 = da.from_array(np_a_2</span><span class="s0">, </span><span class="s1">chunks=tuple(c // </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">shape2))</span>

    <span class="s1">np_a_n = [np_a_1</span><span class="s0">, </span><span class="s1">np_a_2]</span>
    <span class="s1">da_a_n = [da_a_1</span><span class="s0">, </span><span class="s1">da_a_2]</span>

    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>

    <span class="s1">np_r_n = np_func(*np_a_n)</span>
    <span class="s1">da_r_n = da_func(*da_a_n)</span>

    <span class="s0">assert </span><span class="s1">type(np_r_n) </span><span class="s0">is </span><span class="s1">type(da_r_n)</span>

    <span class="s0">assert </span><span class="s1">len(np_r_n) == len(da_r_n)</span>

    <span class="s0">for </span><span class="s1">np_r</span><span class="s0">, </span><span class="s1">da_r </span><span class="s0">in </span><span class="s1">zip(np_r_n</span><span class="s0">, </span><span class="s1">da_r_n):</span>
        <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s0">def </span><span class="s1">test_transpose():</span>
    <span class="s1">x = np.arange(</span><span class="s3">240</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">assert_eq(d.transpose((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">x.transpose((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">same_keys(d.transpose((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">d.transpose((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span>

    <span class="s1">assert_eq(d.transpose(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.transpose(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(d.transpose(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.transpose(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.transpose(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.transpose((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_transpose_negative_axes():</span>
    <span class="s1">x = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">assert_eq(x.transpose([-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">y.transpose([-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_transpose_skip_when_possible():</span>
    <span class="s1">x = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.transpose((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)) </span><span class="s0">is </span><span class="s1">x</span>
    <span class="s0">assert </span><span class="s1">x.transpose((-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)) </span><span class="s0">is </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">test_swapaxes():</span>
    <span class="s1">x = np.random.default_rng().normal(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.swapaxes(x</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.swapaxes(d</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.swapaxes(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.swapaxes(d</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.swapaxes(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.swapaxes(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.swapaxes(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.swapaxes(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(x.swapaxes(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.swapaxes(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">d.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">).name == d.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">).name</span>
    <span class="s0">assert </span><span class="s1">d.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">).name != d.swapaxes(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">).name</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;funcname&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;moveaxis&quot;</span><span class="s0">, </span><span class="s2">&quot;rollaxis&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_moveaxis_rollaxis(funcname</span><span class="s0">, </span><span class="s1">shape):</span>
    <span class="s1">x = np.random.default_rng().random(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)))</span>
    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s0">for </span><span class="s1">axis1 </span><span class="s0">in </span><span class="s1">range(-x.ndim</span><span class="s0">, </span><span class="s1">x.ndim):</span>
        <span class="s0">assert </span><span class="s1">isinstance(da_func(d</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">axis1)</span><span class="s0">, </span><span class="s1">da.Array)</span>
        <span class="s0">for </span><span class="s1">axis2 </span><span class="s0">in </span><span class="s1">range(-x.ndim</span><span class="s0">, </span><span class="s1">x.ndim):</span>
            <span class="s1">assert_eq(np_func(x</span><span class="s0">, </span><span class="s1">axis1</span><span class="s0">, </span><span class="s1">axis2)</span><span class="s0">, </span><span class="s1">da_func(d</span><span class="s0">, </span><span class="s1">axis1</span><span class="s0">, </span><span class="s1">axis2))</span>


<span class="s0">def </span><span class="s1">test_moveaxis_rollaxis_keyword():</span>
    <span class="s1">x = np.random.default_rng().random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.moveaxis(x</span><span class="s0">, </span><span class="s1">destination=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">source=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.moveaxis(d</span><span class="s0">, </span><span class="s1">destination=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">source=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(np.rollaxis(x</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.rollaxis(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">isinstance(da.rollaxis(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(np.rollaxis(x</span><span class="s0">, </span><span class="s1">start=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.rollaxis(d</span><span class="s0">, </span><span class="s1">start=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_moveaxis_rollaxis_numpy_api():</span>
    <span class="s1">a = da.random.default_rng().random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">result = np.moveaxis(a</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">np.moveaxis(a.compute()</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">result = np.rollaxis(a</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">np.rollaxis(a.compute()</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;funcname, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s2">&quot;flipud&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;fliplr&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axis&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axis&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axis&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axis&quot;</span><span class="s1">: -</span><span class="s3">1</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;flip&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axis&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)})</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[tuple()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_flip(funcname</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">shape):</span>
    <span class="s1">axis = kwargs.get(</span><span class="s2">&quot;axis&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">axis </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">funcname == </span><span class="s2">&quot;flipud&quot;</span><span class="s1">:</span>
            <span class="s1">axis = (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">funcname == </span><span class="s2">&quot;fliplr&quot;</span><span class="s1">:</span>
            <span class="s1">axis = (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">funcname == </span><span class="s2">&quot;flip&quot;</span><span class="s1">:</span>
            <span class="s1">axis = range(len(shape))</span>
    <span class="s0">elif not </span><span class="s1">isinstance(axis</span><span class="s0">, </span><span class="s1">tuple):</span>
        <span class="s1">axis = (axis</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">np_a = np.random.default_rng().random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">np_func = getattr(np</span><span class="s0">, </span><span class="s1">funcname)</span>
    <span class="s1">da_func = getattr(da</span><span class="s0">, </span><span class="s1">funcname)</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s0">for </span><span class="s1">ax </span><span class="s0">in </span><span class="s1">axis:</span>
            <span class="s1">range(np_a.ndim)[ax]</span>
    <span class="s0">except </span><span class="s1">IndexError:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">da_func(da_a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">np_r = np_func(np_a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">da_r = da_func(da_a</span><span class="s0">, </span><span class="s1">**kwargs)</span>

        <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[{}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axes&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axes&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axes&quot;</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;axes&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)}]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[tuple()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_rot90(kwargs</span><span class="s0">, </span><span class="s1">shape):</span>
    <span class="s1">axes = kwargs.get(</span><span class="s2">&quot;axes&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">np_a = np.random.default_rng().random(shape)</span>
    <span class="s1">da_a = da.from_array(np_a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">np_func = np.rot90</span>
    <span class="s1">da_func = da.rot90</span>

    <span class="s0">try</span><span class="s1">:</span>
        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">axes[:</span><span class="s3">2</span><span class="s1">]:</span>
            <span class="s1">range(np_a.ndim)[axis]</span>
    <span class="s0">except </span><span class="s1">IndexError:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">da_func(da_a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">if </span><span class="s1">len(axes) != </span><span class="s3">2 </span><span class="s0">or </span><span class="s1">axes[</span><span class="s3">0</span><span class="s1">] == axes[</span><span class="s3">1</span><span class="s1">]:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
                <span class="s1">da_func(da_a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">9</span><span class="s1">):</span>
                <span class="s1">np_r = np_func(np_a</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">**kwargs)</span>
                <span class="s1">da_r = da_func(da_a</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">**kwargs)</span>
                <span class="s1">assert_eq(np_r</span><span class="s0">, </span><span class="s1">da_r)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;x_shape, y_shape, x_chunks, y_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">11</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">19</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">19</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">19</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">13</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">()]</span><span class="s0">,</span>
        <span class="s4"># These tests use explicitly special/disparate chunk sizes:</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">19</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_matmul(x_shape</span><span class="s0">, </span><span class="s1">y_shape</span><span class="s0">, </span><span class="s1">x_chunks</span><span class="s0">, </span><span class="s1">y_chunks):</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">3732</span><span class="s1">)</span>

    <span class="s1">x = rng.random(x_shape)[()]</span>
    <span class="s1">y = rng.random(y_shape)[()]</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=x_chunks </span><span class="s0">or </span><span class="s1">tuple((i // </span><span class="s3">2</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">x.shape))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=y_chunks </span><span class="s0">or </span><span class="s1">tuple((i // </span><span class="s3">2</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">y.shape))</span>

    <span class="s1">expected = </span><span class="s0">None</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">expected = np.matmul(x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s0">except </span><span class="s1">ValueError:</span>
        <span class="s0">pass</span>

    <span class="s0">for </span><span class="s1">d1</span><span class="s0">, </span><span class="s1">d2 </span><span class="s0">in </span><span class="s1">itertools.product([a</span><span class="s0">, </span><span class="s1">x]</span><span class="s0">, </span><span class="s1">[b</span><span class="s0">, </span><span class="s1">y]):</span>
        <span class="s0">if </span><span class="s1">x.ndim == </span><span class="s3">0 </span><span class="s0">or </span><span class="s1">y.ndim == </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
                <span class="s1">da.matmul(d1</span><span class="s0">, </span><span class="s1">d2)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">da.matmul(d1</span><span class="s0">, </span><span class="s1">d2))</span>


<span class="s0">def </span><span class="s1">test_tensordot():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">y = np.arange(</span><span class="s3">200</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">axes </span><span class="s0">in </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]:</span>
        <span class="s1">assert_eq(da.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=axes)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=axes))</span>
        <span class="s1">assert_eq(da.tensordot(x</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=axes)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=axes))</span>
        <span class="s1">assert_eq(da.tensordot(a</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=axes)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=axes))</span>

    <span class="s0">assert </span><span class="s1">same_keys(da.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">da.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)))</span>

    <span class="s4"># Increasing number of chunks warning</span>
    <span class="s0">with </span><span class="s1">pytest.warns(da.PerformanceWarning):</span>
        <span class="s0">assert not </span><span class="s1">same_keys(da.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.tensordot(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">1</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;axes&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_tensordot_2(axes):</span>
    <span class="s1">x = np.arange(</span><span class="s3">4 </span><span class="s1">* </span><span class="s3">4 </span><span class="s1">* </span><span class="s3">4</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(da.tensordot(y</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=axes)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axes=axes))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_tensordot_double_contraction_neq2(chunks):</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/5472</span>
    <span class="s1">x = np.arange(</span><span class="s3">24</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">assert_eq(da.tensordot(y</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_tensordot_double_contraction_ngt2():</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/5472</span>
    <span class="s1">x = np.arange(</span><span class="s3">60.0</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">60.0</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">u = da.from_array(x)</span>
    <span class="s1">v = da.from_array(y)</span>

    <span class="s1">assert_eq(da.tensordot(u</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">x = np.arange(</span><span class="s3">60.0</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = np.arange(</span><span class="s3">60.0</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">u = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">v = da.from_array(y)</span>

    <span class="s1">assert_eq(da.tensordot(u</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.tensordot(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axes=</span><span class="s3">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_tensordot_more_than_26_dims():</span>
    <span class="s1">ndim = </span><span class="s3">27</span>
    <span class="s1">x = np.broadcast_to(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">] * ndim)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.tensordot(dx</span><span class="s0">, </span><span class="s1">dx</span><span class="s0">, </span><span class="s1">ndim)</span><span class="s0">, </span><span class="s1">np.array(</span><span class="s3">2</span><span class="s1">**ndim))</span>


<span class="s0">def </span><span class="s1">test_dot_method():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = np.arange(</span><span class="s3">200</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(a.dot(b)</span><span class="s0">, </span><span class="s1">x.dot(y))</span>


<span class="s0">def </span><span class="s1">test_dot_persist_equivalence():</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/6907</span>
    <span class="s1">x = da.random.default_rng().random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">x[x &lt; </span><span class="s3">0.65</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">y = x.persist()</span>
    <span class="s1">z = x.compute()</span>
    <span class="s1">r1 = da.dot(x</span><span class="s0">, </span><span class="s1">x).compute()</span>
    <span class="s1">r2 = da.dot(y</span><span class="s0">, </span><span class="s1">y).compute()</span>
    <span class="s1">rr = np.dot(z</span><span class="s0">, </span><span class="s1">z)</span>
    <span class="s0">assert </span><span class="s1">np.allclose(rr</span><span class="s0">, </span><span class="s1">r1)</span>
    <span class="s0">assert </span><span class="s1">np.allclose(rr</span><span class="s0">, </span><span class="s1">r2)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">20</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))])</span>
<span class="s0">def </span><span class="s1">test_vdot(shape</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">1337</span><span class="s1">)</span>

    <span class="s1">x = </span><span class="s3">2 </span><span class="s1">* rng.random((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">) + shape) - </span><span class="s3">1</span>
    <span class="s1">x = x[</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">1j </span><span class="s1">* x[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s1">y = </span><span class="s3">2 </span><span class="s1">* rng.random((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">) + shape) - </span><span class="s3">1</span>
    <span class="s1">y = y[</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">1j </span><span class="s1">* y[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">assert_eq(np.vdot(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">da.vdot(a</span><span class="s0">, </span><span class="s1">b))</span>
    <span class="s1">assert_eq(np.vdot(y</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">da.vdot(b</span><span class="s0">, </span><span class="s1">a))</span>
    <span class="s1">assert_eq(da.vdot(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">da.vdot(b</span><span class="s0">, </span><span class="s1">a).conj())</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape1, shape2&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">20</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))])</span>
<span class="s0">def </span><span class="s1">test_outer(shape1</span><span class="s0">, </span><span class="s1">shape2):</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">1337</span><span class="s1">)</span>

    <span class="s1">x = </span><span class="s3">2 </span><span class="s1">* rng.random(shape1) - </span><span class="s3">1</span>
    <span class="s1">y = </span><span class="s3">2 </span><span class="s1">* rng.random(shape2) - </span><span class="s3">1</span>

    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">assert_eq(np.outer(x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">da.outer(a</span><span class="s0">, </span><span class="s1">b))</span>
    <span class="s1">assert_eq(np.outer(y</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">da.outer(b</span><span class="s0">, </span><span class="s1">a))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func1d_name, func1d, specify_output_props&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s2">&quot;ndim&quot;</span><span class="s0">, lambda </span><span class="s1">x: x.ndim</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;sum&quot;</span><span class="s0">, lambda </span><span class="s1">x: x.sum()</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;range&quot;</span><span class="s0">, lambda </span><span class="s1">x: [x.min()</span><span class="s0">, </span><span class="s1">x.max()]</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;range2&quot;</span><span class="s0">, lambda </span><span class="s1">x: [[x.min()</span><span class="s0">, </span><span class="s1">x.max()]</span><span class="s0">, </span><span class="s1">[x.max()</span><span class="s0">, </span><span class="s1">x.min()]]</span><span class="s0">, False</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;cumsum&quot;</span><span class="s0">, lambda </span><span class="s1">x: np.cumsum(x)</span><span class="s0">, True</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;input_shape, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_apply_along_axis(func1d_name</span><span class="s0">, </span><span class="s1">func1d</span><span class="s0">, </span><span class="s1">specify_output_props</span><span class="s0">, </span><span class="s1">input_shape</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">a = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">input_shape)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(len(input_shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">output_shape = </span><span class="s0">None</span>
    <span class="s1">output_dtype = </span><span class="s0">None</span>

    <span class="s0">if </span><span class="s1">specify_output_props:</span>
        <span class="s1">slices = [</span><span class="s3">0</span><span class="s1">] * a.ndim</span>
        <span class="s1">slices[axis] = slice(</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">slices = tuple(slices)</span>
        <span class="s1">sample = np.array(func1d(a[slices]))</span>
        <span class="s1">output_shape = sample.shape</span>
        <span class="s1">output_dtype = sample.dtype</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.apply_along_axis(func1d</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">dtype=output_dtype</span><span class="s0">, </span><span class="s1">shape=output_shape)</span><span class="s0">,</span>
        <span class="s1">np.apply_along_axis(func1d</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func_name, func&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[</span><span class="s2">&quot;sum0&quot;</span><span class="s0">, lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axis: x.sum(axis=axis)]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">&quot;sum1&quot;</span><span class="s0">, lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axis: x.sum(axis=axis</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s2">&quot;range&quot;</span><span class="s0">,</span>
            <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axis: np.concatenate(</span>
                <span class="s1">[x.min(axis=axis</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x.max(axis=axis</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)]</span><span class="s0">,</span>
                <span class="s1">axis=axis</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, axes&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tuple()]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_apply_over_axes(func_name</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">axes):</span>
    <span class="s1">a = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">assert_eq(da.apply_over_axes(func</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">axes)</span><span class="s0">, </span><span class="s1">np.apply_over_axes(func</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">axes))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_ptp(shape</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">a = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">assert_eq(da.ptp(d</span><span class="s0">, </span><span class="s1">axis)</span><span class="s0">, </span><span class="s1">np.ptp(a</span><span class="s0">, </span><span class="s1">axis))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diff(shape</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diff_prepend(n):</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">) + </span><span class="s3">1</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=[</span><span class="s3">0</span><span class="s1">]))</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>

    <span class="s1">x = np.arange(</span><span class="s3">16</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">prepend=[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">prepend=[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">prepend=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">prepend=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">prepend=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">n &gt; </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s4"># When order is 0 the result is the input array, it doesn't raise</span>
        <span class="s4"># an error</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">prepend=np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_diff_append(n):</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">) + </span><span class="s3">1</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=[</span><span class="s3">0</span><span class="s1">]))</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>

    <span class="s1">x = np.arange(</span><span class="s3">16</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">append=[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">append=[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">append=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">append=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
        <span class="s1">np.diff(x</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">append=[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">n &gt; </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s4"># When order is 0 the result is the input array, it doesn't raise</span>
            <span class="s4"># an error</span>
            <span class="s1">da.diff(a</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">append=np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_diff_negative_order():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.diff(da.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;to_end, to_begin&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s0">None, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]])</span>
<span class="s0">def </span><span class="s1">test_ediff1d(shape</span><span class="s0">, </span><span class="s1">to_end</span><span class="s0">, </span><span class="s1">to_begin):</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">assert_eq(da.ediff1d(a</span><span class="s0">, </span><span class="s1">to_end</span><span class="s0">, </span><span class="s1">to_begin)</span><span class="s0">, </span><span class="s1">np.ediff1d(x</span><span class="s0">, </span><span class="s1">to_end</span><span class="s0">, </span><span class="s1">to_begin))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, varargs, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.exp(np.arange(</span><span class="s3">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.exp(np.arange(</span><span class="s3">20</span><span class="s1">)))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.exp(np.arange(</span><span class="s3">20</span><span class="s1">)))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.exp(np.arange(</span><span class="s3">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;edge_order&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_gradient(shape</span><span class="s0">, </span><span class="s1">varargs</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">edge_order):</span>
    <span class="s1">a = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(len(shape) * (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)))</span>

    <span class="s1">r_a = np.gradient(a</span><span class="s0">, </span><span class="s1">*varargs</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">edge_order=edge_order)</span>
    <span class="s1">r_d_a = da.gradient(d_a</span><span class="s0">, </span><span class="s1">*varargs</span><span class="s0">, </span><span class="s1">axis=axis</span><span class="s0">, </span><span class="s1">edge_order=edge_order)</span>

    <span class="s0">if </span><span class="s1">isinstance(axis</span><span class="s0">, </span><span class="s1">Number):</span>
        <span class="s1">assert_eq(r_d_a</span><span class="s0">, </span><span class="s1">r_a)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">len(r_d_a) == len(r_a)</span>

        <span class="s0">for </span><span class="s1">e_r_d_a</span><span class="s0">, </span><span class="s1">e_r_a </span><span class="s0">in </span><span class="s1">zip(r_d_a</span><span class="s0">, </span><span class="s1">r_a):</span>
            <span class="s1">assert_eq(e_r_d_a</span><span class="s0">, </span><span class="s1">e_r_a)</span>

        <span class="s1">assert_eq(</span>
            <span class="s1">da.sqrt(sum(map(da.square</span><span class="s0">, </span><span class="s1">r_d_a)))</span><span class="s0">, </span><span class="s1">np.sqrt(sum(map(np.square</span><span class="s0">, </span><span class="s1">r_a)))</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_bincount():</span>
    <span class="s1">x = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">e = da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">np.bincount(x</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">e)</span>
    <span class="s0">assert </span><span class="s1">e.shape == (</span><span class="s3">6</span><span class="s0">,</span><span class="s1">)  </span><span class="s4"># shape equal to minlength</span>
    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">).name != da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">7</span><span class="s1">).name</span>
    <span class="s0">assert </span><span class="s1">da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">).name == da.bincount(d</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">).name</span>

    <span class="s1">expected_output = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=e.dtype)</span>
    <span class="s1">assert_eq(e[</span><span class="s3">0</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">expected_output)  </span><span class="s4"># can bincount result be sliced</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;weights&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_bincount_with_weights(weights):</span>
    <span class="s1">x = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">dweights = da.from_array(weights</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">e = da.bincount(d</span><span class="s0">, </span><span class="s1">weights=dweights</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">np.bincount(x</span><span class="s0">, </span><span class="s1">weights=dweights.compute()</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.bincount(d</span><span class="s0">, </span><span class="s1">weights=dweights</span><span class="s0">, </span><span class="s1">minlength=</span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">e)</span>


<span class="s0">def </span><span class="s1">test_bincount_unspecified_minlength():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">e = da.bincount(d)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">np.bincount(x))</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.bincount(d)</span><span class="s0">, </span><span class="s1">e)</span>
    <span class="s0">assert </span><span class="s1">len(e.compute()) == </span><span class="s3">8  </span><span class="s4"># shape is (nan,) so must compute for len()</span>


<span class="s0">def </span><span class="s1">test_digitize():</span>
    <span class="s1">x = np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">bins = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s0">for </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]:</span>
        <span class="s0">for </span><span class="s1">right </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
            <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
            <span class="s1">assert_eq(</span>
                <span class="s1">da.digitize(d</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">right=right)</span><span class="s0">, </span><span class="s1">np.digitize(x</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">right=right)</span>
            <span class="s1">)</span>

    <span class="s1">x = np.random.default_rng().random(size=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">))</span>
    <span class="s1">bins = np.random.default_rng().random(size=</span><span class="s3">13</span><span class="s1">)</span>
    <span class="s1">bins.sort()</span>
    <span class="s0">for </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">17</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">87</span><span class="s0">, </span><span class="s3">54</span><span class="s1">)]:</span>
        <span class="s0">for </span><span class="s1">right </span><span class="s0">in </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">]:</span>
            <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
            <span class="s1">assert_eq(</span>
                <span class="s1">da.digitize(d</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">right=right)</span><span class="s0">, </span><span class="s1">np.digitize(x</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">right=right)</span>
            <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;a, a_chunks, v, v_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[[]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">15</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;side&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;left&quot;</span><span class="s0">, </span><span class="s2">&quot;right&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_searchsorted(a</span><span class="s0">, </span><span class="s1">a_chunks</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">v_chunks</span><span class="s0">, </span><span class="s1">side):</span>
    <span class="s1">a = np.array(a)</span>
    <span class="s1">v = np.array(v)</span>

    <span class="s1">ad = da.asarray(a</span><span class="s0">, </span><span class="s1">chunks=a_chunks)</span>
    <span class="s1">vd = da.asarray(v</span><span class="s0">, </span><span class="s1">chunks=v_chunks)</span>

    <span class="s1">out = da.searchsorted(ad</span><span class="s0">, </span><span class="s1">vd</span><span class="s0">, </span><span class="s1">side)</span>

    <span class="s0">assert </span><span class="s1">out.shape == vd.shape</span>
    <span class="s0">assert </span><span class="s1">out.chunks == vd.chunks</span>
    <span class="s1">assert_eq(out</span><span class="s0">, </span><span class="s1">np.searchsorted(a</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">side))</span>


<span class="s0">def </span><span class="s1">test_searchsorted_sorter_not_implemented():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.searchsorted(da.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">da.asarray([</span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">sorter=da.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_histogram():</span>
    <span class="s4"># Test for normal, flattened input</span>
    <span class="s1">n = </span><span class="s3">100</span>
    <span class="s1">v = da.random.default_rng().random(n</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">bins = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1.01</span><span class="s0">, </span><span class="s3">0.01</span><span class="s1">)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins)</span>

    <span class="s4"># Check if the sum of the bins equals the number of samples</span>
    <span class="s0">assert </span><span class="s1">a2.sum(axis=</span><span class="s3">0</span><span class="s1">) == n</span>
    <span class="s0">assert </span><span class="s1">a1.sum(axis=</span><span class="s3">0</span><span class="s1">) == n</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a1)</span>


<span class="s0">def </span><span class="s1">test_histogram_alternative_bins_range():</span>
    <span class="s1">v = da.random.default_rng().random(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogram(v</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogram(v</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(b1</span><span class="s0">, </span><span class="s1">b2)</span>


<span class="s0">def </span><span class="s1">test_histogram_bins_range_with_nan_array():</span>
    <span class="s4"># Regression test for issue #3977</span>
    <span class="s1">v = da.from_array(np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogram(v</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">range=(-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogram(v</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">range=(-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(b1</span><span class="s0">, </span><span class="s1">b2)</span>


<span class="s0">def </span><span class="s1">test_histogram_return_type():</span>
    <span class="s1">v = da.random.default_rng().random(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">bins = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1.01</span><span class="s0">, </span><span class="s3">0.01</span><span class="s1">)</span>
    <span class="s4"># Check if return type is same as hist</span>
    <span class="s1">bins = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.histogram(v * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">bins=bins)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.histogram(v * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">bins=bins)[</span><span class="s3">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_histogram_extra_args_and_shapes():</span>
    <span class="s4"># Check for extra args and shapes</span>
    <span class="s1">bins = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1.01</span><span class="s0">, </span><span class="s3">0.01</span><span class="s1">)</span>
    <span class="s1">v = da.random.default_rng().random(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">data = [</span>
        <span class="s1">(v</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">da.ones(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=v.chunks) * </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">da.random.default_rng().random((</span><span class="s3">50</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">bins</span><span class="s0">,</span>
            <span class="s1">da.ones((</span><span class="s3">50</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">) * </span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">v</span><span class="s0">, </span><span class="s1">bins</span><span class="s0">, </span><span class="s1">w </span><span class="s0">in </span><span class="s1">data:</span>
        <span class="s4"># density</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s4"># weights</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">weights=w)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">np.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">weights=w)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s1">assert_eq(</span>
            <span class="s1">da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">weights=w</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">da.histogram(v</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">weights=w</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_histogram_normed_deprecation():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">da.histogram(x</span><span class="s0">, </span><span class="s1">bins=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">normed=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s2">&quot;density&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;deprecated&quot; </span><span class="s0">in </span><span class="s1">str(info.value).lower()</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;bins, hist_range&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">None, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">da.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]))</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(da.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_histogram_bin_range_raises(bins</span><span class="s0">, </span><span class="s1">hist_range):</span>
    <span class="s1">data = da.random.default_rng().random(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises((ValueError</span><span class="s0">, </span><span class="s1">TypeError)) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">da.histogram(data</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=hist_range)</span>
    <span class="s1">err_msg = str(info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;bins&quot; </span><span class="s0">in </span><span class="s1">err_msg </span><span class="s0">or </span><span class="s2">&quot;range&quot; </span><span class="s0">in </span><span class="s1">err_msg</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;density&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weighted&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;non_delayed_i&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;delay_n_bins&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_histogram_delayed_range(density</span><span class="s0">, </span><span class="s1">weighted</span><span class="s0">, </span><span class="s1">non_delayed_i</span><span class="s0">, </span><span class="s1">delay_n_bins):</span>
    <span class="s1">n = </span><span class="s3">100</span>
    <span class="s1">v = np.random.default_rng().random(n)</span>
    <span class="s1">vd = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">weighted:</span>
        <span class="s1">weights = np.random.default_rng().random(n)</span>
        <span class="s1">weights_d = da.from_array(weights</span><span class="s0">, </span><span class="s1">chunks=vd.chunks)</span>

    <span class="s1">d_range = [vd.min()</span><span class="s0">, </span><span class="s1">vd.max()]</span>
    <span class="s0">if </span><span class="s1">non_delayed_i </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">d_range[non_delayed_i] = d_range[non_delayed_i].compute()</span>
    <span class="s1">hist_d</span><span class="s0">, </span><span class="s1">bins_d = da.histogram(</span>
        <span class="s1">vd</span><span class="s0">,</span>
        <span class="s1">bins=da.array(n) </span><span class="s0">if </span><span class="s1">delay_n_bins </span><span class="s0">and not </span><span class="s1">density </span><span class="s0">else </span><span class="s1">n</span><span class="s0">,</span>
        <span class="s1">range=d_range</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=weights_d </span><span class="s0">if </span><span class="s1">weighted </span><span class="s0">else None,</span>
    <span class="s1">)</span>

    <span class="s1">hist</span><span class="s0">, </span><span class="s1">bins = np.histogram(</span>
        <span class="s1">v</span><span class="s0">,</span>
        <span class="s1">bins=n</span><span class="s0">,</span>
        <span class="s1">range=[v.min()</span><span class="s0">, </span><span class="s1">v.max()]</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=weights </span><span class="s0">if </span><span class="s1">weighted </span><span class="s0">else None,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(hist_d</span><span class="s0">, </span><span class="s1">hist)</span>
    <span class="s1">assert_eq(bins_d</span><span class="s0">, </span><span class="s1">bins)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;density&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weighted&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_histogram_delayed_bins(density</span><span class="s0">, </span><span class="s1">weighted):</span>
    <span class="s1">n = </span><span class="s3">100</span>
    <span class="s1">v = np.random.default_rng().random(n)</span>
    <span class="s1">bins = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">vd = da.from_array(v</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">bins_d = da.from_array(bins</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">weighted:</span>
        <span class="s1">weights = np.random.default_rng().random(n)</span>
        <span class="s1">weights_d = da.from_array(weights</span><span class="s0">, </span><span class="s1">chunks=vd.chunks)</span>

    <span class="s1">hist_d</span><span class="s0">, </span><span class="s1">bins_d2 = da.histogram(</span>
        <span class="s1">vd</span><span class="s0">,</span>
        <span class="s1">bins=bins_d</span><span class="s0">,</span>
        <span class="s1">range=[bins_d[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">bins_d[-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=weights_d </span><span class="s0">if </span><span class="s1">weighted </span><span class="s0">else None,</span>
    <span class="s1">)</span>

    <span class="s1">hist</span><span class="s0">, </span><span class="s1">bins = np.histogram(</span>
        <span class="s1">v</span><span class="s0">,</span>
        <span class="s1">bins=bins</span><span class="s0">,</span>
        <span class="s1">range=[bins[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">bins[-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=weights </span><span class="s0">if </span><span class="s1">weighted </span><span class="s0">else None,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">bins_d </span><span class="s0">is </span><span class="s1">bins_d2</span>
    <span class="s1">assert_eq(hist_d</span><span class="s0">, </span><span class="s1">hist)</span>
    <span class="s1">assert_eq(bins_d2</span><span class="s0">, </span><span class="s1">bins)</span>


<span class="s0">def </span><span class="s1">test_histogram_delayed_n_bins_raises_with_density():</span>
    <span class="s1">data = da.random.default_rng().random(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">NotImplementedError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;`bins` cannot be a scalar Dask object&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogram(data</span><span class="s0">, </span><span class="s1">bins=da.array(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weights&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;density&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;bins&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_histogram2d(weights</span><span class="s0">, </span><span class="s1">density</span><span class="s0">, </span><span class="s1">bins):</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">n = </span><span class="s3">800</span>
    <span class="s1">b = bins</span>
    <span class="s1">r = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">x = rng.uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = rng.uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">w = rng.uniform(</span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">1.1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">)) </span><span class="s0">if </span><span class="s1">weights </span><span class="s0">else None</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">b1x</span><span class="s0">, </span><span class="s1">b1y = da.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">range=r</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2x</span><span class="s0">, </span><span class="s1">b2y = np.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">range=r</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">a3</span><span class="s0">, </span><span class="s1">b3x</span><span class="s0">, </span><span class="s1">b3y = np.histogram2d(</span>
        <span class="s1">x.compute()</span><span class="s0">,</span>
        <span class="s1">y.compute()</span><span class="s0">,</span>
        <span class="s1">bins=b</span><span class="s0">,</span>
        <span class="s1">range=r</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=w.compute() </span><span class="s0">if </span><span class="s1">weights </span><span class="s0">else None,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s0">if not </span><span class="s1">(weights </span><span class="s0">or </span><span class="s1">density):</span>
        <span class="s0">assert </span><span class="s1">a1.sum() == n</span>
        <span class="s0">assert </span><span class="s1">a2.sum() == n</span>
    <span class="s0">assert </span><span class="s1">same_keys(</span>
        <span class="s1">da.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">range=r</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">a1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a1.compute().shape == a3.shape</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weights&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;density&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_histogram2d_array_bins(weights</span><span class="s0">, </span><span class="s1">density):</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">n = </span><span class="s3">800</span>
    <span class="s1">xbins = [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.6</span><span class="s0">, </span><span class="s3">0.9</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span>
    <span class="s1">ybins = [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.4</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span>
    <span class="s1">b = [xbins</span><span class="s0">, </span><span class="s1">ybins]</span>
    <span class="s1">x = rng.uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = rng.uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">w = rng.uniform(</span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">1.1</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">,</span><span class="s1">)) </span><span class="s0">if </span><span class="s1">weights </span><span class="s0">else None</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">b1x</span><span class="s0">, </span><span class="s1">b1y = da.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2x</span><span class="s0">, </span><span class="s1">b2y = np.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">a3</span><span class="s0">, </span><span class="s1">b3x</span><span class="s0">, </span><span class="s1">b3y = np.histogram2d(</span>
        <span class="s1">x.compute()</span><span class="s0">,</span>
        <span class="s1">y.compute()</span><span class="s0">,</span>
        <span class="s1">bins=b</span><span class="s0">,</span>
        <span class="s1">density=density</span><span class="s0">,</span>
        <span class="s1">weights=w.compute() </span><span class="s0">if </span><span class="s1">weights </span><span class="s0">else None,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s0">if not </span><span class="s1">(weights </span><span class="s0">or </span><span class="s1">density):</span>
        <span class="s0">assert </span><span class="s1">a1.sum() == n</span>
        <span class="s0">assert </span><span class="s1">a2.sum() == n</span>
    <span class="s0">assert </span><span class="s1">same_keys(</span>
        <span class="s1">da.histogram2d(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">bins=b</span><span class="s0">, </span><span class="s1">density=density</span><span class="s0">, </span><span class="s1">weights=w)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">a1</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a1.compute().shape == a3.shape</span>


<span class="s0">def </span><span class="s1">test_histogramdd():</span>
    <span class="s1">n1</span><span class="s0">, </span><span class="s1">n2 = </span><span class="s3">800</span><span class="s0">, </span><span class="s3">3</span>
    <span class="s1">x = da.random.default_rng().uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">, </span><span class="s1">n2)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">bins = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.85</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = np.histogramdd(x.compute()</span><span class="s0">, </span><span class="s1">bins=bins)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s0">assert </span><span class="s1">a1.sum() == n1</span>
    <span class="s0">assert </span><span class="s1">a2.sum() == n1</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a1)</span>
    <span class="s0">assert </span><span class="s1">a1.compute().shape == a3.shape</span>


<span class="s0">def </span><span class="s1">test_histogramdd_seq_of_arrays():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">n1 = </span><span class="s3">800</span>
    <span class="s1">x = rng.uniform(size=(n1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">200</span><span class="s1">)</span>
    <span class="s1">y = rng.uniform(size=(n1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">200</span><span class="s1">)</span>
    <span class="s1">bx = [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.75</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span>
    <span class="s1">by = [</span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.30</span><span class="s0">, </span><span class="s3">0.70</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">bins=[bx</span><span class="s0">, </span><span class="s1">by])</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd([x</span><span class="s0">, </span><span class="s1">y]</span><span class="s0">, </span><span class="s1">bins=[bx</span><span class="s0">, </span><span class="s1">by])</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = np.histogramdd((x.compute()</span><span class="s0">, </span><span class="s1">y.compute())</span><span class="s0">, </span><span class="s1">bins=[bx</span><span class="s0">, </span><span class="s1">by])</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_alternative_bins_range():</span>
    <span class="s4"># test for normal input</span>
    <span class="s1">n1</span><span class="s0">, </span><span class="s1">n2 = </span><span class="s3">600</span><span class="s0">, </span><span class="s3">3</span>
    <span class="s1">x = da.random.default_rng().uniform(</span>
        <span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">, </span><span class="s1">n2)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">200</span><span class="s0">, </span><span class="s3">200</span><span class="s0">, </span><span class="s3">200</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">)</span>
    <span class="s1">bins = (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">ranges = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * len(bins)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = np.histogramdd(x.compute()</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s1">bins = </span><span class="s3">4</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>

    <span class="s0">assert </span><span class="s1">a1.sum() == n1</span>
    <span class="s0">assert </span><span class="s1">a2.sum() == n1</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a1)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_weighted():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s4"># test for normal input</span>
    <span class="s1">n1</span><span class="s0">, </span><span class="s1">n2 = </span><span class="s3">600</span><span class="s0">, </span><span class="s3">3</span>
    <span class="s1">x = rng.uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">, </span><span class="s1">n2)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">200</span><span class="s0">, </span><span class="s3">200</span><span class="s0">, </span><span class="s3">200</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)))</span>
    <span class="s1">w = rng.uniform(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">200</span><span class="s1">)</span>
    <span class="s1">bins = (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">ranges = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * len(bins)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = np.histogramdd(x.compute()</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w.compute())</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s1">bins = </span><span class="s3">4</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = np.histogramdd(x.compute()</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w.compute())</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_density():</span>
    <span class="s1">n1</span><span class="s0">, </span><span class="s1">n2 = </span><span class="s3">800</span><span class="s0">, </span><span class="s3">3</span>
    <span class="s1">x = da.random.default_rng().uniform(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">, </span><span class="s1">n2)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">bins = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.85</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">normed=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">(a4</span><span class="s0">, </span><span class="s1">b4) = np.histogramdd(x.compute()</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a4)</span>
    <span class="s0">assert </span><span class="s1">same_keys(da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a1)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_weighted_density():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">n1</span><span class="s0">, </span><span class="s1">n2 = </span><span class="s3">1200</span><span class="s0">, </span><span class="s3">4</span>
    <span class="s1">x = rng.standard_normal(size=(n1</span><span class="s0">, </span><span class="s1">n2)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">200</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">w = rng.uniform(</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">1.2</span><span class="s0">, </span><span class="s1">size=(n1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">200</span><span class="s1">)</span>
    <span class="s1">bins = (</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">ranges = ((-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * len(bins)</span>
    <span class="s1">(a1</span><span class="s0">, </span><span class="s1">b1) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">(a2</span><span class="s0">, </span><span class="s1">b2) = np.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w</span><span class="s0">, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">(a3</span><span class="s0">, </span><span class="s1">b3) = da.histogramdd(x</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">weights=w</span><span class="s0">, </span><span class="s1">normed=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a2)</span>
    <span class="s1">assert_eq(a1</span><span class="s0">, </span><span class="s1">a3)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raises_incompat_sample_chunks():</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Input array can only be chunked along the 0th axis&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raises_incompat_multiarg_chunks():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">z = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;All coordinate arrays must be chunked identically.&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd((x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z)</span><span class="s0">, </span><span class="s1">bins=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raises_incompat_weight_chunks():</span>
    <span class="s1">rng = da.random.default_rng()</span>
    <span class="s1">x = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">z = da.atleast_2d((x</span><span class="s0">, </span><span class="s1">y)).T.rechunk((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">w = rng.random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">&quot;Input arrays and weights must have the same shape and chunk structure.&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd((x</span><span class="s0">, </span><span class="s1">y)</span><span class="s0">, </span><span class="s1">bins=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=w)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">&quot;Input array and weights must have the same shape and chunk structure along the first dimension.&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(z</span><span class="s0">, </span><span class="s1">bins=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=w)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raises_incompat_bins_or_range():</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">bins = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">ranges = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * len(bins)</span>

    <span class="s4"># bad number of bins defined (should be data.shape[1])</span>
    <span class="s1">bins = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">&quot;The dimension of bins must be equal to the dimension of the sample.&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>

    <span class="s4"># one range per dimension is required.</span>
    <span class="s1">bins = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">ranges = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">,</span>
        <span class="s1">match=</span><span class="s2">&quot;range argument requires one entry, a min max pair, per dimension.&quot;</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges)</span>

    <span class="s4"># has range elements that are not pairs</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;range argument should be a sequence of pairs&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raise_normed_and_density():</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">bins = (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s1">ranges = ((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cannot specify both 'normed' and 'density'&quot;</span><span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=bins</span><span class="s0">, </span><span class="s1">range=ranges</span><span class="s0">, </span><span class="s1">normed=</span><span class="s0">True, </span><span class="s1">density=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_histogramdd_raise_incompat_shape():</span>
    <span class="s4"># 1D</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Single array input to histogramdd should be columnar&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">range=((-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s4"># 3D (not columnar)</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Single array input to histogramdd should be columnar&quot;</span>
    <span class="s1">):</span>
        <span class="s1">da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">range=((-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_histogramdd_edges():</span>
    <span class="s1">data = da.random.default_rng().random(size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">edges = [</span>
        <span class="s1">np.array([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.3</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s0">, </span><span class="s3">0.8</span><span class="s0">, </span><span class="s3">0.9</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.7</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s4"># passing bins as an array of bin edges.</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">b1 = da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=edges)</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2 = np.histogramdd(data.compute()</span><span class="s0">, </span><span class="s1">bins=edges)</span>
    <span class="s0">for </span><span class="s1">ib1</span><span class="s0">, </span><span class="s1">ib2 </span><span class="s0">in </span><span class="s1">zip(b1</span><span class="s0">, </span><span class="s1">b2):</span>
        <span class="s1">assert_eq(ib1</span><span class="s0">, </span><span class="s1">ib2)</span>
    <span class="s4"># passing bins as an int with range definitions</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">b1 = da.histogramdd(data</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">a2</span><span class="s0">, </span><span class="s1">b2 = np.histogramdd(data.compute()</span><span class="s0">, </span><span class="s1">bins=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">range=((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">ib1</span><span class="s0">, </span><span class="s1">ib2 </span><span class="s0">in </span><span class="s1">zip(b1</span><span class="s0">, </span><span class="s1">b2):</span>
        <span class="s1">assert_eq(ib1</span><span class="s0">, </span><span class="s1">ib2)</span>


<span class="s0">def </span><span class="s1">test_cov():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.cov(d)</span><span class="s0">, </span><span class="s1">np.cov(x))</span>
    <span class="s1">assert_eq(da.cov(d</span><span class="s0">, </span><span class="s1">rowvar=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.cov(x</span><span class="s0">, </span><span class="s1">rowvar=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">category=RuntimeWarning)  </span><span class="s4"># dof &lt;= 0 for slice</span>
        <span class="s1">assert_eq(da.cov(d</span><span class="s0">, </span><span class="s1">ddof=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.cov(x</span><span class="s0">, </span><span class="s1">ddof=</span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.cov(d</span><span class="s0">, </span><span class="s1">bias=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.cov(x</span><span class="s0">, </span><span class="s1">bias=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.cov(d</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">np.cov(x</span><span class="s0">, </span><span class="s1">x))</span>

    <span class="s1">y = np.arange(</span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">e = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.cov(d</span><span class="s0">, </span><span class="s1">e)</span><span class="s0">, </span><span class="s1">np.cov(x</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.cov(e</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">np.cov(y</span><span class="s0">, </span><span class="s1">x))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.cov(d</span><span class="s0">, </span><span class="s1">ddof=</span><span class="s3">1.5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_corrcoef():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.corrcoef(d)</span><span class="s0">, </span><span class="s1">np.corrcoef(x))</span>
    <span class="s1">assert_eq(da.corrcoef(d</span><span class="s0">, </span><span class="s1">rowvar=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.corrcoef(x</span><span class="s0">, </span><span class="s1">rowvar=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.corrcoef(d</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">np.corrcoef(x</span><span class="s0">, </span><span class="s1">x))</span>

    <span class="s1">y = np.arange(</span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">e = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.corrcoef(d</span><span class="s0">, </span><span class="s1">e)</span><span class="s0">, </span><span class="s1">np.corrcoef(x</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">assert_eq(da.corrcoef(e</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">np.corrcoef(y</span><span class="s0">, </span><span class="s1">x))</span>


<span class="s0">def </span><span class="s1">test_round():</span>
    <span class="s1">x = np.random.default_rng().random(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">):</span>
        <span class="s1">assert_eq(x.round(i)</span><span class="s0">, </span><span class="s1">d.round(i))</span>

    <span class="s1">assert_eq(d.round(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.round(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;return_index&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;return_inverse&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;return_counts&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_unique_kwargs(return_index</span><span class="s0">, </span><span class="s1">return_inverse</span><span class="s0">, </span><span class="s1">return_counts):</span>
    <span class="s1">kwargs = dict(</span>
        <span class="s1">return_index=return_index</span><span class="s0">,</span>
        <span class="s1">return_inverse=return_inverse</span><span class="s0">,</span>
        <span class="s1">return_counts=return_counts</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">a = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">r_a = np.unique(a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">r_d = da.unique(d</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">if not </span><span class="s1">any([return_index</span><span class="s0">, </span><span class="s1">return_inverse</span><span class="s0">, </span><span class="s1">return_counts]):</span>
        <span class="s0">assert </span><span class="s1">isinstance(r_a</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
        <span class="s0">assert </span><span class="s1">isinstance(r_d</span><span class="s0">, </span><span class="s1">da.Array)</span>

        <span class="s1">r_a = (r_a</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">r_d = (r_d</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">len(r_a) == len(r_d)</span>

    <span class="s0">if </span><span class="s1">return_inverse:</span>
        <span class="s1">i = </span><span class="s3">1 </span><span class="s1">+ int(return_index)</span>
        <span class="s0">assert </span><span class="s1">(d.size</span><span class="s0">,</span><span class="s1">) == r_d[i].shape</span>

    <span class="s0">for </span><span class="s1">e_r_a</span><span class="s0">, </span><span class="s1">e_r_d </span><span class="s0">in </span><span class="s1">zip(r_a</span><span class="s0">, </span><span class="s1">r_d):</span>
        <span class="s1">assert_eq(e_r_d</span><span class="s0">, </span><span class="s1">e_r_a)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">23</span><span class="s0">, </span><span class="s3">796</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;low, high&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_unique_rand(seed</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">rng = np.random.default_rng(seed)</span>

    <span class="s1">a = rng.integers(low</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">size=shape)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">kwargs = dict(return_index=</span><span class="s0">True, </span><span class="s1">return_inverse=</span><span class="s0">True, </span><span class="s1">return_counts=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">r_a = np.unique(a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
    <span class="s1">r_d = da.unique(d</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">assert </span><span class="s1">len(r_a) == len(r_d)</span>

    <span class="s0">assert </span><span class="s1">(d.size</span><span class="s0">,</span><span class="s1">) == r_d[</span><span class="s3">2</span><span class="s1">].shape</span>

    <span class="s0">for </span><span class="s1">e_r_a</span><span class="s0">, </span><span class="s1">e_r_d </span><span class="s0">in </span><span class="s1">zip(r_a</span><span class="s0">, </span><span class="s1">r_d):</span>
        <span class="s1">assert_eq(e_r_d</span><span class="s0">, </span><span class="s1">e_r_a)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">23</span><span class="s0">, </span><span class="s3">796</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;low, high&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;elements_shape, elements_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;test_shape, test_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;invert&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_isin_rand(</span>
    <span class="s1">seed</span><span class="s0">, </span><span class="s1">low</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">elements_shape</span><span class="s0">, </span><span class="s1">elements_chunks</span><span class="s0">, </span><span class="s1">test_shape</span><span class="s0">, </span><span class="s1">test_chunks</span><span class="s0">, </span><span class="s1">invert</span>
<span class="s1">):</span>
    <span class="s1">rng = np.random.default_rng(seed)</span>

    <span class="s1">a1 = rng.integers(low</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">size=elements_shape)</span>
    <span class="s1">d1 = da.from_array(a1</span><span class="s0">, </span><span class="s1">chunks=elements_chunks)</span>

    <span class="s1">a2 = rng.integers(low</span><span class="s0">, </span><span class="s1">high</span><span class="s0">, </span><span class="s1">size=test_shape) - </span><span class="s3">5</span>
    <span class="s1">d2 = da.from_array(a2</span><span class="s0">, </span><span class="s1">chunks=test_chunks)</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">category=da.PerformanceWarning)</span>
        <span class="s1">r_a = np.isin(a1</span><span class="s0">, </span><span class="s1">a2</span><span class="s0">, </span><span class="s1">invert=invert)</span>
        <span class="s1">r_d = da.isin(d1</span><span class="s0">, </span><span class="s1">d2</span><span class="s0">, </span><span class="s1">invert=invert)</span>
    <span class="s1">assert_eq(r_a</span><span class="s0">, </span><span class="s1">r_d)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;assume_unique&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_isin_assume_unique(assume_unique):</span>
    <span class="s1">a1 = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d1 = da.from_array(a1</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">test_elements = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">r_a = np.isin(a1</span><span class="s0">, </span><span class="s1">test_elements</span><span class="s0">, </span><span class="s1">assume_unique=assume_unique)</span>
    <span class="s1">r_d = da.isin(d1</span><span class="s0">, </span><span class="s1">test_elements</span><span class="s0">, </span><span class="s1">assume_unique=assume_unique)</span>
    <span class="s1">assert_eq(r_a</span><span class="s0">, </span><span class="s1">r_d)</span>


<span class="s0">def </span><span class="s1">_maybe_len(l):</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s0">return </span><span class="s1">len(l)</span>
    <span class="s0">except </span><span class="s1">TypeError:</span>
        <span class="s0">return </span><span class="s3">0</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shift&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_roll(chunks</span><span class="s0">, </span><span class="s1">shift</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s0">if </span><span class="s1">_maybe_len(shift) != _maybe_len(axis):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError </span><span class="s0">if </span><span class="s1">axis </span><span class="s0">is None else </span><span class="s1">ValueError):</span>
            <span class="s1">da.roll(a</span><span class="s0">, </span><span class="s1">shift</span><span class="s0">, </span><span class="s1">axis)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(np.roll(x</span><span class="s0">, </span><span class="s1">shift</span><span class="s0">, </span><span class="s1">axis)</span><span class="s0">, </span><span class="s1">da.roll(a</span><span class="s0">, </span><span class="s1">shift</span><span class="s0">, </span><span class="s1">axis))</span>


<span class="s0">def </span><span class="s1">test_roll_always_results_in_a_new_array():</span>
    <span class="s1">x = da.arange(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">y = da.roll(x</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y </span><span class="s0">is not </span><span class="s1">x</span>


<span class="s0">def </span><span class="s1">test_roll_works_even_if_shape_is_0():</span>
    <span class="s1">expected = np.roll(np.zeros(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">actual = da.roll(da.zeros(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">actual)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_shape_and_ndim(shape):</span>
    <span class="s1">x = da.random.default_rng().random(shape)</span>
    <span class="s0">assert </span><span class="s1">np.shape(x) == shape</span>

    <span class="s1">x = da.random.default_rng().random(shape)</span>
    <span class="s0">assert </span><span class="s1">np.ndim(x) == len(shape)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">12</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">12</span><span class="s0">,</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">12</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;reverse&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_union1d(shape</span><span class="s0">, </span><span class="s1">reverse):</span>
    <span class="s1">s1</span><span class="s0">, </span><span class="s1">s2 = shape</span>
    <span class="s1">x1 = np.arange(</span><span class="s3">12</span><span class="s1">).reshape(s1)</span>
    <span class="s1">x2 = np.arange(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">18</span><span class="s1">).reshape(s2)</span>

    <span class="s0">if </span><span class="s1">reverse:</span>
        <span class="s1">x1 = x1[::-</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s1">dx1 = da.from_array(x1)</span>
    <span class="s1">dx2 = da.from_array(x2)</span>

    <span class="s1">result = np.union1d(dx1</span><span class="s0">, </span><span class="s1">dx2)</span>
    <span class="s1">expected = np.union1d(x1</span><span class="s0">, </span><span class="s1">x2)</span>

    <span class="s0">assert </span><span class="s1">isinstance(result</span><span class="s0">, </span><span class="s1">da.Array)</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_ravel():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>

    <span class="s4"># 2d</span>
    <span class="s0">for </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]:</span>
        <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
        <span class="s1">assert_eq(x.ravel()</span><span class="s0">, </span><span class="s1">a.ravel())</span>
        <span class="s0">assert </span><span class="s1">len(a.ravel().dask) == len(a.dask) + len(a.chunks[</span><span class="s3">0</span><span class="s1">])</span>

    <span class="s4"># 0d</span>
    <span class="s1">assert_eq(x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">].ravel()</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">].ravel())</span>

    <span class="s4"># 1d</span>
    <span class="s1">a_flat = a.ravel()</span>
    <span class="s1">assert_eq(a_flat.ravel()</span><span class="s0">, </span><span class="s1">a_flat)</span>

    <span class="s4"># 3d</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)]:</span>
        <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
        <span class="s1">assert_eq(x.ravel()</span><span class="s0">, </span><span class="s1">a.ravel())</span>

    <span class="s1">assert_eq(x.flatten()</span><span class="s0">, </span><span class="s1">a.flatten())</span>
    <span class="s1">assert_eq(np.ravel(x)</span><span class="s0">, </span><span class="s1">da.ravel(a))</span>


<span class="s0">def </span><span class="s1">test_ravel_1D_no_op():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s4"># known dims</span>
    <span class="s1">assert_eq(dx.ravel()</span><span class="s0">, </span><span class="s1">x.ravel())</span>
    <span class="s4"># Unknown dims</span>
    <span class="s1">assert_eq(dx[dx &gt; </span><span class="s3">2</span><span class="s1">].ravel()</span><span class="s0">, </span><span class="s1">x[x &gt; </span><span class="s3">2</span><span class="s1">].ravel())</span>


<span class="s0">def </span><span class="s1">test_ravel_with_array_like():</span>
    <span class="s4"># int</span>
    <span class="s1">assert_eq(np.ravel(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.ravel(</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">isinstance(da.ravel(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.core.Array)</span>

    <span class="s4"># list</span>
    <span class="s1">assert_eq(np.ravel([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">da.ravel([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>
    <span class="s0">assert </span><span class="s1">isinstance(da.ravel([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">da.core.Array)</span>

    <span class="s4"># tuple</span>
    <span class="s1">assert_eq(np.ravel((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">da.ravel((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">isinstance(da.ravel((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">da.core.Array)</span>

    <span class="s4"># nested i.e. tuples in list</span>
    <span class="s1">assert_eq(np.ravel([(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">, </span><span class="s1">da.ravel([(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)]))</span>
    <span class="s0">assert </span><span class="s1">isinstance(da.ravel([(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)])</span><span class="s0">, </span><span class="s1">da.core.Array)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_expand_dims(axis):</span>
    <span class="s1">a = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">axis </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
            <span class="s1">da.expand_dims(d</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s0">elif </span><span class="s1">axis == </span><span class="s3">2</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
            <span class="s1">da.expand_dims(d</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">a_e = np.expand_dims(a</span><span class="s0">, </span><span class="s1">axis=axis)</span>
        <span class="s1">d_e = da.expand_dims(d</span><span class="s0">, </span><span class="s1">axis=axis)</span>

        <span class="s1">assert_eq(d_e</span><span class="s0">, </span><span class="s1">a_e)</span>
        <span class="s0">assert </span><span class="s1">same_keys(d_e</span><span class="s0">, </span><span class="s1">da.expand_dims(d</span><span class="s0">, </span><span class="s1">axis=axis))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;is_func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_squeeze(is_func</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">a = np.arange(</span><span class="s3">10</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:</span><span class="s0">, None, None</span><span class="s1">]</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">is_func:</span>
        <span class="s1">a_s = np.squeeze(a</span><span class="s0">, </span><span class="s1">axis=axis)</span>
        <span class="s1">d_s = da.squeeze(d</span><span class="s0">, </span><span class="s1">axis=axis)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">a_s = a.squeeze(axis=axis)</span>
        <span class="s1">d_s = d.squeeze(axis=axis)</span>

    <span class="s1">assert_eq(d_s</span><span class="s0">, </span><span class="s1">a_s)</span>
    <span class="s0">assert </span><span class="s1">same_keys(d_s</span><span class="s0">, </span><span class="s1">da.squeeze(d</span><span class="s0">, </span><span class="s1">axis=axis))</span>

    <span class="s0">if </span><span class="s1">axis </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">axis = tuple(range(a.ndim))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">axis = axis </span><span class="s0">if </span><span class="s1">isinstance(axis</span><span class="s0">, </span><span class="s1">tuple) </span><span class="s0">else </span><span class="s1">(axis</span><span class="s0">,</span><span class="s1">)</span>
        <span class="s1">axis = tuple(i % a.ndim </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">axis)</span>
    <span class="s1">axis = tuple(i </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">enumerate(d.chunks) </span><span class="s0">if </span><span class="s1">i </span><span class="s0">in </span><span class="s1">axis </span><span class="s0">and </span><span class="s1">len(c) == </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">exp_d_s_chunks = tuple(c </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">enumerate(d.chunks) </span><span class="s0">if </span><span class="s1">i </span><span class="s0">not in </span><span class="s1">axis)</span>
    <span class="s0">assert </span><span class="s1">d_s.chunks == exp_d_s_chunks</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_squeeze_1d_array(shape):</span>
    <span class="s1">a = np.full(shape=shape</span><span class="s0">, </span><span class="s1">fill_value=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">a_s = np.squeeze(a)</span>
    <span class="s1">d = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">d_s = da.squeeze(d)</span>
    <span class="s0">assert </span><span class="s1">isinstance(d_s</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s0">assert </span><span class="s1">isinstance(d_s.compute()</span><span class="s0">, </span><span class="s1">np.ndarray)</span>
    <span class="s1">assert_eq(d_s</span><span class="s0">, </span><span class="s1">a_s)</span>


<span class="s0">def </span><span class="s1">test_vstack():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = np.ones(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">b = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(np.vstack((x</span><span class="s0">, </span><span class="s1">y))</span><span class="s0">, </span><span class="s1">da.vstack((a</span><span class="s0">, </span><span class="s1">b)))</span>
    <span class="s1">assert_eq(np.vstack((x</span><span class="s0">, </span><span class="s1">y[</span><span class="s0">None, </span><span class="s1">:]))</span><span class="s0">, </span><span class="s1">da.vstack((a</span><span class="s0">, </span><span class="s1">b[</span><span class="s0">None, </span><span class="s1">:])))</span>


<span class="s0">def </span><span class="s1">test_hstack():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = np.ones(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">b = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(np.hstack((x[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">y[</span><span class="s0">None, </span><span class="s1">:]))</span><span class="s0">, </span><span class="s1">da.hstack((a[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">b[</span><span class="s0">None, </span><span class="s1">:])))</span>
    <span class="s1">assert_eq(np.hstack((x</span><span class="s0">, </span><span class="s1">y))</span><span class="s0">, </span><span class="s1">da.hstack((a</span><span class="s0">, </span><span class="s1">b)))</span>


<span class="s0">def </span><span class="s1">test_dstack():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = np.ones(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">b = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.dstack((x[</span><span class="s0">None, None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">y[</span><span class="s0">None, None, </span><span class="s1">:]))</span><span class="s0">,</span>
        <span class="s1">da.dstack((a[</span><span class="s0">None, None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">b[</span><span class="s0">None, None, </span><span class="s1">:]))</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(np.dstack((x[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">y[</span><span class="s0">None, </span><span class="s1">:]))</span><span class="s0">, </span><span class="s1">da.dstack((a[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">b[</span><span class="s0">None, </span><span class="s1">:])))</span>
    <span class="s1">assert_eq(np.dstack((x</span><span class="s0">, </span><span class="s1">y))</span><span class="s0">, </span><span class="s1">da.dstack((a</span><span class="s0">, </span><span class="s1">b)))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;np_func,dsk_func,nan_chunk&quot;</span><span class="s0">,</span>
    <span class="s1">[(np.hstack</span><span class="s0">, </span><span class="s1">da.hstack</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.dstack</span><span class="s0">, </span><span class="s1">da.dstack</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.vstack</span><span class="s0">, </span><span class="s1">da.vstack</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_stack_unknown_chunk_sizes(np_func</span><span class="s0">, </span><span class="s1">dsk_func</span><span class="s0">, </span><span class="s1">nan_chunk):</span>
    <span class="s1">shape = (</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">50</span><span class="s1">))</span>
    <span class="s1">y = np.ones(shape)</span>

    <span class="s1">tmp = list(x._chunks)</span>
    <span class="s1">tmp[nan_chunk] = (np.nan</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span>
    <span class="s1">x._chunks = tuple(tmp)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dsk_func((x</span><span class="s0">, </span><span class="s1">x))</span>

    <span class="s1">np_stacked = np_func((y</span><span class="s0">, </span><span class="s1">y))</span>
    <span class="s1">dsk_stacked = dsk_func((x</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">allow_unknown_chunksizes=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_eq(np_stacked</span><span class="s0">, </span><span class="s1">dsk_stacked)</span>


<span class="s0">def </span><span class="s1">test_take():</span>
    <span class="s1">x = np.arange(</span><span class="s3">400</span><span class="s1">).reshape((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.take(x</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.take(a</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.take(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.take(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.take(a</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">same_keys(da.take(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.take(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_take_dask_from_numpy():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">).astype(</span><span class="s2">&quot;f8&quot;</span><span class="s1">)</span>
    <span class="s1">y = da.from_array(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">z = da.take(x * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y)</span>

    <span class="s0">assert </span><span class="s1">z.chunks == y.chunks</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_compress():</span>
    <span class="s1">x = np.arange(</span><span class="s3">25</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">c1 = np.array([</span><span class="s0">True, False, True, False, True</span><span class="s1">])</span>
    <span class="s1">c2 = np.array([</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s1">c3 = [</span><span class="s0">True, False</span><span class="s1">]</span>
    <span class="s1">dc1 = da.from_array(c1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">dc2 = da.from_array(c2</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">c</span><span class="s0">, </span><span class="s1">dc </span><span class="s0">in </span><span class="s1">[(c1</span><span class="s0">, </span><span class="s1">c1)</span><span class="s0">, </span><span class="s1">(c2</span><span class="s0">, </span><span class="s1">c2)</span><span class="s0">, </span><span class="s1">(c3</span><span class="s0">, </span><span class="s1">c3)</span><span class="s0">, </span><span class="s1">(c1</span><span class="s0">, </span><span class="s1">dc1)</span><span class="s0">, </span><span class="s1">(c2</span><span class="s0">, </span><span class="s1">dc2)</span><span class="s0">, </span><span class="s1">(c3</span><span class="s0">, </span><span class="s1">dc2)]:</span>
        <span class="s0">for </span><span class="s1">axis </span><span class="s0">in </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]:</span>
            <span class="s1">res = da.compress(dc</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">axis=axis)</span>
            <span class="s1">assert_eq(np.compress(c</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axis=axis)</span><span class="s0">, </span><span class="s1">res)</span>
            <span class="s0">if </span><span class="s1">isinstance(dc</span><span class="s0">, </span><span class="s1">da.Array):</span>
                <span class="s4"># If condition is a dask array then we expect the shape of the</span>
                <span class="s4"># compressed array to be nan, because we won't know that until</span>
                <span class="s4"># the result is computed.</span>
                <span class="s1">axis = axis </span><span class="s0">or </span><span class="s3">0</span>
                <span class="s0">assert </span><span class="s1">np.isnan(res.shape[axis]).all()</span>
                <span class="s0">assert </span><span class="s1">np.isnan(res.chunks[axis]).all()</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># If condition is a not a dask array then we expect the shape of the</span>
                <span class="s4"># compressed axis to be known, i.e., not nan.</span>
                <span class="s1">axis = axis </span><span class="s0">or </span><span class="s3">0</span>
                <span class="s0">assert </span><span class="s1">np.count_nonzero(dc) == res.shape[axis]</span>
                <span class="s0">assert not </span><span class="s1">np.isnan(res.chunks[axis]).any()</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.compress([</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">100</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.compress([[</span><span class="s0">True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">100</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_extract():</span>
    <span class="s1">x = np.arange(</span><span class="s3">25</span><span class="s1">).reshape((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">c1 = np.array([</span><span class="s0">True, False, True, False, True</span><span class="s1">])</span>
    <span class="s1">c2 = np.array([[</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">]])</span>
    <span class="s1">c3 = np.array([</span><span class="s0">True, False</span><span class="s1">])</span>
    <span class="s1">dc1 = da.from_array(c1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">dc2 = da.from_array(c2</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">dc3 = da.from_array(c3</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">c</span><span class="s0">, </span><span class="s1">dc </span><span class="s0">in </span><span class="s1">[(c1</span><span class="s0">, </span><span class="s1">c1)</span><span class="s0">, </span><span class="s1">(c2</span><span class="s0">, </span><span class="s1">c2)</span><span class="s0">, </span><span class="s1">(c3</span><span class="s0">, </span><span class="s1">c3)</span><span class="s0">, </span><span class="s1">(c1</span><span class="s0">, </span><span class="s1">dc1)</span><span class="s0">, </span><span class="s1">(c2</span><span class="s0">, </span><span class="s1">dc2)</span><span class="s0">, </span><span class="s1">(c3</span><span class="s0">, </span><span class="s1">dc3)]:</span>
        <span class="s1">res = da.extract(dc</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_eq(np.extract(c</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">res)</span>
        <span class="s0">if </span><span class="s1">isinstance(dc</span><span class="s0">, </span><span class="s1">da.Array):</span>
            <span class="s0">assert </span><span class="s1">np.isnan(res.chunks[</span><span class="s3">0</span><span class="s1">]).all()</span>


<span class="s0">def </span><span class="s1">test_isnull():</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">contextlib.suppress(ImportError):</span>
        <span class="s1">assert_eq(da.isnull(a)</span><span class="s0">, </span><span class="s1">np.isnan(x))</span>
        <span class="s1">assert_eq(da.notnull(a)</span><span class="s0">, </span><span class="s1">~(np.isnan(x)))</span>


<span class="s0">def </span><span class="s1">test_isnull_result_is_an_array():</span>
    <span class="s4"># regression test for https://github.com/dask/dask/issues/3822</span>
    <span class="s1">arr = da.from_array(np.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">contextlib.suppress(ImportError):</span>
        <span class="s1">result = da.isnull(arr[</span><span class="s3">0</span><span class="s1">]).compute()</span>
        <span class="s0">assert </span><span class="s1">type(result) </span><span class="s0">is </span><span class="s1">np.ndarray</span>


<span class="s0">def </span><span class="s1">test_isclose():</span>
    <span class="s1">x = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">])</span>
    <span class="s1">y = np.array([</span><span class="s3">1e-9</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.isclose(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.isclose(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_allclose():</span>
    <span class="s1">n_a = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">])</span>
    <span class="s1">n_b = np.array([</span><span class="s3">1e-9</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">d_a = da.from_array(n_a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">d_b = da.from_array(n_b</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">n_r = np.allclose(n_a</span><span class="s0">, </span><span class="s1">n_b</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">d_r = da.allclose(d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">assert_eq(np.array(n_r)[()]</span><span class="s0">, </span><span class="s1">d_r)</span>


<span class="s0">def </span><span class="s1">test_choose():</span>
    <span class="s4"># test choose function</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(da.choose(d &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">np.choose(x &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">x]))</span>
    <span class="s1">assert_eq(da.choose(d &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">[-d</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">np.choose(x &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">[-x</span><span class="s0">, </span><span class="s1">x]))</span>

    <span class="s4"># test choose method</span>
    <span class="s1">index_dask = d &gt; </span><span class="s3">5</span>
    <span class="s1">index_numpy = x &gt; </span><span class="s3">5</span>
    <span class="s1">assert_eq(index_dask.choose([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">index_numpy.choose([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">x]))</span>
    <span class="s1">assert_eq(index_dask.choose([-d</span><span class="s0">, </span><span class="s1">d])</span><span class="s0">, </span><span class="s1">index_numpy.choose([-x</span><span class="s0">, </span><span class="s1">x]))</span>


<span class="s0">def </span><span class="s1">test_piecewise():</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">1337</span><span class="s1">)</span>

    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.piecewise(x</span><span class="s0">, </span><span class="s1">[x &lt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">x &gt;= </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: e + </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.piecewise(d</span><span class="s0">, </span><span class="s1">[d &lt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">d &gt;= </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: e + </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">k=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_piecewise_otherwise():</span>
    <span class="s1">rng = np.random.default_rng(</span><span class="s3">1337</span><span class="s1">)</span>

    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.piecewise(</span>
            <span class="s1">x</span><span class="s0">,</span>
            <span class="s1">[x &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">x &lt;= </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s0">lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: e + </span><span class="s3">1</span><span class="s0">, lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: v * e</span><span class="s0">, lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s1">k=</span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.piecewise(</span>
            <span class="s1">d</span><span class="s0">,</span>
            <span class="s1">[d &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">d &lt;= </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s0">lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: e + </span><span class="s3">1</span><span class="s0">, lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: v * e</span><span class="s0">, lambda </span><span class="s1">e</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">k: </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s1">k=</span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_select():</span>
    <span class="s1">conditions = [</span>
        <span class="s1">np.array([</span><span class="s0">False, False, False, False</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s0">False, True, False, True</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s0">False, False, True, True</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">choices = [</span>
        <span class="s1">np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">d_conditions = da.from_array(conditions</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">d_choices = da.from_array(choices)</span>
    <span class="s1">assert_eq(np.select(conditions</span><span class="s0">, </span><span class="s1">choices)</span><span class="s0">, </span><span class="s1">da.select(d_conditions</span><span class="s0">, </span><span class="s1">d_choices))</span>


<span class="s0">def </span><span class="s1">test_select_multidimension():</span>
    <span class="s1">x = np.random.default_rng().random((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">res_x = np.select([x &lt; </span><span class="s3">0</span><span class="s0">, </span><span class="s1">x &gt; </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x &gt; </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[x</span><span class="s0">, </span><span class="s1">x * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x * </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">default=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">res_y = da.select([y &lt; </span><span class="s3">0</span><span class="s0">, </span><span class="s1">y &gt; </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y &gt; </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[y</span><span class="s0">, </span><span class="s1">y * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y * </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">default=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(res_y</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s1">assert_eq(res_y</span><span class="s0">, </span><span class="s1">res_x)</span>


<span class="s0">def </span><span class="s1">test_select_return_dtype():</span>
    <span class="s1">d = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span>
    <span class="s1">m = np.isnan(d)</span>
    <span class="s1">d_d = da.from_array(d)</span>
    <span class="s1">d_m = da.isnan(d_d)</span>
    <span class="s1">assert_eq(np.select([m]</span><span class="s0">, </span><span class="s1">[d])</span><span class="s0">, </span><span class="s1">da.select([d_m]</span><span class="s0">, </span><span class="s1">[d_d])</span><span class="s0">, </span><span class="s1">equal_nan=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;broadcasting in da.select() not implemented yet&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_select_broadcasting():</span>
    <span class="s1">conditions = [np.array(</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">False, True, False</span><span class="s1">])]</span>
    <span class="s1">choices = [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>
    <span class="s1">d_conditions = da.from_array(conditions)</span>
    <span class="s1">d_choices = da.from_array(choices)</span>
    <span class="s1">assert_eq(np.select(conditions</span><span class="s0">, </span><span class="s1">choices)</span><span class="s0">, </span><span class="s1">da.select(d_conditions</span><span class="s0">, </span><span class="s1">d_choices))</span>
    <span class="s4"># default can broadcast too:</span>
    <span class="s1">assert_eq(np.select([</span><span class="s0">True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">default=[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">da.select([</span><span class="s0">True</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">default=[</span><span class="s3">0</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_argwhere():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_nz = np.argwhere(x)</span>
        <span class="s1">d_nz = da.argwhere(d)</span>

        <span class="s1">assert_eq(d_nz</span><span class="s0">, </span><span class="s1">x_nz)</span>


<span class="s0">def </span><span class="s1">test_argwhere_obj():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)).astype(object)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">x_nz = np.argwhere(x)</span>
    <span class="s1">d_nz = da.argwhere(d)</span>

    <span class="s1">assert_eq(d_nz</span><span class="s0">, </span><span class="s1">x_nz)</span>


<span class="s0">def </span><span class="s1">test_argwhere_str():</span>
    <span class="s4"># We may have behavior differences with NumPy for strings</span>
    <span class="s4"># with just spaces, depending on the version of NumPy.</span>
    <span class="s4"># https://github.com/numpy/numpy/issues/9875</span>
    <span class="s1">x = np.array(list(</span><span class="s2">&quot;Hello world&quot;</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">x_nz = np.argwhere(x)</span>
    <span class="s1">d_nz = da.argwhere(d)</span>

    <span class="s1">assert_eq(d_nz</span><span class="s0">, </span><span class="s1">x_nz)</span>


<span class="s0">def </span><span class="s1">test_where():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">14</span><span class="s1">))</span>
    <span class="s1">x[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">] = x[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">] = </span><span class="s3">0  </span><span class="s4"># Ensure some false elements</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">).astype(np.uint8)</span>
    <span class="s1">e = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">c1</span><span class="s0">, </span><span class="s1">c2 </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">(d &gt; </span><span class="s3">5</span><span class="s0">, </span><span class="s1">x &gt; </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.True_</span><span class="s0">, </span><span class="s1">np.True_)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">False, False</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(np.False_</span><span class="s0">, </span><span class="s1">np.False_)</span><span class="s0">,</span>
    <span class="s1">]:</span>
        <span class="s0">for </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">b2 </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(-e[:</span><span class="s0">, None</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-y[:</span><span class="s0">, None</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(e[:</span><span class="s3">14</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[:</span><span class="s3">14</span><span class="s1">])]:</span>
            <span class="s1">w1 = da.where(c1</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">b1)</span>
            <span class="s1">w2 = np.where(c2</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">b2)</span>
            <span class="s1">assert_eq(w1</span><span class="s0">, </span><span class="s1">w2)</span>


<span class="s0">def </span><span class="s1">test_where_scalar_dtype():</span>
    <span class="s1">x = np.int32(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">y1 = np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16)</span>
    <span class="s1">c1 = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">y2 = da.from_array(y1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">c2 = da.from_array(c1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">w1 = np.where(c1</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y1)</span>
    <span class="s1">w2 = da.where(c2</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y2)</span>
    <span class="s1">assert_eq(w1</span><span class="s0">, </span><span class="s1">w2)</span>
    <span class="s4"># Test again for the bool optimization</span>
    <span class="s1">w3 = np.where(</span><span class="s0">True, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y1)</span>
    <span class="s1">w4 = da.where(</span><span class="s0">True, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y1)</span>
    <span class="s1">assert_eq(w3</span><span class="s0">, </span><span class="s1">w4)</span>


<span class="s0">def </span><span class="s1">test_where_bool_optimization():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">e = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">[</span><span class="s0">True, False, </span><span class="s1">np.True_</span><span class="s0">, </span><span class="s1">np.False_</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]:</span>
        <span class="s1">w1 = da.where(c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e)</span>
        <span class="s1">w2 = np.where(c</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y)</span>

        <span class="s1">assert_eq(w1</span><span class="s0">, </span><span class="s1">w2)</span>

        <span class="s1">ex_w1 = d </span><span class="s0">if </span><span class="s1">c </span><span class="s0">else </span><span class="s1">e</span>

        <span class="s0">assert </span><span class="s1">w1 </span><span class="s0">is </span><span class="s1">ex_w1</span>


<span class="s0">def </span><span class="s1">test_where_nonzero():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_w = np.where(x)</span>
        <span class="s1">d_w = da.where(d)</span>

        <span class="s0">assert </span><span class="s1">isinstance(d_w</span><span class="s0">, </span><span class="s1">type(x_w))</span>
        <span class="s0">assert </span><span class="s1">len(d_w) == len(x_w)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_w)):</span>
            <span class="s1">assert_eq(d_w[i]</span><span class="s0">, </span><span class="s1">x_w[i])</span>


<span class="s0">def </span><span class="s1">test_where_incorrect_args():</span>
    <span class="s1">a = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s0">for </span><span class="s1">kwd </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]:</span>
        <span class="s1">kwargs = {kwd: a}</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">da.where(a &gt; </span><span class="s3">0</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s0">assert </span><span class="s2">&quot;either both or neither of x and y should be given&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>


<span class="s0">def </span><span class="s1">test_count_nonzero():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_c = np.count_nonzero(x)</span>
        <span class="s1">d_c = da.count_nonzero(d)</span>

        <span class="s0">if </span><span class="s1">d_c.shape == tuple():</span>
            <span class="s0">assert </span><span class="s1">x_c == d_c.compute()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_eq(x_c</span><span class="s0">, </span><span class="s1">d_c)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_count_nonzero_axis(axis):</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_c = np.count_nonzero(x</span><span class="s0">, </span><span class="s1">axis)</span>
        <span class="s1">d_c = da.count_nonzero(d</span><span class="s0">, </span><span class="s1">axis)</span>

        <span class="s0">if </span><span class="s1">d_c.shape == tuple():</span>
            <span class="s0">assert </span><span class="s1">x_c == d_c.compute()</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_eq(x_c</span><span class="s0">, </span><span class="s1">d_c)</span>


<span class="s0">def </span><span class="s1">test_count_nonzero_obj():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)).astype(object)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">x_c = np.count_nonzero(x)</span>
    <span class="s1">d_c = da.count_nonzero(d)</span>

    <span class="s0">if </span><span class="s1">d_c.shape == tuple():</span>
        <span class="s0">assert </span><span class="s1">x_c == d_c.compute()</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(x_c</span><span class="s0">, </span><span class="s1">d_c)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_count_nonzero_obj_axis(axis):</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)).astype(object)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">x_c = np.count_nonzero(x</span><span class="s0">, </span><span class="s1">axis)</span>
    <span class="s1">d_c = da.count_nonzero(d</span><span class="s0">, </span><span class="s1">axis)</span>

    <span class="s0">if </span><span class="s1">d_c.shape == tuple():</span>
        <span class="s0">assert </span><span class="s1">x_c == d_c.compute()</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4">#######################################################</span>
        <span class="s4"># Workaround oddness with Windows and object arrays.  #</span>
        <span class="s4">#                                                     #</span>
        <span class="s4"># xref: https://github.com/numpy/numpy/issues/9468    #</span>
        <span class="s4">#######################################################</span>
        <span class="s1">assert_eq(x_c.astype(np.intp)</span><span class="s0">, </span><span class="s1">d_c)</span>


<span class="s0">def </span><span class="s1">test_count_nonzero_str():</span>
    <span class="s4"># We may have behavior differences with NumPy for strings</span>
    <span class="s4"># with just spaces, depending on the version of NumPy.</span>
    <span class="s4"># https://github.com/numpy/numpy/issues/9875</span>
    <span class="s1">x = np.array(list(</span><span class="s2">&quot;Hellow orld&quot;</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">x_c = np.count_nonzero(x)</span>
    <span class="s1">d_c = da.count_nonzero(d)</span>

    <span class="s0">assert </span><span class="s1">x_c == d_c.compute()</span>


<span class="s0">def </span><span class="s1">test_flatnonzero():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_fnz = np.flatnonzero(x)</span>
        <span class="s1">d_fnz = da.flatnonzero(d)</span>

        <span class="s1">assert_eq(d_fnz</span><span class="s0">, </span><span class="s1">x_fnz)</span>


<span class="s0">def </span><span class="s1">test_nonzero():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_nz = np.nonzero(x)</span>
        <span class="s1">d_nz = da.nonzero(d)</span>

        <span class="s0">assert </span><span class="s1">isinstance(d_nz</span><span class="s0">, </span><span class="s1">type(x_nz))</span>
        <span class="s0">assert </span><span class="s1">len(d_nz) == len(x_nz)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_nz)):</span>
            <span class="s1">assert_eq(d_nz[i]</span><span class="s0">, </span><span class="s1">x_nz[i])</span>


<span class="s0">def </span><span class="s1">test_nonzero_method():</span>
    <span class="s0">for </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))]:</span>
        <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=shape)</span>
        <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

        <span class="s1">x_nz = x.nonzero()</span>
        <span class="s1">d_nz = d.nonzero()</span>

        <span class="s0">assert </span><span class="s1">isinstance(d_nz</span><span class="s0">, </span><span class="s1">type(x_nz))</span>
        <span class="s0">assert </span><span class="s1">len(d_nz) == len(x_nz)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(x_nz)):</span>
            <span class="s1">assert_eq(d_nz[i]</span><span class="s0">, </span><span class="s1">x_nz[i])</span>


<span class="s0">def </span><span class="s1">test_unravel_index_empty():</span>
    <span class="s1">shape = tuple()</span>
    <span class="s1">findices = np.array(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">dtype=int)</span>
    <span class="s1">d_findices = da.from_array(findices</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">indices = np.unravel_index(findices</span><span class="s0">, </span><span class="s1">shape)</span>
    <span class="s1">d_indices = da.unravel_index(d_findices</span><span class="s0">, </span><span class="s1">shape)</span>

    <span class="s0">assert </span><span class="s1">isinstance(d_indices</span><span class="s0">, </span><span class="s1">type(indices))</span>
    <span class="s0">assert </span><span class="s1">len(d_indices) == len(indices) == </span><span class="s3">0</span>


<span class="s0">def </span><span class="s1">test_unravel_index():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s0">for </span><span class="s1">nindices</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">order </span><span class="s0">in </span><span class="s1">[</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;F&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;F&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]:</span>
        <span class="s1">arr = rng.random(shape)</span>
        <span class="s1">darr = da.from_array(arr</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">findices = rng.integers(np.prod(shape</span><span class="s0">, </span><span class="s1">dtype=int)</span><span class="s0">, </span><span class="s1">size=nindices)</span>
        <span class="s1">d_findices = da.from_array(findices</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">indices = np.unravel_index(findices</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">order)</span>
        <span class="s1">d_indices = da.unravel_index(d_findices</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">order)</span>

        <span class="s0">assert </span><span class="s1">isinstance(d_indices</span><span class="s0">, </span><span class="s1">type(indices))</span>
        <span class="s0">assert </span><span class="s1">len(d_indices) == len(indices)</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(indices)):</span>
            <span class="s1">assert_eq(d_indices[i]</span><span class="s0">, </span><span class="s1">indices[i])</span>

        <span class="s1">assert_eq(darr.vindex[dask.compute(*d_indices)]</span><span class="s0">, </span><span class="s1">arr[indices])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;asarray&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: [np.asarray(a) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">x]</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x: [da.asarray(a) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">x]</span><span class="s0">,</span>
        <span class="s1">np.asarray</span><span class="s0">,</span>
        <span class="s1">da.from_array</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;arr, chunks, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s4"># Numpy doctests:</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;clip&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">mode=(</span><span class="s2">&quot;clip&quot;</span><span class="s0">, </span><span class="s2">&quot;wrap&quot;</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s4"># Shape tests:</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s4"># Multi-dimensional index arrays</span>
        <span class="s1">(</span>
            <span class="s1">np.arange(</span><span class="s3">6</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">).tolist()</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">dict(dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s4"># Broadcasting index arrays</span>
        <span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, None, </span><span class="s1">dict(dims=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]]]</span><span class="s0">, None, </span><span class="s1">dict(dims=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_ravel_multi_index(asarray</span><span class="s0">, </span><span class="s1">arr</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s0">if </span><span class="s1">any(np.isscalar(x) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">arr) </span><span class="s0">and </span><span class="s1">asarray </span><span class="s0">in </span><span class="s1">(np.asarray</span><span class="s0">, </span><span class="s1">da.from_array):</span>
        <span class="s1">pytest.skip()</span>

    <span class="s0">if </span><span class="s1">asarray </span><span class="s0">is </span><span class="s1">da.from_array:</span>
        <span class="s1">arr = np.asarray(arr)</span>
        <span class="s1">input = da.from_array(arr</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">arr = input = asarray(arr)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.ravel_multi_index(arr</span><span class="s0">, </span><span class="s1">**kwargs)</span><span class="s0">,</span>
        <span class="s1">da.ravel_multi_index(input</span><span class="s0">, </span><span class="s1">**kwargs)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ravel_multi_index_unknown_shape():</span>
    <span class="s1">multi_index = da.from_array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">multi_index = multi_index[(multi_index &gt; </span><span class="s3">0</span><span class="s1">).all(axis=</span><span class="s3">1</span><span class="s1">)]</span>

    <span class="s1">multi_index_np = multi_index.compute()</span>

    <span class="s0">assert </span><span class="s1">np.isnan(multi_index.shape).any()</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.ravel_multi_index(multi_index_np</span><span class="s0">, </span><span class="s1">dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">da.ravel_multi_index(multi_index</span><span class="s0">, </span><span class="s1">dims=(</span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_ravel_multi_index_unknown_shape_fails():</span>
    <span class="s1">multi_index1 = da.from_array([</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">multi_index1 = multi_index1[multi_index1 &gt; </span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">multi_index2 = da.from_array(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">multi_index2 = multi_index2[(multi_index2 &gt; </span><span class="s3">0</span><span class="s1">).all(axis=</span><span class="s3">1</span><span class="s1">)]</span>

    <span class="s1">multi_index = [</span><span class="s3">1</span><span class="s0">, </span><span class="s1">multi_index1</span><span class="s0">, </span><span class="s1">multi_index2]</span>

    <span class="s0">assert </span><span class="s1">np.isnan(multi_index1.shape).any()</span>
    <span class="s0">assert </span><span class="s1">np.isnan(multi_index2.shape).any()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Arrays' chunk sizes&quot;</span><span class="s1">):</span>
        <span class="s1">da.ravel_multi_index(multi_index</span><span class="s0">, </span><span class="s1">dims=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dims&quot;</span><span class="s0">, </span><span class="s1">[da.from_array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">])</span><span class="s0">, </span><span class="s1">delayed([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">nout=</span><span class="s3">2</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;wrap_in_list&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_ravel_multi_index_delayed_dims(dims</span><span class="s0">, </span><span class="s1">wrap_in_list):</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Dask types are not supported&quot;</span><span class="s1">):</span>
        <span class="s1">da.ravel_multi_index((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[dims[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dims[</span><span class="s3">1</span><span class="s1">]] </span><span class="s0">if </span><span class="s1">wrap_in_list </span><span class="s0">else </span><span class="s1">dims)</span>


<span class="s0">def </span><span class="s1">test_ravel_multi_index_non_int_dtype():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;only int indices permitted&quot;</span><span class="s1">):</span>
        <span class="s1">da.ravel_multi_index(</span>
            <span class="s1">(</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_coarsen():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">24</span><span class="s0">, </span><span class="s3">24</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">da.chunk.coarsen(np.sum</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">})</span><span class="s0">, </span><span class="s1">da.coarsen(np.sum</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">})</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.chunk.coarsen(np.sum</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">})</span><span class="s0">, </span><span class="s1">da.coarsen(da.sum</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">})</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.chunk.coarsen(np.mean</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float32&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.coarsen(da.mean</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float32&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_coarsen_with_excess():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">assert_eq(da.coarsen(np.min</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">trim_excess=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.coarsen(np.sum</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">3</span><span class="s1">}</span><span class="s0">, </span><span class="s1">trim_excess=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">np.array([</span><span class="s3">0 </span><span class="s1">+ </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3 </span><span class="s1">+ </span><span class="s3">4 </span><span class="s1">+ </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6 </span><span class="s1">+ </span><span class="s3">7 </span><span class="s1">+ </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[(x</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">3 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">16</span><span class="s0">, </span><span class="s3">32</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_coarsen_bad_chunks(chunks):</span>
    <span class="s1">x1 = da.arange(np.sum(chunks)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">x2 = x1.rechunk(tuple(chunks))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">da.coarsen(np.sum</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}</span><span class="s0">, </span><span class="s1">trim_excess=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.coarsen(np.sum</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}</span><span class="s0">, </span><span class="s1">trim_excess=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;chunks, divisor&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_aligned_coarsen_chunks(chunks</span><span class="s0">, </span><span class="s1">divisor):</span>
    <span class="s0">from </span><span class="s1">dask.array.routines </span><span class="s0">import </span><span class="s1">aligned_coarsen_chunks </span><span class="s0">as </span><span class="s1">acc</span>

    <span class="s1">aligned_chunks = acc(chunks</span><span class="s0">, </span><span class="s1">divisor)</span>
    <span class="s1">any_remainders = (np.array(aligned_chunks) % divisor) != </span><span class="s3">0</span>
    <span class="s1">valid_chunks = np.where((np.array(chunks) % divisor) == </span><span class="s3">0</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s4"># check that total number of elements is conserved</span>
    <span class="s0">assert </span><span class="s1">sum(aligned_chunks) == sum(chunks)</span>
    <span class="s4"># check that valid chunks are not modified</span>
    <span class="s0">assert </span><span class="s1">[chunks[idx] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">valid_chunks] == [</span>
        <span class="s1">aligned_chunks[idx] </span><span class="s0">for </span><span class="s1">idx </span><span class="s0">in </span><span class="s1">valid_chunks</span>
    <span class="s1">]</span>
    <span class="s4"># check that no chunks are 0</span>
    <span class="s0">assert </span><span class="s1">(np.array(aligned_chunks) &gt; </span><span class="s3">0</span><span class="s1">).all()</span>
    <span class="s4"># check that at most one chunk was added</span>
    <span class="s0">assert </span><span class="s1">len(aligned_chunks) &lt;= len(chunks) + </span><span class="s3">1</span>
    <span class="s4"># check that either 0 or 1 chunks are not divisible by divisor</span>
    <span class="s0">assert </span><span class="s1">any_remainders.sum() </span><span class="s0">in </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s4"># check that the only indivisible chunk is the last</span>
    <span class="s0">if </span><span class="s1">any_remainders.sum() == </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">any_remainders[-</span><span class="s3">1</span><span class="s1">] == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_insert():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.insert(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.insert(x</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.insert(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">3 </span><span class="s1">+ [</span><span class="s3">5</span><span class="s1">] * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">3 </span><span class="s1">+ [</span><span class="s3">5</span><span class="s1">] * </span><span class="s3">2</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(np.insert(x</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">y[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.insert(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">b[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">assert </span><span class="s1">same_keys(</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.insert(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_append():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s4"># appendage for axis 1 / -1</span>
    <span class="s1">y1 = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">b1 = da.from_array(y1</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># appendage for axis 0 / -2</span>
    <span class="s1">y0 = rng.integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">b0 = da.from_array(y0</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># test axis None</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">))</span>

    <span class="s4"># test axis 0 / -2</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b0</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">))</span>

    <span class="s4"># test axis 1 / -1</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.append(x</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s4"># test --&gt; treat values as array_likes</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.append(x</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.append(x</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.append(x</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s4"># check AxisError</span>
    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">((</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s4"># check ValueError if dimensions don't align</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.append(a</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">10</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_multi_insert():</span>
    <span class="s1">z = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">c = da.from_array(z</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.insert(np.insert(z</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.insert(da.insert(c</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_delete():</span>
    <span class="s1">x = np.random.default_rng().integers(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">size=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.delete(x</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(np.delete(x</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.delete(x</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(np.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(AxisError):</span>
        <span class="s1">da.delete(a</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_result_type():</span>
    <span class="s1">a = da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.float32)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.int16)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">c = da.from_array(np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.int64)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">x = np.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">np.float32)</span>
    <span class="s0">assert </span><span class="s1">da.result_type(b</span><span class="s0">, </span><span class="s1">c) == np.int64</span>
    <span class="s0">assert </span><span class="s1">da.result_type(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c) == np.float64</span>
    <span class="s0">assert </span><span class="s1">da.result_type(b</span><span class="s0">, </span><span class="s1">np.float32) == np.float32</span>
    <span class="s0">assert </span><span class="s1">da.result_type(b</span><span class="s0">, </span><span class="s1">np.dtype(np.float32)) == np.float32</span>
    <span class="s0">assert </span><span class="s1">da.result_type(b</span><span class="s0">, </span><span class="s1">x) == np.float32</span>
    <span class="s4"># Effect of scalars depends on their value</span>
    <span class="s0">assert </span><span class="s1">da.result_type(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">b) == np.int16</span>
    <span class="s0">assert </span><span class="s1">da.result_type(</span><span class="s3">1.0</span><span class="s0">, </span><span class="s1">a) == np.float32</span>
    <span class="s0">assert </span><span class="s1">da.result_type(np.int64(</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">b) == np.int16</span>
    <span class="s0">assert </span><span class="s1">da.result_type(np.ones(()</span><span class="s0">, </span><span class="s1">np.int64)</span><span class="s0">, </span><span class="s1">b) == np.int16  </span><span class="s4"># 0d array</span>
    <span class="s0">assert </span><span class="s1">da.result_type(</span><span class="s3">1e200</span><span class="s0">, </span><span class="s1">a) == np.float64  </span><span class="s4"># 1e200 is too big for float32</span>
    <span class="s4"># dask 0d-arrays are NOT treated like scalars</span>
    <span class="s1">c = da.from_array(np.ones(()</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">chunks=())</span>
    <span class="s0">assert </span><span class="s1">da.result_type(a</span><span class="s0">, </span><span class="s1">c) == np.float64</span>


<span class="s0">def </span><span class="s1">_numpy_and_dask_inputs(input_sigs):</span>
    <span class="s4"># einsum label dimensions</span>
    <span class="s1">_dimensions = {</span>
        <span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s0">,</span>
        <span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">6</span><span class="s0">,</span>
        <span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s0">,</span>
        <span class="s2">&quot;d&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s0">,</span>
        <span class="s2">&quot;e&quot;</span><span class="s1">: </span><span class="s3">6</span><span class="s0">,</span>
        <span class="s2">&quot;f&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s0">,</span>
        <span class="s2">&quot;g&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s2">&quot;h&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s2">&quot;*&quot;</span><span class="s1">: </span><span class="s3">11</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s4"># dimension chunks sizes</span>
    <span class="s1">_chunks = {</span>
        <span class="s2">&quot;a&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;b&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;c&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;d&quot;</span><span class="s1">: (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;e&quot;</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;f&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;g&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s2">&quot;h&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;*&quot;</span><span class="s1">: </span><span class="s3">11</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s0">def </span><span class="s1">_shape_from_string(s):</span>
        <span class="s0">return </span><span class="s1">tuple(_dimensions[c] </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s)</span>

    <span class="s0">def </span><span class="s1">_chunks_from_string(s):</span>
        <span class="s0">return </span><span class="s1">tuple(_chunks[c] </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">s)</span>

    <span class="s1">shapes = [_shape_from_string(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">input_sigs]</span>
    <span class="s1">chunks = [_chunks_from_string(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">input_sigs]</span>

    <span class="s1">np_inputs = [np.random.default_rng().random(s) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">shapes]</span>
    <span class="s1">da_inputs = [da.from_array(i</span><span class="s0">, </span><span class="s1">chunks=c) </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">c </span><span class="s0">in </span><span class="s1">zip(np_inputs</span><span class="s0">, </span><span class="s1">chunks)]</span>

    <span class="s0">return </span><span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;einsum_signature&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s2">&quot;abc,bad-&gt;abcd&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;abcdef,bcdfg-&gt;abcdeg&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ea,fb,abcd,gc,hd-&gt;efgh&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ab,b&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;aa&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a,a-&gt;&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a,a-&gt;a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a,a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a,b&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a,b,c&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ba,b&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ba,b-&gt;&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;defab,fedbc-&gt;defac&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ab...,bc...-&gt;ac...&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a...a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;abc...-&gt;cba...&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;...ab-&gt;...a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;a...a-&gt;a...&quot;</span><span class="s0">,</span>
        <span class="s4"># Following 2 from # https://stackoverflow.com/a/19203475/1611416</span>
        <span class="s2">&quot;...abc,...abcd-&gt;...d&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ab...,b-&gt;ab...&quot;</span><span class="s0">,</span>
        <span class="s4"># https://github.com/dask/dask/pull/3412#discussion_r182413444</span>
        <span class="s2">&quot;aa-&gt;a&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;ab,ab,c-&gt;c&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;aab,bc-&gt;ac&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;aab,bcc-&gt;ac&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;fdf,cdd,ccd,afe-&gt;ae&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;fff,fae,bef,def-&gt;abd&quot;</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_einsum(einsum_signature):</span>
    <span class="s1">input_sigs = einsum_signature.split(</span><span class="s2">&quot;-&gt;&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].replace(</span><span class="s2">&quot;...&quot;</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">).split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)</span>

    <span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(input_sigs)</span>

    <span class="s0">with </span><span class="s1">warnings.catch_warnings():</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;ignore&quot;</span><span class="s0">, </span><span class="s1">category=da.PerformanceWarning)</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">np.einsum(einsum_signature</span><span class="s0">, </span><span class="s1">*np_inputs)</span><span class="s0">,</span>
            <span class="s1">da.einsum(einsum_signature</span><span class="s0">, </span><span class="s1">*da_inputs)</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;optimize_opts&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">True, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;greedy&quot;</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;optimal&quot;</span><span class="s0">, False</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_einsum_optimize(optimize_opts):</span>
    <span class="s1">sig = </span><span class="s2">&quot;ea,fb,abcd,gc,hd-&gt;efgh&quot;</span>
    <span class="s1">input_sigs = sig.split(</span><span class="s2">&quot;-&gt;&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)</span>
    <span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(input_sigs)</span>

    <span class="s1">opt1</span><span class="s0">, </span><span class="s1">opt2 = optimize_opts</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">optimize=opt1)</span><span class="s0">,</span>
        <span class="s1">da.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">optimize=opt2)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">optimize=opt2)</span><span class="s0">,</span>
        <span class="s1">da.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">optimize=opt1)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;order&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;C&quot;</span><span class="s0">, </span><span class="s2">&quot;F&quot;</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;K&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_einsum_order(order):</span>
    <span class="s1">sig = </span><span class="s2">&quot;ea,fb,abcd,gc,hd-&gt;efgh&quot;</span>
    <span class="s1">input_sigs = sig.split(</span><span class="s2">&quot;-&gt;&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)</span>
    <span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(input_sigs)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">order=order)</span><span class="s0">, </span><span class="s1">da.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">order=order)</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;casting&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;no&quot;</span><span class="s0">, </span><span class="s2">&quot;equiv&quot;</span><span class="s0">, </span><span class="s2">&quot;safe&quot;</span><span class="s0">, </span><span class="s2">&quot;same_kind&quot;</span><span class="s0">, </span><span class="s2">&quot;unsafe&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_einsum_casting(casting):</span>
    <span class="s1">sig = </span><span class="s2">&quot;ea,fb,abcd,gc,hd-&gt;efgh&quot;</span>
    <span class="s1">input_sigs = sig.split(</span><span class="s2">&quot;-&gt;&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">].split(</span><span class="s2">&quot;,&quot;</span><span class="s1">)</span>
    <span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(input_sigs)</span>

    <span class="s1">assert_eq(</span>
        <span class="s1">np.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">casting=casting)</span><span class="s0">,</span>
        <span class="s1">da.einsum(sig</span><span class="s0">, </span><span class="s1">*np_inputs</span><span class="s0">, </span><span class="s1">casting=casting)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;split_every&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">2</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_einsum_split_every(split_every):</span>
    <span class="s1">np_inputs</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">np.einsum(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">*np_inputs)</span><span class="s0">, </span><span class="s1">da.einsum(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">*da_inputs</span><span class="s0">, </span><span class="s1">split_every=split_every)</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_einsum_invalid_args():</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">da_inputs = _numpy_and_dask_inputs(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">da.einsum(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">*da_inputs</span><span class="s0">, </span><span class="s1">foo=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">bar=</span><span class="s3">2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_einsum_broadcasting_contraction():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">a = rng.random((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">b = rng.random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">c = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">d = rng.random(</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_b = da.from_array(b</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_c = da.from_array(c</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_d = da.from_array(d</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>

    <span class="s1">np_res = np.einsum(</span><span class="s2">&quot;ijk,kl,jl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c)</span>
    <span class="s1">da_res = da.einsum(</span><span class="s2">&quot;ijk,kl,jl&quot;</span><span class="s0">, </span><span class="s1">d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">d_c)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">da_res)</span>

    <span class="s1">mul_res = da_res * d</span>

    <span class="s1">np_res = np.einsum(</span><span class="s2">&quot;ijk,kl,jl,i-&gt;i&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d)</span>
    <span class="s1">da_res = da.einsum(</span><span class="s2">&quot;ijk,kl,jl,i-&gt;i&quot;</span><span class="s0">, </span><span class="s1">d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">d_c</span><span class="s0">, </span><span class="s1">d_d)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">da_res)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">mul_res)</span>


<span class="s0">def </span><span class="s1">test_einsum_broadcasting_contraction2():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">a = rng.random((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">b = rng.random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">c = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">d = rng.random((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_b = da.from_array(b</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_c = da.from_array(c</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_d = da.from_array(d</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>

    <span class="s1">np_res = np.einsum(</span><span class="s2">&quot;abjk,kl,jl&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c)</span>
    <span class="s1">da_res = da.einsum(</span><span class="s2">&quot;abjk,kl,jl&quot;</span><span class="s0">, </span><span class="s1">d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">d_c)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">da_res)</span>

    <span class="s1">mul_res = da_res * d</span>

    <span class="s1">np_res = np.einsum(</span><span class="s2">&quot;abjk,kl,jl,ab-&gt;ab&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d)</span>
    <span class="s1">da_res = da.einsum(</span><span class="s2">&quot;abjk,kl,jl,ab-&gt;ab&quot;</span><span class="s0">, </span><span class="s1">d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">d_c</span><span class="s0">, </span><span class="s1">d_d)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">da_res)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">mul_res)</span>


<span class="s0">def </span><span class="s1">test_einsum_broadcasting_contraction3():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">a = rng.random((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">b = rng.random((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">c = rng.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">d = rng.random((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_b = da.from_array(b</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_c = da.from_array(c</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">d_d = da.from_array(d</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>

    <span class="s1">np_res = np.einsum(</span><span class="s2">&quot;ajk,kbl,jl,ab-&gt;ab&quot;</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d)</span>
    <span class="s1">da_res = da.einsum(</span><span class="s2">&quot;ajk,kbl,jl,ab-&gt;ab&quot;</span><span class="s0">, </span><span class="s1">d_a</span><span class="s0">, </span><span class="s1">d_b</span><span class="s0">, </span><span class="s1">d_c</span><span class="s0">, </span><span class="s1">d_d)</span>
    <span class="s1">assert_eq(np_res</span><span class="s0">, </span><span class="s1">da_res)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[np.arange(</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;returned&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_average(a</span><span class="s0">, </span><span class="s1">returned):</span>
    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">np_avg = np.average(a</span><span class="s0">, </span><span class="s1">returned=returned)</span>
    <span class="s1">da_avg = da.average(d_a</span><span class="s0">, </span><span class="s1">returned=returned)</span>

    <span class="s1">assert_eq(np_avg</span><span class="s0">, </span><span class="s1">da_avg)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[np.arange(</span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))])</span>
<span class="s0">def </span><span class="s1">test_average_keepdims(a):</span>
    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">da_avg = da.average(d_a</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">_numpy_123:</span>
        <span class="s1">np_avg = np.average(a</span><span class="s0">, </span><span class="s1">keepdims=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(np_avg</span><span class="s0">, </span><span class="s1">da_avg)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;keepdims&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_average_weights(keepdims):</span>
    <span class="s1">a = np.arange(</span><span class="s3">6</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">d_a = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">weights = np.array([</span><span class="s3">0.25</span><span class="s0">, </span><span class="s3">0.75</span><span class="s1">])</span>
    <span class="s1">d_weights = da.from_array(weights</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">da_avg = da.average(d_a</span><span class="s0">, </span><span class="s1">weights=d_weights</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">keepdims=keepdims)</span>

    <span class="s0">if </span><span class="s1">_numpy_123:</span>
        <span class="s1">assert_eq(da_avg</span><span class="s0">, </span><span class="s1">np.average(a</span><span class="s0">, </span><span class="s1">weights=weights</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">keepdims=keepdims))</span>
    <span class="s0">elif not </span><span class="s1">keepdims:</span>
        <span class="s1">assert_eq(da_avg</span><span class="s0">, </span><span class="s1">np.average(a</span><span class="s0">, </span><span class="s1">weights=weights</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_average_raises():</span>
    <span class="s1">d_a = da.arange(</span><span class="s3">11</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">da.average(d_a</span><span class="s0">, </span><span class="s1">weights=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>

    <span class="s0">with </span><span class="s1">pytest.warns(RuntimeWarning):</span>
        <span class="s1">da.average(d_a</span><span class="s0">, </span><span class="s1">weights=da.zeros_like(d_a)).compute()</span>


<span class="s0">def </span><span class="s1">test_iscomplexobj():</span>
    <span class="s1">a = da.from_array(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.iscomplexobj(a) </span><span class="s0">is False</span>

    <span class="s1">a = da.from_array(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">0j</span><span class="s1">])</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.iscomplexobj(a) </span><span class="s0">is True</span>


<span class="s0">def </span><span class="s1">test_tril_triu():</span>
    <span class="s1">A = np.random.default_rng().standard_normal((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">chk </span><span class="s0">in </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]:</span>
        <span class="s1">dA = da.from_array(A</span><span class="s0">, </span><span class="s1">(chk</span><span class="s0">, </span><span class="s1">chk))</span>

        <span class="s0">assert </span><span class="s1">np.allclose(da.triu(dA).compute()</span><span class="s0">, </span><span class="s1">np.triu(A))</span>
        <span class="s0">assert </span><span class="s1">np.allclose(da.tril(dA).compute()</span><span class="s0">, </span><span class="s1">np.tril(A))</span>

        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">-</span><span class="s3">25</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">20</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">19</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">15</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">14</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">9</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">8</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">6</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">5</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">4</span><span class="s0">,</span>
            <span class="s3">5</span><span class="s0">,</span>
            <span class="s3">6</span><span class="s0">,</span>
            <span class="s3">8</span><span class="s0">,</span>
            <span class="s3">10</span><span class="s0">,</span>
            <span class="s3">11</span><span class="s0">,</span>
            <span class="s3">15</span><span class="s0">,</span>
            <span class="s3">16</span><span class="s0">,</span>
            <span class="s3">19</span><span class="s0">,</span>
            <span class="s3">20</span><span class="s0">,</span>
            <span class="s3">21</span><span class="s0">,</span>
        <span class="s1">]:</span>
            <span class="s0">assert </span><span class="s1">np.allclose(da.triu(dA</span><span class="s0">, </span><span class="s1">k).compute()</span><span class="s0">, </span><span class="s1">np.triu(A</span><span class="s0">, </span><span class="s1">k))</span>
            <span class="s0">assert </span><span class="s1">np.allclose(da.tril(dA</span><span class="s0">, </span><span class="s1">k).compute()</span><span class="s0">, </span><span class="s1">np.tril(A</span><span class="s0">, </span><span class="s1">k))</span>


<span class="s0">def </span><span class="s1">test_tril_ndims():</span>
    <span class="s1">A = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">dA = da.from_array(A</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.triu(dA)</span><span class="s0">, </span><span class="s1">np.triu(A))</span>


<span class="s0">def </span><span class="s1">test_tril_triu_non_square_arrays():</span>
    <span class="s1">A = np.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s1">(</span><span class="s3">30</span><span class="s0">, </span><span class="s3">35</span><span class="s1">))</span>
    <span class="s1">dA = da.from_array(A</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(da.triu(dA)</span><span class="s0">, </span><span class="s1">np.triu(A))</span>
    <span class="s1">assert_eq(da.tril(dA)</span><span class="s0">, </span><span class="s1">np.tril(A))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;n, k, m, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_tril_triu_indices(n</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">m</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">actual = da.tril_indices(n=n</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">m=m</span><span class="s0">, </span><span class="s1">chunks=chunks)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">expected = np.tril_indices(n=n</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">m=m)[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">sys.platform == </span><span class="s2">&quot;win32&quot;</span><span class="s1">:</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">actual.astype(expected.dtype)</span><span class="s0">,</span>
            <span class="s1">expected</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(actual</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">actual = da.triu_indices(n=n</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">m=m</span><span class="s0">, </span><span class="s1">chunks=chunks)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">expected = np.triu_indices(n=n</span><span class="s0">, </span><span class="s1">k=k</span><span class="s0">, </span><span class="s1">m=m)[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s0">if </span><span class="s1">sys.platform == </span><span class="s2">&quot;win32&quot;</span><span class="s1">:</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">actual.astype(expected.dtype)</span><span class="s0">,</span>
            <span class="s1">expected</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(actual</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>