<html>
<head>
<title>test_weightstats.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_weightstats.py</font>
</center></td></tr></table>
<pre><span class="s0">'''tests for weightstats, compares with replication 
 
no failures but needs cleanup 
update 2012-09-09: 
   added test after fixing bug in covariance 
   TODOs: 
     - I do not remember what all the commented out code is doing 
     - should be refactored to use generator or inherited tests 
     - still gaps in test coverage 
       - value/diff in ttest_ind is tested in test_tost.py 
     - what about pandas data structures? 
 
Author: Josef Perktold 
License: BSD (3-clause) 
 
'''</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">scipy </span><span class="s2">import </span><span class="s1">stats</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_almost_equal</span><span class="s2">, </span><span class="s1">assert_allclose</span>

<span class="s2">from </span><span class="s1">statsmodels.stats.weightstats </span><span class="s2">import </span><span class="s1">(DescrStatsW</span><span class="s2">, </span><span class="s1">CompareMeans</span><span class="s2">,</span>
                                           <span class="s1">ttest_ind</span><span class="s2">, </span><span class="s1">ztest</span><span class="s2">, </span><span class="s1">zconfint)</span>
<span class="s2">from </span><span class="s1">statsmodels.tools.testing </span><span class="s2">import </span><span class="s1">Holder</span>


<span class="s3"># Mixin for tests against other packages.</span>
<span class="s2">class </span><span class="s1">CheckExternalMixin:</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">get_descriptives(cls</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">):</span>
        <span class="s1">cls.descriptive = DescrStatsW(cls.data</span><span class="s2">, </span><span class="s1">cls.weights</span><span class="s2">, </span><span class="s1">ddof)</span>

    <span class="s3"># TODO: not a test, belongs elsewhere?</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">save_data(cls</span><span class="s2">, </span><span class="s1">fname=</span><span class="s5">&quot;data.csv&quot;</span><span class="s1">):</span>
        <span class="s3"># Utility to get data into another package.</span>
        <span class="s1">df = pd.DataFrame(index=np.arange(len(cls.weights)))</span>
        <span class="s1">df[</span><span class="s5">&quot;weights&quot;</span><span class="s1">] = cls.weights</span>
        <span class="s2">if </span><span class="s1">cls.data.ndim == </span><span class="s4">1</span><span class="s1">:</span>
            <span class="s1">df[</span><span class="s5">&quot;data1&quot;</span><span class="s1">] = cls.data</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range(cls.data.shape[</span><span class="s4">1</span><span class="s1">]):</span>
                <span class="s1">df[</span><span class="s5">&quot;data%d&quot; </span><span class="s1">% (k + </span><span class="s4">1</span><span class="s1">)] = cls.data[:</span><span class="s2">, </span><span class="s1">k]</span>
        <span class="s1">df.to_csv(fname)</span>

    <span class="s2">def </span><span class="s1">test_mean(self):</span>
        <span class="s1">mn = self.descriptive.mean</span>
        <span class="s1">assert_allclose(mn</span><span class="s2">, </span><span class="s1">self.mean</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_sum(self):</span>
        <span class="s1">sm = self.descriptive.sum</span>
        <span class="s1">assert_allclose(sm</span><span class="s2">, </span><span class="s1">self.sum</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_var(self):</span>
        <span class="s3"># Use vardef=wgt option in SAS to match</span>
        <span class="s1">var = self.descriptive.var</span>
        <span class="s1">assert_allclose(var</span><span class="s2">, </span><span class="s1">self.var</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_std(self):</span>
        <span class="s3"># Use vardef=wgt option in SAS to match</span>
        <span class="s1">std = self.descriptive.std</span>
        <span class="s1">assert_allclose(std</span><span class="s2">, </span><span class="s1">self.std</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_sem(self):</span>
        <span class="s3"># Use default vardef in SAS to match; only makes sense if</span>
        <span class="s3"># weights sum to n.</span>
        <span class="s2">if not </span><span class="s1">hasattr(self</span><span class="s2">, </span><span class="s5">&quot;sem&quot;</span><span class="s1">):</span>
            <span class="s2">return</span>
        <span class="s1">sem = self.descriptive.std_mean</span>
        <span class="s1">assert_allclose(sem</span><span class="s2">, </span><span class="s1">self.sem</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_quantiles(self):</span>
        <span class="s1">quant = np.asarray(self.quantiles</span><span class="s2">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s2">for </span><span class="s1">return_pandas </span><span class="s2">in False, True</span><span class="s1">:</span>
            <span class="s1">qtl = self.descriptive.quantile(self.quantile_probs</span><span class="s2">,</span>
                                            <span class="s1">return_pandas=return_pandas)</span>
            <span class="s1">qtl = np.asarray(qtl</span><span class="s2">, </span><span class="s1">dtype=np.float64)</span>
            <span class="s1">assert_allclose(qtl</span><span class="s2">, </span><span class="s1">quant</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">TestSim1(CheckExternalMixin):</span>
    <span class="s3"># 1d data</span>

    <span class="s3"># Taken from SAS</span>
    <span class="s1">mean = </span><span class="s4">0.401499</span>
    <span class="s1">sum = </span><span class="s4">12.9553441</span>
    <span class="s1">var = </span><span class="s4">1.08022</span>
    <span class="s1">std = </span><span class="s4">1.03933</span>
    <span class="s1">quantiles = np.r_[-</span><span class="s4">1.81098</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.84052</span><span class="s2">, </span><span class="s4">0.32859</span><span class="s2">, </span><span class="s4">0.77808</span><span class="s2">, </span><span class="s4">2.93431</span><span class="s1">]</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">cls.data = np.random.normal(size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.weights = np.random.uniform(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.quantile_probs = np.r_[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">cls.get_descriptives()</span>


<span class="s2">class </span><span class="s1">TestSim1t(CheckExternalMixin):</span>
    <span class="s3"># 1d data with ties</span>

    <span class="s3"># Taken from SAS</span>
    <span class="s1">mean = </span><span class="s4">5.05103296</span>
    <span class="s1">sum = </span><span class="s4">156.573464</span>
    <span class="s1">var = </span><span class="s4">9.9711934</span>
    <span class="s1">std = </span><span class="s4">3.15771965</span>
    <span class="s1">quantiles = np.r_[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s1">]</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">cls.data = np.random.randint(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.data[</span><span class="s4">15</span><span class="s1">:</span><span class="s4">20</span><span class="s1">] = cls.data[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">]</span>
        <span class="s1">cls.data[</span><span class="s4">18</span><span class="s1">:</span><span class="s4">20</span><span class="s1">] = cls.data[</span><span class="s4">15</span><span class="s1">:</span><span class="s4">17</span><span class="s1">]</span>
        <span class="s1">cls.weights = np.random.uniform(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.quantile_probs = np.r_[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">cls.get_descriptives()</span>


<span class="s2">class </span><span class="s1">TestSim1n(CheckExternalMixin):</span>
    <span class="s3"># 1d data with weights summing to n so we can check the standard</span>
    <span class="s3"># error of the mean</span>

    <span class="s3"># Taken from SAS</span>
    <span class="s1">mean = -</span><span class="s4">0.3131058</span>
    <span class="s1">sum = -</span><span class="s4">6.2621168</span>
    <span class="s1">var = </span><span class="s4">0.49722696</span>
    <span class="s1">std = </span><span class="s4">0.70514322</span>
    <span class="s1">sem = </span><span class="s4">0.15767482</span>
    <span class="s1">quantiles = np.r_[-</span><span class="s4">1.61593</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1.45576</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.24356</span><span class="s2">, </span><span class="s4">0.16770</span><span class="s2">, </span><span class="s4">1.18791</span><span class="s1">]</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">4342</span><span class="s1">)</span>
        <span class="s1">cls.data = np.random.normal(size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.weights = np.random.uniform(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.weights *= </span><span class="s4">20 </span><span class="s1">/ cls.weights.sum()</span>
        <span class="s1">cls.quantile_probs = np.r_[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">cls.get_descriptives(</span><span class="s4">1</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">TestSim2(CheckExternalMixin):</span>
    <span class="s3"># 2d data</span>

    <span class="s3"># Taken from SAS</span>
    <span class="s1">mean = [-</span><span class="s4">0.2170406</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.2387543</span><span class="s1">]</span>
    <span class="s1">sum = [-</span><span class="s4">6.8383999</span><span class="s2">, </span><span class="s1">-</span><span class="s4">7.5225444</span><span class="s1">]</span>
    <span class="s1">var = [</span><span class="s4">1.77426344</span><span class="s2">, </span><span class="s4">0.61933542</span><span class="s1">]</span>
    <span class="s1">std = [</span><span class="s4">1.3320148</span><span class="s2">, </span><span class="s4">0.78697867</span><span class="s1">]</span>
    <span class="s1">quantiles = np.column_stack(</span>
        <span class="s1">(np.r_[-</span><span class="s4">2.55277</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1.40479</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.61040</span><span class="s2">, </span><span class="s4">0.52740</span><span class="s2">, </span><span class="s4">2.66246</span><span class="s1">]</span><span class="s2">,</span>
         <span class="s1">np.r_[-</span><span class="s4">1.49263</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1.15403</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.16231</span><span class="s2">, </span><span class="s4">0.16464</span><span class="s2">, </span><span class="s4">1.83062</span><span class="s1">]))</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">2249</span><span class="s1">)</span>
        <span class="s1">cls.data = np.random.normal(size=(</span><span class="s4">20</span><span class="s2">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">cls.weights = np.random.uniform(</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s1">size=</span><span class="s4">20</span><span class="s1">)</span>
        <span class="s1">cls.quantile_probs = np.r_[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.1</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">0.75</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">cls.get_descriptives()</span>


<span class="s2">class </span><span class="s1">TestWeightstats:</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 = </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span>
        <span class="s1">m1</span><span class="s2">, </span><span class="s1">m2 = </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span>
        <span class="s1">x1 = m1 + np.random.randn(n1)</span>
        <span class="s1">x2 = m2 + np.random.randn(n2)</span>
        <span class="s1">x1_2d = m1 + np.random.randn(n1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">x2_2d = m2 + np.random.randn(n2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">w1 = np.random.randint(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">4</span><span class="s2">, </span><span class="s1">n1)</span>
        <span class="s1">w2 = np.random.randint(</span><span class="s4">1</span><span class="s2">,</span><span class="s4">4</span><span class="s2">, </span><span class="s1">n2)</span>
        <span class="s1">cls.x1</span><span class="s2">, </span><span class="s1">cls.x2 = x1</span><span class="s2">, </span><span class="s1">x2</span>
        <span class="s1">cls.w1</span><span class="s2">, </span><span class="s1">cls.w2 = w1</span><span class="s2">, </span><span class="s1">w2</span>
        <span class="s1">cls.x1_2d</span><span class="s2">, </span><span class="s1">cls.x2_2d = x1_2d</span><span class="s2">, </span><span class="s1">x2_2d</span>

    <span class="s2">def </span><span class="s1">test_weightstats_1(self):</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 = self.x1</span><span class="s2">, </span><span class="s1">self.x2</span>
        <span class="s1">w1</span><span class="s2">, </span><span class="s1">w2 = self.w1</span><span class="s2">, </span><span class="s1">self.w2</span>
        <span class="s1">w1_ = </span><span class="s4">2. </span><span class="s1">* np.ones(len(x1))</span>
        <span class="s1">w2_ = </span><span class="s4">2. </span><span class="s1">* np.ones(len(x2))</span>

        <span class="s1">d1 = DescrStatsW(x1)</span>
        <span class="s3">#        print ttest_ind(x1, x2)</span>
        <span class="s3">#        print ttest_ind(x1, x2, usevar='unequal')</span>
        <span class="s3">#        #print ttest_ind(x1, x2, usevar='unequal')</span>
        <span class="s3">#        print stats.ttest_ind(x1, x2)</span>
        <span class="s3">#        print ttest_ind(x1, x2, usevar='unequal', alternative='larger')</span>
        <span class="s3">#        print ttest_ind(x1, x2, usevar='unequal', alternative='smaller')</span>
        <span class="s3">#        print ttest_ind(x1, x2, usevar='unequal', weights=(w1_, w2_))</span>
        <span class="s3">#        print stats.ttest_ind(np.r_[x1, x1], np.r_[x2,x2])</span>
        <span class="s1">assert_almost_equal(ttest_ind(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">weights=(w1_</span><span class="s2">, </span><span class="s1">w2_))[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">stats.ttest_ind(np.r_[x1</span><span class="s2">, </span><span class="s1">x1]</span><span class="s2">, </span><span class="s1">np.r_[x2</span><span class="s2">, </span><span class="s1">x2]))</span>

    <span class="s2">def </span><span class="s1">test_weightstats_2(self):</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 = self.x1</span><span class="s2">, </span><span class="s1">self.x2</span>
        <span class="s1">w1</span><span class="s2">, </span><span class="s1">w2 = self.w1</span><span class="s2">, </span><span class="s1">self.w2</span>

        <span class="s1">d1 = DescrStatsW(x1)</span>
        <span class="s1">d1w = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1)</span>
        <span class="s1">d2w = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2)</span>
        <span class="s1">x1r = d1w.asrepeats()</span>
        <span class="s1">x2r = d2w.asrepeats()</span>
        <span class="s3">#        print 'random weights'</span>
        <span class="s3">#        print ttest_ind(x1, x2, weights=(w1, w2))</span>
        <span class="s3">#        print stats.ttest_ind(x1r, x2r)</span>
        <span class="s1">assert_almost_equal(ttest_ind(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">weights=(w1</span><span class="s2">, </span><span class="s1">w2))[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">stats.ttest_ind(x1r</span><span class="s2">, </span><span class="s1">x2r)</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s3"># not the same as new version with random weights/replication</span>
        <span class="s3">#        assert x1r.shape[0] == d1w.sum_weights</span>
        <span class="s3">#        assert x2r.shape[0] == d2w.sum_weights</span>

        <span class="s1">assert_almost_equal(x2r.mean(</span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w.mean</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x2r.var()</span><span class="s2">, </span><span class="s1">d2w.var</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x2r.std()</span><span class="s2">, </span><span class="s1">d2w.std</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s3"># note: the following is for 1d</span>
        <span class="s1">assert_almost_equal(np.cov(x2r</span><span class="s2">, </span><span class="s1">bias=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w.cov</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s3"># assert_almost_equal(np.corrcoef(np.x2r), d2w.corrcoef, 19)</span>
        <span class="s3"># TODO: exception in corrcoef (scalar case)</span>

        <span class="s3"># one-sample tests</span>
        <span class="s3">#        print d1.ttest_mean(3)</span>
        <span class="s3">#        print stats.ttest_1samp(x1, 3)</span>
        <span class="s3">#        print d1w.ttest_mean(3)</span>
        <span class="s3">#        print stats.ttest_1samp(x1r, 3)</span>
        <span class="s1">assert_almost_equal(d1.ttest_mean(</span><span class="s4">3</span><span class="s1">)[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">stats.ttest_1samp(x1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(d1w.ttest_mean(</span><span class="s4">3</span><span class="s1">)[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">stats.ttest_1samp(x1r</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_weightstats_3(self):</span>
        <span class="s1">x1_2d</span><span class="s2">, </span><span class="s1">x2_2d = self.x1_2d</span><span class="s2">, </span><span class="s1">self.x2_2d</span>
        <span class="s1">w1</span><span class="s2">, </span><span class="s1">w2 = self.w1</span><span class="s2">, </span><span class="s1">self.w2</span>

        <span class="s1">d1w_2d = DescrStatsW(x1_2d</span><span class="s2">, </span><span class="s1">weights=w1)</span>
        <span class="s1">d2w_2d = DescrStatsW(x2_2d</span><span class="s2">, </span><span class="s1">weights=w2)</span>
        <span class="s1">x1r_2d = d1w_2d.asrepeats()</span>
        <span class="s1">x2r_2d = d2w_2d.asrepeats()</span>

        <span class="s1">assert_almost_equal(x2r_2d.mean(</span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w_2d.mean</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x2r_2d.var(</span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w_2d.var</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x2r_2d.std(</span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w_2d.std</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(np.cov(x2r_2d.T</span><span class="s2">, </span><span class="s1">bias=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d2w_2d.cov</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(np.corrcoef(x2r_2d.T)</span><span class="s2">, </span><span class="s1">d2w_2d.corrcoef</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s3">#        print d1w_2d.ttest_mean(3)</span>
        <span class="s3">#        #scipy.stats.ttest is also vectorized</span>
        <span class="s3">#        print stats.ttest_1samp(x1r_2d, 3)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">d = d1w_2d.ttest_mean(</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal([t</span><span class="s2">, </span><span class="s1">p]</span><span class="s2">, </span><span class="s1">stats.ttest_1samp(x1r_2d</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)</span>
        <span class="s3"># print [stats.ttest_1samp(xi, 3) for xi in x1r_2d.T]</span>
        <span class="s1">cm = CompareMeans(d1w_2d</span><span class="s2">, </span><span class="s1">d2w_2d)</span>
        <span class="s1">ressm = cm.ttest_ind()</span>
        <span class="s1">resss = stats.ttest_ind(x1r_2d</span><span class="s2">, </span><span class="s1">x2r_2d)</span>
        <span class="s1">assert_almost_equal(ressm[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">resss</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

<span class="s3">#        does not work for 2d, levene does not use weights</span>
<span class="s3">#        cm = CompareMeans(d1w_2d, d2w_2d)</span>
<span class="s3">#        ressm = cm.test_equal_var()</span>
<span class="s3">#        resss = stats.levene(x1r_2d, x2r_2d)</span>
<span class="s3">#        assert_almost_equal(ressm[:2], resss, 14)</span>

    <span class="s2">def </span><span class="s1">test_weightstats_ddof_tests(self):</span>
        <span class="s3"># explicit test that ttest and confint are independent of ddof</span>
        <span class="s3"># one sample case</span>
        <span class="s1">x1_2d = self.x1_2d</span>
        <span class="s1">w1 = self.w1</span>

        <span class="s1">d1w_d0 = DescrStatsW(x1_2d</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">d1w_d1 = DescrStatsW(x1_2d</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">d1w_d2 = DescrStatsW(x1_2d</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">2</span><span class="s1">)</span>

        <span class="s3"># check confint independent of user ddof</span>
        <span class="s1">res0 = d1w_d0.ttest_mean()</span>
        <span class="s1">res1 = d1w_d1.ttest_mean()</span>
        <span class="s1">res2 = d1w_d2.ttest_mean()</span>
        <span class="s3"># concatenate into one array with np.r_</span>
        <span class="s1">assert_almost_equal(np.r_[res1]</span><span class="s2">, </span><span class="s1">np.r_[res0]</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(np.r_[res2]</span><span class="s2">, </span><span class="s1">np.r_[res0]</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s1">res0 = d1w_d0.ttest_mean(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">res1 = d1w_d1.ttest_mean(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">res2 = d1w_d2.ttest_mean(</span><span class="s4">0.5</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(np.r_[res1]</span><span class="s2">, </span><span class="s1">np.r_[res0]</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(np.r_[res2]</span><span class="s2">, </span><span class="s1">np.r_[res0]</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s3"># check confint independent of user ddof</span>
        <span class="s1">res0 = d1w_d0.tconfint_mean()</span>
        <span class="s1">res1 = d1w_d1.tconfint_mean()</span>
        <span class="s1">res2 = d1w_d2.tconfint_mean()</span>
        <span class="s1">assert_almost_equal(res1</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res2</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_comparemeans_convenient_interface(self):</span>
        <span class="s1">x1_2d</span><span class="s2">, </span><span class="s1">x2_2d = self.x1_2d</span><span class="s2">, </span><span class="s1">self.x2_2d</span>
        <span class="s1">d1 = DescrStatsW(x1_2d)</span>
        <span class="s1">d2 = DescrStatsW(x2_2d)</span>
        <span class="s1">cm1 = CompareMeans(d1</span><span class="s2">, </span><span class="s1">d2)</span>

        <span class="s3"># smoke test for summary</span>
        <span class="s2">from </span><span class="s1">statsmodels.iolib.table </span><span class="s2">import </span><span class="s1">SimpleTable</span>
        <span class="s2">for </span><span class="s1">use_t </span><span class="s2">in </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">]:</span>
            <span class="s2">for </span><span class="s1">usevar </span><span class="s2">in </span><span class="s1">[</span><span class="s5">'pooled'</span><span class="s2">, </span><span class="s5">'unequal'</span><span class="s1">]:</span>
                <span class="s1">smry = cm1.summary(use_t=use_t</span><span class="s2">, </span><span class="s1">usevar=usevar)</span>
                <span class="s1">assert_(isinstance(smry</span><span class="s2">, </span><span class="s1">SimpleTable))</span>

        <span class="s3"># test for from_data method</span>
        <span class="s1">cm2 = CompareMeans.from_data(x1_2d</span><span class="s2">, </span><span class="s1">x2_2d)</span>
        <span class="s1">assert_(str(cm1.summary()) == str(cm2.summary()))</span>

    <span class="s2">def </span><span class="s1">test_comparemeans_convenient_interface_1d(self):</span>
        <span class="s3"># same as above for 2d, just use 1d data instead</span>
        <span class="s1">x1_2d</span><span class="s2">, </span><span class="s1">x2_2d = self.x1</span><span class="s2">, </span><span class="s1">self.x2</span>
        <span class="s1">d1 = DescrStatsW(x1_2d)</span>
        <span class="s1">d2 = DescrStatsW(x2_2d)</span>
        <span class="s1">cm1 = CompareMeans(d1</span><span class="s2">, </span><span class="s1">d2)</span>

        <span class="s3"># smoke test for summary</span>
        <span class="s2">from </span><span class="s1">statsmodels.iolib.table </span><span class="s2">import </span><span class="s1">SimpleTable</span>
        <span class="s2">for </span><span class="s1">use_t </span><span class="s2">in </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">]:</span>
            <span class="s2">for </span><span class="s1">usevar </span><span class="s2">in </span><span class="s1">[</span><span class="s5">'pooled'</span><span class="s2">, </span><span class="s5">'unequal'</span><span class="s1">]:</span>
                <span class="s1">smry = cm1.summary(use_t=use_t</span><span class="s2">, </span><span class="s1">usevar=usevar)</span>
                <span class="s1">assert_(isinstance(smry</span><span class="s2">, </span><span class="s1">SimpleTable))</span>

        <span class="s3"># test for from_data method</span>
        <span class="s1">cm2 = CompareMeans.from_data(x1_2d</span><span class="s2">, </span><span class="s1">x2_2d)</span>
        <span class="s1">assert_(str(cm1.summary()) == str(cm2.summary()))</span>


<span class="s2">class </span><span class="s1">CheckWeightstats1dMixin:</span>

    <span class="s2">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">x1r = self.x1r</span>
        <span class="s1">d1w = self.d1w</span>

        <span class="s1">assert_almost_equal(x1r.mean(</span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">d1w.mean</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x1r.var(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ddof=d1w.ddof)</span><span class="s2">, </span><span class="s1">d1w.var</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x1r.std(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ddof=d1w.ddof)</span><span class="s2">, </span><span class="s1">d1w.std</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">var1 = d1w.var_ddof(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x1r.var(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">var1</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">std1 = d1w.std_ddof(ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(x1r.std(</span><span class="s4">0</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">std1</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s1">assert_almost_equal(np.cov(x1r.T</span><span class="s2">, </span><span class="s1">bias=</span><span class="s4">1</span><span class="s1">-d1w.ddof)</span><span class="s2">, </span><span class="s1">d1w.cov</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s3"># assert_almost_equal(np.corrcoef(x1r.T), d1w.corrcoef, 14)</span>

    <span class="s2">def </span><span class="s1">test_ttest(self):</span>
        <span class="s1">x1r = self.x1r</span>
        <span class="s1">d1w = self.d1w</span>
        <span class="s1">assert_almost_equal(d1w.ttest_mean(</span><span class="s4">3</span><span class="s1">)[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">stats.ttest_1samp(x1r</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span><span class="s2">, </span><span class="s4">11</span><span class="s1">)</span>

<span class="s3">#    def</span>
<span class="s3">#        assert_almost_equal(ttest_ind(x1, x2, weights=(w1, w2))[:2],</span>
<span class="s3">#                            stats.ttest_ind(x1r, x2r), 14)</span>

    <span class="s2">def </span><span class="s1">test_ttest_2sample(self):</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 = self.x1</span><span class="s2">, </span><span class="s1">self.x2</span>
        <span class="s1">x1r</span><span class="s2">, </span><span class="s1">x2r = self.x1r</span><span class="s2">, </span><span class="s1">self.x2r</span>
        <span class="s1">w1</span><span class="s2">, </span><span class="s1">w2 = self.w1</span><span class="s2">, </span><span class="s1">self.w2</span>

        <span class="s3"># Note: stats.ttest_ind handles 2d/nd arguments</span>
        <span class="s1">res_sp = stats.ttest_ind(x1r</span><span class="s2">, </span><span class="s1">x2r)</span>
        <span class="s1">assert_almost_equal(ttest_ind(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">weights=(w1</span><span class="s2">, </span><span class="s1">w2))[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">,</span>
                            <span class="s1">res_sp</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s3"># check correct ttest independent of user ddof</span>
        <span class="s1">cm = CompareMeans(DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                          <span class="s1">DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(cm.ttest_ind()[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res_sp</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s1">cm = CompareMeans(DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">,</span>
                          <span class="s1">DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">assert_almost_equal(cm.ttest_ind()[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res_sp</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s1">cm0 = CompareMeans(DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                           <span class="s1">DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">))</span>
        <span class="s1">cm1 = CompareMeans(DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                           <span class="s1">DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">cm2 = CompareMeans(DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span><span class="s2">,</span>
                           <span class="s1">DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">2</span><span class="s1">))</span>

        <span class="s1">res0 = cm0.ttest_ind(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">res1 = cm1.ttest_ind(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">res2 = cm2.ttest_ind(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res1</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res2</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s3"># check confint independent of user ddof</span>
        <span class="s1">res0 = cm0.tconfint_diff(usevar=</span><span class="s5">'pooled'</span><span class="s1">)</span>
        <span class="s1">res1 = cm1.tconfint_diff(usevar=</span><span class="s5">'pooled'</span><span class="s1">)</span>
        <span class="s1">res2 = cm2.tconfint_diff(usevar=</span><span class="s5">'pooled'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res1</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res2</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

        <span class="s1">res0 = cm0.tconfint_diff(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">res1 = cm1.tconfint_diff(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">res2 = cm2.tconfint_diff(usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res1</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>
        <span class="s1">assert_almost_equal(res2</span><span class="s2">, </span><span class="s1">res0</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_confint_mean(self):</span>
        <span class="s3"># compare confint_mean with ttest</span>
        <span class="s1">d1w = self.d1w</span>
        <span class="s1">alpha = </span><span class="s4">0.05</span>
        <span class="s1">low</span><span class="s2">, </span><span class="s1">upp = d1w.tconfint_mean()</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">d = d1w.ttest_mean(low)</span>
        <span class="s1">assert_almost_equal(p</span><span class="s2">, </span><span class="s1">alpha * np.ones(p.shape)</span><span class="s2">, </span><span class="s4">8</span><span class="s1">)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">d = d1w.ttest_mean(upp)</span>
        <span class="s1">assert_almost_equal(p</span><span class="s2">, </span><span class="s1">alpha * np.ones(p.shape)</span><span class="s2">, </span><span class="s4">8</span><span class="s1">)</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">d = d1w.ttest_mean(np.vstack((low</span><span class="s2">, </span><span class="s1">upp)))</span>
        <span class="s1">assert_almost_equal(p</span><span class="s2">, </span><span class="s1">alpha * np.ones(p.shape)</span><span class="s2">, </span><span class="s4">8</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">CheckWeightstats2dMixin(CheckWeightstats1dMixin):</span>

    <span class="s2">def </span><span class="s1">test_corr(self):</span>
        <span class="s1">x1r = self.x1r</span>
        <span class="s1">d1w = self.d1w</span>

        <span class="s1">assert_almost_equal(np.corrcoef(x1r.T)</span><span class="s2">, </span><span class="s1">d1w.corrcoef</span><span class="s2">, </span><span class="s4">14</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">TestWeightstats1d_ddof(CheckWeightstats1dMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 = </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span>
        <span class="s1">m1</span><span class="s2">, </span><span class="s1">m2 = </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span>
        <span class="s1">x1 = m1 + np.random.randn(n1</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">x2 = m2 + np.random.randn(n2</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">w1 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n1)</span>
        <span class="s1">w2 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n2)</span>

        <span class="s1">cls.x1</span><span class="s2">, </span><span class="s1">cls.x2 = x1</span><span class="s2">, </span><span class="s1">x2</span>
        <span class="s1">cls.w1</span><span class="s2">, </span><span class="s1">cls.w2 = w1</span><span class="s2">, </span><span class="s1">w2</span>
        <span class="s1">cls.d1w = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">cls.d2w = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">cls.x1r = cls.d1w.asrepeats()</span>
        <span class="s1">cls.x2r = cls.d2w.asrepeats()</span>


<span class="s2">class </span><span class="s1">TestWeightstats2d(CheckWeightstats2dMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 = </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span>
        <span class="s1">m1</span><span class="s2">, </span><span class="s1">m2 = </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span>
        <span class="s1">x1 = m1 + np.random.randn(n1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">x2 = m2 + np.random.randn(n2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">w1 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n1)</span>
        <span class="s1">w2 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n2)</span>
        <span class="s1">cls.x1</span><span class="s2">, </span><span class="s1">cls.x2 = x1</span><span class="s2">, </span><span class="s1">x2</span>
        <span class="s1">cls.w1</span><span class="s2">, </span><span class="s1">cls.w2 = w1</span><span class="s2">, </span><span class="s1">w2</span>

        <span class="s1">cls.d1w = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1)</span>
        <span class="s1">cls.d2w = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2)</span>
        <span class="s1">cls.x1r = cls.d1w.asrepeats()</span>
        <span class="s1">cls.x2r = cls.d2w.asrepeats()</span>


<span class="s2">class </span><span class="s1">TestWeightstats2d_ddof(CheckWeightstats2dMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 = </span><span class="s4">20</span><span class="s2">, </span><span class="s4">20</span>
        <span class="s1">m1</span><span class="s2">, </span><span class="s1">m2 = </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span>
        <span class="s1">x1 = m1 + np.random.randn(n1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">x2 = m2 + np.random.randn(n2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">w1 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n1)</span>
        <span class="s1">w2 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n2)</span>

        <span class="s1">cls.x1</span><span class="s2">, </span><span class="s1">cls.x2 = x1</span><span class="s2">, </span><span class="s1">x2</span>
        <span class="s1">cls.w1</span><span class="s2">, </span><span class="s1">cls.w2 = w1</span><span class="s2">, </span><span class="s1">w2</span>
        <span class="s1">cls.d1w = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">cls.d2w = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">cls.x1r = cls.d1w.asrepeats()</span>
        <span class="s1">cls.x2r = cls.d2w.asrepeats()</span>


<span class="s2">class </span><span class="s1">TestWeightstats2d_nobs(CheckWeightstats2dMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s4">9876789</span><span class="s1">)</span>
        <span class="s1">n1</span><span class="s2">, </span><span class="s1">n2 = </span><span class="s4">20</span><span class="s2">, </span><span class="s4">30</span>
        <span class="s1">m1</span><span class="s2">, </span><span class="s1">m2 = </span><span class="s4">1</span><span class="s2">, </span><span class="s4">1.2</span>
        <span class="s1">x1 = m1 + np.random.randn(n1</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">x2 = m2 + np.random.randn(n2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">w1 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n1)</span>
        <span class="s1">w2 = np.random.randint(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s1">n2)</span>

        <span class="s1">cls.x1</span><span class="s2">, </span><span class="s1">cls.x2 = x1</span><span class="s2">, </span><span class="s1">x2</span>
        <span class="s1">cls.w1</span><span class="s2">, </span><span class="s1">cls.w2 = w1</span><span class="s2">, </span><span class="s1">w2</span>
        <span class="s1">cls.d1w = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">weights=w1</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">cls.d2w = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">weights=w2</span><span class="s2">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">cls.x1r = cls.d1w.asrepeats()</span>
        <span class="s1">cls.x2r = cls.d2w.asrepeats()</span>


<span class="s2">def </span><span class="s1">test_ttest_ind_with_uneq_var():</span>

    <span class="s3"># from scipy</span>
    <span class="s3"># check vs. R</span>
    <span class="s1">a = (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">b = (</span><span class="s4">1.1</span><span class="s2">, </span><span class="s4">2.9</span><span class="s2">, </span><span class="s4">4.2</span><span class="s1">)</span>
    <span class="s1">pr = </span><span class="s4">0.53619490753126731</span>
    <span class="s1">tr = -</span><span class="s4">0.68649512735572582</span>
    <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">df = ttest_ind(a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([t</span><span class="s2">, </span><span class="s1">p]</span><span class="s2">, </span><span class="s1">[tr</span><span class="s2">, </span><span class="s1">pr]</span><span class="s2">, </span><span class="s4">13</span><span class="s1">)</span>

    <span class="s1">a = (</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">pr = </span><span class="s4">0.84354139131608286</span>
    <span class="s1">tr = -</span><span class="s4">0.2108663315950719</span>
    <span class="s1">t</span><span class="s2">, </span><span class="s1">p</span><span class="s2">, </span><span class="s1">df = ttest_ind(a</span><span class="s2">, </span><span class="s1">b</span><span class="s2">, </span><span class="s1">usevar=</span><span class="s5">'unequal'</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([t</span><span class="s2">, </span><span class="s1">p]</span><span class="s2">, </span><span class="s1">[tr</span><span class="s2">, </span><span class="s1">pr]</span><span class="s2">, </span><span class="s4">13</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_ztest_ztost():</span>
    <span class="s3"># compare weightstats with separately tested proportion ztest ztost</span>
    <span class="s2">import </span><span class="s1">statsmodels.stats.proportion </span><span class="s2">as </span><span class="s1">smprop</span>

    <span class="s1">x1 = [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">w1 = [</span><span class="s4">5</span><span class="s2">, </span><span class="s4">15</span><span class="s1">]</span>

    <span class="s1">res2 = smprop.proportions_ztest(</span><span class="s4">15</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s1">value=</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">d1 = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">w1)</span>
    <span class="s1">res1 = d1.ztest_mean(</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">0.03</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">0.003</span><span class="s1">)</span>

    <span class="s1">d2 = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">np.array(w1)*</span><span class="s4">21.</span><span class="s1">/</span><span class="s4">20</span><span class="s1">)</span>
    <span class="s1">res1 = d2.ztest_mean(</span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s4">12</span><span class="s1">)</span>

    <span class="s1">res1 = d2.ztost_mean(</span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.6</span><span class="s1">)</span>
    <span class="s1">res2 = smprop.proportions_ztost(</span><span class="s4">15</span><span class="s2">, </span><span class="s4">20.</span><span class="s2">, </span><span class="s4">0.4</span><span class="s2">, </span><span class="s4">0.6</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res1[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s4">12</span><span class="s1">)</span>

    <span class="s1">x2 = [</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">w2 = [</span><span class="s4">10</span><span class="s2">, </span><span class="s4">10</span><span class="s1">]</span>
    <span class="s3"># d2 = DescrStatsW(x1, np.array(w1)*21./20)</span>
    <span class="s1">d2 = DescrStatsW(x2</span><span class="s2">, </span><span class="s1">w2)</span>
    <span class="s1">res1 = ztest(d1.asrepeats()</span><span class="s2">, </span><span class="s1">d2.asrepeats())</span>
    <span class="s1">res2 = smprop.proportions_chisquare(np.asarray([</span><span class="s4">15</span><span class="s2">, </span><span class="s4">10</span><span class="s1">])</span><span class="s2">,</span>
                                        <span class="s1">np.asarray([</span><span class="s4">20.</span><span class="s2">, </span><span class="s4">20</span><span class="s1">]))</span>
    <span class="s3"># TODO: check this is this difference expected?, see test_proportion</span>
    <span class="s1">assert_allclose(res1[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">0.03</span><span class="s1">)</span>

    <span class="s1">res1a = CompareMeans(d1</span><span class="s2">, </span><span class="s1">d2).ztest_ind()</span>
    <span class="s1">assert_allclose(res1a[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">0.03</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(res1a</span><span class="s2">, </span><span class="s1">res1</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s4">12</span><span class="s1">)</span>


<span class="s3"># test for ztest and z confidence interval against R BSDA z.test</span>
<span class="s3"># Note: I needed to calculate the pooled standard deviation for R</span>
<span class="s3">#       std = np.std(np.concatenate((x-x.mean(),y-y.mean())), ddof=2)</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y, sigma.y=0.57676142668828667)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest.&quot;)</span>
<span class="s1">ztest_ = Holder()</span>
<span class="s1">ztest_.statistic = </span><span class="s4">6.55109865675183</span>
<span class="s1">ztest_.p_value = </span><span class="s4">5.711530850508982e-11</span>
<span class="s1">ztest_.conf_int = np.array([</span><span class="s4">1.230415246535603</span><span class="s2">, </span><span class="s4">2.280948389828034</span><span class="s1">])</span>
<span class="s1">ztest_.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_.null_value = </span><span class="s4">0</span>
<span class="s1">ztest_.alternative = </span><span class="s5">'two.sided'</span>
<span class="s1">ztest_.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_.data_name = </span><span class="s5">'x and y'</span>
<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y,</span>
<span class="s3">#               sigma.y=0.57676142668828667, alternative=&quot;less&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_smaller.&quot;)</span>
<span class="s1">ztest_smaller = Holder()</span>
<span class="s1">ztest_smaller.statistic = </span><span class="s4">6.55109865675183</span>
<span class="s1">ztest_smaller.p_value = </span><span class="s4">0.999999999971442</span>
<span class="s1">ztest_smaller.conf_int = np.array([np.nan</span><span class="s2">, </span><span class="s4">2.196499421109045</span><span class="s1">])</span>
<span class="s1">ztest_smaller.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_smaller.null_value = </span><span class="s4">0</span>
<span class="s1">ztest_smaller.alternative = </span><span class="s5">'less'</span>
<span class="s1">ztest_smaller.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_smaller.data_name = </span><span class="s5">'x and y'</span>
<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y,</span>
<span class="s3">#               sigma.y=0.57676142668828667, alternative=&quot;greater&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_larger.&quot;)</span>
<span class="s1">ztest_larger = Holder()</span>
<span class="s1">ztest_larger.statistic = </span><span class="s4">6.55109865675183</span>
<span class="s1">ztest_larger.p_value = </span><span class="s4">2.855760072861813e-11</span>
<span class="s1">ztest_larger.conf_int = np.array([</span><span class="s4">1.314864215254592</span><span class="s2">, </span><span class="s1">np.nan])</span>
<span class="s1">ztest_larger.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_larger.null_value = </span><span class="s4">0</span>
<span class="s1">ztest_larger.alternative = </span><span class="s5">'greater'</span>
<span class="s1">ztest_larger.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_larger.data_name = </span><span class="s5">'x and y'</span>


<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y,</span>
<span class="s3">#               sigma.y=0.57676142668828667, mu=1, alternative=&quot;two.sided&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_mu.&quot;)</span>
<span class="s1">ztest_mu = Holder()</span>
<span class="s1">ztest_mu.statistic = </span><span class="s4">2.81972854805176</span>
<span class="s1">ztest_mu.p_value = </span><span class="s4">0.00480642898427981</span>
<span class="s1">ztest_mu.conf_int = np.array([</span><span class="s4">1.230415246535603</span><span class="s2">, </span><span class="s4">2.280948389828034</span><span class="s1">])</span>
<span class="s1">ztest_mu.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_mu.null_value = </span><span class="s4">1</span>
<span class="s1">ztest_mu.alternative = </span><span class="s5">'two.sided'</span>
<span class="s1">ztest_mu.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_mu.data_name = </span><span class="s5">'x and y'</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y,</span>
<span class="s3">#               sigma.y=0.57676142668828667, mu=1, alternative=&quot;greater&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_larger_mu.&quot;)</span>
<span class="s1">ztest_larger_mu = Holder()</span>
<span class="s1">ztest_larger_mu.statistic = </span><span class="s4">2.81972854805176</span>
<span class="s1">ztest_larger_mu.p_value = </span><span class="s4">0.002403214492139871</span>
<span class="s1">ztest_larger_mu.conf_int = np.array([</span><span class="s4">1.314864215254592</span><span class="s2">, </span><span class="s1">np.nan])</span>
<span class="s1">ztest_larger_mu.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_larger_mu.null_value = </span><span class="s4">1</span>
<span class="s1">ztest_larger_mu.alternative = </span><span class="s5">'greater'</span>
<span class="s1">ztest_larger_mu.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_larger_mu.data_name = </span><span class="s5">'x and y'</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.57676142668828667, y,</span>
<span class="s3">#               sigma.y=0.57676142668828667, mu=2, alternative=&quot;less&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_smaller_mu.&quot;)</span>
<span class="s1">ztest_smaller_mu = Holder()</span>
<span class="s1">ztest_smaller_mu.statistic = -</span><span class="s4">0.911641560648313</span>
<span class="s1">ztest_smaller_mu.p_value = </span><span class="s4">0.1809787183191324</span>
<span class="s1">ztest_smaller_mu.conf_int = np.array([np.nan</span><span class="s2">, </span><span class="s4">2.196499421109045</span><span class="s1">])</span>
<span class="s1">ztest_smaller_mu.estimate = np.array([</span><span class="s4">7.01818181818182</span><span class="s2">, </span><span class="s4">5.2625</span><span class="s1">])</span>
<span class="s1">ztest_smaller_mu.null_value = </span><span class="s4">2</span>
<span class="s1">ztest_smaller_mu.alternative = </span><span class="s5">'less'</span>
<span class="s1">ztest_smaller_mu.method = </span><span class="s5">'Two-sample z-Test'</span>
<span class="s1">ztest_smaller_mu.data_name = </span><span class="s5">'x and y'</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.46436662631627995, mu=6.4,</span>
<span class="s3">#               alternative=&quot;two.sided&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_mu_1s.&quot;)</span>
<span class="s1">ztest_mu_1s = Holder()</span>
<span class="s1">ztest_mu_1s.statistic = </span><span class="s4">4.415212090914452</span>
<span class="s1">ztest_mu_1s.p_value = </span><span class="s4">1.009110038015147e-05</span>
<span class="s1">ztest_mu_1s.conf_int = np.array([</span><span class="s4">6.74376372125119</span><span class="s2">, </span><span class="s4">7.29259991511245</span><span class="s1">])</span>
<span class="s1">ztest_mu_1s.estimate = </span><span class="s4">7.01818181818182</span>
<span class="s1">ztest_mu_1s.null_value = </span><span class="s4">6.4</span>
<span class="s1">ztest_mu_1s.alternative = </span><span class="s5">'two.sided'</span>
<span class="s1">ztest_mu_1s.method = </span><span class="s5">'One-sample z-Test'</span>
<span class="s1">ztest_mu_1s.data_name = </span><span class="s5">'x'</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.46436662631627995, mu=7.4, alternative=&quot;less&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_smaller_mu_1s.&quot;)</span>
<span class="s1">ztest_smaller_mu_1s = Holder()</span>
<span class="s1">ztest_smaller_mu_1s.statistic = -</span><span class="s4">2.727042762035397</span>
<span class="s1">ztest_smaller_mu_1s.p_value = </span><span class="s4">0.00319523783881176</span>
<span class="s1">ztest_smaller_mu_1s.conf_int = np.array([np.nan</span><span class="s2">, </span><span class="s4">7.248480744895716</span><span class="s1">])</span>
<span class="s1">ztest_smaller_mu_1s.estimate = </span><span class="s4">7.01818181818182</span>
<span class="s1">ztest_smaller_mu_1s.null_value = </span><span class="s4">7.4</span>
<span class="s1">ztest_smaller_mu_1s.alternative = </span><span class="s5">'less'</span>
<span class="s1">ztest_smaller_mu_1s.method = </span><span class="s5">'One-sample z-Test'</span>
<span class="s1">ztest_smaller_mu_1s.data_name = </span><span class="s5">'x'</span>

<span class="s3"># &gt; zt = z.test(x, sigma.x=0.46436662631627995, mu=6.4, alternative=&quot;greater&quot;)</span>
<span class="s3"># &gt; cat_items(zt, &quot;ztest_greater_mu_1s.&quot;)</span>
<span class="s1">ztest_larger_mu_1s = Holder()</span>
<span class="s1">ztest_larger_mu_1s.statistic = </span><span class="s4">4.415212090914452</span>
<span class="s1">ztest_larger_mu_1s.p_value = </span><span class="s4">5.045550190097003e-06</span>
<span class="s1">ztest_larger_mu_1s.conf_int = np.array([</span><span class="s4">6.78788289146792</span><span class="s2">, </span><span class="s1">np.nan])</span>
<span class="s1">ztest_larger_mu_1s.estimate = </span><span class="s4">7.01818181818182</span>
<span class="s1">ztest_larger_mu_1s.null_value = </span><span class="s4">6.4</span>
<span class="s1">ztest_larger_mu_1s.alternative = </span><span class="s5">'greater'</span>
<span class="s1">ztest_larger_mu_1s.method = </span><span class="s5">'One-sample z-Test'</span>
<span class="s1">ztest_larger_mu_1s.data_name = </span><span class="s5">'x'</span>


<span class="s1">alternatives = {</span><span class="s5">'less'</span><span class="s1">: </span><span class="s5">'smaller'</span><span class="s2">,</span>
                <span class="s5">'greater'</span><span class="s1">: </span><span class="s5">'larger'</span><span class="s2">,</span>
                <span class="s5">'two.sided'</span><span class="s1">: </span><span class="s5">'two-sided'</span><span class="s1">}</span>


<span class="s2">class </span><span class="s1">TestZTest:</span>
    <span class="s3"># all examples use the same data</span>
    <span class="s3"># no weights used in tests</span>

    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.x1 = np.array([</span><span class="s4">7.8</span><span class="s2">, </span><span class="s4">6.6</span><span class="s2">, </span><span class="s4">6.5</span><span class="s2">, </span><span class="s4">7.4</span><span class="s2">, </span><span class="s4">7.3</span><span class="s2">, </span><span class="s4">7.</span><span class="s2">, </span><span class="s4">6.4</span><span class="s2">,</span>
                          <span class="s4">7.1</span><span class="s2">, </span><span class="s4">6.7</span><span class="s2">, </span><span class="s4">7.6</span><span class="s2">, </span><span class="s4">6.8</span><span class="s1">])</span>
        <span class="s1">cls.x2 = np.array([</span><span class="s4">4.5</span><span class="s2">, </span><span class="s4">5.4</span><span class="s2">, </span><span class="s4">6.1</span><span class="s2">, </span><span class="s4">6.1</span><span class="s2">, </span><span class="s4">5.4</span><span class="s2">, </span><span class="s4">5.</span><span class="s2">, </span><span class="s4">4.1</span><span class="s2">, </span><span class="s4">5.5</span><span class="s1">])</span>
        <span class="s1">cls.d1 = DescrStatsW(cls.x1)</span>
        <span class="s1">cls.d2 = DescrStatsW(cls.x2)</span>
        <span class="s1">cls.cm = CompareMeans(cls.d1</span><span class="s2">, </span><span class="s1">cls.d2)</span>

    <span class="s2">def </span><span class="s1">test(self):</span>
        <span class="s1">x1</span><span class="s2">, </span><span class="s1">x2 = self.x1</span><span class="s2">, </span><span class="s1">self.x2</span>
        <span class="s1">cm = self.cm</span>

        <span class="s3"># tc : test cases</span>
        <span class="s2">for </span><span class="s1">tc </span><span class="s2">in </span><span class="s1">[ztest_</span><span class="s2">, </span><span class="s1">ztest_smaller</span><span class="s2">, </span><span class="s1">ztest_larger</span><span class="s2">,</span>
                   <span class="s1">ztest_mu</span><span class="s2">, </span><span class="s1">ztest_smaller_mu</span><span class="s2">, </span><span class="s1">ztest_larger_mu]:</span>

            <span class="s1">zstat</span><span class="s2">, </span><span class="s1">pval = ztest(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">value=tc.null_value</span><span class="s2">,</span>
                                <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(zstat</span><span class="s2">, </span><span class="s1">tc.statistic</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
            <span class="s1">assert_allclose(pval</span><span class="s2">, </span><span class="s1">tc.p_value</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">1e-16</span><span class="s1">)</span>

            <span class="s1">zstat</span><span class="s2">, </span><span class="s1">pval = cm.ztest_ind(value=tc.null_value</span><span class="s2">,</span>
                                <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(zstat</span><span class="s2">, </span><span class="s1">tc.statistic</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
            <span class="s1">assert_allclose(pval</span><span class="s2">, </span><span class="s1">tc.p_value</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">1e-16</span><span class="s1">)</span>

            <span class="s3"># overwrite nan in R's confint</span>
            <span class="s1">tc_conf_int = tc.conf_int.copy()</span>
            <span class="s2">if </span><span class="s1">np.isnan(tc_conf_int[</span><span class="s4">0</span><span class="s1">]):</span>
                <span class="s1">tc_conf_int[</span><span class="s4">0</span><span class="s1">] = - np.inf</span>
            <span class="s2">if </span><span class="s1">np.isnan(tc_conf_int[</span><span class="s4">1</span><span class="s1">]):</span>
                <span class="s1">tc_conf_int[</span><span class="s4">1</span><span class="s1">] = np.inf</span>

            <span class="s3"># Note: value is shifting our confidence interval in zconfint</span>
            <span class="s1">ci = zconfint(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">value=</span><span class="s4">0</span><span class="s2">,</span>
                          <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(ci</span><span class="s2">, </span><span class="s1">tc_conf_int</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

            <span class="s1">ci = cm.zconfint_diff(alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(ci</span><span class="s2">, </span><span class="s1">tc_conf_int</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

            <span class="s1">ci = zconfint(x1</span><span class="s2">, </span><span class="s1">x2</span><span class="s2">, </span><span class="s1">value=tc.null_value</span><span class="s2">,</span>
                          <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(ci</span><span class="s2">, </span><span class="s1">tc_conf_int - tc.null_value</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

        <span class="s3"># 1 sample test copy-paste</span>
        <span class="s1">d1 = self.d1</span>
        <span class="s2">for </span><span class="s1">tc </span><span class="s2">in </span><span class="s1">[ztest_mu_1s</span><span class="s2">, </span><span class="s1">ztest_smaller_mu_1s</span><span class="s2">, </span><span class="s1">ztest_larger_mu_1s]:</span>
            <span class="s1">zstat</span><span class="s2">, </span><span class="s1">pval = ztest(x1</span><span class="s2">, </span><span class="s1">value=tc.null_value</span><span class="s2">,</span>
                                <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(zstat</span><span class="s2">, </span><span class="s1">tc.statistic</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
            <span class="s1">assert_allclose(pval</span><span class="s2">, </span><span class="s1">tc.p_value</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">1e-16</span><span class="s1">)</span>

            <span class="s1">zstat</span><span class="s2">, </span><span class="s1">pval = d1.ztest_mean(value=tc.null_value</span><span class="s2">,</span>
                                 <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(zstat</span><span class="s2">, </span><span class="s1">tc.statistic</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
            <span class="s1">assert_allclose(pval</span><span class="s2">, </span><span class="s1">tc.p_value</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">1e-16</span><span class="s1">)</span>

            <span class="s3"># overwrite nan in R's confint</span>
            <span class="s1">tc_conf_int = tc.conf_int.copy()</span>
            <span class="s2">if </span><span class="s1">np.isnan(tc_conf_int[</span><span class="s4">0</span><span class="s1">]):</span>
                <span class="s1">tc_conf_int[</span><span class="s4">0</span><span class="s1">] = - np.inf</span>
            <span class="s2">if </span><span class="s1">np.isnan(tc_conf_int[</span><span class="s4">1</span><span class="s1">]):</span>
                <span class="s1">tc_conf_int[</span><span class="s4">1</span><span class="s1">] = np.inf</span>

            <span class="s3"># Note: value is shifting our confidence interval in zconfint</span>
            <span class="s1">ci = zconfint(x1</span><span class="s2">, </span><span class="s1">value=</span><span class="s4">0</span><span class="s2">,</span>
                          <span class="s1">alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(ci</span><span class="s2">, </span><span class="s1">tc_conf_int</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>

            <span class="s1">ci = d1.zconfint_mean(alternative=alternatives[tc.alternative])</span>
            <span class="s1">assert_allclose(ci</span><span class="s2">, </span><span class="s1">tc_conf_int</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_weightstats_len_1():</span>
    <span class="s1">x1 = [</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">w1 = [</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">d1 = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">w1)</span>
    <span class="s2">assert </span><span class="s1">(d1.quantile([</span><span class="s4">0.0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">]) == </span><span class="s4">1</span><span class="s1">).all()</span>


<span class="s2">def </span><span class="s1">test_weightstats_2d_w1():</span>
    <span class="s1">x1 = [[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]</span>
    <span class="s1">w1 = [[</span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">]]</span>
    <span class="s1">d1 = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">w1)</span>
    <span class="s1">print(len(np.array(w1).shape))</span>
    <span class="s2">assert </span><span class="s1">(d1.quantile([</span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">]) == </span><span class="s4">2</span><span class="s1">).all().all()</span>


<span class="s2">def </span><span class="s1">test_weightstats_2d_w2():</span>
    <span class="s1">x1 = [[</span><span class="s4">1</span><span class="s1">]]</span>
    <span class="s1">w1 = [[</span><span class="s4">1</span><span class="s1">]]</span>
    <span class="s1">d1 = DescrStatsW(x1</span><span class="s2">, </span><span class="s1">w1)</span>
    <span class="s2">assert </span><span class="s1">(d1.quantile([</span><span class="s4">0</span><span class="s2">, </span><span class="s4">0.5</span><span class="s2">, </span><span class="s4">1.0</span><span class="s1">]) == </span><span class="s4">1</span><span class="s1">).all().all()</span>
</pre>
</body>
</html>