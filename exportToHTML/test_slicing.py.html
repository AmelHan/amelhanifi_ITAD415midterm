<html>
<head>
<title>test_slicing.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_slicing.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">tlz </span><span class="s0">import </span><span class="s1">merge</span>

<span class="s1">np = pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask </span><span class="s0">import </span><span class="s1">config</span>
<span class="s0">from </span><span class="s1">dask.array.chunk </span><span class="s0">import </span><span class="s1">getitem</span>
<span class="s0">from </span><span class="s1">dask.array.slicing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_sanitize_index_element</span><span class="s0">,</span>
    <span class="s1">_slice_1d</span><span class="s0">,</span>
    <span class="s1">make_block_sorted_slices</span><span class="s0">,</span>
    <span class="s1">new_blockdim</span><span class="s0">,</span>
    <span class="s1">normalize_index</span><span class="s0">,</span>
    <span class="s1">sanitize_index</span><span class="s0">,</span>
    <span class="s1">shuffle_slice</span><span class="s0">,</span>
    <span class="s1">slice_array</span><span class="s0">,</span>
    <span class="s1">slicing_plan</span><span class="s0">,</span>
    <span class="s1">take</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">same_keys</span>


<span class="s0">def </span><span class="s1">test_slice_1d():</span>
    <span class="s1">expected = {</span><span class="s3">0</span><span class="s1">: slice(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">25</span><span class="s1">] * </span><span class="s3">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[100:12:-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[102::-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">102</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[::-4]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[::-7]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x=range(115)</span>
    <span class="s4"># x[::-7]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">7</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">115</span><span class="s0">, </span><span class="s1">[</span><span class="s3">23</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">7</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[79::-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s1">] * </span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">79</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[-1:-8:-1]</span>
    <span class="s1">expected = {</span><span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">8</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">92</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[20:0:-1]</span>
    <span class="s1">expected = {</span><span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">20</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">20</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[:0]</span>
    <span class="s1">expected = {}</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">result</span>

    <span class="s4"># x=range(99)</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">20</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s4"># This array has non-uniformly sized blocks</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">99</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">100</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x=range(104)</span>
    <span class="s4"># x[::-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">0</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">21</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">24</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">28</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">14</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">22</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s4"># This array has non-uniformly sized blocks</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">104</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">21</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x=range(104)</span>
    <span class="s4"># x[:27:-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">16</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">28</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">14</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">22</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s4"># This array has non-uniformly sized blocks</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">104</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">21</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, </span><span class="s3">27</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x=range(104)</span>
    <span class="s4"># x[100:27:-3]</span>
    <span class="s1">expected = {</span>
        <span class="s3">1</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">16</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">2</span><span class="s1">: slice(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">28</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">3</span><span class="s1">: slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">14</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">4</span><span class="s1">: slice(-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">22</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s4"># This array has non-uniformly sized blocks</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">104</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">21</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x=range(1000000000000)</span>
    <span class="s4"># x[1000:]</span>
    <span class="s1">expected = {</span><span class="s3">0</span><span class="s1">: slice(</span><span class="s3">1000</span><span class="s0">, </span><span class="s3">1000000000</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)}</span>
    <span class="s1">expected.update({ii: slice(</span><span class="s0">None, None, None</span><span class="s1">) </span><span class="s0">for </span><span class="s1">ii </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1000</span><span class="s1">)})</span>
    <span class="s4"># This array is large</span>
    <span class="s1">result = _slice_1d(</span><span class="s3">1000000000000</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1000000000</span><span class="s1">] * </span><span class="s3">1000</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1000</span><span class="s0">, None, None</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>


<span class="s0">def </span><span class="s1">test_slice_singleton_value_on_boundary():</span>
    <span class="s0">assert </span><span class="s1">_slice_1d(</span><span class="s3">15</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">10</span><span class="s1">) == {</span><span class="s3">2</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">_slice_1d(</span><span class="s3">30</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">10</span><span class="s1">) == {</span><span class="s3">2</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_slice_array_1d():</span>
    <span class="s4"># x[24::2]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">25</span><span class="s1">] * </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[slice(</span><span class="s3">24</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[26::2]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">25</span><span class="s1">] * </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[slice(</span><span class="s3">26</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[24::2]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">25</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">24</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># x[26::2]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">25</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">26</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>


<span class="s0">def </span><span class="s1">test_slice_array_2d():</span>
    <span class="s4"># 2d slices: x[13::2,10::1]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">13</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">10</span><span class="s0">, None, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># 2d slices with one dimension: x[5,10::1]</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">([</span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">10</span><span class="s0">, None, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s3">8</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>


<span class="s0">def </span><span class="s1">test_slice_optimizations():</span>
    <span class="s4"># bar[:]</span>
    <span class="s1">expected = {(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)}</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">100</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>

    <span class="s4"># bar[:,:,:]</span>
    <span class="s1">expected = {(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (</span><span class="s2">&quot;bar&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;foo&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;bar&quot;</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">1000</span><span class="s0">, </span><span class="s3">10000</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">(slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">expected == result</span>


<span class="s0">def </span><span class="s1">test_slicing_with_singleton_indices():</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span>
    <span class="s1">)</span>

    <span class="s1">expected = {(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))}</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>


<span class="s0">def </span><span class="s1">test_slicing_with_newaxis():</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">,</span>
        <span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s0">assert </span><span class="s1">expected == result</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_take():</span>
    <span class="s1">chunks</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">7</span><span class="s1">])</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">np.testing.assert_equal(sorted(dsk.items())</span><span class="s0">, </span><span class="s1">sorted(expected.items()))</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks</span><span class="s0">, </span><span class="s1">dsk = take(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span>
    <span class="s1">)</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span>
            <span class="s1">getitem</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(np.array([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">7</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">7</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.array([</span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">np.testing.assert_equal(sorted(dsk.items())</span><span class="s0">, </span><span class="s1">sorted(expected.items()))</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_take_sorted():</span>
    <span class="s1">chunks</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">expected = {</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">([</span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">np.testing.assert_equal(dsk</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks</span><span class="s0">, </span><span class="s1">dsk = take(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">37</span><span class="s1">]</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span>
    <span class="s1">)</span>
    <span class="s1">expected = merge(</span>
        <span class="s1">{</span>
            <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]))</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span>
            <span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s0">None, None, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">17</span><span class="s1">]))</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">np.testing.assert_equal(dsk</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_slicing_chunks():</span>
    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">result</span><span class="s0">, </span><span class="s1">chunks = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_slicing_with_numpy_arrays():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">bd1 = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">b</span><span class="s0">, </span><span class="s1">bd2 = slice_array(</span>
        <span class="s2">&quot;y&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;x&quot;</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">itemsize=</span><span class="s3">8</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">bd1 == bd2</span>
    <span class="s1">np.testing.assert_equal(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s1">i = [</span><span class="s0">False, True, True, False, False, False, False, False, False, True</span><span class="s1">]</span>
    <span class="s1">index = (i</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, None</span><span class="s1">))</span>
    <span class="s1">index = normalize_index(index</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">c</span><span class="s0">, </span><span class="s1">bd3 = slice_array(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">bd1 == bd3</span>
    <span class="s1">np.testing.assert_equal(a</span><span class="s0">, </span><span class="s1">c)</span>


<span class="s0">def </span><span class="s1">test_slicing_and_chunks():</span>
    <span class="s1">o = da.ones((</span><span class="s3">24</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">t = o[</span><span class="s3">4</span><span class="s1">:-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">t.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_slicing_and_unknown_chunks():</span>
    <span class="s1">a = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">a._chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Array chunk size or shape is unknown&quot;</span><span class="s1">):</span>
        <span class="s1">a[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]].compute()</span>


<span class="s0">def </span><span class="s1">test_slicing_identities():</span>
    <span class="s1">a = da.ones((</span><span class="s3">24</span><span class="s0">, </span><span class="s3">16</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>

    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[slice(</span><span class="s0">None</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[:]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[::]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[...]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[</span><span class="s3">0</span><span class="s1">:]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[</span><span class="s3">0</span><span class="s1">::]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[::</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[</span><span class="s3">0 </span><span class="s1">: len(a)]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[</span><span class="s3">0</span><span class="s1">::</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">a </span><span class="s0">is </span><span class="s1">a[</span><span class="s3">0 </span><span class="s1">: len(a) : </span><span class="s3">1</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_slice_stop_0():</span>
    <span class="s4"># from gh-125</span>
    <span class="s1">a = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))[:</span><span class="s3">0</span><span class="s1">].compute()</span>
    <span class="s1">b = np.ones(</span><span class="s3">10</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s0">def </span><span class="s1">test_slice_list_then_None():</span>
    <span class="s1">x = da.zeros(shape=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">y = x[[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]][</span><span class="s0">None</span><span class="s1">]</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>


<span class="s0">class </span><span class="s1">ReturnItem:</span>
    <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">key):</span>
        <span class="s0">return </span><span class="s1">key</span>


<span class="s1">@pytest.mark.skip(reason=</span><span class="s2">&quot;really long test&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_slicing_exhaustively():</span>
    <span class="s1">x = np.random.default_rng().random(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">I = ReturnItem()</span>

    <span class="s4"># independent indexing along different axes</span>
    <span class="s1">indexers = [</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">I[:]</span><span class="s0">, </span><span class="s1">I[:</span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">I[::-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, None, </span><span class="s1">I[:</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]]</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">indexers:</span>
        <span class="s1">assert_eq(x[i]</span><span class="s0">, </span><span class="s1">a[i])</span><span class="s0">, </span><span class="s1">i</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">indexers:</span>
            <span class="s1">assert_eq(x[i][:</span><span class="s0">, </span><span class="s1">j]</span><span class="s0">, </span><span class="s1">a[i][:</span><span class="s0">, </span><span class="s1">j])</span><span class="s0">, </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">j)</span>
            <span class="s1">assert_eq(x[:</span><span class="s0">, </span><span class="s1">i][j]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">i][j])</span><span class="s0">, </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">j)</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">indexers:</span>
                <span class="s1">assert_eq(x[...</span><span class="s0">, </span><span class="s1">i][:</span><span class="s0">, </span><span class="s1">j][k]</span><span class="s0">, </span><span class="s1">a[...</span><span class="s0">, </span><span class="s1">i][:</span><span class="s0">, </span><span class="s1">j][k])</span><span class="s0">, </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k)</span>

    <span class="s4"># repeated indexing along the first axis</span>
    <span class="s1">first_indexers = [I[:]</span><span class="s0">, </span><span class="s1">I[:</span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">6</span><span class="s1">) &lt; </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s1">second_indexers = [</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">I[:]</span><span class="s0">, </span><span class="s1">I[:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">I[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">I[:</span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">first_indexers:</span>
        <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">second_indexers:</span>
            <span class="s1">assert_eq(x[i][j]</span><span class="s0">, </span><span class="s1">a[i][j])</span><span class="s0">, </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">j)</span>


<span class="s0">def </span><span class="s1">test_slicing_with_negative_step_flops_keys():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x[:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">(x.name</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) </span><span class="s0">in </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">(x.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">) </span><span class="s0">in </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">)[:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(x.name</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">6</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">y.dask[(y.name</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == (getitem</span><span class="s0">, </span><span class="s1">(x.name</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_empty_slice():</span>
    <span class="s1">x = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">y = x[:</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)[:</span><span class="s3">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_multiple_list_slicing():</span>
    <span class="s1">x = np.random.default_rng().random((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]][[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]][[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_boolean_list_slicing():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">da.asarray(range(</span><span class="s3">2</span><span class="s1">))[[</span><span class="s0">True</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">da.asarray(range(</span><span class="s3">2</span><span class="s1">))[[</span><span class="s0">False, False, False</span><span class="s1">]]</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">ind = [</span><span class="s0">True, False, False, False, True</span><span class="s1">]</span>
    <span class="s1">assert_eq(da.asarray(x)[ind]</span><span class="s0">, </span><span class="s1">x[ind])</span>
    <span class="s4"># https://github.com/dask/dask/issues/3706</span>
    <span class="s1">ind = [</span><span class="s0">True</span><span class="s1">]</span>
    <span class="s1">assert_eq(da.asarray([</span><span class="s3">0</span><span class="s1">])[ind]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">1</span><span class="s1">)[ind])</span>


<span class="s0">def </span><span class="s1">test_boolean_numpy_array_slicing():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">da.asarray(range(</span><span class="s3">2</span><span class="s1">))[np.array([</span><span class="s0">True</span><span class="s1">])]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">da.asarray(range(</span><span class="s3">2</span><span class="s1">))[np.array([</span><span class="s0">False, False, False</span><span class="s1">])]</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">ind = np.array([</span><span class="s0">True, False, False, False, True</span><span class="s1">])</span>
    <span class="s1">assert_eq(da.asarray(x)[ind]</span><span class="s0">, </span><span class="s1">x[ind])</span>
    <span class="s4"># https://github.com/dask/dask/issues/3706</span>
    <span class="s1">ind = np.array([</span><span class="s0">True</span><span class="s1">])</span>
    <span class="s1">assert_eq(da.asarray([</span><span class="s3">0</span><span class="s1">])[ind]</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">1</span><span class="s1">)[ind])</span>


<span class="s0">def </span><span class="s1">test_empty_list():</span>
    <span class="s1">x = np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(dx[[]</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[[]</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(dx[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">assert_eq(dx[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">[]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">3</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">[]])</span>


<span class="s0">def </span><span class="s1">test_uneven_chunks():</span>
    <span class="s0">assert </span><span class="s1">da.ones(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)[::</span><span class="s3">2</span><span class="s1">].chunks == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_new_blockdim():</span>
    <span class="s0">assert </span><span class="s1">new_blockdim(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)) == [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_slicing_consistent_names():</span>
    <span class="s1">x = np.arange(</span><span class="s3">100</span><span class="s1">).reshape((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[:</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">...]</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">...])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[...]</span><span class="s0">, </span><span class="s1">a[...])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">a[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[-</span><span class="s3">11</span><span class="s1">:</span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[:])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[-</span><span class="s3">11</span><span class="s1">:-</span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[:</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">9</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(a[</span><span class="s3">0</span><span class="s1">::-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">a[</span><span class="s3">0</span><span class="s1">:-</span><span class="s3">11</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_slicing_consistent_names_after_normalization():</span>
    <span class="s1">x = da.zeros(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">same_keys(x[</span><span class="s3">0</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s3">10</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(x[</span><span class="s3">0</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">10</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(x[</span><span class="s3">0</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">10</span><span class="s1">:</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">same_keys(x[:]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">10</span><span class="s1">:</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_sanitize_index_element():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">_sanitize_index_element(</span><span class="s2">&quot;Hello!&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_sanitize_index():</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">sanitize_index(</span><span class="s2">&quot;Hello!&quot;</span><span class="s1">)</span>

    <span class="s1">np.testing.assert_equal(sanitize_index(pd.Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_equal(sanitize_index((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_uneven_blockdims():</span>
    <span class="s1">blockdims = ((</span><span class="s3">31</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">100</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">index = (slice(</span><span class="s3">240</span><span class="s0">, </span><span class="s3">270</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">))</span>
    <span class="s1">dsk_out</span><span class="s0">, </span><span class="s1">bd_out = slice_array(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s1">blockdims</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">sol = {</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">dsk_out == sol</span>
    <span class="s0">assert </span><span class="s1">bd_out == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">27</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">100</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">blockdims = ((</span><span class="s3">31</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">2</span>
    <span class="s1">index = (slice(</span><span class="s3">240</span><span class="s0">, </span><span class="s3">270</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">180</span><span class="s0">, </span><span class="s3">230</span><span class="s1">))</span>
    <span class="s1">dsk_out</span><span class="s0">, </span><span class="s1">bd_out = slice_array(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s1">blockdims</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">sol = {</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">28</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;in&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (getitem</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;out&quot;</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">dsk_out == sol</span>
    <span class="s0">assert </span><span class="s1">bd_out == ((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">27</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">18</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_oob_check():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[</span><span class="s3">6</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[</span><span class="s3">6</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[-</span><span class="s3">10</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[-</span><span class="s3">10</span><span class="s1">]]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;idx_chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;x_chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array(x_chunks</span><span class="s0">, </span><span class="s1">idx_chunks):</span>
    <span class="s4"># test data is crafted to stress use cases:</span>
    <span class="s4"># - pick from different chunks of x out of order</span>
    <span class="s4"># - a chunk of x contains no matches</span>
    <span class="s4"># - only one chunk of x</span>
    <span class="s1">x = np.array(</span>
        <span class="s1">[[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">50</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">60</span><span class="s0">, </span><span class="s3">70</span><span class="s0">, </span><span class="s3">80</span><span class="s0">, </span><span class="s3">90</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">110</span><span class="s0">, </span><span class="s3">120</span><span class="s0">, </span><span class="s3">130</span><span class="s0">, </span><span class="s3">140</span><span class="s0">, </span><span class="s3">150</span><span class="s1">]]</span>
    <span class="s1">)</span>
    <span class="s1">idx = np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">expect = np.array([[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">90</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">70</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">140</span><span class="s0">, </span><span class="s3">110</span><span class="s0">, </span><span class="s3">120</span><span class="s1">]])</span>

    <span class="s0">if </span><span class="s1">x_chunks </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">x = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=x_chunks)</span>
    <span class="s0">if </span><span class="s1">idx_chunks </span><span class="s0">is not None</span><span class="s1">:</span>
        <span class="s1">idx = da.from_array(idx</span><span class="s0">, </span><span class="s1">chunks=idx_chunks)</span>

    <span class="s1">assert_eq(x[:</span><span class="s0">, </span><span class="s1">idx]</span><span class="s0">, </span><span class="s1">expect)</span>
    <span class="s1">assert_eq(x.T[idx</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">expect.T)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_0d(chunks):</span>
    <span class="s4"># Slice by 0-dimensional array</span>
    <span class="s1">x = da.from_array([[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">60</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">idx0 = da.from_array(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(x[idx0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:])</span>
    <span class="s1">assert_eq(x[:</span><span class="s0">, </span><span class="s1">idx0]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_nanchunks(chunks):</span>
    <span class="s4"># Slice by array with nan-sized chunks</span>
    <span class="s1">a = da.arange(-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">assert_eq(a[a.nonzero()]</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
    <span class="s4"># Edge case: the nan-sized chunks resolve to size 0</span>
    <span class="s1">a = da.zeros(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">assert_eq(a[a.nonzero()]</span><span class="s0">, </span><span class="s1">np.array([]))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_negindex(chunks):</span>
    <span class="s1">a = da.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">idx = da.from_array([-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(a[idx]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;chunks&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_indexerror(chunks):</span>
    <span class="s1">a = da.arange(</span><span class="s3">4</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">idx = da.from_array([</span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">a[idx].compute()</span>
    <span class="s1">idx = da.from_array([-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">a[idx].compute()</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int8&quot;</span><span class="s0">, </span><span class="s2">&quot;int16&quot;</span><span class="s0">, </span><span class="s2">&quot;int32&quot;</span><span class="s0">, </span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;uint8&quot;</span><span class="s0">, </span><span class="s2">&quot;uint16&quot;</span><span class="s0">, </span><span class="s2">&quot;uint32&quot;</span><span class="s0">, </span><span class="s2">&quot;uint64&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_dtypes(dtype):</span>
    <span class="s1">a = da.from_array([</span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">40</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">idx = da.from_array(np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]).astype(dtype)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(a[idx]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">20</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_index_with_int_dask_array_nocompute():</span>
    <span class="s5">&quot;&quot;&quot;Test that when the indices are a dask array 
    they are not accidentally computed 
    &quot;&quot;&quot;</span>

    <span class="s0">def </span><span class="s1">crash():</span>
        <span class="s0">raise </span><span class="s1">NotImplementedError()</span>

    <span class="s1">x = da.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=-</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">idx = da.Array({(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (crash</span><span class="s0">,</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.int64)</span>
    <span class="s1">result = x[idx]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">result.compute()</span>


<span class="s0">def </span><span class="s1">test_index_with_bool_dask_array():</span>
    <span class="s1">x = np.arange(</span><span class="s3">36</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">ind = np.asarray([</span><span class="s0">True, True, False, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
    <span class="s1">ind = da.from_array(ind</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">index </span><span class="s0">in </span><span class="s1">[ind</span><span class="s0">, </span><span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">ind)</span><span class="s0">, </span><span class="s1">(ind</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))]:</span>
        <span class="s1">x_index = dask.compute(index)[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">assert_eq(x[x_index]</span><span class="s0">, </span><span class="s1">d[index])</span>


<span class="s0">def </span><span class="s1">test_index_with_bool_dask_array_2():</span>
    <span class="s1">rng = np.random.default_rng()</span>
    <span class="s1">x = rng.random((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">ind = rng.random(</span><span class="s3">10</span><span class="s1">) &gt; </span><span class="s3">0.5</span>

    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">dind = da.from_array(ind</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s1">index = [slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None</span><span class="s1">)]</span>

    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(x.ndim):</span>
        <span class="s1">index2 = index[:]</span>
        <span class="s1">index2.insert(i</span><span class="s0">, </span><span class="s1">dind)</span>

        <span class="s1">index3 = index[:]</span>
        <span class="s1">index3.insert(i</span><span class="s0">, </span><span class="s1">ind)</span>

        <span class="s1">assert_eq(x[tuple(index3)]</span><span class="s0">, </span><span class="s1">d[tuple(index2)])</span>


<span class="s1">@pytest.mark.xfail</span>
<span class="s0">def </span><span class="s1">test_cull():</span>
    <span class="s1">x = da.ones(</span><span class="s3">1000</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">slc </span><span class="s0">in </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">30</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">0</span><span class="s0">, None, </span><span class="s3">100</span><span class="s1">)]:</span>
        <span class="s1">y = x[slc]</span>
        <span class="s0">assert </span><span class="s1">len(y.dask) &lt; len(x.dask)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;shape&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s1">[(Ellipsis</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">Ellipsis)</span><span class="s0">, </span><span class="s1">(Ellipsis</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">Ellipsis</span><span class="s0">, None</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_slicing_with_Nones(shape</span><span class="s0">, </span><span class="s1">index):</span>
    <span class="s1">x = np.random.default_rng().random(shape)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=shape)</span>

    <span class="s1">assert_eq(x[index]</span><span class="s0">, </span><span class="s1">d[index])</span>


<span class="s1">indexers = [Ellipsis</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">slice(-</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">]</span>


<span class="s2">&quot;&quot;&quot; 
# We comment this out because it is 4096 tests 
@pytest.mark.parametrize('a', indexers) 
@pytest.mark.parametrize('b', indexers) 
@pytest.mark.parametrize('c', indexers) 
@pytest.mark.parametrize('d', indexers) 
def test_slicing_none_int_ellipses(a, b, c, d): 
    if (a, b, c, d).count(Ellipsis) &gt; 1: 
        return 
    shape = (2,3,5,7,11) 
    x = np.arange(np.prod(shape)).reshape(shape) 
    y = da.core.asarray(x) 
 
    xx = x[a, b, c, d] 
    yy = y[a, b, c, d] 
    assert_eq(xx, yy) 
&quot;&quot;&quot;</span>


<span class="s0">def </span><span class="s1">test_slicing_integer_no_warnings():</span>
    <span class="s4"># https://github.com/dask/dask/pull/2457/</span>
    <span class="s1">X = da.random.default_rng().random(size=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">idx = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
        <span class="s1">X[idx].compute()</span>
    <span class="s0">assert not </span><span class="s1">record</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_slicing_none_int_ellipes():</span>
    <span class="s1">shape = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">x = np.arange(np.prod(shape)).reshape(shape)</span>
    <span class="s1">y = da.core.asarray(x)</span>
    <span class="s0">for </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">itertools.product(indexers</span><span class="s0">, </span><span class="s1">indexers</span><span class="s0">, </span><span class="s1">indexers</span><span class="s0">, </span><span class="s1">indexers):</span>
        <span class="s0">if </span><span class="s1">ind.count(Ellipsis) &gt; </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s0">continue</span>

        <span class="s1">assert_eq(x[ind]</span><span class="s0">, </span><span class="s1">y[ind])</span>


<span class="s0">def </span><span class="s1">test_None_overlap_int():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d = (</span><span class="s3">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, </span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, None, </span><span class="s1">Ellipsis)</span>
    <span class="s1">shape = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">x = np.arange(np.prod(shape)).reshape(shape)</span>
    <span class="s1">y = da.core.asarray(x)</span>

    <span class="s1">xx = x[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d]</span>
    <span class="s1">yy = y[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d]</span>
    <span class="s1">assert_eq(xx</span><span class="s0">, </span><span class="s1">yy)</span>


<span class="s0">def </span><span class="s1">test_negative_n_slicing():</span>
    <span class="s1">assert_eq(da.ones(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)[-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">2</span><span class="s1">)[-</span><span class="s3">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_negative_list_slicing():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_eq(dx[[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]])</span>
    <span class="s1">assert_eq(dx[[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_permit_oob_slices():</span>
    <span class="s1">x = np.arange(</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">assert_eq(x[-</span><span class="s3">102</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">dx[-</span><span class="s3">102</span><span class="s1">:])</span>
    <span class="s1">assert_eq(x[</span><span class="s3">102</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">dx[</span><span class="s3">102</span><span class="s1">:])</span>
    <span class="s1">assert_eq(x[:</span><span class="s3">102</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[:</span><span class="s3">102</span><span class="s1">])</span>
    <span class="s1">assert_eq(x[:-</span><span class="s3">102</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dx[:-</span><span class="s3">102</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_normalize_index():</span>
    <span class="s0">assert </span><span class="s1">normalize_index((Ellipsis</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)) == (slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">normalize_index(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">)) == (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">normalize_index(-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">)) == (-</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">(result</span><span class="s0">,</span><span class="s1">) = normalize_index([-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">result.tolist() == [-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">normalize_index(slice(-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">)) == (slice(-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_take_semi_sorted():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">index = np.arange(</span><span class="s3">15</span><span class="s1">) % </span><span class="s3">10</span>

    <span class="s1">y = x[index]</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;chunks,index,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">15</span><span class="s1">) % </span><span class="s3">10</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">np.arange(</span><span class="s3">20</span><span class="s1">) // </span><span class="s3">2</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) // </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) // </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">15</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">])])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_slicing_plan(chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">plan = slicing_plan(chunks</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s0">assert </span><span class="s1">len(plan) == len(expected)</span>
    <span class="s0">for </span><span class="s1">(i</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">(j</span><span class="s0">, </span><span class="s1">y) </span><span class="s0">in </span><span class="s1">zip(plan</span><span class="s0">, </span><span class="s1">expected):</span>
        <span class="s0">assert </span><span class="s1">i == j</span>
        <span class="s0">assert </span><span class="s1">len(x) == len(y)</span>
        <span class="s0">assert </span><span class="s1">(x == y).all()</span>


<span class="s0">def </span><span class="s1">test_getitem_avoids_large_chunks():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;0.1Mb&quot;</span><span class="s1">}):</span>
        <span class="s1">a = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">128 </span><span class="s1">* </span><span class="s3">128</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">128</span><span class="s0">, </span><span class="s3">128</span><span class="s1">)</span>
        <span class="s1">indexer = [</span><span class="s3">0</span><span class="s1">] + [</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">11</span>
        <span class="s1">arr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
        <span class="s1">result = arr[</span>
            <span class="s1">indexer</span>
        <span class="s1">]  </span><span class="s4"># small chunks within the chunk-size limit should NOT raise PerformanceWarning</span>
        <span class="s1">expected = a[indexer]</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s1">arr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">128</span><span class="s0">, </span><span class="s3">128</span><span class="s1">))  </span><span class="s4"># large chunks</span>
        <span class="s1">expected = a[indexer]</span>

        <span class="s4"># By default, we warn</span>
        <span class="s0">with </span><span class="s1">pytest.warns(da.PerformanceWarning):</span>
            <span class="s1">result = arr[indexer]</span>

        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
        <span class="s0">assert </span><span class="s1">result.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">128</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">128</span><span class="s0">,</span><span class="s1">))</span>

        <span class="s4"># Users can silence the warning</span>
        <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.slicing.split-large-chunks&quot;</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}):</span>
            <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
                <span class="s1">result = arr[indexer]</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
            <span class="s0">assert not </span><span class="s1">record</span>

        <span class="s4"># Users can silence the warning</span>
        <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.slicing.split-large-chunks&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
            <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
                <span class="s1">result = arr[indexer]</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
            <span class="s0">assert not </span><span class="s1">record</span>

            <span class="s0">assert </span><span class="s1">result.chunks == ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s3">12</span><span class="s0">, </span><span class="s1">(</span><span class="s3">128</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">128</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_getitem_avoids_large_chunks_missing():</span>
    <span class="s4"># We cannot apply the &quot;avoid large chunks&quot; optimization when</span>
    <span class="s4"># the chunks have unknown sizes.</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;0.1Mb&quot;</span><span class="s1">}):</span>
        <span class="s1">a = np.arange(</span><span class="s3">4 </span><span class="s1">* </span><span class="s3">500 </span><span class="s1">* </span><span class="s3">500</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">500</span><span class="s0">, </span><span class="s3">500</span><span class="s1">)</span>
        <span class="s1">arr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">500</span><span class="s0">, </span><span class="s3">500</span><span class="s1">))</span>
        <span class="s1">arr._chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">indexer = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] + [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">100 </span><span class="s1">+ [</span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">expected = a[indexer]</span>
        <span class="s1">result = arr[indexer]</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_take_avoids_large_chunks():</span>
    <span class="s4"># unit test for https://github.com/dask/dask/issues/6270</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.slicing.split-large-chunks&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
        <span class="s1">chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">itemsize = </span><span class="s3">8</span>
        <span class="s1">index = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] + [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">101 </span><span class="s1">+ [</span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">chunks2</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s0">assert </span><span class="s1">chunks2 == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">len(dsk) == </span><span class="s3">5</span>

        <span class="s1">index = np.array([</span><span class="s3">0</span><span class="s1">] * </span><span class="s3">101 </span><span class="s1">+ [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">chunks2</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s0">assert </span><span class="s1">chunks2 == ((</span><span class="s3">51</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">len(dsk) == </span><span class="s3">5</span>

        <span class="s1">index = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">] + [</span><span class="s3">3</span><span class="s1">] * </span><span class="s3">101</span><span class="s1">)</span>
        <span class="s1">chunks2</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s0">assert </span><span class="s1">chunks2 == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">len(dsk) == </span><span class="s3">5</span>

        <span class="s1">chunks = ((</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">index = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">] + [</span><span class="s3">3</span><span class="s1">] * </span><span class="s3">101</span><span class="s1">)</span>
        <span class="s1">chunks2</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">chunks2 == ((</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">len(dsk) == </span><span class="s3">5</span>


<span class="s0">def </span><span class="s1">test_take_uses_config():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.slicing.split-large-chunks&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
        <span class="s1">chunks = ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">index = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] + [</span><span class="s3">2</span><span class="s1">] * </span><span class="s3">101 </span><span class="s1">+ [</span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">itemsize = </span><span class="s3">8</span>
        <span class="s0">with </span><span class="s1">config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;10GB&quot;</span><span class="s1">}):</span>
            <span class="s1">chunks2</span><span class="s0">, </span><span class="s1">dsk = take(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">index</span><span class="s0">, </span><span class="s1">itemsize)</span>
        <span class="s0">assert </span><span class="s1">chunks2 == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">101</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">500</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">len(dsk) == </span><span class="s3">4</span>


<span class="s0">def </span><span class="s1">test_pathological_unsorted_slicing():</span>
    <span class="s1">x = da.ones(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s4"># [0, 10, 20, ... 90, 1, 11, 21, ... 91, ...]</span>
    <span class="s1">index = np.arange(</span><span class="s3">100</span><span class="s1">).reshape(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">).ravel(order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(da.PerformanceWarning) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x[index]</span>

    <span class="s0">assert </span><span class="s2">&quot;10&quot; </span><span class="s0">in </span><span class="s1">str(info.list[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s2">&quot;out-of-order&quot; </span><span class="s0">in </span><span class="s1">str(info.list[</span><span class="s3">0</span><span class="s1">])</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;params&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_setitem_with_different_chunks_preserves_shape(params):</span>
    <span class="s5">&quot;&quot;&quot;Reproducer for https://github.com/dask/dask/issues/3730. 
 
    Mutating based on an array with different chunks can cause new chunks to be 
    used.  We need to ensure those new chunk sizes are applied to the mutated 
    array, otherwise the array won't generate the correct keys. 
    &quot;&quot;&quot;</span>
    <span class="s1">array_size</span><span class="s0">, </span><span class="s1">chunk_size1</span><span class="s0">, </span><span class="s1">chunk_size2 = params</span>
    <span class="s1">x = da.zeros(array_size</span><span class="s0">, </span><span class="s1">chunks=chunk_size1)</span>
    <span class="s1">mask = da.zeros(array_size</span><span class="s0">, </span><span class="s1">chunks=chunk_size2)</span>
    <span class="s1">x[mask] = </span><span class="s3">1</span>
    <span class="s1">result = x.compute()</span>
    <span class="s0">assert </span><span class="s1">x.shape == result.shape</span>


<span class="s0">def </span><span class="s1">test_gh3579():</span>
    <span class="s1">assert_eq(np.arange(</span><span class="s3">10</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">::-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">::-</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">assert_eq(np.arange(</span><span class="s3">10</span><span class="s1">)[::-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">3</span><span class="s1">)[::-</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_make_blockwise_sorted_slice():</span>
    <span class="s1">x = da.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">index = np.array([</span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>

    <span class="s1">a</span><span class="s0">, </span><span class="s1">b = make_block_sorted_slices(index</span><span class="s0">, </span><span class="s1">x.chunks)</span>

    <span class="s1">index2 = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span>
    <span class="s1">index3 = np.array([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(a</span><span class="s0">, </span><span class="s1">index2)</span>
    <span class="s1">np.testing.assert_array_equal(b</span><span class="s0">, </span><span class="s1">index3)</span>


<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:Slicing:dask.array.core.PerformanceWarning&quot;</span><span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;size, chunks&quot;</span><span class="s0">, </span><span class="s1">[((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">50</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">37</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">((</span><span class="s3">100</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">55</span><span class="s0">,</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_shuffle_slice(size</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">x = da.random.default_rng().integers(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1000</span><span class="s0">, </span><span class="s1">size=size</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">index = np.arange(len(x))</span>
    <span class="s1">np.random.default_rng().shuffle(index)</span>

    <span class="s1">a = x[index]</span>
    <span class="s1">b = shuffle_slice(x</span><span class="s0">, </span><span class="s1">index)</span>
    <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;lock&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;asarray&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fancy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_gh4043(lock</span><span class="s0">, </span><span class="s1">asarray</span><span class="s0">, </span><span class="s1">fancy):</span>
    <span class="s1">a1 = da.from_array(np.zeros(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">asarray=asarray</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">fancy=fancy)</span>
    <span class="s1">a2 = da.from_array(np.ones(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">asarray=asarray</span><span class="s0">, </span><span class="s1">lock=lock</span><span class="s0">, </span><span class="s1">fancy=fancy)</span>
    <span class="s1">al = da.stack([a1</span><span class="s0">, </span><span class="s1">a2])</span>
    <span class="s1">assert_eq(al</span><span class="s0">, </span><span class="s1">al)</span>


<span class="s0">def </span><span class="s1">test_slice_array_3d_with_bool_numpy_array():</span>
    <span class="s4"># https://github.com/dask/dask/issues/6089</span>
    <span class="s1">array = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">mask = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)) &gt; </span><span class="s3">12</span>

    <span class="s1">actual = array[mask].compute()</span>
    <span class="s1">expected = np.arange(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">24</span><span class="s1">)</span>
    <span class="s1">assert_eq(actual</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_slice_array_null_dimension():</span>
    <span class="s1">array = da.from_array(np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)))</span>
    <span class="s1">expected = np.zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))[[</span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s1">assert_eq(array[[</span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>