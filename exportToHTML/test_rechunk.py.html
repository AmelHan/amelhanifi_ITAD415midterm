<html>
<head>
<title>test_rechunk.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_rechunk.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">np = pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>
<span class="s0">import </span><span class="s1">math</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.rechunk </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_breakpoints</span><span class="s0">,</span>
    <span class="s1">_intersect_1d</span><span class="s0">,</span>
    <span class="s1">cumdims_label</span><span class="s0">,</span>
    <span class="s1">divide_to_width</span><span class="s0">,</span>
    <span class="s1">intersect_chunks</span><span class="s0">,</span>
    <span class="s1">merge_to_number</span><span class="s0">,</span>
    <span class="s1">normalize_chunks</span><span class="s0">,</span>
    <span class="s1">old_to_new</span><span class="s0">,</span>
    <span class="s1">plan_rechunk</span><span class="s0">,</span>
    <span class="s1">rechunk</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span>
<span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">funcname</span>


<span class="s0">def </span><span class="s1">test_rechunk_internals_1():</span>
    <span class="s3">&quot;&quot;&quot;Test the cumdims_label and _breakpoints and 
    _intersect_1d internal funcs to rechunk.&quot;&quot;&quot;</span>
    <span class="s1">new = cumdims_label(((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;n&quot;</span><span class="s1">)</span>
    <span class="s1">old = cumdims_label(((</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;o&quot;</span><span class="s1">)</span>
    <span class="s1">breaks = tuple(_breakpoints(o</span><span class="s0">, </span><span class="s1">n) </span><span class="s0">for </span><span class="s1">o</span><span class="s0">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">zip(old</span><span class="s0">, </span><span class="s1">new))</span>
    <span class="s1">answer = ((</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">breaks[</span><span class="s4">0</span><span class="s1">] == answer</span>
    <span class="s1">answer2 = (</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">breaks[</span><span class="s4">1</span><span class="s1">] == answer2</span>
    <span class="s1">i1d = [_intersect_1d(b) </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">breaks]</span>
    <span class="s1">answer3 = [[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]]</span>
    <span class="s0">assert </span><span class="s1">i1d[</span><span class="s4">0</span><span class="s1">] == answer3</span>
    <span class="s1">answer4 = [</span>
        <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">i1d[</span><span class="s4">1</span><span class="s1">] == answer4</span>

    <span class="s1">new = cumdims_label(((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))</span><span class="s0">, </span><span class="s2">&quot;n&quot;</span><span class="s1">)</span>
    <span class="s1">breaks = tuple(_breakpoints(o</span><span class="s0">, </span><span class="s1">n) </span><span class="s0">for </span><span class="s1">o</span><span class="s0">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">zip(old</span><span class="s0">, </span><span class="s1">new))</span>
    <span class="s1">answer5 = (</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;o&quot;</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">breaks[</span><span class="s4">1</span><span class="s1">] == answer5</span>
    <span class="s1">i1d = [_intersect_1d(b) </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">breaks]</span>
    <span class="s1">answer6 = [</span>
        <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">i1d[</span><span class="s4">1</span><span class="s1">] == answer6</span>


<span class="s0">def </span><span class="s1">test_intersect_1():</span>
    <span class="s3">&quot;&quot;&quot;Convert 1 D chunks&quot;&quot;&quot;</span>
    <span class="s1">old = ((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">25</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">answer = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">cross = list(intersect_chunks(old_chunks=old</span><span class="s0">, </span><span class="s1">new_chunks=new))</span>
    <span class="s0">assert </span><span class="s1">answer == cross</span>


<span class="s0">def </span><span class="s1">test_intersect_2():</span>
    <span class="s3">&quot;&quot;&quot;Convert 1 D chunks&quot;&quot;&quot;</span>
    <span class="s1">old = ((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">58</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">18</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">answer = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">18</span><span class="s1">))</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">18</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">((</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">20</span><span class="s1">))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">cross = list(intersect_chunks(old_chunks=old</span><span class="s0">, </span><span class="s1">new_chunks=new))</span>
    <span class="s0">assert </span><span class="s1">answer == cross</span>


<span class="s0">def </span><span class="s1">test_rechunk_1d():</span>
    <span class="s3">&quot;&quot;&quot;Try rechunking a random 1d matrix&quot;&quot;&quot;</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">30</span><span class="s1">)</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">3</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">5</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">x2 = rechunk(x</span><span class="s0">, </span><span class="s1">chunks=new)</span>
    <span class="s0">assert </span><span class="s1">x2.chunks == new</span>
    <span class="s0">assert </span><span class="s1">np.all(x2.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_rechunk_2d():</span>
    <span class="s3">&quot;&quot;&quot;Try rechunking a random 2d matrix&quot;&quot;&quot;</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">300</span><span class="s1">).reshape((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">30</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">6</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">15</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">x2 = rechunk(x</span><span class="s0">, </span><span class="s1">chunks=new)</span>
    <span class="s0">assert </span><span class="s1">x2.chunks == new</span>
    <span class="s0">assert </span><span class="s1">np.all(x2.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_rechunk_4d():</span>
    <span class="s3">&quot;&quot;&quot;Try rechunking a random 4d matrix&quot;&quot;&quot;</span>
    <span class="s1">old = ((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10000</span><span class="s1">).reshape((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=old)</span>
    <span class="s1">new = ((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span>
    <span class="s1">x2 = rechunk(x</span><span class="s0">, </span><span class="s1">chunks=new)</span>
    <span class="s0">assert </span><span class="s1">x2.chunks == new</span>
    <span class="s0">assert </span><span class="s1">np.all(x2.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_rechunk_expand():</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">100</span><span class="s1">).reshape((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(chunks=((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">np.all(y.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_rechunk_expand2():</span>
    <span class="s1">(a</span><span class="s0">, </span><span class="s1">b) = (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">orig = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">a**b).reshape((a</span><span class="s0">,</span><span class="s1">) * b)</span>
    <span class="s0">for </span><span class="s1">off</span><span class="s0">, </span><span class="s1">off2 </span><span class="s0">in </span><span class="s1">product(range(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">a - </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">a - </span><span class="s4">1</span><span class="s1">)):</span>
        <span class="s1">old = ((a - off</span><span class="s0">, </span><span class="s1">off)</span><span class="s0">,</span><span class="s1">) * b</span>
        <span class="s1">x = da.from_array(orig</span><span class="s0">, </span><span class="s1">chunks=old)</span>
        <span class="s1">new = ((a - off2</span><span class="s0">, </span><span class="s1">off2)</span><span class="s0">,</span><span class="s1">) * b</span>
        <span class="s0">assert </span><span class="s1">np.all(x.rechunk(chunks=new).compute() == orig)</span>
        <span class="s0">if </span><span class="s1">a - off - off2 &gt; </span><span class="s4">0</span><span class="s1">:</span>
            <span class="s1">new = ((off</span><span class="s0">, </span><span class="s1">a - off2 - off</span><span class="s0">, </span><span class="s1">off2)</span><span class="s0">,</span><span class="s1">) * b</span>
            <span class="s1">y = x.rechunk(chunks=new).compute()</span>
            <span class="s0">assert </span><span class="s1">np.all(y == orig)</span>


<span class="s0">def </span><span class="s1">test_rechunk_method():</span>
    <span class="s3">&quot;&quot;&quot;Test rechunking can be done as a method of dask array.&quot;&quot;&quot;</span>
    <span class="s1">old = ((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span>
    <span class="s1">new = ((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10000</span><span class="s1">).reshape((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=old)</span>
    <span class="s1">x2 = x.rechunk(chunks=new)</span>
    <span class="s0">assert </span><span class="s1">x2.chunks == new</span>
    <span class="s0">assert </span><span class="s1">np.all(x2.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_rechunk_blockshape():</span>
    <span class="s3">&quot;&quot;&quot;Test that blockshape can be used.&quot;&quot;&quot;</span>
    <span class="s1">new_shape</span><span class="s0">, </span><span class="s1">new_chunks = (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">new_blockdims = normalize_chunks(new_chunks</span><span class="s0">, </span><span class="s1">new_shape)</span>
    <span class="s1">old_chunks = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">a = np.random.default_rng().uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">100</span><span class="s1">).reshape((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=old_chunks)</span>
    <span class="s1">check1 = rechunk(x</span><span class="s0">, </span><span class="s1">chunks=new_chunks)</span>
    <span class="s0">assert </span><span class="s1">check1.chunks == new_blockdims</span>
    <span class="s0">assert </span><span class="s1">np.all(check1.compute() == a)</span>


<span class="s0">def </span><span class="s1">test_dtype():</span>
    <span class="s1">x = da.ones(</span><span class="s4">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.rechunk(chunks=(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">)).dtype == x.dtype</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_dict():</span>
    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(chunks={</span><span class="s4">0</span><span class="s1">: </span><span class="s4">12</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>

    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(chunks={</span><span class="s4">0</span><span class="s1">: (</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>

    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(chunks={</span><span class="s4">0</span><span class="s1">: -</span><span class="s4">1</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>

    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(chunks={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">None, </span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_empty_input():</span>
    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.rechunk(chunks={}).chunks == x.chunks</span>
    <span class="s1">pytest.raises(ValueError</span><span class="s0">, lambda</span><span class="s1">: x.rechunk(chunks=()))</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_null_dimensions():</span>
    <span class="s1">x = da.from_array(np.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">))</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.rechunk(chunks=(</span><span class="s0">None, </span><span class="s4">4</span><span class="s1">)).chunks == da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)).chunks</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">x.rechunk(chunks={</span><span class="s4">0</span><span class="s1">: </span><span class="s0">None, </span><span class="s4">1</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}).chunks</span>
        <span class="s1">== da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)).chunks</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_integer():</span>
    <span class="s1">x = da.from_array(np.arange(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">4</span><span class="s1">)</span>
    <span class="s1">y = x.rechunk(</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">(x.compute() == y.compute()).all()</span>


<span class="s0">def </span><span class="s1">test_rechunk_0d():</span>
    <span class="s1">a = np.array(</span><span class="s4">42</span><span class="s1">)</span>
    <span class="s1">x = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=())</span>
    <span class="s1">y = x.rechunk(())</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ()</span>
    <span class="s0">assert </span><span class="s1">y.compute() == a</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;arr&quot;</span><span class="s0">, </span><span class="s1">[da.array([])</span><span class="s0">, </span><span class="s1">da.array([[]</span><span class="s0">, </span><span class="s1">[]])</span><span class="s0">, </span><span class="s1">da.array([[[]]</span><span class="s0">, </span><span class="s1">[[]]])]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_empty_array(arr):</span>
    <span class="s1">arr.rechunk()</span>
    <span class="s0">assert </span><span class="s1">arr.size == </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_rechunk_empty():</span>
    <span class="s1">x = da.ones((</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_rechunk_zero_dim_array():</span>
    <span class="s1">x = da.zeros((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s4">4</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_rechunk_zero_dim_array_II():</span>
    <span class="s1">x = da.zeros((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">: </span><span class="s4">2</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_rechunk_same():</span>
    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk(x.chunks)</span>
    <span class="s0">assert </span><span class="s1">x </span><span class="s0">is </span><span class="s1">y</span>


<span class="s0">def </span><span class="s1">test_rechunk_same_fully_unknown():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">new_chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">y.chunks == new_chunks</span>
    <span class="s1">result = y.rechunk(new_chunks)</span>
    <span class="s0">assert </span><span class="s1">y </span><span class="s0">is </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_rechunk_same_fully_unknown_floats():</span>
    <span class="s3">&quot;&quot;&quot;Similar to test_rechunk_same_fully_unknown but testing the behavior if 
    ``float(&quot;nan&quot;)`` is used instead of the recommended ``np.nan`` 
    &quot;&quot;&quot;</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">new_chunks = ((float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">result = y.rechunk(new_chunks)</span>
    <span class="s0">assert </span><span class="s1">y </span><span class="s0">is </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_rechunk_same_partially_unknown():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y])</span>
    <span class="s1">new_chunks = ((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">z.chunks == new_chunks</span>
    <span class="s1">result = z.rechunk(new_chunks)</span>
    <span class="s0">assert </span><span class="s1">z </span><span class="s0">is </span><span class="s1">result</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_zero_placeholders():</span>
    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)))</span>
    <span class="s1">y = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)))</span>
    <span class="s1">y = y.rechunk(((</span><span class="s4">12</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">24</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">x.chunks == y.chunks</span>


<span class="s0">def </span><span class="s1">test_rechunk_minus_one():</span>
    <span class="s1">x = da.ones((</span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk((-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">24</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_rechunk_intermediates():</span>
    <span class="s1">x = da.random.default_rng().normal(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">len(y.dask) &gt; </span><span class="s4">30</span>


<span class="s0">def </span><span class="s1">test_divide_to_width():</span>
    <span class="s1">chunks = divide_to_width((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = divide_to_width((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s1">)</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s5"># Note how 9 gives (3, 3, 3), not (4, 4, 1) or whatever</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_merge_to_number():</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">20</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">40</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">50</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">2</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">40</span><span class="s0">, </span><span class="s4">30</span><span class="s0">, </span><span class="s4">30</span><span class="s1">)</span>

    <span class="s1">chunks = merge_to_number((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">7</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">22</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">32</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">chunks = merge_to_number((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">chunks == (</span><span class="s4">9</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">_plan(old_chunks</span><span class="s0">, </span><span class="s1">new_chunks</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">1e7</span><span class="s0">, </span><span class="s1">threshold=</span><span class="s4">4</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">plan_rechunk(</span>
        <span class="s1">old_chunks</span><span class="s0">,</span>
        <span class="s1">new_chunks</span><span class="s0">,</span>
        <span class="s1">itemsize=itemsize</span><span class="s0">,</span>
        <span class="s1">block_size_limit=block_size_limit</span><span class="s0">,</span>
        <span class="s1">threshold=threshold</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s0">assert </span><span class="s1">len(steps) == len(expected)</span>
    <span class="s0">assert </span><span class="s1">steps == expected</span>


<span class="s0">def </span><span class="s1">test_plan_rechunk():</span>
    <span class="s1">c = (</span><span class="s4">20</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">2  </span><span class="s5"># coarse</span>
    <span class="s1">f = (</span><span class="s4">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">20  </span><span class="s5"># fine</span>
    <span class="s1">nc = (np.nan</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">2  </span><span class="s5"># nan-coarse</span>
    <span class="s1">nf = (np.nan</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">20  </span><span class="s5"># nan-fine</span>

    <span class="s5"># Trivial cases</span>
    <span class="s1">steps = _plan(()</span><span class="s0">, </span><span class="s1">())</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[()])</span>
    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">())</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">()))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">())])</span>

    <span class="s5"># No intermediate required</span>
    <span class="s1">steps = _plan((c</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">,</span><span class="s1">)])</span>
    <span class="s1">steps = _plan((f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">,</span><span class="s1">)])</span>
    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">f))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">f)])</span>
    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c)])</span>
    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c)])</span>
    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c)])</span>

    <span class="s5"># An intermediate is used to reduce graph size</span>
    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)])</span>

    <span class="s1">steps = _plan((c + c</span><span class="s0">, </span><span class="s1">c + f)</span><span class="s0">, </span><span class="s1">(f + f</span><span class="s0">, </span><span class="s1">c + c))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c + c</span><span class="s0">, </span><span class="s1">c + c)</span><span class="s0">, </span><span class="s1">(f + f</span><span class="s0">, </span><span class="s1">c + c)])</span>

    <span class="s5"># Same, with unknown dim</span>
    <span class="s1">steps = _plan((nc + nf</span><span class="s0">, </span><span class="s1">c + c</span><span class="s0">, </span><span class="s1">c + f)</span><span class="s0">, </span><span class="s1">(nc + nf</span><span class="s0">, </span><span class="s1">f + f</span><span class="s0">, </span><span class="s1">c + c))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">steps)</span>

    <span class="s5"># Regression test for #5908</span>
    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">threshold=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">f)])</span>

    <span class="s5"># Just at the memory limit =&gt; an intermediate is used</span>
    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">400</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)])</span>

    <span class="s5"># Hitting the memory limit =&gt; partial merge</span>
    <span class="s1">m = (</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">4  </span><span class="s5"># mid</span>

    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">399</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(m</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)])</span>

    <span class="s1">steps2 = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">3999</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s4">10</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps2</span><span class="s0">, </span><span class="s1">steps)</span>

    <span class="s5"># Larger problem size =&gt; more intermediates</span>
    <span class="s1">c = (</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">2  </span><span class="s5"># coarse</span>
    <span class="s1">f = (</span><span class="s4">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">1000  </span><span class="s5"># fine</span>

    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">99999</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(steps) == </span><span class="s4">3</span>
    <span class="s0">assert </span><span class="s1">steps[-</span><span class="s4">1</span><span class="s1">] == (c</span><span class="s0">, </span><span class="s1">f)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(steps) - </span><span class="s4">1</span><span class="s1">):</span>
        <span class="s1">prev = steps[i]</span>
        <span class="s1">succ = steps[i + </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s5"># Merging on the first dim, splitting on the second dim</span>
        <span class="s0">assert </span><span class="s1">len(succ[</span><span class="s4">0</span><span class="s1">]) &lt;= len(prev[</span><span class="s4">0</span><span class="s1">]) / </span><span class="s4">2.0</span>
        <span class="s0">assert </span><span class="s1">len(succ[</span><span class="s4">1</span><span class="s1">]) &gt;= len(prev[</span><span class="s4">1</span><span class="s1">]) * </span><span class="s4">2.0</span>


<span class="s0">def </span><span class="s1">test_plan_rechunk_5d():</span>
    <span class="s5"># 5d problem</span>
    <span class="s1">c = (</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">1  </span><span class="s5"># coarse</span>
    <span class="s1">f = (</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10  </span><span class="s5"># fine</span>

    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f)])</span>
    <span class="s1">steps = _plan((f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f)])</span>
    <span class="s5"># Only 1 dim can be merged at first</span>
    <span class="s1">steps = _plan((c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">2e4</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">f)])</span>


<span class="s0">def </span><span class="s1">test_plan_rechunk_heterogeneous():</span>
    <span class="s1">c = (</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">1  </span><span class="s5"># coarse</span>
    <span class="s1">f = (</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10  </span><span class="s5"># fine</span>
    <span class="s1">cf = c + f</span>
    <span class="s1">cc = c + c</span>
    <span class="s1">ff = f + f</span>
    <span class="s1">fc = f + c</span>

    <span class="s5"># No intermediate required</span>
    <span class="s1">steps = _plan((cc</span><span class="s0">, </span><span class="s1">cf)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">ff))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(ff</span><span class="s0">, </span><span class="s1">ff)])</span>
    <span class="s1">steps = _plan((cf</span><span class="s0">, </span><span class="s1">fc)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cf))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(ff</span><span class="s0">, </span><span class="s1">cf)])</span>

    <span class="s5"># An intermediate is used to reduce graph size</span>
    <span class="s1">steps = _plan((cc</span><span class="s0">, </span><span class="s1">cf)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cc))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(cc</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cc)])</span>

    <span class="s1">steps = _plan((cc</span><span class="s0">, </span><span class="s1">cf</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cc</span><span class="s0">, </span><span class="s1">cf))</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(cc</span><span class="s0">, </span><span class="s1">cc</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cc</span><span class="s0">, </span><span class="s1">cf)])</span>

    <span class="s5"># Imposing a memory limit =&gt; the first intermediate is constrained:</span>
    <span class="s5">#  * cc -&gt; ff would increase the graph size: no</span>
    <span class="s5">#  * ff -&gt; cf would increase the block size too much: no</span>
    <span class="s5">#  * cf -&gt; cc fits the bill (graph size /= 10, block size neutral)</span>
    <span class="s5">#  * cf -&gt; fc also fits the bill (graph size and block size neutral)</span>
    <span class="s1">steps = _plan((cc</span><span class="s0">, </span><span class="s1">ff</span><span class="s0">, </span><span class="s1">cf)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cf</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">_assert_steps(steps</span><span class="s0">, </span><span class="s1">[(cc</span><span class="s0">, </span><span class="s1">ff</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">, </span><span class="s1">(ff</span><span class="s0">, </span><span class="s1">cf</span><span class="s0">, </span><span class="s1">cc)])</span>


<span class="s0">def </span><span class="s1">test_plan_rechunk_asymmetric():</span>
    <span class="s1">a = ((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">1000</span><span class="s0">, </span><span class="s1">(</span><span class="s4">80000000</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = ((</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">80000</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">1000</span><span class="s1">)</span>
    <span class="s1">steps = plan_rechunk(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">itemsize=</span><span class="s4">8</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(steps) &gt; </span><span class="s4">1</span>

    <span class="s1">x = da.ones((</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">80000000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">80000000</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk((</span><span class="s4">1000</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s4">1</span><span class="s1">] // </span><span class="s4">1000</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">len(y.dask) &lt; </span><span class="s4">100000</span>


<span class="s0">def </span><span class="s1">test_rechunk_warning():</span>
    <span class="s1">N = </span><span class="s4">20</span>
    <span class="s1">x = da.random.default_rng().normal(size=(N</span><span class="s0">, </span><span class="s1">N</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">N</span><span class="s0">, </span><span class="s4">100</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
        <span class="s1">x = x.rechunk((N</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">100</span><span class="s1">))</span>

    <span class="s0">assert not </span><span class="s1">w</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape,chunks&quot;</span><span class="s0">, </span><span class="s1">[[(</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)]]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_dont_concatenate_single_chunks(shape</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">x = da.ones(shape</span><span class="s0">, </span><span class="s1">chunks=shape)</span>
    <span class="s1">y = x.rechunk(chunks)</span>
    <span class="s1">dsk = dict(y.dask)</span>
    <span class="s0">assert not </span><span class="s1">any(</span>
        <span class="s1">funcname(task[</span><span class="s4">0</span><span class="s1">]).startswith(</span><span class="s2">&quot;concat&quot;</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">task </span><span class="s0">in </span><span class="s1">dsk.values()</span>
        <span class="s0">if </span><span class="s1">dask.istask(task)</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_intersect_nan():</span>
    <span class="s1">old_chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new_chunks = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>

    <span class="s1">result = list(intersect_chunks(old_chunks</span><span class="s0">, </span><span class="s1">new_chunks))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_intersect_nan_single():</span>
    <span class="s1">old_chunks = ((np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new_chunks = ((np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>

    <span class="s1">result = list(intersect_chunks(old_chunks</span><span class="s0">, </span><span class="s1">new_chunks))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_intersect_nan_long():</span>
    <span class="s1">old_chunks = (tuple([np.nan] * </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new_chunks = (tuple([np.nan] * </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old_chunks</span><span class="s0">, </span><span class="s1">new_chunks))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_rechunk_unknown_from_pandas():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>

    <span class="s1">arr = np.random.default_rng().standard_normal((</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s1">x = dd.from_pandas(pd.DataFrame(arr)</span><span class="s0">, </span><span class="s4">2</span><span class="s1">).values</span>
    <span class="s1">result = x.rechunk((</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s0">assert </span><span class="s1">np.isnan(x.chunks[</span><span class="s4">0</span><span class="s1">]).all()</span>
    <span class="s0">assert </span><span class="s1">np.isnan(result.chunks[</span><span class="s4">0</span><span class="s1">]).all()</span>
    <span class="s0">assert </span><span class="s1">result.chunks[</span><span class="s4">1</span><span class="s1">] == (</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">expected = da.from_array(arr</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">25</span><span class="s0">, </span><span class="s4">25</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))).rechunk((</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_rechunk_unknown_from_array():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s5"># pd = pytest.importorskip('pandas')</span>
    <span class="s1">x = dd.from_array(da.ones(shape=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))).values</span>
    <span class="s5"># result = x.rechunk({1: 5})</span>
    <span class="s1">result = x.rechunk((</span><span class="s0">None, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.isnan(x.chunks[</span><span class="s4">0</span><span class="s1">]).all()</span>
    <span class="s0">assert </span><span class="s1">np.isnan(result.chunks[</span><span class="s4">0</span><span class="s1">]).all()</span>
    <span class="s0">assert </span><span class="s1">x.chunks[</span><span class="s4">1</span><span class="s1">] == (</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;x, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_with_fully_unknown_dimension(x</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">result = y.rechunk(chunks)</span>
    <span class="s1">expected = x.rechunk(chunks)</span>
    <span class="s1">assert_chunks_match(result.chunks</span><span class="s0">, </span><span class="s1">expected.chunks)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;x, chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">25</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">1000</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">{</span><span class="s4">1</span><span class="s1">: </span><span class="s4">5</span><span class="s1">})</span><span class="s0">,</span>
        <span class="s1">(da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_with_partially_unknown_dimension(x</span><span class="s0">, </span><span class="s1">chunks):</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y])</span>
    <span class="s1">xx = da.concatenate([x</span><span class="s0">, </span><span class="s1">x])</span>
    <span class="s1">result = z.rechunk(chunks)</span>
    <span class="s1">expected = xx.rechunk(chunks)</span>
    <span class="s1">assert_chunks_match(result.chunks</span><span class="s0">, </span><span class="s1">expected.chunks)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;new_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((math.nan</span><span class="s0">, </span><span class="s1">math.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_with_fully_unknown_dimension_explicit(new_chunks):</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">result = y.rechunk(new_chunks)</span>
    <span class="s1">expected = x.rechunk((</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s1">assert_chunks_match(result.chunks</span><span class="s0">, </span><span class="s1">expected.chunks)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;new_chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s1">math.nan</span><span class="s0">, </span><span class="s1">math.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">float(</span><span class="s2">&quot;nan&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_with_partially_unknown_dimension_explicit(new_chunks):</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>
    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y])</span>
    <span class="s1">xx = da.concatenate([x</span><span class="s0">, </span><span class="s1">x])</span>
    <span class="s1">result = z.rechunk(new_chunks)</span>
    <span class="s1">expected = xx.rechunk((</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s1">assert_chunks_match(result.chunks</span><span class="s0">, </span><span class="s1">expected.chunks)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">assert_chunks_match(left</span><span class="s0">, </span><span class="s1">right):</span>
    <span class="s0">for </span><span class="s1">ldim</span><span class="s0">, </span><span class="s1">rdim </span><span class="s0">in </span><span class="s1">zip(left</span><span class="s0">, </span><span class="s1">right):</span>
        <span class="s0">assert </span><span class="s1">all(np.isnan(l) </span><span class="s0">or </span><span class="s1">l == r </span><span class="s0">for </span><span class="s1">l</span><span class="s0">, </span><span class="s1">r </span><span class="s0">in </span><span class="s1">zip(ldim</span><span class="s0">, </span><span class="s1">rdim))</span>


<span class="s0">def </span><span class="s1">test_rechunk_unknown_raises():</span>
    <span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>

    <span class="s1">x = da.ones(shape=(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">y = dd.from_array(x).values</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Chunks do not add&quot;</span><span class="s1">):</span>
        <span class="s1">y.rechunk((</span><span class="s0">None, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Chunks must be unchanging&quot;</span><span class="s1">):</span>
        <span class="s1">y.rechunk(((np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Chunks must be unchanging&quot;</span><span class="s1">):</span>
        <span class="s1">y.rechunk(((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Chunks must be unchanging&quot;</span><span class="s1">):</span>
        <span class="s1">z = da.concatenate([x</span><span class="s0">, </span><span class="s1">y])</span>
        <span class="s1">z.rechunk(((</span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_old_to_new_single():</span>
    <span class="s1">old = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">8</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((np.nan</span><span class="s0">, </span><span class="s1">np.nan)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>

    <span class="s1">expected = [</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]]</span><span class="s0">,</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, None</span><span class="s1">))]]</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_old_to_new():</span>
    <span class="s1">old = ((np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((np.nan</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]]</span><span class="s0">,</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))]]</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_old_to_new_large():</span>
    <span class="s1">old = (tuple([np.nan] * </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = (tuple([np.nan] * </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span>

    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [</span>
        <span class="s1">[</span>
            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, None, None</span><span class="s1">))]</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))]]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_old_to_new_known():</span>
    <span class="s1">old = ((</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">25</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [</span>
        <span class="s1">[</span>
            <span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">,</span>
            <span class="s1">[(</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, None</span><span class="s1">))]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_rechunk_zero_dim():</span>
    <span class="s1">da = pytest.importorskip(</span><span class="s2">&quot;dask.array&quot;</span><span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)).rechunk((</span><span class="s4">0</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">50</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">len(x.compute()) == </span><span class="s4">0</span>


<span class="s0">def </span><span class="s1">test_rechunk_empty_chunks():</span>
    <span class="s1">x = da.zeros((</span><span class="s4">7</span><span class="s0">, </span><span class="s4">24</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s1">y = x.rechunk((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_rechunk_avoid_needless_chunking():</span>
    <span class="s1">x = da.ones(</span><span class="s4">16</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">y = x.rechunk(</span><span class="s4">8</span><span class="s1">)</span>
    <span class="s1">dsk = y.__dask_graph__()</span>
    <span class="s0">assert </span><span class="s1">len(dsk) &lt;= </span><span class="s4">8 </span><span class="s1">+ </span><span class="s4">2</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape,chunks,bs,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">50</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">20</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">7</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s4">20</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s1">(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rechunk_auto_1d(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">bs</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">x = da.ones(shape</span><span class="s0">, </span><span class="s1">chunks=(chunks</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">block_size_limit=bs * x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == (expected</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rechunk_auto_2d():</span>
    <span class="s1">x = da.ones((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: -</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">20 </span><span class="s1">* x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">20</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">20</span><span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">y = x.rechunk((-</span><span class="s4">1</span><span class="s0">, </span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">80 </span><span class="s1">* x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">20</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">5</span><span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)))</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">20 </span><span class="s1">* x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">1</span><span class="s1">] == x.chunks[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">2</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">)))</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">20 </span><span class="s1">* x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">1</span><span class="s1">] == x.chunks[</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)  </span><span class="s5"># limited by largest</span>


<span class="s0">def </span><span class="s1">test_rechunk_auto_3d():</span>
    <span class="s1">x = da.ones((</span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)))</span>
    <span class="s1">y = x.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">block_size_limit=</span><span class="s4">200 </span><span class="s1">* x.dtype.itemsize)</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">2</span><span class="s1">] == x.chunks[</span><span class="s4">2</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks[</span><span class="s4">1</span><span class="s1">] == (</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)  </span><span class="s5"># even split</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">100</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_rechunk_auto_image_stack(n):</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;10MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.ones((n</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span><span class="s1">)</span>
        <span class="s1">y = x.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * (n // </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">y.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">).chunks == y.chunks  </span><span class="s5"># idempotent</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;7MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">z = x.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">n == </span><span class="s4">100</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">7</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">14 </span><span class="s1">+ (</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">7</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">142 </span><span class="s1">+ (</span><span class="s4">6</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;1MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.ones((n</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float64&quot;</span><span class="s1">)</span>
        <span class="s1">z = x.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * n</span><span class="s0">, </span><span class="s1">(</span><span class="s4">362</span><span class="s0">, </span><span class="s4">362</span><span class="s0">, </span><span class="s4">276</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">362</span><span class="s0">, </span><span class="s4">362</span><span class="s0">, </span><span class="s4">276</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_rechunk_down():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;10MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.ones((</span><span class="s4">100</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1000</span><span class="s0">, </span><span class="s4">1000</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;uint8&quot;</span><span class="s1">)</span>
        <span class="s1">y = x.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;1MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">z = y.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">4</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">25</span><span class="s0">, </span><span class="s1">(</span><span class="s4">511</span><span class="s0">, </span><span class="s4">489</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">511</span><span class="s0">, </span><span class="s4">489</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;1MiB&quot;</span><span class="s1">}):</span>
        <span class="s1">z = y.rechunk({</span><span class="s4">0</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">100</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>

        <span class="s1">z = y.rechunk({</span><span class="s4">1</span><span class="s1">: </span><span class="s2">&quot;auto&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s4">10</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">, </span><span class="s1">(</span><span class="s4">104</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">9 </span><span class="s1">+ (</span><span class="s4">64</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1000</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_rechunk_zero():</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;array.chunk-size&quot;</span><span class="s1">: </span><span class="s2">&quot;1B&quot;</span><span class="s1">}):</span>
        <span class="s1">x = da.ones(</span><span class="s4">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">5</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">y = x.rechunk(</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s4">1</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">10</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_rechunk_bad_keys():</span>
    <span class="s1">x = da.zeros((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.rechunk({-</span><span class="s4">1</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}).chunks == ((</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">x.rechunk({-x.ndim: </span><span class="s4">2</span><span class="s1">}).chunks == ((</span><span class="s4">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(TypeError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.rechunk({</span><span class="s2">&quot;blah&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">})</span>

    <span class="s0">assert </span><span class="s2">&quot;blah&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.rechunk({</span><span class="s4">100</span><span class="s1">: </span><span class="s4">4</span><span class="s1">})</span>

    <span class="s0">assert </span><span class="s2">&quot;100&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">x.rechunk({-</span><span class="s4">100</span><span class="s1">: </span><span class="s4">4</span><span class="s1">})</span>

    <span class="s0">assert </span><span class="s2">&quot;-100&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>


<span class="s0">def </span><span class="s1">test_balance_basics():</span>
    <span class="s1">arr_len = </span><span class="s4">220</span>

    <span class="s1">x = da.from_array(np.arange(arr_len)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">balanced = x.rechunk(chunks=</span><span class="s4">100</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=</span><span class="s4">100</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">110</span><span class="s0">, </span><span class="s4">110</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_chunks_unchanged():</span>
    <span class="s1">arr_len = </span><span class="s4">220</span>

    <span class="s1">x = da.from_array(np.arange(arr_len))</span>
    <span class="s1">balanced = x.rechunk(chunks=</span><span class="s4">100</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=</span><span class="s4">100</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">20</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">110</span><span class="s0">, </span><span class="s4">110</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_small():</span>
    <span class="s1">arr_len = </span><span class="s4">13</span>

    <span class="s1">x = da.from_array(np.arange(arr_len))</span>
    <span class="s1">balanced = x.rechunk(chunks=</span><span class="s4">4</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=</span><span class="s4">4</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s1">arr_len = </span><span class="s4">7</span>

    <span class="s1">x = da.from_array(np.arange(arr_len))</span>
    <span class="s1">balanced = x.rechunk(chunks=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">4</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_n_chunks_size():</span>
    <span class="s1">arr_len = </span><span class="s4">100</span>
    <span class="s1">n_chunks = </span><span class="s4">8</span>

    <span class="s1">x = da.from_array(np.arange(arr_len))</span>
    <span class="s1">balanced = x.rechunk(chunks=arr_len // n_chunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=arr_len // n_chunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">13</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">7 </span><span class="s1">+ (</span><span class="s4">9</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks[</span><span class="s4">0</span><span class="s1">] == (</span><span class="s4">12</span><span class="s0">,</span><span class="s1">) * </span><span class="s4">8 </span><span class="s1">+ (</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_raises():</span>
    <span class="s1">arr_len = </span><span class="s4">100</span>
    <span class="s1">n_chunks = </span><span class="s4">11</span>

    <span class="s1">x = da.from_array(np.arange(arr_len))</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Try increasing the chunk size&quot;</span><span class="s1">):</span>
        <span class="s1">balanced = x.rechunk(chunks=arr_len // n_chunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=arr_len // n_chunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks == unbalanced.chunks</span>

    <span class="s1">n_chunks = </span><span class="s4">10</span>
    <span class="s1">x.rechunk(chunks=arr_len // n_chunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_basics_2d():</span>
    <span class="s1">N = </span><span class="s4">210</span>

    <span class="s1">x = da.from_array(np.random.default_rng().uniform(size=(N</span><span class="s0">, </span><span class="s1">N)))</span>
    <span class="s1">balanced = x.rechunk(chunks=(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks == ((</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks == ((</span><span class="s4">105</span><span class="s0">, </span><span class="s4">105</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">105</span><span class="s0">, </span><span class="s4">105</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_balance_2d_negative_dimension():</span>
    <span class="s1">N = </span><span class="s4">210</span>

    <span class="s1">x = da.from_array(np.random.default_rng().uniform(size=(N</span><span class="s0">, </span><span class="s1">N)))</span>
    <span class="s1">balanced = x.rechunk(chunks=(</span><span class="s4">100</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=(</span><span class="s4">100</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">unbalanced.chunks == ((</span><span class="s4">100</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s4">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(N</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks == ((</span><span class="s4">105</span><span class="s0">, </span><span class="s4">105</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(N</span><span class="s0">,</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_balance_different_inputs():</span>
    <span class="s1">N = </span><span class="s4">210</span>

    <span class="s1">x = da.from_array(np.random.default_rng().uniform(size=(N</span><span class="s0">, </span><span class="s1">N)))</span>
    <span class="s1">balanced = x.rechunk(chunks=(</span><span class="s2">&quot;10MB&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">unbalanced = x.rechunk(chunks=(</span><span class="s2">&quot;10MB&quot;</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks == unbalanced.chunks</span>
    <span class="s0">assert </span><span class="s1">balanced.chunks[</span><span class="s4">1</span><span class="s1">] == (N</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_balance_split_into_n_chunks():</span>
    <span class="s5"># Some prime numbers around 1000</span>
    <span class="s1">array_lens = [</span>
        <span class="s4">991</span><span class="s0">,</span>
        <span class="s4">997</span><span class="s0">,</span>
        <span class="s4">1009</span><span class="s0">,</span>
        <span class="s4">1013</span><span class="s0">,</span>
        <span class="s4">1019</span><span class="s0">,</span>
        <span class="s4">1021</span><span class="s0">,</span>
        <span class="s4">1031</span><span class="s0">,</span>
        <span class="s4">1033</span><span class="s0">,</span>
        <span class="s4">1039</span><span class="s0">,</span>
        <span class="s4">1049</span><span class="s0">,</span>
        <span class="s4">1051</span><span class="s0">,</span>
        <span class="s4">1061</span><span class="s0">,</span>
        <span class="s4">1063</span><span class="s0">,</span>
        <span class="s4">1069</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">for </span><span class="s1">N </span><span class="s0">in </span><span class="s1">array_lens:</span>
        <span class="s0">for </span><span class="s1">nchunks </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">20</span><span class="s1">):</span>
            <span class="s1">x = da.from_array(np.random.default_rng().uniform(size=N))</span>
            <span class="s1">y = x.rechunk(chunks=len(x) // nchunks</span><span class="s0">, </span><span class="s1">balance=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">len(y.chunks[</span><span class="s4">0</span><span class="s1">]) == nchunks</span>


<span class="s0">def </span><span class="s1">test_rechunk_with_zero():</span>
    <span class="s1">a = da.ones((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">result = a.rechunk(((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)))</span>
    <span class="s1">expected = da.ones((</span><span class="s4">8</span><span class="s0">, </span><span class="s4">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)))</span>

    <span class="s5"># reverse:</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">expected = expected</span><span class="s0">, </span><span class="s1">a</span>
    <span class="s1">result = a.rechunk((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_intersect_chunks_with_nonzero():</span>
    <span class="s0">from </span><span class="s1">dask.array.rechunk </span><span class="s0">import </span><span class="s1">intersect_chunks</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">8</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old</span><span class="s0">, </span><span class="s1">new))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(</span>
            <span class="s1">((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_intersect_chunks_with_zero():</span>
    <span class="s0">from </span><span class="s1">dask.array.rechunk </span><span class="s0">import </span><span class="s1">intersect_chunks</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old</span><span class="s0">, </span><span class="s1">new))</span>

    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old</span><span class="s0">, </span><span class="s1">new))</span>

    <span class="s1">expected = [</span>
        <span class="s1">(</span>
            <span class="s1">((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s1">((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
            <span class="s1">((</span><span class="s4">3</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old</span><span class="s0">, </span><span class="s1">new))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">new = ((</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
    <span class="s1">result = list(intersect_chunks(old</span><span class="s0">, </span><span class="s1">new))</span>
    <span class="s1">expected = [</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, None</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, None</span><span class="s1">)))</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">result == expected</span>


<span class="s0">def </span><span class="s1">test_old_to_new_with_zero():</span>
    <span class="s0">from </span><span class="s1">dask.array.rechunk </span><span class="s0">import </span><span class="s1">old_to_new</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">1</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]]]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">4</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]]]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>

    <span class="s1">old = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">new = ((</span><span class="s4">4</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">result = old_to_new(old</span><span class="s0">, </span><span class="s1">new)</span>
    <span class="s1">expected = [</span>
        <span class="s1">[[(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))]</span><span class="s0">, </span><span class="s1">[(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">slice(</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))]]</span>
    <span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">result == expected</span>
</pre>
</body>
</html>