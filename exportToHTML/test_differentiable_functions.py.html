<html>
<head>
<title>test_differentiable_functions.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_differentiable_functions.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(TestCase</span><span class="s0">, </span><span class="s1">assert_array_almost_equal</span><span class="s0">,</span>
                           <span class="s1">assert_array_equal</span><span class="s0">, </span><span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_allclose</span><span class="s0">,</span>
                           <span class="s1">assert_equal)</span>
<span class="s0">from </span><span class="s1">scipy.sparse </span><span class="s0">import </span><span class="s1">csr_matrix</span>
<span class="s0">from </span><span class="s1">scipy.sparse.linalg </span><span class="s0">import </span><span class="s1">LinearOperator</span>
<span class="s0">from </span><span class="s1">scipy.optimize._differentiable_functions </span><span class="s0">import </span><span class="s1">(ScalarFunction</span><span class="s0">,</span>
                                                      <span class="s1">VectorFunction</span><span class="s0">,</span>
                                                      <span class="s1">LinearVectorFunction</span><span class="s0">,</span>
                                                      <span class="s1">IdentityVectorFunction)</span>
<span class="s0">from </span><span class="s1">scipy.optimize </span><span class="s0">import </span><span class="s1">rosen</span><span class="s0">, </span><span class="s1">rosen_der</span><span class="s0">, </span><span class="s1">rosen_hess</span>
<span class="s0">from </span><span class="s1">scipy.optimize._hessian_update_strategy </span><span class="s0">import </span><span class="s1">BFGS</span>


<span class="s0">class </span><span class="s1">ExScalarFunction:</span>

    <span class="s0">def </span><span class="s1">__init__(self):</span>
        <span class="s1">self.nfev = </span><span class="s2">0</span>
        <span class="s1">self.ngev = </span><span class="s2">0</span>
        <span class="s1">self.nhev = </span><span class="s2">0</span>

    <span class="s0">def </span><span class="s1">fun(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.nfev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s2">2</span><span class="s1">*(x[</span><span class="s2">0</span><span class="s1">]**</span><span class="s2">2 </span><span class="s1">+ x[</span><span class="s2">1</span><span class="s1">]**</span><span class="s2">2 </span><span class="s1">- </span><span class="s2">1</span><span class="s1">) - x[</span><span class="s2">0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">grad(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.ngev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s1">np.array([</span><span class="s2">4</span><span class="s1">*x[</span><span class="s2">0</span><span class="s1">]-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">*x[</span><span class="s2">1</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">hess(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.nhev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s2">4</span><span class="s1">*np.eye(</span><span class="s2">2</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestScalarFunction(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_finite_difference_grad(self):</span>
        <span class="s1">ex = ExScalarFunction()</span>
        <span class="s1">nfev = </span><span class="s2">0</span>
        <span class="s1">ngev = </span><span class="s2">0</span>

        <span class="s1">x0 = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span>
        <span class="s1">analit = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">ex.grad</span><span class="s0">,</span>
                                <span class="s1">ex.hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">approx = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'2-point'</span><span class="s0">,</span>
                                <span class="s1">ex.hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.f</span><span class="s0">, </span><span class="s1">approx.f)</span>
        <span class="s1">assert_array_almost_equal(analit.g</span><span class="s0">, </span><span class="s1">approx.g)</span>

        <span class="s1">x = [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">g_analit = analit.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">g_approx = approx.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(g_analit</span><span class="s0">, </span><span class="s1">g_approx)</span>

        <span class="s1">x = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span>
        <span class="s1">g_analit = analit.grad(x)</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>

        <span class="s1">g_approx = approx.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_almost_equal(g_analit</span><span class="s0">, </span><span class="s1">g_approx)</span>

        <span class="s1">x = [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">g_analit = analit.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">g_approx = approx.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(g_analit</span><span class="s0">, </span><span class="s1">g_approx)</span>

        <span class="s1">x = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">g_analit = analit.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">g_approx = approx.grad(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(g_analit</span><span class="s0">, </span><span class="s1">g_approx)</span>

    <span class="s0">def </span><span class="s1">test_fun_and_grad(self):</span>
        <span class="s1">ex = ExScalarFunction()</span>

        <span class="s0">def </span><span class="s1">fg_allclose(x</span><span class="s0">, </span><span class="s1">y):</span>
            <span class="s1">assert_allclose(x[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[</span><span class="s2">0</span><span class="s1">])</span>
            <span class="s1">assert_allclose(x[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[</span><span class="s2">1</span><span class="s1">])</span>

        <span class="s4"># with analytic gradient</span>
        <span class="s1">x0 = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">analit = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">ex.grad</span><span class="s0">,</span>
                                <span class="s1">ex.hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>

        <span class="s1">fg = ex.fun(x0)</span><span class="s0">, </span><span class="s1">ex.grad(x0)</span>
        <span class="s1">fg_allclose(analit.fun_and_grad(x0)</span><span class="s0">, </span><span class="s1">fg)</span>
        <span class="s0">assert </span><span class="s1">analit.ngev == </span><span class="s2">1</span>

        <span class="s1">x0[</span><span class="s2">1</span><span class="s1">] = </span><span class="s2">1.</span>
        <span class="s1">fg = ex.fun(x0)</span><span class="s0">, </span><span class="s1">ex.grad(x0)</span>
        <span class="s1">fg_allclose(analit.fun_and_grad(x0)</span><span class="s0">, </span><span class="s1">fg)</span>

        <span class="s4"># with finite difference gradient</span>
        <span class="s1">x0 = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">sf = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">,</span>
                                <span class="s1">ex.hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s0">assert </span><span class="s1">sf.ngev == </span><span class="s2">1</span>
        <span class="s1">fg = ex.fun(x0)</span><span class="s0">, </span><span class="s1">ex.grad(x0)</span>
        <span class="s1">fg_allclose(sf.fun_and_grad(x0)</span><span class="s0">, </span><span class="s1">fg)</span>
        <span class="s0">assert </span><span class="s1">sf.ngev == </span><span class="s2">1</span>

        <span class="s1">x0[</span><span class="s2">1</span><span class="s1">] = </span><span class="s2">1.</span>
        <span class="s1">fg = ex.fun(x0)</span><span class="s0">, </span><span class="s1">ex.grad(x0)</span>
        <span class="s1">fg_allclose(sf.fun_and_grad(x0)</span><span class="s0">, </span><span class="s1">fg)</span>

    <span class="s0">def </span><span class="s1">test_finite_difference_hess_linear_operator(self):</span>
        <span class="s1">ex = ExScalarFunction()</span>
        <span class="s1">nfev = </span><span class="s2">0</span>
        <span class="s1">ngev = </span><span class="s2">0</span>
        <span class="s1">nhev = </span><span class="s2">0</span>

        <span class="s1">x0 = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span>
        <span class="s1">analit = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">ex.grad</span><span class="s0">,</span>
                                <span class="s1">ex.hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">approx = ScalarFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">ex.grad</span><span class="s0">,</span>
                                <span class="s3">'2-point'</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s1">assert_(isinstance(approx.H</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_equal(analit.f</span><span class="s0">, </span><span class="s1">approx.f)</span>
            <span class="s1">assert_array_almost_equal(analit.g</span><span class="s0">, </span><span class="s1">approx.g)</span>
            <span class="s1">assert_array_almost_equal(analit.H.dot(v)</span><span class="s0">, </span><span class="s1">approx.H.dot(v))</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">ngev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span>
        <span class="s1">H_analit = analit.hess(x)</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">H_approx = approx.hess(x)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v))</span>
        <span class="s1">ngev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.1</span><span class="s0">, </span><span class="s2">1.2</span><span class="s1">]</span>
        <span class="s1">H_analit = analit.hess(x)</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">H_approx = approx.hess(x)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v))</span>
        <span class="s1">ngev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">_ = analit.grad(x)</span>
        <span class="s1">H_analit = analit.hess(x)</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">_ = approx.grad(x)</span>
        <span class="s1">H_approx = approx.hess(x)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v))</span>
        <span class="s1">ngev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">5.2</span><span class="s0">, </span><span class="s2">2.3</span><span class="s1">]</span>
        <span class="s1">_ = analit.grad(x)</span>
        <span class="s1">H_analit = analit.hess(x)</span>
        <span class="s1">ngev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">_ = approx.grad(x)</span>
        <span class="s1">H_approx = approx.hess(x)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v))</span>
        <span class="s1">ngev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(analit.ngev+approx.ngev</span><span class="s0">, </span><span class="s1">ngev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

    <span class="s0">def </span><span class="s1">test_x_storage_overlap(self):</span>
        <span class="s4"># Scalar_Function should not store references to arrays, it should</span>
        <span class="s4"># store copies - this checks that updating an array in-place causes</span>
        <span class="s4"># Scalar_Function.x to be updated.</span>

        <span class="s0">def </span><span class="s1">f(x):</span>
            <span class="s0">return </span><span class="s1">np.sum(np.asarray(x) ** </span><span class="s2">2</span><span class="s1">)</span>

        <span class="s1">x = np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">])</span>
        <span class="s1">sf = ScalarFunction(f</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">, lambda </span><span class="s1">x: x</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>

        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>
        <span class="s1">assert_equal(sf.fun(x)</span><span class="s0">, </span><span class="s2">14.0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>

        <span class="s1">x[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0.</span>
        <span class="s1">f1 = sf.fun(x)</span>
        <span class="s1">assert_equal(f1</span><span class="s0">, </span><span class="s2">13.0</span><span class="s1">)</span>

        <span class="s1">x[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">f2 = sf.fun(x)</span>
        <span class="s1">assert_equal(f2</span><span class="s0">, </span><span class="s2">14.0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>

        <span class="s4"># now test with a HessianUpdate strategy specified</span>
        <span class="s1">hess = BFGS()</span>
        <span class="s1">x = np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">])</span>
        <span class="s1">sf = ScalarFunction(f</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">, </span><span class="s1">hess</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>

        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>
        <span class="s1">assert_equal(sf.fun(x)</span><span class="s0">, </span><span class="s2">14.0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>

        <span class="s1">x[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">0.</span>
        <span class="s1">f1 = sf.fun(x)</span>
        <span class="s1">assert_equal(f1</span><span class="s0">, </span><span class="s2">13.0</span><span class="s1">)</span>

        <span class="s1">x[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">f2 = sf.fun(x)</span>
        <span class="s1">assert_equal(f2</span><span class="s0">, </span><span class="s2">14.0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>

        <span class="s4"># gh13740 x is changed in user function</span>
        <span class="s0">def </span><span class="s1">ff(x):</span>
            <span class="s1">x *= x    </span><span class="s4"># overwrite x</span>
            <span class="s0">return </span><span class="s1">np.sum(x)</span>

        <span class="s1">x = np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">])</span>
        <span class="s1">sf = ScalarFunction(</span>
            <span class="s1">ff</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">, lambda </span><span class="s1">x: x</span><span class="s0">, None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>
        <span class="s1">assert_equal(sf.fun(x)</span><span class="s0">, </span><span class="s2">14.0</span><span class="s1">)</span>
        <span class="s1">assert_equal(sf.x</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">2.</span><span class="s0">, </span><span class="s2">3.</span><span class="s1">]))</span>
        <span class="s0">assert </span><span class="s1">x </span><span class="s0">is not </span><span class="s1">sf.x</span>

    <span class="s0">def </span><span class="s1">test_lowest_x(self):</span>
        <span class="s4"># ScalarFunction should remember the lowest func(x) visited.</span>
        <span class="s1">x0 = np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">sf = ScalarFunction(rosen</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">rosen_der</span><span class="s0">, </span><span class="s1">rosen_hess</span><span class="s0">,</span>
                            <span class="s0">None, None</span><span class="s1">)</span>
        <span class="s1">sf.fun([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">sf.fun(x0)</span>
        <span class="s1">sf.fun([</span><span class="s2">1.01</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">sf.grad([</span><span class="s2">1.01</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">assert_equal(sf._lowest_f</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span>
        <span class="s1">assert_equal(sf._lowest_x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>

        <span class="s1">sf = ScalarFunction(rosen</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s3">'2-point'</span><span class="s0">, </span><span class="s1">rosen_hess</span><span class="s0">,</span>
                            <span class="s0">None, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf))</span>
        <span class="s1">sf.fun([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">sf.fun(x0)</span>
        <span class="s1">sf.fun([</span><span class="s2">1.01</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">sf.grad([</span><span class="s2">1.01</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>
        <span class="s1">assert_equal(sf._lowest_f</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span>
        <span class="s1">assert_equal(sf._lowest_x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">ExVectorialFunction:</span>

    <span class="s0">def </span><span class="s1">__init__(self):</span>
        <span class="s1">self.nfev = </span><span class="s2">0</span>
        <span class="s1">self.njev = </span><span class="s2">0</span>
        <span class="s1">self.nhev = </span><span class="s2">0</span>

    <span class="s0">def </span><span class="s1">fun(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.nfev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s1">np.array([</span><span class="s2">2</span><span class="s1">*(x[</span><span class="s2">0</span><span class="s1">]**</span><span class="s2">2 </span><span class="s1">+ x[</span><span class="s2">1</span><span class="s1">]**</span><span class="s2">2 </span><span class="s1">- </span><span class="s2">1</span><span class="s1">) - x[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s2">4</span><span class="s1">*(x[</span><span class="s2">0</span><span class="s1">]**</span><span class="s2">3 </span><span class="s1">+ x[</span><span class="s2">1</span><span class="s1">]**</span><span class="s2">2 </span><span class="s1">- </span><span class="s2">4</span><span class="s1">) - </span><span class="s2">3</span><span class="s1">*x[</span><span class="s2">0</span><span class="s1">]])</span>

    <span class="s0">def </span><span class="s1">jac(self</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">self.njev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s1">np.array([[</span><span class="s2">4</span><span class="s1">*x[</span><span class="s2">0</span><span class="s1">]-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">*x[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">12</span><span class="s1">*x[</span><span class="s2">0</span><span class="s1">]**</span><span class="s2">2</span><span class="s1">-</span><span class="s2">3</span><span class="s0">, </span><span class="s2">8</span><span class="s1">*x[</span><span class="s2">1</span><span class="s1">]]])</span>

    <span class="s0">def </span><span class="s1">hess(self</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">v):</span>
        <span class="s1">self.nhev += </span><span class="s2">1</span>
        <span class="s0">return </span><span class="s1">v[</span><span class="s2">0</span><span class="s1">]*</span><span class="s2">4</span><span class="s1">*np.eye(</span><span class="s2">2</span><span class="s1">) + v[</span><span class="s2">1</span><span class="s1">]*np.array([[</span><span class="s2">24</span><span class="s1">*x[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                                                 <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]])</span>


<span class="s0">class </span><span class="s1">TestVectorialFunction(TestCase):</span>

    <span class="s0">def </span><span class="s1">test_finite_difference_jac(self):</span>
        <span class="s1">ex = ExVectorialFunction()</span>
        <span class="s1">nfev = </span><span class="s2">0</span>
        <span class="s1">njev = </span><span class="s2">0</span>

        <span class="s1">x0 = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span>
        <span class="s1">analit = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">ex.jac</span><span class="s0">, </span><span class="s1">ex.hess</span><span class="s0">, None, None,</span>
                                <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">approx = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s3">'2-point'</span><span class="s0">, </span><span class="s1">ex.hess</span><span class="s0">, None, None,</span>
                                <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.f</span><span class="s0">, </span><span class="s1">approx.f)</span>
        <span class="s1">assert_array_almost_equal(analit.J</span><span class="s0">, </span><span class="s1">approx.J)</span>

        <span class="s1">x = [</span><span class="s2">10</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">J_analit = analit.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">J_approx = approx.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(J_analit</span><span class="s0">, </span><span class="s1">J_approx</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s2">4</span><span class="s1">)</span>

        <span class="s1">x = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span>
        <span class="s1">J_analit = analit.jac(x)</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">J_approx = approx.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_almost_equal(J_analit</span><span class="s0">, </span><span class="s1">J_approx)</span>

        <span class="s1">x = [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">J_analit = analit.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">J_approx = approx.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(J_analit</span><span class="s0">, </span><span class="s1">J_approx)</span>

        <span class="s1">x = [</span><span class="s2">2</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">f_analit = analit.fun(x)</span>
        <span class="s1">J_analit = analit.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">f_approx = approx.fun(x)</span>
        <span class="s1">J_approx = approx.jac(x)</span>
        <span class="s1">nfev += </span><span class="s2">3</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_almost_equal(f_analit</span><span class="s0">, </span><span class="s1">f_approx)</span>
        <span class="s1">assert_array_almost_equal(J_analit</span><span class="s0">, </span><span class="s1">J_approx)</span>

    <span class="s0">def </span><span class="s1">test_finite_difference_hess_linear_operator(self):</span>
        <span class="s1">ex = ExVectorialFunction()</span>
        <span class="s1">nfev = </span><span class="s2">0</span>
        <span class="s1">njev = </span><span class="s2">0</span>
        <span class="s1">nhev = </span><span class="s2">0</span>

        <span class="s1">x0 = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span>
        <span class="s1">v0 = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span>
        <span class="s1">analit = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">ex.jac</span><span class="s0">, </span><span class="s1">ex.hess</span><span class="s0">, None, None,</span>
                                <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">approx = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s1">ex.jac</span><span class="s0">, </span><span class="s3">'2-point'</span><span class="s0">, None, None,</span>
                                <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">assert_(isinstance(approx.H</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_equal(analit.f</span><span class="s0">, </span><span class="s1">approx.f)</span>
            <span class="s1">assert_array_almost_equal(analit.J</span><span class="s0">, </span><span class="s1">approx.J)</span>
            <span class="s1">assert_array_almost_equal(analit.H.dot(p)</span><span class="s0">, </span><span class="s1">approx.H.dot(p))</span>
        <span class="s1">nfev += </span><span class="s2">1</span>
        <span class="s1">njev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span>
        <span class="s1">H_analit = analit.hess(x</span><span class="s0">, </span><span class="s1">v0)</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">H_approx = approx.hess(x</span><span class="s0">, </span><span class="s1">v0)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">p </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(p)</span><span class="s0">, </span><span class="s1">H_approx.dot(p)</span><span class="s0">,</span>
                                      <span class="s1">decimal=</span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">njev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.1</span><span class="s0">, </span><span class="s2">1.2</span><span class="s1">]</span>
        <span class="s1">v = [</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">1.0</span><span class="s1">]</span>
        <span class="s1">H_analit = analit.hess(x</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">H_approx = approx.hess(x</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v))</span>
        <span class="s1">njev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">0.3</span><span class="s1">]</span>
        <span class="s1">_ = analit.jac(x)</span>
        <span class="s1">H_analit = analit.hess(x</span><span class="s0">, </span><span class="s1">v0)</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">_ = approx.jac(x)</span>
        <span class="s1">H_approx = approx.hess(x</span><span class="s0">, </span><span class="s1">v0)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s2">4</span><span class="s1">)</span>
        <span class="s1">njev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

        <span class="s1">x = [</span><span class="s2">5.2</span><span class="s0">, </span><span class="s2">2.3</span><span class="s1">]</span>
        <span class="s1">v = [</span><span class="s2">2.3</span><span class="s0">, </span><span class="s2">5.2</span><span class="s1">]</span>
        <span class="s1">_ = analit.jac(x)</span>
        <span class="s1">H_analit = analit.hess(x</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">njev += </span><span class="s2">1</span>
        <span class="s1">nhev += </span><span class="s2">1</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">_ = approx.jac(x)</span>
        <span class="s1">H_approx = approx.hess(x</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">assert_(isinstance(H_approx</span><span class="s0">, </span><span class="s1">LinearOperator))</span>
        <span class="s0">for </span><span class="s1">v </span><span class="s0">in </span><span class="s1">([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3.0</span><span class="s0">, </span><span class="s2">4.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5.0</span><span class="s0">, </span><span class="s2">2.0</span><span class="s1">]):</span>
            <span class="s1">assert_array_almost_equal(H_analit.dot(v)</span><span class="s0">, </span><span class="s1">H_approx.dot(v)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s2">4</span><span class="s1">)</span>
        <span class="s1">njev += </span><span class="s2">4</span>
        <span class="s1">assert_array_equal(ex.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(analit.nfev+approx.nfev</span><span class="s0">, </span><span class="s1">nfev)</span>
        <span class="s1">assert_array_equal(ex.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(analit.njev+approx.njev</span><span class="s0">, </span><span class="s1">njev)</span>
        <span class="s1">assert_array_equal(ex.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>
        <span class="s1">assert_array_equal(analit.nhev+approx.nhev</span><span class="s0">, </span><span class="s1">nhev)</span>

    <span class="s0">def </span><span class="s1">test_x_storage_overlap(self):</span>
        <span class="s4"># VectorFunction should not store references to arrays, it should</span>
        <span class="s4"># store copies - this checks that updating an array in-place causes</span>
        <span class="s4"># Scalar_Function.x to be updated.</span>
        <span class="s1">ex = ExVectorialFunction()</span>
        <span class="s1">x0 = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>

        <span class="s1">vf = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">, </span><span class="s1">ex.hess</span><span class="s0">, None, None,</span>
                            <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>
        <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
        <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>

        <span class="s1">x0[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">2.</span>
        <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
        <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>

        <span class="s1">x0[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">1.</span>
        <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
        <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>

        <span class="s4"># now test with a HessianUpdate strategy specified</span>
        <span class="s1">hess = BFGS()</span>
        <span class="s1">x0 = np.array([</span><span class="s2">1.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">vf = VectorFunction(ex.fun</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, </span><span class="s3">'3-point'</span><span class="s0">, </span><span class="s1">hess</span><span class="s0">, None, None,</span>
                            <span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, None</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
            <span class="s4"># filter UserWarning because ExVectorialFunction is linear and</span>
            <span class="s4"># a quasi-Newton approximation is used for the Hessian.</span>
            <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>
            <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
            <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>

            <span class="s1">x0[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">2.</span>
            <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
            <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>

            <span class="s1">x0[</span><span class="s2">0</span><span class="s1">] = </span><span class="s2">1.</span>
            <span class="s1">assert_equal(vf.fun(x0)</span><span class="s0">, </span><span class="s1">ex.fun(x0))</span>
            <span class="s0">assert </span><span class="s1">x0 </span><span class="s0">is not </span><span class="s1">vf.x</span>


<span class="s0">def </span><span class="s1">test_LinearVectorFunction():</span>
    <span class="s1">A_dense = np.array([</span>
        <span class="s1">[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
    <span class="s1">])</span>
    <span class="s1">x0 = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>
    <span class="s1">A_sparse = csr_matrix(A_dense)</span>
    <span class="s1">x = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">v = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">Ax = np.array([-</span><span class="s2">3</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s1">])</span>

    <span class="s1">f1 = LinearVectorFunction(A_dense</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">f1.sparse_jacobian)</span>

    <span class="s1">f2 = LinearVectorFunction(A_dense</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, True</span><span class="s1">)</span>
    <span class="s1">assert_(f2.sparse_jacobian)</span>

    <span class="s1">f3 = LinearVectorFunction(A_dense</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, False</span><span class="s1">)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">f3.sparse_jacobian)</span>

    <span class="s1">f4 = LinearVectorFunction(A_sparse</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">assert_(f4.sparse_jacobian)</span>

    <span class="s1">f5 = LinearVectorFunction(A_sparse</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, True</span><span class="s1">)</span>
    <span class="s1">assert_(f5.sparse_jacobian)</span>

    <span class="s1">f6 = LinearVectorFunction(A_sparse</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, False</span><span class="s1">)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">f6.sparse_jacobian)</span>

    <span class="s1">assert_array_equal(f1.fun(x)</span><span class="s0">, </span><span class="s1">Ax)</span>
    <span class="s1">assert_array_equal(f2.fun(x)</span><span class="s0">, </span><span class="s1">Ax)</span>
    <span class="s1">assert_array_equal(f1.jac(x)</span><span class="s0">, </span><span class="s1">A_dense)</span>
    <span class="s1">assert_array_equal(f2.jac(x).toarray()</span><span class="s0">, </span><span class="s1">A_sparse.toarray())</span>
    <span class="s1">assert_array_equal(f1.hess(x</span><span class="s0">, </span><span class="s1">v).toarray()</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_LinearVectorFunction_memoization():</span>
    <span class="s1">A = np.array([[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]])</span>
    <span class="s1">x0 = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">fun = LinearVectorFunction(A</span><span class="s0">, </span><span class="s1">x0</span><span class="s0">, False</span><span class="s1">)</span>

    <span class="s1">assert_array_equal(x0</span><span class="s0">, </span><span class="s1">fun.x)</span>
    <span class="s1">assert_array_equal(A.dot(x0)</span><span class="s0">, </span><span class="s1">fun.f)</span>

    <span class="s1">x1 = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">assert_array_equal(A</span><span class="s0">, </span><span class="s1">fun.jac(x1))</span>
    <span class="s1">assert_array_equal(x1</span><span class="s0">, </span><span class="s1">fun.x)</span>
    <span class="s1">assert_array_equal(A.dot(x0)</span><span class="s0">, </span><span class="s1">fun.f)</span>
    <span class="s1">assert_array_equal(A.dot(x1)</span><span class="s0">, </span><span class="s1">fun.fun(x1))</span>
    <span class="s1">assert_array_equal(A.dot(x1)</span><span class="s0">, </span><span class="s1">fun.f)</span>


<span class="s0">def </span><span class="s1">test_IdentityVectorFunction():</span>
    <span class="s1">x0 = np.zeros(</span><span class="s2">3</span><span class="s1">)</span>

    <span class="s1">f1 = IdentityVectorFunction(x0</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">f2 = IdentityVectorFunction(x0</span><span class="s0">, False</span><span class="s1">)</span>
    <span class="s1">f3 = IdentityVectorFunction(x0</span><span class="s0">, True</span><span class="s1">)</span>

    <span class="s1">assert_(f1.sparse_jacobian)</span>
    <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">f2.sparse_jacobian)</span>
    <span class="s1">assert_(f3.sparse_jacobian)</span>

    <span class="s1">x = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">v = np.array([-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

    <span class="s1">assert_array_equal(f1.fun(x)</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">assert_array_equal(f2.fun(x)</span><span class="s0">, </span><span class="s1">x)</span>

    <span class="s1">assert_array_equal(f1.jac(x).toarray()</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s2">3</span><span class="s1">))</span>
    <span class="s1">assert_array_equal(f2.jac(x)</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s2">3</span><span class="s1">))</span>

    <span class="s1">assert_array_equal(f1.hess(x</span><span class="s0">, </span><span class="s1">v).toarray()</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>
</pre>
</body>
</html>