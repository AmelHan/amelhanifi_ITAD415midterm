<html>
<head>
<title>test_predict_functional.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_predict_functional.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">statsmodels.sandbox.predict_functional </span><span class="s0">import </span><span class="s1">predict_functional</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">statsmodels.api </span><span class="s0">as </span><span class="s1">sm</span>

<span class="s2"># If true, the output is written to a multi-page pdf file.</span>
<span class="s1">pdf_output = </span><span class="s0">False</span>

<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s0">pass</span>

<span class="s0">def </span><span class="s1">pctl(q):</span>
    <span class="s0">return lambda </span><span class="s1">x : np.percentile(x</span><span class="s0">, </span><span class="s3">100 </span><span class="s1">*q)</span>


<span class="s0">class </span><span class="s1">TestPredFunc:</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s0">if </span><span class="s1">pdf_output:</span>
            <span class="s0">from </span><span class="s1">matplotlib.backends.backend_pdf </span><span class="s0">import </span><span class="s1">PdfPages</span>
            <span class="s1">cls.pdf = PdfPages(</span><span class="s4">&quot;predict_functional.pdf&quot;</span><span class="s1">)</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">teardown_class(cls):</span>
        <span class="s0">if </span><span class="s1">pdf_output:</span>
            <span class="s1">cls.pdf.close()</span>

    <span class="s0">def </span><span class="s1">close_or_save(self</span><span class="s0">, </span><span class="s1">fig):</span>
        <span class="s0">if </span><span class="s1">pdf_output:</span>
            <span class="s1">self.pdf.savefig(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_formula(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">542</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">500</span>
        <span class="s1">x1 = np.random.normal(size=n)</span>
        <span class="s1">x2 = np.random.normal(size=n)</span>
        <span class="s1">x3 = np.random.normal(size=n)</span>
        <span class="s1">x4 = np.random.randint(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">size=n)</span>
        <span class="s1">x4 = np.asarray([</span><span class="s4">&quot;ABCDE&quot;</span><span class="s1">[i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">x4])</span>
        <span class="s1">x5 = np.random.normal(size=n)</span>
        <span class="s1">y = </span><span class="s3">0.3</span><span class="s1">*x2**</span><span class="s3">2 </span><span class="s1">+ (x4 == </span><span class="s4">&quot;B&quot;</span><span class="s1">) + </span><span class="s3">0.1</span><span class="s1">*(x4 == </span><span class="s4">&quot;B&quot;</span><span class="s1">)*x2**</span><span class="s3">2 </span><span class="s1">+ x5 + np.random.normal(size=n)</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;y&quot;</span><span class="s1">: y</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s1">: x1</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: x2</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: x3</span><span class="s0">, </span><span class="s4">&quot;x4&quot;</span><span class="s1">: x4</span><span class="s0">, </span><span class="s4">&quot;x5&quot;</span><span class="s1">: x5})</span>

        <span class="s1">fml = </span><span class="s4">&quot;y ~ x1 + bs(x2, df=4) + x3 + x2*x3 + I(x1**2) + C(x4) + C(x4)*bs(x2, df=4) + x5&quot;</span>
        <span class="s1">model = sm.OLS.from_formula(fml</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">result = model.fit()</span>

        <span class="s1">summaries = {</span><span class="s4">&quot;x1&quot;</span><span class="s1">: np.mean</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: pctl(</span><span class="s3">0.75</span><span class="s1">)</span><span class="s0">, </span><span class="s4">&quot;x5&quot;</span><span class="s1">: np.mean}</span>

        <span class="s1">values = {</span><span class="s4">&quot;x4&quot;</span><span class="s1">: </span><span class="s4">&quot;B&quot;</span><span class="s1">}</span>
        <span class="s1">pr1</span><span class="s0">, </span><span class="s1">ci1</span><span class="s0">, </span><span class="s1">fvals1 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values)</span>

        <span class="s1">values = {</span><span class="s4">&quot;x4&quot;</span><span class="s1">: </span><span class="s4">&quot;C&quot;</span><span class="s1">}</span>
        <span class="s1">pr2</span><span class="s0">, </span><span class="s1">ci2</span><span class="s0">, </span><span class="s1">fvals2 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x4=B'</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x4=C'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted mean&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Linear model prediction&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x4=B'</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals1</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x4=C'</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals2</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted mean&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Linear model prediction&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_lm_contrast(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">542</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s1">x1 = np.random.normal(size=n)</span>
        <span class="s1">x2 = np.random.normal(size=n)</span>
        <span class="s1">x3 = np.random.normal(size=n)</span>
        <span class="s1">y = x1 + </span><span class="s3">2</span><span class="s1">*x2 + x3 - x1*x2 + x2*x3 + np.random.normal(size=n)</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;y&quot;</span><span class="s1">: y</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s1">: x1</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: x2</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: x3})</span>

        <span class="s1">fml = </span><span class="s4">&quot;y ~ x1 + x2 + x3 + x1*x2 + x2*x3&quot;</span>
        <span class="s1">model = sm.OLS.from_formula(fml</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">result = model.fit()</span>

        <span class="s1">values = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">} </span><span class="s2"># y = 4</span>
        <span class="s1">values2 = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">} </span><span class="s2"># y = x1</span>
        <span class="s1">pr</span><span class="s0">, </span><span class="s1">cb</span><span class="s0">, </span><span class="s1">fvals = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">values=values</span><span class="s0">,</span>
                                           <span class="s1">values2=values2</span><span class="s0">, </span><span class="s1">ci_method=</span><span class="s4">'scheffe'</span><span class="s1">)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.67</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals</span><span class="s0">, </span><span class="s1">pr</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">&quot;Estimate&quot;</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'orange'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals</span><span class="s0">, </span><span class="s3">4 </span><span class="s1">- fvals</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">&quot;Truth&quot;</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'lime'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals</span><span class="s0">, </span><span class="s1">cb[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cb[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">leg = plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">leg.draw_frame(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Mean contrast&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Linear model contrast&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_glm_formula_contrast(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">542</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">50</span>
        <span class="s1">x1 = np.random.normal(size=n)</span>
        <span class="s1">x2 = np.random.normal(size=n)</span>
        <span class="s1">x3 = np.random.normal(size=n)</span>
        <span class="s1">mn = </span><span class="s3">5 </span><span class="s1">+ </span><span class="s3">0.1</span><span class="s1">*x1 + </span><span class="s3">0.1</span><span class="s1">*x2 + </span><span class="s3">0.1</span><span class="s1">*x3 - </span><span class="s3">0.1</span><span class="s1">*x1*x2</span>
        <span class="s1">y = np.random.poisson(np.exp(mn)</span><span class="s0">, </span><span class="s1">size=len(mn))</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;y&quot;</span><span class="s1">: y</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s1">: x1</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: x2</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: x3})</span>

        <span class="s1">fml = </span><span class="s4">&quot;y ~ x1 + x2 + x3 + x1*x2&quot;</span>
        <span class="s1">model = sm.GLM.from_formula(fml</span><span class="s0">, </span><span class="s1">data=df</span><span class="s0">, </span><span class="s1">family=sm.families.Poisson())</span>
        <span class="s1">result = model.fit()</span>

        <span class="s1">values = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">} </span><span class="s2"># y = 5.2</span>
        <span class="s1">values2 = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">} </span><span class="s2"># y = 5 + 0.1*x1</span>
        <span class="s1">pr</span><span class="s0">, </span><span class="s1">cb</span><span class="s0">, </span><span class="s1">fvals = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">values=values</span><span class="s0">,</span>
                                           <span class="s1">values2=values2</span><span class="s0">, </span><span class="s1">ci_method=</span><span class="s4">'simultaneous'</span><span class="s1">)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.67</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals</span><span class="s0">, </span><span class="s1">pr</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">&quot;Estimate&quot;</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'orange'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals</span><span class="s0">, </span><span class="s3">0.2 </span><span class="s1">- </span><span class="s3">0.1</span><span class="s1">*fvals</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">&quot;Truth&quot;</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'lime'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals</span><span class="s0">, </span><span class="s1">cb[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cb[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">leg = plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">leg.draw_frame(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Linear predictor contrast&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Poisson regression contrast&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_scb(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">473</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s1">x = np.random.normal(size=(n</span><span class="s0">,</span><span class="s3">4</span><span class="s1">))</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">1</span>

        <span class="s0">for </span><span class="s1">fam_name </span><span class="s0">in </span><span class="s4">&quot;poisson&quot;</span><span class="s0">, </span><span class="s4">&quot;binomial&quot;</span><span class="s0">, </span><span class="s4">&quot;gaussian&quot;</span><span class="s1">:</span>

            <span class="s0">if </span><span class="s1">fam_name == </span><span class="s4">&quot;poisson&quot;</span><span class="s1">:</span>
                <span class="s1">y = np.random.poisson(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">size=n)</span>
                <span class="s1">fam = sm.families.Poisson()</span>
                <span class="s1">true_mean = </span><span class="s3">20</span>
                <span class="s1">true_lp = np.log(</span><span class="s3">20</span><span class="s1">)</span>
            <span class="s0">elif </span><span class="s1">fam_name == </span><span class="s4">&quot;binomial&quot;</span><span class="s1">:</span>
                <span class="s1">y = </span><span class="s3">1 </span><span class="s1">* (np.random.uniform(size=n) &lt; </span><span class="s3">0.5</span><span class="s1">)</span>
                <span class="s1">fam = sm.families.Binomial()</span>
                <span class="s1">true_mean = </span><span class="s3">0.5</span>
                <span class="s1">true_lp = </span><span class="s3">0</span>
            <span class="s0">elif </span><span class="s1">fam_name == </span><span class="s4">&quot;gaussian&quot;</span><span class="s1">:</span>
                <span class="s1">y = np.random.normal(size=n)</span>
                <span class="s1">fam = sm.families.Gaussian()</span>
                <span class="s1">true_mean = </span><span class="s3">0</span>
                <span class="s1">true_lp = </span><span class="s3">0</span>

            <span class="s1">model = sm.GLM(y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">family=fam)</span>
            <span class="s1">result = model.fit()</span>

            <span class="s2"># CB is for linear predictor or mean response</span>
            <span class="s0">for </span><span class="s1">linear </span><span class="s0">in False, True</span><span class="s1">:</span>

                <span class="s1">true = true_lp </span><span class="s0">if </span><span class="s1">linear </span><span class="s0">else </span><span class="s1">true_mean</span>

                <span class="s1">values = {</span><span class="s4">'const'</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span>
                <span class="s1">summaries = {</span><span class="s4">&quot;x3&quot;</span><span class="s1">: np.mean}</span>
                <span class="s1">pred1</span><span class="s0">, </span><span class="s1">cb1</span><span class="s0">, </span><span class="s1">fvals1 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">,</span>
                            <span class="s1">values=values</span><span class="s0">, </span><span class="s1">summaries=summaries</span><span class="s0">, </span><span class="s1">linear=linear)</span>
                <span class="s1">pred2</span><span class="s0">, </span><span class="s1">cb2</span><span class="s0">, </span><span class="s1">fvals2 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">,</span>
                            <span class="s1">values=values</span><span class="s0">, </span><span class="s1">summaries=summaries</span><span class="s0">,</span>
                            <span class="s1">ci_method=</span><span class="s4">'simultaneous'</span><span class="s0">, </span><span class="s1">linear=linear)</span>

                <span class="s1">plt.clf()</span>
                <span class="s1">fig = plt.figure()</span>
                <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.58</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
                <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pred1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'black'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'Estimate'</span><span class="s1">)</span>
                <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">true * np.ones(len(pred1))</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'purple'</span><span class="s0">,</span>
                         <span class="s1">label=</span><span class="s4">'Truth'</span><span class="s1">)</span>
                <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">cb1[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'blue'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'Pointwise CB'</span><span class="s1">)</span>
                <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">cb1[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'blue'</span><span class="s1">)</span>
                <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">cb2[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'green'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'Simultaneous CB'</span><span class="s1">)</span>
                <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">cb2[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'green'</span><span class="s1">)</span>
                <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
                <span class="s1">leg = plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
                <span class="s1">leg.draw_frame(</span><span class="s0">False</span><span class="s1">)</span>
                <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
                <span class="s0">if </span><span class="s1">linear:</span>
                    <span class="s1">plt.ylabel(</span><span class="s4">&quot;Linear predictor&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted mean&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
                <span class="s1">plt.title(</span><span class="s4">&quot;%s family prediction&quot; </span><span class="s1">% fam_name.capitalize())</span>

                <span class="s1">self.close_or_save(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_glm_formula(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">542</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">500</span>
        <span class="s1">x1 = np.random.normal(size=n)</span>
        <span class="s1">x2 = np.random.normal(size=n)</span>
        <span class="s1">x3 = np.random.randint(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">size=n)</span>
        <span class="s1">x3 = np.asarray([</span><span class="s4">&quot;ABC&quot;</span><span class="s1">[i] </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">x3])</span>
        <span class="s1">lin_pred = -</span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.5</span><span class="s1">*x1**</span><span class="s3">2 </span><span class="s1">+ (x3 == </span><span class="s4">&quot;B&quot;</span><span class="s1">)</span>
        <span class="s1">prob = </span><span class="s3">1 </span><span class="s1">/ (</span><span class="s3">1 </span><span class="s1">+ np.exp(-lin_pred))</span>
        <span class="s1">y = </span><span class="s3">1 </span><span class="s1">* (np.random.uniform(size=n) &lt; prob)</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s4">&quot;y&quot;</span><span class="s1">: y</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s1">: x1</span><span class="s0">, </span><span class="s4">&quot;x2&quot;</span><span class="s1">: x2</span><span class="s0">, </span><span class="s4">&quot;x3&quot;</span><span class="s1">: x3})</span>

        <span class="s1">fml = </span><span class="s4">&quot;y ~ x1 + I(x1**2) + x2 + C(x3)&quot;</span>
        <span class="s1">model = sm.GLM.from_formula(fml</span><span class="s0">, </span><span class="s1">family=sm.families.Binomial()</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">result = model.fit()</span>
        <span class="s1">summaries = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: np.mean}</span>

        <span class="s0">for </span><span class="s1">linear </span><span class="s0">in False, True</span><span class="s1">:</span>

            <span class="s1">values = {</span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s4">&quot;B&quot;</span><span class="s1">}</span>
            <span class="s1">pr1</span><span class="s0">, </span><span class="s1">ci1</span><span class="s0">, </span><span class="s1">fvals1 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">linear=linear)</span>

            <span class="s1">values = {</span><span class="s4">&quot;x3&quot;</span><span class="s1">: </span><span class="s4">&quot;C&quot;</span><span class="s1">}</span>
            <span class="s1">pr2</span><span class="s0">, </span><span class="s1">ci2</span><span class="s0">, </span><span class="s1">fvals2 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values</span><span class="s0">, </span><span class="s1">linear=linear)</span>

            <span class="s1">exact1 = -</span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.5</span><span class="s1">*fvals1**</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1</span>
            <span class="s1">exact2 = -</span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.5</span><span class="s1">*fvals2**</span><span class="s3">2</span>

            <span class="s0">if not </span><span class="s1">linear:</span>
                <span class="s1">exact1 = </span><span class="s3">1 </span><span class="s1">/ (</span><span class="s3">1 </span><span class="s1">+ np.exp(-exact1))</span>
                <span class="s1">exact2 = </span><span class="s3">1 </span><span class="s1">/ (</span><span class="s3">1 </span><span class="s1">+ np.exp(-exact2))</span>

            <span class="s1">plt.clf()</span>
            <span class="s1">fig = plt.figure()</span>
            <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
            <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=B'</span><span class="s1">)</span>
            <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=C'</span><span class="s1">)</span>
            <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">exact1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=B (exact)'</span><span class="s1">)</span>
            <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">exact2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=C (exact)'</span><span class="s1">)</span>
            <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
            <span class="s1">plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
            <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">linear:</span>
                <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted linear predictor&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted probability&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s1">plt.title(</span><span class="s4">&quot;Binomial GLM prediction&quot;</span><span class="s1">)</span>
            <span class="s1">self.close_or_save(fig)</span>

            <span class="s1">plt.clf()</span>
            <span class="s1">fig = plt.figure()</span>
            <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
            <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=B'</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'orange'</span><span class="s1">)</span>
            <span class="s1">plt.fill_between(fvals1</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
            <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x3=C'</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'lime'</span><span class="s1">)</span>
            <span class="s1">plt.fill_between(fvals2</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
            <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
            <span class="s1">plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
            <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s0">if </span><span class="s1">linear:</span>
                <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted linear predictor&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted probability&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
            <span class="s1">plt.title(</span><span class="s4">&quot;Binomial GLM prediction&quot;</span><span class="s1">)</span>
            <span class="s1">self.close_or_save(fig)</span>

    <span class="s1">@pytest.mark.matplotlib</span>
    <span class="s0">def </span><span class="s1">test_noformula_prediction(self</span><span class="s0">, </span><span class="s1">close_figures):</span>

        <span class="s1">np.random.seed(</span><span class="s3">6434</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s1">x1 = np.random.normal(size=n)</span>
        <span class="s1">x2 = np.random.normal(size=n)</span>
        <span class="s1">x3 = np.random.normal(size=n)</span>
        <span class="s1">y = x1 - x2 + np.random.normal(size=n)</span>

        <span class="s1">exog = np.vstack((x1</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">x3)).T</span>

        <span class="s1">model = sm.OLS(y</span><span class="s0">, </span><span class="s1">exog)</span>
        <span class="s1">result = model.fit()</span>

        <span class="s1">summaries = {</span><span class="s4">&quot;x3&quot;</span><span class="s1">: pctl(</span><span class="s3">0.75</span><span class="s1">)}</span>
        <span class="s1">values = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span>
        <span class="s1">pr1</span><span class="s0">, </span><span class="s1">ci1</span><span class="s0">, </span><span class="s1">fvals1 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values)</span>

        <span class="s1">values = {</span><span class="s4">&quot;x2&quot;</span><span class="s1">: -</span><span class="s3">1</span><span class="s1">}</span>
        <span class="s1">pr2</span><span class="s0">, </span><span class="s1">ci2</span><span class="s0">, </span><span class="s1">fvals2 = predict_functional(result</span><span class="s0">, </span><span class="s4">&quot;x1&quot;</span><span class="s0">, </span><span class="s1">summaries</span><span class="s0">, </span><span class="s1">values)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x2=1'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s3">0.6</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'orange'</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals2</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x2=-1'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s3">0.6</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'lime'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">leg = plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">leg.draw_frame(</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted mean&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Linear model prediction&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>

        <span class="s1">plt.clf()</span>
        <span class="s1">fig = plt.figure()</span>
        <span class="s1">ax = plt.axes([</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.7</span><span class="s0">, </span><span class="s3">0.8</span><span class="s1">])</span>
        <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr1</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x2=1'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s3">0.6</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'orange'</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals1</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci1[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">plt.plot(fvals1</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s4">'-'</span><span class="s0">, </span><span class="s1">label=</span><span class="s4">'x2=1'</span><span class="s0">, </span><span class="s1">lw=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">alpha=</span><span class="s3">0.6</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'lime'</span><span class="s1">)</span>
        <span class="s1">plt.fill_between(fvals2</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ci2[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">color=</span><span class="s4">'grey'</span><span class="s1">)</span>
        <span class="s1">ha</span><span class="s0">, </span><span class="s1">lb = ax.get_legend_handles_labels()</span>
        <span class="s1">plt.figlegend(ha</span><span class="s0">, </span><span class="s1">lb</span><span class="s0">, </span><span class="s1">loc=</span><span class="s4">&quot;center right&quot;</span><span class="s1">)</span>
        <span class="s1">plt.xlabel(</span><span class="s4">&quot;Focus variable&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.ylabel(</span><span class="s4">&quot;Fitted mean&quot;</span><span class="s0">, </span><span class="s1">size=</span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">plt.title(</span><span class="s4">&quot;Linear model prediction&quot;</span><span class="s1">)</span>
        <span class="s1">self.close_or_save(fig)</span>
</pre>
</body>
</html>