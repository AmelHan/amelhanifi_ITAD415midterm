<html>
<head>
<title>test_fixed_params.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_fixed_params.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot; 
Tests for fixing the values of some parameters and estimating others 
 
Author: Chad Fulton 
License: Simplified-BSD 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">__future__ </span><span class="s2">import </span><span class="s1">division</span><span class="s2">, </span><span class="s1">absolute_import</span><span class="s2">, </span><span class="s1">print_function</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">statsmodels </span><span class="s2">import </span><span class="s1">datasets</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.statespace </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">initialization</span><span class="s2">, </span><span class="s1">mlemodel</span><span class="s2">, </span><span class="s1">sarimax</span><span class="s2">, </span><span class="s1">structural</span><span class="s2">, </span><span class="s1">dynamic_factor</span><span class="s2">, </span><span class="s1">varmax)</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">assert_</span><span class="s2">, </span><span class="s1">assert_raises</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">, </span><span class="s1">assert_allclose</span>

<span class="s1">macrodata = datasets.macrodata.load_pandas().data</span>


<span class="s2">def </span><span class="s1">test_fix_params():</span>
    <span class="s3"># Just create a dummy model to test the basic `fix_params` mechanics</span>
    <span class="s1">mod = mlemodel.MLEModel([]</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">mod._param_names = [</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'c'</span><span class="s1">]</span>
    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'b'</span><span class="s1">: </span><span class="s4">1.</span><span class="s1">}):</span>
        <span class="s1">assert_(mod._has_fixed_params)</span>
        <span class="s1">assert_equal(mod._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'b'</span><span class="s1">: </span><span class="s4">1.</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">mod._has_fixed_params)</span>
    <span class="s1">assert_equal(mod._fixed_params</span><span class="s2">, </span><span class="s1">{})</span>
    <span class="s1">assert_equal(mod._fixed_params_index</span><span class="s2">, None</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod._free_params_index</span><span class="s2">, None</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_nested_fix_params():</span>
    <span class="s1">mod = mlemodel.MLEModel([]</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">mod._param_names = [</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'c'</span><span class="s1">]</span>
    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'a'</span><span class="s1">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">'b'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}):</span>
        <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'b'</span><span class="s1">: </span><span class="s4">1.</span><span class="s1">}):</span>
            <span class="s1">assert_(mod._has_fixed_params)</span>
            <span class="s1">assert_equal(mod._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'a'</span><span class="s1">: </span><span class="s4">2</span><span class="s2">, </span><span class="s5">'b'</span><span class="s1">: </span><span class="s4">1.</span><span class="s1">})</span>
            <span class="s1">assert_equal(mod._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_(</span><span class="s2">not </span><span class="s1">mod._has_fixed_params)</span>
    <span class="s1">assert_equal(mod._fixed_params</span><span class="s2">, </span><span class="s1">{})</span>
    <span class="s1">assert_equal(mod._fixed_params_index</span><span class="s2">, None</span><span class="s1">)</span>
    <span class="s1">assert_equal(mod._free_params_index</span><span class="s2">, None</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_results_append():</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>
    <span class="s1">endog1 = endog.iloc[:</span><span class="s4">100</span><span class="s1">]</span>
    <span class="s1">endog2 = endog.iloc[</span><span class="s4">100</span><span class="s1">:]</span>

    <span class="s1">mod_full = sarimax.SARIMAX(endog)</span>
    <span class="s2">with </span><span class="s1">mod_full.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">res_full = mod_full.smooth([</span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s3"># Start pretty close to optimum to speed up test</span>
        <span class="s1">start_params = [</span><span class="s4">10.3</span><span class="s1">]</span>
        <span class="s1">res_full_fit = mod_full.fit(start_params</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">mod = sarimax.SARIMAX(endog1)</span>
    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">res1 = mod.smooth([</span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Append should work outside the context manager, since the results object</span>
    <span class="s3"># was created with fixed parameters</span>
    <span class="s1">res2 = res1.append(endog2)</span>

    <span class="s3"># Test to make sure refit works with fixed parameters</span>
    <span class="s1">res2_fit = res1.append(endog2</span><span class="s2">, </span><span class="s1">refit=</span><span class="s2">True, </span><span class="s1">fit_kwargs={</span>
        <span class="s5">'disp'</span><span class="s1">: </span><span class="s2">False, </span><span class="s5">'start_params'</span><span class="s1">: res_full_fit.params})</span>

    <span class="s3"># Check non-refit</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">res_full.params)</span>
    <span class="s1">assert_equal(res2._fixed_params</span><span class="s2">, </span><span class="s1">res_full._fixed_params)</span>
    <span class="s1">assert_allclose(res2.llf_obs</span><span class="s2">, </span><span class="s1">res_full.llf_obs)</span>

    <span class="s3"># Check refit results</span>
    <span class="s1">assert_allclose(res2_fit.params</span><span class="s2">, </span><span class="s1">res_full_fit.params)</span>
    <span class="s1">assert_equal(res2_fit._fixed_params</span><span class="s2">, </span><span class="s1">res_full_fit._fixed_params)</span>
    <span class="s1">assert_allclose(res2_fit.llf_obs</span><span class="s2">, </span><span class="s1">res_full_fit.llf_obs)</span>


<span class="s2">def </span><span class="s1">test_results_extend():</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>
    <span class="s1">endog1 = endog.iloc[:</span><span class="s4">100</span><span class="s1">]</span>
    <span class="s1">endog2 = endog.iloc[</span><span class="s4">100</span><span class="s1">:]</span>

    <span class="s1">mod_full = sarimax.SARIMAX(endog)</span>
    <span class="s2">with </span><span class="s1">mod_full.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">res_full = mod_full.smooth([</span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">mod = sarimax.SARIMAX(endog1)</span>
    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">res1 = mod.smooth([</span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Append should work outside the context manager, since the results object</span>
    <span class="s3"># was created with fixed parameters</span>
    <span class="s1">res2 = res1.append(endog2)</span>

    <span class="s3"># Check results</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">res_full.params)</span>
    <span class="s1">assert_equal(res2._fixed_params</span><span class="s2">, </span><span class="s1">res_full._fixed_params)</span>
    <span class="s1">assert_allclose(res2.llf_obs</span><span class="s2">, </span><span class="s1">res_full.llf_obs)</span>


<span class="s2">def </span><span class="s1">test_results_apply():</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>

    <span class="s1">mod = sarimax.SARIMAX(endog)</span>
    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">res = mod.smooth([</span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s3"># Start pretty close to optimum to speed up test</span>
        <span class="s1">start_params = [</span><span class="s4">10.3</span><span class="s1">]</span>
        <span class="s1">res_fit = mod.fit(start_params</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s1">res2 = res.apply(endog)</span>

    <span class="s3"># Test to make sure refit works with fixed parameters</span>
    <span class="s1">res2_fit = res.apply(endog</span><span class="s2">, </span><span class="s1">refit=</span><span class="s2">True, </span><span class="s1">fit_kwargs={</span>
        <span class="s5">'disp'</span><span class="s1">: </span><span class="s2">False, </span><span class="s5">'start_params'</span><span class="s1">: res_fit.params})</span>

    <span class="s3"># Check non-refit</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">res.params)</span>
    <span class="s1">assert_equal(res2._fixed_params</span><span class="s2">, </span><span class="s1">res._fixed_params)</span>
    <span class="s1">assert_allclose(res2.llf_obs</span><span class="s2">, </span><span class="s1">res.llf_obs)</span>

    <span class="s3"># Check refit results</span>
    <span class="s1">assert_allclose(res2_fit.params</span><span class="s2">, </span><span class="s1">res_fit.params)</span>
    <span class="s1">assert_equal(res2_fit._fixed_params</span><span class="s2">, </span><span class="s1">res_fit._fixed_params)</span>
    <span class="s1">assert_allclose(res2_fit.llf_obs</span><span class="s2">, </span><span class="s1">res_fit.llf_obs)</span>


<span class="s2">def </span><span class="s1">test_mle_validate():</span>
    <span class="s1">mod = mlemodel.MLEModel([]</span><span class="s2">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">mod._param_names = [</span><span class="s5">'a'</span><span class="s2">, </span><span class="s5">'b'</span><span class="s2">, </span><span class="s5">'c'</span><span class="s1">]</span>
    <span class="s1">msg = </span><span class="s5">'Invalid parameter name passed: &quot;d&quot;'</span>

    <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=msg):</span>
        <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'d'</span><span class="s1">: </span><span class="s4">1</span><span class="s1">}):</span>
            <span class="s2">pass</span>


<span class="s2">def </span><span class="s1">test_sarimax_validate():</span>
    <span class="s3"># Test for invalid uses of parameter fixing</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>
    <span class="s1">mod1 = sarimax.SARIMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">))</span>

    <span class="s3"># Try to fix invalid parameter</span>
    <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">mod1.fit_constrained</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'AR.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">})</span>

    <span class="s3"># Cannot fix individual parameters that are part of a multivariate</span>
    <span class="s3"># transformation</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
            <span class="s2">pass</span>
    <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">mod1.fit_constrained</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">})</span>

    <span class="s3"># But can fix the entire set of parameters that are part of a multivariate</span>
    <span class="s3"># transformation</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">])</span>

    <span class="s1">res = mod1.fit_constrained({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}</span><span class="s2">,</span>
                               <span class="s1">start_params=[</span><span class="s4">7.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res._has_fixed_params)</span>
    <span class="s1">assert_equal(res._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
    <span class="s1">assert_equal(res._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(res._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">])</span>

    <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.</span><span class="s1">}):</span>
        <span class="s3"># overwrite ar.L2 with nested fix_params</span>
        <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}):</span>
            <span class="s1">assert_(mod1._has_fixed_params)</span>
            <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
            <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_structural_validate():</span>
    <span class="s3"># Test for invalid uses of parameter fixing</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>
    <span class="s1">mod1 = structural.UnobservedComponents(endog</span><span class="s2">, </span><span class="s5">'rwalk'</span><span class="s2">, </span><span class="s1">autoregressive=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s3"># Try to fix invalid parameter</span>
    <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">mod1.fit_constrained</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'AR.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">})</span>

    <span class="s3"># Cannot fix parameters that are part of a multivariate transformation</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
            <span class="s2">pass</span>
    <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">mod1.fit_constrained</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">})</span>

    <span class="s3"># But can fix the entire set of parameters that are part of a multivariate</span>
    <span class="s3"># transformation</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">res = mod1.fit_constrained({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}</span><span class="s2">,</span>
                               <span class="s1">start_params=[</span><span class="s4">7.0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res._has_fixed_params)</span>
    <span class="s1">assert_equal(res._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
    <span class="s1">assert_equal(res._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s1">assert_equal(res._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>

    <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.</span><span class="s1">}):</span>
        <span class="s3"># overwrite ar.L2 with nested fix_params</span>
        <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">}):</span>
            <span class="s1">assert_(mod1._has_fixed_params)</span>
            <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s1">})</span>
            <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_dynamic_factor_validate():</span>
    <span class="s3"># Test for invalid uses of parameter fixing</span>
    <span class="s1">endog = np.log(macrodata[[</span><span class="s5">'cpi'</span><span class="s2">, </span><span class="s5">'realgdp'</span><span class="s2">, </span><span class="s5">'realinv'</span><span class="s1">]]).diff().iloc[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">endog = (endog - endog.mean()) / endog.std()</span>

    <span class="s3"># Basic model</span>
    <span class="s1">mod1 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s1">)</span>

    <span class="s3"># Check loading</span>
    <span class="s1">constraints = {</span><span class="s5">'loading.f1.cpi'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params(constraints):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">])</span>
    <span class="s1">res1 = mod1.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res1._has_fixed_params)</span>
    <span class="s1">assert_equal(res1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">assert_equal(res1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s1">])</span>

    <span class="s3"># With k_factors=1 and factor_order=1, we can fix the factor AR coefficient</span>
    <span class="s3"># even with `enforce_stationarity=True`.</span>
    <span class="s3"># Fix factor AR coefficient</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">6</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>

    <span class="s3"># With k_factors &gt; 1 or factor_order &gt; 1, we can only fix the entire set of</span>
    <span class="s3"># factor AR coefficients when `enforce_stationarity=True`.</span>
    <span class="s1">mod2 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod2.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
            <span class="s2">pass</span>

    <span class="s1">constraints = {</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'L2.f1.f1'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params(constraints):</span>
        <span class="s1">assert_(mod2._has_fixed_params)</span>
        <span class="s1">assert_equal(mod2._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod2._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod2._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>

    <span class="s1">res2 = mod2.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res2._has_fixed_params)</span>
    <span class="s1">assert_equal(res2._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res2._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s1">])</span>
    <span class="s1">assert_equal(res2._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>

    <span class="s2">with </span><span class="s1">mod2.fix_params(constraints):</span>
        <span class="s3"># overwrite L1.f1.f1 with nested fix_params</span>
        <span class="s2">with </span><span class="s1">mod2.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: -</span><span class="s4">0.3</span><span class="s1">}):</span>
            <span class="s1">assert_(mod2._has_fixed_params)</span>
            <span class="s1">assert_equal(</span>
                <span class="s1">mod2._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.f1.f1'</span><span class="s1">: -</span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'L2.f1.f1'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s1">}</span>
            <span class="s1">)</span>
            <span class="s1">assert_equal(mod2._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod2._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>

    <span class="s3"># (same as previous, now k_factors=2)</span>
    <span class="s1">mod3 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod3.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.3</span><span class="s1">}):</span>
            <span class="s2">pass</span>

    <span class="s1">constraints = dict([(</span><span class="s5">'L1.f1.f1'</span><span class="s2">, </span><span class="s4">0.3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">'L1.f2.f1'</span><span class="s2">, </span><span class="s4">0.1</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">(</span><span class="s5">'L1.f1.f2'</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.05</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">'L1.f2.f2'</span><span class="s2">, </span><span class="s4">0.1</span><span class="s1">)])</span>
    <span class="s2">with </span><span class="s1">mod3.fix_params(constraints):</span>
        <span class="s1">assert_(mod3._has_fixed_params)</span>
        <span class="s1">assert_equal(mod3._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s1">res3 = mod3.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res3._has_fixed_params)</span>
    <span class="s1">assert_equal(res3._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>
    <span class="s1">assert_equal(res3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s2">with </span><span class="s1">mod3.fix_params(constraints):</span>
        <span class="s3"># overwrite L1.f1.f1 and L1.f2.f2 with nested fix_params</span>
        <span class="s2">with </span><span class="s1">mod3.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: -</span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'L1.f2.f2'</span><span class="s1">: -</span><span class="s4">0.1</span><span class="s1">}):</span>
            <span class="s1">assert_(mod3._has_fixed_params)</span>
            <span class="s1">assert_equal(</span>
                <span class="s1">mod3._fixed_params</span><span class="s2">,</span>
                <span class="s1">dict([(</span><span class="s5">'L1.f1.f1'</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">'L1.f2.f1'</span><span class="s2">, </span><span class="s4">0.1</span><span class="s1">)</span><span class="s2">,</span>
                      <span class="s1">(</span><span class="s5">'L1.f1.f2'</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.05</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">'L1.f2.f2'</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.1</span><span class="s1">)])</span>
            <span class="s1">)</span>
            <span class="s1">assert_equal(mod3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s3"># Now, with enforce_stationarity=False, we can fix any of the factor AR</span>
    <span class="s3"># coefficients</span>
    <span class="s1">mod4 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s2">,</span>
        <span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">mod4.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">}):</span>
        <span class="s1">assert_(mod4._has_fixed_params)</span>
        <span class="s1">assert_equal(mod4._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod4._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">6</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod4._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">7</span><span class="s1">])</span>

    <span class="s1">mod5 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">2</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s2">,</span>
        <span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">mod5.fix_params({</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">}):</span>
        <span class="s1">assert_(mod5._has_fixed_params)</span>
        <span class="s1">assert_equal(mod5._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.f1.f1'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod5._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">9</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod5._free_params_index</span><span class="s2">,</span>
                     <span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>

    <span class="s3"># Check error variance</span>
    <span class="s3"># (mod1 has error_cov_type='diagonal', so we can fix any that we like)</span>
    <span class="s1">constraints = {</span><span class="s5">'sigma2.cpi'</span><span class="s1">: </span><span class="s4">0.9</span><span class="s2">, </span><span class="s5">'sigma2.realinv'</span><span class="s1">: </span><span class="s4">3</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params(constraints):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s1">])</span>
    <span class="s1">res1 = mod1.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res1._has_fixed_params)</span>
    <span class="s1">assert_equal(res1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">3</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">assert_equal(res1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">6</span><span class="s1">])</span>

    <span class="s3"># Check unstructured error variance</span>
    <span class="s3"># (also reduce k_endog and fix some other parameters to make MLE go faster)</span>
    <span class="s1">mod6 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog[[</span><span class="s5">'cpi'</span><span class="s2">, </span><span class="s5">'realgdp'</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">,</span>
        <span class="s1">error_cov_type=</span><span class="s5">'unstructured'</span><span class="s1">)</span>
    <span class="s1">constraints = {</span>
        <span class="s5">'loading.f1.cpi'</span><span class="s1">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'loading.f1.realgdp'</span><span class="s1">: </span><span class="s4">1.</span><span class="s2">, </span><span class="s5">'cov.chol[1,1]'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">,</span>
        <span class="s5">'cov.chol[2,1]'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod6.fix_params(constraints):</span>
        <span class="s1">assert_(mod6._has_fixed_params)</span>
        <span class="s1">assert_equal(mod6._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod6._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod6._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">res6 = mod6.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res6._has_fixed_params)</span>
    <span class="s1">assert_equal(res6._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res6._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>
    <span class="s1">assert_equal(res6._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_varmax_validate():</span>
    <span class="s3"># Test for invalid uses of parameter fixing</span>
    <span class="s1">endog = np.log(macrodata[[</span><span class="s5">'cpi'</span><span class="s2">, </span><span class="s5">'realgdp'</span><span class="s1">]]).diff().iloc[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">exog = np.log(macrodata[[</span><span class="s5">'realinv'</span><span class="s1">]]).diff().iloc[</span><span class="s4">1</span><span class="s1">:]</span>

    <span class="s3"># Basic model, VAR(1) + exog + measurement error</span>
    <span class="s1">mod1 = varmax.VARMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exog=exog</span><span class="s2">,</span>
                         <span class="s1">measurement_error=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Check intercept, exog</span>
    <span class="s1">constraints = {</span><span class="s5">'intercept.cpi'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s2">, </span><span class="s5">'intercept.realgdp'</span><span class="s1">: </span><span class="s4">1.1</span><span class="s2">,</span>
                   <span class="s5">'beta.realinv.cpi'</span><span class="s1">: </span><span class="s4">0.2</span><span class="s2">, </span><span class="s5">'beta.realinv.realgdp'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s2">,</span>
                   <span class="s5">'sqrt.var.cpi'</span><span class="s1">: </span><span class="s4">1.2</span><span class="s2">, </span><span class="s5">'sqrt.cov.cpi.realgdp'</span><span class="s1">: -</span><span class="s4">0.1</span><span class="s2">,</span>
                   <span class="s5">'sqrt.var.realgdp'</span><span class="s1">: </span><span class="s4">2.3</span><span class="s2">, </span><span class="s5">'measurement_variance.cpi'</span><span class="s1">: </span><span class="s4">0.4</span><span class="s2">,</span>
                   <span class="s5">'measurement_variance.realgdp'</span><span class="s1">: </span><span class="s4">0.4</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod1.fix_params(constraints):</span>
        <span class="s1">assert_(mod1._has_fixed_params)</span>
        <span class="s1">assert_equal(mod1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">res1 = mod1.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res1._has_fixed_params)</span>
    <span class="s1">assert_equal(res1._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res1._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s2">, </span><span class="s4">9</span><span class="s2">, </span><span class="s4">10</span><span class="s2">, </span><span class="s4">11</span><span class="s2">, </span><span class="s4">12</span><span class="s1">])</span>
    <span class="s1">assert_equal(res1._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>

    <span class="s3"># With k_endog=1 we can fix the factor AR coefficient</span>
    <span class="s3"># even with `enforce_stationarity=True`.</span>
    <span class="s3"># Fix factor AR coefficient</span>
    <span class="s1">mod2 = varmax.VARMAX(endog[[</span><span class="s5">'cpi'</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">exog=exog</span><span class="s2">,</span>
                         <span class="s1">measurement_error=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">constraints = {</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params(constraints):</span>
        <span class="s1">assert_(mod2._has_fixed_params)</span>
        <span class="s1">assert_equal(mod2._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod2._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod2._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s1">])</span>

    <span class="s3"># With k_ar &gt; 1, we can only fix the entire set of AR coefficients when</span>
    <span class="s3"># `enforce_stationarity=True`.</span>
    <span class="s1">mod3 = varmax.VARMAX(endog[[</span><span class="s5">'cpi'</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">2</span><span class="s2">, </span><span class="s4">0</span><span class="s1">))</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod3.fix_params({</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
            <span class="s2">pass</span>

    <span class="s1">constraints = {</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'L2.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s1">}</span>
    <span class="s2">with </span><span class="s1">mod3.fix_params(constraints):</span>
        <span class="s1">assert_(mod3._has_fixed_params)</span>
        <span class="s1">assert_equal(mod3._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>

    <span class="s1">res3 = mod3.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">start_params=[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1.</span><span class="s1">]</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res3._has_fixed_params)</span>
    <span class="s1">assert_equal(res3._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">assert_equal(res3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>

    <span class="s2">with </span><span class="s1">mod3.fix_params(constraints):</span>
        <span class="s3"># overwrite L1.cpi.cpi with nested fix_params</span>
        <span class="s2">with </span><span class="s1">mod3.fix_params({</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: -</span><span class="s4">0.3</span><span class="s1">}):</span>
            <span class="s1">assert_(mod3._has_fixed_params)</span>
            <span class="s1">assert_equal(</span>
                <span class="s1">mod3._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: -</span><span class="s4">0.3</span><span class="s2">, </span><span class="s5">'L2.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.1</span><span class="s1">}</span>
            <span class="s1">)</span>
            <span class="s1">assert_equal(mod3._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>
            <span class="s1">assert_equal(mod3._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">3</span><span class="s1">])</span>

    <span class="s3"># With k_endog &gt; 1, we can only fix the entire set of AR coefficients when</span>
    <span class="s3"># `enforce_stationarity=True`.</span>
    <span class="s1">mod4 = varmax.VARMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">))</span>
    <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s2">with </span><span class="s1">mod4.fix_params({</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.3</span><span class="s1">}):</span>
            <span class="s2">pass</span>
    <span class="s1">constraints = dict([(</span><span class="s5">'L1.cpi.cpi'</span><span class="s2">, </span><span class="s4">0.3</span><span class="s1">)</span><span class="s2">, </span><span class="s1">(</span><span class="s5">'L1.realgdp.cpi'</span><span class="s2">, </span><span class="s4">0.1</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">(</span><span class="s5">'L1.cpi.realgdp'</span><span class="s2">, </span><span class="s1">-</span><span class="s4">0.05</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">(</span><span class="s5">'L1.realgdp.realgdp'</span><span class="s2">, </span><span class="s4">0.1</span><span class="s1">)])</span>
    <span class="s2">with </span><span class="s1">mod4.fix_params(constraints):</span>
        <span class="s1">assert_(mod4._has_fixed_params)</span>
        <span class="s1">assert_equal(mod4._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
        <span class="s1">assert_equal(mod4._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod4._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>
    <span class="s1">res4 = mod4.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_(res4._has_fixed_params)</span>
    <span class="s1">assert_equal(res4._fixed_params</span><span class="s2">, </span><span class="s1">constraints)</span>
    <span class="s1">assert_equal(res4._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s1">])</span>
    <span class="s1">assert_equal(res4._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s3"># Now, with enforce_stationarity=False, we can fix any of the AR</span>
    <span class="s3"># coefficients</span>
    <span class="s1">mod5 = varmax.VARMAX(endog[[</span><span class="s5">'cpi'</span><span class="s1">]]</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                         <span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">mod5.fix_params({</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">}):</span>
        <span class="s1">assert_(mod5._has_fixed_params)</span>
        <span class="s1">assert_equal(mod5._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod5._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod5._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">2</span><span class="s1">])</span>

    <span class="s3"># Now, with enforce_stationarity=False, we can fix any of the AR</span>
    <span class="s3"># coefficients</span>
    <span class="s1">mod6 = varmax.VARMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                         <span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">mod6.fix_params({</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">}):</span>
        <span class="s1">assert_(mod6._has_fixed_params)</span>
        <span class="s1">assert_equal(mod6._fixed_params</span><span class="s2">, </span><span class="s1">{</span><span class="s5">'L1.cpi.cpi'</span><span class="s1">: </span><span class="s4">0.6</span><span class="s1">})</span>
        <span class="s1">assert_equal(mod6._fixed_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(mod6._free_params_index</span><span class="s2">, </span><span class="s1">[</span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s2">, </span><span class="s4">3</span><span class="s2">, </span><span class="s4">4</span><span class="s2">, </span><span class="s4">5</span><span class="s2">, </span><span class="s4">6</span><span class="s2">, </span><span class="s4">7</span><span class="s2">, </span><span class="s4">8</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">check_results(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">check_lutkepohl=</span><span class="s2">False, </span><span class="s1">check_params=</span><span class="s2">True</span><span class="s1">):</span>
    <span class="s3"># Check other results</span>
    <span class="s1">assert_allclose(res2.nobs</span><span class="s2">, </span><span class="s1">res1.nobs)</span>
    <span class="s1">assert_allclose(res2.nobs_diffuse</span><span class="s2">, </span><span class="s1">res1.nobs_diffuse)</span>
    <span class="s1">assert_allclose(res2.nobs_effective</span><span class="s2">, </span><span class="s1">res1.nobs_effective)</span>
    <span class="s1">assert_allclose(res2.k_diffuse_states</span><span class="s2">, </span><span class="s1">res1.k_diffuse_states)</span>

    <span class="s1">assert_allclose(res2.df_model</span><span class="s2">, </span><span class="s1">res1.df_model)</span>
    <span class="s1">assert_allclose(res2.df_resid</span><span class="s2">, </span><span class="s1">res1.df_resid)</span>

    <span class="s1">assert_allclose(res2.llf</span><span class="s2">, </span><span class="s1">res1.llf)</span>
    <span class="s1">assert_allclose(res2.aic</span><span class="s2">, </span><span class="s1">res1.aic)</span>
    <span class="s1">assert_allclose(res2.bic</span><span class="s2">, </span><span class="s1">res1.bic)</span>
    <span class="s1">assert_allclose(res2.hqic</span><span class="s2">, </span><span class="s1">res1.hqic)</span>

    <span class="s2">if </span><span class="s1">check_lutkepohl:</span>
        <span class="s1">assert_allclose(res2.info_criteria(</span><span class="s5">'aic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">res1.info_criteria(</span><span class="s5">'aic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">))</span>
        <span class="s1">assert_allclose(res2.info_criteria(</span><span class="s5">'bic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">res1.info_criteria(</span><span class="s5">'bic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">))</span>
        <span class="s1">assert_allclose(res2.info_criteria(</span><span class="s5">'hqic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">)</span><span class="s2">,</span>
                        <span class="s1">res1.info_criteria(</span><span class="s5">'hqic'</span><span class="s2">, </span><span class="s5">'lutkepohl'</span><span class="s1">))</span>

    <span class="s1">assert_allclose(res2.llf_obs</span><span class="s2">, </span><span class="s1">res1.llf_obs)</span>
    <span class="s1">assert_allclose(res2.fittedvalues</span><span class="s2">, </span><span class="s1">res1.fittedvalues)</span>
    <span class="s1">assert_allclose(res2.fittedvalues</span><span class="s2">, </span><span class="s1">res1.fittedvalues)</span>

    <span class="s2">if </span><span class="s1">check_params:</span>
        <span class="s3"># Check parameter-related values</span>
        <span class="s1">mask_free = res2._free_params_index</span>
        <span class="s1">mask_fixed = res2._fixed_params_index</span>
        <span class="s1">assert_allclose(res2.pvalues[mask_free]</span><span class="s2">, </span><span class="s1">res1.pvalues)</span>
        <span class="s1">assert_allclose(res2.pvalues[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.bse[mask_free]</span><span class="s2">, </span><span class="s1">res1.bse)</span>
        <span class="s1">assert_allclose(res2.bse[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.zvalues[mask_free]</span><span class="s2">, </span><span class="s1">res1.zvalues)</span>
        <span class="s1">assert_allclose(res2.zvalues[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s3"># Check parameter covariance matrix</span>
        <span class="s1">mask_free = np.ix_(res2._free_params_index</span><span class="s2">, </span><span class="s1">res2._free_params_index)</span>
        <span class="s1">mask_fixed = np.ix_(res2._fixed_params_index</span><span class="s2">, </span><span class="s1">res2._fixed_params_index)</span>
        <span class="s1">assert_allclose(res2.cov_params_default.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_default)</span>
        <span class="s1">assert_allclose(res2.cov_params_default.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_approx.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_approx)</span>
        <span class="s1">assert_allclose(res2.cov_params_approx.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_oim.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_oim)</span>
        <span class="s1">assert_allclose(res2.cov_params_oim.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_opg.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_opg)</span>
        <span class="s1">assert_allclose(res2.cov_params_opg.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_robust.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_robust)</span>
        <span class="s1">assert_allclose(res2.cov_params_robust.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_robust_oim.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_robust_oim)</span>
        <span class="s1">assert_allclose(res2.cov_params_robust_oim.values[mask_fixed]</span><span class="s2">, </span><span class="s1">np.nan)</span>

        <span class="s1">assert_allclose(res2.cov_params_robust_approx.values[mask_free]</span><span class="s2">,</span>
                        <span class="s1">res1.cov_params_robust_approx)</span>
        <span class="s1">assert_allclose(res2.cov_params_robust_approx.values[mask_fixed]</span><span class="s2">,</span>
                        <span class="s1">np.nan)</span>

    <span class="s3"># Check residual hypothesis tests</span>
    <span class="s1">assert_allclose(res2.test_normality(</span><span class="s5">'jarquebera'</span><span class="s1">)</span><span class="s2">,</span>
                    <span class="s1">res1.test_normality(</span><span class="s5">'jarquebera'</span><span class="s1">))</span>

    <span class="s1">assert_allclose(res2.test_heteroskedasticity(</span><span class="s5">'breakvar'</span><span class="s1">)</span><span class="s2">,</span>
                    <span class="s1">res1.test_heteroskedasticity(</span><span class="s5">'breakvar'</span><span class="s1">))</span>

    <span class="s1">actual = res2.test_serial_correlation(</span><span class="s5">'ljungbox'</span><span class="s1">)</span>
    <span class="s1">desired = res1.test_serial_correlation(</span><span class="s5">'ljungbox'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(actual</span><span class="s2">, </span><span class="s1">desired)</span>


<span class="s2">def </span><span class="s1">test_sarimax_nonconsecutive():</span>
    <span class="s3"># SARIMAX allows using non-consecutive lag orders, which implicitly fix</span>
    <span class="s3"># AR coefficients to zeros, so we can test explicitly fixed AR coefficients</span>
    <span class="s3"># against this</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>

    <span class="s3"># y_t = \phi_1 y_{t-1} + \phi_4 y_{t-4} + \varepsilon_t</span>
    <span class="s3"># Note: because the transformation will not respect the parameter</span>
    <span class="s3"># constraints, we will need to set enforce_stationarity=False; set it to</span>
    <span class="s3"># False here too so that they both are the same model</span>
    <span class="s1">mod1 = sarimax.SARIMAX(endog</span><span class="s2">, </span><span class="s1">order=([</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">1</span><span class="s1">]</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">,</span>
                           <span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">mod2 = sarimax.SARIMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">4</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">enforce_stationarity=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Start pretty close to optimum to speed up test</span>
    <span class="s1">start_params = [</span><span class="s4">0.6</span><span class="s2">, </span><span class="s4">0.2</span><span class="s2">, </span><span class="s4">6.4</span><span class="s1">]</span>
    <span class="s1">res1 = mod1.fit(start_params</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res2 = mod2.fit_constrained({</span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">'ar.L3'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span><span class="s2">, </span><span class="s1">res1.params</span><span class="s2">,</span>
                                <span class="s1">includes_fixed=</span><span class="s2">False, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check that the right parameters were fixed</span>
    <span class="s1">assert_equal(res1.fixed_params</span><span class="s2">, </span><span class="s1">[])</span>
    <span class="s1">assert_equal(res2.fixed_params</span><span class="s2">, </span><span class="s1">[</span><span class="s5">'ar.L2'</span><span class="s2">, </span><span class="s5">'ar.L3'</span><span class="s1">])</span>

    <span class="s3"># Check that MLE finds the same parameters in either case</span>
    <span class="s1">desired = np.r_[res1.params[</span><span class="s4">0</span><span class="s1">]</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">res1.params[</span><span class="s4">1</span><span class="s1">:]]</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Now smooth at the actual parameters (to allow high precision testing</span>
    <span class="s3"># below, even if there are small differences between MLE fitted parameters)</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params({</span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">'ar.L3'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}):</span>
        <span class="s1">res2 = mod2.smooth(res1.params)</span>

    <span class="s1">check_results(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">check_lutkepohl=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s3"># Check that results methods work within the context</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params({</span><span class="s5">'ar.L2'</span><span class="s1">: </span><span class="s4">0</span><span class="s2">, </span><span class="s5">'ar.L3'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}):</span>
        <span class="s1">res3 = mod2.filter(res2.params</span><span class="s2">, </span><span class="s1">includes_fixed=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">check_results(res1</span><span class="s2">, </span><span class="s1">res3</span><span class="s2">, </span><span class="s1">check_lutkepohl=</span><span class="s2">True</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_structural():</span>
    <span class="s3"># Many of the forms of UnobservedComponents are just special cases of the</span>
    <span class="s3"># most general model with parameter restrictions</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>

    <span class="s3"># Local linear trend is a pretty general model, so we can test fixing</span>
    <span class="s3"># parameters against other more specific models</span>

    <span class="s3"># Local level is local linear trend with sigma2.trend = 0</span>
    <span class="s1">mod1 = structural.UnobservedComponents(endog</span><span class="s2">, </span><span class="s5">'llevel'</span><span class="s1">)</span>
    <span class="s1">mod2 = structural.UnobservedComponents(endog</span><span class="s2">, </span><span class="s5">'lltrend'</span><span class="s1">)</span>

    <span class="s3"># Note: have to reinitialize, so the estimate of the trend term stays at</span>
    <span class="s3"># zero.</span>
    <span class="s1">init = initialization.Initialization(mod2.k_states)</span>
    <span class="s1">init[</span><span class="s4">0</span><span class="s1">] = </span><span class="s5">'approximate_diffuse'</span>
    <span class="s1">init.set(</span><span class="s4">1</span><span class="s2">, </span><span class="s5">'known'</span><span class="s2">, </span><span class="s1">constant=[</span><span class="s4">0</span><span class="s1">])</span>
    <span class="s1">mod2.ssm.initialization = init</span>
    <span class="s1">mod2.ssm.loglikelihood_burn = </span><span class="s4">1</span>

    <span class="s1">constraints = {</span><span class="s5">'sigma2.trend'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span>

    <span class="s3"># Start pretty close to optimum to speed up test</span>
    <span class="s1">start_params = [</span><span class="s4">3.37</span><span class="s2">, </span><span class="s4">0.74</span><span class="s1">]</span>
    <span class="s1">res1 = mod1.fit(start_params</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res2 = mod2.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">start_params=res1.params</span><span class="s2">,</span>
                                <span class="s1">includes_fixed=</span><span class="s2">False, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check that the right parameters were fixed</span>
    <span class="s1">assert_equal(res1.fixed_params</span><span class="s2">, </span><span class="s1">[])</span>
    <span class="s1">assert_equal(res2.fixed_params</span><span class="s2">, </span><span class="s1">[</span><span class="s5">'sigma2.trend'</span><span class="s1">])</span>

    <span class="s3"># Check that MLE finds the same parameters in either case</span>
    <span class="s1">desired = np.r_[res1.params</span><span class="s2">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">desired)</span>

    <span class="s3"># Now smooth at the actual parameters (to allow high precision testing</span>
    <span class="s3"># below, even if there are small differences between MLE fitted parameters)</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params(constraints):</span>
        <span class="s1">res2 = mod2.smooth(res1.params)</span>

    <span class="s1">check_results(res1</span><span class="s2">, </span><span class="s1">res2)</span>


<span class="s2">def </span><span class="s1">test_dynamic_factor_diag_error_cov():</span>
    <span class="s3"># Can test fixing the off-diagonal error covariance parameters to zeros</span>
    <span class="s3"># with `error_cov_type='unstructured'` against the case</span>
    <span class="s3"># `error_cov_type='diagonal'`.</span>
    <span class="s1">endog = np.log(macrodata[[</span><span class="s5">'cpi'</span><span class="s2">, </span><span class="s5">'realgdp'</span><span class="s1">]]).diff().iloc[</span><span class="s4">1</span><span class="s1">:]</span>
    <span class="s1">endog = (endog - endog.mean()) / endog.std()</span>

    <span class="s3"># Basic model</span>
    <span class="s1">mod1 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'diagonal'</span><span class="s1">)</span>
    <span class="s1">mod2 = dynamic_factor.DynamicFactor(</span>
        <span class="s1">endog</span><span class="s2">, </span><span class="s1">k_factors=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">factor_order=</span><span class="s4">1</span><span class="s2">, </span><span class="s1">error_cov_type=</span><span class="s5">'unstructured'</span><span class="s1">)</span>

    <span class="s1">constraints = {</span><span class="s5">'cov.chol[2,1]'</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span>

    <span class="s3"># Start pretty close to optimum to speed up test</span>
    <span class="s1">start_params = [-</span><span class="s4">4.5e-06</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1.0e-05</span><span class="s2">, </span><span class="s4">9.9e-01</span><span class="s2">, </span><span class="s4">9.9e-01</span><span class="s2">, </span><span class="s1">-</span><span class="s4">1.4e-01</span><span class="s1">]</span>
    <span class="s1">res1 = mod1.fit(start_params=start_params</span><span class="s2">, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res2 = mod2.fit_constrained(constraints</span><span class="s2">, </span><span class="s1">start_params=res1.params</span><span class="s2">,</span>
                                <span class="s1">includes_fixed=</span><span class="s2">False, </span><span class="s1">disp=</span><span class="s2">False</span><span class="s1">)</span>

    <span class="s3"># Check that the right parameters were fixed</span>
    <span class="s1">assert_equal(res1.fixed_params</span><span class="s2">, </span><span class="s1">[])</span>
    <span class="s1">assert_equal(res2.fixed_params</span><span class="s2">, </span><span class="s1">[</span><span class="s5">'cov.chol[2,1]'</span><span class="s1">])</span>

    <span class="s3"># Check that MLE finds the same parameters in either case</span>
    <span class="s3"># (need to account for the fact that diagonal params are variances but</span>
    <span class="s3"># unstructured params are standard deviations)</span>
    <span class="s1">params = np.r_[res1.params[:</span><span class="s4">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1.params[</span><span class="s4">2</span><span class="s1">:</span><span class="s4">4</span><span class="s1">]**</span><span class="s4">0.5</span><span class="s2">, </span><span class="s1">res1.params[</span><span class="s4">4</span><span class="s1">]]</span>
    <span class="s1">desired = np.r_[params[:</span><span class="s4">3</span><span class="s1">]</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s1">params[</span><span class="s4">3</span><span class="s1">:]]</span>
    <span class="s1">assert_allclose(res2.params</span><span class="s2">, </span><span class="s1">desired</span><span class="s2">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>

    <span class="s3"># Now smooth at the actual parameters (to allow high precision testing</span>
    <span class="s3"># below, even if there are small differences between MLE fitted parameters)</span>
    <span class="s2">with </span><span class="s1">mod2.fix_params(constraints):</span>
        <span class="s1">res2 = mod2.smooth(params)</span>

    <span class="s3"># Can't check some parameters-related values because of the different</span>
    <span class="s3"># parameterization (i.e. cov_params, bse, pvalues, etc. won't match).</span>
    <span class="s1">check_results(res1</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">check_params=</span><span class="s2">False</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_score_shape():</span>
    <span class="s3"># Test that the `score()` output for fixed params has the same shape as the</span>
    <span class="s3"># input vector</span>
    <span class="s1">endog = macrodata[</span><span class="s5">'infl'</span><span class="s1">]</span>

    <span class="s1">mod = sarimax.SARIMAX(endog</span><span class="s2">, </span><span class="s1">order=(</span><span class="s4">1</span><span class="s2">, </span><span class="s4">0</span><span class="s2">, </span><span class="s4">0</span><span class="s1">))</span>

    <span class="s2">with </span><span class="s1">mod.fix_params({</span><span class="s5">'ar.L1'</span><span class="s1">: </span><span class="s4">0.5</span><span class="s1">}):</span>
        <span class="s1">score = mod.score([</span><span class="s4">1.0</span><span class="s1">])</span>

    <span class="s1">assert_equal(score.shape</span><span class="s2">, </span><span class="s1">(</span><span class="s4">1</span><span class="s2">,</span><span class="s1">))</span>
</pre>
</body>
</html>