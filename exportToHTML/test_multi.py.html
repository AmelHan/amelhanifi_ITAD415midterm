<html>
<head>
<title>test_multi.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_multi.py</font>
</center></td></tr></table>
<pre><span class="s0">'''Tests for multipletests and fdr pvalue corrections 
 
Author : Josef Perktold 
 
 
['b', 's', 'sh', 'hs', 'h', 'fdr_i', 'fdr_n', 'fdr_tsbh'] 
are tested against R:multtest 
 
'hommel' is tested against R stats p_adjust (not available in multtest 
 
'fdr_gbs', 'fdr_2sbky' I did not find them in R, currently tested for 
    consistency only 
 
'''</span>
<span class="s2">import </span><span class="s1">pytest</span>
<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">(assert_almost_equal</span><span class="s2">, </span><span class="s1">assert_equal</span><span class="s2">,</span>
                           <span class="s1">assert_allclose)</span>

<span class="s2">from </span><span class="s1">statsmodels.stats.multitest </span><span class="s2">import </span><span class="s1">(multipletests</span><span class="s2">, </span><span class="s1">fdrcorrection</span><span class="s2">,</span>
                                         <span class="s1">fdrcorrection_twostage</span><span class="s2">,</span>
                                         <span class="s1">NullDistribution</span><span class="s2">,</span>
                                         <span class="s1">local_fdr</span><span class="s2">, </span><span class="s1">multitest_methods_names)</span>
<span class="s2">from </span><span class="s1">statsmodels.stats.multicomp </span><span class="s2">import </span><span class="s1">tukeyhsd</span>
<span class="s2">from </span><span class="s1">scipy.stats.distributions </span><span class="s2">import </span><span class="s1">norm</span>
<span class="s2">import </span><span class="s1">scipy</span>
<span class="s2">from </span><span class="s1">packaging </span><span class="s2">import </span><span class="s1">version</span>

<span class="s1">pval0 = np.array([</span>
    <span class="s3">0.838541367553</span><span class="s2">,  </span><span class="s3">0.642193923795</span><span class="s2">,  </span><span class="s3">0.680845947633</span><span class="s2">,</span>
    <span class="s3">0.967833824309</span><span class="s2">,  </span><span class="s3">0.71626938238</span><span class="s2">,  </span><span class="s3">0.177096952723</span><span class="s2">,  </span><span class="s3">5.23656777208e-005</span><span class="s2">,</span>
    <span class="s3">0.0202732688798</span><span class="s2">,  </span><span class="s3">0.00028140506198</span><span class="s2">,  </span><span class="s3">0.0149877310796</span><span class="s1">])</span>

<span class="s1">res_multtest1 = np.array([</span>
    <span class="s1">[</span><span class="s3">5.2365677720800003e-05</span><span class="s2">,   </span><span class="s3">5.2365677720800005e-04</span><span class="s2">,</span>
     <span class="s3">5.2365677720800005e-04</span><span class="s2">,   </span><span class="s3">5.2365677720800005e-04</span><span class="s2">,</span>
     <span class="s3">5.2353339704891422e-04</span><span class="s2">,   </span><span class="s3">5.2353339704891422e-04</span><span class="s2">,</span>
     <span class="s3">5.2365677720800005e-04</span><span class="s2">,   </span><span class="s3">1.5337740764175588e-03</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">2.8140506198000000e-04</span><span class="s2">,   </span><span class="s3">2.8140506197999998e-03</span><span class="s2">,</span>
     <span class="s3">2.5326455578199999e-03</span><span class="s2">,   </span><span class="s3">2.5326455578199999e-03</span><span class="s2">,</span>
     <span class="s3">2.8104897961789277e-03</span><span class="s2">,   </span><span class="s3">2.5297966317768816e-03</span><span class="s2">,</span>
     <span class="s3">1.4070253098999999e-03</span><span class="s2">,   </span><span class="s3">4.1211324652269442e-03</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">1.4987731079600001e-02</span><span class="s2">,   </span><span class="s3">1.4987731079600000e-01</span><span class="s2">,</span>
     <span class="s3">1.1990184863680001e-01</span><span class="s2">,   </span><span class="s3">1.1990184863680001e-01</span><span class="s2">,</span>
     <span class="s3">1.4016246580579017e-01</span><span class="s2">,   </span><span class="s3">1.1379719679449507e-01</span><span class="s2">,</span>
     <span class="s3">4.9959103598666670e-02</span><span class="s2">,   </span><span class="s3">1.4632862843720582e-01</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">2.0273268879800001e-02</span><span class="s2">,   </span><span class="s3">2.0273268879799999e-01</span><span class="s2">,</span>
     <span class="s3">1.4191288215860001e-01</span><span class="s2">,   </span><span class="s3">1.4191288215860001e-01</span><span class="s2">,</span>
     <span class="s3">1.8520270949069695e-01</span><span class="s2">,   </span><span class="s3">1.3356756197485375e-01</span><span class="s2">,</span>
     <span class="s3">5.0683172199499998e-02</span><span class="s2">,   </span><span class="s3">1.4844940238274187e-01</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">1.7709695272300000e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">8.5760763426056130e-01</span><span class="s2">,   </span><span class="s3">6.8947825122356643e-01</span><span class="s2">,</span>
     <span class="s3">3.5419390544599999e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">6.4219392379499995e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">9.9996560644133570e-01</span><span class="s2">,   </span><span class="s3">9.9413539782557070e-01</span><span class="s2">,</span>
     <span class="s3">8.9533672797500008e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">6.8084594763299999e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">9.9998903512635740e-01</span><span class="s2">,   </span><span class="s3">9.9413539782557070e-01</span><span class="s2">,</span>
     <span class="s3">8.9533672797500008e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">7.1626938238000004e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">9.9999661886871472e-01</span><span class="s2">,   </span><span class="s3">9.9413539782557070e-01</span><span class="s2">,</span>
     <span class="s3">8.9533672797500008e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">8.3854136755300002e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">9.9999998796038225e-01</span><span class="s2">,   </span><span class="s3">9.9413539782557070e-01</span><span class="s2">,</span>
     <span class="s3">9.3171263061444454e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]</span><span class="s2">,</span>
    <span class="s1">[</span><span class="s3">9.6783382430900000e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s2">,</span>
     <span class="s3">1.0000000000000000e+00</span><span class="s2">,   </span><span class="s3">9.6783382430900000e-01</span><span class="s2">,</span>
     <span class="s3">9.9999999999999878e-01</span><span class="s2">,   </span><span class="s3">9.9413539782557070e-01</span><span class="s2">,</span>
     <span class="s3">9.6783382430900000e-01</span><span class="s2">,   </span><span class="s3">1.0000000000000000e+00</span><span class="s1">]])</span>


<span class="s1">res_multtest2_columns = [</span>
    <span class="s4">'rawp'</span><span class="s2">, </span><span class="s4">'Bonferroni'</span><span class="s2">, </span><span class="s4">'Holm'</span><span class="s2">, </span><span class="s4">'Hochberg'</span><span class="s2">, </span><span class="s4">'SidakSS'</span><span class="s2">, </span><span class="s4">'SidakSD'</span><span class="s2">,</span>
    <span class="s4">'BH'</span><span class="s2">, </span><span class="s4">'BY'</span><span class="s2">, </span><span class="s4">'ABH'</span><span class="s2">, </span><span class="s4">'TSBH_0.05'</span><span class="s1">]</span>

<span class="s1">rmethods = {</span>
    <span class="s4">'rawp'</span><span class="s1">: (</span><span class="s3">0</span><span class="s2">, </span><span class="s4">'pval'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'Bonferroni'</span><span class="s1">: (</span><span class="s3">1</span><span class="s2">, </span><span class="s4">'b'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'Holm'</span><span class="s1">: (</span><span class="s3">2</span><span class="s2">, </span><span class="s4">'h'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'Hochberg'</span><span class="s1">: (</span><span class="s3">3</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'SidakSS'</span><span class="s1">: (</span><span class="s3">4</span><span class="s2">, </span><span class="s4">'s'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'SidakSD'</span><span class="s1">: (</span><span class="s3">5</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'BH'</span><span class="s1">: (</span><span class="s3">6</span><span class="s2">, </span><span class="s4">'fdr_i'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'BY'</span><span class="s1">: (</span><span class="s3">7</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s1">)</span><span class="s2">,</span>
    <span class="s4">'TSBH_0.05'</span><span class="s1">: (</span><span class="s3">9</span><span class="s2">, </span><span class="s4">'fdr_tsbh'</span><span class="s1">)</span>
<span class="s1">}</span>

<span class="s1">NA = np.nan</span>
<span class="s5"># all rejections, except for Bonferroni and Sidak</span>
<span class="s1">res_multtest2 = np.array([</span>
     <span class="s3">0.002</span><span class="s2">, </span><span class="s3">0.004</span><span class="s2">, </span><span class="s3">0.006</span><span class="s2">, </span><span class="s3">0.008</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.036</span><span class="s2">, </span><span class="s3">0.048</span><span class="s2">,</span>
     <span class="s3">0.06</span><span class="s2">, </span><span class="s3">0.072</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.02</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">,</span>
     <span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.01194015976019192</span><span class="s2">, </span><span class="s3">0.02376127616613988</span><span class="s2">,</span>
     <span class="s3">0.03546430060660932</span><span class="s2">, </span><span class="s3">0.04705017875634587</span><span class="s2">, </span><span class="s3">0.058519850599</span><span class="s2">,</span>
     <span class="s3">0.06987425045000606</span><span class="s2">, </span><span class="s3">0.01194015976019192</span><span class="s2">, </span><span class="s3">0.01984063872102404</span><span class="s2">,</span>
     <span class="s3">0.02378486270400004</span><span class="s2">, </span><span class="s3">0.023808512</span><span class="s2">, </span><span class="s3">0.023808512</span><span class="s2">, </span><span class="s3">0.023808512</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">,</span>
     <span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.012</span><span class="s2">, </span><span class="s3">0.0294</span><span class="s2">, </span><span class="s3">0.0294</span><span class="s2">, </span><span class="s3">0.0294</span><span class="s2">, </span><span class="s3">0.0294</span><span class="s2">,</span>
     <span class="s3">0.0294</span><span class="s2">, </span><span class="s3">0.0294</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span>
    <span class="s1">]).reshape(</span><span class="s3">6</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>

<span class="s1">res_multtest3 = np.array([</span>
     <span class="s3">0.001</span><span class="s2">, </span><span class="s3">0.002</span><span class="s2">, </span><span class="s3">0.003</span><span class="s2">, </span><span class="s3">0.004</span><span class="s2">, </span><span class="s3">0.005</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.06</span><span class="s2">, </span><span class="s3">0.07</span><span class="s2">, </span><span class="s3">0.08</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">,</span>
     <span class="s3">0.02</span><span class="s2">, </span><span class="s3">0.03</span><span class="s2">, </span><span class="s3">0.04</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.6</span><span class="s2">, </span><span class="s3">0.7</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.9</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.018</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">,</span>
     <span class="s3">0.028</span><span class="s2">, </span><span class="s3">0.03</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.25</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.018</span><span class="s2">, </span><span class="s3">0.024</span><span class="s2">, </span><span class="s3">0.028</span><span class="s2">,</span>
     <span class="s3">0.03</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">, </span><span class="s3">0.00995511979025177</span><span class="s2">,</span>
     <span class="s3">0.01982095664805061</span><span class="s2">, </span><span class="s3">0.02959822305108317</span><span class="s2">, </span><span class="s3">0.03928762649718986</span><span class="s2">,</span>
     <span class="s3">0.04888986953422814</span><span class="s2">, </span><span class="s3">0.4012630607616213</span><span class="s2">, </span><span class="s3">0.4613848859051006</span><span class="s2">,</span>
     <span class="s3">0.5160176928207072</span><span class="s2">, </span><span class="s3">0.5656115457763677</span><span class="s2">, </span><span class="s3">0.6105838818818925</span><span class="s2">,</span>
     <span class="s3">0.00995511979025177</span><span class="s2">, </span><span class="s3">0.0178566699880266</span><span class="s2">, </span><span class="s3">0.02374950634358763</span><span class="s2">,</span>
     <span class="s3">0.02766623106147537</span><span class="s2">, </span><span class="s3">0.02962749064373438</span><span class="s2">, </span><span class="s3">0.2262190625000001</span><span class="s2">,</span>
     <span class="s3">0.2262190625000001</span><span class="s2">, </span><span class="s3">0.2262190625000001</span><span class="s2">, </span><span class="s3">0.2262190625000001</span><span class="s2">,</span>
     <span class="s3">0.2262190625000001</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.08333333333333334</span><span class="s2">,</span>
     <span class="s3">0.0857142857142857</span><span class="s2">, </span><span class="s3">0.0875</span><span class="s2">, </span><span class="s3">0.0888888888888889</span><span class="s2">, </span><span class="s3">0.09</span><span class="s2">,</span>
     <span class="s3">0.02928968253968254</span><span class="s2">, </span><span class="s3">0.02928968253968254</span><span class="s2">, </span><span class="s3">0.02928968253968254</span><span class="s2">,</span>
     <span class="s3">0.02928968253968254</span><span class="s2">, </span><span class="s3">0.02928968253968254</span><span class="s2">, </span><span class="s3">0.2440806878306878</span><span class="s2">,</span>
     <span class="s3">0.2510544217687075</span><span class="s2">, </span><span class="s3">0.2562847222222222</span><span class="s2">, </span><span class="s3">0.2603527336860670</span><span class="s2">,</span>
     <span class="s3">0.2636071428571428</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s1">NA</span><span class="s2">, </span><span class="s3">0.005</span><span class="s2">,</span>
     <span class="s3">0.005</span><span class="s2">, </span><span class="s3">0.005</span><span class="s2">, </span><span class="s3">0.005</span><span class="s2">, </span><span class="s3">0.005</span><span class="s2">, </span><span class="s3">0.04166666666666667</span><span class="s2">, </span><span class="s3">0.04285714285714286</span><span class="s2">,</span>
     <span class="s3">0.04375</span><span class="s2">, </span><span class="s3">0.04444444444444445</span><span class="s2">, </span><span class="s3">0.045</span>
    <span class="s1">]).reshape(</span><span class="s3">10</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>

<span class="s1">res0_large = np.array([</span>
     <span class="s3">0.00031612</span><span class="s2">, </span><span class="s3">0.0003965</span><span class="s2">, </span><span class="s3">0.00048442</span><span class="s2">, </span><span class="s3">0.00051932</span><span class="s2">, </span><span class="s3">0.00101436</span><span class="s2">, </span><span class="s3">0.00121506</span><span class="s2">,</span>
     <span class="s3">0.0014516</span><span class="s2">, </span><span class="s3">0.00265684</span><span class="s2">, </span><span class="s3">0.00430043</span><span class="s2">, </span><span class="s3">0.01743686</span><span class="s2">, </span><span class="s3">0.02080285</span><span class="s2">, </span><span class="s3">0.02785414</span><span class="s2">,</span>
     <span class="s3">0.0327198</span><span class="s2">, </span><span class="s3">0.03494679</span><span class="s2">, </span><span class="s3">0.04206808</span><span class="s2">, </span><span class="s3">0.08067095</span><span class="s2">, </span><span class="s3">0.23882767</span><span class="s2">, </span><span class="s3">0.28352304</span><span class="s2">,</span>
     <span class="s3">0.36140401</span><span class="s2">, </span><span class="s3">0.43565145</span><span class="s2">, </span><span class="s3">0.44866768</span><span class="s2">, </span><span class="s3">0.45368782</span><span class="s2">, </span><span class="s3">0.48282088</span><span class="s2">,</span>
     <span class="s3">0.49223781</span><span class="s2">, </span><span class="s3">0.55451638</span><span class="s2">, </span><span class="s3">0.6207473</span><span class="s2">, </span><span class="s3">0.71847853</span><span class="s2">, </span><span class="s3">0.72424145</span><span class="s2">, </span><span class="s3">0.85950263</span><span class="s2">,</span>
     <span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.0094836</span><span class="s2">, </span><span class="s3">0.011895</span><span class="s2">, </span><span class="s3">0.0145326</span><span class="s2">, </span><span class="s3">0.0155796</span><span class="s2">, </span><span class="s3">0.0304308</span><span class="s2">,</span>
     <span class="s3">0.0364518</span><span class="s2">, </span><span class="s3">0.043548</span><span class="s2">, </span><span class="s3">0.0797052</span><span class="s2">, </span><span class="s3">0.1290129</span><span class="s2">, </span><span class="s3">0.5231058</span><span class="s2">, </span><span class="s3">0.6240855</span><span class="s2">,</span>
     <span class="s3">0.8356242</span><span class="s2">, </span><span class="s3">0.981594</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
     <span class="s3">1</span><span class="s2">, </span><span class="s3">0.0094836</span><span class="s2">, </span><span class="s3">0.0114985</span><span class="s2">, </span><span class="s3">0.01356376</span><span class="s2">, </span><span class="s3">0.01402164</span><span class="s2">, </span><span class="s3">0.02637336</span><span class="s2">,</span>
     <span class="s3">0.0303765</span><span class="s2">, </span><span class="s3">0.0348384</span><span class="s2">, </span><span class="s3">0.06110732</span><span class="s2">, </span><span class="s3">0.09460946</span><span class="s2">, </span><span class="s3">0.36617406</span><span class="s2">, </span><span class="s3">0.416057</span><span class="s2">,</span>
     <span class="s3">0.52922866</span><span class="s2">, </span><span class="s3">0.5889564</span><span class="s2">, </span><span class="s3">0.59409543</span><span class="s2">, </span><span class="s3">0.67308928</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
     <span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.0094836</span><span class="s2">, </span><span class="s3">0.0114985</span><span class="s2">, </span><span class="s3">0.01356376</span><span class="s2">, </span><span class="s3">0.01402164</span><span class="s2">,</span>
     <span class="s3">0.02637336</span><span class="s2">, </span><span class="s3">0.0303765</span><span class="s2">, </span><span class="s3">0.0348384</span><span class="s2">, </span><span class="s3">0.06110732</span><span class="s2">, </span><span class="s3">0.09460946</span><span class="s2">, </span><span class="s3">0.36617406</span><span class="s2">,</span>
     <span class="s3">0.416057</span><span class="s2">, </span><span class="s3">0.52922866</span><span class="s2">, </span><span class="s3">0.5889564</span><span class="s2">, </span><span class="s3">0.59409543</span><span class="s2">, </span><span class="s3">0.67308928</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">,</span>
     <span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">,</span>
     <span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">,</span>
     <span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.009440257627368331</span><span class="s2">,</span>
     <span class="s3">0.01182686507401931</span><span class="s2">, </span><span class="s3">0.01443098172617119</span><span class="s2">, </span><span class="s3">0.01546285007478554</span><span class="s2">,</span>
     <span class="s3">0.02998742566629453</span><span class="s2">, </span><span class="s3">0.03581680249125385</span><span class="s2">, </span><span class="s3">0.04264369065603335</span><span class="s2">,</span>
     <span class="s3">0.0767094173291795</span><span class="s2">, </span><span class="s3">0.1212818694859857</span><span class="s2">, </span><span class="s3">0.410051586220387</span><span class="s2">,</span>
     <span class="s3">0.4677640287633493</span><span class="s2">, </span><span class="s3">0.5715077903157826</span><span class="s2">, </span><span class="s3">0.631388450393325</span><span class="s2">,</span>
     <span class="s3">0.656016359012282</span><span class="s2">, </span><span class="s3">0.724552174001554</span><span class="s2">, </span><span class="s3">0.919808283456286</span><span class="s2">,</span>
     <span class="s3">0.999721715014484</span><span class="s2">, </span><span class="s3">0.9999547032674126</span><span class="s2">, </span><span class="s3">0.9999985652190126</span><span class="s2">,</span>
     <span class="s3">0.999999964809746</span><span class="s2">, </span><span class="s3">0.999999982525548</span><span class="s2">, </span><span class="s3">0.999999986719131</span><span class="s2">,</span>
     <span class="s3">0.999999997434160</span><span class="s2">, </span><span class="s3">0.999999998521536</span><span class="s2">, </span><span class="s3">0.999999999970829</span><span class="s2">,</span>
     <span class="s3">0.999999999999767</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.009440257627368331</span><span class="s2">,</span>
     <span class="s3">0.01143489901147732</span><span class="s2">, </span><span class="s3">0.0134754287611275</span><span class="s2">, </span><span class="s3">0.01392738605848343</span><span class="s2">,</span>
     <span class="s3">0.0260416568490015</span><span class="s2">, </span><span class="s3">0.02993768724817902</span><span class="s2">, </span><span class="s3">0.0342629726119179</span><span class="s2">,</span>
     <span class="s3">0.0593542206208364</span><span class="s2">, </span><span class="s3">0.09045742964699988</span><span class="s2">, </span><span class="s3">0.308853956167216</span><span class="s2">,</span>
     <span class="s3">0.343245865702423</span><span class="s2">, </span><span class="s3">0.4153483370083637</span><span class="s2">, </span><span class="s3">0.4505333180190900</span><span class="s2">,</span>
     <span class="s3">0.453775200643535</span><span class="s2">, </span><span class="s3">0.497247406680671</span><span class="s2">, </span><span class="s3">0.71681858015803</span><span class="s2">,</span>
     <span class="s3">0.978083969553718</span><span class="s2">, </span><span class="s3">0.986889206426321</span><span class="s2">, </span><span class="s3">0.995400461639735</span><span class="s2">,</span>
     <span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">,</span>
     <span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">,</span>
     <span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">,</span>
     <span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.9981506396214986</span><span class="s2">, </span><span class="s3">0.0038949</span><span class="s2">, </span><span class="s3">0.0038949</span><span class="s2">,</span>
     <span class="s3">0.0038949</span><span class="s2">, </span><span class="s3">0.0038949</span><span class="s2">, </span><span class="s3">0.0060753</span><span class="s2">, </span><span class="s3">0.0060753</span><span class="s2">, </span><span class="s3">0.006221142857142857</span><span class="s2">,</span>
     <span class="s3">0.00996315</span><span class="s2">, </span><span class="s3">0.01433476666666667</span><span class="s2">, </span><span class="s3">0.05231058</span><span class="s2">, </span><span class="s3">0.05673504545454545</span><span class="s2">,</span>
     <span class="s3">0.06963535</span><span class="s2">, </span><span class="s3">0.07488597857142856</span><span class="s2">, </span><span class="s3">0.07488597857142856</span><span class="s2">, </span><span class="s3">0.08413616</span><span class="s2">,</span>
     <span class="s3">0.15125803125</span><span class="s2">, </span><span class="s3">0.421460594117647</span><span class="s2">, </span><span class="s3">0.4725384</span><span class="s2">, </span><span class="s3">0.570637910526316</span><span class="s2">,</span>
     <span class="s3">0.6152972625</span><span class="s2">, </span><span class="s3">0.6152972625</span><span class="s2">, </span><span class="s3">0.6152972625</span><span class="s2">, </span><span class="s3">0.6152972625</span><span class="s2">, </span><span class="s3">0.6152972625</span><span class="s2">,</span>
     <span class="s3">0.665419656</span><span class="s2">, </span><span class="s3">0.7162468846153845</span><span class="s2">, </span><span class="s3">0.775972982142857</span><span class="s2">, </span><span class="s3">0.775972982142857</span><span class="s2">,</span>
     <span class="s3">0.889140651724138</span><span class="s2">, </span><span class="s3">0.89032747</span><span class="s2">, </span><span class="s3">0.01556007537622183</span><span class="s2">,</span>
     <span class="s3">0.01556007537622183</span><span class="s2">, </span><span class="s3">0.01556007537622183</span><span class="s2">, </span><span class="s3">0.01556007537622183</span><span class="s2">,</span>
     <span class="s3">0.02427074531648065</span><span class="s2">, </span><span class="s3">0.02427074531648065</span><span class="s2">, </span><span class="s3">0.02485338565390302</span><span class="s2">,</span>
     <span class="s3">0.0398026560334295</span><span class="s2">, </span><span class="s3">0.0572672083580799</span><span class="s2">, </span><span class="s3">0.2089800939109816</span><span class="s2">,</span>
     <span class="s3">0.2266557764630925</span><span class="s2">, </span><span class="s3">0.2781923271071372</span><span class="s2">, </span><span class="s3">0.2991685206792373</span><span class="s2">,</span>
     <span class="s3">0.2991685206792373</span><span class="s2">, </span><span class="s3">0.336122876445059</span><span class="s2">, </span><span class="s3">0.6042738882921044</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">,</span>
     <span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0.00220711</span><span class="s2">, </span><span class="s3">0.00220711</span><span class="s2">, </span><span class="s3">0.00220711</span><span class="s2">,</span>
     <span class="s3">0.00220711</span><span class="s2">, </span><span class="s3">0.00344267</span><span class="s2">, </span><span class="s3">0.00344267</span><span class="s2">, </span><span class="s3">0.003525314285714285</span><span class="s2">, </span><span class="s3">0.005645785</span><span class="s2">,</span>
     <span class="s3">0.00812303444444444</span><span class="s2">, </span><span class="s3">0.029642662</span><span class="s2">, </span><span class="s3">0.0321498590909091</span><span class="s2">,</span>
     <span class="s3">0.03946003166666667</span><span class="s2">, </span><span class="s3">0.04243538785714285</span><span class="s2">, </span><span class="s3">0.04243538785714285</span><span class="s2">,</span>
     <span class="s3">0.0476771573333333</span><span class="s2">, </span><span class="s3">0.085712884375</span><span class="s2">, </span><span class="s3">0.23882767</span><span class="s2">, </span><span class="s3">0.26777176</span><span class="s2">,</span>
     <span class="s3">0.323361482631579</span><span class="s2">, </span><span class="s3">0.34866844875</span><span class="s2">, </span><span class="s3">0.34866844875</span><span class="s2">, </span><span class="s3">0.34866844875</span><span class="s2">,</span>
     <span class="s3">0.34866844875</span><span class="s2">, </span><span class="s3">0.34866844875</span><span class="s2">, </span><span class="s3">0.3770711384</span><span class="s2">, </span><span class="s3">0.4058732346153846</span><span class="s2">,</span>
     <span class="s3">0.4397180232142857</span><span class="s2">, </span><span class="s3">0.4397180232142857</span><span class="s2">, </span><span class="s3">0.503846369310345</span><span class="s2">,</span>
     <span class="s3">0.504518899666667</span><span class="s2">, </span><span class="s3">0.00272643</span><span class="s2">, </span><span class="s3">0.00272643</span><span class="s2">, </span><span class="s3">0.00272643</span><span class="s2">, </span><span class="s3">0.00272643</span><span class="s2">,</span>
     <span class="s3">0.00425271</span><span class="s2">, </span><span class="s3">0.00425271</span><span class="s2">, </span><span class="s3">0.0043548</span><span class="s2">, </span><span class="s3">0.006974205</span><span class="s2">, </span><span class="s3">0.01003433666666667</span><span class="s2">,</span>
     <span class="s3">0.036617406</span><span class="s2">, </span><span class="s3">0.03971453181818182</span><span class="s2">, </span><span class="s3">0.048744745</span><span class="s2">, </span><span class="s3">0.052420185</span><span class="s2">,</span>
     <span class="s3">0.052420185</span><span class="s2">, </span><span class="s3">0.058895312</span><span class="s2">, </span><span class="s3">0.105880621875</span><span class="s2">, </span><span class="s3">0.295022415882353</span><span class="s2">,</span>
     <span class="s3">0.33077688</span><span class="s2">, </span><span class="s3">0.399446537368421</span><span class="s2">, </span><span class="s3">0.43070808375</span><span class="s2">, </span><span class="s3">0.43070808375</span><span class="s2">,</span>
     <span class="s3">0.43070808375</span><span class="s2">, </span><span class="s3">0.43070808375</span><span class="s2">, </span><span class="s3">0.43070808375</span><span class="s2">, </span><span class="s3">0.4657937592</span><span class="s2">,</span>
     <span class="s3">0.5013728192307692</span><span class="s2">, </span><span class="s3">0.5431810875</span><span class="s2">, </span><span class="s3">0.5431810875</span><span class="s2">, </span><span class="s3">0.622398456206897</span><span class="s2">,</span>
     <span class="s3">0.623229229</span>
    <span class="s1">]).reshape(</span><span class="s3">30</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">CheckMultiTestsMixin:</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s4">'key,val'</span><span class="s2">, </span><span class="s1">sorted(rmethods.items()))</span>
    <span class="s2">def </span><span class="s1">test_multi_pvalcorrection_rmethods(self</span><span class="s2">, </span><span class="s1">key</span><span class="s2">, </span><span class="s1">val):</span>
        <span class="s5"># test against R package multtest mt.rawp2adjp</span>

        <span class="s1">res_multtest = self.res2</span>
        <span class="s1">pval0 = res_multtest[:</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span>

        <span class="s2">if </span><span class="s1">val[</span><span class="s3">1</span><span class="s1">] </span><span class="s2">in </span><span class="s1">self.methods:</span>
            <span class="s1">reject</span><span class="s2">, </span><span class="s1">pvalscorr = multipletests(pval0</span><span class="s2">,</span>
                                              <span class="s1">alpha=self.alpha</span><span class="s2">,</span>
                                              <span class="s1">method=val[</span><span class="s3">1</span><span class="s1">])[:</span><span class="s3">2</span><span class="s1">]</span>
            <span class="s1">assert_almost_equal(pvalscorr</span><span class="s2">, </span><span class="s1">res_multtest[:</span><span class="s2">, </span><span class="s1">val[</span><span class="s3">0</span><span class="s1">]]</span><span class="s2">, </span><span class="s3">15</span><span class="s1">)</span>
            <span class="s1">assert_equal(reject</span><span class="s2">, </span><span class="s1">pvalscorr &lt;= self.alpha)</span>

    <span class="s2">def </span><span class="s1">test_multi_pvalcorrection(self):</span>
        <span class="s5"># test against R package multtest mt.rawp2adjp</span>

        <span class="s1">res_multtest = self.res2</span>
        <span class="s1">pval0 = res_multtest[:</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span>

        <span class="s1">pvalscorr = np.sort(fdrcorrection(pval0</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'n'</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(pvalscorr</span><span class="s2">, </span><span class="s1">res_multtest[:</span><span class="s2">, </span><span class="s3">7</span><span class="s1">]</span><span class="s2">, </span><span class="s3">15</span><span class="s1">)</span>
        <span class="s1">pvalscorr = np.sort(fdrcorrection(pval0</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'i'</span><span class="s1">)[</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_almost_equal(pvalscorr</span><span class="s2">, </span><span class="s1">res_multtest[:</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">, </span><span class="s3">15</span><span class="s1">)</span>


<span class="s2">class </span><span class="s1">TestMultiTests1(CheckMultiTestsMixin):</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.methods = [</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'s'</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s2">, </span><span class="s4">'h'</span><span class="s2">, </span><span class="s4">'fdr_i'</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s1">]</span>
        <span class="s1">cls.alpha = </span><span class="s3">0.1</span>
        <span class="s1">cls.res2 = res_multtest1</span>


<span class="s2">class </span><span class="s1">TestMultiTests2(CheckMultiTestsMixin):</span>
    <span class="s5"># case: all hypothesis rejected (except 'b' and 's'</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.methods = [</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'s'</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s2">, </span><span class="s4">'h'</span><span class="s2">, </span><span class="s4">'fdr_i'</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s1">]</span>
        <span class="s1">cls.alpha = </span><span class="s3">0.05</span>
        <span class="s1">cls.res2 = res_multtest2</span>


<span class="s2">class </span><span class="s1">TestMultiTests3(CheckMultiTestsMixin):</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.methods = [</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'s'</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s2">, </span><span class="s4">'h'</span><span class="s2">, </span><span class="s4">'fdr_i'</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s2">,</span>
                       <span class="s4">'fdr_tsbh'</span><span class="s1">]</span>
        <span class="s1">cls.alpha = </span><span class="s3">0.05</span>
        <span class="s1">cls.res2 = res0_large</span>


<span class="s2">class </span><span class="s1">TestMultiTests4(CheckMultiTestsMixin):</span>
    <span class="s5"># in simulations, all two stage fdr, fdr_tsbky, fdr_tsbh, fdr_gbs, have in</span>
    <span class="s5"># some cases (cases with large Alternative) an FDR that looks too large</span>
    <span class="s5"># this is the first case #rejected = 12, DGP : has 10 false</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.methods = [</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'s'</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s2">, </span><span class="s4">'h'</span><span class="s2">, </span><span class="s4">'fdr_i'</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s2">,</span>
                       <span class="s4">'fdr_tsbh'</span><span class="s1">]</span>
        <span class="s1">cls.alpha = </span><span class="s3">0.05</span>
        <span class="s1">cls.res2 = res_multtest3</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'alpha'</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0.01</span><span class="s2">, </span><span class="s3">0.05</span><span class="s2">, </span><span class="s3">0.1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'method'</span><span class="s2">, </span><span class="s1">[</span><span class="s4">'b'</span><span class="s2">, </span><span class="s4">'s'</span><span class="s2">, </span><span class="s4">'sh'</span><span class="s2">, </span><span class="s4">'hs'</span><span class="s2">, </span><span class="s4">'h'</span><span class="s2">, </span><span class="s4">'hommel'</span><span class="s2">,</span>
                                    <span class="s4">'fdr_i'</span><span class="s2">, </span><span class="s4">'fdr_n'</span><span class="s2">, </span><span class="s4">'fdr_tsbky'</span><span class="s2">,</span>
                                    <span class="s4">'fdr_tsbh'</span><span class="s2">, </span><span class="s4">'fdr_gbs'</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'ii'</span><span class="s2">, </span><span class="s1">list(range(</span><span class="s3">11</span><span class="s1">)))</span>
<span class="s2">def </span><span class="s1">test_pvalcorrection_reject(alpha</span><span class="s2">, </span><span class="s1">method</span><span class="s2">, </span><span class="s1">ii):</span>
    <span class="s5"># consistency test for reject boolean and pvalscorr</span>

    <span class="s1">pval1 = np.hstack((np.linspace(</span><span class="s3">0.0001</span><span class="s2">, </span><span class="s3">0.0100</span><span class="s2">, </span><span class="s1">ii)</span><span class="s2">,</span>
                       <span class="s1">np.linspace(</span><span class="s3">0.05001</span><span class="s2">, </span><span class="s3">0.11</span><span class="s2">, </span><span class="s3">10 </span><span class="s1">- ii)))</span>
    <span class="s5"># using .05001 instead of 0.05 to avoid edge case issue #768</span>
    <span class="s1">reject</span><span class="s2">, </span><span class="s1">pvalscorr = multipletests(pval1</span><span class="s2">, </span><span class="s1">alpha=alpha</span><span class="s2">,</span>
                                      <span class="s1">method=method)[:</span><span class="s3">2</span><span class="s1">]</span>

    <span class="s1">msg = </span><span class="s4">'case %s %3.2f rejected:%d</span><span class="s2">\n</span><span class="s4">pval_raw=%r</span><span class="s2">\n</span><span class="s4">pvalscorr=%r' </span><span class="s1">% (</span>
                     <span class="s1">method</span><span class="s2">, </span><span class="s1">alpha</span><span class="s2">, </span><span class="s1">reject.sum()</span><span class="s2">, </span><span class="s1">pval1</span><span class="s2">, </span><span class="s1">pvalscorr)</span>
    <span class="s1">assert_equal(reject</span><span class="s2">, </span><span class="s1">pvalscorr &lt;= alpha</span><span class="s2">, </span><span class="s1">err_msg=msg)</span>


<span class="s2">def </span><span class="s1">test_hommel():</span>
    <span class="s5"># tested against R stats p_adjust(pval0, method='hommel')</span>
    <span class="s1">pval0 = np.array([</span>
        <span class="s3">0.00116</span><span class="s2">,  </span><span class="s3">0.00924</span><span class="s2">,  </span><span class="s3">0.01075</span><span class="s2">,  </span><span class="s3">0.01437</span><span class="s2">,  </span><span class="s3">0.01784</span><span class="s2">,  </span><span class="s3">0.01918</span><span class="s2">,</span>
        <span class="s3">0.02751</span><span class="s2">,  </span><span class="s3">0.02871</span><span class="s2">,  </span><span class="s3">0.03054</span><span class="s2">,  </span><span class="s3">0.03246</span><span class="s2">,  </span><span class="s3">0.04259</span><span class="s2">,  </span><span class="s3">0.06879</span><span class="s2">,</span>
        <span class="s3">0.0691</span><span class="s2">,   </span><span class="s3">0.08081</span><span class="s2">,  </span><span class="s3">0.08593</span><span class="s2">,  </span><span class="s3">0.08993</span><span class="s2">,  </span><span class="s3">0.09386</span><span class="s2">,  </span><span class="s3">0.09412</span><span class="s2">,</span>
        <span class="s3">0.09718</span><span class="s2">,  </span><span class="s3">0.09758</span><span class="s2">,  </span><span class="s3">0.09781</span><span class="s2">,  </span><span class="s3">0.09788</span><span class="s2">,  </span><span class="s3">0.13282</span><span class="s2">,  </span><span class="s3">0.20191</span><span class="s2">,</span>
        <span class="s3">0.21757</span><span class="s2">,  </span><span class="s3">0.24031</span><span class="s2">,  </span><span class="s3">0.26061</span><span class="s2">,  </span><span class="s3">0.26762</span><span class="s2">,  </span><span class="s3">0.29474</span><span class="s2">,  </span><span class="s3">0.32901</span><span class="s2">,</span>
        <span class="s3">0.41386</span><span class="s2">,  </span><span class="s3">0.51479</span><span class="s2">,  </span><span class="s3">0.52461</span><span class="s2">,  </span><span class="s3">0.53389</span><span class="s2">,  </span><span class="s3">0.56276</span><span class="s2">,  </span><span class="s3">0.62967</span><span class="s2">,</span>
        <span class="s3">0.72178</span><span class="s2">,  </span><span class="s3">0.73403</span><span class="s2">,  </span><span class="s3">0.87182</span><span class="s2">,  </span><span class="s3">0.95384</span><span class="s1">])</span>

    <span class="s1">result_ho = np.array([</span>
        <span class="s3">0.0464</span><span class="s2">,              </span><span class="s3">0.25872</span><span class="s2">,             </span><span class="s3">0.29025</span><span class="s2">,</span>
        <span class="s3">0.3495714285714286</span><span class="s2">,  </span><span class="s3">0.41032</span><span class="s2">,             </span><span class="s3">0.44114</span><span class="s2">,</span>
        <span class="s3">0.57771</span><span class="s2">,             </span><span class="s3">0.60291</span><span class="s2">,             </span><span class="s3">0.618954</span><span class="s2">,</span>
        <span class="s3">0.6492</span><span class="s2">,              </span><span class="s3">0.7402725000000001</span><span class="s2">,  </span><span class="s3">0.86749</span><span class="s2">,</span>
        <span class="s3">0.86749</span><span class="s2">,             </span><span class="s3">0.8889100000000001</span><span class="s2">,  </span><span class="s3">0.8971477777777778</span><span class="s2">,</span>
        <span class="s3">0.8993</span><span class="s2">,              </span><span class="s3">0.9175374999999999</span><span class="s2">,  </span><span class="s3">0.9175374999999999</span><span class="s2">,</span>
        <span class="s3">0.9175374999999999</span><span class="s2">,  </span><span class="s3">0.9175374999999999</span><span class="s2">,  </span><span class="s3">0.9175374999999999</span><span class="s2">,</span>
        <span class="s3">0.9175374999999999</span><span class="s2">,  </span><span class="s3">0.95384</span><span class="s2">,             </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,  </span><span class="s3">0.9538400000000001</span><span class="s2">,</span>
        <span class="s3">0.9538400000000001</span><span class="s1">])</span>

    <span class="s1">rej</span><span class="s2">, </span><span class="s1">pvalscorr</span><span class="s2">, </span><span class="s1">_</span><span class="s2">, </span><span class="s1">_ = multipletests(pval0</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.1</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'ho'</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(pvalscorr</span><span class="s2">, </span><span class="s1">result_ho</span><span class="s2">, </span><span class="s3">15</span><span class="s1">)</span>
    <span class="s1">assert_equal(rej</span><span class="s2">, </span><span class="s1">result_ho &lt; </span><span class="s3">0.1</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_fdr_bky():</span>
    <span class="s5"># test for fdrcorrection_twostage</span>
    <span class="s5"># example from BKY</span>
    <span class="s1">pvals = [</span>
        <span class="s3">0.0001</span><span class="s2">, </span><span class="s3">0.0004</span><span class="s2">, </span><span class="s3">0.0019</span><span class="s2">, </span><span class="s3">0.0095</span><span class="s2">, </span><span class="s3">0.0201</span><span class="s2">, </span><span class="s3">0.0278</span><span class="s2">, </span><span class="s3">0.0298</span><span class="s2">, </span><span class="s3">0.0344</span><span class="s2">, </span><span class="s3">0.0459</span><span class="s2">,</span>
        <span class="s3">0.3240</span><span class="s2">, </span><span class="s3">0.4262</span><span class="s2">, </span><span class="s3">0.5719</span><span class="s2">, </span><span class="s3">0.6528</span><span class="s2">, </span><span class="s3">0.7590</span><span class="s2">, </span><span class="s3">1.000</span><span class="s1">]</span>

    <span class="s5"># no test for corrected p-values, but they are inherited</span>
    <span class="s5"># same number of rejection as in BKY paper:</span>
    <span class="s5"># single step-up:4, two-stage:8, iterated two-step:9</span>
    <span class="s5"># also alpha_star is the same as theirs for TST</span>

    <span class="s5"># alpha_star for stage 2</span>
    <span class="s2">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s2">, </span><span class="s1">match=</span><span class="s4">&quot;iter keyword&quot;</span><span class="s1">):</span>
        <span class="s1">res_tst = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">iter=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal([</span><span class="s3">0.047619</span><span class="s2">, </span><span class="s3">0.0649</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res_tst[-</span><span class="s3">1</span><span class="s1">][:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">assert_equal(</span><span class="s3">8</span><span class="s2">, </span><span class="s1">res_tst[</span><span class="s3">0</span><span class="s1">].sum())</span>

    <span class="s5"># reference number from Prism, see #8619</span>
    <span class="s1">res2 = np.array([</span>
        <span class="s3">0.0012</span><span class="s2">, </span><span class="s3">0.0023</span><span class="s2">, </span><span class="s3">0.0073</span><span class="s2">, </span><span class="s3">0.0274</span><span class="s2">, </span><span class="s3">0.0464</span><span class="s2">, </span><span class="s3">0.0492</span><span class="s2">, </span><span class="s3">0.0492</span><span class="s2">, </span><span class="s3">0.0497</span><span class="s2">,</span>
        <span class="s3">0.0589</span><span class="s2">, </span><span class="s3">0.3742</span><span class="s2">, </span><span class="s3">0.4475</span><span class="s2">, </span><span class="s3">0.5505</span><span class="s2">, </span><span class="s3">0.5800</span><span class="s2">, </span><span class="s3">0.6262</span><span class="s2">, </span><span class="s3">0.77</span>
        <span class="s1">])</span>
    <span class="s1">assert_allclose(res_tst[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">6e-5</span><span class="s1">)</span>

    <span class="s5"># issue #8619, problems if no or all rejected, ordering</span>
    <span class="s1">pvals = np.array([</span><span class="s3">0.2</span><span class="s2">, </span><span class="s3">0.8</span><span class="s2">, </span><span class="s3">0.3</span><span class="s2">, </span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">res1 = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'bky'</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbky'</span><span class="s1">)</span>
    <span class="s1">assert_equal(res1[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res2[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">6e-5</span><span class="s1">)</span>
    <span class="s5"># confirmed with Prism</span>
    <span class="s1">res_pv = np.array([</span><span class="s3">0.7875</span><span class="s2">, </span><span class="s3">1.</span><span class="s2">, </span><span class="s3">0.7875</span><span class="s2">, </span><span class="s3">0.875 </span><span class="s2">, </span><span class="s3">1.</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res_pv</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">6e-5</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_fdr_twostage():</span>
    <span class="s5"># test for iteration in fdrcorrection_twostage, new maxiter</span>
    <span class="s5"># example from BKY</span>
    <span class="s1">pvals = [</span>
        <span class="s3">0.0001</span><span class="s2">, </span><span class="s3">0.0004</span><span class="s2">, </span><span class="s3">0.0019</span><span class="s2">, </span><span class="s3">0.0095</span><span class="s2">, </span><span class="s3">0.0201</span><span class="s2">, </span><span class="s3">0.0278</span><span class="s2">, </span><span class="s3">0.0298</span><span class="s2">, </span><span class="s3">0.0344</span><span class="s2">, </span><span class="s3">0.0459</span><span class="s2">,</span>
        <span class="s3">0.3240</span><span class="s2">, </span><span class="s3">0.4262</span><span class="s2">, </span><span class="s3">0.5719</span><span class="s2">, </span><span class="s3">0.6528</span><span class="s2">, </span><span class="s3">0.7590</span><span class="s2">, </span><span class="s3">1.000</span><span class="s1">]</span>
    <span class="s1">n = len(pvals)</span>

    <span class="s5"># bh twostage fdr</span>
    <span class="s1">k = </span><span class="s3">0</span>
    <span class="s5"># same pvalues as one-stage fdr</span>
    <span class="s1">res0 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_bh'</span><span class="s1">)</span>
    <span class="s1">res1 = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'bh'</span><span class="s2">, </span><span class="s1">maxiter=k</span><span class="s2">,</span>
                                  <span class="s1">iter=</span><span class="s2">None</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbh'</span><span class="s2">, </span><span class="s1">maxiter=k)</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res0[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res2[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">k = </span><span class="s3">1</span>
    <span class="s5"># pvalues corrected by first stage number of rejections</span>
    <span class="s1">res0 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_bh'</span><span class="s1">)</span>
    <span class="s1">res1 = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'bh'</span><span class="s2">, </span><span class="s1">maxiter=k</span><span class="s2">,</span>
                                  <span class="s1">iter=</span><span class="s2">None</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbh'</span><span class="s2">, </span><span class="s1">maxiter=k)</span>
    <span class="s1">res3 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbh'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res0[</span><span class="s3">1</span><span class="s1">] * (</span><span class="s3">1 </span><span class="s1">- res0[</span><span class="s3">0</span><span class="s1">].sum() / n))</span>
    <span class="s1">assert_allclose(res2[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res3[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])  </span><span class="s5"># check default maxiter</span>

    <span class="s5"># bky has an extra factor 1+alpha in fdr twostage independent of iter</span>
    <span class="s1">fact = </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">0.05</span>
    <span class="s1">k = </span><span class="s3">0</span>
    <span class="s5"># same pvalues as one-stage fdr</span>
    <span class="s1">res0 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_bh'</span><span class="s1">)</span>
    <span class="s1">res1 = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'bky'</span><span class="s2">, </span><span class="s1">maxiter=k</span><span class="s2">,</span>
                                  <span class="s1">iter=</span><span class="s2">None</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbky'</span><span class="s2">, </span><span class="s1">maxiter=k)</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">np.clip(res0[</span><span class="s3">1</span><span class="s1">] * fact</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_allclose(res2[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s1">k = </span><span class="s3">1</span>
    <span class="s5"># pvalues corrected by first stage number of rejections</span>
    <span class="s1">res0 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_bh'</span><span class="s1">)</span>
    <span class="s1">res1 = fdrcorrection_twostage(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'bky'</span><span class="s2">, </span><span class="s1">maxiter=k</span><span class="s2">,</span>
                                  <span class="s1">iter=</span><span class="s2">None</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbky'</span><span class="s2">, </span><span class="s1">maxiter=k)</span>
    <span class="s1">res3 = multipletests(pvals</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">method=</span><span class="s4">'fdr_tsbky'</span><span class="s1">)</span>
    <span class="s1">assert_allclose(res1[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res0[</span><span class="s3">1</span><span class="s1">] * (</span><span class="s3">1 </span><span class="s1">- res0[</span><span class="s3">0</span><span class="s1">].sum() / n) * fact)</span>
    <span class="s1">assert_allclose(res2[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res3[</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">1</span><span class="s1">])  </span><span class="s5"># check default maxiter</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'method'</span><span class="s2">, </span><span class="s1">sorted(multitest_methods_names))</span>
<span class="s2">def </span><span class="s1">test_issorted(method):</span>
    <span class="s5"># test that is_sorted keyword works correctly</span>
    <span class="s5"># the fdrcorrection functions are tested indirectly</span>

    <span class="s5"># data generated as random numbers np.random.beta(0.2, 0.5, size=10)</span>
    <span class="s1">pvals = np.array([</span><span class="s3">31</span><span class="s2">, </span><span class="s3">9958111</span><span class="s2">, </span><span class="s3">7430818</span><span class="s2">, </span><span class="s3">8653643</span><span class="s2">, </span><span class="s3">9892855</span><span class="s2">, </span><span class="s3">876</span><span class="s2">, </span><span class="s3">2651691</span><span class="s2">,</span>
                      <span class="s3">145836</span><span class="s2">, </span><span class="s3">9931</span><span class="s2">, </span><span class="s3">6174747</span><span class="s1">]) * </span><span class="s3">1e-7</span>
    <span class="s1">sortind = np.argsort(pvals)</span>
    <span class="s1">sortrevind = sortind.argsort()</span>
    <span class="s1">pvals_sorted = pvals[sortind]</span>

    <span class="s1">res1 = multipletests(pvals</span><span class="s2">, </span><span class="s1">method=method</span><span class="s2">, </span><span class="s1">is_sorted=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">res2 = multipletests(pvals_sorted</span><span class="s2">, </span><span class="s1">method=method</span><span class="s2">, </span><span class="s1">is_sorted=</span><span class="s2">True</span><span class="s1">)</span>
    <span class="s1">assert_equal(res2[</span><span class="s3">0</span><span class="s1">][sortrevind]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(res2[</span><span class="s3">0</span><span class="s1">][sortrevind]</span><span class="s2">, </span><span class="s1">res1[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-10</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'method'</span><span class="s2">, </span><span class="s1">sorted(multitest_methods_names))</span>
<span class="s2">def </span><span class="s1">test_floating_precision(method):</span>
    <span class="s5"># issue #7465</span>
    <span class="s1">pvals = np.full(</span><span class="s3">6000</span><span class="s2">, </span><span class="s3">0.99</span><span class="s1">)</span>
    <span class="s1">pvals[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">1.138569e-56</span>
    <span class="s2">assert </span><span class="s1">multipletests(pvals</span><span class="s2">, </span><span class="s1">method=method)[</span><span class="s3">1</span><span class="s1">][</span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">1e-60</span>


<span class="s2">def </span><span class="s1">test_tukeyhsd():</span>
    <span class="s5"># example multicomp in R p 83</span>

    <span class="s1">res = </span><span class="s4">'''</span><span class="s2">\ 
    </span><span class="s4">pair      diff        lwr        upr       p adj 
    P-M   8.150000 -10.037586 26.3375861 0.670063958 
    S-M  -3.258333 -21.445919 14.9292527 0.982419709 
    T-M  23.808333   5.620747 41.9959194 0.006783701 
    V-M   4.791667 -13.395919 22.9792527 0.931020848 
    S-P -11.408333 -29.595919  6.7792527 0.360680099 
    T-P  15.658333  -2.529253 33.8459194 0.113221634 
    V-P  -3.358333 -21.545919 14.8292527 0.980350080 
    T-S  27.066667   8.879081 45.2542527 0.002027122 
    V-S   8.050000 -10.137586 26.2375861 0.679824487 
    V-T -19.016667 -37.204253 -0.8290806 0.037710044 
    '''</span>

    <span class="s1">res = np.array([</span>
        <span class="s1">[</span><span class="s3">8.150000</span><span class="s2">,  </span><span class="s1">-</span><span class="s3">10.037586</span><span class="s2">, </span><span class="s3">26.3375861</span><span class="s2">, </span><span class="s3">0.670063958</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[-</span><span class="s3">3.258333</span><span class="s2">,  </span><span class="s1">-</span><span class="s3">21.445919</span><span class="s2">, </span><span class="s3">14.9292527</span><span class="s2">, </span><span class="s3">0.982419709</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s3">23.808333</span><span class="s2">,    </span><span class="s3">5.620747</span><span class="s2">, </span><span class="s3">41.9959194</span><span class="s2">, </span><span class="s3">0.006783701</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s3">4.791667</span><span class="s2">,  </span><span class="s1">-</span><span class="s3">13.395919</span><span class="s2">, </span><span class="s3">22.9792527</span><span class="s2">, </span><span class="s3">0.931020848</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[-</span><span class="s3">11.408333</span><span class="s2">, </span><span class="s1">-</span><span class="s3">29.595919</span><span class="s2">,  </span><span class="s3">6.7792527</span><span class="s2">, </span><span class="s3">0.360680099</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s3">15.658333</span><span class="s2">,  </span><span class="s1">-</span><span class="s3">2.529253</span><span class="s2">,  </span><span class="s3">33.8459194</span><span class="s2">, </span><span class="s3">0.113221634</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[-</span><span class="s3">3.358333</span><span class="s2">, </span><span class="s1">-</span><span class="s3">21.545919</span><span class="s2">,  </span><span class="s3">14.8292527</span><span class="s2">, </span><span class="s3">0.980350080</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s3">27.066667</span><span class="s2">,   </span><span class="s3">8.879081</span><span class="s2">,  </span><span class="s3">45.2542527</span><span class="s2">, </span><span class="s3">0.002027122</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[</span><span class="s3">8.050000</span><span class="s2">, </span><span class="s1">-</span><span class="s3">10.137586</span><span class="s2">,  </span><span class="s3">26.2375861</span><span class="s2">, </span><span class="s3">0.679824487</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">[-</span><span class="s3">19.016667</span><span class="s2">, </span><span class="s1">-</span><span class="s3">37.204253</span><span class="s2">, </span><span class="s1">-</span><span class="s3">0.8290806</span><span class="s2">, </span><span class="s3">0.037710044</span><span class="s1">]])</span>

    <span class="s1">m_r = [</span><span class="s3">94.39167</span><span class="s2">, </span><span class="s3">102.54167</span><span class="s2">,  </span><span class="s3">91.13333</span><span class="s2">, </span><span class="s3">118.20000</span><span class="s2">,  </span><span class="s3">99.18333</span><span class="s1">]</span>
    <span class="s1">myres = tukeyhsd(m_r</span><span class="s2">, </span><span class="s3">6</span><span class="s2">, </span><span class="s3">110.8254416667</span><span class="s2">, </span><span class="s1">alpha=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">df=</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">pairs</span><span class="s2">, </span><span class="s1">reject</span><span class="s2">, </span><span class="s1">meandiffs</span><span class="s2">, </span><span class="s1">std_pairs</span><span class="s2">, </span><span class="s1">confint</span><span class="s2">, </span><span class="s1">q_crit = myres[:</span><span class="s3">6</span><span class="s1">]</span>
    <span class="s1">assert_almost_equal(meandiffs</span><span class="s2">, </span><span class="s1">res[:</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(confint</span><span class="s2">, </span><span class="s1">res[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">decimal=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_equal(reject</span><span class="s2">, </span><span class="s1">res[:</span><span class="s2">, </span><span class="s3">3</span><span class="s1">] &lt; </span><span class="s3">0.05</span><span class="s1">)</span>

    <span class="s5"># check p-values (divergence of high values is expected)</span>
    <span class="s1">small_pvals_idx = [</span><span class="s3">2</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">9</span><span class="s1">]</span>

    <span class="s5"># Remove this check when minimum SciPy version is 1.7+ (gh-8035)</span>
    <span class="s1">scipy_version = (version.parse(scipy.version.version) &gt;=</span>
                     <span class="s1">version.parse(</span><span class="s4">'1.7.0'</span><span class="s1">))</span>
    <span class="s1">rtol = </span><span class="s3">1e-5 </span><span class="s2">if </span><span class="s1">scipy_version </span><span class="s2">else </span><span class="s3">1e-2</span>
    <span class="s1">assert_allclose(myres[</span><span class="s3">8</span><span class="s1">][small_pvals_idx]</span><span class="s2">, </span><span class="s1">res[small_pvals_idx</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">,</span>
                    <span class="s1">rtol=rtol)</span>


<span class="s2">def </span><span class="s1">test_local_fdr():</span>

    <span class="s5"># Create a mixed population of Z-scores: 1000 standard normal and</span>
    <span class="s5"># 20 uniformly distributed between 3 and 4.</span>
    <span class="s1">grid = np.linspace(</span><span class="s3">0.001</span><span class="s2">, </span><span class="s3">0.999</span><span class="s2">, </span><span class="s3">1000</span><span class="s1">)</span>
    <span class="s1">z0 = norm.ppf(grid)</span>
    <span class="s1">z1 = np.linspace(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">zs = np.concatenate((z0</span><span class="s2">, </span><span class="s1">z1))</span>

    <span class="s5"># Exact local FDR for U(3, 4) component.</span>
    <span class="s1">f1 = np.exp(-z1**</span><span class="s3">2 </span><span class="s1">/ </span><span class="s3">2</span><span class="s1">) / np.sqrt(</span><span class="s3">2</span><span class="s1">*np.pi)</span>
    <span class="s1">r = len(z1) / float(len(z0) + len(z1))</span>
    <span class="s1">f1 /= (</span><span class="s3">1 </span><span class="s1">- r) * f1 + r</span>

    <span class="s2">for </span><span class="s1">alpha </span><span class="s2">in None, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1e-8</span><span class="s1">:</span>
        <span class="s2">if </span><span class="s1">alpha </span><span class="s2">is None</span><span class="s1">:</span>
            <span class="s1">fdr = local_fdr(zs)</span>
        <span class="s2">else</span><span class="s1">:</span>
            <span class="s1">fdr = local_fdr(zs</span><span class="s2">, </span><span class="s1">alpha=alpha)</span>
        <span class="s1">fdr1 = fdr[len(z0):]</span>
        <span class="s1">assert_allclose(f1</span><span class="s2">, </span><span class="s1">fdr1</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">0.05</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">0.1</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_null_distribution():</span>

    <span class="s5"># Create a mixed population of Z-scores: 1000 standard normal and</span>
    <span class="s5"># 20 uniformly distributed between 3 and 4.</span>
    <span class="s1">grid = np.linspace(</span><span class="s3">0.001</span><span class="s2">, </span><span class="s3">0.999</span><span class="s2">, </span><span class="s3">1000</span><span class="s1">)</span>
    <span class="s1">z0 = norm.ppf(grid)</span>
    <span class="s1">z1 = np.linspace(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">zs = np.concatenate((z0</span><span class="s2">, </span><span class="s1">z1))</span>
    <span class="s1">emp_null = NullDistribution(zs</span><span class="s2">, </span><span class="s1">estimate_null_proportion=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s1">assert_allclose(emp_null.mean</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-5</span><span class="s1">)</span>
    <span class="s1">assert_allclose(emp_null.sd</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-2</span><span class="s1">)</span>
    <span class="s1">assert_allclose(emp_null.null_proportion</span><span class="s2">, </span><span class="s3">0.98</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-2</span><span class="s1">)</span>

    <span class="s5"># consistency check</span>
    <span class="s1">assert_allclose(emp_null.pdf(np.r_[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">])</span><span class="s2">,</span>
                    <span class="s1">norm.pdf(np.r_[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">,</span>
                             <span class="s1">loc=emp_null.mean</span><span class="s2">, </span><span class="s1">scale=emp_null.sd)</span><span class="s2">,</span>
                    <span class="s1">rtol=</span><span class="s3">1e-13</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'estimate_prob'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'estimate_scale'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s4">'estimate_mean'</span><span class="s2">, </span><span class="s1">[</span><span class="s2">True, False</span><span class="s1">])</span>
<span class="s2">def </span><span class="s1">test_null_constrained(estimate_mean</span><span class="s2">, </span><span class="s1">estimate_scale</span><span class="s2">, </span><span class="s1">estimate_prob):</span>

    <span class="s5"># Create a mixed population of Z-scores: 1000 standard normal and</span>
    <span class="s5"># 20 uniformly distributed between 3 and 4.</span>
    <span class="s1">grid = np.linspace(</span><span class="s3">0.001</span><span class="s2">, </span><span class="s3">0.999</span><span class="s2">, </span><span class="s3">1000</span><span class="s1">)</span>
    <span class="s1">z0 = norm.ppf(grid)</span>
    <span class="s1">z1 = np.linspace(</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">zs = np.concatenate((z0</span><span class="s2">, </span><span class="s1">z1))</span>

    <span class="s1">emp_null = NullDistribution(zs</span><span class="s2">, </span><span class="s1">estimate_mean=estimate_mean</span><span class="s2">,</span>
                                <span class="s1">estimate_scale=estimate_scale</span><span class="s2">,</span>
                                <span class="s1">estimate_null_proportion=estimate_prob)</span>

    <span class="s2">if not </span><span class="s1">estimate_mean:</span>
        <span class="s1">assert_allclose(emp_null.mean</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-5</span><span class="s1">)</span>
    <span class="s2">if not </span><span class="s1">estimate_scale:</span>
        <span class="s1">assert_allclose(emp_null.sd</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-2</span><span class="s1">)</span>
    <span class="s2">if not </span><span class="s1">estimate_prob:</span>
        <span class="s1">assert_allclose(emp_null.null_proportion</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s1">atol=</span><span class="s3">1e-5</span><span class="s2">, </span><span class="s1">rtol=</span><span class="s3">1e-2</span><span class="s1">)</span>

    <span class="s5"># consistency check</span>
    <span class="s1">assert_allclose(emp_null.pdf(np.r_[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">])</span><span class="s2">,</span>
                    <span class="s1">norm.pdf(np.r_[-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">loc=emp_null.mean</span><span class="s2">,</span>
                             <span class="s1">scale=emp_null.sd)</span><span class="s2">,</span>
                    <span class="s1">rtol=</span><span class="s3">1e-13</span><span class="s1">)</span>
</pre>
</body>
</html>