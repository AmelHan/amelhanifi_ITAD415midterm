<html>
<head>
<title>test_hdf.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_hdf.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">pathlib</span>
<span class="s0">from </span><span class="s1">time </span><span class="s0">import </span><span class="s1">sleep</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">packaging.version </span><span class="s0">import </span><span class="s1">Version</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.dataframe </span><span class="s0">as </span><span class="s1">dd</span>
<span class="s0">from </span><span class="s1">dask._compatibility </span><span class="s0">import </span><span class="s1">PY_VERSION</span>
<span class="s0">from </span><span class="s1">dask.dataframe._compat </span><span class="s0">import </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">dask.dataframe.optimize </span><span class="s0">import </span><span class="s1">optimize_dataframe_getitem</span>
<span class="s0">from </span><span class="s1">dask.dataframe.utils </span><span class="s0">import </span><span class="s1">assert_eq</span>
<span class="s0">from </span><span class="s1">dask.layers </span><span class="s0">import </span><span class="s1">DataFrameIOLayer</span>
<span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">dependency_depth</span><span class="s0">, </span><span class="s1">tmpdir</span><span class="s0">, </span><span class="s1">tmpfile</span>

<span class="s2"># there's no support in upstream for writing HDF with extension dtypes yet.</span>
<span class="s2"># see https://github.com/pandas-dev/pandas/issues/31199</span>
<span class="s1">pytestmark = pytest.mark.skip_with_pyarrow_strings  </span><span class="s2"># no support for hdf yet</span>


<span class="s0">def </span><span class="s1">test_to_hdf():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">out[:])</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.x.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_series_equal(df.x</span><span class="s0">, </span><span class="s1">out[:])</span>

    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">out[:])</span>

    <span class="s2"># test compute = False</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">r = a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">r.compute()</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">out[:])</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s1">PY_VERSION &gt;= Version(</span><span class="s3">&quot;3.11&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s3">&quot;segfaults due to https://github.com/PyTables/PyTables/issues/977&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_to_hdf_multiple_nodes():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">b = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s2"># saving to multiple nodes</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple nodes making sure order is kept</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">b.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df16</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple datasets with custom name_function</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data_*&quot;</span><span class="s0">, </span><span class="s1">name_function=</span><span class="s0">lambda </span><span class="s1">i: </span><span class="s3">&quot;a&quot; </span><span class="s1">* (i + </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data_*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data_a&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(out</span><span class="s0">, </span><span class="s1">df.iloc[:</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data_aa&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(out</span><span class="s0">, </span><span class="s1">df.iloc[</span><span class="s4">2</span><span class="s1">:])</span>

    <span class="s2"># test multiple nodes with hdf object</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">pd.HDFStore(fn) </span><span class="s0">as </span><span class="s1">hdf:</span>
            <span class="s1">b.to_hdf(hdf</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df16</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># Test getitem optimization</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)[[</span><span class="s3">&quot;x&quot;</span><span class="s1">]]</span>
        <span class="s1">dsk = optimize_dataframe_getitem(out.dask</span><span class="s0">, </span><span class="s1">keys=out.__dask_keys__())</span>
        <span class="s1">read = [key </span><span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">dsk.layers </span><span class="s0">if </span><span class="s1">key.startswith(</span><span class="s3">&quot;read-hdf&quot;</span><span class="s1">)][</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">subgraph = dsk.layers[read]</span>
        <span class="s0">assert </span><span class="s1">isinstance(subgraph</span><span class="s0">, </span><span class="s1">DataFrameIOLayer)</span>
        <span class="s0">assert </span><span class="s1">subgraph.columns == [</span><span class="s3">&quot;x&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_to_hdf_multiple_files():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">b = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s2"># saving to multiple files</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.h5&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple files making sure order is kept</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.h5&quot;</span><span class="s1">)</span>
        <span class="s1">b.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df16</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple files where first file is longer</span>
    <span class="s2"># https://github.com/dask/dask/issues/8023</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn1 = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_1.h5&quot;</span><span class="s1">)</span>
        <span class="s1">fn2 = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_2.h5&quot;</span><span class="s1">)</span>
        <span class="s1">b.to_hdf(fn1</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn2</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf([fn1</span><span class="s0">, </span><span class="s1">fn2]</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(pd.concat([df16</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple files with custom name_function</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.h5&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">name_function=</span><span class="s0">lambda </span><span class="s1">i: </span><span class="s3">&quot;a&quot; </span><span class="s1">* (i + </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

        <span class="s1">out = pd.read_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_a.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(out</span><span class="s0">, </span><span class="s1">df.iloc[:</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">out = pd.read_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_aa.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(out</span><span class="s0">, </span><span class="s1">df.iloc[</span><span class="s4">2</span><span class="s1">:])</span>

    <span class="s2"># test hdf object</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">pd.HDFStore(fn) </span><span class="s0">as </span><span class="s1">hdf:</span>
            <span class="s1">a.to_hdf(hdf</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_modes_multiple_nodes():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s2"># appending a single partition to existing data</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data2&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># overwriting a file with a single partition</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data2&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># appending two partitions to existing data</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data2&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># overwriting a file with two partitions</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data2&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># overwriting a single partition, keeping other partitions</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data1&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data2&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">append=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_modes_multiple_files():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s2"># appending a single partition to existing data</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># appending two partitions to existing data</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># overwriting a file with two partitions</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># overwriting a single partition, keeping other partitions</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data1&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s1">append=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(dd.concat([df</span><span class="s0">, </span><span class="s1">df])</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_link_optimizations():</span>
    <span class="s5">&quot;&quot;&quot;testing dask link levels is correct by calculating the depth of the dask graph&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s2"># saving to multiple hdf files, no links are needed</span>
    <span class="s2"># expected layers: from_pandas, to_hdf, list = depth of 3</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">d = a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">dependency_depth(d.dask) == </span><span class="s4">3</span>

    <span class="s2"># saving to a single hdf file with multiple nodes</span>
    <span class="s2"># all subsequent nodes depend on the first</span>
    <span class="s2"># expected layers: from_pandas, first to_hdf(creates file+node), subsequent to_hdfs, list = 4</span>
    <span class="s0">with </span><span class="s1">tmpfile() </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">d = a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">dependency_depth(d.dask) == </span><span class="s4">4</span>

    <span class="s2"># saving to a single hdf file with a single node</span>
    <span class="s2"># every node depends on the previous node</span>
    <span class="s2"># expected layers: from_pandas, to_hdf times npartitions(15), list = 2 + npartitions = 17</span>
    <span class="s0">with </span><span class="s1">tmpfile() </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">d = a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">dependency_depth(d.dask) == </span><span class="s4">2 </span><span class="s1">+ a.npartitions</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s1">PY_VERSION &gt;= Version(</span><span class="s3">&quot;3.11&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s3">&quot;segfaults due to https://github.com/PyTables/PyTables/issues/977&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_to_hdf_lock_delays():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s2"># adding artificial delays to make sure last tasks finish first</span>
    <span class="s2"># that's a way to simulate last tasks finishing last</span>
    <span class="s0">def </span><span class="s1">delayed_nop(i):</span>
        <span class="s0">if </span><span class="s1">i.iloc[</span><span class="s4">1</span><span class="s1">] &lt; </span><span class="s4">10</span><span class="s1">:</span>
            <span class="s1">sleep(</span><span class="s4">0.1 </span><span class="s1">* (</span><span class="s4">10 </span><span class="s1">- i.iloc[</span><span class="s4">1</span><span class="s1">]))</span>
        <span class="s0">return </span><span class="s1">i</span>

    <span class="s2"># saving to multiple hdf nodes</span>
    <span class="s0">with </span><span class="s1">tmpfile() </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a = a.apply(delayed_nop</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">meta=a)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df16</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># saving to multiple hdf files</span>
    <span class="s2"># adding artificial delays to make sure last tasks finish first</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data*&quot;</span><span class="s1">)</span>
        <span class="s1">a = a.apply(delayed_nop</span><span class="s0">, </span><span class="s1">axis=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">meta=a)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df16</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_exceptions():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>

    <span class="s2"># triggering too many asterisks error</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.h5&quot;</span><span class="s1">)</span>
            <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data_*&quot;</span><span class="s1">)</span>

    <span class="s2"># triggering too many asterisks error</span>
    <span class="s0">with </span><span class="s1">tmpfile() </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">pd.HDFStore(fn) </span><span class="s0">as </span><span class="s1">hdf:</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
                <span class="s1">a.to_hdf(hdf</span><span class="s0">, </span><span class="s3">&quot;/data_*_*&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s1">PY_VERSION &gt;= Version(</span><span class="s3">&quot;3.11&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s3">&quot;segfaults due to https://github.com/PyTables/PyTables/issues/977&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;scheduler&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">&quot;sync&quot;</span><span class="s0">, </span><span class="s3">&quot;threads&quot;</span><span class="s0">, </span><span class="s3">&quot;processes&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;npartitions&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">10</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_to_hdf_schedulers(scheduler</span><span class="s0">, </span><span class="s1">npartitions):</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=npartitions)</span>

    <span class="s2"># test single file single node</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">scheduler=scheduler)</span>
        <span class="s1">out = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># test multiple files single node</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.h5&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">scheduler=scheduler)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>

    <span class="s2"># test single file multiple nodes</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">scheduler=scheduler)</span>
        <span class="s1">out = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">out)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_kwargs():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;aaaa&quot;</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">ddf.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;foo4&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s0">, </span><span class="s1">min_itemsize=</span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">df2 = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;foo4&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df2)</span>

    <span class="s2"># test shorthand 't' for table</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">ddf.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;foo4&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;t&quot;</span><span class="s0">, </span><span class="s1">min_itemsize=</span><span class="s4">4</span><span class="s1">)</span>
        <span class="s1">df2 = pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;foo4&quot;</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df2)</span>


<span class="s0">def </span><span class="s1">test_to_fmt_warns():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s2"># testing warning when breaking order</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">pytest.warns(</span>
            <span class="s1">UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;To preserve order between partitions name_function&quot;</span>
        <span class="s1">):</span>
            <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">name_function=str)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s3">&quot;data_*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">name_function=str)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s3">&quot;data, compare&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span>
            <span class="s1">pd.DataFrame(</span>
                <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">,</span>
                <span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">tm.assert_frame_equal</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(pd.Series([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">tm.assert_series_equal)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_hdf(data</span><span class="s0">, </span><span class="s1">compare):</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">data.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>
            <span class="s0">assert False</span>
        <span class="s0">except </span><span class="s1">TypeError </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s0">assert </span><span class="s3">&quot;format='table'&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">data.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">a = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a.npartitions == </span><span class="s4">2</span>

        <span class="s1">compare(a.compute()</span><span class="s0">, </span><span class="s1">data)</span>

        <span class="s1">compare(</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">start=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">stop=</span><span class="s4">3</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">).compute()</span><span class="s0">,</span>
            <span class="s1">pd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">start=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">stop=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">sorted(dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">).dask) == sorted(</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">).dask</span>
        <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">sorted_data = data.sort_index()</span>
        <span class="s1">sorted_data.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">a = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">sorted_index=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a.npartitions == </span><span class="s4">2</span>

        <span class="s1">compare(a.compute()</span><span class="s0">, </span><span class="s1">sorted_data)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_multiply_open():</span>
    <span class="s5">&quot;&quot;&quot;Test that we can read from a file that's already opened elsewhere in 
    read-only mode.&quot;&quot;&quot;</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pd.HDFStore(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">):</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;r&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s1">PY_VERSION &gt;= Version(</span><span class="s3">&quot;3.11&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s3">&quot;segfaults due to https://github.com/PyTables/PyTables/issues/977&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_hdf_multiple():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s3">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s3">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s3">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span><span class="s0">,</span>
        <span class="s1">index=[</span>
            <span class="s4">1.0</span><span class="s0">,</span>
            <span class="s4">2.0</span><span class="s0">,</span>
            <span class="s4">3.0</span><span class="s0">,</span>
            <span class="s4">4.0</span><span class="s0">,</span>
            <span class="s4">5.0</span><span class="s0">,</span>
            <span class="s4">6.0</span><span class="s0">,</span>
            <span class="s4">7.0</span><span class="s0">,</span>
            <span class="s4">8.0</span><span class="s0">,</span>
            <span class="s4">9.0</span><span class="s0">,</span>
            <span class="s4">10.0</span><span class="s0">,</span>
            <span class="s4">11.0</span><span class="s0">,</span>
            <span class="s4">12.0</span><span class="s0">,</span>
            <span class="s4">13.0</span><span class="s0">,</span>
            <span class="s4">14.0</span><span class="s0">,</span>
            <span class="s4">15.0</span><span class="s0">,</span>
            <span class="s4">16.0</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s1">)</span>
        <span class="s1">r = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data*&quot;</span><span class="s0">, </span><span class="s1">sorted_index=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a.npartitions == r.npartitions</span>
        <span class="s0">assert </span><span class="s1">a.divisions == r.divisions</span>
        <span class="s1">assert_eq(a</span><span class="s0">, </span><span class="s1">r)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_start_stop_values():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df.to_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;number of rows&quot;</span><span class="s1">):</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">stop=</span><span class="s4">10</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;is above or equal to&quot;</span><span class="s1">):</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">start=</span><span class="s4">10</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;positive integer&quot;</span><span class="s1">):</span>
            <span class="s1">dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=-</span><span class="s4">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_hdf_globbing():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">tdir:</span>
        <span class="s1">df.to_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/foo/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">df.to_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;two.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/bar/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">df.to_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;two.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/foo/data&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">dask.config.set(scheduler=</span><span class="s3">&quot;sync&quot;</span><span class="s1">):</span>
            <span class="s1">res = dd.read_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/*/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">res.npartitions == </span><span class="s4">2</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">df)</span>

            <span class="s1">res = dd.read_hdf(</span>
                <span class="s1">os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/*/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s0">, </span><span class="s1">start=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">stop=</span><span class="s4">3</span>
            <span class="s1">)</span>
            <span class="s1">expected = pd.read_hdf(</span>
                <span class="s1">os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/foo/data&quot;</span><span class="s0">, </span><span class="s1">start=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">stop=</span><span class="s4">3</span>
            <span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">expected)</span>

            <span class="s1">res = dd.read_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;two.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/*/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">res.npartitions == </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">pd.concat([df] * </span><span class="s4">2</span><span class="s1">))</span>

            <span class="s1">res = dd.read_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;*.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/foo/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">res.npartitions == </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">pd.concat([df] * </span><span class="s4">2</span><span class="s1">))</span>

            <span class="s1">res = dd.read_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;*.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;/*/data&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">res.npartitions == </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">2</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">pd.concat([df] * </span><span class="s4">3</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_hdf_file_list():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">tdir:</span>
        <span class="s1">df.iloc[:</span><span class="s4">2</span><span class="s1">].to_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">df.iloc[</span><span class="s4">2</span><span class="s1">:].to_hdf(os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;two.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">dask.config.set(scheduler=</span><span class="s3">&quot;sync&quot;</span><span class="s1">):</span>
            <span class="s1">input_files = [os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;one.h5&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">os.path.join(tdir</span><span class="s0">, </span><span class="s3">&quot;two.h5&quot;</span><span class="s1">)]</span>
            <span class="s1">res = dd.read_hdf(input_files</span><span class="s0">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(res.compute()</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_pattern_pathlike():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">path = pathlib.Path(fn)</span>
        <span class="s1">df.to_hdf(path</span><span class="s0">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s1">)</span>
        <span class="s1">res = dd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;dataframe&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_to_hdf_path_pathlike():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">3</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">path = pathlib.Path(fn)</span>
        <span class="s1">ddf.to_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">res = pd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/data&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">ddf)</span>


<span class="s0">def </span><span class="s1">test_read_hdf_doesnt_segfault():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">N = </span><span class="s4">40</span>
        <span class="s1">df = pd.DataFrame(np.random.randn(N</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
        <span class="s0">with </span><span class="s1">pd.HDFStore(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">store:</span>
            <span class="s1">store.append(</span><span class="s3">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">ddf = dd.read_hdf(fn</span><span class="s0">, </span><span class="s3">&quot;/x&quot;</span><span class="s0">, </span><span class="s1">chunksize=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(ddf) == N</span>


<span class="s0">def </span><span class="s1">test_hdf_filenames():</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s3">&quot;x&quot;</span><span class="s1">: [</span><span class="s3">&quot;a&quot;</span><span class="s0">, </span><span class="s3">&quot;b&quot;</span><span class="s0">, </span><span class="s3">&quot;c&quot;</span><span class="s0">, </span><span class="s3">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ddf.to_hdf(</span><span class="s3">&quot;foo*.hdf5&quot;</span><span class="s0">, </span><span class="s3">&quot;key&quot;</span><span class="s1">) == [</span><span class="s3">&quot;foo0.hdf5&quot;</span><span class="s0">, </span><span class="s3">&quot;foo1.hdf5&quot;</span><span class="s1">]</span>
    <span class="s1">os.remove(</span><span class="s3">&quot;foo0.hdf5&quot;</span><span class="s1">)</span>
    <span class="s1">os.remove(</span><span class="s3">&quot;foo1.hdf5&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_hdf_path_exceptions():</span>
    <span class="s2"># single file doesn't exist</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IOError):</span>
        <span class="s1">dd.read_hdf(</span><span class="s3">&quot;nonexistant_store_X34HJK&quot;</span><span class="s0">, </span><span class="s3">&quot;/tmp&quot;</span><span class="s1">)</span>

    <span class="s2"># a file from a list of files doesn't exist</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IOError):</span>
        <span class="s1">dd.read_hdf([</span><span class="s3">&quot;nonexistant_store_X34HJK&quot;</span><span class="s0">, </span><span class="s3">&quot;nonexistant_store_UY56YH&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;/tmp&quot;</span><span class="s1">)</span>

    <span class="s2"># list of files is empty</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dd.read_hdf([]</span><span class="s0">, </span><span class="s3">&quot;/tmp&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_hdf_nonpandas_keys():</span>
    <span class="s2"># https://github.com/dask/dask/issues/5934</span>
    <span class="s2"># TODO: maybe remove this if/when pandas copes with all keys</span>

    <span class="s1">tables = pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">tables</span>

    <span class="s0">class </span><span class="s1">Table1(tables.IsDescription):</span>
        <span class="s1">value1 = tables.Float32Col()</span>

    <span class="s0">class </span><span class="s1">Table2(tables.IsDescription):</span>
        <span class="s1">value2 = tables.Float32Col()</span>

    <span class="s0">class </span><span class="s1">Table3(tables.IsDescription):</span>
        <span class="s1">value3 = tables.Float32Col()</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s3">&quot;h5&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">path:</span>
        <span class="s0">with </span><span class="s1">tables.open_file(path</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">h5file:</span>
            <span class="s1">group = h5file.create_group(</span><span class="s3">&quot;/&quot;</span><span class="s0">, </span><span class="s3">&quot;group&quot;</span><span class="s1">)</span>
            <span class="s1">t = h5file.create_table(group</span><span class="s0">, </span><span class="s3">&quot;table1&quot;</span><span class="s0">, </span><span class="s1">Table1</span><span class="s0">, </span><span class="s3">&quot;Table 1&quot;</span><span class="s1">)</span>
            <span class="s1">row = t.row</span>
            <span class="s1">row[</span><span class="s3">&quot;value1&quot;</span><span class="s1">] = </span><span class="s4">1</span>
            <span class="s1">row.append()</span>
            <span class="s1">t = h5file.create_table(group</span><span class="s0">, </span><span class="s3">&quot;table2&quot;</span><span class="s0">, </span><span class="s1">Table2</span><span class="s0">, </span><span class="s3">&quot;Table 2&quot;</span><span class="s1">)</span>
            <span class="s1">row = t.row</span>
            <span class="s1">row[</span><span class="s3">&quot;value2&quot;</span><span class="s1">] = </span><span class="s4">1</span>
            <span class="s1">row.append()</span>
            <span class="s1">t = h5file.create_table(group</span><span class="s0">, </span><span class="s3">&quot;table3&quot;</span><span class="s0">, </span><span class="s1">Table3</span><span class="s0">, </span><span class="s3">&quot;Table 3&quot;</span><span class="s1">)</span>
            <span class="s1">row = t.row</span>
            <span class="s1">row[</span><span class="s3">&quot;value3&quot;</span><span class="s1">] = </span><span class="s4">1</span>
            <span class="s1">row.append()</span>

        <span class="s2"># pandas keys should still work</span>
        <span class="s1">bar = pd.DataFrame(np.random.randn(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">bar.to_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/bar&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;table&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;a&quot;</span><span class="s1">)</span>

        <span class="s1">dd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/group/table1&quot;</span><span class="s1">)</span>
        <span class="s1">dd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/group/table2&quot;</span><span class="s1">)</span>
        <span class="s1">dd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/group/table3&quot;</span><span class="s1">)</span>
        <span class="s1">dd.read_hdf(path</span><span class="s0">, </span><span class="s3">&quot;/bar&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_hdf_empty_dataframe(tmp_path):</span>
    <span class="s1">pytest.importorskip(</span><span class="s3">&quot;tables&quot;</span><span class="s1">)</span>
    <span class="s2"># https://github.com/dask/dask/issues/8707</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.hdf </span><span class="s0">import </span><span class="s1">dont_use_fixed_error_message</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;A&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s3">&quot;B&quot;</span><span class="s1">: []}</span><span class="s0">, </span><span class="s1">index=[])</span>
    <span class="s1">df.to_hdf(tmp_path / </span><span class="s3">&quot;data.h5&quot;</span><span class="s0">, </span><span class="s1">format=</span><span class="s3">&quot;fixed&quot;</span><span class="s0">, </span><span class="s1">key=</span><span class="s3">&quot;df&quot;</span><span class="s0">, </span><span class="s1">mode=</span><span class="s3">&quot;w&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=dont_use_fixed_error_message):</span>
        <span class="s1">dd.read_hdf(tmp_path / </span><span class="s3">&quot;data.h5&quot;</span><span class="s0">, </span><span class="s3">&quot;df&quot;</span><span class="s1">)</span>
</pre>
</body>
</html>