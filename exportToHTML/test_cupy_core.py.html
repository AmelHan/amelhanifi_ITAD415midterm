<html>
<head>
<title>test_cupy_core.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_cupy_core.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">packaging.version </span><span class="s0">import </span><span class="s1">parse </span><span class="s0">as </span><span class="s1">parse_version</span>

<span class="s1">pytestmark = pytest.mark.gpu</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span>
<span class="s0">from </span><span class="s1">dask.sizeof </span><span class="s0">import </span><span class="s1">sizeof</span>

<span class="s1">cupy = pytest.importorskip(</span><span class="s2">&quot;cupy&quot;</span><span class="s1">)</span>
<span class="s1">cupy_version = parse_version(cupy.__version__)</span>


<span class="s1">functions = [</span>
    <span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.expm1(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: </span><span class="s3">2 </span><span class="s1">* x</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x / </span><span class="s3">2</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x**</span><span class="s3">2</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x + x</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x * x</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x[:</span><span class="s3">1</span><span class="s0">, None, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.T</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.transpose(x</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.sum()</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.empty_like(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.ones_like(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.zeros_like(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: da.full_like(x</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: x.mean()</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s1">cupy_version &lt; parse_version(</span><span class="s2">&quot;6.4.0&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s2">&quot;Requires CuPy 6.4.0+ &quot;</span>
            <span class="s2">&quot;(with https://github.com/cupy/cupy/pull/2418)&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s0">lambda </span><span class="s1">x: x.moment(order=</span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.moment(order=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: x.std()</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s1">cupy_version &lt; parse_version(</span><span class="s2">&quot;6.4.0&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s2">&quot;Requires CuPy 6.4.0+ &quot;</span>
            <span class="s2">&quot;(with https://github.com/cupy/cupy/pull/2418)&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: x.var()</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s1">cupy_version &lt; parse_version(</span><span class="s2">&quot;6.4.0&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s2">&quot;Requires CuPy 6.4.0+ &quot;</span>
            <span class="s2">&quot;(with https://github.com/cupy/cupy/pull/2418)&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: x.dot(np.arange(x.shape[-</span><span class="s3">1</span><span class="s1">]))</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.xfail(reason=</span><span class="s2">&quot;cupy.dot(numpy) fails&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: x.dot(np.eye(x.shape[-</span><span class="s3">1</span><span class="s1">]))</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.xfail(reason=</span><span class="s2">&quot;cupy.dot(numpy) fails&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: da.tensordot(x</span><span class="s0">, </span><span class="s1">np.ones(x.shape[:</span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">axes=[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.xfail(reason=</span><span class="s2">&quot;cupy.dot(numpy) fails&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.sum(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.max(axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.sum(axis=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.astype(np.complex128)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x: x * </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s0">lambda </span><span class="s1">x: x.round(</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.reshape((x.shape[</span><span class="s3">0</span><span class="s1">] * x.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">2</span><span class="s1">]))</span><span class="s0">,</span>
    <span class="s4"># Rechunking here is required, see https://github.com/dask/dask/issues/2561</span>
    <span class="s0">lambda </span><span class="s1">x: (x.rechunk(x.shape)).reshape((x.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">2</span><span class="s1">]))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.reshape((x.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">2</span><span class="s1">] / </span><span class="s3">2</span><span class="s0">, </span><span class="s1">x.shape[</span><span class="s3">2</span><span class="s1">] / </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: abs(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x &gt; </span><span class="s3">0.5</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.rechunk((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: x.rechunk((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span><span class="s0">lambda </span><span class="s1">x: da.einsum(</span><span class="s2">&quot;ijk,ijk&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.isneginf(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.isposinf(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.isreal(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.iscomplex(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.real(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.imag(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.exp(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.fix(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.i0(x.reshape((</span><span class="s3">24</span><span class="s0">,</span><span class="s1">)))</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.sinc(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.nan_to_num(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.max(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.min(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.prod(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.any(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.all(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.nansum(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.nanprod(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.nanmin(x)</span><span class="s0">,</span>
    <span class="s0">lambda </span><span class="s1">x: np.nanmax(x)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: np.angle(x)</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s0">not </span><span class="s1">dask.utils.has_keyword(cupy.angle</span><span class="s0">, </span><span class="s2">&quot;deg&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s2">&quot;Requires `deg` argument in `cupy.angle()` introduced in &quot;</span>
            <span class="s2">&quot;https://github.com/cupy/cupy/pull/6905&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">pytest.param(</span>
        <span class="s0">lambda </span><span class="s1">x: np.angle(x</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">marks=pytest.mark.skipif(</span>
            <span class="s0">not </span><span class="s1">dask.utils.has_keyword(cupy.angle</span><span class="s0">, </span><span class="s2">&quot;deg&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">reason=</span><span class="s2">&quot;Requires `deg` argument in `cupy.angle()` introduced in &quot;</span>
            <span class="s2">&quot;https://github.com/cupy/cupy/pull/6905&quot;</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">]</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">functions)</span>
<span class="s0">def </span><span class="s1">test_basic(func):</span>
    <span class="s1">c = cupy.random.default_rng().random((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">n = c.get()</span>
    <span class="s1">dc = da.from_array(c</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">asarray=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">dn = da.from_array(n</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">ddc = func(dc)</span>
    <span class="s1">ddn = func(dn)</span>

    <span class="s0">assert </span><span class="s1">type(ddc._meta) </span><span class="s0">is </span><span class="s1">cupy.ndarray</span>

    <span class="s0">if </span><span class="s1">next(iter(ddc.dask.keys()))[</span><span class="s3">0</span><span class="s1">].startswith(</span><span class="s2">&quot;empty&quot;</span><span class="s1">):</span>
        <span class="s4"># We can't verify for data correctness when testing empty_like</span>
        <span class="s0">assert </span><span class="s1">type(ddc._meta) </span><span class="s0">is </span><span class="s1">type(ddc.compute())</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_eq(ddc</span><span class="s0">, </span><span class="s1">ddc)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
        <span class="s1">assert_eq(ddc</span><span class="s0">, </span><span class="s1">ddn</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;f4&quot;</span><span class="s0">, </span><span class="s2">&quot;f8&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_sizeof(dtype):</span>
    <span class="s1">c = cupy.random.default_rng().random((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>

    <span class="s0">assert </span><span class="s1">sizeof(c) == c.nbytes</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;arr&quot;</span><span class="s0">, </span><span class="s1">[np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">cupy.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.from_array(cupy.arange(</span><span class="s3">5</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;like&quot;</span><span class="s0">, </span><span class="s1">[np.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">cupy.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">da.from_array(cupy.arange(</span><span class="s3">5</span><span class="s1">))]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_asanyarray(arr</span><span class="s0">, </span><span class="s1">like):</span>
    <span class="s0">if </span><span class="s1">isinstance(like</span><span class="s0">, </span><span class="s1">np.ndarray) </span><span class="s0">and </span><span class="s1">isinstance(</span>
        <span class="s1">da.utils.meta_from_array(arr)</span><span class="s0">, </span><span class="s1">cupy.ndarray</span>
    <span class="s1">):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
            <span class="s1">a = da.utils.asanyarray_safe(arr</span><span class="s0">, </span><span class="s1">like=like)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">a = da.utils.asanyarray_safe(arr</span><span class="s0">, </span><span class="s1">like=like)</span>
        <span class="s0">assert </span><span class="s1">type(a) </span><span class="s0">is </span><span class="s1">type(like)</span>


<span class="s0">def </span><span class="s1">test_vindex():</span>
    <span class="s1">x_np = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">x_cp = cupy.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>

    <span class="s1">d_np = da.from_array(x_np</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">d_cp = da.from_array(x_cp</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">res_np = da.core._vindex(d_np</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span>
    <span class="s1">res_cp = da.core._vindex(d_cp</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s1">])</span>

    <span class="s0">assert </span><span class="s1">type(res_cp._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">res_cp</span><span class="s0">, </span><span class="s1">res_cp</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span>
    <span class="s1">)  </span><span class="s4"># Check that _meta and computed arrays match types</span>

    <span class="s1">assert_eq(res_np</span><span class="s0">, </span><span class="s1">res_cp</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_view():</span>
    <span class="s1">x = np.arange(</span><span class="s3">56</span><span class="s1">).reshape((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(cupy.array(x)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">result = d.view()</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.view()</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">result = d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">result = d.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(isinstance(s</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">d.shape)</span>

    <span class="s1">x = np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i1&quot;</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(cupy.array(x)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">result = d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(x.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x = np.arange(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;i1&quot;</span><span class="s1">)</span>
        <span class="s1">d = da.from_array(cupy.array(x)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;asdf&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_view_fortran():</span>
    <span class="s1">x = np.asfortranarray(np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)))</span>
    <span class="s1">d = da.from_array(cupy.asfortranarray(cupy.array(x))</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s1">result = d.view(</span><span class="s2">&quot;i4&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.T.view(</span><span class="s2">&quot;i4&quot;</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">result = d.view(</span><span class="s2">&quot;i2&quot;</span><span class="s0">, </span><span class="s1">order=</span><span class="s2">&quot;F&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">type(result._meta) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">result)  </span><span class="s4"># Check that _meta and computed arrays match types</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">x.T.view(</span><span class="s2">&quot;i2&quot;</span><span class="s1">).T</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_getter():</span>
    <span class="s1">result = da.core.getter(cupy.arange(</span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">None, </span><span class="s1">slice(</span><span class="s0">None, None</span><span class="s1">)))</span>

    <span class="s0">assert </span><span class="s1">type(result) == cupy.ndarray</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">)[</span><span class="s0">None, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">check_type=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_store_kwargs():</span>
    <span class="s1">d = da.from_array(cupy.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">a = d + </span><span class="s3">1</span>

    <span class="s1">called = [</span><span class="s0">False</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">get_func(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">assert </span><span class="s1">kwargs.pop(</span><span class="s2">&quot;foo&quot;</span><span class="s1">) == </span><span class="s2">&quot;test kwarg&quot;</span>
        <span class="s1">r = dask.get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>
        <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">r</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = cupy.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">da.core.store([a]</span><span class="s0">, </span><span class="s1">[at]</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = cupy.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">a.store(at</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s1">called[</span><span class="s3">0</span><span class="s1">] = </span><span class="s0">False</span>
    <span class="s1">at = cupy.zeros(shape=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">da.core.store([a]</span><span class="s0">, </span><span class="s1">[at]</span><span class="s0">, </span><span class="s1">scheduler=get_func</span><span class="s0">, </span><span class="s1">return_stored=</span><span class="s0">True, </span><span class="s1">foo=</span><span class="s2">&quot;test kwarg&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">called[</span><span class="s3">0</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_setitem_1d():</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">x[x &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_setitem_2d():</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">x[x &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">dx[dx &gt; </span><span class="s3">6</span><span class="s1">] = -</span><span class="s3">1</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">2</span>

    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx)</span>


<span class="s0">def </span><span class="s1">test_setitem_extended_API_0d():</span>
    <span class="s4"># 0-d array</span>
    <span class="s1">x = cupy.array(</span><span class="s3">9</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x.copy())</span>

    <span class="s1">x[()] = -</span><span class="s3">1</span>
    <span class="s1">dx[()] = -</span><span class="s3">1</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">x[...] = -</span><span class="s3">11</span>
    <span class="s1">dx[...] = -</span><span class="s3">11</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index, value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">8</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(</span><span class="s3">8</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[-</span><span class="s3">30</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[-</span><span class="s3">40</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(-</span><span class="s3">3</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(</span><span class="s3">3</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(-</span><span class="s3">4</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_extended_API_1d(index</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s4"># 1-d array</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">dx[index] = value</span>
    <span class="s1">x[index] = value</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index, value&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[Ellipsis</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, None, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(Ellipsis</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">range(</span><span class="s3">6</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Assigning `range` to CuPy array is not supported&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s3">3</span><span class="s0">,</span>
            <span class="s1">range(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Assigning `range` to CuPy array is not supported&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">31</span><span class="s0">, </span><span class="s1">-</span><span class="s3">32</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[([-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">30</span><span class="s0">, </span><span class="s1">-</span><span class="s3">31</span><span class="s0">, </span><span class="s1">-</span><span class="s3">32</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">(slice(</span><span class="s0">None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s0">None, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">[-</span><span class="s3">50</span><span class="s0">, </span><span class="s1">-</span><span class="s3">51</span><span class="s0">, </span><span class="s1">-</span><span class="s3">52</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">60</span><span class="s0">, </span><span class="s1">-</span><span class="s3">61</span><span class="s0">, </span><span class="s1">-</span><span class="s3">62</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">(slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">[[-</span><span class="s3">70</span><span class="s0">, </span><span class="s1">-</span><span class="s3">71</span><span class="s0">, </span><span class="s1">-</span><span class="s3">72</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(reason=</span><span class="s2">&quot;Unsupported assigning `list` to CuPy array&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">[[-</span><span class="s3">80</span><span class="s0">, </span><span class="s1">-</span><span class="s3">81</span><span class="s0">, </span><span class="s3">91</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.flaky(reruns=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[([</span><span class="s0">True, False, False, False, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, False, True, True, False, True, False, True, True</span><span class="s1">])</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(np.array([</span><span class="s0">False, False, True, True, False, False</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(cupy.array([</span><span class="s0">False, False, True, True, False, False</span><span class="s1">])</span><span class="s0">, </span><span class="s1">slice(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">(</span>
                <span class="s3">4</span><span class="s0">,</span>
                <span class="s1">da.from_array(</span>
                    <span class="s1">[</span><span class="s0">False, False, True, True, False, False, True, False, False, True</span><span class="s1">]</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">-</span><span class="s3">1</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Unsupported assigning Dask Array to CuPy array&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">5</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">99</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(</span><span class="s3">5</span><span class="s0">, None, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Assigning `range` to CuPy array is not supported&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">[slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">98</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span>
            <span class="s1">slice(</span><span class="s3">1</span><span class="s0">, None, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">range(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">21</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">marks=pytest.mark.skip(</span>
                <span class="s1">reason=</span><span class="s2">&quot;Assigning `range` to CuPy array is not supported&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_setitem_extended_API_2d(index</span><span class="s0">, </span><span class="s1">value):</span>
    <span class="s4"># 2-d array</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">60</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">dx[index] = value</span>
    <span class="s1">x[index] = value</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s0">def </span><span class="s1">test_setitem_extended_API_2d_rhs_func_of_lhs():</span>
    <span class="s4"># Cases:</span>
    <span class="s4"># * RHS and/or indices are a function of the LHS</span>
    <span class="s4"># * Indices have unknown chunk sizes</span>
    <span class="s4"># * RHS has extra leading size 1 dimensions compared to LHS</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">60</span><span class="s1">).reshape((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">chunks = (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">dx[</span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">3</span><span class="s1">] = -</span><span class="s3">5</span>
    <span class="s1">x[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">] &gt; </span><span class="s3">3</span><span class="s1">] = -</span><span class="s3">5</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dx[</span><span class="s3">0</span><span class="s1">] &lt; -</span><span class="s3">2</span><span class="s1">] = -</span><span class="s3">7</span>
    <span class="s1">x[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">] &lt; -</span><span class="s3">2</span><span class="s1">] = -</span><span class="s3">7</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[dx % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">x[x % </span><span class="s3">2 </span><span class="s1">== </span><span class="s3">0</span><span class="s1">] = -</span><span class="s3">8</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">] = -dx[:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">] = -x[:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">1</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">] = -dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:</span><span class="s3">3</span><span class="s1">] = -x[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">:</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[...] = dx</span>
    <span class="s1">x[...] = x</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[...] = dx[...]</span>
    <span class="s1">x[...] = x[...]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = dx[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s1">] = x[-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = dx[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = x[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = dx[:</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = x[:</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.from_array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">8</span><span class="s1">] = [</span><span class="s3">99</span><span class="s0">, </span><span class="s3">88</span><span class="s1">]</span>
    <span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">8</span><span class="s1">] = [</span><span class="s3">99</span><span class="s0">, </span><span class="s3">88</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[:</span><span class="s0">, </span><span class="s1">index] = dx[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]] = x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">23</span><span class="s0">, </span><span class="s1">-</span><span class="s3">33</span><span class="s1">]</span>
    <span class="s1">x[index.compute()</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">23</span><span class="s0">, </span><span class="s1">-</span><span class="s3">33</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[(index</span><span class="s0">,</span><span class="s1">)] = -</span><span class="s3">34</span>
    <span class="s1">x[(index.compute()</span><span class="s0">,</span><span class="s1">)] = -</span><span class="s3">34</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = index - </span><span class="s3">4</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">dx[index</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">43</span><span class="s0">, </span><span class="s1">-</span><span class="s3">53</span><span class="s1">]</span>
    <span class="s1">x[index.compute()</span><span class="s0">, </span><span class="s3">7</span><span class="s1">] = [-</span><span class="s3">43</span><span class="s0">, </span><span class="s1">-</span><span class="s3">53</span><span class="s1">]</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">index = da.from_array([</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">x[[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]] = </span><span class="s3">9999</span>
    <span class="s1">dx[(index</span><span class="s0">,</span><span class="s1">)] = </span><span class="s3">9999</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">dx[...] = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

    <span class="s4"># Both tests below fail in CuPy due to leading singular dimensions</span>
    <span class="s0">if False</span><span class="s1">:</span>
        <span class="s4"># RHS has extra leading size 1 dimensions compared to LHS</span>
        <span class="s1">dx = da.from_array(x.copy()</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">v = x.reshape((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) + x.shape)</span>
        <span class="s1">x[...] = v</span>
        <span class="s1">dx[...] = v</span>
        <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>

        <span class="s1">index = da.where(da.arange(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)) &lt; </span><span class="s3">2</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">v = -cupy.arange(</span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]] = v</span>
        <span class="s1">dx[:</span><span class="s0">, </span><span class="s1">index] = v</span>
        <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">dx.compute())</span>


<span class="s0">def </span><span class="s1">test_setitem_on_read_only_blocks():</span>
    <span class="s4"># Outputs of broadcast_trick-style functions contain read-only</span>
    <span class="s4"># arrays</span>
    <span class="s1">dx = da.empty_like(cupy.array(())</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">99</span>

    <span class="s1">assert_eq(dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">99.0</span><span class="s1">)</span>

    <span class="s1">dx[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] = </span><span class="s3">88</span>

    <span class="s1">assert_eq(dx[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">88.0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_setitem_errs():</span>
    <span class="s1">x = da.ones_like(cupy.array(())</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[x &gt; </span><span class="s3">1</span><span class="s1">] = x</span>

    <span class="s4"># Shape mismatch</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, True, False</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, True, False</span><span class="s1">]] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, True, True, False</span><span class="s1">]] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[da.from_array([</span><span class="s0">True, True, True, False</span><span class="s1">])</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">da.from_array([</span><span class="s0">True, False, False, True</span><span class="s1">])] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:] = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>

    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s4"># Too many indices</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s1">:] = </span><span class="s3">2</span>

    <span class="s4"># 2-d boolean indexing a single dimension</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[[</span><span class="s0">True, True, False, False</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s4"># Too many/not enough booleans</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[</span><span class="s0">False, True, True, True, False</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s4"># 2-d indexing a single dimension</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">x[[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s4"># Multiple 1-d boolean/integer arrays</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]] = </span><span class="s3">6</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[[</span><span class="s0">True, True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">False, True, False, False</span><span class="s1">]] = </span><span class="s3">7</span>

    <span class="s4"># scalar boolean indexing</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[</span><span class="s0">True</span><span class="s1">] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[cupy.array(</span><span class="s0">True</span><span class="s1">)] = </span><span class="s3">5</span>

    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">da.from_array(</span><span class="s0">True</span><span class="s1">)] = </span><span class="s3">5</span>

    <span class="s4"># Scalar arrays</span>
    <span class="s1">y = da.from_array(cupy.array(</span><span class="s3">1</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(IndexError):</span>
        <span class="s1">y[:] = </span><span class="s3">2</span>

    <span class="s4"># RHS has non-brodacastable extra leading dimensions</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">12</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dx[...] = cupy.arange(</span><span class="s3">24</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s4"># RHS has extra leading size 1 dimensions compared to LHS</span>
    <span class="s1">x = cupy.arange(</span><span class="s3">12</span><span class="s1">).reshape((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">dx = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;xp&quot;</span><span class="s0">, </span><span class="s1">[np</span><span class="s0">, </span><span class="s1">da])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;orig_arr&quot;</span><span class="s0">, </span><span class="s1">[np.array</span><span class="s0">, </span><span class="s1">da.array])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;array_func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;array&quot;</span><span class="s0">, </span><span class="s2">&quot;asarray&quot;</span><span class="s0">, </span><span class="s2">&quot;asanyarray&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_array_like(xp</span><span class="s0">, </span><span class="s1">orig_arr</span><span class="s0">, </span><span class="s1">array_func):</span>
    <span class="s1">cp_func = getattr(cupy</span><span class="s0">, </span><span class="s1">array_func)</span>
    <span class="s1">xp_func = getattr(xp</span><span class="s0">, </span><span class="s1">array_func)</span>

    <span class="s1">cp_a = cp_func([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">xp_a = xp_func(orig_arr([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">like=da.from_array(cupy.array(())))</span>
    <span class="s0">assert </span><span class="s1">isinstance(xp_a</span><span class="s0">, </span><span class="s1">da.Array)</span>
    <span class="s0">assert </span><span class="s1">isinstance(xp_a._meta</span><span class="s0">, </span><span class="s1">cupy.ndarray)</span>
    <span class="s1">assert_eq(xp_a</span><span class="s0">, </span><span class="s1">cp_a)</span>
</pre>
</body>
</html>