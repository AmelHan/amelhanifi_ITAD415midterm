<html>
<head>
<title>test_sandwich_cov.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6a8759;}
.s5 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_sandwich_cov.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot; 
 
Created on Mon Dec 09 21:29:20 2013 
 
Author: Josef Perktold 
&quot;&quot;&quot;</span>

<span class="s3">import </span><span class="s1">os</span>
<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">import </span><span class="s1">pandas </span><span class="s3">as </span><span class="s1">pd</span>
<span class="s3">import </span><span class="s1">statsmodels.discrete.discrete_model </span><span class="s3">as </span><span class="s1">smd</span>
<span class="s3">from </span><span class="s1">statsmodels.genmod.generalized_linear_model </span><span class="s3">import </span><span class="s1">GLM</span>
<span class="s3">from </span><span class="s1">statsmodels.genmod </span><span class="s3">import </span><span class="s1">families</span>
<span class="s3">from </span><span class="s1">statsmodels.genmod.families </span><span class="s3">import </span><span class="s1">links</span>
<span class="s3">from </span><span class="s1">statsmodels.regression.linear_model </span><span class="s3">import </span><span class="s1">OLS</span>
<span class="s3">from </span><span class="s1">statsmodels.base.covtype </span><span class="s3">import </span><span class="s1">get_robustcov_results</span>
<span class="s3">import </span><span class="s1">statsmodels.stats.sandwich_covariance </span><span class="s3">as </span><span class="s1">sw</span>
<span class="s3">from </span><span class="s1">statsmodels.tools.tools </span><span class="s3">import </span><span class="s1">add_constant</span>


<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">assert_allclose</span><span class="s3">, </span><span class="s1">assert_equal</span><span class="s3">, </span><span class="s1">assert_</span>
<span class="s3">import </span><span class="s1">statsmodels.tools._testing </span><span class="s3">as </span><span class="s1">smt</span>


<span class="s0"># get data and results as module global for now, TODO: move to class</span>
<span class="s3">from </span><span class="s1">.results </span><span class="s3">import </span><span class="s1">results_count_robust_cluster </span><span class="s3">as </span><span class="s1">results_st</span>

<span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>

<span class="s1">filepath = os.path.join(cur_dir</span><span class="s3">, </span><span class="s4">&quot;results&quot;</span><span class="s3">, </span><span class="s4">&quot;ships.csv&quot;</span><span class="s1">)</span>
<span class="s1">data_raw = pd.read_csv(filepath</span><span class="s3">, </span><span class="s1">index_col=</span><span class="s3">False</span><span class="s1">)</span>
<span class="s1">data = data_raw.dropna()</span>

<span class="s0">#mod = smd.Poisson.from_formula('accident ~ yr_con + op_75_79', data=dat)</span>
<span class="s0"># Do not use formula for tests against Stata because intercept needs to be last</span>
<span class="s1">endog = data[</span><span class="s4">'accident'</span><span class="s1">]</span>
<span class="s1">exog_data = data[</span><span class="s4">'yr_con op_75_79'</span><span class="s1">.split()]</span>
<span class="s1">exog = add_constant(exog_data</span><span class="s3">, </span><span class="s1">prepend=</span><span class="s3">False</span><span class="s1">)</span>
<span class="s1">group = np.asarray(data[</span><span class="s4">'ship'</span><span class="s1">]</span><span class="s3">, </span><span class="s1">int)</span>
<span class="s1">exposure = np.asarray(data[</span><span class="s4">'service'</span><span class="s1">])</span>


<span class="s0"># TODO get the test methods from regression/tests</span>
<span class="s3">class </span><span class="s1">CheckCountRobustMixin:</span>


    <span class="s3">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s3">if </span><span class="s1">len(res1.params) == (len(res2.params) - </span><span class="s5">1</span><span class="s1">):</span>
            <span class="s0"># Stata includes lnalpha in table for NegativeBinomial</span>
            <span class="s1">mask = np.ones(len(res2.params)</span><span class="s3">, </span><span class="s1">np.bool_)</span>
            <span class="s1">mask[-</span><span class="s5">2</span><span class="s1">] = </span><span class="s3">False</span>
            <span class="s1">res2_params = res2.params[mask]</span>
            <span class="s1">res2_bse = res2.bse[mask]</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">res2_params = res2.params</span>
            <span class="s1">res2_bse = res2.bse</span>

        <span class="s1">assert_allclose(res1._results.params</span><span class="s3">, </span><span class="s1">res2_params</span><span class="s3">, </span><span class="s5">1e-4</span><span class="s1">)</span>

        <span class="s1">assert_allclose(self.bse_rob / self.corr_fact</span><span class="s3">, </span><span class="s1">res2_bse</span><span class="s3">, </span><span class="s5">6e-5</span><span class="s1">)</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">get_robust_clu(cls):</span>
        <span class="s1">res1 = cls.res1</span>
        <span class="s1">cov_clu = sw.cov_cluster(res1</span><span class="s3">, </span><span class="s1">group)</span>
        <span class="s1">cls.bse_rob = sw.se_cov(cov_clu)</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(res1)</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">get_correction_factor(cls</span><span class="s3">, </span><span class="s1">results</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">True</span><span class="s1">):</span>
        <span class="s1">mod = results.model</span>
        <span class="s1">nobs</span><span class="s3">, </span><span class="s1">k_vars = mod.exog.shape</span>

        <span class="s3">if </span><span class="s1">sub_kparams:</span>
            <span class="s0"># TODO: document why we adjust by k_params for some classes</span>
            <span class="s0">#   but not others.</span>
            <span class="s1">k_params = len(results.params)</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">k_params = </span><span class="s5">0</span>

        <span class="s1">corr_fact = (nobs - </span><span class="s5">1.</span><span class="s1">) / float(nobs - k_params)</span>
        <span class="s0"># for bse we need sqrt of correction factor</span>
        <span class="s3">return </span><span class="s1">np.sqrt(corr_fact)</span>


    <span class="s3">def </span><span class="s1">test_oth(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>
        <span class="s1">assert_allclose(res1._results.llf</span><span class="s3">, </span><span class="s1">res2.ll</span><span class="s3">, </span><span class="s5">1e-4</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1._results.llnull</span><span class="s3">, </span><span class="s1">res2.ll_0</span><span class="s3">, </span><span class="s5">1e-4</span><span class="s1">)</span>


    <span class="s3">def </span><span class="s1">test_ttest(self):</span>
        <span class="s1">smt.check_ttest_tvalues(self.res1)</span>


    <span class="s3">def </span><span class="s1">test_waldtest(self):</span>
        <span class="s1">smt.check_ftest_pvalues(self.res1)</span>


<span class="s3">class </span><span class="s1">TestPoissonClu(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.get_robust_clu()</span>


<span class="s3">class </span><span class="s1">TestPoissonCluGeneric(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s1">debug = </span><span class="s3">False</span>
        <span class="s3">if </span><span class="s1">debug:</span>
            <span class="s0"># for debugging</span>
            <span class="s1">cls.bse_nonrobust = cls.res1.bse.copy()</span>
            <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>
            <span class="s1">cls.get_robust_clu()</span>
            <span class="s1">cls.res3 = cls.res1</span>
            <span class="s1">cls.bse_rob3 = cls.bse_rob.copy()</span>
            <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s3">from </span><span class="s1">statsmodels.base.covtype </span><span class="s3">import </span><span class="s1">get_robustcov_results</span>

        <span class="s0">#res_hc0_ = cls.res1.get_robustcov_results('HC1')</span>
        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'cluster'</span><span class="s3">,</span>
                                                  <span class="s1">groups=group</span><span class="s3">,</span>
                                                  <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                  <span class="s1">df_correction=</span><span class="s3">True,  </span><span class="s0">#TODO has no effect</span>
                                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                                  <span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestPoissonHC1Generic(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_hc1</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s3">from </span><span class="s1">statsmodels.base.covtype </span><span class="s3">import </span><span class="s1">get_robustcov_results</span>

        <span class="s0">#res_hc0_ = cls.res1.get_robustcov_results('HC1')</span>
        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'HC1'</span><span class="s3">, </span><span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">False</span><span class="s1">)</span>


<span class="s0"># TODO: refactor xxxFit to full testing results</span>
<span class="s3">class </span><span class="s1">TestPoissonCluFit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>


        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>

        <span class="s0"># scaling of cov_params_default to match Stata</span>
        <span class="s0"># TODO should the default be changed?</span>
        <span class="s1">nobs</span><span class="s3">, </span><span class="s1">k_params = mod.exog.shape</span>
        <span class="s0"># TODO: this is similar but not identical to logic in</span>
        <span class="s0">#   get_correction_factor; can we de-duplicate?</span>
        <span class="s1">sc_fact = (nobs-</span><span class="s5">1.</span><span class="s1">) / float(nobs - k_params)</span>

        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">cov_type=</span><span class="s4">'cluster'</span><span class="s3">,</span>
                           <span class="s1">cov_kwds=dict(groups=group</span><span class="s3">,</span>
                                         <span class="s1">use_correction=</span><span class="s3">True,</span>
                                         <span class="s1">scaling_factor=</span><span class="s5">1. </span><span class="s1">/ sc_fact</span><span class="s3">,</span>
                                         <span class="s1">df_correction=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">,  </span><span class="s0">#TODO has no effect</span>
                           <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                           <span class="s1">)</span>

        <span class="s0"># The model results, t_test, ... should also work without</span>
        <span class="s0"># normalized_cov_params, see #2209</span>
        <span class="s0"># Note: we cannot set on the wrapper res1, we need res1._results</span>
        <span class="s1">cls.res1._results.normalized_cov_params = </span><span class="s3">None</span>

        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s0"># backwards compatibility with inherited test methods</span>
        <span class="s1">cls.corr_fact = </span><span class="s5">1</span>


    <span class="s3">def </span><span class="s1">test_basic_inference(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>
        <span class="s1">rtol = </span><span class="s5">1e-7</span>
        <span class="s1">assert_allclose(res1.params</span><span class="s3">, </span><span class="s1">res2.params</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bse</span><span class="s3">, </span><span class="s1">res2.bse</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
        <span class="s1">assert_allclose(res1.tvalues</span><span class="s3">, </span><span class="s1">res2.tvalues</span><span class="s3">, </span><span class="s1">rtol=rtol</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.pvalues</span><span class="s3">, </span><span class="s1">res2.pvalues</span><span class="s3">, </span><span class="s1">rtol=rtol</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-20</span><span class="s1">)</span>
        <span class="s1">ci = res2.params_table[:</span><span class="s3">, </span><span class="s5">4</span><span class="s1">:</span><span class="s5">6</span><span class="s1">]</span>
        <span class="s1">assert_allclose(res1.conf_int()</span><span class="s3">, </span><span class="s1">ci</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">5e-7</span><span class="s3">, </span><span class="s1">atol=</span><span class="s5">1e-20</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestPoissonHC1Fit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_hc1</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">cov_type=</span><span class="s4">'HC1'</span><span class="s1">)</span>

        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">False</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestPoissonHC1FitExposure(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_exposure_hc1</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">exposure=exposure)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">cov_type=</span><span class="s4">'HC1'</span><span class="s1">)</span>

        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">False</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestPoissonCluExposure(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_exposure_clu </span><span class="s0">#nonrobust</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">exposure=exposure)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.get_robust_clu()</span>


<span class="s3">class </span><span class="s1">TestPoissonCluExposureGeneric(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_exposure_clu </span><span class="s0">#nonrobust</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">exposure=exposure)</span>
        <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>

        <span class="s3">from </span><span class="s1">statsmodels.base.covtype </span><span class="s3">import </span><span class="s1">get_robustcov_results</span>

        <span class="s0">#res_hc0_ = cls.res1.get_robustcov_results('HC1')</span>
        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'cluster'</span><span class="s3">,</span>
                                                  <span class="s1">groups=group</span><span class="s3">,</span>
                                                  <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                  <span class="s1">df_correction=</span><span class="s3">True,  </span><span class="s0">#TODO has no effect</span>
                                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                                  <span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse </span><span class="s0">#sw.se_cov(cov_clu)</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestGLMPoissonClu(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = smd.Poisson(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">mod = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = mod.fit()</span>
        <span class="s1">cls.get_robust_clu()</span>


<span class="s3">class </span><span class="s1">TestGLMPoissonCluGeneric(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = res1 = mod.fit()</span>

        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'cluster'</span><span class="s3">,</span>
                                                  <span class="s1">groups=group</span><span class="s3">,</span>
                                                  <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                  <span class="s1">df_correction=</span><span class="s3">True,  </span><span class="s0">#TODO has no effect</span>
                                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                                  <span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestGLMPoissonHC1Generic(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_hc1</span>
        <span class="s1">mod = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = mod.fit()</span>

        <span class="s0">#res_hc0_ = cls.res1.get_robustcov_results('HC1')</span>
        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'HC1'</span><span class="s3">, </span><span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">False</span><span class="s1">)</span>


<span class="s0"># TODO: refactor xxxFit to full testing results</span>
<span class="s3">class </span><span class="s1">TestGLMPoissonCluFit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_clu</span>
        <span class="s1">mod = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = res1 = mod.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">,</span>
                                  <span class="s1">cov_kwds=dict(groups=group</span><span class="s3">,</span>
                                                <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                <span class="s1">df_correction=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">,  </span><span class="s0">#TODO has no effect</span>
                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                  <span class="s1">)</span>

        <span class="s0"># The model results, t_test, ... should also work without</span>
        <span class="s0"># normalized_cov_params, see #2209</span>
        <span class="s0"># Note: we cannot set on the wrapper res1, we need res1._results</span>
        <span class="s1">cls.res1._results.normalized_cov_params = </span><span class="s3">None</span>

        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestGLMPoissonHC1Fit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_poisson_hc1</span>
        <span class="s1">mod = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = mod.fit(cov_type=</span><span class="s4">'HC1'</span><span class="s1">)</span>

        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1</span><span class="s3">, </span><span class="s1">sub_kparams=</span><span class="s3">False</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestNegbinClu(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_negbin_clu</span>
        <span class="s1">mod = smd.NegativeBinomial(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">gtol=</span><span class="s5">1e-7</span><span class="s1">)</span>
        <span class="s1">cls.get_robust_clu()</span>


<span class="s3">class </span><span class="s1">TestNegbinCluExposure(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_negbin_exposure_clu </span><span class="s0">#nonrobust</span>
        <span class="s1">mod = smd.NegativeBinomial(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">exposure=exposure)</span>
        <span class="s1">cls.res1 = mod.fit(disp=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.get_robust_clu()</span>


<span class="s0">#        mod_nbe = smd.NegativeBinomial(endog, exog, exposure=data['service'])</span>
<span class="s0">#        res_nbe = mod_nbe.fit()</span>
<span class="s0">#        mod_nb = smd.NegativeBinomial(endog, exog)</span>
<span class="s0">#        res_nb = mod_nb.fit()</span>
<span class="s0">#</span>
<span class="s0">#        cov_clu_nb = sw.cov_cluster(res_nb, group)</span>
<span class="s0">#        k_params = k_vars + 1</span>
<span class="s0">#        print sw.se_cov(cov_clu_nb / ((nobs-1.) / float(nobs - k_params)))</span>
<span class="s0">#</span>
<span class="s0">#        wt = res_nb.wald_test(np.eye(len(res_nb.params))[1:3], cov_p=cov_clu_nb/((nobs-1.) / float(nobs - k_params)))</span>
<span class="s0">#        print wt</span>
<span class="s0">#</span>
<span class="s0">#        print dir(results_st)</span>

<span class="s3">class </span><span class="s1">TestNegbinCluGeneric(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_negbin_clu</span>
        <span class="s1">mod = smd.NegativeBinomial(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">gtol=</span><span class="s5">1e-7</span><span class="s1">)</span>

        <span class="s1">get_robustcov_results(cls.res1._results</span><span class="s3">, </span><span class="s4">'cluster'</span><span class="s3">,</span>
                                                  <span class="s1">groups=group</span><span class="s3">,</span>
                                                  <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                  <span class="s1">df_correction=</span><span class="s3">True,  </span><span class="s0">#TODO has no effect</span>
                                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                                  <span class="s1">use_self=</span><span class="s3">True</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestNegbinCluFit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_negbin_clu</span>
        <span class="s1">mod = smd.NegativeBinomial(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">cov_type=</span><span class="s4">'cluster'</span><span class="s3">,</span>
                                  <span class="s1">cov_kwds=dict(groups=group</span><span class="s3">,</span>
                                                <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                <span class="s1">df_correction=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">,  </span><span class="s0">#TODO has no effect</span>
                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                  <span class="s1">gtol=</span><span class="s5">1e-7</span><span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">TestNegbinCluExposureFit(CheckCountRobustMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.res2 = results_st.results_negbin_exposure_clu </span><span class="s0">#nonrobust</span>
        <span class="s1">mod = smd.NegativeBinomial(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">exposure=exposure)</span>
        <span class="s1">cls.res1 = res1 = mod.fit(disp=</span><span class="s3">False, </span><span class="s1">cov_type=</span><span class="s4">'cluster'</span><span class="s3">,</span>
                                  <span class="s1">cov_kwds=dict(groups=group</span><span class="s3">,</span>
                                                <span class="s1">use_correction=</span><span class="s3">True,</span>
                                                <span class="s1">df_correction=</span><span class="s3">True</span><span class="s1">)</span><span class="s3">,  </span><span class="s0">#TODO has no effect</span>
                                  <span class="s1">use_t=</span><span class="s3">False, </span><span class="s0">#True,</span>
                                  <span class="s1">)</span>
        <span class="s1">cls.bse_rob = cls.res1.bse</span>

        <span class="s1">cls.corr_fact = cls.get_correction_factor(cls.res1)</span>


<span class="s3">class </span><span class="s1">CheckDiscreteGLM:</span>
    <span class="s0"># compare GLM with other models, no verified reference results</span>

    <span class="s3">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">res1 = self.res1  </span><span class="s0"># GLM model</span>
        <span class="s1">res2 = self.res2  </span><span class="s0"># comparison model, discrete or OLS</span>

        <span class="s1">assert_equal(res1.cov_type</span><span class="s3">, </span><span class="s1">self.cov_type)</span>
        <span class="s1">assert_equal(res2.cov_type</span><span class="s3">, </span><span class="s1">self.cov_type)</span>

        <span class="s1">rtol = getattr(res1</span><span class="s3">, </span><span class="s4">'rtol'</span><span class="s3">, </span><span class="s5">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.params</span><span class="s3">, </span><span class="s1">res2.params</span><span class="s3">, </span><span class="s1">rtol=rtol)</span>
        <span class="s1">assert_allclose(res1.bse</span><span class="s3">, </span><span class="s1">res2.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_score_hessian(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s0"># We need to fix scale in GLM and OLS,</span>
        <span class="s0"># discrete MLE have it always fixed</span>
        <span class="s3">if </span><span class="s1">isinstance(res2.model</span><span class="s3">, </span><span class="s1">OLS):</span>
            <span class="s1">kwds = {</span><span class="s4">'scale'</span><span class="s1">: res2.scale}</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">kwds = {}</span>
        <span class="s3">if </span><span class="s1">isinstance(res2.model</span><span class="s3">, </span><span class="s1">OLS):</span>
            <span class="s1">sgn = + </span><span class="s5">1</span>
        <span class="s3">else</span><span class="s1">:</span>
            <span class="s1">sgn = -</span><span class="s5">1  </span><span class="s0"># see #4714</span>

        <span class="s1">score1 = res1.model.score(res1.params * </span><span class="s5">0.98</span><span class="s3">, </span><span class="s1">scale=res1.scale)</span>
        <span class="s1">score2 = res2.model.score(res1.params * </span><span class="s5">0.98</span><span class="s3">, </span><span class="s1">**kwds)</span>
        <span class="s1">assert_allclose(score1</span><span class="s3">, </span><span class="s1">score2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">hess1 = res1.model.hessian(res1.params</span><span class="s3">, </span><span class="s1">scale=res1.scale)</span>
        <span class="s1">hess2 = res2.model.hessian(res1.params</span><span class="s3">, </span><span class="s1">**kwds)</span>
        <span class="s1">assert_allclose(hess1</span><span class="s3">, </span><span class="s1">hess2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s3">if </span><span class="s1">isinstance(res2.model</span><span class="s3">, </span><span class="s1">OLS):</span>
            <span class="s0"># skip the rest</span>
            <span class="s3">return</span>
        <span class="s1">scoref1 = res1.model.score_factor(res1.params</span><span class="s3">, </span><span class="s1">scale=res1.scale)</span>
        <span class="s1">scoref2 = res2.model.score_factor(res1.params</span><span class="s3">, </span><span class="s1">**kwds)</span>
        <span class="s1">assert_allclose(scoref1</span><span class="s3">, </span><span class="s1">scoref2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

        <span class="s1">hessf1 = res1.model.hessian_factor(res1.params</span><span class="s3">, </span><span class="s1">scale=res1.scale)</span>
        <span class="s1">hessf2 = res2.model.hessian_factor(res1.params</span><span class="s3">, </span><span class="s1">**kwds)</span>
        <span class="s1">assert_allclose(sgn * hessf1</span><span class="s3">, </span><span class="s1">hessf2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-10</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_score_test(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s3">if </span><span class="s1">isinstance(res2.model</span><span class="s3">, </span><span class="s1">OLS):</span>
            <span class="s0"># skip</span>
            <span class="s3">return</span>

        <span class="s1">fitted = self.res1.fittedvalues</span>
        <span class="s1">exog_extra = np.column_stack((fitted**</span><span class="s5">2</span><span class="s3">, </span><span class="s1">fitted**</span><span class="s5">3</span><span class="s1">))</span>
        <span class="s1">res_lm1 = res1.score_test(exog_extra</span><span class="s3">, </span><span class="s1">cov_type=</span><span class="s4">'nonrobust'</span><span class="s1">)</span>
        <span class="s1">res_lm2 = res2.score_test(exog_extra</span><span class="s3">, </span><span class="s1">cov_type=</span><span class="s4">'nonrobust'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.hstack(res_lm1)</span><span class="s3">, </span><span class="s1">np.hstack(res_lm2)</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">5e-7</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestGLMPoisson(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">np.random.seed(</span><span class="s5">987125643</span><span class="s1">)  </span><span class="s0"># not intentional seed</span>
        <span class="s1">endog_count = np.random.poisson(endog)</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'HC0'</span>

        <span class="s1">mod1 = GLM(endog_count</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Poisson())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HC0'</span><span class="s1">)</span>

        <span class="s1">mod1 = smd.Poisson(endog_count</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod1.fit(cov_type=</span><span class="s4">'HC0'</span><span class="s1">)</span>

        <span class="s1">cls.res1.rtol = </span><span class="s5">1e-11</span>


<span class="s3">class </span><span class="s1">TestGLMLogit(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">endog_bin = (endog &gt; endog.mean()).astype(int)</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'cluster'</span>

        <span class="s1">mod1 = GLM(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Binomial())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

        <span class="s1">mod1 = smd.Logit(endog_bin</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>


<span class="s3">class </span><span class="s1">TestGLMLogitOffset(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">endog_bin = (endog &gt; endog.mean()).astype(int)</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'cluster'</span>
        <span class="s1">offset = np.ones(endog_bin.shape[</span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">mod1 = GLM(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Binomial()</span><span class="s3">, </span><span class="s1">offset=offset)</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

        <span class="s1">mod1 = smd.Logit(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">offset=offset)</span>
        <span class="s1">cls.res2 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

<span class="s3">class </span><span class="s1">TestGLMProbit(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">endog_bin = (endog &gt; endog.mean()).astype(int)</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'cluster'</span>

        <span class="s1">mod1 = GLM(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Binomial(link=links.Probit()))</span>
        <span class="s1">cls.res1 = mod1.fit(method=</span><span class="s4">'newton'</span><span class="s3">,</span>
                            <span class="s1">cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

        <span class="s1">mod1 = smd.Probit(endog_bin</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>
        <span class="s1">cls.rtol = </span><span class="s5">1e-6</span>

    <span class="s3">def </span><span class="s1">test_score_hessian(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>
        <span class="s0"># Note scale is fixed at 1, so we do not need to fix it explicitly</span>
        <span class="s1">score1 = res1.model.score(res1.params * </span><span class="s5">0.98</span><span class="s1">)</span>
        <span class="s1">score2 = res2.model.score(res1.params * </span><span class="s5">0.98</span><span class="s1">)</span>
        <span class="s1">assert_allclose(score1</span><span class="s3">, </span><span class="s1">score2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>

        <span class="s1">hess1 = res1.model.hessian(res1.params)</span>
        <span class="s1">hess2 = res2.model.hessian(res1.params)</span>
        <span class="s1">assert_allclose(hess1</span><span class="s3">, </span><span class="s1">hess2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-13</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestGLMProbitOffset(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">endog_bin = (endog &gt; endog.mean()).astype(int)</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'cluster'</span>
        <span class="s1">offset = np.ones(endog_bin.shape[</span><span class="s5">0</span><span class="s1">])</span>

        <span class="s1">mod1 = GLM(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">,</span>
                   <span class="s1">family=families.Binomial(link=links.Probit())</span><span class="s3">,</span>
                   <span class="s1">offset=offset)</span>
        <span class="s1">cls.res1 = mod1.fit(method=</span><span class="s4">'newton'</span><span class="s3">,</span>
                            <span class="s1">cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

        <span class="s1">mod1 = smd.Probit(endog_bin</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">offset=offset)</span>
        <span class="s1">cls.res2 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>
        <span class="s1">cls.rtol = </span><span class="s5">1e-6</span>


<span class="s3">class </span><span class="s1">TestGLMGaussNonRobust(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'nonrobust'</span>

        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit()</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit()</span>


<span class="s3">class </span><span class="s1">TestGLMGaussClu(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'cluster'</span>

        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'cluster'</span><span class="s3">, </span><span class="s1">cov_kwds=dict(groups=group))</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHC(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'HC0'</span>

        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HC0'</span><span class="s1">)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'HC0'</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHAC(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">cls.cov_type = </span><span class="s4">'HAC'</span>

        <span class="s1">kwds={</span><span class="s4">'maxlags'</span><span class="s1">:</span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHAC2(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">cls.cov_type = </span><span class="s4">'HAC'</span>

        <span class="s0"># check kernel specified as string</span>
        <span class="s1">kwds = {</span><span class="s4">'kernel'</span><span class="s1">: </span><span class="s4">'bartlett'</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">kwds2 = {</span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds2)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHACUniform(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">cls.cov_type = </span><span class="s4">'HAC'</span>

        <span class="s1">kwds={</span><span class="s4">'kernel'</span><span class="s1">:sw.weights_uniform</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">:</span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s0">#for debugging</span>
        <span class="s1">cls.res3 = mod2.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds={</span><span class="s4">'maxlags'</span><span class="s1">:</span><span class="s5">2</span><span class="s1">})</span>


    <span class="s3">def </span><span class="s1">test_cov_options(self):</span>

        <span class="s0"># check keyword `weights_func</span>
        <span class="s1">kwdsa = {</span><span class="s4">'weights_func'</span><span class="s1">: sw.weights_uniform</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">res1a = self.res1.model.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwdsa)</span>
        <span class="s1">res2a = self.res2.model.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwdsa)</span>
        <span class="s1">assert_allclose(res1a.bse</span><span class="s3">, </span><span class="s1">self.res1.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-12</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res2a.bse</span><span class="s3">, </span><span class="s1">self.res2.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-12</span><span class="s1">)</span>

        <span class="s0"># regression test for bse values</span>
        <span class="s1">bse = np.array([  </span><span class="s5">2.82203924</span><span class="s3">,   </span><span class="s5">4.60199596</span><span class="s3">,  </span><span class="s5">11.01275064</span><span class="s1">])</span>
        <span class="s1">assert_allclose(res1a.bse</span><span class="s3">, </span><span class="s1">bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-6</span><span class="s1">)</span>

        <span class="s1">assert_(res1a.cov_kwds[</span><span class="s4">'weights_func'</span><span class="s1">] </span><span class="s3">is </span><span class="s1">sw.weights_uniform)</span>

        <span class="s1">kwdsb = {</span><span class="s4">'kernel'</span><span class="s1">: sw.weights_bartlett</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">res1a = self.res1.model.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwdsb)</span>
        <span class="s1">res2a = self.res2.model.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwdsb)</span>
        <span class="s1">assert_allclose(res1a.bse</span><span class="s3">, </span><span class="s1">res2a.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-12</span><span class="s1">)</span>

        <span class="s0"># regression test for bse values</span>
        <span class="s1">bse = np.array([  </span><span class="s5">2.502264</span><span class="s3">,  </span><span class="s5">3.697807</span><span class="s3">,  </span><span class="s5">9.193303</span><span class="s1">])</span>
        <span class="s1">assert_allclose(res1a.bse</span><span class="s3">, </span><span class="s1">bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-6</span><span class="s1">)</span>



<span class="s3">class </span><span class="s1">TestGLMGaussHACUniform2(TestGLMGaussHACUniform):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">cls.cov_type = </span><span class="s4">'HAC'</span>

        <span class="s1">kwds={</span><span class="s4">'kernel'</span><span class="s1">: sw.weights_uniform</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s0"># check kernel as string</span>
        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">kwds2 = {</span><span class="s4">'kernel'</span><span class="s1">: </span><span class="s4">'uniform'</span><span class="s3">, </span><span class="s4">'maxlags'</span><span class="s1">: </span><span class="s5">2</span><span class="s1">}</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'HAC'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHACPanel(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'hac-panel'</span>
        <span class="s0"># time index is just made up to have a test case</span>
        <span class="s1">time = np.tile(np.arange(</span><span class="s5">7</span><span class="s1">)</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)[:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">mod1 = GLM(endog.copy()</span><span class="s3">, </span><span class="s1">exog.copy()</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">kwds = dict(time=time</span><span class="s3">,</span>
                    <span class="s1">maxlags=</span><span class="s5">2</span><span class="s3">,</span>
                    <span class="s1">kernel=sw.weights_uniform</span><span class="s3">,</span>
                    <span class="s1">use_correction=</span><span class="s4">'hac'</span><span class="s3">,</span>
                    <span class="s1">df_correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'hac-panel'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>
        <span class="s1">cls.res1b = mod1.fit(cov_type=</span><span class="s4">'nw-panel'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'hac-panel'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

    <span class="s3">def </span><span class="s1">test_kwd(self):</span>
        <span class="s0"># test corrected keyword name</span>
        <span class="s1">assert_allclose(self.res1b.bse</span><span class="s3">, </span><span class="s1">self.res1.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-12</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHACPanelGroups(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'hac-panel'</span>
        <span class="s0"># time index is just made up to have a test case</span>
        <span class="s1">groups = np.repeat(np.arange(</span><span class="s5">5</span><span class="s1">)</span><span class="s3">, </span><span class="s5">7</span><span class="s1">)[:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">mod1 = GLM(endog.copy()</span><span class="s3">, </span><span class="s1">exog.copy()</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">kwds = dict(groups=pd.Series(groups)</span><span class="s3">,  </span><span class="s0"># check for #3606</span>
                    <span class="s1">maxlags=</span><span class="s5">2</span><span class="s3">,</span>
                    <span class="s1">kernel=sw.weights_uniform</span><span class="s3">,</span>
                    <span class="s1">use_correction=</span><span class="s4">'hac'</span><span class="s3">,</span>
                    <span class="s1">df_correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'hac-panel'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'hac-panel'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>


<span class="s3">class </span><span class="s1">TestGLMGaussHACGroupsum(CheckDiscreteGLM):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.cov_type = </span><span class="s4">'hac-groupsum'</span>
        <span class="s0"># time index is just made up to have a test case</span>
        <span class="s1">time = np.tile(np.arange(</span><span class="s5">7</span><span class="s1">)</span><span class="s3">, </span><span class="s5">5</span><span class="s1">)[:-</span><span class="s5">1</span><span class="s1">]</span>
        <span class="s1">mod1 = GLM(endog</span><span class="s3">, </span><span class="s1">exog</span><span class="s3">, </span><span class="s1">family=families.Gaussian())</span>
        <span class="s1">kwds = dict(time=pd.Series(time)</span><span class="s3">,  </span><span class="s0"># check for #3606</span>
                    <span class="s1">maxlags=</span><span class="s5">2</span><span class="s3">,</span>
                    <span class="s1">use_correction=</span><span class="s4">'hac'</span><span class="s3">,</span>
                    <span class="s1">df_correction=</span><span class="s3">False</span><span class="s1">)</span>
        <span class="s1">cls.res1 = mod1.fit(cov_type=</span><span class="s4">'hac-groupsum'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>
        <span class="s1">cls.res1b = mod1.fit(cov_type=</span><span class="s4">'nw-groupsum'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

        <span class="s1">mod2 = OLS(endog</span><span class="s3">, </span><span class="s1">exog)</span>
        <span class="s1">cls.res2 = mod2.fit(cov_type=</span><span class="s4">'hac-groupsum'</span><span class="s3">, </span><span class="s1">cov_kwds=kwds)</span>

    <span class="s3">def </span><span class="s1">test_kwd(self):</span>
        <span class="s0"># test corrected keyword name</span>
        <span class="s1">assert_allclose(self.res1b.bse</span><span class="s3">, </span><span class="s1">self.res1.bse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s5">1e-12</span><span class="s1">)</span>
</pre>
</body>
</html>