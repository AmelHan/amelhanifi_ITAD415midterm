<html>
<head>
<title>test_phreg.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_phreg.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">statsmodels.duration.hazard_regression </span><span class="s0">import </span><span class="s1">PHReg</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(assert_allclose</span><span class="s0">,</span>
                           <span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_)</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s2"># TODO: Include some corner cases: data sets with empty strata, strata</span>
<span class="s2">#      with no events, entry times after censoring times, etc.</span>

<span class="s2"># All the R results</span>
<span class="s0">from </span><span class="s1">.results </span><span class="s0">import </span><span class="s1">survival_r_results</span>
<span class="s0">from </span><span class="s1">.results </span><span class="s0">import </span><span class="s1">survival_enet_r_results</span>

<span class="s3">&quot;&quot;&quot; 
Tests of PHReg against R coxph. 
 
Tests include entry times and stratification. 
 
phreg_gentests.py generates the test data sets and puts them into the 
results folder. 
 
survival.R runs R on all the test data sets and constructs the 
survival_r_results module. 
&quot;&quot;&quot;</span>

<span class="s2"># Arguments passed to the PHReg fit method.</span>
<span class="s1">args = {</span><span class="s3">&quot;method&quot;</span><span class="s1">: </span><span class="s3">&quot;bfgs&quot;</span><span class="s0">, </span><span class="s3">&quot;disp&quot;</span><span class="s1">: </span><span class="s4">0</span><span class="s1">}</span>


<span class="s0">def </span><span class="s1">get_results(n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">ties):</span>
    <span class="s0">if </span><span class="s1">ext </span><span class="s0">is None</span><span class="s1">:</span>
        <span class="s1">coef_name = </span><span class="s3">&quot;coef_%d_%d_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">se_name = </span><span class="s3">&quot;se_%d_%d_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">time_name = </span><span class="s3">&quot;time_%d_%d_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">hazard_name = </span><span class="s3">&quot;hazard_%d_%d_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ties)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">coef_name = </span><span class="s3">&quot;coef_%d_%d_%s_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">se_name = </span><span class="s3">&quot;se_%d_%d_%s_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">time_name = </span><span class="s3">&quot;time_%d_%d_%s_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">ties)</span>
        <span class="s1">hazard_name = </span><span class="s3">&quot;hazard_%d_%d_%s_%s&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">ext</span><span class="s0">, </span><span class="s1">ties)</span>
    <span class="s1">coef = getattr(survival_r_results</span><span class="s0">, </span><span class="s1">coef_name)</span>
    <span class="s1">se = getattr(survival_r_results</span><span class="s0">, </span><span class="s1">se_name)</span>
    <span class="s1">time = getattr(survival_r_results</span><span class="s0">, </span><span class="s1">time_name)</span>
    <span class="s1">hazard = getattr(survival_r_results</span><span class="s0">, </span><span class="s1">hazard_name)</span>
    <span class="s0">return </span><span class="s1">coef</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">time</span><span class="s0">, </span><span class="s1">hazard</span>

<span class="s0">class </span><span class="s1">TestPHReg:</span>

    <span class="s2"># Load a data file from the results directory</span>
    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">load_file(fname):</span>
        <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
        <span class="s1">data = np.genfromtxt(os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s1">fname)</span><span class="s0">,</span>
                             <span class="s1">delimiter=</span><span class="s3">&quot; &quot;</span><span class="s1">)</span>
        <span class="s1">time = data[:</span><span class="s0">,</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">status = data[:</span><span class="s0">,</span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">entry = data[:</span><span class="s0">,</span><span class="s4">2</span><span class="s1">]</span>
        <span class="s1">exog = data[:</span><span class="s0">,</span><span class="s4">3</span><span class="s1">:]</span>

        <span class="s0">return </span><span class="s1">time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry</span><span class="s0">, </span><span class="s1">exog</span>

    <span class="s2"># Run a single test against R output</span>
    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">do1(fname</span><span class="s0">, </span><span class="s1">ties</span><span class="s0">, </span><span class="s1">entry_f</span><span class="s0">, </span><span class="s1">strata_f):</span>

        <span class="s2"># Read the test data.</span>
        <span class="s1">time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry</span><span class="s0">, </span><span class="s1">exog = TestPHReg.load_file(fname)</span>
        <span class="s1">n = len(time)</span>

        <span class="s1">vs = fname.split(</span><span class="s3">&quot;_&quot;</span><span class="s1">)</span>
        <span class="s1">n = int(vs[</span><span class="s4">2</span><span class="s1">])</span>
        <span class="s1">p = int(vs[</span><span class="s4">3</span><span class="s1">].split(</span><span class="s3">&quot;.&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">ties1 = ties[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">3</span><span class="s1">]</span>

        <span class="s2"># Needs to match the kronecker statement in survival.R</span>
        <span class="s1">strata = np.kron(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.ones(n // </span><span class="s4">5</span><span class="s1">))</span>

        <span class="s2"># No stratification or entry times</span>
        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">ties=ties)</span>
        <span class="s1">phrb = mod.fit(**args)</span>
        <span class="s1">coef_r</span><span class="s0">, </span><span class="s1">se_r</span><span class="s0">, </span><span class="s1">time_r</span><span class="s0">, </span><span class="s1">hazard_r = get_results(n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, None, </span><span class="s1">ties1)</span>
        <span class="s1">assert_allclose(phrb.params</span><span class="s0">, </span><span class="s1">coef_r</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(phrb.bse</span><span class="s0">, </span><span class="s1">se_r</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
        <span class="s1">time_h</span><span class="s0">, </span><span class="s1">cumhaz</span><span class="s0">, </span><span class="s1">surv = phrb.baseline_cumulative_hazard[</span><span class="s4">0</span><span class="s1">]</span>

        <span class="s2"># Entry times but no stratification</span>
        <span class="s1">phrb = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry</span><span class="s0">,</span>
                     <span class="s1">ties=ties).fit(**args)</span>
        <span class="s1">coef</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">time_r</span><span class="s0">, </span><span class="s1">hazard_r = get_results(n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s3">&quot;et&quot;</span><span class="s0">, </span><span class="s1">ties1)</span>
        <span class="s1">assert_allclose(phrb.params</span><span class="s0">, </span><span class="s1">coef</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(phrb.bse</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>

        <span class="s2"># Stratification but no entry times</span>
        <span class="s1">phrb = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">strata=strata</span><span class="s0">,</span>
                      <span class="s1">ties=ties).fit(**args)</span>
        <span class="s1">coef</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">time_r</span><span class="s0">, </span><span class="s1">hazard_r = get_results(n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s3">&quot;st&quot;</span><span class="s0">, </span><span class="s1">ties1)</span>
        <span class="s1">assert_allclose(phrb.params</span><span class="s0">, </span><span class="s1">coef</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>
        <span class="s1">assert_allclose(phrb.bse</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

        <span class="s2"># Stratification and entry times</span>
        <span class="s1">phrb = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry</span><span class="s0">,</span>
                     <span class="s1">strata=strata</span><span class="s0">, </span><span class="s1">ties=ties).fit(**args)</span>
        <span class="s1">coef</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">time_r</span><span class="s0">, </span><span class="s1">hazard_r = get_results(n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s3">&quot;et_st&quot;</span><span class="s0">, </span><span class="s1">ties1)</span>
        <span class="s1">assert_allclose(phrb.params</span><span class="s0">, </span><span class="s1">coef</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(phrb.bse</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-4</span><span class="s1">)</span>

        <span class="s2">#smoke test</span>
        <span class="s1">time_h</span><span class="s0">, </span><span class="s1">cumhaz</span><span class="s0">, </span><span class="s1">surv = phrb.baseline_cumulative_hazard[</span><span class="s4">0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">test_missing(self):</span>

        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>

        <span class="s1">time[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">5</span><span class="s1">] = np.nan</span>
        <span class="s1">status[</span><span class="s4">5</span><span class="s1">:</span><span class="s4">10</span><span class="s1">] = np.nan</span>
        <span class="s1">exog[</span><span class="s4">10</span><span class="s1">:</span><span class="s4">15</span><span class="s0">,</span><span class="s1">:] = np.nan</span>

        <span class="s1">md = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">missing=</span><span class="s3">'drop'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(len(md.endog)</span><span class="s0">, </span><span class="s4">185</span><span class="s1">)</span>
        <span class="s1">assert_allclose(len(md.status)</span><span class="s0">, </span><span class="s4">185</span><span class="s1">)</span>
        <span class="s1">assert_allclose(md.exog.shape</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">185</span><span class="s0">,</span><span class="s4">4</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_formula(self):</span>

        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">entry = np.zeros_like(time)</span>
        <span class="s1">entry[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">10</span><span class="s1">] = time[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">10</span><span class="s1">] / </span><span class="s4">2</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;time&quot;</span><span class="s1">: time</span><span class="s0">, </span><span class="s3">&quot;status&quot;</span><span class="s1">: status</span><span class="s0">,</span>
                           <span class="s3">&quot;exog1&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;exog2&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s3">&quot;exog3&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;exog4&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s3">&quot;entry&quot;</span><span class="s1">: entry})</span>

        <span class="s1">mod1 = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry)</span>
        <span class="s1">rslt1 = mod1.fit()</span>

        <span class="s2"># works with &quot;0 +&quot; on RHS but issues warning</span>
        <span class="s1">fml = </span><span class="s3">&quot;time ~ exog1 + exog2 + exog3 + exog4&quot;</span>
        <span class="s1">mod2 = PHReg.from_formula(fml</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">status=status</span><span class="s0">,</span>
                                  <span class="s1">entry=entry)</span>
        <span class="s1">rslt2 = mod2.fit()</span>

        <span class="s1">mod3 = PHReg.from_formula(fml</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">status=</span><span class="s3">&quot;status&quot;</span><span class="s0">,</span>
                                  <span class="s1">entry=</span><span class="s3">&quot;entry&quot;</span><span class="s1">)</span>
        <span class="s1">rslt3 = mod3.fit()</span>

        <span class="s1">assert_allclose(rslt1.params</span><span class="s0">, </span><span class="s1">rslt2.params)</span>
        <span class="s1">assert_allclose(rslt1.params</span><span class="s0">, </span><span class="s1">rslt3.params)</span>
        <span class="s1">assert_allclose(rslt1.bse</span><span class="s0">, </span><span class="s1">rslt2.bse)</span>
        <span class="s1">assert_allclose(rslt1.bse</span><span class="s0">, </span><span class="s1">rslt3.bse)</span>

    <span class="s0">def </span><span class="s1">test_formula_cat_interactions(self):</span>

        <span class="s1">time = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s1">]</span>
        <span class="s1">status = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
        <span class="s1">x1 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">x2 = np.r_[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span>
        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;time&quot;</span><span class="s1">: time</span><span class="s0">, </span><span class="s3">&quot;status&quot;</span><span class="s1">: status</span><span class="s0">,</span>
                           <span class="s3">&quot;x1&quot;</span><span class="s1">: x1</span><span class="s0">, </span><span class="s3">&quot;x2&quot;</span><span class="s1">: x2})</span>

        <span class="s1">model1 = PHReg.from_formula(</span><span class="s3">&quot;time ~ C(x1) + C(x2) + C(x1)*C(x2)&quot;</span><span class="s0">, </span><span class="s1">status=</span><span class="s3">&quot;status&quot;</span><span class="s0">,</span>
                                    <span class="s1">data=df)</span>
        <span class="s1">assert_equal(model1.exog.shape</span><span class="s0">, </span><span class="s1">[</span><span class="s4">9</span><span class="s0">, </span><span class="s4">8</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_predict_formula(self):</span>

        <span class="s1">n = </span><span class="s4">100</span>
        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=n)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">n).astype(np.float64)</span>
        <span class="s1">exog = np.random.uniform(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=(n</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;time&quot;</span><span class="s1">: time</span><span class="s0">, </span><span class="s3">&quot;status&quot;</span><span class="s1">: status</span><span class="s0">,</span>
                           <span class="s3">&quot;exog1&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;exog2&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]})</span>

        <span class="s2"># Works with &quot;0 +&quot; on RHS but issues warning</span>
        <span class="s1">fml = </span><span class="s3">&quot;time ~ exog1 + np.log(exog2) + exog1*exog2&quot;</span>
        <span class="s1">model1 = PHReg.from_formula(fml</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">status=status)</span>
        <span class="s1">result1 = model1.fit()</span>

        <span class="s0">from </span><span class="s1">patsy </span><span class="s0">import </span><span class="s1">dmatrix</span>
        <span class="s1">dfp = dmatrix(model1.data.design_info</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s1">pr1 = result1.predict()</span>
        <span class="s1">pr2 = result1.predict(exog=df)</span>
        <span class="s1">pr3 = model1.predict(result1.params</span><span class="s0">, </span><span class="s1">exog=dfp)  </span><span class="s2"># No standard errors</span>
        <span class="s1">pr4 = model1.predict(result1.params</span><span class="s0">,</span>
                             <span class="s1">cov_params=result1.cov_params()</span><span class="s0">,</span>
                             <span class="s1">exog=dfp)</span>

        <span class="s1">prl = (pr1</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s1">pr3</span><span class="s0">, </span><span class="s1">pr4)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">4</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(i):</span>
                <span class="s1">assert_allclose(prl[i].predicted_values</span><span class="s0">,</span>
                                <span class="s1">prl[j].predicted_values)</span>

        <span class="s1">prl = (pr1</span><span class="s0">, </span><span class="s1">pr2</span><span class="s0">, </span><span class="s1">pr4)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(i):</span>
                <span class="s1">assert_allclose(prl[i].standard_errors</span><span class="s0">, </span><span class="s1">prl[j].standard_errors)</span>

    <span class="s0">def </span><span class="s1">test_formula_args(self):</span>

        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s4">200</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=n)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s1">size=n).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">offset = np.random.uniform(size=n)</span>
        <span class="s1">entry = np.random.uniform(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">size=n) * time</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;time&quot;</span><span class="s1">: time</span><span class="s0">, </span><span class="s3">&quot;status&quot;</span><span class="s1">: status</span><span class="s0">, </span><span class="s3">&quot;x1&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s3">&quot;x2&quot;</span><span class="s1">: exog[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">&quot;offset&quot;</span><span class="s1">: offset</span><span class="s0">, </span><span class="s3">&quot;entry&quot;</span><span class="s1">: entry})</span>
        <span class="s1">model1 = PHReg.from_formula(</span><span class="s3">&quot;time ~ x1 + x2&quot;</span><span class="s0">, </span><span class="s1">status=</span><span class="s3">&quot;status&quot;</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">&quot;offset&quot;</span><span class="s0">,</span>
                                    <span class="s1">entry=</span><span class="s3">&quot;entry&quot;</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">result1 = model1.fit()</span>
        <span class="s1">model2 = PHReg.from_formula(</span><span class="s3">&quot;time ~ x1 + x2&quot;</span><span class="s0">, </span><span class="s1">status=df.status</span><span class="s0">, </span><span class="s1">offset=df.offset</span><span class="s0">,</span>
                                    <span class="s1">entry=df.entry</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">result2 = model2.fit()</span>
        <span class="s1">assert_allclose(result1.params</span><span class="s0">, </span><span class="s1">result2.params)</span>
        <span class="s1">assert_allclose(result1.bse</span><span class="s0">, </span><span class="s1">result2.bse)</span>

    <span class="s0">def </span><span class="s1">test_offset(self):</span>

        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>

        <span class="s0">for </span><span class="s1">ties </span><span class="s0">in </span><span class="s3">&quot;breslow&quot;</span><span class="s0">, </span><span class="s3">&quot;efron&quot;</span><span class="s1">:</span>
            <span class="s1">mod1 = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
            <span class="s1">rslt1 = mod1.fit()</span>
            <span class="s1">offset = exog[:</span><span class="s0">,</span><span class="s4">0</span><span class="s1">] * rslt1.params[</span><span class="s4">0</span><span class="s1">]</span>
            <span class="s1">exog = exog[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:]</span>

            <span class="s1">mod2 = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">offset=offset</span><span class="s0">, </span><span class="s1">ties=ties)</span>
            <span class="s1">rslt2 = mod2.fit()</span>

            <span class="s1">assert_allclose(rslt2.params</span><span class="s0">, </span><span class="s1">rslt1.params[</span><span class="s4">1</span><span class="s1">:])</span>

    <span class="s0">def </span><span class="s1">test_post_estimation(self):</span>
        <span class="s2"># All regression tests</span>
        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>

        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
        <span class="s1">rslt = mod.fit()</span>
        <span class="s1">mart_resid = rslt.martingale_residuals</span>
        <span class="s1">assert_allclose(np.abs(mart_resid).sum()</span><span class="s0">, </span><span class="s4">120.72475743348433</span><span class="s1">)</span>

        <span class="s1">w_avg = rslt.weighted_covariate_averages</span>
        <span class="s1">assert_allclose(np.abs(w_avg[</span><span class="s4">0</span><span class="s1">]).sum(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">,</span>
               <span class="s1">np.r_[</span><span class="s4">7.31008415</span><span class="s0">, </span><span class="s4">9.77608674</span><span class="s0">,</span><span class="s4">10.89515885</span><span class="s0">, </span><span class="s4">13.1106801</span><span class="s1">])</span>

        <span class="s1">bc_haz = rslt.baseline_cumulative_hazard</span>
        <span class="s1">v = [np.mean(np.abs(x)) </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">bc_haz[</span><span class="s4">0</span><span class="s1">]]</span>
        <span class="s1">w = np.r_[</span><span class="s4">23.482841556421608</span><span class="s0">, </span><span class="s4">0.44149255358417017</span><span class="s0">,</span>
                  <span class="s4">0.68660114081275281</span><span class="s1">]</span>
        <span class="s1">assert_allclose(v</span><span class="s0">, </span><span class="s1">w)</span>

        <span class="s1">score_resid = rslt.score_residuals</span>
        <span class="s1">v = np.r_[ </span><span class="s4">0.50924792</span><span class="s0">, </span><span class="s4">0.4533952</span><span class="s0">, </span><span class="s4">0.4876718</span><span class="s0">, </span><span class="s4">0.5441128</span><span class="s1">]</span>
        <span class="s1">w = np.abs(score_resid).mean(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(v</span><span class="s0">, </span><span class="s1">w)</span>

        <span class="s1">groups = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
        <span class="s1">rslt = mod.fit(groups=groups)</span>
        <span class="s1">robust_cov = rslt.cov_params()</span>
        <span class="s1">v = [</span><span class="s4">0.00513432</span><span class="s0">, </span><span class="s4">0.01278423</span><span class="s0">, </span><span class="s4">0.00810427</span><span class="s0">, </span><span class="s4">0.00293147</span><span class="s1">]</span>
        <span class="s1">w = np.abs(robust_cov).mean(</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(v</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

        <span class="s1">s_resid = rslt.schoenfeld_residuals</span>
        <span class="s1">ii = np.flatnonzero(np.isfinite(s_resid).all(</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">s_resid = s_resid[ii</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">v = np.r_[</span><span class="s4">0.85154336</span><span class="s0">, </span><span class="s4">0.72993748</span><span class="s0">, </span><span class="s4">0.73758071</span><span class="s0">, </span><span class="s4">0.78599333</span><span class="s1">]</span>
        <span class="s1">assert_allclose(np.abs(s_resid).mean(</span><span class="s4">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s1">@pytest.mark.smoke</span>
    <span class="s0">def </span><span class="s1">test_summary(self):</span>
        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">time = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>

        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
        <span class="s1">rslt = mod.fit()</span>
        <span class="s1">smry = rslt.summary()</span>

        <span class="s1">strata = np.kron(np.arange(</span><span class="s4">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">strata=strata)</span>
        <span class="s1">rslt = mod.fit()</span>
        <span class="s1">smry = rslt.summary()</span>
        <span class="s1">msg = </span><span class="s3">&quot;3 strata dropped for having no events&quot;</span>
        <span class="s1">assert_(msg </span><span class="s0">in </span><span class="s1">str(smry))</span>

        <span class="s1">groups = np.kron(np.arange(</span><span class="s4">25</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">8</span><span class="s1">))</span>
        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
        <span class="s1">rslt = mod.fit(groups=groups)</span>
        <span class="s1">smry = rslt.summary()</span>

        <span class="s1">entry = np.random.uniform(</span><span class="s4">0.1</span><span class="s0">, </span><span class="s4">0.8</span><span class="s0">, </span><span class="s4">200</span><span class="s1">) * time</span>
        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry=entry)</span>
        <span class="s1">rslt = mod.fit()</span>
        <span class="s1">smry = rslt.summary()</span>
        <span class="s1">msg = </span><span class="s3">&quot;200 observations have positive entry times&quot;</span>
        <span class="s1">assert_(msg </span><span class="s0">in </span><span class="s1">str(smry))</span>

    <span class="s1">@pytest.mark.smoke</span>
    <span class="s0">def </span><span class="s1">test_predict(self):</span>
        <span class="s2"># All smoke tests. We should be able to convert the lhr and hr</span>
        <span class="s2"># tests into real tests against R.  There are many options to</span>
        <span class="s2"># this function that may interact in complicated ways.  Only a</span>
        <span class="s2"># few key combinations are tested here.</span>
        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">endog = </span><span class="s4">50 </span><span class="s1">* np.random.uniform(size=</span><span class="s4">200</span><span class="s1">)</span>
        <span class="s1">status = np.random.randint(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">200</span><span class="s1">).astype(np.float64)</span>
        <span class="s1">exog = np.random.normal(size=(</span><span class="s4">200</span><span class="s0">,</span><span class="s4">4</span><span class="s1">))</span>

        <span class="s1">mod = PHReg(endog</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status)</span>
        <span class="s1">rslt = mod.fit()</span>
        <span class="s1">rslt.predict()</span>
        <span class="s0">for </span><span class="s1">pred_type </span><span class="s0">in </span><span class="s3">'lhr'</span><span class="s0">, </span><span class="s3">'hr'</span><span class="s0">, </span><span class="s3">'cumhaz'</span><span class="s0">, </span><span class="s3">'surv'</span><span class="s1">:</span>
            <span class="s1">rslt.predict(pred_type=pred_type)</span>
            <span class="s1">rslt.predict(endog=endog[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">pred_type=pred_type)</span>
            <span class="s1">rslt.predict(endog=endog[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">exog=exog[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">10</span><span class="s0">,</span><span class="s1">:]</span><span class="s0">,</span>
                         <span class="s1">pred_type=pred_type)</span>

    <span class="s1">@pytest.mark.smoke</span>
    <span class="s0">def </span><span class="s1">test_get_distribution(self):</span>
        <span class="s1">np.random.seed(</span><span class="s4">34234</span><span class="s1">)</span>
        <span class="s1">n = </span><span class="s4">200</span>
        <span class="s1">exog = np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">lin_pred = exog.sum(</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">elin_pred = np.exp(-lin_pred)</span>
        <span class="s1">time = -elin_pred * np.log(np.random.uniform(size=n))</span>
        <span class="s1">status = np.ones(n)</span>
        <span class="s1">status[</span><span class="s4">0</span><span class="s1">:</span><span class="s4">20</span><span class="s1">] = </span><span class="s4">0</span>
        <span class="s1">strata = np.kron(range(</span><span class="s4">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.ones(n // </span><span class="s4">5</span><span class="s1">))</span>

        <span class="s1">mod = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status=status</span><span class="s0">, </span><span class="s1">strata=strata)</span>
        <span class="s1">rslt = mod.fit()</span>

        <span class="s1">dist = rslt.get_distribution()</span>

        <span class="s1">fitted_means = dist.mean()</span>
        <span class="s1">true_means = elin_pred</span>
        <span class="s1">fitted_var = dist.var()</span>
        <span class="s1">fitted_sd = dist.std()</span>
        <span class="s1">sample = dist.rvs()</span>

    <span class="s0">def </span><span class="s1">test_fit_regularized(self):</span>

        <span class="s2"># Data set sizes</span>
        <span class="s0">for </span><span class="s1">n</span><span class="s0">,</span><span class="s1">p </span><span class="s0">in </span><span class="s1">(</span><span class="s4">50</span><span class="s0">,</span><span class="s4">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">(</span><span class="s4">100</span><span class="s0">,</span><span class="s4">5</span><span class="s1">):</span>

            <span class="s2"># Penalty weights</span>
            <span class="s0">for </span><span class="s1">js</span><span class="s0">,</span><span class="s1">s </span><span class="s0">in </span><span class="s1">enumerate([</span><span class="s4">0</span><span class="s0">,</span><span class="s4">0.1</span><span class="s1">]):</span>

                <span class="s1">coef_name = </span><span class="s3">&quot;coef_%d_%d_%d&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">js)</span>
                <span class="s1">params = getattr(survival_enet_r_results</span><span class="s0">, </span><span class="s1">coef_name)</span>

                <span class="s1">fname = </span><span class="s3">&quot;survival_data_%d_%d.csv&quot; </span><span class="s1">% (n</span><span class="s0">, </span><span class="s1">p)</span>
                <span class="s1">time</span><span class="s0">, </span><span class="s1">status</span><span class="s0">, </span><span class="s1">entry</span><span class="s0">, </span><span class="s1">exog = self.load_file(fname)</span>

                <span class="s1">exog -= exog.mean(</span><span class="s4">0</span><span class="s1">)</span>
                <span class="s1">exog /= exog.std(</span><span class="s4">0</span><span class="s0">, </span><span class="s1">ddof=</span><span class="s4">1</span><span class="s1">)</span>

                <span class="s1">model = PHReg(time</span><span class="s0">, </span><span class="s1">exog</span><span class="s0">, </span><span class="s1">status=status</span><span class="s0">, </span><span class="s1">ties=</span><span class="s3">'breslow'</span><span class="s1">)</span>
                <span class="s1">sm_result = model.fit_regularized(alpha=s)</span>

                <span class="s2"># The agreement is not very high, the issue may be on</span>
                <span class="s2"># the R side.  See below for further checks.</span>
                <span class="s1">assert_allclose(sm_result.params</span><span class="s0">, </span><span class="s1">params</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.3</span><span class="s1">)</span>

                <span class="s2"># The penalized log-likelihood that we are maximizing.</span>
                <span class="s0">def </span><span class="s1">plf(params):</span>
                    <span class="s1">llf = model.loglike(params) / len(time)</span>
                    <span class="s1">L1_wt = </span><span class="s4">1</span>
                    <span class="s1">llf = llf - s * ((</span><span class="s4">1 </span><span class="s1">- L1_wt)*np.sum(params**</span><span class="s4">2</span><span class="s1">) / </span><span class="s4">2 </span><span class="s1">+ L1_wt*np.sum(np.abs(params)))</span>
                    <span class="s0">return </span><span class="s1">llf</span>

                <span class="s2"># Confirm that we are doing better than glmnet.</span>
                <span class="s1">llf_r = plf(params)</span>
                <span class="s1">llf_sm = plf(sm_result.params)</span>
                <span class="s1">assert_equal(np.sign(llf_sm - llf_r)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>


<span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
<span class="s1">rdir = os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s1">)</span>
<span class="s1">fnames = os.listdir(rdir)</span>
<span class="s1">fnames = [x </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">fnames </span><span class="s0">if </span><span class="s1">x.startswith(</span><span class="s3">&quot;survival&quot;</span><span class="s1">)</span>
          <span class="s0">and </span><span class="s1">x.endswith(</span><span class="s3">&quot;.csv&quot;</span><span class="s1">)]</span>

<span class="s1">ties = (</span><span class="s3">&quot;breslow&quot;</span><span class="s0">, </span><span class="s3">&quot;efron&quot;</span><span class="s1">)</span>
<span class="s1">entry_f = (</span><span class="s0">False, True</span><span class="s1">)</span>
<span class="s1">strata_f = (</span><span class="s0">False, True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'fname,ties,entry_f,strata_f'</span><span class="s0">,</span>
                         <span class="s1">list(itertools.product(fnames</span><span class="s0">, </span><span class="s1">ties</span><span class="s0">, </span><span class="s1">entry_f</span><span class="s0">, </span><span class="s1">strata_f)))</span>
<span class="s0">def </span><span class="s1">test_r(fname</span><span class="s0">, </span><span class="s1">ties</span><span class="s0">, </span><span class="s1">entry_f</span><span class="s0">, </span><span class="s1">strata_f):</span>
    <span class="s1">TestPHReg.do1(fname</span><span class="s0">, </span><span class="s1">ties</span><span class="s0">, </span><span class="s1">entry_f</span><span class="s0">, </span><span class="s1">strata_f)</span>
</pre>
</body>
</html>