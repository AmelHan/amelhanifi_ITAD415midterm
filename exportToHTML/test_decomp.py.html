<html>
<head>
<title>test_decomp.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_decomp.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">itertools</span>
<span class="s0">import </span><span class="s1">platform</span>
<span class="s0">import </span><span class="s1">sys</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(assert_equal</span><span class="s0">, </span><span class="s1">assert_almost_equal</span><span class="s0">,</span>
                           <span class="s1">assert_array_almost_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">,</span>
                           <span class="s1">assert_</span><span class="s0">, </span><span class="s1">assert_allclose)</span>

<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>

<span class="s0">from </span><span class="s1">scipy.linalg </span><span class="s0">import </span><span class="s1">(eig</span><span class="s0">, </span><span class="s1">eigvals</span><span class="s0">, </span><span class="s1">lu</span><span class="s0">, </span><span class="s1">svd</span><span class="s0">, </span><span class="s1">svdvals</span><span class="s0">, </span><span class="s1">cholesky</span><span class="s0">, </span><span class="s1">qr</span><span class="s0">,</span>
                          <span class="s1">schur</span><span class="s0">, </span><span class="s1">rsf2csf</span><span class="s0">, </span><span class="s1">lu_solve</span><span class="s0">, </span><span class="s1">lu_factor</span><span class="s0">, </span><span class="s1">solve</span><span class="s0">, </span><span class="s1">diagsvd</span><span class="s0">,</span>
                          <span class="s1">hessenberg</span><span class="s0">, </span><span class="s1">rq</span><span class="s0">, </span><span class="s1">eig_banded</span><span class="s0">, </span><span class="s1">eigvals_banded</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">,</span>
                          <span class="s1">eigvalsh</span><span class="s0">, </span><span class="s1">qr_multiply</span><span class="s0">, </span><span class="s1">qz</span><span class="s0">, </span><span class="s1">orth</span><span class="s0">, </span><span class="s1">ordqz</span><span class="s0">,</span>
                          <span class="s1">subspace_angles</span><span class="s0">, </span><span class="s1">hadamard</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">,</span>
                          <span class="s1">eigh_tridiagonal</span><span class="s0">, </span><span class="s1">null_space</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">LinAlgError)</span>

<span class="s0">from </span><span class="s1">scipy.linalg.lapack </span><span class="s0">import </span><span class="s1">(dgbtrf</span><span class="s0">, </span><span class="s1">dgbtrs</span><span class="s0">, </span><span class="s1">zgbtrf</span><span class="s0">, </span><span class="s1">zgbtrs</span><span class="s0">, </span><span class="s1">dsbev</span><span class="s0">,</span>
                                 <span class="s1">dsbevd</span><span class="s0">, </span><span class="s1">dsbevx</span><span class="s0">, </span><span class="s1">zhbevd</span><span class="s0">, </span><span class="s1">zhbevx)</span>

<span class="s0">from </span><span class="s1">scipy.linalg._misc </span><span class="s0">import </span><span class="s1">norm</span>
<span class="s0">from </span><span class="s1">scipy.linalg._decomp_qz </span><span class="s0">import </span><span class="s1">_select_function</span>
<span class="s0">from </span><span class="s1">scipy.stats </span><span class="s0">import </span><span class="s1">ortho_group</span>

<span class="s0">from </span><span class="s1">numpy </span><span class="s0">import </span><span class="s1">(array</span><span class="s0">, </span><span class="s1">diag</span><span class="s0">, </span><span class="s1">full</span><span class="s0">, </span><span class="s1">linalg</span><span class="s0">, </span><span class="s1">argsort</span><span class="s0">, </span><span class="s1">zeros</span><span class="s0">, </span><span class="s1">arange</span><span class="s0">,</span>
                   <span class="s1">float32</span><span class="s0">, </span><span class="s1">complex64</span><span class="s0">, </span><span class="s1">ravel</span><span class="s0">, </span><span class="s1">sqrt</span><span class="s0">, </span><span class="s1">iscomplex</span><span class="s0">, </span><span class="s1">shape</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">,</span>
                   <span class="s1">sign</span><span class="s0">, </span><span class="s1">asarray</span><span class="s0">, </span><span class="s1">isfinite</span><span class="s0">, </span><span class="s1">ndarray</span><span class="s0">, </span><span class="s1">eye</span><span class="s0">,</span><span class="s1">)</span>

<span class="s0">from </span><span class="s1">numpy.random </span><span class="s0">import </span><span class="s1">seed</span><span class="s0">, </span><span class="s1">random</span>

<span class="s0">from </span><span class="s1">scipy.linalg._testutils </span><span class="s0">import </span><span class="s1">assert_no_overwrite</span>
<span class="s0">from </span><span class="s1">scipy.sparse._sputils </span><span class="s0">import </span><span class="s1">matrix</span>

<span class="s0">from </span><span class="s1">scipy._lib._testutils </span><span class="s0">import </span><span class="s1">check_free_memory</span>
<span class="s0">from </span><span class="s1">scipy.linalg.blas </span><span class="s0">import </span><span class="s1">HAS_ILP64</span>
<span class="s0">try</span><span class="s1">:</span>
    <span class="s0">from </span><span class="s1">scipy.__config__ </span><span class="s0">import </span><span class="s1">CONFIG</span>
<span class="s0">except </span><span class="s1">ImportError:</span>
    <span class="s1">CONFIG = </span><span class="s0">None</span>


<span class="s0">def </span><span class="s1">_random_hermitian_matrix(n</span><span class="s0">, </span><span class="s1">posdef=</span><span class="s0">False, </span><span class="s1">dtype=float):</span>
    <span class="s2">&quot;Generate random sym/hermitian array of the given size n&quot;</span>
    <span class="s0">if </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">COMPLEX_DTYPES:</span>
        <span class="s1">A = np.random.rand(n</span><span class="s0">, </span><span class="s1">n) + np.random.rand(n</span><span class="s0">, </span><span class="s1">n)*</span><span class="s3">1.0j</span>
        <span class="s1">A = (A + A.conj().T)/</span><span class="s3">2</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">A = np.random.rand(n</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">A = (A + A.T)/</span><span class="s3">2</span>

    <span class="s0">if </span><span class="s1">posdef:</span>
        <span class="s1">A += sqrt(</span><span class="s3">2</span><span class="s1">*n)*np.eye(n)</span>

    <span class="s0">return </span><span class="s1">A.astype(dtype)</span>


<span class="s1">REAL_DTYPES = [np.float32</span><span class="s0">, </span><span class="s1">np.float64]</span>
<span class="s1">COMPLEX_DTYPES = [np.complex64</span><span class="s0">, </span><span class="s1">np.complex128]</span>
<span class="s1">DTYPES = REAL_DTYPES + COMPLEX_DTYPES</span>


<span class="s0">def </span><span class="s1">clear_fuss(ar</span><span class="s0">, </span><span class="s1">fuss_binary_bits=</span><span class="s3">7</span><span class="s1">):</span>
    <span class="s2">&quot;&quot;&quot;Clears trailing `fuss_binary_bits` of mantissa of a floating number&quot;&quot;&quot;</span>
    <span class="s1">x = np.asanyarray(ar)</span>
    <span class="s0">if </span><span class="s1">np.iscomplexobj(x):</span>
        <span class="s0">return </span><span class="s1">clear_fuss(x.real) + </span><span class="s3">1j </span><span class="s1">* clear_fuss(x.imag)</span>

    <span class="s1">significant_binary_bits = np.finfo(x.dtype).nmant</span>
    <span class="s1">x_mant</span><span class="s0">, </span><span class="s1">x_exp = np.frexp(x)</span>
    <span class="s1">f = </span><span class="s3">2.0</span><span class="s1">**(significant_binary_bits - fuss_binary_bits)</span>
    <span class="s1">x_mant *= f</span>
    <span class="s1">np.rint(x_mant</span><span class="s0">, </span><span class="s1">out=x_mant)</span>
    <span class="s1">x_mant /= f</span>

    <span class="s0">return </span><span class="s1">np.ldexp(x_mant</span><span class="s0">, </span><span class="s1">x_exp)</span>


<span class="s4"># XXX: This function should not be defined here, but somewhere in</span>
<span class="s4">#      scipy.linalg namespace</span>
<span class="s0">def </span><span class="s1">symrand(dim_or_eigv):</span>
    <span class="s2">&quot;&quot;&quot;Return a random symmetric (Hermitian) matrix. 
 
    If 'dim_or_eigv' is an integer N, return a NxN matrix, with eigenvalues 
        uniformly distributed on (-1,1). 
 
    If 'dim_or_eigv' is  1-D real array 'a', return a matrix whose 
                      eigenvalues are 'a'. 
    &quot;&quot;&quot;</span>
    <span class="s0">if </span><span class="s1">isinstance(dim_or_eigv</span><span class="s0">, </span><span class="s1">int):</span>
        <span class="s1">dim = dim_or_eigv</span>
        <span class="s1">d = random(dim)*</span><span class="s3">2 </span><span class="s1">- </span><span class="s3">1</span>
    <span class="s0">elif </span><span class="s1">(isinstance(dim_or_eigv</span><span class="s0">, </span><span class="s1">ndarray) </span><span class="s0">and</span>
          <span class="s1">len(dim_or_eigv.shape) == </span><span class="s3">1</span><span class="s1">):</span>
        <span class="s1">dim = dim_or_eigv.shape[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">d = dim_or_eigv</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">raise </span><span class="s1">TypeError(</span><span class="s5">&quot;input type not supported.&quot;</span><span class="s1">)</span>

    <span class="s1">v = ortho_group.rvs(dim)</span>
    <span class="s1">h = v.T.conj() @ diag(d) @ v</span>
    <span class="s4"># to avoid roundoff errors, symmetrize the matrix (again)</span>
    <span class="s1">h = </span><span class="s3">0.5</span><span class="s1">*(h.T+h)</span>
    <span class="s0">return </span><span class="s1">h</span>


<span class="s0">class </span><span class="s1">TestEigVals:</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">w = eigvals(a)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>

    <span class="s0">def </span><span class="s1">test_simple_tr(self):</span>
        <span class="s1">a = array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s5">'d'</span><span class="s1">).T</span>
        <span class="s1">a = a.copy()</span>
        <span class="s1">a = a.T</span>
        <span class="s1">w = eigvals(a)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">]]</span>
        <span class="s1">w = eigvals(a)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">+sqrt(</span><span class="s3">92</span><span class="s1">+</span><span class="s3">6j</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">,</span>
                   <span class="s3">0</span><span class="s0">,</span>
                   <span class="s1">(</span><span class="s3">9</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">-sqrt(</span><span class="s3">92</span><span class="s1">+</span><span class="s3">6j</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>

    <span class="s0">def </span><span class="s1">test_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">w = eigvals(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>


<span class="s0">class </span><span class="s1">TestEig:</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eig(a)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">v0 = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">)/</span><span class="s3">3</span><span class="s1">)/</span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">v1 = array([</span><span class="s3">3.</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">v2 = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">)/</span><span class="s3">3</span><span class="s1">)/</span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">v0 = v0 / norm(v0)</span>
        <span class="s1">v1 = v1 / norm(v1)</span>
        <span class="s1">v2 = v2 / norm(v2)</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>
        <span class="s1">assert_array_almost_equal(v0</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(v1</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(v2</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a @ v[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">w[i]*v[:</span><span class="s0">, </span><span class="s1">i])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eig(a</span><span class="s0">, </span><span class="s1">left=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">right=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a.T @ v[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">w[i]*v[:</span><span class="s0">, </span><span class="s1">i])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_eig(self):</span>
        <span class="s1">a = array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">vl</span><span class="s0">, </span><span class="s1">vr = eig(a</span><span class="s0">, </span><span class="s1">left=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">right=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">array([</span><span class="s3">1</span><span class="s1">+</span><span class="s3">2j</span><span class="s0">, </span><span class="s3">1</span><span class="s1">-</span><span class="s3">2j</span><span class="s1">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a @ vr[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">w[i]*vr[:</span><span class="s0">, </span><span class="s1">i])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a.conj().T @ vl[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">,</span>
                                      <span class="s1">w[i].conj()*vl[:</span><span class="s0">, </span><span class="s1">i])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">vl</span><span class="s0">, </span><span class="s1">vr = eig(a</span><span class="s0">, </span><span class="s1">left=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">right=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a @ vr[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">w[i]*vr[:</span><span class="s0">, </span><span class="s1">i])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a.conj().T @ vl[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">,</span>
                                      <span class="s1">w[i].conj()*vl[:</span><span class="s0">, </span><span class="s1">i])</span>

    <span class="s0">def </span><span class="s1">test_gh_3054(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s1">]]</span>
        <span class="s1">b = [[</span><span class="s3">0</span><span class="s1">]]</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">vr = eig(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">homogeneous_eigvals=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_allclose(w[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_(w[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] != </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(vr</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">w</span><span class="s0">, </span><span class="s1">vr = eig(a</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_equal(w</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_allclose(vr</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_check_gen_eig(self</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B):</span>
        <span class="s0">if </span><span class="s1">B </span><span class="s0">is not None</span><span class="s1">:</span>
            <span class="s1">A</span><span class="s0">, </span><span class="s1">B = asarray(A)</span><span class="s0">, </span><span class="s1">asarray(B)</span>
            <span class="s1">B0 = B</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">A = asarray(A)</span>
            <span class="s1">B0 = B</span>
            <span class="s1">B = np.eye(*A.shape)</span>
        <span class="s1">msg = </span><span class="s5">f&quot;</span><span class="s0">\n{</span><span class="s1">A</span><span class="s0">!r}\n{</span><span class="s1">B</span><span class="s0">!r}</span><span class="s5">&quot;</span>

        <span class="s4"># Eigenvalues in homogeneous coordinates</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">vr = eig(A</span><span class="s0">, </span><span class="s1">B0</span><span class="s0">, </span><span class="s1">homogeneous_eigvals=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">wt = eigvals(A</span><span class="s0">, </span><span class="s1">B0</span><span class="s0">, </span><span class="s1">homogeneous_eigvals=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">val1 = A @ vr * w[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s1">val2 = B @ vr * w[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(val1.shape[</span><span class="s3">1</span><span class="s1">]):</span>
            <span class="s1">assert_allclose(val1[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">val2[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">,</span>
                            <span class="s1">rtol=</span><span class="s3">1e-13</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-13</span><span class="s0">, </span><span class="s1">err_msg=msg)</span>

        <span class="s0">if </span><span class="s1">B0 </span><span class="s0">is None</span><span class="s1">:</span>
            <span class="s1">assert_allclose(w[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">assert_allclose(wt[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">perm = np.lexsort(w)</span>
        <span class="s1">permt = np.lexsort(wt)</span>
        <span class="s1">assert_allclose(w[:</span><span class="s0">, </span><span class="s1">perm]</span><span class="s0">, </span><span class="s1">wt[:</span><span class="s0">, </span><span class="s1">permt]</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-7</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-7</span><span class="s0">,</span>
                        <span class="s1">err_msg=msg)</span>

        <span class="s1">length = np.empty(len(vr))</span>

        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(vr)):</span>
            <span class="s1">length[i] = norm(vr[:</span><span class="s0">, </span><span class="s1">i])</span>

        <span class="s1">assert_allclose(length</span><span class="s0">, </span><span class="s1">np.ones(length.size)</span><span class="s0">, </span><span class="s1">err_msg=msg</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s3">1e-7</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-7</span><span class="s1">)</span>

        <span class="s4"># Convert homogeneous coordinates</span>
        <span class="s1">beta_nonzero = (w[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:] != </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">wh = w[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">beta_nonzero] / w[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">beta_nonzero]</span>

        <span class="s4"># Eigenvalues in standard coordinates</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">vr = eig(A</span><span class="s0">, </span><span class="s1">B0)</span>
        <span class="s1">wt = eigvals(A</span><span class="s0">, </span><span class="s1">B0)</span>
        <span class="s1">val1 = A @ vr</span>
        <span class="s1">val2 = B @ vr * w</span>
        <span class="s1">res = val1 - val2</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(res.shape[</span><span class="s3">1</span><span class="s1">]):</span>
            <span class="s0">if </span><span class="s1">np.all(isfinite(res[:</span><span class="s0">, </span><span class="s1">i])):</span>
                <span class="s1">assert_allclose(res[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s3">0</span><span class="s0">,</span>
                                <span class="s1">rtol=</span><span class="s3">1e-13</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-13</span><span class="s0">, </span><span class="s1">err_msg=msg)</span>

        <span class="s1">w_fin = w[isfinite(w)]</span>
        <span class="s1">wt_fin = wt[isfinite(wt)]</span>
        <span class="s1">perm = argsort(clear_fuss(w_fin))</span>
        <span class="s1">permt = argsort(clear_fuss(wt_fin))</span>
        <span class="s1">assert_allclose(w[perm]</span><span class="s0">, </span><span class="s1">wt[permt]</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s3">1e-7</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-7</span><span class="s0">, </span><span class="s1">err_msg=msg)</span>

        <span class="s1">length = np.empty(len(vr))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(vr)):</span>
            <span class="s1">length[i] = norm(vr[:</span><span class="s0">, </span><span class="s1">i])</span>
        <span class="s1">assert_allclose(length</span><span class="s0">, </span><span class="s1">np.ones(length.size)</span><span class="s0">, </span><span class="s1">err_msg=msg)</span>

        <span class="s4"># Compare homogeneous and nonhomogeneous versions</span>
        <span class="s1">assert_allclose(sort(wh)</span><span class="s0">, </span><span class="s1">sort(w[np.isfinite(w)]))</span>

    <span class="s1">@pytest.mark.xfail(reason=</span><span class="s5">&quot;See gh-2254&quot;</span><span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_singular(self):</span>
        <span class="s4"># Example taken from</span>
        <span class="s4"># https://web.archive.org/web/20040903121217/http://www.cs.umu.se/research/nla/singular_pairs/guptri/matlab.html</span>
        <span class="s1">A = array([[</span><span class="s3">22</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">17</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">45</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">29</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">39</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">34</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">27</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">38</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]])</span>
        <span class="s1">B = array([[</span><span class="s3">13</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">24</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">31</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">37</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">26</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">25</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
                   <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s1">]])</span>

        <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">'ignore'</span><span class="s1">):</span>
            <span class="s1">self._check_gen_eig(A</span><span class="s0">, </span><span class="s1">B)</span>

    <span class="s0">def </span><span class="s1">test_falker(self):</span>
        <span class="s4"># Test matrices giving some Nan generalized eigenvalues.</span>
        <span class="s1">M = diag(array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span>
        <span class="s1">K = array(([</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s1">D = array(([</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>
        <span class="s1">Z = zeros((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">I3 = eye(</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">A = np.block([[I3</span><span class="s0">, </span><span class="s1">Z]</span><span class="s0">, </span><span class="s1">[Z</span><span class="s0">, </span><span class="s1">-K]])</span>
        <span class="s1">B = np.block([[Z</span><span class="s0">, </span><span class="s1">I3]</span><span class="s0">, </span><span class="s1">[M</span><span class="s0">, </span><span class="s1">D]])</span>

        <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">'ignore'</span><span class="s1">):</span>
            <span class="s1">self._check_gen_eig(A</span><span class="s0">, </span><span class="s1">B)</span>

    <span class="s0">def </span><span class="s1">test_bad_geneig(self):</span>
        <span class="s4"># Ticket #709 (strange return values from DGGEV)</span>

        <span class="s0">def </span><span class="s1">matrices(omega):</span>
            <span class="s1">c1 = -</span><span class="s3">9 </span><span class="s1">+ omega**</span><span class="s3">2</span>
            <span class="s1">c2 = </span><span class="s3">2</span><span class="s1">*omega</span>
            <span class="s1">A = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">c1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">c1]]</span>
            <span class="s1">B = [[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-c2]</span><span class="s0">,</span>
                 <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">c2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
            <span class="s0">return </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span>

        <span class="s4"># With a buggy LAPACK, this can fail for different omega on different</span>
        <span class="s4"># machines -- so we need to test several values</span>
        <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">'ignore'</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">100</span><span class="s1">):</span>
                <span class="s1">A</span><span class="s0">, </span><span class="s1">B = matrices(omega=k*</span><span class="s3">5.</span><span class="s1">/</span><span class="s3">100</span><span class="s1">)</span>
                <span class="s1">self._check_gen_eig(A</span><span class="s0">, </span><span class="s1">B)</span>

    <span class="s0">def </span><span class="s1">test_make_eigvals(self):</span>
        <span class="s4"># Step through all paths in _make_eigvals</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>
        <span class="s4"># Real eigenvalues</span>
        <span class="s1">A = symrand(</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">self._check_gen_eig(A</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">B = symrand(</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">self._check_gen_eig(A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s4"># Complex eigenvalues</span>
        <span class="s1">A = random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) + </span><span class="s3">1j</span><span class="s1">*random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">self._check_gen_eig(A</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">B = random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) + </span><span class="s3">1j</span><span class="s1">*random((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">self._check_gen_eig(A</span><span class="s0">, </span><span class="s1">B)</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eig(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">exact_w = [(</span><span class="s3">9</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s3">9</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">))/</span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">v0 = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s1">+sqrt(</span><span class="s3">93</span><span class="s1">)/</span><span class="s3">3</span><span class="s1">)/</span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">v1 = array([</span><span class="s3">3.</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">v2 = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s1">-sqrt(</span><span class="s3">93</span><span class="s1">)/</span><span class="s3">3</span><span class="s1">)/</span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">v0 = v0 / norm(v0)</span>
        <span class="s1">v1 = v1 / norm(v1)</span>
        <span class="s1">v2 = v2 / norm(v2)</span>
        <span class="s1">assert_array_almost_equal(w</span><span class="s0">, </span><span class="s1">exact_w)</span>
        <span class="s1">assert_array_almost_equal(v0</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(v1</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(v2</span><span class="s0">, </span><span class="s1">v[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]*sign(v[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s1">assert_array_almost_equal(a @ v[:</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">w[i]*v[:</span><span class="s0">, </span><span class="s1">i])</span>

    <span class="s0">def </span><span class="s1">test_not_square_error(self):</span>
        <span class="s2">&quot;&quot;&quot;Check that passing a non-square array raises a ValueError.&quot;&quot;&quot;</span>
        <span class="s1">A = np.arange(</span><span class="s3">6</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eig</span><span class="s0">, </span><span class="s1">A)</span>

    <span class="s0">def </span><span class="s1">test_shape_mismatch(self):</span>
        <span class="s2">&quot;&quot;&quot;Check that passing arrays of with different shapes 
        raises a ValueError.&quot;&quot;&quot;</span>
        <span class="s1">A = eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B = np.arange(</span><span class="s3">9.0</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eig</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eig</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">A)</span>


<span class="s0">class </span><span class="s1">TestEigBanded:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.create_bandmat()</span>

    <span class="s0">def </span><span class="s1">create_bandmat(self):</span>
        <span class="s2">&quot;&quot;&quot;Create the full matrix `self.fullmat` and 
           the corresponding band matrix `self.bandmat`.&quot;&quot;&quot;</span>
        <span class="s1">N = </span><span class="s3">10</span>
        <span class="s1">self.KL = </span><span class="s3">2   </span><span class="s4"># number of subdiagonals (below the diagonal)</span>
        <span class="s1">self.KU = </span><span class="s3">2   </span><span class="s4"># number of superdiagonals (above the diagonal)</span>

        <span class="s4"># symmetric band matrix</span>
        <span class="s1">self.sym_mat = (diag(full(N</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">))</span>
                        <span class="s1">+ diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">) + diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
                        <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">) + diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

        <span class="s4"># hermitian band matrix</span>
        <span class="s1">self.herm_mat = (diag(full(N</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">))</span>
                         <span class="s1">+ </span><span class="s3">1j</span><span class="s1">*diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
                         <span class="s1">- </span><span class="s3">1j</span><span class="s1">*diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

        <span class="s4"># general real band matrix</span>
        <span class="s1">self.real_mat = (diag(full(N</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">))</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">) + diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">) + diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

        <span class="s4"># general complex band matrix</span>
        <span class="s1">self.comp_mat = (</span><span class="s3">1j</span><span class="s1">*diag(full(N</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">))</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span>
                         <span class="s1">+ </span><span class="s3">1j</span><span class="s1">*diag(full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span>
                         <span class="s1">+ diag(full(N-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

        <span class="s4"># Eigenvalues and -vectors from linalg.eig</span>
        <span class="s1">ew</span><span class="s0">, </span><span class="s1">ev = linalg.eig(self.sym_mat)</span>
        <span class="s1">ew = ew.real</span>
        <span class="s1">args = argsort(ew)</span>
        <span class="s1">self.w_sym_lin = ew[args]</span>
        <span class="s1">self.evec_sym_lin = ev[:</span><span class="s0">, </span><span class="s1">args]</span>

        <span class="s1">ew</span><span class="s0">, </span><span class="s1">ev = linalg.eig(self.herm_mat)</span>
        <span class="s1">ew = ew.real</span>
        <span class="s1">args = argsort(ew)</span>
        <span class="s1">self.w_herm_lin = ew[args]</span>
        <span class="s1">self.evec_herm_lin = ev[:</span><span class="s0">, </span><span class="s1">args]</span>

        <span class="s4"># Extract upper bands from symmetric and hermitian band matrices</span>
        <span class="s4"># (for use in dsbevd, dsbevx, zhbevd, zhbevx</span>
        <span class="s4">#  and their single precision versions)</span>
        <span class="s1">LDAB = self.KU + </span><span class="s3">1</span>
        <span class="s1">self.bandmat_sym = zeros((LDAB</span><span class="s0">, </span><span class="s1">N)</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">self.bandmat_herm = zeros((LDAB</span><span class="s0">, </span><span class="s1">N)</span><span class="s0">, </span><span class="s1">dtype=complex)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(LDAB):</span>
            <span class="s1">self.bandmat_sym[LDAB-i-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">i:N] = diag(self.sym_mat</span><span class="s0">, </span><span class="s1">i)</span>
            <span class="s1">self.bandmat_herm[LDAB-i-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">i:N] = diag(self.herm_mat</span><span class="s0">, </span><span class="s1">i)</span>

        <span class="s4"># Extract bands from general real and complex band matrix</span>
        <span class="s4"># (for use in dgbtrf, dgbtrs and their single precision versions)</span>
        <span class="s1">LDAB = </span><span class="s3">2</span><span class="s1">*self.KL + self.KU + </span><span class="s3">1</span>
        <span class="s1">self.bandmat_real = zeros((LDAB</span><span class="s0">, </span><span class="s1">N)</span><span class="s0">, </span><span class="s1">dtype=float)</span>
        <span class="s1">self.bandmat_real[</span><span class="s3">2</span><span class="s1">*self.KL</span><span class="s0">, </span><span class="s1">:] = diag(self.real_mat)  </span><span class="s4"># diagonal</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.KL):</span>
            <span class="s4"># superdiagonals</span>
            <span class="s1">self.bandmat_real[</span><span class="s3">2</span><span class="s1">*self.KL-</span><span class="s3">1</span><span class="s1">-i</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">:N] = diag(self.real_mat</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s4"># subdiagonals</span>
            <span class="s1">self.bandmat_real[</span><span class="s3">2</span><span class="s1">*self.KL+</span><span class="s3">1</span><span class="s1">+i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:N-</span><span class="s3">1</span><span class="s1">-i] = diag(self.real_mat</span><span class="s0">,</span>
                                                             <span class="s1">-i-</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">self.bandmat_comp = zeros((LDAB</span><span class="s0">, </span><span class="s1">N)</span><span class="s0">, </span><span class="s1">dtype=complex)</span>
        <span class="s1">self.bandmat_comp[</span><span class="s3">2</span><span class="s1">*self.KL</span><span class="s0">, </span><span class="s1">:] = diag(self.comp_mat)  </span><span class="s4"># diagonal</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.KL):</span>
            <span class="s4"># superdiagonals</span>
            <span class="s1">self.bandmat_comp[</span><span class="s3">2</span><span class="s1">*self.KL-</span><span class="s3">1</span><span class="s1">-i</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">:N] = diag(self.comp_mat</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s4"># subdiagonals</span>
            <span class="s1">self.bandmat_comp[</span><span class="s3">2</span><span class="s1">*self.KL+</span><span class="s3">1</span><span class="s1">+i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:N-</span><span class="s3">1</span><span class="s1">-i] = diag(self.comp_mat</span><span class="s0">,</span>
                                                             <span class="s1">-i-</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s4"># absolute value for linear equation system A*x = b</span>
        <span class="s1">self.b = </span><span class="s3">1.0</span><span class="s1">*arange(N)</span>
        <span class="s1">self.bc = self.b * (</span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)</span>

    <span class="s4">#####################################################################</span>

    <span class="s0">def </span><span class="s1">test_dsbev(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare dsbev eigenvalues and eigenvectors with 
           the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">evec</span><span class="s0">, </span><span class="s1">info = dsbev(self.bandmat_sym</span><span class="s0">, </span><span class="s1">compute_v=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
        <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec_sym_lin))</span>

    <span class="s0">def </span><span class="s1">test_dsbevd(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare dsbevd eigenvalues and eigenvectors with 
           the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">evec</span><span class="s0">, </span><span class="s1">info = dsbevd(self.bandmat_sym</span><span class="s0">, </span><span class="s1">compute_v=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
        <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec_sym_lin))</span>

    <span class="s0">def </span><span class="s1">test_dsbevx(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare dsbevx eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">N</span><span class="s0">, </span><span class="s1">N = shape(self.sym_mat)</span>
        <span class="s4"># Achtung: Argumente 0.0,0.0,range?</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">evec</span><span class="s0">, </span><span class="s1">num</span><span class="s0">, </span><span class="s1">ifail</span><span class="s0">, </span><span class="s1">info = dsbevx(self.bandmat_sym</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">N</span><span class="s0">,</span>
                                           <span class="s1">compute_v=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">range=</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
        <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec_sym_lin))</span>

    <span class="s0">def </span><span class="s1">test_zhbevd(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare zhbevd eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">evec</span><span class="s0">, </span><span class="s1">info = zhbevd(self.bandmat_herm</span><span class="s0">, </span><span class="s1">compute_v=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
        <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w_herm_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec_herm_lin))</span>

    <span class="s0">def </span><span class="s1">test_zhbevx(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare zhbevx eigenvalues and eigenvectors 
           with the result of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">N</span><span class="s0">, </span><span class="s1">N = shape(self.herm_mat)</span>
        <span class="s4"># Achtung: Argumente 0.0,0.0,range?</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">evec</span><span class="s0">, </span><span class="s1">num</span><span class="s0">, </span><span class="s1">ifail</span><span class="s0">, </span><span class="s1">info = zhbevx(self.bandmat_herm</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">N</span><span class="s0">,</span>
                                           <span class="s1">compute_v=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">range=</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
        <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w_herm_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec_herm_lin))</span>

    <span class="s0">def </span><span class="s1">test_eigvals_banded(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare eigenvalues of eigvals_banded with those of linalg.eig.&quot;&quot;&quot;</span>
        <span class="s1">w_sym = eigvals_banded(self.bandmat_sym)</span>
        <span class="s1">w_sym = w_sym.real</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>

        <span class="s1">w_herm = eigvals_banded(self.bandmat_herm)</span>
        <span class="s1">w_herm = w_herm.real</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm)</span><span class="s0">, </span><span class="s1">self.w_herm_lin)</span>

        <span class="s4"># extracting eigenvalues with respect to an index range</span>
        <span class="s1">ind1 = </span><span class="s3">2</span>
        <span class="s1">ind2 = np.longlong(</span><span class="s3">6</span><span class="s1">)</span>
        <span class="s1">w_sym_ind = eigvals_banded(self.bandmat_sym</span><span class="s0">,</span>
                                   <span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2))</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym_ind)</span><span class="s0">,</span>
                                  <span class="s1">self.w_sym_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">w_herm_ind = eigvals_banded(self.bandmat_herm</span><span class="s0">,</span>
                                    <span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2))</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm_ind)</span><span class="s0">,</span>
                                  <span class="s1">self.w_herm_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>

        <span class="s4"># extracting eigenvalues with respect to a value range</span>
        <span class="s1">v_lower = self.w_sym_lin[ind1] - </span><span class="s3">1.0e-5</span>
        <span class="s1">v_upper = self.w_sym_lin[ind2] + </span><span class="s3">1.0e-5</span>
        <span class="s1">w_sym_val = eigvals_banded(self.bandmat_sym</span><span class="s0">,</span>
                                   <span class="s1">select=</span><span class="s5">'v'</span><span class="s0">, </span><span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper))</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym_val)</span><span class="s0">,</span>
                                  <span class="s1">self.w_sym_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>

        <span class="s1">v_lower = self.w_herm_lin[ind1] - </span><span class="s3">1.0e-5</span>
        <span class="s1">v_upper = self.w_herm_lin[ind2] + </span><span class="s3">1.0e-5</span>
        <span class="s1">w_herm_val = eigvals_banded(self.bandmat_herm</span><span class="s0">,</span>
                                    <span class="s1">select=</span><span class="s5">'v'</span><span class="s0">,</span>
                                    <span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper))</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm_val)</span><span class="s0">,</span>
                                  <span class="s1">self.w_herm_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>

        <span class="s1">w_sym = eigvals_banded(self.bandmat_sym</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">w_sym = w_sym.real</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>

    <span class="s0">def </span><span class="s1">test_eig_banded(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare eigenvalues and eigenvectors of eig_banded 
           with those of linalg.eig. &quot;&quot;&quot;</span>
        <span class="s1">w_sym</span><span class="s0">, </span><span class="s1">evec_sym = eig_banded(self.bandmat_sym)</span>
        <span class="s1">evec_sym_ = evec_sym[:</span><span class="s0">, </span><span class="s1">argsort(w_sym.real)]</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_sym_)</span><span class="s0">, </span><span class="s1">abs(self.evec_sym_lin))</span>

        <span class="s1">w_herm</span><span class="s0">, </span><span class="s1">evec_herm = eig_banded(self.bandmat_herm)</span>
        <span class="s1">evec_herm_ = evec_herm[:</span><span class="s0">, </span><span class="s1">argsort(w_herm.real)]</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm)</span><span class="s0">, </span><span class="s1">self.w_herm_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_herm_)</span><span class="s0">, </span><span class="s1">abs(self.evec_herm_lin))</span>

        <span class="s4"># extracting eigenvalues with respect to an index range</span>
        <span class="s1">ind1 = </span><span class="s3">2</span>
        <span class="s1">ind2 = </span><span class="s3">6</span>
        <span class="s1">w_sym_ind</span><span class="s0">, </span><span class="s1">evec_sym_ind = eig_banded(self.bandmat_sym</span><span class="s0">,</span>
                                             <span class="s1">select=</span><span class="s5">'i'</span><span class="s0">,</span>
                                             <span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2))</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym_ind)</span><span class="s0">,</span>
                                  <span class="s1">self.w_sym_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(abs(evec_sym_ind)</span><span class="s0">,</span>
                                  <span class="s1">abs(self.evec_sym_lin[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>

        <span class="s1">w_herm_ind</span><span class="s0">, </span><span class="s1">evec_herm_ind = eig_banded(self.bandmat_herm</span><span class="s0">,</span>
                                               <span class="s1">select=</span><span class="s5">'i'</span><span class="s0">,</span>
                                               <span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2))</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm_ind)</span><span class="s0">,</span>
                                  <span class="s1">self.w_herm_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(abs(evec_herm_ind)</span><span class="s0">,</span>
                                  <span class="s1">abs(self.evec_herm_lin[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>

        <span class="s4"># extracting eigenvalues with respect to a value range</span>
        <span class="s1">v_lower = self.w_sym_lin[ind1] - </span><span class="s3">1.0e-5</span>
        <span class="s1">v_upper = self.w_sym_lin[ind2] + </span><span class="s3">1.0e-5</span>
        <span class="s1">w_sym_val</span><span class="s0">, </span><span class="s1">evec_sym_val = eig_banded(self.bandmat_sym</span><span class="s0">,</span>
                                             <span class="s1">select=</span><span class="s5">'v'</span><span class="s0">,</span>
                                             <span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper))</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym_val)</span><span class="s0">,</span>
                                  <span class="s1">self.w_sym_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(abs(evec_sym_val)</span><span class="s0">,</span>
                                  <span class="s1">abs(self.evec_sym_lin[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>

        <span class="s1">v_lower = self.w_herm_lin[ind1] - </span><span class="s3">1.0e-5</span>
        <span class="s1">v_upper = self.w_herm_lin[ind2] + </span><span class="s3">1.0e-5</span>
        <span class="s1">w_herm_val</span><span class="s0">, </span><span class="s1">evec_herm_val = eig_banded(self.bandmat_herm</span><span class="s0">,</span>
                                               <span class="s1">select=</span><span class="s5">'v'</span><span class="s0">,</span>
                                               <span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper))</span>
        <span class="s1">assert_array_almost_equal(sort(w_herm_val)</span><span class="s0">,</span>
                                  <span class="s1">self.w_herm_lin[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_array_almost_equal(abs(evec_herm_val)</span><span class="s0">,</span>
                                  <span class="s1">abs(self.evec_herm_lin[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>

        <span class="s1">w_sym</span><span class="s0">, </span><span class="s1">evec_sym = eig_banded(self.bandmat_sym</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">evec_sym_ = evec_sym[:</span><span class="s0">, </span><span class="s1">argsort(w_sym.real)]</span>
        <span class="s1">assert_array_almost_equal(sort(w_sym)</span><span class="s0">, </span><span class="s1">self.w_sym_lin)</span>
        <span class="s1">assert_array_almost_equal(abs(evec_sym_)</span><span class="s0">, </span><span class="s1">abs(self.evec_sym_lin))</span>

    <span class="s0">def </span><span class="s1">test_dgbtrf(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare dgbtrf  LU factorisation with the LU factorisation result 
           of linalg.lu.&quot;&quot;&quot;</span>
        <span class="s1">M</span><span class="s0">, </span><span class="s1">N = shape(self.real_mat)</span>
        <span class="s1">lu_symm_band</span><span class="s0">, </span><span class="s1">ipiv</span><span class="s0">, </span><span class="s1">info = dgbtrf(self.bandmat_real</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU)</span>

        <span class="s4"># extract matrix u from lu_symm_band</span>
        <span class="s1">u = diag(lu_symm_band[</span><span class="s3">2</span><span class="s1">*self.KL</span><span class="s0">, </span><span class="s1">:])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.KL + self.KU):</span>
            <span class="s1">u += diag(lu_symm_band[</span><span class="s3">2</span><span class="s1">*self.KL-</span><span class="s3">1</span><span class="s1">-i</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">:N]</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">p_lin</span><span class="s0">, </span><span class="s1">l_lin</span><span class="s0">, </span><span class="s1">u_lin = lu(self.real_mat</span><span class="s0">, </span><span class="s1">permute_l=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(u</span><span class="s0">, </span><span class="s1">u_lin)</span>

    <span class="s0">def </span><span class="s1">test_zgbtrf(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare zgbtrf  LU factorisation with the LU factorisation result 
           of linalg.lu.&quot;&quot;&quot;</span>
        <span class="s1">M</span><span class="s0">, </span><span class="s1">N = shape(self.comp_mat)</span>
        <span class="s1">lu_symm_band</span><span class="s0">, </span><span class="s1">ipiv</span><span class="s0">, </span><span class="s1">info = zgbtrf(self.bandmat_comp</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU)</span>

        <span class="s4"># extract matrix u from lu_symm_band</span>
        <span class="s1">u = diag(lu_symm_band[</span><span class="s3">2</span><span class="s1">*self.KL</span><span class="s0">, </span><span class="s1">:])</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(self.KL + self.KU):</span>
            <span class="s1">u += diag(lu_symm_band[</span><span class="s3">2</span><span class="s1">*self.KL-</span><span class="s3">1</span><span class="s1">-i</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">:N]</span><span class="s0">, </span><span class="s1">i+</span><span class="s3">1</span><span class="s1">)</span>

        <span class="s1">p_lin</span><span class="s0">, </span><span class="s1">l_lin</span><span class="s0">, </span><span class="s1">u_lin = lu(self.comp_mat</span><span class="s0">, </span><span class="s1">permute_l=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(u</span><span class="s0">, </span><span class="s1">u_lin)</span>

    <span class="s0">def </span><span class="s1">test_dgbtrs(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare dgbtrs  solutions for linear equation system  A*x = b 
           with solutions of linalg.solve.&quot;&quot;&quot;</span>

        <span class="s1">lu_symm_band</span><span class="s0">, </span><span class="s1">ipiv</span><span class="s0">, </span><span class="s1">info = dgbtrf(self.bandmat_real</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU)</span>
        <span class="s1">y</span><span class="s0">, </span><span class="s1">info = dgbtrs(lu_symm_band</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU</span><span class="s0">, </span><span class="s1">self.b</span><span class="s0">, </span><span class="s1">ipiv)</span>

        <span class="s1">y_lin = linalg.solve(self.real_mat</span><span class="s0">, </span><span class="s1">self.b)</span>
        <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y_lin)</span>

    <span class="s0">def </span><span class="s1">test_zgbtrs(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare zgbtrs  solutions for linear equation system  A*x = b 
           with solutions of linalg.solve.&quot;&quot;&quot;</span>

        <span class="s1">lu_symm_band</span><span class="s0">, </span><span class="s1">ipiv</span><span class="s0">, </span><span class="s1">info = zgbtrf(self.bandmat_comp</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU)</span>
        <span class="s1">y</span><span class="s0">, </span><span class="s1">info = zgbtrs(lu_symm_band</span><span class="s0">, </span><span class="s1">self.KL</span><span class="s0">, </span><span class="s1">self.KU</span><span class="s0">, </span><span class="s1">self.bc</span><span class="s0">, </span><span class="s1">ipiv)</span>

        <span class="s1">y_lin = linalg.solve(self.comp_mat</span><span class="s0">, </span><span class="s1">self.bc)</span>
        <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y_lin)</span>


<span class="s0">class </span><span class="s1">TestEigTridiagonal:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.create_trimat()</span>

    <span class="s0">def </span><span class="s1">create_trimat(self):</span>
        <span class="s2">&quot;&quot;&quot;Create the full matrix `self.fullmat`, `self.d`, and `self.e`.&quot;&quot;&quot;</span>
        <span class="s1">N = </span><span class="s3">10</span>

        <span class="s4"># symmetric band matrix</span>
        <span class="s1">self.d = full(N</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span>
        <span class="s1">self.e = full(N-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.0</span><span class="s1">)</span>
        <span class="s1">self.full_mat = (diag(self.d) + diag(self.e</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">) + diag(self.e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

        <span class="s1">ew</span><span class="s0">, </span><span class="s1">ev = linalg.eig(self.full_mat)</span>
        <span class="s1">ew = ew.real</span>
        <span class="s1">args = argsort(ew)</span>
        <span class="s1">self.w = ew[args]</span>
        <span class="s1">self.evec = ev[:</span><span class="s0">, </span><span class="s1">args]</span>

    <span class="s0">def </span><span class="s1">test_degenerate(self):</span>
        <span class="s2">&quot;&quot;&quot;Test error conditions.&quot;&quot;&quot;</span>
        <span class="s4"># Wrong sizes</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e[:-</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s4"># Must be real</span>
        <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e * </span><span class="s3">1j</span><span class="s1">)</span>
        <span class="s4"># Bad driver</span>
        <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                      <span class="s1">lapack_driver=</span><span class="s3">1.</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                      <span class="s1">lapack_driver=</span><span class="s5">'foo'</span><span class="s1">)</span>
        <span class="s4"># Bad bounds</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                      <span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh_tridiagonal(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare eigenvalues of eigvalsh_tridiagonal with those of eig.&quot;&quot;&quot;</span>
        <span class="s4"># can't use ?STERF with subselection</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s1">(</span><span class="s5">'sterf'</span><span class="s0">, </span><span class="s5">'stev'</span><span class="s0">, </span><span class="s5">'stebz'</span><span class="s0">, </span><span class="s5">'stemr'</span><span class="s0">, </span><span class="s5">'auto'</span><span class="s1">):</span>
            <span class="s1">w = eigvalsh_tridiagonal(self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w)</span>

        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s1">(</span><span class="s5">'sterf'</span><span class="s0">, </span><span class="s5">'stev'</span><span class="s1">):</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigvalsh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                          <span class="s1">lapack_driver=</span><span class="s5">'stev'</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">,</span>
                          <span class="s1">select_range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s1">(</span><span class="s5">'stebz'</span><span class="s0">, </span><span class="s5">'stemr'</span><span class="s0">, </span><span class="s5">'auto'</span><span class="s1">):</span>
            <span class="s4"># extracting eigenvalues with respect to the full index range</span>
            <span class="s1">w_ind = eigvalsh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">len(self.d)-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w_ind)</span><span class="s0">, </span><span class="s1">self.w)</span>

            <span class="s4"># extracting eigenvalues with respect to an index range</span>
            <span class="s1">ind1 = </span><span class="s3">2</span>
            <span class="s1">ind2 = </span><span class="s3">6</span>
            <span class="s1">w_ind = eigvalsh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w_ind)</span><span class="s0">, </span><span class="s1">self.w[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>

            <span class="s4"># extracting eigenvalues with respect to a value range</span>
            <span class="s1">v_lower = self.w[ind1] - </span><span class="s3">1.0e-5</span>
            <span class="s1">v_upper = self.w[ind2] + </span><span class="s3">1.0e-5</span>
            <span class="s1">w_val = eigvalsh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'v'</span><span class="s0">, </span><span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w_val)</span><span class="s0">, </span><span class="s1">self.w[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_eigh_tridiagonal(self):</span>
        <span class="s2">&quot;&quot;&quot;Compare eigenvalues and eigenvectors of eigh_tridiagonal 
           with those of eig. &quot;&quot;&quot;</span>
        <span class="s4"># can't use ?STERF when eigenvectors are requested</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                      <span class="s1">lapack_driver=</span><span class="s5">'sterf'</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s1">(</span><span class="s5">'stebz'</span><span class="s0">, </span><span class="s5">'stev'</span><span class="s0">, </span><span class="s5">'stemr'</span><span class="s0">, </span><span class="s5">'auto'</span><span class="s1">):</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">evec = eigh_tridiagonal(self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">lapack_driver=driver)</span>
            <span class="s1">evec_ = evec[:</span><span class="s0">, </span><span class="s1">argsort(w)]</span>
            <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w)</span>
            <span class="s1">assert_array_almost_equal(abs(evec_)</span><span class="s0">, </span><span class="s1">abs(self.evec))</span>

        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh_tridiagonal</span><span class="s0">, </span><span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">,</span>
                      <span class="s1">lapack_driver=</span><span class="s5">'stev'</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">driver </span><span class="s0">in </span><span class="s1">(</span><span class="s5">'stebz'</span><span class="s0">, </span><span class="s5">'stemr'</span><span class="s0">, </span><span class="s5">'auto'</span><span class="s1">):</span>
            <span class="s4"># extracting eigenvalues with respect to an index range</span>
            <span class="s1">ind1 = </span><span class="s3">0</span>
            <span class="s1">ind2 = len(self.d)-</span><span class="s3">1</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">evec = eigh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w)</span>
            <span class="s1">assert_array_almost_equal(abs(evec)</span><span class="s0">, </span><span class="s1">abs(self.evec))</span>
            <span class="s1">ind1 = </span><span class="s3">2</span>
            <span class="s1">ind2 = </span><span class="s3">6</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">evec = eigh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'i'</span><span class="s0">, </span><span class="s1">select_range=(ind1</span><span class="s0">, </span><span class="s1">ind2)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
            <span class="s1">assert_array_almost_equal(abs(evec)</span><span class="s0">,</span>
                                      <span class="s1">abs(self.evec[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>

            <span class="s4"># extracting eigenvalues with respect to a value range</span>
            <span class="s1">v_lower = self.w[ind1] - </span><span class="s3">1.0e-5</span>
            <span class="s1">v_upper = self.w[ind2] + </span><span class="s3">1.0e-5</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">evec = eigh_tridiagonal(</span>
                <span class="s1">self.d</span><span class="s0">, </span><span class="s1">self.e</span><span class="s0">, </span><span class="s1">select=</span><span class="s5">'v'</span><span class="s0">, </span><span class="s1">select_range=(v_lower</span><span class="s0">, </span><span class="s1">v_upper)</span><span class="s0">,</span>
                <span class="s1">lapack_driver=driver)</span>
            <span class="s1">assert_array_almost_equal(sort(w)</span><span class="s0">, </span><span class="s1">self.w[ind1:ind2+</span><span class="s3">1</span><span class="s1">])</span>
            <span class="s1">assert_array_almost_equal(abs(evec)</span><span class="s0">,</span>
                                      <span class="s1">abs(self.evec[:</span><span class="s0">, </span><span class="s1">ind1:ind2+</span><span class="s3">1</span><span class="s1">]))</span>


<span class="s0">class </span><span class="s1">TestEigh:</span>
    <span class="s0">def </span><span class="s1">setup_class(self):</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_wrong_inputs(self):</span>
        <span class="s4"># Nonsquare a</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s4"># Nonsquare b</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s4"># Incompatible a, b sizes</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]))</span>
        <span class="s4"># Wrong type parameter for generalized problem</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">type=</span><span class="s3">4</span><span class="s1">)</span>
        <span class="s4"># Both value and index subsets requested</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">subset_by_value=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'eigvals&quot;</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                          <span class="s1">subset_by_value=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">eigvals=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
        <span class="s4"># Invalid upper index spec</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">subset_by_index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'eigvals&quot;</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                          <span class="s1">eigvals=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
        <span class="s4"># Invalid lower index</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">subset_by_index=[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'eigvals&quot;</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                          <span class="s1">eigvals=[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s4"># Invalid index spec #2</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">subset_by_index=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'eigvals&quot;</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                          <span class="s1">subset_by_index=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s4"># Invalid value spec</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">subset_by_value=[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s4"># Invalid driver name</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">driver=</span><span class="s5">'wrong'</span><span class="s1">)</span>
        <span class="s4"># Generalized driver selection without b</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, None, </span><span class="s1">driver=</span><span class="s5">'gvx'</span><span class="s1">)</span>
        <span class="s4"># Standard driver with b</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">driver=</span><span class="s5">'evr'</span><span class="s0">, </span><span class="s1">turbo=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s4"># Subset request from invalid driver</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                      <span class="s1">driver=</span><span class="s5">'gvd'</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">turbo=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;'eigh' keyword argument 'eigvals&quot;</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">,</span>
                          <span class="s1">driver=</span><span class="s5">'gvd'</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">turbo=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_nonpositive_b(self):</span>
        <span class="s1">assert_raises(LinAlgError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.ones([</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]))</span>

    <span class="s4"># index based subsets are done in the legacy test_eigh()</span>
    <span class="s0">def </span><span class="s1">test_value_subsets(self):</span>
        <span class="s0">for </span><span class="s1">ind</span><span class="s0">, </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">enumerate(DTYPES):</span>

            <span class="s1">a = _random_hermitian_matrix(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">dtype=dt)</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a</span><span class="s0">, </span><span class="s1">subset_by_value=[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
            <span class="s1">assert_equal(v.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">len(w))</span>
            <span class="s0">assert </span><span class="s1">all((w &gt; -</span><span class="s3">2</span><span class="s1">) &amp; (w &lt; </span><span class="s3">2</span><span class="s1">))</span>

            <span class="s1">b = _random_hermitian_matrix(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">posdef=</span><span class="s0">True, </span><span class="s1">dtype=dt)</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">subset_by_value=[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
            <span class="s1">assert_equal(v.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">len(w))</span>
            <span class="s0">assert </span><span class="s1">all((w &gt; -</span><span class="s3">2</span><span class="s1">) &amp; (w &lt; </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_eigh_integer(self):</span>
        <span class="s1">a = array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">b = array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">z = eigh(a)</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">z = eigh(a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">test_eigh_of_sparse(self):</span>
        <span class="s4"># This tests the rejection of inputs that eigh cannot currently handle.</span>
        <span class="s0">import </span><span class="s1">scipy.sparse</span>
        <span class="s1">a = scipy.sparse.identity(</span><span class="s3">2</span><span class="s1">).tocsc()</span>
        <span class="s1">b = np.atleast_2d(a)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">eigh</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'dtype_'</span><span class="s0">, </span><span class="s1">DTYPES)</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'driver'</span><span class="s0">, </span><span class="s1">(</span><span class="s5">&quot;ev&quot;</span><span class="s0">, </span><span class="s5">&quot;evd&quot;</span><span class="s0">, </span><span class="s5">&quot;evr&quot;</span><span class="s0">, </span><span class="s5">&quot;evx&quot;</span><span class="s1">))</span>
    <span class="s0">def </span><span class="s1">test_various_drivers_standard(self</span><span class="s0">, </span><span class="s1">driver</span><span class="s0">, </span><span class="s1">dtype_):</span>
        <span class="s1">a = _random_hermitian_matrix(n=</span><span class="s3">20</span><span class="s0">, </span><span class="s1">dtype=dtype_)</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a</span><span class="s0">, </span><span class="s1">driver=driver)</span>
        <span class="s1">assert_allclose(a @ v - (v * w)</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s3">1000</span><span class="s1">*np.finfo(dtype_).eps</span><span class="s0">,</span>
                        <span class="s1">rtol=</span><span class="s3">0.</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'type'</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'driver'</span><span class="s0">, </span><span class="s1">(</span><span class="s5">&quot;gv&quot;</span><span class="s0">, </span><span class="s5">&quot;gvd&quot;</span><span class="s0">, </span><span class="s5">&quot;gvx&quot;</span><span class="s1">))</span>
    <span class="s0">def </span><span class="s1">test_various_drivers_generalized(self</span><span class="s0">, </span><span class="s1">driver</span><span class="s0">, </span><span class="s1">type):</span>
        <span class="s1">atol = np.spacing(</span><span class="s3">5000.</span><span class="s1">)</span>
        <span class="s1">a = _random_hermitian_matrix(</span><span class="s3">20</span><span class="s1">)</span>
        <span class="s1">b = _random_hermitian_matrix(</span><span class="s3">20</span><span class="s0">, </span><span class="s1">posdef=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a=a</span><span class="s0">, </span><span class="s1">b=b</span><span class="s0">, </span><span class="s1">driver=driver</span><span class="s0">, </span><span class="s1">type=type)</span>
        <span class="s0">if </span><span class="s1">type == </span><span class="s3">1</span><span class="s1">:</span>
            <span class="s1">assert_allclose(a @ v - w*(b @ v)</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">0.</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">type == </span><span class="s3">2</span><span class="s1">:</span>
            <span class="s1">assert_allclose(a @ b @ v - v * w</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">0.</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_allclose(b @ a @ v - v * w</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">0.</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh_new_args(self):</span>
        <span class="s1">a = _random_hermitian_matrix(</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">w = eigvalsh(a</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(len(w)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>

        <span class="s1">w2 = eigvalsh(a</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(len(w2)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(w</span><span class="s0">, </span><span class="s1">w2)</span>

        <span class="s1">b = np.diag([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.2</span><span class="s0">, </span><span class="s3">1.3</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">w3 = eigvalsh(b</span><span class="s0">, </span><span class="s1">subset_by_value=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.4</span><span class="s1">])</span>
        <span class="s1">assert_equal(len(w3)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(w3</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1.2</span><span class="s0">, </span><span class="s3">1.3</span><span class="s1">]))</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[eigh</span><span class="s0">, </span><span class="s1">eigvalsh])</span>
    <span class="s0">def </span><span class="s1">test_deprecation_warnings(self</span><span class="s0">, </span><span class="s1">method):</span>
        <span class="s0">with </span><span class="s1">pytest.warns(DeprecationWarning</span><span class="s0">,</span>
                          <span class="s1">match=</span><span class="s5">&quot;Keyword argument 'turbo'&quot;</span><span class="s1">):</span>
            <span class="s1">method(np.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">turbo=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.warns(DeprecationWarning</span><span class="s0">,</span>
                          <span class="s1">match=</span><span class="s5">&quot;Keyword argument 'eigvals'&quot;</span><span class="s1">):</span>
            <span class="s1">method(np.zeros((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">eigvals=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_deprecation_results(self):</span>
        <span class="s1">a = _random_hermitian_matrix(</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">b = _random_hermitian_matrix(</span><span class="s3">3</span><span class="s0">, </span><span class="s1">posdef=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s4"># check turbo gives same result as driver='gvd'</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'turbo'&quot;</span><span class="s1">)</span>
            <span class="s1">w_dep</span><span class="s0">, </span><span class="s1">v_dep = eigh(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">turbo=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">driver=</span><span class="s5">'gvd'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(w_dep</span><span class="s0">, </span><span class="s1">w)</span>
        <span class="s1">assert_allclose(v_dep</span><span class="s0">, </span><span class="s1">v)</span>

        <span class="s4"># check eigvals gives the same result as subset_by_index</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(DeprecationWarning</span><span class="s0">, </span><span class="s5">&quot;Keyword argument 'eigvals'&quot;</span><span class="s1">)</span>
            <span class="s1">w_dep</span><span class="s0">, </span><span class="s1">v_dep = eigh(a</span><span class="s0">, </span><span class="s1">eigvals=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = eigh(a</span><span class="s0">, </span><span class="s1">subset_by_index=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_allclose(w_dep</span><span class="s0">, </span><span class="s1">w)</span>
        <span class="s1">assert_allclose(v_dep</span><span class="s0">, </span><span class="s1">v)</span>


<span class="s0">class </span><span class="s1">TestSVD_GESDD:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.lapack_driver = </span><span class="s5">'gesdd'</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_degenerate(self):</span>
        <span class="s1">assert_raises(TypeError</span><span class="s0">, </span><span class="s1">svd</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1.</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">lapack_driver=</span><span class="s3">1.</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">svd</span><span class="s0">, </span><span class="s1">[[</span><span class="s3">1.</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">lapack_driver=</span><span class="s5">'foo'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                           <span class="s1">lapack_driver=self.lapack_driver)</span>
            <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
            <span class="s1">assert_array_almost_equal(vh.T @ vh</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
            <span class="s1">sigma = zeros((u.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
            <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_singular(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                           <span class="s1">lapack_driver=self.lapack_driver)</span>
            <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
            <span class="s1">assert_array_almost_equal(vh.T @ vh</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
            <span class="s1">sigma = zeros((u.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
            <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                           <span class="s1">lapack_driver=self.lapack_driver)</span>
            <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(u.shape[</span><span class="s3">0</span><span class="s1">]))</span>
            <span class="s1">sigma = zeros((u.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
            <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                           <span class="s1">lapack_driver=self.lapack_driver)</span>
            <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(u.shape[</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(vh.T @ vh</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
            <span class="s1">sigma = zeros((u.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
            <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s1">m = </span><span class="s3">15</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">[random([n</span><span class="s0">, </span><span class="s1">m])</span><span class="s0">, </span><span class="s1">random([m</span><span class="s0">, </span><span class="s1">n])]:</span>
                <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
                    <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                                   <span class="s1">lapack_driver=self.lapack_driver)</span>
                    <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(u.shape[</span><span class="s3">1</span><span class="s1">]))</span>
                    <span class="s1">assert_array_almost_equal(vh @ vh.T</span><span class="s0">, </span><span class="s1">eye(vh.shape[</span><span class="s3">0</span><span class="s1">]))</span>
                    <span class="s1">sigma = zeros((u.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                        <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
                    <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2j</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
            <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                           <span class="s1">lapack_driver=self.lapack_driver)</span>
            <span class="s1">assert_array_almost_equal(u.conj().T @ u</span><span class="s0">, </span><span class="s1">eye(u.shape[</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(vh.conj().T @ vh</span><span class="s0">, </span><span class="s1">eye(vh.shape[</span><span class="s3">0</span><span class="s1">]))</span>
            <span class="s1">sigma = zeros((u.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
            <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_complex(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s1">m = </span><span class="s3">15</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">full_matrices </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
                <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">[random([n</span><span class="s0">, </span><span class="s1">m])</span><span class="s0">, </span><span class="s1">random([m</span><span class="s0">, </span><span class="s1">n])]:</span>
                    <span class="s1">a = a + </span><span class="s3">1j</span><span class="s1">*random(list(a.shape))</span>
                    <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">full_matrices=full_matrices</span><span class="s0">,</span>
                                   <span class="s1">lapack_driver=self.lapack_driver)</span>
                    <span class="s1">assert_array_almost_equal(u.conj().T @ u</span><span class="s0">,</span>
                                              <span class="s1">eye(u.shape[</span><span class="s3">1</span><span class="s1">]))</span>
                    <span class="s4"># This fails when [m,n]</span>
                    <span class="s4"># assert_array_almost_equal(vh.conj().T @ vh,</span>
                    <span class="s4">#                        eye(len(vh),dtype=vh.dtype.char))</span>
                    <span class="s1">sigma = zeros((u.shape[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
                    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
                        <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
                    <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_crash_1580(self):</span>
        <span class="s1">sizes = [(</span><span class="s3">13</span><span class="s0">, </span><span class="s3">23</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">30</span><span class="s0">, </span><span class="s3">50</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">60</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)]</span>
        <span class="s1">np.random.seed(</span><span class="s3">1234</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">sz </span><span class="s0">in </span><span class="s1">sizes:</span>
            <span class="s0">for </span><span class="s1">dt </span><span class="s0">in </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.complex64</span><span class="s0">, </span><span class="s1">np.complex128]:</span>
                <span class="s1">a = np.random.rand(*sz).astype(dt)</span>
                <span class="s4"># should not crash</span>
                <span class="s1">svd(a</span><span class="s0">, </span><span class="s1">lapack_driver=self.lapack_driver)</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False, </span><span class="s1">lapack_driver=self.lapack_driver)</span>
        <span class="s1">assert_array_almost_equal(u.T @ u</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(vh.T @ vh</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">sigma = zeros((u.shape[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">vh.shape[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">s.dtype.char)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(s)):</span>
            <span class="s1">sigma[i</span><span class="s0">, </span><span class="s1">i] = s[i]</span>
        <span class="s1">assert_array_almost_equal(u @ sigma @ vh</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_gh_5039(self):</span>
        <span class="s4"># This is a smoke test for https://github.com/scipy/scipy/issues/5039</span>
        <span class="s4">#</span>
        <span class="s4"># The following is reported to raise &quot;ValueError: On entry to DGESDD</span>
        <span class="s4"># parameter number 12 had an illegal value&quot;.</span>
        <span class="s4"># `interp1d([1,2,3,4], [1,2,3,4], kind='cubic')`</span>
        <span class="s4"># This is reported to only show up on LAPACK 3.0.3.</span>
        <span class="s4">#</span>
        <span class="s4"># The matrix below is taken from the call to</span>
        <span class="s4"># `B = _fitpack._bsplmat(order, xk)` in interpolate._find_smoothest</span>
        <span class="s1">b = np.array(</span>
            <span class="s1">[[</span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.66666667</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.66666667</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.66666667</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s0">, </span><span class="s3">0.66666667</span><span class="s0">, </span><span class="s3">0.16666667</span><span class="s1">]])</span>
        <span class="s1">svd(b</span><span class="s0">, </span><span class="s1">lapack_driver=self.lapack_driver)</span>

    <span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">HAS_ILP64</span><span class="s0">, </span><span class="s1">reason=</span><span class="s5">&quot;64-bit LAPACK required&quot;</span><span class="s1">)</span>
    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_large_matrix(self):</span>
        <span class="s1">check_free_memory(free_mb=</span><span class="s3">17000</span><span class="s1">)</span>
        <span class="s1">A = np.zeros([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">**</span><span class="s3">31</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
        <span class="s1">A[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">] = </span><span class="s3">1</span>
        <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">vh = svd(A</span><span class="s0">, </span><span class="s1">full_matrices=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_allclose(s[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span>
        <span class="s1">assert_allclose(u[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] * vh[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestSVD_GESVD(TestSVD_GESDD):</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.lapack_driver = </span><span class="s5">'gesvd'</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestSVDVals:</span>

    <span class="s0">def </span><span class="s1">test_empty(self):</span>
        <span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">[[]]</span><span class="s0">, </span><span class="s1">np.empty((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)):</span>
            <span class="s1">s = svdvals(a)</span>
            <span class="s1">assert_equal(s</span><span class="s0">, </span><span class="s1">np.empty(</span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">] &gt;= s[</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">3j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">] &gt;= s[</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_simple_underdet_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5j</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_simple_overdet_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3j</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">s = svdvals(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_(len(s) == </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_(s[</span><span class="s3">0</span><span class="s1">] &gt;= s[</span><span class="s3">1</span><span class="s1">] &gt;= s[</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_crash_2609(self):</span>
        <span class="s1">np.random.seed(</span><span class="s3">1234</span><span class="s1">)</span>
        <span class="s1">a = np.random.rand(</span><span class="s3">1500</span><span class="s0">, </span><span class="s3">2800</span><span class="s1">)</span>
        <span class="s4"># Shouldn't crash:</span>
        <span class="s1">svdvals(a)</span>


<span class="s0">class </span><span class="s1">TestDiagSVD:</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">assert_array_almost_equal(diagsvd([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
                                  <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span>


<span class="s0">class </span><span class="s1">TestQR:</span>

    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_left(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_right(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_pivoting(self):</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_left_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_right_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap_pivoting(self):</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall(self):</span>
        <span class="s4"># full version</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_pivoting(self):</span>
        <span class="s4"># full version pivoting</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_e(self):</span>
        <span class="s4"># economy version</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_e_pivoting(self):</span>
        <span class="s4"># economy version pivoting</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p]</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_left(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">c = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, </span><span class="s1">overwrite_c=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c[:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_left_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">kpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(jpvt</span><span class="s0">, </span><span class="s1">kpvt)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_right(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(cq</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_right_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(cq</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat(self):</span>
        <span class="s4"># full version</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_pivoting(self):</span>
        <span class="s4"># full version pivoting</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_e(self):</span>
        <span class="s4"># economy version</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>
        <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_e_pivoting(self):</span>
        <span class="s4"># economy version pivoting</span>
        <span class="s1">a = np.asarray([[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p]</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_left(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_left_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_right(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(cq</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat_right_pivoting(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
        <span class="s1">cq</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(cq</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">assert_array_almost_equal(q.conj().T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall_complex_left(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">3j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s1">+</span><span class="s3">7j</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">2j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>
        <span class="s1">c = array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r2 = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, </span><span class="s1">overwrite_c=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c[:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">qc)</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left_conjugate(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, </span><span class="s1">conjugate=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.conj() @ c</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_tall_left_conjugate(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">2j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, </span><span class="s1">conjugate=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.conj() @ c</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right_conjugate(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
        <span class="s1">c = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">])</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">conjugate=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(c @ q.conj()</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_pivoting(self):</span>
        <span class="s1">a = array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">d = abs(diag(r))</span>
        <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">assert_array_almost_equal(q.conj().T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_left_pivoting(self):</span>
        <span class="s1">a = array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex_right_pivoting(self):</span>
        <span class="s1">a = array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]])</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">c = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s1">]</span>
        <span class="s1">qc</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">jpvt = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_random(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_left(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">c = random([n])</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_random_right(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">c = random([n])</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
            <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">cq)</span>

    <span class="s0">def </span><span class="s1">test_random_pivoting(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">d = abs(diag(r))</span>
            <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
            <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_random_tall(self):</span>
        <span class="s4"># full version</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_left(self):</span>
        <span class="s4"># full version</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
            <span class="s1">c = random([n])</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(qc</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_right(self):</span>
        <span class="s4"># full version</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">&quot;economic&quot;</span><span class="s1">)</span>
            <span class="s1">c = random([m])</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
            <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(cq</span><span class="s0">, </span><span class="s1">q)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_pivoting(self):</span>
        <span class="s4"># full version pivoting</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">d = abs(diag(r))</span>
            <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
            <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_random_tall_e(self):</span>
        <span class="s4"># economy version</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">n))</span>
            <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n))</span>

    <span class="s0">def </span><span class="s1">test_random_tall_e_pivoting(self):</span>
        <span class="s4"># economy version pivoting</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
            <span class="s1">d = abs(diag(r))</span>
            <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">n))</span>
            <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n))</span>
            <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p]</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
            <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_random_trap(self):</span>
        <span class="s1">m = </span><span class="s3">100</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_trap_pivoting(self):</span>
        <span class="s1">m = </span><span class="s3">100</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">d = abs(diag(r))</span>
            <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
            <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_random_complex(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">assert_array_almost_equal(q.conj().T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_left(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">c = random([n])+</span><span class="s3">1j</span><span class="s1">*random([n])</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q @ c</span><span class="s0">, </span><span class="s1">qc)</span>
            <span class="s1">qc</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s5">&quot;left&quot;</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">qc)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_right(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a)</span>
            <span class="s1">c = random([n])+</span><span class="s3">1j</span><span class="s1">*random([n])</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">c)</span>
            <span class="s1">assert_array_almost_equal(c @ q</span><span class="s0">, </span><span class="s1">cq)</span>
            <span class="s1">cq</span><span class="s0">, </span><span class="s1">r = qr_multiply(a</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">cq)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_pivoting(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">q</span><span class="s0">, </span><span class="s1">r</span><span class="s0">, </span><span class="s1">p = qr(a</span><span class="s0">, </span><span class="s1">pivoting=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">d = abs(diag(r))</span>
            <span class="s1">assert_(np.all(d[</span><span class="s3">1</span><span class="s1">:] &lt;= d[:-</span><span class="s3">1</span><span class="s1">]))</span>
            <span class="s1">assert_array_almost_equal(q.conj().T @ q</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a[:</span><span class="s0">, </span><span class="s1">p])</span>
            <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">q2)</span>
            <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(q @ r</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_lwork(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s4"># Get comparison values</span>
        <span class="s1">q</span><span class="s0">, </span><span class="s1">r = qr(a</span><span class="s0">, </span><span class="s1">lwork=</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s4"># Test against minimum valid lwork</span>
        <span class="s1">q2</span><span class="s0">, </span><span class="s1">r2 = qr(a</span><span class="s0">, </span><span class="s1">lwork=</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q2</span><span class="s0">, </span><span class="s1">q)</span>
        <span class="s1">assert_array_almost_equal(r2</span><span class="s0">, </span><span class="s1">r)</span>

        <span class="s4"># Test against larger lwork</span>
        <span class="s1">q3</span><span class="s0">, </span><span class="s1">r3 = qr(a</span><span class="s0">, </span><span class="s1">lwork=</span><span class="s3">10</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q3</span><span class="s0">, </span><span class="s1">q)</span>
        <span class="s1">assert_array_almost_equal(r3</span><span class="s0">, </span><span class="s1">r)</span>

        <span class="s4"># Test against explicit lwork=-1</span>
        <span class="s1">q4</span><span class="s0">, </span><span class="s1">r4 = qr(a</span><span class="s0">, </span><span class="s1">lwork=-</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q4</span><span class="s0">, </span><span class="s1">q)</span>
        <span class="s1">assert_array_almost_equal(r4</span><span class="s0">, </span><span class="s1">r)</span>

        <span class="s4"># Test against invalid lwork</span>
        <span class="s1">assert_raises(Exception</span><span class="s0">, </span><span class="s1">qr</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s5">'lwork'</span><span class="s1">: </span><span class="s3">0</span><span class="s1">})</span>
        <span class="s1">assert_raises(Exception</span><span class="s0">, </span><span class="s1">qr</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s5">'lwork'</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span>


<span class="s0">class </span><span class="s1">TestRQ:</span>

    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">seed(</span><span class="s3">1234</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_r(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">r2 = rq(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'r'</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(r</span><span class="s0">, </span><span class="s1">r2)</span>

    <span class="s0">def </span><span class="s1">test_random(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
            <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_trap(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_tall(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">assert_array_almost_equal(q.T @ q</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_fat(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">+</span><span class="s3">4j</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">+</span><span class="s3">7j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
        <span class="s1">assert_array_almost_equal(q @ q.conj().T</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_tall(self):</span>
        <span class="s1">m = </span><span class="s3">200</span>
        <span class="s1">n = </span><span class="s3">100</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
            <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_trap(self):</span>
        <span class="s1">m = </span><span class="s3">100</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
            <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_trap_economic(self):</span>
        <span class="s1">m = </span><span class="s3">100</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">n))</span>
            <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">m))</span>

    <span class="s0">def </span><span class="s1">test_random_complex(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a)</span>
            <span class="s1">assert_array_almost_equal(q @ q.conj().T</span><span class="s0">, </span><span class="s1">eye(n))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>

    <span class="s0">def </span><span class="s1">test_random_complex_economic(self):</span>
        <span class="s1">m = </span><span class="s3">100</span>
        <span class="s1">n = </span><span class="s3">200</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([m</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([m</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a</span><span class="s0">, </span><span class="s1">mode=</span><span class="s5">'economic'</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q @ q.conj().T</span><span class="s0">, </span><span class="s1">eye(m))</span>
            <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>
            <span class="s1">assert_equal(q.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">n))</span>
            <span class="s1">assert_equal(r.shape</span><span class="s0">, </span><span class="s1">(m</span><span class="s0">, </span><span class="s1">m))</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">r</span><span class="s0">, </span><span class="s1">q = rq(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q @ q.T</span><span class="s0">, </span><span class="s1">eye(</span><span class="s3">3</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(r @ q</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">class </span><span class="s1">TestSchur:</span>

    <span class="s0">def </span><span class="s1">check_schur(self</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">t</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol):</span>
        <span class="s4"># Check that the Schur decomposition is correct.</span>
        <span class="s1">assert_allclose(u @ t @ u.conj().T</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                        <span class="s1">err_msg=</span><span class="s5">&quot;Schur decomposition does not match 'a'&quot;</span><span class="s1">)</span>
        <span class="s4"># The expected value of u @ u.H - I is all zeros, so test</span>
        <span class="s4"># with absolute tolerance only.</span>
        <span class="s1">assert_allclose(u @ u.conj().T - np.eye(len(u))</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                        <span class="s1">err_msg=</span><span class="s5">&quot;u is not unitary&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">t</span><span class="s0">, </span><span class="s1">z = schur(a)</span>
        <span class="s1">self.check_schur(a</span><span class="s0">, </span><span class="s1">t</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-14</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">5e-15</span><span class="s1">)</span>
        <span class="s1">tc</span><span class="s0">, </span><span class="s1">zc = schur(a</span><span class="s0">, </span><span class="s5">'complex'</span><span class="s1">)</span>
        <span class="s1">assert_(np.any(ravel(iscomplex(zc))) </span><span class="s0">and </span><span class="s1">np.any(ravel(iscomplex(tc))))</span>
        <span class="s1">self.check_schur(a</span><span class="s0">, </span><span class="s1">tc</span><span class="s0">, </span><span class="s1">zc</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-14</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">5e-15</span><span class="s1">)</span>
        <span class="s1">tc2</span><span class="s0">, </span><span class="s1">zc2 = rsf2csf(tc</span><span class="s0">, </span><span class="s1">zc)</span>
        <span class="s1">self.check_schur(a</span><span class="s0">, </span><span class="s1">tc2</span><span class="s0">, </span><span class="s1">zc2</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-14</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">5e-15</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s5">'sort, expected_diag'</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">[-np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span><span class="s0">,</span>
         <span class="s1">(</span><span class="s5">'rhp'</span><span class="s0">, </span><span class="s1">[np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">-np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])</span><span class="s0">,</span>
         <span class="s1">(</span><span class="s5">'iuc'</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-np.sqrt(</span><span class="s3">2</span><span class="s1">)])</span><span class="s0">,</span>
         <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span><span class="s0">,</span>
         <span class="s1">(</span><span class="s0">lambda </span><span class="s1">x: x &gt;= </span><span class="s3">0.0</span><span class="s0">, </span><span class="s1">[np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">-np.sqrt(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])]</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_sort(self</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">expected_diag):</span>
        <span class="s4"># The exact eigenvalues of this matrix are</span>
        <span class="s4">#   -sqrt(2), sqrt(2), -1/2, 1/2.</span>
        <span class="s1">a = [[</span><span class="s3">4.</span><span class="s0">, </span><span class="s3">3.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[-</span><span class="s3">4.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">9.</span><span class="s0">, </span><span class="s3">6.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4.</span><span class="s0">, </span><span class="s3">4.5</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">6.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.</span><span class="s0">, </span><span class="s3">3.5</span><span class="s1">]]</span>
        <span class="s1">t</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">sdim = schur(a</span><span class="s0">, </span><span class="s1">sort=sort)</span>
        <span class="s1">self.check_schur(a</span><span class="s0">, </span><span class="s1">t</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-14</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">5e-15</span><span class="s1">)</span>
        <span class="s1">assert_allclose(np.diag(t)</span><span class="s0">, </span><span class="s1">expected_diag</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
        <span class="s1">assert_equal(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">sdim)</span>

    <span class="s0">def </span><span class="s1">test_sort_errors(self):</span>
        <span class="s1">a = [[</span><span class="s3">4.</span><span class="s0">, </span><span class="s3">3.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[-</span><span class="s3">4.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.</span><span class="s0">, </span><span class="s3">1.</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">9.</span><span class="s0">, </span><span class="s3">6.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4.</span><span class="s0">, </span><span class="s3">4.5</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">6.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.</span><span class="s0">, </span><span class="s3">3.5</span><span class="s1">]]</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">schur</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">sort=</span><span class="s5">'unsupported'</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">schur</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">sort=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">t</span><span class="s0">, </span><span class="s1">z = schur(a</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(z @ t @ z.conj().T</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">class </span><span class="s1">TestHessenberg:</span>

    <span class="s0">def </span><span class="s1">test_simple(self):</span>
        <span class="s1">a = [[-</span><span class="s3">149</span><span class="s0">, </span><span class="s1">-</span><span class="s3">50</span><span class="s0">, </span><span class="s1">-</span><span class="s3">154</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">537</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s3">546</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[-</span><span class="s3">27</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9</span><span class="s0">, </span><span class="s1">-</span><span class="s3">25</span><span class="s1">]]</span>
        <span class="s1">h1 = [[-</span><span class="s3">149.0000</span><span class="s0">, </span><span class="s3">42.2037</span><span class="s0">, </span><span class="s1">-</span><span class="s3">156.3165</span><span class="s1">]</span><span class="s0">,</span>
              <span class="s1">[-</span><span class="s3">537.6783</span><span class="s0">, </span><span class="s3">152.5511</span><span class="s0">, </span><span class="s1">-</span><span class="s3">554.9272</span><span class="s1">]</span><span class="s0">,</span>
              <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.0728</span><span class="s0">, </span><span class="s3">2.4489</span><span class="s1">]]</span>
        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>
        <span class="s1">assert_array_almost_equal(h</span><span class="s0">, </span><span class="s1">h1</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_simple_complex(self):</span>
        <span class="s1">a = [[-</span><span class="s3">149</span><span class="s0">, </span><span class="s1">-</span><span class="s3">50</span><span class="s0">, </span><span class="s1">-</span><span class="s3">154</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">537</span><span class="s0">, </span><span class="s3">180j</span><span class="s0">, </span><span class="s3">546</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[-</span><span class="s3">27j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9</span><span class="s0">, </span><span class="s1">-</span><span class="s3">25</span><span class="s1">]]</span>
        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.conj().T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">test_simple2(self):</span>
        <span class="s1">a = [[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]]</span>
        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">test_simple3(self):</span>
        <span class="s1">a = np.eye(</span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">a[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">2</span>
        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">test_random(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q.T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">test_random_complex(self):</span>
        <span class="s1">n = </span><span class="s3">20</span>
        <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
            <span class="s1">a = random([n</span><span class="s0">, </span><span class="s1">n])+</span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
            <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(q.conj().T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">a = [[-</span><span class="s3">149</span><span class="s0">, </span><span class="s1">-</span><span class="s3">50</span><span class="s0">, </span><span class="s1">-</span><span class="s3">154</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s3">537</span><span class="s0">, </span><span class="s3">180</span><span class="s0">, </span><span class="s3">546</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[-</span><span class="s3">27</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9</span><span class="s0">, </span><span class="s1">-</span><span class="s3">25</span><span class="s1">]]</span>
        <span class="s1">h1 = [[-</span><span class="s3">149.0000</span><span class="s0">, </span><span class="s3">42.2037</span><span class="s0">, </span><span class="s1">-</span><span class="s3">156.3165</span><span class="s1">]</span><span class="s0">,</span>
              <span class="s1">[-</span><span class="s3">537.6783</span><span class="s0">, </span><span class="s3">152.5511</span><span class="s0">, </span><span class="s1">-</span><span class="s3">554.9272</span><span class="s1">]</span><span class="s0">,</span>
              <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.0728</span><span class="s0">, </span><span class="s3">2.4489</span><span class="s1">]]</span>
        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q.T @ a @ q</span><span class="s0">, </span><span class="s1">h)</span>
        <span class="s1">assert_array_almost_equal(h</span><span class="s0">, </span><span class="s1">h1</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_2x2(self):</span>
        <span class="s1">a = [[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]]</span>

        <span class="s1">h</span><span class="s0">, </span><span class="s1">q = hessenberg(a</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(h</span><span class="s0">, </span><span class="s1">a)</span>

        <span class="s1">b = [[</span><span class="s3">2</span><span class="s1">-</span><span class="s3">7j</span><span class="s0">, </span><span class="s3">1</span><span class="s1">+</span><span class="s3">2j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s1">+</span><span class="s3">3j</span><span class="s0">, </span><span class="s3">12</span><span class="s1">-</span><span class="s3">2j</span><span class="s1">]]</span>
        <span class="s1">h2</span><span class="s0">, </span><span class="s1">q2 = hessenberg(b</span><span class="s0">, </span><span class="s1">calc_q=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(q2</span><span class="s0">, </span><span class="s1">np.eye(</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_array_almost_equal(h2</span><span class="s0">, </span><span class="s1">b)</span>


<span class="s1">blas_provider = blas_version = </span><span class="s0">None</span>
<span class="s0">if </span><span class="s1">CONFIG </span><span class="s0">is not None</span><span class="s1">:</span>
    <span class="s1">blas_provider = CONFIG[</span><span class="s5">'Build Dependencies'</span><span class="s1">][</span><span class="s5">'blas'</span><span class="s1">][</span><span class="s5">'name'</span><span class="s1">]</span>
    <span class="s1">blas_version = CONFIG[</span><span class="s5">'Build Dependencies'</span><span class="s1">][</span><span class="s5">'blas'</span><span class="s1">][</span><span class="s5">'version'</span><span class="s1">]</span>


<span class="s0">class </span><span class="s1">TestQZ:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">seed(</span><span class="s3">12345</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.xfail(</span>
        <span class="s1">sys.platform == </span><span class="s5">'darwin' </span><span class="s0">and</span>
        <span class="s1">blas_provider == </span><span class="s5">'openblas' </span><span class="s0">and</span>
        <span class="s1">blas_version &lt; </span><span class="s5">&quot;0.3.21.dev&quot;</span><span class="s0">,</span>
        <span class="s1">reason=</span><span class="s5">&quot;gges[float32] broken for OpenBLAS on macOS, see gh-16949&quot;</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_qz_single(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = random([n</span><span class="s0">, </span><span class="s1">n]).astype(float32)</span>
        <span class="s1">B = random([n</span><span class="s0">, </span><span class="s1">n]).astype(float32)</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ AA @ Z.T</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB @ Z.T</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.T</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.T</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">B = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ AA @ Z.T</span><span class="s0">, </span><span class="s1">A)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB @ Z.T</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_qz_complex(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = random([n</span><span class="s0">, </span><span class="s1">n]) + </span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">B = random([n</span><span class="s0">, </span><span class="s1">n]) + </span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ AA @ Z.conj().T</span><span class="s0">, </span><span class="s1">A)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB @ Z.conj().T</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.conj().T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.conj().T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(diag(BB).imag == </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_qz_complex64(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = (random([n</span><span class="s0">, </span><span class="s1">n]) + </span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])).astype(complex64)</span>
        <span class="s1">B = (random([n</span><span class="s0">, </span><span class="s1">n]) + </span><span class="s3">1j</span><span class="s1">*random([n</span><span class="s0">, </span><span class="s1">n])).astype(complex64)</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ AA @ Z.conj().T</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB @ Z.conj().T</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.conj().T</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.conj().T</span><span class="s0">, </span><span class="s1">eye(n)</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(diag(BB).imag == </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double_complex(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">B = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">output=</span><span class="s5">'complex'</span><span class="s1">)</span>
        <span class="s1">aa = Q @ AA @ Z.conj().T</span>
        <span class="s1">assert_array_almost_equal(aa.real</span><span class="s0">, </span><span class="s1">A)</span>
        <span class="s1">assert_array_almost_equal(aa.imag</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">bb = Q @ BB @ Z.conj().T</span>
        <span class="s1">assert_array_almost_equal(bb.real</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(bb.imag</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.conj().T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.conj().T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_qz_double_sort(self):</span>
        <span class="s4"># from https://www.nag.com/lapack-ex/node119.html</span>
        <span class="s4"># NOTE: These matrices may be ill-conditioned and lead to a</span>
        <span class="s4"># seg fault on certain python versions when compiled with</span>
        <span class="s4"># sse2 or sse3 older ATLAS/LAPACK binaries for windows</span>
        <span class="s4"># A =   np.array([[3.9,  12.5, -34.5,  -0.5],</span>
        <span class="s4">#                [ 4.3,  21.5, -47.5,   7.5],</span>
        <span class="s4">#                [ 4.3,  21.5, -43.5,   3.5],</span>
        <span class="s4">#                [ 4.4,  26.0, -46.0,   6.0 ]])</span>

        <span class="s4"># B = np.array([[ 1.0,   2.0,  -3.0,   1.0],</span>
        <span class="s4">#              [1.0,   3.0,  -5.0,   4.0],</span>
        <span class="s4">#              [1.0,   3.0,  -4.0,   3.0],</span>
        <span class="s4">#              [1.0,   3.0,  -4.0,   4.0]])</span>
        <span class="s1">A = np.array([[</span><span class="s3">3.9</span><span class="s0">, </span><span class="s3">12.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">34.5</span><span class="s0">, </span><span class="s3">2.5</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">4.3</span><span class="s0">, </span><span class="s3">21.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">47.5</span><span class="s0">, </span><span class="s3">7.5</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">4.3</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">43.5</span><span class="s0">, </span><span class="s3">3.5</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">4.4</span><span class="s0">, </span><span class="s3">6.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">46.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">]])</span>

        <span class="s1">B = np.array([[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">4.4</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s3">1.2</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">4.0</span><span class="s1">]])</span>

        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">qz</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">lambda </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">ai</span><span class="s0">, </span><span class="s1">beta: ai == </span><span class="s3">0</span><span class="s1">)</span>
        <span class="s0">if False</span><span class="s1">:</span>
            <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z</span><span class="s0">, </span><span class="s1">sdim = qz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">lambda </span><span class="s1">ar</span><span class="s0">, </span><span class="s1">ai</span><span class="s0">, </span><span class="s1">beta: ai == </span><span class="s3">0</span><span class="s1">)</span>
            <span class="s4"># assert_(sdim == 2)</span>
            <span class="s1">assert_(sdim == </span><span class="s3">4</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(Q @ AA @ Z.T</span><span class="s0">, </span><span class="s1">A)</span>
            <span class="s1">assert_array_almost_equal(Q @ BB @ Z.T</span><span class="s0">, </span><span class="s1">B)</span>

            <span class="s4"># test absolute values bc the sign is ambiguous and</span>
            <span class="s4"># might be platform dependent</span>
            <span class="s1">assert_array_almost_equal(np.abs(AA)</span><span class="s0">, </span><span class="s1">np.abs(np.array(</span>
                            <span class="s1">[[</span><span class="s3">35.7864</span><span class="s0">, </span><span class="s1">-</span><span class="s3">80.9061</span><span class="s0">, </span><span class="s1">-</span><span class="s3">12.0629</span><span class="s0">, </span><span class="s1">-</span><span class="s3">9.498</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">2.7638</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.3505</span><span class="s0">, </span><span class="s3">7.3256</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.6258</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.0398</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">-</span><span class="s3">12.8217</span><span class="s1">]]))</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.abs(BB)</span><span class="s0">, </span><span class="s1">np.abs(np.array(</span>
                            <span class="s1">[[</span><span class="s3">4.5324</span><span class="s0">, </span><span class="s1">-</span><span class="s3">8.7878</span><span class="s0">, </span><span class="s3">3.2357</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.5526</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">1.4314</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.1894</span><span class="s0">, </span><span class="s3">0.9709</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">1.3126</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.3468</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s3">0.559</span><span class="s1">]]))</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.abs(Q)</span><span class="s0">, </span><span class="s1">np.abs(np.array(</span>
                            <span class="s1">[[-</span><span class="s3">0.4193</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.605</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.1894</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.6498</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[-</span><span class="s3">0.5495</span><span class="s0">, </span><span class="s3">0.6987</span><span class="s0">, </span><span class="s3">0.2654</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.3734</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[-</span><span class="s3">0.4973</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.3682</span><span class="s0">, </span><span class="s3">0.6194</span><span class="s0">, </span><span class="s3">0.4832</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[-</span><span class="s3">0.5243</span><span class="s0">, </span><span class="s3">0.1008</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.7142</span><span class="s0">, </span><span class="s3">0.4526</span><span class="s1">]]))</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
            <span class="s1">assert_array_almost_equal(np.abs(Z)</span><span class="s0">, </span><span class="s1">np.abs(np.array(</span>
                            <span class="s1">[[-</span><span class="s3">0.9471</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.2971</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.1217</span><span class="s0">, </span><span class="s3">0.0055</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[-</span><span class="s3">0.0367</span><span class="s0">, </span><span class="s3">0.1209</span><span class="s0">, </span><span class="s3">0.0358</span><span class="s0">, </span><span class="s3">0.9913</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.3171</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.9041</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.2547</span><span class="s0">, </span><span class="s3">0.1312</span><span class="s1">]</span><span class="s0">,</span>
                             <span class="s1">[</span><span class="s3">0.0346</span><span class="s0">, </span><span class="s3">0.2824</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.9587</span><span class="s0">, </span><span class="s3">0.0014</span><span class="s1">]]))</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>

        <span class="s4"># test absolute values bc the sign is ambiguous and might be platform</span>
        <span class="s4"># dependent</span>
        <span class="s4"># assert_array_almost_equal(abs(AA), abs(np.array([</span>
        <span class="s4">#                [3.8009, -69.4505, 50.3135, -43.2884],</span>
        <span class="s4">#                [0.0000, 9.2033, -0.2001, 5.9881],</span>
        <span class="s4">#                [0.0000, 0.0000, 1.4279, 4.4453],</span>
        <span class="s4">#                [0.0000, 0.0000, 0.9019, -1.1962]])), 4)</span>
        <span class="s4"># assert_array_almost_equal(abs(BB), abs(np.array([</span>
        <span class="s4">#                [1.9005, -10.2285, 0.8658, -5.2134],</span>
        <span class="s4">#                [0.0000,   2.3008, 0.7915,  0.4262],</span>
        <span class="s4">#                [0.0000,   0.0000, 0.8101,  0.0000],</span>
        <span class="s4">#                [0.0000,   0.0000, 0.0000, -0.2823]])), 4)</span>
        <span class="s4"># assert_array_almost_equal(abs(Q), abs(np.array([</span>
        <span class="s4">#                [0.4642,  0.7886,  0.2915, -0.2786],</span>
        <span class="s4">#                [0.5002, -0.5986,  0.5638, -0.2713],</span>
        <span class="s4">#                [0.5002,  0.0154, -0.0107,  0.8657],</span>
        <span class="s4">#                [0.5331, -0.1395, -0.7727, -0.3151]])), 4)</span>
        <span class="s4"># assert_array_almost_equal(dot(Q,Q.T), eye(4))</span>
        <span class="s4"># assert_array_almost_equal(abs(Z), abs(np.array([</span>
        <span class="s4">#                [0.9961, -0.0014,  0.0887, -0.0026],</span>
        <span class="s4">#                [0.0057, -0.0404, -0.0938, -0.9948],</span>
        <span class="s4">#                [0.0626,  0.7194, -0.6908,  0.0363],</span>
        <span class="s4">#                [0.0626, -0.6934, -0.7114,  0.0956]])), 4)</span>
        <span class="s4"># assert_array_almost_equal(dot(Z,Z.T), eye(4))</span>

    <span class="s4"># def test_qz_complex_sort(self):</span>
    <span class="s4">#    cA = np.array([</span>
    <span class="s4">#   [-21.10+22.50*1j, 53.50+-50.50*1j, -34.50+127.50*1j, 7.50+  0.50*1j],</span>
    <span class="s4">#   [-0.46+ -7.78*1j, -3.50+-37.50*1j, -15.50+ 58.50*1j,-10.50+ -1.50*1j],</span>
    <span class="s4">#   [ 4.30+ -5.50*1j, 39.70+-17.10*1j, -68.50+ 12.50*1j, -7.50+ -3.50*1j],</span>
    <span class="s4">#   [ 5.50+  4.40*1j, 14.40+ 43.30*1j, -32.50+-46.00*1j,-19.00+-32.50*1j]])</span>

    <span class="s4">#    cB =  np.array([</span>
    <span class="s4">#   [1.00+ -5.00*1j, 1.60+  1.20*1j,-3.00+  0.00*1j, 0.00+ -1.00*1j],</span>
    <span class="s4">#   [0.80+ -0.60*1j, 3.00+ -5.00*1j,-4.00+  3.00*1j,-2.40+ -3.20*1j],</span>
    <span class="s4">#   [1.00+  0.00*1j, 2.40+  1.80*1j,-4.00+ -5.00*1j, 0.00+ -3.00*1j],</span>
    <span class="s4">#   [0.00+  1.00*1j,-1.80+  2.40*1j, 0.00+ -4.00*1j, 4.00+ -5.00*1j]])</span>

    <span class="s4">#    AAS,BBS,QS,ZS,sdim = qz(cA,cB,sort='lhp')</span>

    <span class="s4">#    eigenvalues = diag(AAS)/diag(BBS)</span>
    <span class="s4">#    assert_(np.all(np.real(eigenvalues[:sdim] &lt; 0)))</span>
    <span class="s4">#    assert_(np.all(np.real(eigenvalues[sdim:] &gt; 0)))</span>

    <span class="s0">def </span><span class="s1">test_check_finite(self):</span>
        <span class="s1">n = </span><span class="s3">5</span>
        <span class="s1">A = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">B = random([n</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z = qz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">check_finite=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(Q @ AA @ Z.T</span><span class="s0">, </span><span class="s1">A)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB @ Z.T</span><span class="s0">, </span><span class="s1">B)</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.T</span><span class="s0">, </span><span class="s1">eye(n))</span>
        <span class="s1">assert_(np.all(diag(BB) &gt;= </span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestOrdQZ:</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s4"># https://www.nag.com/lapack-ex/node119.html</span>
        <span class="s1">A1 = np.array([[-</span><span class="s3">21.10 </span><span class="s1">- </span><span class="s3">22.50j</span><span class="s0">, </span><span class="s3">53.5 </span><span class="s1">- </span><span class="s3">50.5j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">34.5 </span><span class="s1">+ </span><span class="s3">127.5j</span><span class="s0">,</span>
                        <span class="s3">7.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[-</span><span class="s3">0.46 </span><span class="s1">- </span><span class="s3">7.78j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3.5 </span><span class="s1">- </span><span class="s3">37.5j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">15.5 </span><span class="s1">+ </span><span class="s3">58.5j</span><span class="s0">,</span>
                        <span class="s1">-</span><span class="s3">10.5 </span><span class="s1">- </span><span class="s3">1.5j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">4.30 </span><span class="s1">- </span><span class="s3">5.50j</span><span class="s0">, </span><span class="s3">39.7 </span><span class="s1">- </span><span class="s3">17.1j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">68.5 </span><span class="s1">+ </span><span class="s3">12.5j</span><span class="s0">,</span>
                        <span class="s1">-</span><span class="s3">7.5 </span><span class="s1">- </span><span class="s3">3.5j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">5.50 </span><span class="s1">+ </span><span class="s3">4.40j</span><span class="s0">, </span><span class="s3">14.4 </span><span class="s1">+ </span><span class="s3">43.3j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">32.5 </span><span class="s1">- </span><span class="s3">46.0j</span><span class="s0">,</span>
                        <span class="s1">-</span><span class="s3">19.0 </span><span class="s1">- </span><span class="s3">32.5j</span><span class="s1">]])</span>

        <span class="s1">B1 = np.array([[</span><span class="s3">1.0 </span><span class="s1">- </span><span class="s3">5.0j</span><span class="s0">, </span><span class="s3">1.6 </span><span class="s1">+ </span><span class="s3">1.2j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3 </span><span class="s1">+ </span><span class="s3">0j</span><span class="s0">, </span><span class="s3">0.0 </span><span class="s1">- </span><span class="s3">1.0j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">0.8 </span><span class="s1">- </span><span class="s3">0.6j</span><span class="s0">, </span><span class="s3">.0 </span><span class="s1">- </span><span class="s3">5.0j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4 </span><span class="s1">+ </span><span class="s3">3j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2.4 </span><span class="s1">- </span><span class="s3">3.2j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">1.0 </span><span class="s1">+ </span><span class="s3">0.0j</span><span class="s0">, </span><span class="s3">2.4 </span><span class="s1">+ </span><span class="s3">1.8j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4 </span><span class="s1">- </span><span class="s3">5j</span><span class="s0">, </span><span class="s3">0.0 </span><span class="s1">- </span><span class="s3">3.0j</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">0.0 </span><span class="s1">+ </span><span class="s3">1.0j</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.8 </span><span class="s1">+ </span><span class="s3">2.4j</span><span class="s0">, </span><span class="s3">0 </span><span class="s1">- </span><span class="s3">4j</span><span class="s0">, </span><span class="s3">4.0 </span><span class="s1">- </span><span class="s3">5.0j</span><span class="s1">]])</span>

        <span class="s4"># https://www.nag.com/numeric/fl/nagdoc_fl23/xhtml/F08/f08yuf.xml</span>
        <span class="s1">A2 = np.array([[</span><span class="s3">3.9</span><span class="s0">, </span><span class="s3">12.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">34.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">4.3</span><span class="s0">, </span><span class="s3">21.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">47.5</span><span class="s0">, </span><span class="s3">7.5</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">4.3</span><span class="s0">, </span><span class="s3">21.5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">43.5</span><span class="s0">, </span><span class="s3">3.5</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">4.4</span><span class="s0">, </span><span class="s3">26.0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">46.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">]])</span>

        <span class="s1">B2 = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>

        <span class="s4"># example with the eigenvalues</span>
        <span class="s4"># -0.33891648, 1.61217396+0.74013521j, 1.61217396-0.74013521j,</span>
        <span class="s4"># 0.61244091</span>
        <span class="s4"># thus featuring:</span>
        <span class="s4">#  * one complex conjugate eigenvalue pair,</span>
        <span class="s4">#  * one eigenvalue in the lhp</span>
        <span class="s4">#  * 2 eigenvalues in the unit circle</span>
        <span class="s4">#  * 2 non-real eigenvalues</span>
        <span class="s1">A3 = np.array([[</span><span class="s3">5.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">3.</span><span class="s0">, </span><span class="s3">3.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">4.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s3">2.</span><span class="s0">, </span><span class="s3">7.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">7.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">3.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">0.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s3">8.</span><span class="s0">, </span><span class="s3">7.</span><span class="s1">]])</span>
        <span class="s1">B3 = np.array([[</span><span class="s3">8.</span><span class="s0">, </span><span class="s3">10.</span><span class="s0">, </span><span class="s3">6.</span><span class="s0">, </span><span class="s3">10.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">7.</span><span class="s0">, </span><span class="s3">7.</span><span class="s0">, </span><span class="s3">2.</span><span class="s0">, </span><span class="s3">9.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">9.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">6.</span><span class="s0">, </span><span class="s3">6.</span><span class="s1">]</span><span class="s0">,</span>
                       <span class="s1">[</span><span class="s3">5.</span><span class="s0">, </span><span class="s3">1.</span><span class="s0">, </span><span class="s3">4.</span><span class="s0">, </span><span class="s3">7.</span><span class="s1">]])</span>

        <span class="s4"># example with infinite eigenvalues</span>
        <span class="s1">A4 = np.eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B4 = np.diag([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

        <span class="s4"># example with (alpha, beta) = (0, 0)</span>
        <span class="s1">A5 = np.diag([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>

        <span class="s1">cls.A = [A1</span><span class="s0">, </span><span class="s1">A2</span><span class="s0">, </span><span class="s1">A3</span><span class="s0">, </span><span class="s1">A4</span><span class="s0">, </span><span class="s1">A5]</span>
        <span class="s1">cls.B = [B1</span><span class="s0">, </span><span class="s1">B2</span><span class="s0">, </span><span class="s1">B3</span><span class="s0">, </span><span class="s1">B4</span><span class="s0">, </span><span class="s1">A5]</span>

    <span class="s0">def </span><span class="s1">qz_decomp(self</span><span class="s0">, </span><span class="s1">sort):</span>
        <span class="s0">with </span><span class="s1">np.errstate(all=</span><span class="s5">'raise'</span><span class="s1">):</span>
            <span class="s1">ret = [ordqz(Ai</span><span class="s0">, </span><span class="s1">Bi</span><span class="s0">, </span><span class="s1">sort=sort) </span><span class="s0">for </span><span class="s1">Ai</span><span class="s0">, </span><span class="s1">Bi </span><span class="s0">in </span><span class="s1">zip(self.A</span><span class="s0">, </span><span class="s1">self.B)]</span>
        <span class="s0">return </span><span class="s1">tuple(ret)</span>

    <span class="s0">def </span><span class="s1">check(self</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">AA</span><span class="s0">, </span><span class="s1">BB</span><span class="s0">, </span><span class="s1">alpha</span><span class="s0">, </span><span class="s1">beta</span><span class="s0">, </span><span class="s1">Q</span><span class="s0">, </span><span class="s1">Z):</span>
        <span class="s1">Id = np.eye(*A.shape)</span>
        <span class="s4"># make sure Q and Z are orthogonal</span>
        <span class="s1">assert_array_almost_equal(Q @ Q.T.conj()</span><span class="s0">, </span><span class="s1">Id)</span>
        <span class="s1">assert_array_almost_equal(Z @ Z.T.conj()</span><span class="s0">, </span><span class="s1">Id)</span>
        <span class="s4"># check factorization</span>
        <span class="s1">assert_array_almost_equal(Q @ AA</span><span class="s0">, </span><span class="s1">A @ Z)</span>
        <span class="s1">assert_array_almost_equal(Q @ BB</span><span class="s0">, </span><span class="s1">B @ Z)</span>
        <span class="s4"># check shape of AA and BB</span>
        <span class="s1">assert_array_equal(np.tril(AA</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros(AA.shape))</span>
        <span class="s1">assert_array_equal(np.tril(BB</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros(BB.shape))</span>
        <span class="s4"># check eigenvalues</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(A.shape[</span><span class="s3">0</span><span class="s1">]):</span>
            <span class="s4"># does the current diagonal element belong to a 2-by-2 block</span>
            <span class="s4"># that was already checked?</span>
            <span class="s0">if </span><span class="s1">i &gt; </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">A[i</span><span class="s0">, </span><span class="s1">i - </span><span class="s3">1</span><span class="s1">] != </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s0">continue</span>
            <span class="s4"># take care of 2-by-2 blocks</span>
            <span class="s0">if </span><span class="s1">i &lt; AA.shape[</span><span class="s3">0</span><span class="s1">] - </span><span class="s3">1 </span><span class="s0">and </span><span class="s1">AA[i + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">i] != </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s1">evals</span><span class="s0">, </span><span class="s1">_ = eig(AA[i:i + </span><span class="s3">2</span><span class="s0">, </span><span class="s1">i:i + </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">BB[i:i + </span><span class="s3">2</span><span class="s0">, </span><span class="s1">i:i + </span><span class="s3">2</span><span class="s1">])</span>
                <span class="s4"># make sure the pair of complex conjugate eigenvalues</span>
                <span class="s4"># is ordered consistently (positive imaginary part first)</span>
                <span class="s0">if </span><span class="s1">evals[</span><span class="s3">0</span><span class="s1">].imag &lt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">evals = evals[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
                <span class="s1">tmp = alpha[i:i + </span><span class="s3">2</span><span class="s1">]/beta[i:i + </span><span class="s3">2</span><span class="s1">]</span>
                <span class="s0">if </span><span class="s1">tmp[</span><span class="s3">0</span><span class="s1">].imag &lt; </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">tmp = tmp[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span>
                <span class="s1">assert_array_almost_equal(evals</span><span class="s0">, </span><span class="s1">tmp)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s0">if </span><span class="s1">alpha[i] == </span><span class="s3">0 </span><span class="s0">and </span><span class="s1">beta[i] == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">assert_equal(AA[i</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
                    <span class="s1">assert_equal(BB[i</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s0">elif </span><span class="s1">beta[i] == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">assert_equal(BB[i</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s0">else</span><span class="s1">:</span>
                    <span class="s1">assert_almost_equal(AA[i</span><span class="s0">, </span><span class="s1">i]/BB[i</span><span class="s0">, </span><span class="s1">i]</span><span class="s0">, </span><span class="s1">alpha[i]/beta[i])</span>
        <span class="s1">sortfun = _select_function(sort)</span>
        <span class="s1">lastsort = </span><span class="s0">True</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(A.shape[</span><span class="s3">0</span><span class="s1">]):</span>
            <span class="s1">cursort = sortfun(np.array([alpha[i]])</span><span class="s0">, </span><span class="s1">np.array([beta[i]]))</span>
            <span class="s4"># once the sorting criterion was not matched all subsequent</span>
            <span class="s4"># eigenvalues also shouldn't match</span>
            <span class="s0">if not </span><span class="s1">lastsort:</span>
                <span class="s0">assert not </span><span class="s1">cursort</span>
            <span class="s1">lastsort = cursort</span>

    <span class="s0">def </span><span class="s1">check_all(self</span><span class="s0">, </span><span class="s1">sort):</span>
        <span class="s1">ret = self.qz_decomp(sort)</span>

        <span class="s0">for </span><span class="s1">reti</span><span class="s0">, </span><span class="s1">Ai</span><span class="s0">, </span><span class="s1">Bi </span><span class="s0">in </span><span class="s1">zip(ret</span><span class="s0">, </span><span class="s1">self.A</span><span class="s0">, </span><span class="s1">self.B):</span>
            <span class="s1">self.check(Ai</span><span class="s0">, </span><span class="s1">Bi</span><span class="s0">, </span><span class="s1">sort</span><span class="s0">, </span><span class="s1">*reti)</span>

    <span class="s0">def </span><span class="s1">test_lhp(self):</span>
        <span class="s1">self.check_all(</span><span class="s5">'lhp'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_rhp(self):</span>
        <span class="s1">self.check_all(</span><span class="s5">'rhp'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_iuc(self):</span>
        <span class="s1">self.check_all(</span><span class="s5">'iuc'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_ouc(self):</span>
        <span class="s1">self.check_all(</span><span class="s5">'ouc'</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_ref(self):</span>
        <span class="s4"># real eigenvalues first (top-left corner)</span>
        <span class="s0">def </span><span class="s1">sort(x</span><span class="s0">, </span><span class="s1">y):</span>
            <span class="s1">out = np.empty_like(x</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
            <span class="s1">nonzero = (y != </span><span class="s3">0</span><span class="s1">)</span>
            <span class="s1">out[~nonzero] = </span><span class="s0">False</span>
            <span class="s1">out[nonzero] = (x[nonzero]/y[nonzero]).imag == </span><span class="s3">0</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s1">self.check_all(sort)</span>

    <span class="s0">def </span><span class="s1">test_cef(self):</span>
        <span class="s4"># complex eigenvalues first (top-left corner)</span>
        <span class="s0">def </span><span class="s1">sort(x</span><span class="s0">, </span><span class="s1">y):</span>
            <span class="s1">out = np.empty_like(x</span><span class="s0">, </span><span class="s1">dtype=bool)</span>
            <span class="s1">nonzero = (y != </span><span class="s3">0</span><span class="s1">)</span>
            <span class="s1">out[~nonzero] = </span><span class="s0">False</span>
            <span class="s1">out[nonzero] = (x[nonzero]/y[nonzero]).imag != </span><span class="s3">0</span>
            <span class="s0">return </span><span class="s1">out</span>

        <span class="s1">self.check_all(sort)</span>

    <span class="s0">def </span><span class="s1">test_diff_input_types(self):</span>
        <span class="s1">ret = ordqz(self.A[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.B[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sort=</span><span class="s5">'lhp'</span><span class="s1">)</span>
        <span class="s1">self.check(self.A[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.B[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">*ret)</span>

        <span class="s1">ret = ordqz(self.B[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.A[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sort=</span><span class="s5">'lhp'</span><span class="s1">)</span>
        <span class="s1">self.check(self.B[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">self.A[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">*ret)</span>

    <span class="s0">def </span><span class="s1">test_sort_explicit(self):</span>
        <span class="s4"># Test order of the eigenvalues in the 2 x 2 case where we can</span>
        <span class="s4"># explicitly compute the solution</span>
        <span class="s1">A1 = np.eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B1 = np.diag([-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s1">expected1 = [(</span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'rhp'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'iuc'</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])]</span>
        <span class="s1">A2 = np.eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B2 = np.diag([-</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s0">, </span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">])</span>
        <span class="s1">expected2 = [(</span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">/(-</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">/(</span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">)])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'rhp'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">/(</span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">/(-</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'iuc'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">/(-</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">/(</span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">)])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">/(</span><span class="s3">0.5 </span><span class="s1">+ </span><span class="s3">0.5j</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">/(-</span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">)])]</span>
        <span class="s4"># 'lhp' is ambiguous so don't test it</span>
        <span class="s1">A3 = np.eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B3 = np.diag([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">expected3 = [(</span><span class="s5">'rhp'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'iuc'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])]</span>
        <span class="s4"># 'rhp' is ambiguous so don't test it</span>
        <span class="s1">A4 = np.eye(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">B4 = np.diag([-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">expected4 = [(</span><span class="s5">'lhp'</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'iuc'</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[np.inf</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.5</span><span class="s1">])]</span>
        <span class="s1">A5 = np.diag([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">B5 = np.diag([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>
        <span class="s4"># 'lhp' and 'iuc' are ambiguous so don't test them</span>
        <span class="s1">expected5 = [(</span><span class="s5">'rhp'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan])</span><span class="s0">,</span>
                     <span class="s1">(</span><span class="s5">'ouc'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">np.nan])]</span>

        <span class="s1">A = [A1</span><span class="s0">, </span><span class="s1">A2</span><span class="s0">, </span><span class="s1">A3</span><span class="s0">, </span><span class="s1">A4</span><span class="s0">, </span><span class="s1">A5]</span>
        <span class="s1">B = [B1</span><span class="s0">, </span><span class="s1">B2</span><span class="s0">, </span><span class="s1">B3</span><span class="s0">, </span><span class="s1">B4</span><span class="s0">, </span><span class="s1">B5]</span>
        <span class="s1">expected = [expected1</span><span class="s0">, </span><span class="s1">expected2</span><span class="s0">, </span><span class="s1">expected3</span><span class="s0">, </span><span class="s1">expected4</span><span class="s0">, </span><span class="s1">expected5]</span>
        <span class="s0">for </span><span class="s1">Ai</span><span class="s0">, </span><span class="s1">Bi</span><span class="s0">, </span><span class="s1">expectedi </span><span class="s0">in </span><span class="s1">zip(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">expected):</span>
            <span class="s0">for </span><span class="s1">sortstr</span><span class="s0">, </span><span class="s1">expected_eigvals </span><span class="s0">in </span><span class="s1">expectedi:</span>
                <span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">alpha</span><span class="s0">, </span><span class="s1">beta</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = ordqz(Ai</span><span class="s0">, </span><span class="s1">Bi</span><span class="s0">, </span><span class="s1">sort=sortstr)</span>
                <span class="s1">azero = (alpha == </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s1">bzero = (beta == </span><span class="s3">0</span><span class="s1">)</span>
                <span class="s1">x = np.empty_like(alpha)</span>
                <span class="s1">x[azero &amp; bzero] = np.nan</span>
                <span class="s1">x[~azero &amp; bzero] = np.inf</span>
                <span class="s1">x[~bzero] = alpha[~bzero]/beta[~bzero]</span>
                <span class="s1">assert_allclose(expected_eigvals</span><span class="s0">, </span><span class="s1">x)</span>


<span class="s0">class </span><span class="s1">TestOrdQZWorkspaceSize:</span>

    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">seed(</span><span class="s3">12345</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_decompose(self):</span>

        <span class="s1">N = </span><span class="s3">202</span>

        <span class="s4"># raises error if lwork parameter to dtrsen is too small</span>
        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64]:</span>
            <span class="s1">A = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s1">B = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s4"># sort = lambda ar, ai, b: ar**2 + ai**2 &lt; b**2</span>
            <span class="s1">_ = ordqz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">lambda </span><span class="s1">alpha</span><span class="s0">, </span><span class="s1">beta: alpha &lt; beta</span><span class="s0">,</span>
                      <span class="s1">output=</span><span class="s5">'real'</span><span class="s1">)</span>

        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s1">[np.complex128</span><span class="s0">, </span><span class="s1">np.complex64]:</span>
            <span class="s1">A = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s1">B = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s1">_ = ordqz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort=</span><span class="s0">lambda </span><span class="s1">alpha</span><span class="s0">, </span><span class="s1">beta: alpha &lt; beta</span><span class="s0">,</span>
                      <span class="s1">output=</span><span class="s5">'complex'</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s0">def </span><span class="s1">test_decompose_ouc(self):</span>

        <span class="s1">N = </span><span class="s3">202</span>

        <span class="s4"># segfaults if lwork parameter to dtrsen is too small</span>
        <span class="s0">for </span><span class="s1">ddtype </span><span class="s0">in </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.complex128</span><span class="s0">, </span><span class="s1">np.complex64]:</span>
            <span class="s1">A = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s1">B = random((N</span><span class="s0">, </span><span class="s1">N)).astype(ddtype)</span>
            <span class="s1">S</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">alpha</span><span class="s0">, </span><span class="s1">beta</span><span class="s0">, </span><span class="s1">U</span><span class="s0">, </span><span class="s1">V = ordqz(A</span><span class="s0">, </span><span class="s1">B</span><span class="s0">, </span><span class="s1">sort=</span><span class="s5">'ouc'</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestDatacopied:</span>

    <span class="s0">def </span><span class="s1">test_datacopied(self):</span>
        <span class="s0">from </span><span class="s1">scipy.linalg._decomp </span><span class="s0">import </span><span class="s1">_datacopied</span>

        <span class="s1">M = matrix([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]])</span>
        <span class="s1">A = asarray(M)</span>
        <span class="s1">L = M.tolist()</span>
        <span class="s1">M2 = M.copy()</span>

        <span class="s0">class </span><span class="s1">Fake1:</span>
            <span class="s0">def </span><span class="s1">__array__(self):</span>
                <span class="s0">return </span><span class="s1">A</span>

        <span class="s0">class </span><span class="s1">Fake2:</span>
            <span class="s1">__array_interface__ = A.__array_interface__</span>

        <span class="s1">F1 = Fake1()</span>
        <span class="s1">F2 = Fake2()</span>

        <span class="s0">for </span><span class="s1">item</span><span class="s0">, </span><span class="s1">status </span><span class="s0">in </span><span class="s1">[(M</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(A</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(L</span><span class="s0">, True</span><span class="s1">)</span><span class="s0">,</span>
                             <span class="s1">(M2</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(F1</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(F2</span><span class="s0">, False</span><span class="s1">)]:</span>
            <span class="s1">arr = asarray(item)</span>
            <span class="s1">assert_equal(_datacopied(arr</span><span class="s0">, </span><span class="s1">item)</span><span class="s0">, </span><span class="s1">status</span><span class="s0">,</span>
                         <span class="s1">err_msg=repr(item))</span>


<span class="s0">def </span><span class="s1">test_aligned_mem_float():</span>
    <span class="s2">&quot;&quot;&quot;Check linalg works with non-aligned memory (float32)&quot;&quot;&quot;</span>
    <span class="s4"># Allocate 402 bytes of memory (allocated on boundary)</span>
    <span class="s1">a = arange(</span><span class="s3">402</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>

    <span class="s4"># Create an array with boundary offset 4</span>
    <span class="s1">z = np.frombuffer(a.data</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">count=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">dtype=float32)</span>
    <span class="s1">z.shape = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span>

    <span class="s1">eig(z</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">eig(z.T</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s1">@pytest.mark.skipif(platform.machine() == </span><span class="s5">'ppc64le'</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;crashes on ppc64le&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_aligned_mem():</span>
    <span class="s2">&quot;&quot;&quot;Check linalg works with non-aligned memory (float64)&quot;&quot;&quot;</span>
    <span class="s4"># Allocate 804 bytes of memory (allocated on boundary)</span>
    <span class="s1">a = arange(</span><span class="s3">804</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>

    <span class="s4"># Create an array with boundary offset 4</span>
    <span class="s1">z = np.frombuffer(a.data</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">count=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">z.shape = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span>

    <span class="s1">eig(z</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">eig(z.T</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_aligned_mem_complex():</span>
    <span class="s2">&quot;&quot;&quot;Check that complex objects don't need to be completely aligned&quot;&quot;&quot;</span>
    <span class="s4"># Allocate 1608 bytes of memory (allocated on boundary)</span>
    <span class="s1">a = zeros(</span><span class="s3">1608</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>

    <span class="s4"># Create an array with boundary offset 8</span>
    <span class="s1">z = np.frombuffer(a.data</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">8</span><span class="s0">, </span><span class="s1">count=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">dtype=complex)</span>
    <span class="s1">z.shape = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span>

    <span class="s1">eig(z</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s4"># This does not need special handling</span>
    <span class="s1">eig(z.T</span><span class="s0">, </span><span class="s1">overwrite_a=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">check_lapack_misaligned(func</span><span class="s0">, </span><span class="s1">args</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">args = list(args)</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(args)):</span>
        <span class="s1">a = args[:]</span>
        <span class="s0">if </span><span class="s1">isinstance(a[i]</span><span class="s0">, </span><span class="s1">np.ndarray):</span>
            <span class="s4"># Try misaligning a[i]</span>
            <span class="s1">aa = np.zeros(a[i].size*a[i].dtype.itemsize+</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
            <span class="s1">aa = np.frombuffer(aa.data</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">count=a[i].size</span><span class="s0">,</span>
                               <span class="s1">dtype=a[i].dtype)</span>
            <span class="s1">aa.shape = a[i].shape</span>
            <span class="s1">aa[...] = a[i]</span>
            <span class="s1">a[i] = aa</span>
            <span class="s1">func(*a</span><span class="s0">, </span><span class="s1">**kwargs)</span>
            <span class="s0">if </span><span class="s1">len(a[i].shape) &gt; </span><span class="s3">1</span><span class="s1">:</span>
                <span class="s1">a[i] = a[i].T</span>
                <span class="s1">func(*a</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s1">@pytest.mark.xfail(run=</span><span class="s0">False,</span>
                   <span class="s1">reason=</span><span class="s5">&quot;Ticket #1152, triggers a segfault in rare cases.&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_lapack_misaligned():</span>
    <span class="s1">M = np.eye(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">R = np.arange(</span><span class="s3">100</span><span class="s1">)</span>
    <span class="s1">R.shape = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span>
    <span class="s1">S = np.arange(</span><span class="s3">20000</span><span class="s0">, </span><span class="s1">dtype=np.uint8)</span>
    <span class="s1">S = np.frombuffer(S.data</span><span class="s0">, </span><span class="s1">offset=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">count=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">S.shape = </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span>
    <span class="s1">b = np.ones(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">LU</span><span class="s0">, </span><span class="s1">piv = lu_factor(S)</span>
    <span class="s0">for </span><span class="s1">(func</span><span class="s0">, </span><span class="s1">args</span><span class="s0">, </span><span class="s1">kwargs) </span><span class="s0">in </span><span class="s1">[</span>
            <span class="s1">(eig</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(eigvals</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(lu</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(lu_factor</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(lu_solve</span><span class="s0">, </span><span class="s1">((LU</span><span class="s0">, </span><span class="s1">piv)</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">dict(overwrite_b=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(solve</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True, </span><span class="s1">overwrite_b=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">(svd</span><span class="s0">, </span><span class="s1">(M</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(svd</span><span class="s0">, </span><span class="s1">(R</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(svd</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(svdvals</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict())</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(svdvals</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(cholesky</span><span class="s0">, </span><span class="s1">(M</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># no crash</span>
            <span class="s1">(qr</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(rq</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(hessenberg</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">(schur</span><span class="s0">, </span><span class="s1">(S</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dict(overwrite_a=</span><span class="s0">True</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># crash</span>
            <span class="s1">]:</span>
        <span class="s1">check_lapack_misaligned(func</span><span class="s0">, </span><span class="s1">args</span><span class="s0">, </span><span class="s1">kwargs)</span>
<span class="s4"># not properly tested</span>
<span class="s4"># cholesky, rsf2csf, lu_solve, solve, eig_banded, eigvals_banded, eigh, diagsvd</span>


<span class="s0">class </span><span class="s1">TestOverwrite:</span>
    <span class="s0">def </span><span class="s1">test_eig(self):</span>
        <span class="s1">assert_no_overwrite(eig</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>
        <span class="s1">assert_no_overwrite(eig</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_eigh(self):</span>
        <span class="s1">assert_no_overwrite(eigh</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>
        <span class="s1">assert_no_overwrite(eigh</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_eig_banded(self):</span>
        <span class="s1">assert_no_overwrite(eig_banded</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvals(self):</span>
        <span class="s1">assert_no_overwrite(eigvals</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvalsh(self):</span>
        <span class="s1">assert_no_overwrite(eigvalsh</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_eigvals_banded(self):</span>
        <span class="s1">assert_no_overwrite(eigvals_banded</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_hessenberg(self):</span>
        <span class="s1">assert_no_overwrite(hessenberg</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_lu_factor(self):</span>
        <span class="s1">assert_no_overwrite(lu_factor</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_lu_solve(self):</span>
        <span class="s1">x = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]])</span>
        <span class="s1">xlu = lu_factor(x)</span>
        <span class="s1">assert_no_overwrite(</span><span class="s0">lambda </span><span class="s1">b: lu_solve(xlu</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_lu(self):</span>
        <span class="s1">assert_no_overwrite(lu</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_qr(self):</span>
        <span class="s1">assert_no_overwrite(qr</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_rq(self):</span>
        <span class="s1">assert_no_overwrite(rq</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_schur(self):</span>
        <span class="s1">assert_no_overwrite(schur</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_schur_complex(self):</span>
        <span class="s1">assert_no_overwrite(</span><span class="s0">lambda </span><span class="s1">a: schur(a</span><span class="s0">, </span><span class="s5">'complex'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span><span class="s0">,</span>
                            <span class="s1">dtypes=[np.float32</span><span class="s0">, </span><span class="s1">np.float64])</span>

    <span class="s0">def </span><span class="s1">test_svd(self):</span>
        <span class="s1">assert_no_overwrite(svd</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>
        <span class="s1">assert_no_overwrite(</span><span class="s0">lambda </span><span class="s1">a: svd(a</span><span class="s0">, </span><span class="s1">lapack_driver=</span><span class="s5">'gesvd'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>

    <span class="s0">def </span><span class="s1">test_svdvals(self):</span>
        <span class="s1">assert_no_overwrite(svdvals</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)])</span>


<span class="s0">def </span><span class="s1">_check_orth(n</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">skip_big=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s1">X = np.ones((n</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=float).astype(dtype)</span>

    <span class="s1">eps = np.finfo(dtype).eps</span>
    <span class="s1">tol = </span><span class="s3">1000 </span><span class="s1">* eps</span>

    <span class="s1">Y = orth(X)</span>
    <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_allclose(Y</span><span class="s0">, </span><span class="s1">Y.mean()</span><span class="s0">, </span><span class="s1">atol=tol)</span>

    <span class="s1">Y = orth(X.T)</span>
    <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_allclose(Y</span><span class="s0">, </span><span class="s1">Y.mean()</span><span class="s0">, </span><span class="s1">atol=tol)</span>

    <span class="s0">if </span><span class="s1">n &gt; </span><span class="s3">5 </span><span class="s0">and not </span><span class="s1">skip_big:</span>
        <span class="s1">np.random.seed(</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">X = np.random.rand(n</span><span class="s0">, </span><span class="s3">5</span><span class="s1">) @ np.random.rand(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">X = X + </span><span class="s3">1e-4 </span><span class="s1">* np.random.rand(n</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) @ np.random.rand(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">X = X.astype(dtype)</span>

        <span class="s1">Y = orth(X</span><span class="s0">, </span><span class="s1">rcond=</span><span class="s3">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

        <span class="s1">Y = orth(X</span><span class="s0">, </span><span class="s1">rcond=</span><span class="s3">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s3">5 </span><span class="s1">+ </span><span class="s3">1</span><span class="s1">))</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s1">@pytest.mark.skipif(np.dtype(np.intp).itemsize &lt; </span><span class="s3">8</span><span class="s0">,</span>
                    <span class="s1">reason=</span><span class="s5">&quot;test only on 64-bit, else too slow&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_orth_memory_efficiency():</span>
    <span class="s4"># Pick n so that 16*n bytes is reasonable but 8*n*n bytes is unreasonable.</span>
    <span class="s4"># Keep in mind that @pytest.mark.slow tests are likely to be running</span>
    <span class="s4"># under configurations that support 4Gb+ memory for tests related to</span>
    <span class="s4"># 32 bit overflow.</span>
    <span class="s1">n = </span><span class="s3">10</span><span class="s1">*</span><span class="s3">1000</span><span class="s1">*</span><span class="s3">1000</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">_check_orth(n</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">skip_big=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">except </span><span class="s1">MemoryError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">raise </span><span class="s1">AssertionError(</span>
            <span class="s5">'memory error perhaps caused by orth regression'</span>
        <span class="s1">) </span><span class="s0">from </span><span class="s1">e</span>


<span class="s0">def </span><span class="s1">test_orth():</span>
    <span class="s1">dtypes = [np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.complex64</span><span class="s0">, </span><span class="s1">np.complex128]</span>
    <span class="s1">sizes = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">itertools.product(dtypes</span><span class="s0">, </span><span class="s1">sizes):</span>
        <span class="s1">_check_orth(n</span><span class="s0">, </span><span class="s1">dt)</span>


<span class="s0">def </span><span class="s1">test_null_space():</span>
    <span class="s1">np.random.seed(</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">dtypes = [np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.complex64</span><span class="s0">, </span><span class="s1">np.complex128]</span>
    <span class="s1">sizes = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">dt</span><span class="s0">, </span><span class="s1">n </span><span class="s0">in </span><span class="s1">itertools.product(dtypes</span><span class="s0">, </span><span class="s1">sizes):</span>
        <span class="s1">X = np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s1">n)</span><span class="s0">, </span><span class="s1">dtype=dt)</span>

        <span class="s1">eps = np.finfo(dt).eps</span>
        <span class="s1">tol = </span><span class="s3">1000 </span><span class="s1">* eps</span>

        <span class="s1">Y = null_space(X)</span>
        <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n-</span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">assert_allclose(X @ Y</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">atol=tol)</span>

        <span class="s1">Y = null_space(X.T)</span>
        <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
        <span class="s1">assert_allclose(X.T @ Y</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">atol=tol)</span>

        <span class="s1">X = np.random.randn(</span><span class="s3">1 </span><span class="s1">+ n//</span><span class="s3">2</span><span class="s0">, </span><span class="s1">n)</span>
        <span class="s1">Y = null_space(X)</span>
        <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n - </span><span class="s3">1 </span><span class="s1">- n//</span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">assert_allclose(X @ Y</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">atol=tol)</span>

        <span class="s0">if </span><span class="s1">n &gt; </span><span class="s3">5</span><span class="s1">:</span>
            <span class="s1">np.random.seed(</span><span class="s3">1</span><span class="s1">)</span>
            <span class="s1">X = np.random.rand(n</span><span class="s0">, </span><span class="s3">5</span><span class="s1">) @ np.random.rand(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">X = X + </span><span class="s3">1e-4 </span><span class="s1">* np.random.rand(n</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) @ np.random.rand(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">n)</span>
            <span class="s1">X = X.astype(dt)</span>

            <span class="s1">Y = null_space(X</span><span class="s0">, </span><span class="s1">rcond=</span><span class="s3">1e-3</span><span class="s1">)</span>
            <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n - </span><span class="s3">5</span><span class="s1">))</span>

            <span class="s1">Y = null_space(X</span><span class="s0">, </span><span class="s1">rcond=</span><span class="s3">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_equal(Y.shape</span><span class="s0">, </span><span class="s1">(n</span><span class="s0">, </span><span class="s1">n - </span><span class="s3">6</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_subspace_angles():</span>
    <span class="s1">H = hadamard(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">float)</span>
    <span class="s1">A = H[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span>
    <span class="s1">B = H[:</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:]</span>
    <span class="s1">assert_allclose(subspace_angles(A</span><span class="s0">, </span><span class="s1">B)</span><span class="s0">, </span><span class="s1">[np.pi / </span><span class="s3">2.</span><span class="s1">] * </span><span class="s3">3</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(subspace_angles(B</span><span class="s0">, </span><span class="s1">A)</span><span class="s0">, </span><span class="s1">[np.pi / </span><span class="s3">2.</span><span class="s1">] * </span><span class="s3">3</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-14</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">(A</span><span class="s0">, </span><span class="s1">B):</span>
        <span class="s1">assert_allclose(subspace_angles(x</span><span class="s0">, </span><span class="s1">x)</span><span class="s0">, </span><span class="s1">np.zeros(x.shape[</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s3">1e-14</span><span class="s1">)</span>
    <span class="s4"># From MATLAB function &quot;subspace&quot;, which effectively only returns the</span>
    <span class="s4"># last value that we calculate</span>
    <span class="s1">x = np.array(</span>
        <span class="s1">[[</span><span class="s3">0.537667139546100</span><span class="s0">, </span><span class="s3">0.318765239858981</span><span class="s0">, </span><span class="s3">3.578396939725760</span><span class="s0">, </span><span class="s3">0.725404224946106</span><span class="s1">]</span><span class="s0">,  </span><span class="s4"># noqa: E501</span>
         <span class="s1">[</span><span class="s3">1.833885014595086</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.307688296305273</span><span class="s0">, </span><span class="s3">2.769437029884877</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.063054873189656</span><span class="s1">]</span><span class="s0">,  </span><span class="s4"># noqa: E501</span>
         <span class="s1">[-</span><span class="s3">2.258846861003648</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.433592022305684</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1.349886940156521</span><span class="s0">, </span><span class="s3">0.714742903826096</span><span class="s1">]</span><span class="s0">,  </span><span class="s4"># noqa: E501</span>
         <span class="s1">[</span><span class="s3">0.862173320368121</span><span class="s0">, </span><span class="s3">0.342624466538650</span><span class="s0">, </span><span class="s3">3.034923466331855</span><span class="s0">, </span><span class="s1">-</span><span class="s3">0.204966058299775</span><span class="s1">]])  </span><span class="s4"># noqa: E501</span>
    <span class="s1">expected = </span><span class="s3">1.481454682101605</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:])[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">expected = </span><span class="s3">0.746361174247302</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">expected = </span><span class="s3">0.487163718534313</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]])</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s1">expected = </span><span class="s3">0.328950515907756</span>
    <span class="s1">assert_allclose(subspace_angles(x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x[:</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:])</span><span class="s0">, </span><span class="s1">[expected</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                    <span class="s1">atol=</span><span class="s3">1e-12</span><span class="s1">)</span>
    <span class="s4"># Degenerate conditions</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">subspace_angles</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x)</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">subspace_angles</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">subspace_angles</span><span class="s0">, </span><span class="s1">x[:-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">x)</span>

    <span class="s4"># Test branch if mask.any is True:</span>
    <span class="s1">A = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]])</span>
    <span class="s1">B = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
                  <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">expected = np.array([np.pi/</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_allclose(subspace_angles(A</span><span class="s0">, </span><span class="s1">B)</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s3">1e-12</span><span class="s1">)</span>

    <span class="s4"># Complex</span>
    <span class="s4"># second column in &quot;b&quot; does not affect result, just there so that</span>
    <span class="s4"># b can have more cols than a, and vice-versa (both conditional code paths)</span>
    <span class="s1">a = [[</span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">1j</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s1">]]</span>
    <span class="s1">b = [[</span><span class="s3">1 </span><span class="s1">- </span><span class="s3">1j</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s1">assert_allclose(subspace_angles(a</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(subspace_angles(b</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s3">0.</span><span class="s0">, </span><span class="s1">atol=</span><span class="s3">1e-14</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestCDF2RDF:</span>

    <span class="s0">def </span><span class="s1">matmul(self</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b):</span>
        <span class="s0">return </span><span class="s1">np.einsum(</span><span class="s5">'...ij,...jk-&gt;...ik'</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">b)</span>

    <span class="s0">def </span><span class="s1">assert_eig_valid(self</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">self.matmul(v</span><span class="s0">, </span><span class="s1">w)</span><span class="s0">,</span>
            <span class="s1">self.matmul(x</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_single_array0x0real(self):</span>
        <span class="s4"># eig doesn't support 0x0 in old versions of numpy</span>
        <span class="s1">X = np.empty((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.empty(</span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.empty((</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_single_array2x2_real(self):</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_single_array2x2_complex(self):</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_single_array3x3_real(self):</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_single_array3x3_complex(self):</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
        <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_random_1d_stacked_arrays(self):</span>
        <span class="s4"># cannot test M == 0 due to bug in old numpy</span>
        <span class="s0">for </span><span class="s1">M </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">):</span>
            <span class="s1">np.random.seed(</span><span class="s3">999999999</span><span class="s1">)</span>
            <span class="s1">X = np.random.rand(</span><span class="s3">100</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s1">M)</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
            <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
            <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_random_2d_stacked_arrays(self):</span>
        <span class="s4"># cannot test M == 0 due to bug in old numpy</span>
        <span class="s0">for </span><span class="s1">M </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">):</span>
            <span class="s1">X = np.random.rand(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s1">M</span><span class="s0">, </span><span class="s1">M)</span>
            <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
            <span class="s1">wr</span><span class="s0">, </span><span class="s1">vr = cdf2rdf(w</span><span class="s0">, </span><span class="s1">v)</span>
            <span class="s1">self.assert_eig_valid(wr</span><span class="s0">, </span><span class="s1">vr</span><span class="s0">, </span><span class="s1">X)</span>

    <span class="s0">def </span><span class="s1">test_low_dimensionality_error(self):</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.empty(())</span><span class="s0">, </span><span class="s1">np.array((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">test_not_square_error(self):</span>
        <span class="s4"># Check that passing a non-square array raises a ValueError.</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.arange(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">6</span><span class="s1">).reshape(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">test_swapped_v_w_error(self):</span>
        <span class="s4"># Check that exchanging places of w and v raises ValueError.</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">v</span><span class="s0">, </span><span class="s1">w)</span>

    <span class="s0">def </span><span class="s1">test_non_associated_error(self):</span>
        <span class="s4"># Check that passing non-associated eigenvectors raises a ValueError.</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.arange(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">16</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v)</span>

    <span class="s0">def </span><span class="s1">test_not_conjugate_pairs(self):</span>
        <span class="s4"># Check that passing non-conjugate pairs raises a ValueError.</span>
        <span class="s1">X = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">]])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v)</span>

        <span class="s4"># different arrays in the stack, so not conjugate</span>
        <span class="s1">X = np.array([</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">+</span><span class="s3">1j</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">-</span><span class="s3">1j</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s1">w</span><span class="s0">, </span><span class="s1">v = np.linalg.eig(X)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">cdf2rdf</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">v)</span>
</pre>
</body>
</html>