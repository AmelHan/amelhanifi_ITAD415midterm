<html>
<head>
<title>test_grouputils.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_grouputils.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">statsmodels.compat.pandas </span><span class="s0">import </span><span class="s1">assert_frame_equal</span><span class="s0">, </span><span class="s1">assert_series_equal</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_equal</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>

<span class="s0">from </span><span class="s1">statsmodels.tools.grouputils </span><span class="s0">import </span><span class="s1">(dummy_sparse</span><span class="s0">, </span><span class="s1">Grouping</span><span class="s0">, </span><span class="s1">Group</span><span class="s0">,</span>
                                          <span class="s1">combine_indices</span><span class="s0">, </span><span class="s1">group_sums)</span>
<span class="s0">from </span><span class="s1">statsmodels.datasets </span><span class="s0">import </span><span class="s1">grunfeld</span><span class="s0">, </span><span class="s1">anes96</span>


<span class="s0">class </span><span class="s1">CheckGrouping:</span>

    <span class="s1">@pytest.mark.smoke</span>
    <span class="s0">def </span><span class="s1">test_reindex(self):</span>
        <span class="s1">self.grouping.reindex(self.grouping.index)</span>

    <span class="s0">def </span><span class="s1">test_count_categories(self):</span>
        <span class="s1">self.grouping.count_categories(level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">np.testing.assert_equal(self.grouping.counts</span><span class="s0">, </span><span class="s1">self.expected_counts)</span>

    <span class="s0">def </span><span class="s1">test_sort(self):</span>
        <span class="s3"># data frame</span>
        <span class="s1">sorted_data</span><span class="s0">, </span><span class="s1">index = self.grouping.sort(self.data)</span>
        <span class="s1">expected_sorted_data = self.data.sort_index()</span>

        <span class="s1">assert_frame_equal(sorted_data</span><span class="s0">, </span><span class="s1">expected_sorted_data)</span>
        <span class="s1">np.testing.assert_(isinstance(sorted_data</span><span class="s0">, </span><span class="s1">pd.DataFrame))</span>
        <span class="s1">np.testing.assert_(</span><span class="s0">not </span><span class="s1">index.equals(self.grouping.index))</span>

        <span class="s3"># make sure it copied</span>
        <span class="s0">if </span><span class="s1">hasattr(sorted_data</span><span class="s0">, </span><span class="s4">'equals'</span><span class="s1">): </span><span class="s3"># newer pandas</span>
            <span class="s1">np.testing.assert_(</span><span class="s0">not </span><span class="s1">sorted_data.equals(self.data))</span>

        <span class="s3"># 2d arrays</span>
        <span class="s1">sorted_data</span><span class="s0">, </span><span class="s1">index = self.grouping.sort(self.data.values)</span>
        <span class="s1">np.testing.assert_array_equal(sorted_data</span><span class="s0">,</span>
                                      <span class="s1">expected_sorted_data.values)</span>
        <span class="s1">np.testing.assert_(isinstance(sorted_data</span><span class="s0">, </span><span class="s1">np.ndarray))</span>

        <span class="s3"># 1d series</span>
        <span class="s1">series = self.data[self.data.columns[</span><span class="s2">0</span><span class="s1">]]</span>
        <span class="s1">sorted_data</span><span class="s0">, </span><span class="s1">index = self.grouping.sort(series)</span>

        <span class="s1">expected_sorted_data = series.sort_index()</span>
        <span class="s1">assert_series_equal(sorted_data</span><span class="s0">, </span><span class="s1">expected_sorted_data)</span>
        <span class="s1">np.testing.assert_(isinstance(sorted_data</span><span class="s0">, </span><span class="s1">pd.Series))</span>
        <span class="s0">if </span><span class="s1">hasattr(sorted_data</span><span class="s0">, </span><span class="s4">'equals'</span><span class="s1">):</span>
            <span class="s1">np.testing.assert_(</span><span class="s0">not </span><span class="s1">sorted_data.equals(series))</span>

        <span class="s3"># 1d array</span>
        <span class="s1">array = series.values</span>
        <span class="s1">sorted_data</span><span class="s0">, </span><span class="s1">index = self.grouping.sort(array)</span>

        <span class="s1">expected_sorted_data = series.sort_index().values</span>
        <span class="s1">np.testing.assert_array_equal(sorted_data</span><span class="s0">, </span><span class="s1">expected_sorted_data)</span>
        <span class="s1">np.testing.assert_(isinstance(sorted_data</span><span class="s0">, </span><span class="s1">np.ndarray))</span>

    <span class="s0">def </span><span class="s1">test_transform_dataframe(self):</span>
        <span class="s1">names = self.data.index.names</span>
        <span class="s1">transformed_dataframe = self.grouping.transform_dataframe(</span>
                                            <span class="s1">self.data</span><span class="s0">,</span>
                                            <span class="s0">lambda </span><span class="s1">x : x.mean()</span><span class="s0">,</span>
                                            <span class="s1">level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">cols = [names[</span><span class="s2">0</span><span class="s1">]] + list(self.data.columns)</span>
        <span class="s1">df = self.data.reset_index()[cols].set_index(names[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">grouped = df[self.data.columns].groupby(level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">expected = grouped.apply(</span><span class="s0">lambda </span><span class="s1">x : x.mean())</span>
        <span class="s1">np.testing.assert_allclose(transformed_dataframe</span><span class="s0">,</span>
                                   <span class="s1">expected.values)</span>

        <span class="s0">if </span><span class="s1">len(names) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s1">transformed_dataframe = self.grouping.transform_dataframe(</span>
                                            <span class="s1">self.data</span><span class="s0">, lambda </span><span class="s1">x : x.mean()</span><span class="s0">,</span>
                                            <span class="s1">level=</span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">cols = [names[</span><span class="s2">1</span><span class="s1">]] + list(self.data.columns)</span>
            <span class="s1">df = self.data.reset_index()[cols].set_index(names[</span><span class="s2">1</span><span class="s1">])</span>
            <span class="s1">grouped = df.groupby(level=</span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">expected = grouped.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean())[self.data.columns]</span>
            <span class="s1">np.testing.assert_allclose(transformed_dataframe</span><span class="s0">,</span>
                                       <span class="s1">expected.values)</span>

    <span class="s0">def </span><span class="s1">test_transform_array(self):</span>
        <span class="s1">names = self.data.index.names</span>
        <span class="s1">transformed_array = self.grouping.transform_array(</span>
                                            <span class="s1">self.data.values</span><span class="s0">,</span>
                                            <span class="s0">lambda </span><span class="s1">x : x.mean()</span><span class="s0">,</span>
                                            <span class="s1">level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">cols = [names[</span><span class="s2">0</span><span class="s1">]] + list(self.data.columns)</span>
        <span class="s1">df = self.data.reset_index()[cols].set_index(names[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">grouped = df[self.data.columns].groupby(level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">expected = grouped.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean())</span>
        <span class="s1">np.testing.assert_allclose(transformed_array</span><span class="s0">,</span>
                                   <span class="s1">expected.values)</span>

        <span class="s0">if </span><span class="s1">len(names) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s1">transformed_array = self.grouping.transform_array(</span>
                                            <span class="s1">self.data.values</span><span class="s0">,</span>
                                            <span class="s0">lambda </span><span class="s1">x : x.mean()</span><span class="s0">, </span><span class="s1">level=</span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">cols = [names[</span><span class="s2">1</span><span class="s1">]] + list(self.data.columns)</span>
            <span class="s1">df = self.data.reset_index()[cols].set_index(names[</span><span class="s2">1</span><span class="s1">])</span>
            <span class="s1">grouped = df[self.data.columns].groupby(level=</span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">expected = grouped.apply(</span><span class="s0">lambda </span><span class="s1">x: x.mean())[self.data.columns]</span>
            <span class="s1">np.testing.assert_allclose(transformed_array</span><span class="s0">,</span>
                                       <span class="s1">expected.values)</span>


    <span class="s0">def </span><span class="s1">test_transform_slices(self):</span>
        <span class="s1">names = self.data.index.names</span>
        <span class="s1">transformed_slices = self.grouping.transform_slices(</span>
                                            <span class="s1">self.data.values</span><span class="s0">,</span>
                                            <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">idx : x.mean(</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># noqa</span>
                                            <span class="s1">level=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">expected = self.data.reset_index().groupby(</span>
            <span class="s1">names[</span><span class="s2">0</span><span class="s1">])[self.data.columns].mean()</span>
        <span class="s1">np.testing.assert_allclose(transformed_slices</span><span class="s0">, </span><span class="s1">expected.values</span><span class="s0">,</span>
                                   <span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-25</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">len(names) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s1">transformed_slices = self.grouping.transform_slices(</span>
                                            <span class="s1">self.data.values</span><span class="s0">,</span>
                                            <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">idx : x.mean(</span><span class="s2">0</span><span class="s1">)</span><span class="s0">,  </span><span class="s3"># noqa</span>
                                            <span class="s1">level=</span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">expected = self.data.reset_index().groupby(</span>
                <span class="s1">names[</span><span class="s2">1</span><span class="s1">])[self.data.columns].mean()</span>
            <span class="s1">np.testing.assert_allclose(transformed_slices</span><span class="s0">, </span><span class="s1">expected.values</span><span class="s0">,</span>
                                       <span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-25</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.smoke</span>
    <span class="s0">def </span><span class="s1">test_dummies_groups(self):</span>
        <span class="s3"># calls dummy_sparse under the hood</span>
        <span class="s1">self.grouping.dummies_groups()</span>

        <span class="s0">if </span><span class="s1">len(self.grouping.group_names) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s1">self.grouping.dummies_groups(level=</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_dummy_sparse(self):</span>
        <span class="s1">data = self.data</span>
        <span class="s1">self.grouping.dummy_sparse()</span>
        <span class="s1">values = data.index.get_level_values(</span><span class="s2">0</span><span class="s1">).values</span>
        <span class="s1">expected = pd.get_dummies(pd.Series(values</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                  <span class="s1">drop_first=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">np.testing.assert_equal(self.grouping._dummies.toarray()</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">if </span><span class="s1">len(self.grouping.group_names) &gt; </span><span class="s2">1</span><span class="s1">:</span>
            <span class="s1">self.grouping.dummy_sparse(level=</span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">values = data.index.get_level_values(</span><span class="s2">1</span><span class="s1">).values</span>
            <span class="s1">expected = pd.get_dummies(pd.Series(values</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s4">&quot;category&quot;</span><span class="s1">)</span><span class="s0">,</span>
                                      <span class="s1">drop_first=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">np.testing.assert_equal(self.grouping._dummies.toarray()</span><span class="s0">,</span>
                                    <span class="s1">expected)</span>


<span class="s0">class </span><span class="s1">TestMultiIndexGrouping(CheckGrouping):</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">grun_data = grunfeld.load_pandas().data</span>
        <span class="s1">multi_index_data = grun_data.set_index([</span><span class="s4">'firm'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>
        <span class="s1">multi_index_panel = multi_index_data.index</span>
        <span class="s1">cls.grouping = Grouping(multi_index_panel)</span>
        <span class="s1">cls.data = multi_index_data</span>

        <span class="s1">cls.expected_counts = [</span><span class="s2">20</span><span class="s1">] * </span><span class="s2">11</span>


<span class="s0">class </span><span class="s1">TestIndexGrouping(CheckGrouping):</span>
    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">grun_data = grunfeld.load_pandas().data</span>
        <span class="s1">index_data = grun_data.set_index([</span><span class="s4">'firm'</span><span class="s1">])</span>
        <span class="s1">index_group = index_data.index</span>
        <span class="s1">cls.grouping = Grouping(index_group)</span>
        <span class="s1">cls.data = index_data</span>

        <span class="s1">cls.expected_counts = [</span><span class="s2">20</span><span class="s1">] * </span><span class="s2">11</span>


<span class="s0">def </span><span class="s1">test_init_api():</span>
    <span class="s3"># make a multi-index panel</span>
    <span class="s1">grun_data = grunfeld.load_pandas().data</span>
    <span class="s1">multi_index_panel = grun_data.set_index([</span><span class="s4">'firm'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">]).index</span>
    <span class="s1">grouping = Grouping(multi_index_panel)</span>
    <span class="s3"># check group_names</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'firm'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>
    <span class="s3"># check shape</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">11</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>
    <span class="s3"># check index_int</span>
    <span class="s1">np.testing.assert_array_equal(grouping.labels</span><span class="s0">,</span>
      <span class="s1">[[ </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">,</span>
         <span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">,</span>
         <span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">,</span>
         <span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">,</span>
         <span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">,</span>
         <span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">,</span>
         <span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">7</span><span class="s0">,</span>
         <span class="s2">7</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">,</span>
         <span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">,</span>
         <span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">,</span>
         <span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">,</span>
         <span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">,</span>
         <span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
       <span class="s1">[ </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">,</span>
         <span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">,</span>
         <span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">,</span>
         <span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">,</span>
         <span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">,</span>
         <span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">,</span>
         <span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">,</span>
         <span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">,</span>
         <span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">,</span>
         <span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">,</span>
         <span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">,</span>
         <span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s0">,</span>
         <span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">11</span><span class="s0">, </span><span class="s2">12</span><span class="s0">, </span><span class="s2">13</span><span class="s0">, </span><span class="s2">14</span><span class="s0">, </span><span class="s2">15</span><span class="s0">, </span><span class="s2">16</span><span class="s0">, </span><span class="s2">17</span><span class="s0">, </span><span class="s2">18</span><span class="s0">, </span><span class="s2">19</span><span class="s1">]])</span>
    <span class="s1">grouping = Grouping(multi_index_panel</span><span class="s0">, </span><span class="s1">names=[</span><span class="s4">'firms'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'firms'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>

    <span class="s3"># make a multi-index grouping</span>
    <span class="s1">anes_data = anes96.load_pandas().data</span>
    <span class="s1">multi_index_groups = anes_data.set_index([</span><span class="s4">'educ'</span><span class="s0">, </span><span class="s4">'income'</span><span class="s0">,</span>
                                              <span class="s4">'TVnews'</span><span class="s1">]).index</span>
    <span class="s1">grouping = Grouping(multi_index_groups)</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">,</span>
                                  <span class="s1">[</span><span class="s4">'educ'</span><span class="s0">, </span><span class="s4">'income'</span><span class="s0">, </span><span class="s4">'TVnews'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">7</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">8</span><span class="s1">))</span>

    <span class="s3"># make a list multi-index panel</span>
    <span class="s1">list_panel = multi_index_panel.tolist()</span>
    <span class="s1">grouping = Grouping(list_panel</span><span class="s0">, </span><span class="s1">names=[</span><span class="s4">'firms'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'firms'</span><span class="s0">, </span><span class="s4">'year'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">11</span><span class="s0">, </span><span class="s2">20</span><span class="s1">))</span>

    <span class="s3"># make a list multi-index grouping</span>
    <span class="s1">list_groups = multi_index_groups.tolist()</span>
    <span class="s1">grouping = Grouping(list_groups</span><span class="s0">, </span><span class="s1">names=[</span><span class="s4">'educ'</span><span class="s0">, </span><span class="s4">'income'</span><span class="s0">, </span><span class="s4">'TVnews'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">,</span>
                                  <span class="s1">[</span><span class="s4">'educ'</span><span class="s0">, </span><span class="s4">'income'</span><span class="s0">, </span><span class="s4">'TVnews'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">7</span><span class="s0">, </span><span class="s2">24</span><span class="s0">, </span><span class="s2">8</span><span class="s1">))</span>


    <span class="s3"># single-variable index grouping</span>
    <span class="s1">index_group = multi_index_panel.get_level_values(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">grouping = Grouping(index_group)</span>
    <span class="s3"># the original multi_index_panel had it's name changed inplace above</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'firms'</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">220</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s3"># single variable list grouping</span>
    <span class="s1">list_group = multi_index_panel.get_level_values(</span><span class="s2">0</span><span class="s1">).tolist()</span>
    <span class="s1">grouping = Grouping(list_group)</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;group0&quot;</span><span class="s1">])</span>
    <span class="s1">np.testing.assert_array_equal(grouping.index_shape</span><span class="s0">, </span><span class="s2">11</span><span class="s1">*</span><span class="s2">20</span><span class="s1">)</span>

    <span class="s3"># test generic group names</span>
    <span class="s1">grouping = Grouping(list_groups)</span>
    <span class="s1">np.testing.assert_array_equal(grouping.group_names</span><span class="s0">,</span>
                                  <span class="s1">[</span><span class="s4">'group0'</span><span class="s0">, </span><span class="s4">'group1'</span><span class="s0">, </span><span class="s4">'group2'</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_combine_indices():</span>
    <span class="s3"># Moved from grouputils __main__ section</span>
    <span class="s1">np.random.seed(</span><span class="s2">985367</span><span class="s1">)</span>
    <span class="s1">groups = np.random.randint(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">size=(</span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
    <span class="s1">uv</span><span class="s0">, </span><span class="s1">ux</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">label = combine_indices(groups</span><span class="s0">, </span><span class="s1">return_labels=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">uv</span><span class="s0">, </span><span class="s1">ux</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">label = combine_indices(groups</span><span class="s0">, </span><span class="s1">prefix=</span><span class="s4">'g1,g2='</span><span class="s0">, </span><span class="s1">sep=</span><span class="s4">','</span><span class="s0">,</span>
                                       <span class="s1">return_labels=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">group0 = np.array([</span><span class="s4">'sector0'</span><span class="s0">, </span><span class="s4">'sector1'</span><span class="s1">])[groups[:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]]</span>
    <span class="s1">group1 = np.array([</span><span class="s4">'region0'</span><span class="s0">, </span><span class="s4">'region1'</span><span class="s1">])[groups[:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span>
    <span class="s1">uv</span><span class="s0">, </span><span class="s1">ux</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">label = combine_indices((group0</span><span class="s0">, </span><span class="s1">group1)</span><span class="s0">,</span>
                                       <span class="s1">prefix=</span><span class="s4">'sector,region='</span><span class="s0">,</span>
                                       <span class="s1">sep=</span><span class="s4">','</span><span class="s0">,</span>
                                       <span class="s1">return_labels=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">uv</span><span class="s0">, </span><span class="s1">ux</span><span class="s0">, </span><span class="s1">u</span><span class="s0">, </span><span class="s1">label = combine_indices((group0</span><span class="s0">, </span><span class="s1">group1)</span><span class="s0">, </span><span class="s1">prefix=</span><span class="s4">''</span><span class="s0">, </span><span class="s1">sep=</span><span class="s4">'.'</span><span class="s0">,</span>
                                       <span class="s1">return_labels=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">group_joint = np.array(label)[uv]</span>
    <span class="s1">group_joint_expected = np.array([</span><span class="s4">'sector1.region0'</span><span class="s0">, </span><span class="s4">'sector0.region1'</span><span class="s0">,</span>
                                     <span class="s4">'sector0.region0'</span><span class="s0">, </span><span class="s4">'sector0.region1'</span><span class="s0">,</span>
                                     <span class="s4">'sector1.region1'</span><span class="s0">, </span><span class="s4">'sector0.region0'</span><span class="s0">,</span>
                                     <span class="s4">'sector1.region0'</span><span class="s0">, </span><span class="s4">'sector1.region0'</span><span class="s0">,</span>
                                     <span class="s4">'sector0.region1'</span><span class="s0">, </span><span class="s4">'sector0.region0'</span><span class="s1">]</span><span class="s0">,</span>
                                    <span class="s1">dtype=</span><span class="s4">'|U15'</span><span class="s1">)</span>
    <span class="s1">assert_equal(group_joint</span><span class="s0">, </span><span class="s1">group_joint_expected)</span>


<span class="s1">@pytest.mark.smoke</span>
<span class="s0">def </span><span class="s1">test_group_sums():</span>
    <span class="s3"># Moved from grouputils __main__ section</span>
    <span class="s1">g = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

    <span class="s1">group_sums(np.arange(len(g)*</span><span class="s2">3</span><span class="s1">*</span><span class="s2">2</span><span class="s1">).reshape(len(g)</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">g</span><span class="s0">,</span>
               <span class="s1">use_bincount=</span><span class="s0">False</span><span class="s1">).T</span>
    <span class="s1">group_sums(np.arange(len(g)*</span><span class="s2">3</span><span class="s1">*</span><span class="s2">2</span><span class="s1">).reshape(len(g)</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">g)</span>
    <span class="s1">group_sums(np.arange(len(g)*</span><span class="s2">3</span><span class="s1">*</span><span class="s2">2</span><span class="s1">).reshape(len(g)</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">g)</span>


<span class="s1">@pytest.mark.smoke</span>
<span class="s0">def </span><span class="s1">test_group_class():</span>
    <span class="s3"># Moved from grouputils __main__ section</span>
    <span class="s1">g = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>

    <span class="s1">x = np.arange(len(g)*</span><span class="s2">3</span><span class="s1">).reshape(len(g)</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">order=</span><span class="s4">'F'</span><span class="s1">)</span>
    <span class="s1">mygroup = Group(g)</span>

    <span class="s1">mygroup.group_int</span>
    <span class="s1">mygroup.group_sums(x)</span>
    <span class="s1">mygroup.labels()</span>


<span class="s0">def </span><span class="s1">test_dummy_sparse():</span>
    <span class="s3"># See GH#5687</span>

    <span class="s1">g = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">indi = dummy_sparse(g)</span>
    <span class="s0">assert </span><span class="s1">isinstance(indi</span><span class="s0">, </span><span class="s1">sparse.csr_matrix)</span>
    <span class="s1">result = indi.todense()</span>
    <span class="s1">expected = np.matrix([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
    <span class="s1">assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


    <span class="s3"># current behavior with missing groups</span>
    <span class="s1">g = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">indi = dummy_sparse(g)</span>
    <span class="s1">result = indi.todense()</span>
    <span class="s1">expected = np.matrix([[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                         <span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">dtype=np.int8)</span>
    <span class="s1">assert_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>
</pre>
</body>
</html>