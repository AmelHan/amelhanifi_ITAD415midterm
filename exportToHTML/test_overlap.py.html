<html>
<head>
<title>test_overlap.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_overlap.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_array_almost_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span>

<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.lib.stride_tricks </span><span class="s0">import </span><span class="s1">sliding_window_view</span>
<span class="s0">from </span><span class="s1">dask.array.overlap </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">boundaries</span><span class="s0">,</span>
    <span class="s1">constant</span><span class="s0">,</span>
    <span class="s1">ensure_minimum_chunksize</span><span class="s0">,</span>
    <span class="s1">nearest</span><span class="s0">,</span>
    <span class="s1">overlap</span><span class="s0">,</span>
    <span class="s1">overlap_internal</span><span class="s0">,</span>
    <span class="s1">periodic</span><span class="s0">,</span>
    <span class="s1">reflect</span><span class="s0">,</span>
    <span class="s1">trim_internal</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">same_keys</span>


<span class="s0">def </span><span class="s1">test_overlap_internal():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">g = overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">result = g.compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">g.chunks == ((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">48</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">55</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">56</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">61</span><span class="s0">, </span><span class="s3">62</span><span class="s0">, </span><span class="s3">63</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span><span class="s0">, </span><span class="s1">g)</span>


<span class="s0">def </span><span class="s1">test_overlap_internal_asymmetric():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">result = overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)})</span>
    <span class="s0">assert </span><span class="s1">result.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">48</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">55</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">56</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">61</span><span class="s0">, </span><span class="s3">62</span><span class="s0">, </span><span class="s3">63</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)})</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_overlap_internal_asymmetric_small():</span>
    <span class="s1">x = np.arange(</span><span class="s3">32</span><span class="s1">).reshape((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">16</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">result = overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)})</span>
    <span class="s0">assert </span><span class="s1">result.chunks == ((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s3">16</span><span class="s0">,</span>
                <span class="s3">17</span><span class="s0">,</span>
                <span class="s3">18</span><span class="s0">,</span>
                <span class="s3">19</span><span class="s0">,</span>
                <span class="s3">20</span><span class="s0">,</span>
                <span class="s3">19</span><span class="s0">,</span>
                <span class="s3">20</span><span class="s0">,</span>
                <span class="s3">21</span><span class="s0">,</span>
                <span class="s3">22</span><span class="s0">,</span>
                <span class="s3">23</span><span class="s0">,</span>
                <span class="s3">24</span><span class="s0">,</span>
                <span class="s3">23</span><span class="s0">,</span>
                <span class="s3">24</span><span class="s0">,</span>
                <span class="s3">25</span><span class="s0">,</span>
                <span class="s3">26</span><span class="s0">,</span>
                <span class="s3">27</span><span class="s0">,</span>
                <span class="s3">28</span><span class="s0">,</span>
                <span class="s3">27</span><span class="s0">,</span>
                <span class="s3">28</span><span class="s0">,</span>
                <span class="s3">29</span><span class="s0">,</span>
                <span class="s3">30</span><span class="s0">,</span>
                <span class="s3">31</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(overlap_internal(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)})</span><span class="s0">, </span><span class="s1">result)</span>


<span class="s0">def </span><span class="s1">test_trim_internal():</span>
    <span class="s1">d = da.ones((</span><span class="s3">40</span><span class="s0">, </span><span class="s3">60</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">e = trim_internal(d</span><span class="s0">, </span><span class="s1">axes={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">e.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_periodic():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">e = periodic(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.shape[</span><span class="s3">0</span><span class="s1">] == d.shape[</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">4</span>
    <span class="s0">assert </span><span class="s1">e.shape[</span><span class="s3">1</span><span class="s1">] == d.shape[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s1">assert_eq(e[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">d[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:])</span>
    <span class="s1">assert_eq(e[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">d[-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:])</span>


<span class="s0">def </span><span class="s1">test_reflect():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">e = reflect(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">expected = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">])</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">e = reflect(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">expected = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_nearest():</span>
    <span class="s1">x = np.arange(</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">e = nearest(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">expected = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">e = nearest(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">expected = np.array([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_constant():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">e = constant(d</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">value=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">e.shape[</span><span class="s3">0</span><span class="s1">] == d.shape[</span><span class="s3">0</span><span class="s1">] + </span><span class="s3">4</span>
    <span class="s0">assert </span><span class="s1">e.shape[</span><span class="s3">1</span><span class="s1">] == d.shape[</span><span class="s3">1</span><span class="s1">]</span>

    <span class="s1">assert_eq(e[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=x.dtype) * </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">assert_eq(e[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">8</span><span class="s0">, </span><span class="s1">dtype=x.dtype) * </span><span class="s3">10</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_boundaries():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s1">e = boundaries(d</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;periodic&quot;</span><span class="s1">})</span>

    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">15</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">23</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">16</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">31</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">24</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">39</span><span class="s0">, </span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s0">, </span><span class="s3">32</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">47</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">40</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">55</span><span class="s0">, </span><span class="s3">48</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">48</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">63</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">61</span><span class="s0">, </span><span class="s3">62</span><span class="s0">, </span><span class="s3">63</span><span class="s0">, </span><span class="s3">56</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(e</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_overlap():</span>
    <span class="s1">x = np.arange(</span><span class="s3">64</span><span class="s1">).reshape((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">g = overlap(d</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">g.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">48</span><span class="s0">, </span><span class="s3">48</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">55</span><span class="s0">, </span><span class="s3">55</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">56</span><span class="s0">, </span><span class="s3">56</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">61</span><span class="s0">, </span><span class="s3">62</span><span class="s0">, </span><span class="s3">63</span><span class="s0">, </span><span class="s3">63</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(g</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(g</span><span class="s0">, </span><span class="s1">overlap(d</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s1">}))</span>

    <span class="s1">u_depth = np.uint16([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">u_depth = {k: v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate(u_depth)}</span>
    <span class="s1">g = overlap(d</span><span class="s0">, </span><span class="s1">depth=u_depth</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">g.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_eq(g</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">same_keys(g</span><span class="s0">, </span><span class="s1">overlap(d</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s1">}))</span>

    <span class="s1">g = overlap(d</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s1">})</span>
    <span class="s1">expected = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">19</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">23</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">24</span><span class="s0">, </span><span class="s3">25</span><span class="s0">, </span><span class="s3">26</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">28</span><span class="s0">, </span><span class="s3">29</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">31</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">32</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">34</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">35</span><span class="s0">, </span><span class="s3">36</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">39</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">40</span><span class="s0">, </span><span class="s3">41</span><span class="s0">, </span><span class="s3">42</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">43</span><span class="s0">, </span><span class="s3">44</span><span class="s0">, </span><span class="s3">45</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">47</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">48</span><span class="s0">, </span><span class="s3">49</span><span class="s0">, </span><span class="s3">50</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">51</span><span class="s0">, </span><span class="s3">52</span><span class="s0">, </span><span class="s3">53</span><span class="s0">, </span><span class="s3">54</span><span class="s0">, </span><span class="s3">55</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">56</span><span class="s0">, </span><span class="s3">57</span><span class="s0">, </span><span class="s3">58</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">59</span><span class="s0">, </span><span class="s3">60</span><span class="s0">, </span><span class="s3">61</span><span class="s0">, </span><span class="s3">62</span><span class="s0">, </span><span class="s3">63</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(g</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">g.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">u_depth = np.uint16([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">u_depth = {k: v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">enumerate(u_depth)}</span>
    <span class="s1">g = overlap(d</span><span class="s0">, </span><span class="s1">depth=u_depth</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s1">})</span>
    <span class="s1">assert_eq(g</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">assert </span><span class="s1">g.chunks == ((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_overlap_allow_rechunk_kwarg():</span>
    <span class="s4"># The smallest array chunk is too small to fit overlap depth</span>
    <span class="s1">arr = da.arange(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">da.overlap.overlap(arr</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">allow_rechunk=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">arr.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">allow_rechunk=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">da.overlap.overlap(arr</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">allow_rechunk=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">arr.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">allow_rechunk=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s4"># No rechunking required</span>
    <span class="s1">arr = da.arange(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">da.overlap.overlap(arr</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">allow_rechunk=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_asymmetric_overlap_boundary_exception():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
        <span class="s1">x.map_overlap(</span>
            <span class="s0">lambda </span><span class="s1">x: x + len(x)</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: (</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_overlap():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x + len(x)</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">5 </span><span class="s1">+ </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">x: x + len(x)</span><span class="s0">, </span><span class="s1">depth=np.int64(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all([(type(s) </span><span class="s0">is </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">y.shape])</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">5 </span><span class="s1">+ </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">z = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">1</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks[</span><span class="s3">0</span><span class="s1">] == x.chunks[</span><span class="s3">0</span><span class="s1">]  </span><span class="s4"># don't rechunk the first dimension</span>

    <span class="s1">x = np.arange(</span><span class="s3">16</span><span class="s1">).reshape((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">exp1 = d.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">x: x + x.size</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">dtype=d.dtype</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span>
    <span class="s1">)</span>
    <span class="s1">exp2 = d.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">x: x + x.size</span><span class="s0">,</span>
        <span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">dtype=d.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">exp3 = d.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">x: x + x.size</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=d.dtype</span>
    <span class="s1">)</span>
    <span class="s1">exp4 = d.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">x: x + x.size</span><span class="s0">,</span>
        <span class="s1">depth={</span><span class="s3">1</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)}</span><span class="s0">,</span>
        <span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">dtype=d.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(exp1</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">16</span><span class="s1">)</span>
    <span class="s1">assert_eq(exp2</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">12</span><span class="s1">)</span>
    <span class="s1">assert_eq(exp3</span><span class="s0">, </span><span class="s1">x + </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">exp4</span><span class="s0">,</span>
        <span class="s1">np.block(</span>
            <span class="s1">[[x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] + </span><span class="s3">4</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s1">] + </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[x[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">:</span><span class="s3">2</span><span class="s1">] + </span><span class="s3">4</span><span class="s0">, </span><span class="s1">x[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:</span><span class="s3">4</span><span class="s1">] + </span><span class="s3">6</span><span class="s1">]]</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_escapes_to_map_blocks_when_depth_is_zero():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x + </span><span class="s3">1</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(y.dask) == </span><span class="s3">2 </span><span class="s1">* x.numblocks[</span><span class="s3">0</span><span class="s1">]  </span><span class="s4"># depth=0 --&gt; map_blocks</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">1</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;boundary&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s2">&quot;periodic&quot;</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s2">&quot;none&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_map_overlap_no_depth(boundary):</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">i: i</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">boundary=boundary</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">x)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray():</span>
    <span class="s4"># Same ndim, same numblocks, same chunks</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">z = da.map_overlap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.arange(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s4"># Same ndim, same numblocks, different chunks</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">z = da.map_overlap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.arange(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s4"># Same ndim, different numblocks, different chunks</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">z = da.map_overlap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.arange(</span><span class="s3">10</span><span class="s1">))</span>

    <span class="s4"># Different ndim, different numblocks, different chunks</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.arange(</span><span class="s3">10</span><span class="s1">).reshape(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">).rechunk((</span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>
    <span class="s1">z = da.map_overlap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">z.shape == (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s3">2 </span><span class="s1">* np.arange(</span><span class="s3">10</span><span class="s1">)[np.newaxis])</span>

    <span class="s4"># Note: checks on arange equality in all of the above help ensure that</span>
    <span class="s4"># trimming is applied appropriately to result chunks (i.e. results</span>
    <span class="s4"># are not somehow shifted)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray_defaults():</span>
    <span class="s4"># Check that by default, chunk alignment and arrays of varying dimensionality</span>
    <span class="s4"># are supported by with no effect on result shape</span>
    <span class="s4"># (i.e. defaults are pass-through to map_blocks)</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">y = da.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">z = da.map_overlap(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s4"># func should be called twice and get (5,) and (1, 5) arrays of ones each time</span>
    <span class="s1">assert_eq(z.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>
    <span class="s1">assert_eq(z.sum()</span><span class="s0">, </span><span class="s3">20.0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray_different_depths():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int&quot;</span><span class="s1">)</span>
    <span class="s1">y = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">run(depth):</span>
        <span class="s0">return </span><span class="s1">da.map_overlap(</span>
            <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x.sum() + y.sum()</span><span class="s0">,</span>
            <span class="s1">x</span><span class="s0">,</span>
            <span class="s1">y</span><span class="s0">,</span>
            <span class="s1">depth=depth</span><span class="s0">,</span>
            <span class="s1">chunks=(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">trim=</span><span class="s0">False,</span>
            <span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s0">,</span>
        <span class="s1">).compute()</span>

    <span class="s4"># Check that the number of elements added</span>
    <span class="s4"># to arrays in overlap works as expected</span>
    <span class="s4"># when depths differ for each array</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]) == </span><span class="s3">10</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]) == </span><span class="s3">12</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]) == </span><span class="s3">14</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]) == </span><span class="s3">16</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]) == </span><span class="s3">20</span>
    <span class="s0">assert </span><span class="s1">run([</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]) == </span><span class="s3">30</span>

    <span class="s4"># Ensure that depth &gt; chunk size results in error</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">run([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">6</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray_uneven_numblocks_exception():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s4"># Fail with chunk alignment explicitly disabled</span>
        <span class="s1">da.map_overlap(</span>
            <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">align_arrays=</span><span class="s0">False, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span>
        <span class="s1">).compute()</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray_block_broadcast():</span>
    <span class="s0">def </span><span class="s1">func(x</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s4"># Return result with expected padding</span>
        <span class="s1">z = x.size + y.size</span>
        <span class="s0">return </span><span class="s1">np.ones((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)) * z</span>

    <span class="s4"># Chunks in trailing dimension will be unified to two chunks of size 6</span>
    <span class="s4"># and block broadcast will allow chunks from x to repeat</span>
    <span class="s1">x = da.ones((</span><span class="s3">12</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">12</span><span class="s1">)  </span><span class="s4"># numblocks = (1,) -&gt; (2, 2) after broadcast</span>
    <span class="s1">y = da.ones((</span><span class="s3">16</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))  </span><span class="s4"># numblocks = (2, 2)</span>
    <span class="s1">z = da.map_overlap(</span>
        <span class="s1">func</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">trim=</span><span class="s0">True, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">z)</span>
    <span class="s0">assert </span><span class="s1">z.shape == (</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s4"># func call will receive (8,) and (10, 8) arrays for each of 4 blocks</span>
    <span class="s1">assert_eq(z.sum()</span><span class="s0">, </span><span class="s3">4.0 </span><span class="s1">* (</span><span class="s3">10 </span><span class="s1">* </span><span class="s3">8 </span><span class="s1">+ </span><span class="s3">8</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_map_overlap_multiarray_variadic():</span>
    <span class="s4"># Test overlapping row slices from 3D arrays</span>
    <span class="s1">xs = [</span>
        <span class="s4"># Dim 0 will unify to chunks of size 4 for all:</span>
        <span class="s1">da.ones((</span><span class="s3">12</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">12</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">da.ones((</span><span class="s3">12</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">da.ones((</span><span class="s3">12</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s0">def </span><span class="s1">func(*args):</span>
        <span class="s0">return </span><span class="s1">np.array([sum(x.size </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">args)])</span>

    <span class="s1">x = da.map_overlap(</span>
        <span class="s1">func</span><span class="s0">,</span>
        <span class="s1">*xs</span><span class="s0">,</span>
        <span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">depth=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">trim=</span><span class="s0">False,</span>
        <span class="s1">drop_axis=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s4"># Each func call should get 4 rows from each array padded by 1 in each dimension</span>
    <span class="s1">size_per_slice = sum(np.pad(x[:</span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;constant&quot;</span><span class="s1">).size </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">xs)</span>
    <span class="s0">assert </span><span class="s1">x.shape == (</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(x.compute() == size_per_slice)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;drop_axis&quot;</span><span class="s0">,</span>
    <span class="s1">(</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">-</span><span class="s3">2</span><span class="s0">,</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_map_overlap_trim_using_drop_axis_and_different_depths(drop_axis):</span>
    <span class="s1">x = da.random.default_rng().standard_normal((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">_mean(x):</span>
        <span class="s0">return </span><span class="s1">x.mean(axis=drop_axis)</span>

    <span class="s1">expected = _mean(x)</span>

    <span class="s4"># unique boundary and depth value per axis</span>
    <span class="s1">boundary = (</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
    <span class="s1">depth = (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s4"># to match expected result, dropped axes must have depth 0</span>
    <span class="s1">_drop_axis = (drop_axis</span><span class="s0">,</span><span class="s1">) </span><span class="s0">if </span><span class="s1">np.isscalar(drop_axis) </span><span class="s0">else </span><span class="s1">drop_axis</span>
    <span class="s1">_drop_axis = [d % x.ndim </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">_drop_axis]</span>
    <span class="s1">depth = tuple(</span><span class="s3">0 </span><span class="s0">if </span><span class="s1">i </span><span class="s0">in </span><span class="s1">_drop_axis </span><span class="s0">else </span><span class="s1">d </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">d </span><span class="s0">in </span><span class="s1">enumerate(depth))</span>

    <span class="s1">y = da.map_overlap(</span>
        <span class="s1">_mean</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=boundary</span><span class="s0">, </span><span class="s1">drop_axis=drop_axis</span><span class="s0">, </span><span class="s1">dtype=float</span>
    <span class="s1">).compute()</span>
    <span class="s1">assert_array_almost_equal(expected</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_assumes_shape_matches_first_array_if_trim_is_false():</span>
    <span class="s4"># https://github.com/dask/dask/issues/6681</span>
    <span class="s1">x1 = da.ones((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">x2 = x1.rechunk(</span><span class="s3">10</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">oversum(x):</span>
        <span class="s0">return </span><span class="s1">x[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">2</span><span class="s1">]</span>

    <span class="s1">z1 = da.map_overlap(oversum</span><span class="s0">, </span><span class="s1">x1</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">trim=</span><span class="s0">False, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z1.shape == (</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s1">z2 = da.map_overlap(oversum</span><span class="s0">, </span><span class="s1">x2</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">trim=</span><span class="s0">False, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z2.shape == (</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_deprecated_signature():</span>
    <span class="s0">def </span><span class="s1">func(x):</span>
        <span class="s0">return </span><span class="s1">np.array(x.sum())</span>

    <span class="s1">x = da.ones(</span><span class="s3">3</span><span class="s1">)</span>

    <span class="s4"># Old positional signature: func, depth, boundary, trim</span>
    <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">y = da.map_overlap(x</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.compute() == </span><span class="s3">3</span>
        <span class="s0">assert </span><span class="s1">y.shape == (</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">y = da.map_overlap(x</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.compute() == </span><span class="s3">5</span>
        <span class="s0">assert </span><span class="s1">y.shape == (</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning):</span>
        <span class="s1">y = da.map_overlap(x</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">y.compute() == </span><span class="s3">5</span>
        <span class="s0">assert </span><span class="s1">y.shape == (</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_nearest_overlap():</span>
    <span class="s1">a = np.arange(</span><span class="s3">144</span><span class="s1">).reshape(</span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">).astype(float)</span>

    <span class="s1">darr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">garr = overlap(darr</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s2">&quot;nearest&quot;</span><span class="s1">})</span>
    <span class="s1">tarr = trim_internal(garr</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(tarr</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;depth&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">,  </span><span class="s4"># depth all zeros</span>
        <span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">,  </span><span class="s4"># depth with some zeros</span>
        <span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">,  </span><span class="s4"># depth equal to boundary length</span>
        <span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">8</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">,  </span><span class="s4"># depth greater than boundary length</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_different_depths_and_boundary_combinations(depth):</span>
    <span class="s1">expected = np.arange(</span><span class="s3">100</span><span class="s1">).reshape(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span>
    <span class="s1">darr = da.from_array(expected</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">reflected = overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s1">)</span>
    <span class="s1">nearest = overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
    <span class="s1">periodic = overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;periodic&quot;</span><span class="s1">)</span>
    <span class="s1">constant = overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">42</span><span class="s1">)</span>

    <span class="s1">result = trim_internal(reflected</span><span class="s0">, </span><span class="s1">depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = trim_internal(nearest</span><span class="s0">, </span><span class="s1">depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;nearest&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = trim_internal(periodic</span><span class="s0">, </span><span class="s1">depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;periodic&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s1">result = trim_internal(constant</span><span class="s0">, </span><span class="s1">depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_one_chunk_along_axis():</span>
    <span class="s1">a = np.arange(</span><span class="s3">2 </span><span class="s1">* </span><span class="s3">9</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span>
    <span class="s1">darr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s1">g = overlap(darr</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">a.shape == g.shape</span>


<span class="s0">def </span><span class="s1">test_constant_boundaries():</span>
    <span class="s1">a = np.arange(</span><span class="s3">1 </span><span class="s1">* </span><span class="s3">9</span><span class="s1">).reshape(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span>
    <span class="s1">darr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)))</span>
    <span class="s1">b = boundaries(darr</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">0</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">b.chunks == darr.chunks</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;chunks&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">((</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_depth_greater_than_smallest_chunk_combines_chunks(chunks):</span>
    <span class="s1">a = np.arange(</span><span class="s3">144</span><span class="s1">).reshape(</span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span>
    <span class="s1">darr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>

    <span class="s1">depth = {</span><span class="s3">0</span><span class="s1">: </span><span class="s3">4</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span>
    <span class="s1">output = overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">all(c &gt;= depth[</span><span class="s3">0</span><span class="s1">] * </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">output.chunks[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">all(c &gt;= depth[</span><span class="s3">1</span><span class="s1">] * </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">output.chunks[</span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_depth_greater_than_dim():</span>
    <span class="s1">a = np.arange(</span><span class="s3">144</span><span class="s1">).reshape(</span><span class="s3">12</span><span class="s0">, </span><span class="s3">12</span><span class="s1">)</span>
    <span class="s1">darr = da.from_array(a</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">depth = {</span><span class="s3">0</span><span class="s1">: </span><span class="s3">13</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">4</span><span class="s1">}</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;The overlapping depth&quot;</span><span class="s1">):</span>
        <span class="s1">overlap(darr</span><span class="s0">, </span><span class="s1">depth=depth</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">1</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_none_boundaries():</span>
    <span class="s1">x = da.from_array(np.arange(</span><span class="s3">16</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">exp = boundaries(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;none&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">33</span><span class="s1">})</span>
    <span class="s1">res = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">33</span><span class="s0">, </span><span class="s3">33</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(exp</span><span class="s0">, </span><span class="s1">res)</span>


<span class="s0">def </span><span class="s1">test_overlap_small():</span>
    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(y.dask) &lt; </span><span class="s3">200</span>

    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(y.dask) &lt; </span><span class="s3">100</span>


<span class="s0">def </span><span class="s1">test_no_shared_keys_with_different_depths():</span>
    <span class="s1">rng = da.random.default_rng(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">a = rng.random((</span><span class="s3">9</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">check(x):</span>
        <span class="s0">assert </span><span class="s1">x.shape == (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s1">r = [</span>
        <span class="s1">a.map_overlap(</span>
            <span class="s0">lambda </span><span class="s1">a: a + </span><span class="s3">1</span><span class="s0">,</span>
            <span class="s1">dtype=a.dtype</span><span class="s0">,</span>
            <span class="s1">depth={j: int(i == j) </span><span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(a.ndim)}</span><span class="s0">,</span>
            <span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s0">,</span>
        <span class="s1">).map_blocks(check</span><span class="s0">, </span><span class="s1">dtype=a.dtype)</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(a.ndim)</span>
    <span class="s1">]</span>

    <span class="s0">assert </span><span class="s1">set(r[</span><span class="s3">0</span><span class="s1">].dask) &amp; set(r[</span><span class="s3">1</span><span class="s1">].dask) == set(a.dask)</span>
    <span class="s1">da.compute(*r</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_overlap_few_dimensions_small():</span>
    <span class="s1">x = da.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>

    <span class="s1">a = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">a)</span>
    <span class="s0">assert </span><span class="s1">any(isinstance(k[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">a.dask)</span>
    <span class="s0">assert </span><span class="s1">all(isinstance(k[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">a.dask)</span>

    <span class="s1">b = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s0">assert </span><span class="s1">all(isinstance(k[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">int) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">b.dask)</span>
    <span class="s0">assert </span><span class="s1">any(isinstance(k[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">b.dask)</span>

    <span class="s1">c = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">c)</span>
    <span class="s0">assert </span><span class="s1">any(isinstance(k[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">c.dask)</span>
    <span class="s0">assert </span><span class="s1">any(isinstance(k[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">float) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">c.dask)</span>


<span class="s0">def </span><span class="s1">test_overlap_few_dimensions():</span>
    <span class="s1">x = da.ones((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">100</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>

    <span class="s1">a = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">b = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>
    <span class="s1">c = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s2">&quot;none&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">len(a.dask) == len(b.dask)</span>
    <span class="s0">assert </span><span class="s1">len(a.dask) &lt; len(c.dask)</span>

    <span class="s0">assert </span><span class="s1">len(c.dask) &lt; </span><span class="s3">10 </span><span class="s1">* len(a.dask)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;boundary&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s2">&quot;periodic&quot;</span><span class="s0">, </span><span class="s2">&quot;nearest&quot;</span><span class="s0">, </span><span class="s2">&quot;none&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_trim_boundary(boundary):</span>
    <span class="s1">x = da.from_array(np.arange(</span><span class="s3">24</span><span class="s1">).reshape(</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">x_overlaped = da.overlap.overlap(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: boundary})</span>
    <span class="s1">x_trimmed = da.overlap.trim_overlap(</span>
        <span class="s1">x_overlaped</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">0</span><span class="s1">: </span><span class="s2">&quot;reflect&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: boundary}</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.all(x == x_trimmed)</span>

    <span class="s1">x_overlaped = da.overlap.overlap(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">1</span><span class="s1">: boundary})</span>
    <span class="s1">x_trimmed = da.overlap.trim_overlap(x_overlaped</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary={</span><span class="s3">1</span><span class="s1">: boundary})</span>
    <span class="s0">assert </span><span class="s1">np.all(x == x_trimmed)</span>

    <span class="s1">x_overlaped = da.overlap.overlap(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary=boundary)</span>
    <span class="s1">x_trimmed = da.overlap.trim_overlap(x_overlaped</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary=boundary)</span>
    <span class="s0">assert </span><span class="s1">np.all(x == x_trimmed)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_rechunks_array_if_needed():</span>
    <span class="s4"># https://github.com/dask/dask/issues/6597</span>
    <span class="s1">expected = np.arange(</span><span class="s3">11</span><span class="s1">)</span>
    <span class="s1">x = da.from_array(expected</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">5</span><span class="s1">)</span>
    <span class="s1">y = x.map_overlap(</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">depth=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">boundary=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(c &gt;= </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">y.chunks[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_map_overlap_rechunks_array_along_multiple_dims_if_needed():</span>
    <span class="s4"># https://github.com/dask/dask/issues/6688</span>
    <span class="s1">rand = da.random.default_rng().random((</span><span class="s3">860</span><span class="s0">, </span><span class="s3">1024</span><span class="s0">, </span><span class="s3">1024</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1024</span><span class="s0">, </span><span class="s3">1024</span><span class="s1">))</span>
    <span class="s1">filtered = rand.map_overlap(</span>
        <span class="s0">lambda </span><span class="s1">arr: arr</span><span class="s0">,</span>
        <span class="s1">depth=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">boundary=</span><span class="s2">&quot;reflect&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(all(c &gt;= </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">c </span><span class="s0">in </span><span class="s1">chunks) </span><span class="s0">for </span><span class="s1">chunks </span><span class="s0">in </span><span class="s1">filtered.chunks)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;chunks,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">11</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">14</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">11</span><span class="s0">,</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">[(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">20</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_ensure_minimum_chunksize(chunks</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">actual = ensure_minimum_chunksize(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks)</span>
    <span class="s0">assert </span><span class="s1">actual == expected</span>


<span class="s0">def </span><span class="s1">test_ensure_minimum_chunksize_raises_error():</span>
    <span class="s1">chunks = (</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;overlapping depth 10 is larger than&quot;</span><span class="s1">):</span>
        <span class="s1">ensure_minimum_chunksize(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;shape, chunks, window_shape, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># chunks vary along axis</span>
        <span class="s1">((</span><span class="s3">40</span><span class="s0">, </span><span class="s3">30</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># window &lt; chunk</span>
        <span class="s1">((</span><span class="s3">21</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># window &gt; chunk</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># window == chunk, axis is integer</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># axis=-1</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># axis=None</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># axis=None</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># axis is repeated</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># axis is repeated, with -1</span>
        <span class="s1">((</span><span class="s3">9</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span><span class="s0">,  </span><span class="s4"># list instead of tuple</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_sliding_window_view(shape</span><span class="s0">, </span><span class="s1">chunks</span><span class="s0">, </span><span class="s1">window_shape</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">arr = da.from_array(np.arange(np.prod(shape)).reshape(shape)</span><span class="s0">, </span><span class="s1">chunks=chunks)</span>
    <span class="s1">actual = sliding_window_view(arr</span><span class="s0">, </span><span class="s1">window_shape</span><span class="s0">, </span><span class="s1">axis)</span>
    <span class="s1">expected = np.lib.stride_tricks.sliding_window_view(</span>
        <span class="s1">arr.compute()</span><span class="s0">, </span><span class="s1">window_shape</span><span class="s0">, </span><span class="s1">axis</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(expected</span><span class="s0">, </span><span class="s1">actual)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;window_shape, axis&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">((</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># window &gt; axis shape</span>
        <span class="s1">((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># axis &gt; ndim</span>
        <span class="s1">(-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># window shape is negative</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,  </span><span class="s4"># len(window shape) &lt; len(axis)</span>
        <span class="s1">(</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># len(window shape) &lt; len(axis)</span>
        <span class="s1">(</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">,  </span><span class="s4"># window_shape = 0</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_sliding_window_errors(window_shape</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">arr = da.zeros((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">sliding_window_view(arr</span><span class="s0">, </span><span class="s1">window_shape</span><span class="s0">, </span><span class="s1">axis)</span>
</pre>
</body>
</html>