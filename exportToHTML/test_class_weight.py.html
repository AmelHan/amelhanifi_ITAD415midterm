<html>
<head>
<title>test_class_weight.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6897bb;}
.s4 { color: #6a8759;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_class_weight.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">sparse</span>

<span class="s0">from </span><span class="s1">sklearn.datasets </span><span class="s0">import </span><span class="s1">make_blobs</span>
<span class="s0">from </span><span class="s1">sklearn.linear_model </span><span class="s0">import </span><span class="s1">LogisticRegression</span>
<span class="s0">from </span><span class="s1">sklearn.tree </span><span class="s0">import </span><span class="s1">DecisionTreeClassifier</span>
<span class="s0">from </span><span class="s1">sklearn.utils._testing </span><span class="s0">import </span><span class="s1">assert_almost_equal</span><span class="s0">, </span><span class="s1">assert_array_almost_equal</span>
<span class="s0">from </span><span class="s1">sklearn.utils.class_weight </span><span class="s0">import </span><span class="s1">compute_class_weight</span><span class="s0">, </span><span class="s1">compute_sample_weight</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight():</span>
    <span class="s2"># Test (and demo) compute_class_weight.</span>
    <span class="s1">y = np.asarray([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">classes = np.unique(y)</span>

    <span class="s1">cw = compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s2"># total effect of samples is preserved</span>
    <span class="s1">class_counts = np.bincount(y)[</span><span class="s3">2</span><span class="s1">:]</span>
    <span class="s1">assert_almost_equal(np.dot(cw</span><span class="s0">, </span><span class="s1">class_counts)</span><span class="s0">, </span><span class="s1">y.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">cw[</span><span class="s3">0</span><span class="s1">] &lt; cw[</span><span class="s3">1</span><span class="s1">] &lt; cw[</span><span class="s3">2</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_not_present():</span>
    <span class="s2"># Raise error when y does not contain all class labels</span>
    <span class="s1">classes = np.arange(</span><span class="s3">4</span><span class="s1">)</span>
    <span class="s1">y = np.asarray([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s2"># Fix exception in error message formatting when missing label is a string</span>
    <span class="s2"># https://github.com/scikit-learn/scikit-learn/issues/8312</span>
    <span class="s0">with </span><span class="s1">pytest.raises(</span>
        <span class="s1">ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s4">r&quot;The classes, \[0, 1, 2, 3\], are not in class_weight&quot;</span>
    <span class="s1">):</span>
        <span class="s1">compute_class_weight({</span><span class="s4">&quot;label_not_present&quot;</span><span class="s1">: </span><span class="s3">1.0</span><span class="s1">}</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s2"># Raise error when y has items not in classes</span>
    <span class="s1">classes = np.arange(</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_class_weight({</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2.0</span><span class="s1">}</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>

    <span class="s2"># y contains a unweighted class that is not in class_weights</span>
    <span class="s1">classes = np.asarray([</span><span class="s4">&quot;cat&quot;</span><span class="s0">, </span><span class="s4">&quot;dog&quot;</span><span class="s1">])</span>
    <span class="s1">y = np.asarray([</span><span class="s4">&quot;dog&quot;</span><span class="s0">, </span><span class="s4">&quot;cat&quot;</span><span class="s0">, </span><span class="s4">&quot;dog&quot;</span><span class="s1">])</span>
    <span class="s1">class_weights = {</span><span class="s4">&quot;dogs&quot;</span><span class="s1">: </span><span class="s3">3</span><span class="s0">, </span><span class="s4">&quot;cat&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span>
    <span class="s1">msg = </span><span class="s4">r&quot;The classes, \['dog'\], are not in class_weight&quot;</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">compute_class_weight(class_weights</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_dict():</span>
    <span class="s1">classes = np.arange(</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">class_weights = {</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">3.0</span><span class="s1">}</span>
    <span class="s1">y = np.asarray([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">cw = compute_class_weight(class_weights</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>

    <span class="s2"># When the user specifies class weights, compute_class_weights should just</span>
    <span class="s2"># return them.</span>
    <span class="s1">assert_array_almost_equal(np.asarray([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">cw)</span>

    <span class="s2"># When a class weight is specified that isn't in classes, the weight is ignored</span>
    <span class="s1">class_weights = {</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">4</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">}</span>
    <span class="s1">cw = compute_class_weight(class_weights</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s1">assert_allclose([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cw)</span>

    <span class="s1">class_weights = {-</span><span class="s3">1</span><span class="s1">: </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">: </span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">3.0</span><span class="s1">}</span>
    <span class="s1">cw = compute_class_weight(class_weights</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s1">assert_allclose([</span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">cw)</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_invariance():</span>
    <span class="s2"># Test that results with class_weight=&quot;balanced&quot; is invariant wrt</span>
    <span class="s2"># class imbalance if the number of samples is identical.</span>
    <span class="s2"># The test uses a balanced two class dataset with 100 datapoints.</span>
    <span class="s2"># It creates three versions, one where class 1 is duplicated</span>
    <span class="s2"># resulting in 150 points of class 1 and 50 of class 0,</span>
    <span class="s2"># one where there are 50 points in class 1 and 150 in class 0,</span>
    <span class="s2"># and one where there are 100 points of each class (this one is balanced</span>
    <span class="s2"># again).</span>
    <span class="s2"># With balancing class weights, all three should give the same model.</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = make_blobs(centers=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s2"># create dataset where class 1 is duplicated twice</span>
    <span class="s1">X_1 = np.vstack([X] + [X[y == </span><span class="s3">1</span><span class="s1">]] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y_1 = np.hstack([y] + [y[y == </span><span class="s3">1</span><span class="s1">]] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s2"># create dataset where class 0 is duplicated twice</span>
    <span class="s1">X_0 = np.vstack([X] + [X[y == </span><span class="s3">0</span><span class="s1">]] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y_0 = np.hstack([y] + [y[y == </span><span class="s3">0</span><span class="s1">]] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s2"># duplicate everything</span>
    <span class="s1">X_ = np.vstack([X] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y_ = np.hstack([y] * </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s2"># results should be identical</span>
    <span class="s1">logreg1 = LogisticRegression(class_weight=</span><span class="s4">&quot;balanced&quot;</span><span class="s1">).fit(X_1</span><span class="s0">, </span><span class="s1">y_1)</span>
    <span class="s1">logreg0 = LogisticRegression(class_weight=</span><span class="s4">&quot;balanced&quot;</span><span class="s1">).fit(X_0</span><span class="s0">, </span><span class="s1">y_0)</span>
    <span class="s1">logreg = LogisticRegression(class_weight=</span><span class="s4">&quot;balanced&quot;</span><span class="s1">).fit(X_</span><span class="s0">, </span><span class="s1">y_)</span>
    <span class="s1">assert_array_almost_equal(logreg1.coef_</span><span class="s0">, </span><span class="s1">logreg0.coef_)</span>
    <span class="s1">assert_array_almost_equal(logreg.coef_</span><span class="s0">, </span><span class="s1">logreg0.coef_)</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_balanced_negative():</span>
    <span class="s2"># Test compute_class_weight when labels are negative</span>
    <span class="s2"># Test with balanced class labels.</span>
    <span class="s1">classes = np.array([-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">y = np.asarray([-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">cw = compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">assert </span><span class="s1">len(cw) == len(classes)</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]))</span>

    <span class="s2"># Test with unbalanced class labels.</span>
    <span class="s1">y = np.asarray([-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">])</span>

    <span class="s1">cw = compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">assert </span><span class="s1">len(cw) == len(classes)</span>
    <span class="s1">class_counts = np.bincount(y + </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(np.dot(cw</span><span class="s0">, </span><span class="s1">class_counts)</span><span class="s0">, </span><span class="s1">y.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_balanced_unordered():</span>
    <span class="s2"># Test compute_class_weight when classes are unordered</span>
    <span class="s1">classes = np.array([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>

    <span class="s1">cw = compute_class_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s1">class_counts = np.bincount(y)[classes]</span>
    <span class="s1">assert_almost_equal(np.dot(cw</span><span class="s0">, </span><span class="s1">class_counts)</span><span class="s0">, </span><span class="s1">y.shape[</span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0 </span><span class="s1">/ </span><span class="s3">3</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_compute_class_weight_default():</span>
    <span class="s2"># Test for the case where no weight is given for a present class.</span>
    <span class="s2"># Current behaviour is to assign the unweighted classes a weight of 1.</span>
    <span class="s1">y = np.asarray([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">classes = np.unique(y)</span>
    <span class="s1">classes_len = len(classes)</span>

    <span class="s2"># Test for non specified weights</span>
    <span class="s1">cw = compute_class_weight(</span><span class="s0">None, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">assert </span><span class="s1">len(cw) == classes_len</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">3</span><span class="s1">))</span>

    <span class="s2"># Tests for partly specified weights</span>
    <span class="s1">cw = compute_class_weight({</span><span class="s3">2</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">assert </span><span class="s1">len(cw) == classes_len</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s1">cw = compute_class_weight({</span><span class="s3">2</span><span class="s1">: </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">4</span><span class="s1">: </span><span class="s3">0.5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">classes=classes</span><span class="s0">, </span><span class="s1">y=y)</span>
    <span class="s0">assert </span><span class="s1">len(cw) == classes_len</span>
    <span class="s1">assert_array_almost_equal(cw</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.5</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_compute_sample_weight():</span>
    <span class="s2"># Test (and demo) compute_sample_weight.</span>
    <span class="s2"># Test with balanced classes</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with user-defined weights</span>
    <span class="s1">sample_weight = compute_sample_weight({</span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with column vector of balanced classes</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with unbalanced classes</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">expected_balanced = np.array(</span>
        <span class="s1">[</span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">0.7777</span><span class="s0">, </span><span class="s3">2.3333</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">expected_balanced</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">4</span><span class="s1">)</span>

    <span class="s2"># Test with `None` weights</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s0">None, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with multi-output of balanced classes</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with multi-output with user-defined weights</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight([{</span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}]</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span>

    <span class="s2"># Test with multi-output of unbalanced classes</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">expected_balanced**</span><span class="s3">2</span><span class="s0">, </span><span class="s1">decimal=</span><span class="s3">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_compute_sample_weight_with_subsample():</span>
    <span class="s2"># Test compute_sample_weight with subsamples specified.</span>
    <span class="s2"># Test with balanced classes and all samples present</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with column vector of balanced classes and all samples present</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">])</span>

    <span class="s2"># Test with a subsample</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2.0 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2.0 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2.0 </span><span class="s1">/ </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s1">])</span>

    <span class="s2"># Test with a bootstrap subsample</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">expected_balanced = np.asarray([</span><span class="s3">0.6</span><span class="s0">, </span><span class="s3">0.6</span><span class="s0">, </span><span class="s3">0.6</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">expected_balanced)</span>

    <span class="s2"># Test with a bootstrap subsample for multi-output</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">expected_balanced**</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s2"># Test with a missing class</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">])</span>

    <span class="s2"># Test with a missing class for multi-output</span>
    <span class="s1">y = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">6</span><span class="s1">))</span>
    <span class="s1">assert_array_almost_equal(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">0.0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_compute_sample_weight_errors():</span>
    <span class="s2"># Test compute_sample_weight raises errors expected.</span>
    <span class="s2"># Invalid preset string</span>
    <span class="s1">y = np.asarray([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">y_ = np.asarray([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]])</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight(</span><span class="s4">&quot;ni&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight(</span><span class="s4">&quot;ni&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">4</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight(</span><span class="s4">&quot;ni&quot;</span><span class="s0">, </span><span class="s1">y_)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight(</span><span class="s4">&quot;ni&quot;</span><span class="s0">, </span><span class="s1">y_</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">4</span><span class="s1">))</span>

    <span class="s2"># Not &quot;balanced&quot; for subsample</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight({</span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=range(</span><span class="s3">4</span><span class="s1">))</span>

    <span class="s2"># Not a list or preset for multi-output</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight({</span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">y_)</span>

    <span class="s2"># Incorrect length list for multi-output</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">compute_sample_weight([{</span><span class="s3">1</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}]</span><span class="s0">, </span><span class="s1">y_)</span>


<span class="s0">def </span><span class="s1">test_compute_sample_weight_more_than_32():</span>
    <span class="s2"># Non-regression smoke test for #12146</span>
    <span class="s1">y = np.arange(</span><span class="s3">50</span><span class="s1">)  </span><span class="s2"># more than 32 distinct classes</span>
    <span class="s1">indices = np.arange(</span><span class="s3">50</span><span class="s1">)  </span><span class="s2"># use subsampling</span>
    <span class="s1">weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">indices=indices)</span>
    <span class="s1">assert_array_almost_equal(weight</span><span class="s0">, </span><span class="s1">np.ones(y.shape[</span><span class="s3">0</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_class_weight_does_not_contains_more_classes():</span>
    <span class="s5">&quot;&quot;&quot;Check that class_weight can contain more labels than in y. 
 
    Non-regression test for #22413 
    &quot;&quot;&quot;</span>
    <span class="s1">tree = DecisionTreeClassifier(class_weight={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: </span><span class="s3">10</span><span class="s0">, </span><span class="s3">2</span><span class="s1">: </span><span class="s3">20</span><span class="s1">})</span>

    <span class="s2"># Does not raise</span>
    <span class="s1">tree.fit([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_compute_sample_weight_sparse():</span>
    <span class="s5">&quot;&quot;&quot;Check that we can compute weight for sparse `y`.&quot;&quot;&quot;</span>
    <span class="s1">y = sparse.csc_matrix(np.asarray([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])).T</span>
    <span class="s1">sample_weight = compute_sample_weight(</span><span class="s4">&quot;balanced&quot;</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">assert_allclose(sample_weight</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">0.75</span><span class="s0">, </span><span class="s3">0.75</span><span class="s1">])</span>
</pre>
</body>
</html>