<html>
<head>
<title>test_rotation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6897bb;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_rotation.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">unittest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

<span class="s0">from </span><span class="s1">statsmodels.multivariate.factor_rotation._wrappers </span><span class="s0">import </span><span class="s1">rotate_factors</span>
<span class="s0">from </span><span class="s1">statsmodels.multivariate.factor_rotation._gpa_rotation </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">ff_partial_target</span><span class="s0">, </span><span class="s1">vgQ_partial_target</span><span class="s0">, </span><span class="s1">ff_target</span><span class="s0">, </span><span class="s1">vgQ_target</span><span class="s0">, </span><span class="s1">CF_objective</span><span class="s0">,</span>
    <span class="s1">orthomax_objective</span><span class="s0">, </span><span class="s1">oblimin_objective</span><span class="s0">, </span><span class="s1">GPA)</span>
<span class="s0">from </span><span class="s1">statsmodels.multivariate.factor_rotation._analytic_rotation </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">target_rotation)</span>


<span class="s0">class </span><span class="s1">TestAnalyticRotation(unittest.TestCase):</span>
    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">str2matrix(A):</span>
        <span class="s1">A = A.lstrip().rstrip().split(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
        <span class="s1">A = np.array([row.split() </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">A]).astype(float)</span>
        <span class="s0">return </span><span class="s1">A</span>

    <span class="s0">def </span><span class="s1">test_target_rotation(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Rotation towards target matrix example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         .830 -.396 
         .818 -.469 
         .777 -.470 
         .798 -.401 
         .786  .500 
         .672  .458 
         .594  .444 
         .647  .333 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">H = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          .8 -.3 
          .8 -.4 
          .7 -.4 
          .9 -.4 
          .8  .5 
          .6  .4 
          .5  .4 
          .6  .3 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">T = target_rotation(A</span><span class="s0">, </span><span class="s1">H)</span>
        <span class="s1">L = A.dot(T)</span>
        <span class="s1">L_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.84168  -0.37053 
        0.83191  -0.44386 
        0.79096  -0.44611 
        0.80985  -0.37650 
        0.77040   0.52371 
        0.65774   0.47826 
        0.58020   0.46189 
        0.63656   0.35255 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">T = target_rotation(A</span><span class="s0">, </span><span class="s1">H</span><span class="s0">, </span><span class="s1">full_rank=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L = A.dot(T)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_orthogonal_target(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Rotation towards target matrix example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         .830 -.396 
         .818 -.469 
         .777 -.470 
         .798 -.401 
         .786  .500 
         .672  .458 
         .594  .444 
         .647  .333 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">H = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          .8 -.3 
          .8 -.4 
          .7 -.4 
          .9 -.4 
          .8  .5 
          .6  .4 
          .5  .4 
          .6  .3 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: vgQ_target(H</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">T_analytic = target_rotation(A</span><span class="s0">, </span><span class="s1">H)</span>
        <span class="s1">self.assertTrue(np.allclose(T</span><span class="s0">, </span><span class="s1">T_analytic</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestGPARotation(unittest.TestCase):</span>

    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">str2matrix(A):</span>
        <span class="s1">A = A.lstrip().rstrip().split(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
        <span class="s1">A = np.array([row.split() </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">A]).astype(float)</span>
        <span class="s0">return </span><span class="s1">A</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">get_A(cls):</span>
        <span class="s0">return </span><span class="s1">cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         .830 -.396 
         .818 -.469 
         .777 -.470 
         .798 -.401 
         .786  .500 
         .672  .458 
         .594  .444 
         .647  .333 
        &quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">get_quartimin_example(cls):</span>
        <span class="s1">A = cls.get_A()</span>
        <span class="s1">table_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          0.00000    0.42806   -0.46393    1.00000 
        1.00000    0.41311   -0.57313    0.25000 
        2.00000    0.38238   -0.36652    0.50000 
        3.00000    0.31850   -0.21011    0.50000 
        4.00000    0.20937   -0.13838    0.50000 
        5.00000    0.12379   -0.35583    0.25000 
        6.00000    0.04289   -0.53244    0.50000 
        7.00000    0.01098   -0.86649    0.50000 
        8.00000    0.00566   -1.65798    0.50000 
        9.00000    0.00558   -2.13212    0.25000 
       10.00000    0.00557   -2.49020    0.25000 
       11.00000    0.00557   -2.84585    0.25000 
       12.00000    0.00557   -3.20320    0.25000 
       13.00000    0.00557   -3.56143    0.25000 
       14.00000    0.00557   -3.92005    0.25000 
       15.00000    0.00557   -4.27885    0.25000 
       16.00000    0.00557   -4.63772    0.25000 
       17.00000    0.00557   -4.99663    0.25000 
       18.00000    0.00557   -5.35555    0.25000 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
       0.891822   0.056015 
       0.953680  -0.023246 
       0.929150  -0.046503 
       0.876683   0.033658 
       0.013701   0.925000 
      -0.017265   0.821253 
      -0.052445   0.764953 
       0.085890   0.683115 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">get_biquartimin_example(cls):</span>
        <span class="s1">A = cls.get_A()</span>
        <span class="s1">table_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
            0.00000    0.21632   -0.54955    1.00000 
            1.00000    0.19519   -0.46174    0.50000 
            2.00000    0.09479   -0.16365    1.00000 
            3.00000   -0.06302   -0.32096    0.50000 
            4.00000   -0.21304   -0.46562    1.00000 
            5.00000   -0.33199   -0.33287    1.00000 
            6.00000   -0.35108   -0.63990    0.12500 
            7.00000   -0.35543   -1.20916    0.12500 
            8.00000   -0.35568   -2.61213    0.12500 
            9.00000   -0.35568   -2.97910    0.06250 
           10.00000   -0.35568   -3.32645    0.06250 
           11.00000   -0.35568   -3.66021    0.06250 
           12.00000   -0.35568   -3.98564    0.06250 
           13.00000   -0.35568   -4.30635    0.06250 
           14.00000   -0.35568   -4.62451    0.06250 
           15.00000   -0.35568   -4.94133    0.06250 
           16.00000   -0.35568   -5.25745    0.06250 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
           1.01753  -0.13657 
           1.11338  -0.24643 
           1.09200  -0.26890 
           1.00676  -0.16010 
          -0.26534   1.11371 
          -0.26972   0.99553 
          -0.29341   0.93561 
          -0.10806   0.80513 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">get_biquartimin_example_derivative_free(cls):</span>
        <span class="s1">A = cls.get_A()</span>
        <span class="s1">table_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
            0.00000    0.21632   -0.54955    1.00000 
            1.00000    0.19519   -0.46174    0.50000 
            2.00000    0.09479   -0.16365    1.00000 
            3.00000   -0.06302   -0.32096    0.50000 
            4.00000   -0.21304   -0.46562    1.00000 
            5.00000   -0.33199   -0.33287    1.00000 
            6.00000   -0.35108   -0.63990    0.12500 
            7.00000   -0.35543   -1.20916    0.12500 
            8.00000   -0.35568   -2.61213    0.12500 
            9.00000   -0.35568   -2.97910    0.06250 
           10.00000   -0.35568   -3.32645    0.06250 
           11.00000   -0.35568   -3.66021    0.06250 
           12.00000   -0.35568   -3.98564    0.06250 
           13.00000   -0.35568   -4.30634    0.06250 
           14.00000   -0.35568   -4.62451    0.06250 
           15.00000   -0.35568   -4.94133    0.06250 
           16.00000   -0.35568   -6.32435    0.12500 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
           1.01753  -0.13657 
           1.11338  -0.24643 
           1.09200  -0.26890 
           1.00676  -0.16010 
          -0.26534   1.11371 
          -0.26972   0.99553 
          -0.29342   0.93561 
          -0.10806   0.80513 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">get_quartimax_example_derivative_free(cls):</span>
        <span class="s1">A = cls.get_A()</span>
        <span class="s1">table_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.00000   -0.72073   -0.65498    1.00000 
        1.00000   -0.88561   -0.34614    2.00000 
        2.00000   -1.01992   -1.07152    1.00000 
        3.00000   -1.02237   -1.51373    0.50000 
        4.00000   -1.02269   -1.96205    0.50000 
        5.00000   -1.02273   -2.41116    0.50000 
        6.00000   -1.02273   -2.86037    0.50000 
        7.00000   -1.02273   -3.30959    0.50000 
        8.00000   -1.02273   -3.75881    0.50000 
        9.00000   -1.02273   -4.20804    0.50000 
       10.00000   -1.02273   -4.65726    0.50000 
       11.00000   -1.02273   -5.10648    0.50000 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = cls.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
       0.89876   0.19482 
       0.93394   0.12974 
       0.90213   0.10386 
       0.87651   0.17128 
       0.31558   0.87647 
       0.25113   0.77349 
       0.19801   0.71468 
       0.30786   0.65933 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required</span>

    <span class="s0">def </span><span class="s1">test_orthomax(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Quartimax example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.get_A()</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: orthomax_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">table_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         0.00000   -0.72073   -0.65498    1.00000 
         1.00000   -0.88561   -0.34614    2.00000 
         2.00000   -1.01992   -1.07152    1.00000 
         3.00000   -1.02237   -1.51373    0.50000 
         4.00000   -1.02269   -1.96205    0.50000 
         5.00000   -1.02273   -2.41116    0.50000 
         6.00000   -1.02273   -2.86037    0.50000 
         7.00000   -1.02273   -3.30959    0.50000 
         8.00000   -1.02273   -3.75881    0.50000 
         9.00000   -1.02273   -4.20804    0.50000 
        10.00000   -1.02273   -4.65726    0.50000 
        11.00000   -1.02273   -5.10648    0.50000 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.89876   0.19482 
        0.93394   0.12974 
        0.90213   0.10386 
        0.87651   0.17128 
        0.31558   0.87647 
        0.25113   0.77349 
        0.19801   0.71468 
        0.30786   0.65933 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># oblimin criterion gives same result</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">phi2</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table2 = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">,</span>
                                          <span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># derivative free quartimax</span>
        <span class="s1">out = self.get_quartimax_example_derivative_free()</span>
        <span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required = out</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: orthomax_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">return_gradient=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_equivalence_orthomax_oblimin(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        These criteria should be equivalent when restricted to orthogonal 
        rotation. 
        See Hartman 1976 page 299. 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.get_A()</span>
        <span class="s1">gamma = </span><span class="s4">0  </span><span class="s5"># quartimax</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: orthomax_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=gamma</span><span class="s0">, </span><span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_orthomax</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(</span>
            <span class="s1">A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=gamma</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">phi2</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table2 = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">,</span>
                                          <span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L_orthomax</span><span class="s0">, </span><span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">gamma = </span><span class="s4">1  </span><span class="s5"># varimax</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: orthomax_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=gamma</span><span class="s0">, </span><span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_orthomax</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(</span>
            <span class="s1">A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=gamma</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">phi2</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table2 = GPA(</span>
            <span class="s1">A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L_orthomax</span><span class="s0">, </span><span class="s1">L_oblimin</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_orthogonal_target(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Rotation towards target matrix example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.get_A()</span>
        <span class="s1">H = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          .8 -.3 
          .8 -.4 
          .7 -.4 
          .9 -.4 
          .8  .5 
          .6  .4 
          .5  .4 
          .6  .3 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: vgQ_target(H</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">table_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.00000   0.05925  -0.61244   1.00000 
        1.00000   0.05444  -1.14701   0.12500 
        2.00000   0.05403  -1.68194   0.12500 
        3.00000   0.05399  -2.21689   0.12500 
        4.00000   0.05399  -2.75185   0.12500 
        5.00000   0.05399  -3.28681   0.12500 
        6.00000   0.05399  -3.82176   0.12500 
        7.00000   0.05399  -4.35672   0.12500 
        8.00000   0.05399  -4.89168   0.12500 
        9.00000   0.05399  -5.42664   0.12500 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.84168  -0.37053 
        0.83191  -0.44386 
        0.79096  -0.44611 
        0.80985  -0.37650 
        0.77040   0.52371 
        0.65774   0.47826 
        0.58020   0.46189 
        0.63656   0.35255 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: ff_target(H</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T)</span>
        <span class="s1">L2</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(T</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: vgQ_target(</span>
            <span class="s1">H</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: ff_target(</span>
            <span class="s1">H</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">L2</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(T</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_orthogonal_partial_target(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Rotation towards target matrix example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s1">A = self.get_A()</span>
        <span class="s1">H = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          .8 -.3 
          .8 -.4 
          .7 -.4 
          .9 -.4 
          .8  .5 
          .6  .4 
          .5  .4 
          .6  .3 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">W = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        1 0 
        0 1 
        0 0 
        1 1 
        1 0 
        1 0 
        0 1 
        1 0 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: vgQ_partial_target(</span>
            <span class="s1">H</span><span class="s0">, </span><span class="s1">W</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">table_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         0.00000    0.02559   -0.84194    1.00000 
         1.00000    0.02203   -1.27116    0.25000 
         2.00000    0.02154   -1.71198    0.25000 
         3.00000    0.02148   -2.15713    0.25000 
         4.00000    0.02147   -2.60385    0.25000 
         5.00000    0.02147   -3.05114    0.25000 
         6.00000    0.02147   -3.49863    0.25000 
         7.00000    0.02147   -3.94619    0.25000 
         8.00000    0.02147   -4.39377    0.25000 
         9.00000    0.02147   -4.84137    0.25000 
        10.00000    0.02147   -5.28897    0.25000 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">L_required = self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        0.84526  -0.36228 
        0.83621  -0.43571 
        0.79528  -0.43836 
        0.81349  -0.36857 
        0.76525   0.53122 
        0.65303   0.48467 
        0.57565   0.46754 
        0.63308   0.35876 
        &quot;&quot;&quot;</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: ff_partial_target(</span>
            <span class="s1">H</span><span class="s0">, </span><span class="s1">W</span><span class="s0">, </span><span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T)</span>
        <span class="s1">L2</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(T</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_oblimin(self):</span>
        <span class="s5"># quartimin</span>
        <span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required = self.get_quartimin_example()</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># quartimin derivative free</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># biquartimin</span>
        <span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required = self.get_biquartimin_example()</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">1</span><span class="s1">/</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># quartimin derivative free</span>
        <span class="s1">out = self.get_biquartimin_example_derivative_free()</span>
        <span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required = out</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: oblimin_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">1</span><span class="s1">/</span><span class="s4">2</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'oblique'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(table</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_CF(self):</span>
        <span class="s5"># quartimax</span>
        <span class="s1">out = self.get_quartimax_example_derivative_free()</span>
        <span class="s1">A</span><span class="s0">, </span><span class="s1">table_required</span><span class="s0">, </span><span class="s1">L_required = out</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: CF_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">kappa=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># quartimax derivative free</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: CF_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">kappa=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">L</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L</span><span class="s0">, </span><span class="s1">L_required</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s5"># varimax</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">k = A.shape</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: orthomax_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">gamma=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_vm</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">vgQ = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: CF_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">kappa=</span><span class="s4">1</span><span class="s1">/p</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">L_CF</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">vgQ=vgQ</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">ff = </span><span class="s0">lambda </span><span class="s1">L=</span><span class="s0">None, </span><span class="s1">A=</span><span class="s0">None, </span><span class="s1">T=</span><span class="s0">None</span><span class="s1">: CF_objective(</span>
            <span class="s1">L=L</span><span class="s0">, </span><span class="s1">A=A</span><span class="s0">, </span><span class="s1">T=T</span><span class="s0">, </span><span class="s1">kappa=</span><span class="s4">1</span><span class="s1">/p</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s0">,</span>
            <span class="s1">return_gradient=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">L_CF_df</span><span class="s0">, </span><span class="s1">phi</span><span class="s0">, </span><span class="s1">T</span><span class="s0">, </span><span class="s1">table = GPA(A</span><span class="s0">, </span><span class="s1">ff=ff</span><span class="s0">, </span><span class="s1">rotation_method=</span><span class="s2">'orthogonal'</span><span class="s1">)</span>
        <span class="s1">self.assertTrue(np.allclose(L_vm</span><span class="s0">, </span><span class="s1">L_CF</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(L_CF</span><span class="s0">, </span><span class="s1">L_CF_df</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-05</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestWrappers(unittest.TestCase):</span>
    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">str2matrix(A):</span>
        <span class="s1">A = A.lstrip().rstrip().split(</span><span class="s2">'</span><span class="s0">\n</span><span class="s2">'</span><span class="s1">)</span>
        <span class="s1">A = np.array([row.split() </span><span class="s0">for </span><span class="s1">row </span><span class="s0">in </span><span class="s1">A]).astype(float)</span>
        <span class="s0">return </span><span class="s1">A</span>

    <span class="s0">def </span><span class="s1">get_A(self):</span>
        <span class="s0">return </span><span class="s1">self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
         .830 -.396 
         .818 -.469 
         .777 -.470 
         .798 -.401 
         .786  .500 
         .672  .458 
         .594  .444 
         .647  .333 
        &quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">get_H(self):</span>
        <span class="s0">return </span><span class="s1">self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
          .8 -.3 
          .8 -.4 
          .7 -.4 
          .9 -.4 
          .8  .5 
          .6  .4 
          .5  .4 
          .6  .3 
        &quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">get_W(self):</span>
        <span class="s0">return </span><span class="s1">self.str2matrix(</span><span class="s2">&quot;&quot;&quot; 
        1 0 
        0 1 
        0 0 
        1 1 
        1 0 
        1 0 
        0 1 
        1 0 
        &quot;&quot;&quot;</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">_test_template(self</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">*method_args</span><span class="s0">, </span><span class="s1">**algorithms):</span>
        <span class="s1">A = self.get_A()</span>
        <span class="s1">algorithm1 = </span><span class="s2">'gpa' </span><span class="s0">if </span><span class="s2">'algorithm1' </span><span class="s0">not in </span><span class="s1">algorithms </span><span class="s0">else </span><span class="s1">algorithms[</span>
            <span class="s2">'algorithm1'</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s2">'algorithm`' </span><span class="s0">not in </span><span class="s1">algorithms:</span>
            <span class="s1">algorithm2 = </span><span class="s2">'gpa_der_free'</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">algorithms[</span><span class="s2">'algorithm1'</span><span class="s1">]</span>
        <span class="s1">L1</span><span class="s0">, </span><span class="s1">T1 = rotate_factors(A</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">*method_args</span><span class="s0">, </span><span class="s1">algorithm=algorithm1)</span>
        <span class="s1">L2</span><span class="s0">, </span><span class="s1">T2 = rotate_factors(A</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">*method_args</span><span class="s0">, </span><span class="s1">algorithm=algorithm2)</span>
        <span class="s1">self.assertTrue(np.allclose(L1</span><span class="s0">, </span><span class="s1">L2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">))</span>
        <span class="s1">self.assertTrue(np.allclose(T1</span><span class="s0">, </span><span class="s1">T2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_methods(self):</span>
        <span class="s3">&quot;&quot;&quot; 
        Quartimax derivative free example 
        http://www.stat.ucla.edu/research/gpa 
        &quot;&quot;&quot;</span>
        <span class="s5"># orthomax, oblimin and CF are tested indirectly</span>
        <span class="s1">methods = [</span><span class="s2">'quartimin'</span><span class="s0">, </span><span class="s2">'biquartimin'</span><span class="s0">,</span>
                   <span class="s2">'quartimax'</span><span class="s0">, </span><span class="s2">'biquartimax'</span><span class="s0">, </span><span class="s2">'varimax'</span><span class="s0">, </span><span class="s2">'equamax'</span><span class="s0">,</span>
                   <span class="s2">'parsimax'</span><span class="s0">, </span><span class="s2">'parsimony'</span><span class="s0">,</span>
                   <span class="s2">'target'</span><span class="s0">, </span><span class="s2">'partial_target'</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">methods:</span>
            <span class="s1">method_args = []</span>
            <span class="s0">if </span><span class="s1">method == </span><span class="s2">'target'</span><span class="s1">:</span>
                <span class="s1">method_args = [self.get_H()</span><span class="s0">, </span><span class="s2">'orthogonal'</span><span class="s1">]</span>
                <span class="s1">self._test_template(method</span><span class="s0">, </span><span class="s1">*method_args)</span>
                <span class="s1">method_args = [self.get_H()</span><span class="s0">, </span><span class="s2">'oblique'</span><span class="s1">]</span>
                <span class="s1">self._test_template(method</span><span class="s0">, </span><span class="s1">*method_args)</span>
                <span class="s1">method_args = [self.get_H()</span><span class="s0">, </span><span class="s2">'orthogonal'</span><span class="s1">]</span>
                <span class="s1">self._test_template(method</span><span class="s0">, </span><span class="s1">*method_args</span><span class="s0">,</span>
                                    <span class="s1">algorithm2=</span><span class="s2">'analytic'</span><span class="s1">)</span>
            <span class="s0">elif </span><span class="s1">method == </span><span class="s2">'partial_target'</span><span class="s1">:</span>
                <span class="s1">method_args = [self.get_H()</span><span class="s0">, </span><span class="s1">self.get_W()]</span>
            <span class="s1">self._test_template(method</span><span class="s0">, </span><span class="s1">*method_args)</span>
</pre>
</body>
</html>