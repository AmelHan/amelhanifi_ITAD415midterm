<html>
<head>
<title>test_dicttoolz.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #6a8759;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_dicttoolz.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">collections </span><span class="s0">import </span><span class="s1">defaultdict </span><span class="s0">as </span><span class="s1">_defaultdict</span>
<span class="s0">from </span><span class="s1">collections.abc </span><span class="s0">import </span><span class="s1">Mapping</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">toolz.dicttoolz </span><span class="s0">import </span><span class="s1">(merge</span><span class="s0">, </span><span class="s1">merge_with</span><span class="s0">, </span><span class="s1">valmap</span><span class="s0">, </span><span class="s1">keymap</span><span class="s0">, </span><span class="s1">update_in</span><span class="s0">,</span>
                             <span class="s1">assoc</span><span class="s0">, </span><span class="s1">dissoc</span><span class="s0">, </span><span class="s1">keyfilter</span><span class="s0">, </span><span class="s1">valfilter</span><span class="s0">, </span><span class="s1">itemmap</span><span class="s0">,</span>
                             <span class="s1">itemfilter</span><span class="s0">, </span><span class="s1">assoc_in)</span>
<span class="s0">from </span><span class="s1">toolz.functoolz </span><span class="s0">import </span><span class="s1">identity</span>
<span class="s0">from </span><span class="s1">toolz.utils </span><span class="s0">import </span><span class="s1">raises</span>


<span class="s0">def </span><span class="s1">inc(x):</span>
    <span class="s0">return </span><span class="s1">x + </span><span class="s2">1</span>


<span class="s0">def </span><span class="s1">iseven(i):</span>
    <span class="s0">return </span><span class="s1">i % </span><span class="s2">2 </span><span class="s1">== </span><span class="s2">0</span>


<span class="s0">class </span><span class="s1">TestDict(object):</span>
    <span class="s3">&quot;&quot;&quot;Test typical usage: dict inputs, no factory keyword. 
 
    Class attributes: 
        D: callable that inputs a dict and creates or returns a MutableMapping 
        kw: kwargs dict to specify &quot;factory&quot; keyword (if applicable) 
    &quot;&quot;&quot;</span>
    <span class="s1">D = dict</span>
    <span class="s1">kw = {}</span>

    <span class="s0">def </span><span class="s1">test_merge(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">merge(D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">3</span><span class="s1">: </span><span class="s2">4</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">4</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_merge_iterable_arg(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">merge([D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">3</span><span class="s1">: </span><span class="s2">4</span><span class="s1">})]</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">4</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_merge_with(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s1">dicts = D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">20</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">*dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">22</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(tuple</span><span class="s0">, </span><span class="s1">*dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: (</span><span class="s2">1</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: (</span><span class="s2">2</span><span class="s0">, </span><span class="s2">20</span><span class="s1">)})</span>

        <span class="s1">dicts = D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">20</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">*dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">22</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(tuple</span><span class="s0">, </span><span class="s1">*dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: (</span><span class="s2">1</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: (</span><span class="s2">2</span><span class="s0">, </span><span class="s2">20</span><span class="s1">)</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: (</span><span class="s2">3</span><span class="s0">,</span><span class="s1">)})</span>

        <span class="s0">assert not </span><span class="s1">merge_with(sum)</span>

    <span class="s0">def </span><span class="s1">test_merge_with_iterable_arg(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s1">dicts = D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">10</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">20</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">*dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">22</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">dicts</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">22</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">iter(dicts)</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">11</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">22</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_valmap(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">valmap(inc</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_keymap(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">keymap(inc</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_itemmap(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">itemmap(reversed</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">4</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_valfilter(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">valfilter(iseven</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_keyfilter(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">keyfilter(iseven</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_itemfilter(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">itemfilter(</span><span class="s0">lambda </span><span class="s1">item: iseven(item[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">itemfilter(</span><span class="s0">lambda </span><span class="s1">item: iseven(item[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>

    <span class="s0">def </span><span class="s1">test_assoc(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">assoc(D({})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">assoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">assoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>

        <span class="s5"># Verify immutability:</span>
        <span class="s1">d = D({</span><span class="s4">'x'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">oldd = d</span>
        <span class="s1">assoc(d</span><span class="s0">, </span><span class="s4">'x'</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">**kw)</span>
        <span class="s0">assert </span><span class="s1">d </span><span class="s0">is </span><span class="s1">oldd</span>

    <span class="s0">def </span><span class="s1">test_dissoc(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kw) == D({})</span>
        <span class="s0">assert </span><span class="s1">dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s1">**kw) == D({})</span>
        <span class="s0">assert </span><span class="s1">dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kw) == dissoc(dissoc(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kw)</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s1">**kw)</span>

        <span class="s5"># Verify immutability:</span>
        <span class="s1">d = D({</span><span class="s4">'x'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">oldd = d</span>
        <span class="s1">d2 = dissoc(d</span><span class="s0">, </span><span class="s4">'x'</span><span class="s0">, </span><span class="s1">**kw)</span>
        <span class="s0">assert </span><span class="s1">d </span><span class="s0">is </span><span class="s1">oldd</span>
        <span class="s0">assert </span><span class="s1">d2 </span><span class="s0">is not </span><span class="s1">oldd</span>

    <span class="s0">def </span><span class="s1">test_assoc_in(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">assoc_in(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">(assoc_in(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: D({</span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">**kw) ==</span>
                <span class="s1">D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: D({</span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})}))</span>
        <span class="s0">assert </span><span class="s1">assoc_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: D({</span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})})</span>

        <span class="s5"># Verify immutability:</span>
        <span class="s1">d = D({</span><span class="s4">'x'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">oldd = d</span>
        <span class="s1">d2 = assoc_in(d</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s1">**kw)</span>
        <span class="s0">assert </span><span class="s1">d </span><span class="s0">is </span><span class="s1">oldd</span>
        <span class="s0">assert </span><span class="s1">d2 </span><span class="s0">is not </span><span class="s1">oldd</span>

    <span class="s0">def </span><span class="s1">test_update_in(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">update_in(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s1">})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">inc</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">update_in(D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s0">, </span><span class="s4">&quot;b&quot;</span><span class="s1">: </span><span class="s4">&quot;1&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">(update_in(D({</span><span class="s4">&quot;t&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;v&quot;</span><span class="s1">: D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">0</span><span class="s1">})})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;v&quot;</span><span class="s0">, </span><span class="s4">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">inc</span><span class="s0">, </span><span class="s1">**kw) ==</span>
                <span class="s1">D({</span><span class="s4">&quot;t&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s0">, </span><span class="s4">&quot;v&quot;</span><span class="s1">: D({</span><span class="s4">&quot;a&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})}))</span>
        <span class="s5"># Handle one missing key.</span>
        <span class="s0">assert </span><span class="s1">update_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, None, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;z&quot;</span><span class="s1">: </span><span class="s4">&quot;None&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">update_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">inc</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;z&quot;</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">update_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;z&quot;</span><span class="s1">]</span><span class="s0">, lambda </span><span class="s1">x: x+</span><span class="s4">&quot;ar&quot;</span><span class="s0">, </span><span class="s1">default=</span><span class="s4">&quot;b&quot;</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s4">&quot;z&quot;</span><span class="s1">: </span><span class="s4">&quot;bar&quot;</span><span class="s1">})</span>
        <span class="s5"># Same semantics as Clojure for multiple missing keys, ie. recursively</span>
        <span class="s5"># create nested empty dictionaries to the depth specified by the</span>
        <span class="s5"># keys with the innermost value set to f(default).</span>
        <span class="s0">assert </span><span class="s1">update_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">inc</span><span class="s0">, </span><span class="s1">default=-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">0</span><span class="s1">: D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">0</span><span class="s1">})})</span>
        <span class="s0">assert </span><span class="s1">update_in(D({})</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, </span><span class="s1">default=</span><span class="s2">100</span><span class="s0">, </span><span class="s1">**kw) == D({</span><span class="s2">0</span><span class="s1">: D({</span><span class="s2">1</span><span class="s1">: </span><span class="s4">&quot;100&quot;</span><span class="s1">})})</span>
        <span class="s0">assert </span><span class="s1">(update_in(D({</span><span class="s4">&quot;foo&quot;</span><span class="s1">: </span><span class="s4">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">50</span><span class="s1">})</span><span class="s0">, </span><span class="s1">[</span><span class="s4">&quot;d&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">str</span><span class="s0">, </span><span class="s2">20</span><span class="s0">, </span><span class="s1">**kw) ==</span>
                <span class="s1">D({</span><span class="s4">&quot;foo&quot;</span><span class="s1">: </span><span class="s4">&quot;bar&quot;</span><span class="s0">, </span><span class="s2">1</span><span class="s1">: </span><span class="s2">50</span><span class="s0">, </span><span class="s4">&quot;d&quot;</span><span class="s1">: D({</span><span class="s2">1</span><span class="s1">: D({</span><span class="s2">0</span><span class="s1">: </span><span class="s4">&quot;20&quot;</span><span class="s1">})})}))</span>
        <span class="s5"># Verify immutability:</span>
        <span class="s1">d = D({</span><span class="s4">'x'</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>
        <span class="s1">oldd = d</span>
        <span class="s1">update_in(d</span><span class="s0">, </span><span class="s1">[</span><span class="s4">'x'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">inc</span><span class="s0">, </span><span class="s1">**kw)</span>
        <span class="s0">assert </span><span class="s1">d </span><span class="s0">is </span><span class="s1">oldd</span>

    <span class="s0">def </span><span class="s1">test_factory(self):</span>
        <span class="s1">D</span><span class="s0">, </span><span class="s1">kw = self.D</span><span class="s0">, </span><span class="s1">self.kw</span>
        <span class="s0">assert </span><span class="s1">merge(defaultdict(int</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">}))</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})) == {</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">}</span>
        <span class="s0">assert </span><span class="s1">(merge(defaultdict(int</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">}))</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">,</span>
                      <span class="s1">factory=</span><span class="s0">lambda</span><span class="s1">: defaultdict(int)) ==</span>
                <span class="s1">defaultdict(int</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})))</span>
        <span class="s0">assert not </span><span class="s1">(merge(defaultdict(int</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">}))</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">,</span>
                          <span class="s1">factory=</span><span class="s0">lambda</span><span class="s1">: defaultdict(int)) == {</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">raises(TypeError</span><span class="s0">, lambda</span><span class="s1">: merge(D({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">2</span><span class="s1">})</span><span class="s0">, </span><span class="s1">D({</span><span class="s2">2</span><span class="s1">: </span><span class="s2">3</span><span class="s1">})</span><span class="s0">, </span><span class="s1">factoryy=dict))</span>


<span class="s0">class </span><span class="s1">defaultdict(_defaultdict):</span>
    <span class="s0">def </span><span class="s1">__eq__(self</span><span class="s0">, </span><span class="s1">other):</span>
        <span class="s0">return </span><span class="s1">(super(defaultdict</span><span class="s0">, </span><span class="s1">self).__eq__(other) </span><span class="s0">and</span>
                <span class="s1">isinstance(other</span><span class="s0">, </span><span class="s1">_defaultdict) </span><span class="s0">and</span>
                <span class="s1">self.default_factory == other.default_factory)</span>


<span class="s0">class </span><span class="s1">TestDefaultDict(TestDict):</span>
    <span class="s3">&quot;&quot;&quot;Test defaultdict as input and factory 
 
    Class attributes: 
        D: callable that inputs a dict and creates or returns a MutableMapping 
        kw: kwargs dict to specify &quot;factory&quot; keyword (if applicable) 
    &quot;&quot;&quot;</span>
    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">D(dict_):</span>
        <span class="s0">return </span><span class="s1">defaultdict(int</span><span class="s0">, </span><span class="s1">dict_)</span>

    <span class="s1">kw = {</span><span class="s4">'factory'</span><span class="s1">: </span><span class="s0">lambda</span><span class="s1">: defaultdict(int)}</span>


<span class="s0">class </span><span class="s1">CustomMapping(object):</span>
    <span class="s3">&quot;&quot;&quot;Define methods of the MutableMapping protocol required by dicttoolz&quot;&quot;&quot;</span>
    <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self._d = dict(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">key):</span>
        <span class="s0">return </span><span class="s1">self._d[key]</span>

    <span class="s0">def </span><span class="s1">__setitem__(self</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val):</span>
        <span class="s1">self._d[key] = val</span>

    <span class="s0">def </span><span class="s1">__delitem__(self</span><span class="s0">, </span><span class="s1">key):</span>
        <span class="s0">del </span><span class="s1">self._d[key]</span>

    <span class="s0">def </span><span class="s1">__iter__(self):</span>
        <span class="s0">return </span><span class="s1">iter(self._d)</span>

    <span class="s0">def </span><span class="s1">__len__(self):</span>
        <span class="s0">return </span><span class="s1">len(self._d)</span>

    <span class="s0">def </span><span class="s1">__contains__(self</span><span class="s0">, </span><span class="s1">key):</span>
        <span class="s0">return </span><span class="s1">key </span><span class="s0">in </span><span class="s1">self._d</span>

    <span class="s0">def </span><span class="s1">__eq__(self</span><span class="s0">, </span><span class="s1">other):</span>
        <span class="s0">return </span><span class="s1">isinstance(other</span><span class="s0">, </span><span class="s1">CustomMapping) </span><span class="s0">and </span><span class="s1">self._d == other._d</span>

    <span class="s0">def </span><span class="s1">__ne__(self</span><span class="s0">, </span><span class="s1">other):</span>
        <span class="s0">return not </span><span class="s1">isinstance(other</span><span class="s0">, </span><span class="s1">CustomMapping) </span><span class="s0">or </span><span class="s1">self._d != other._d</span>

    <span class="s0">def </span><span class="s1">keys(self):</span>
        <span class="s0">return </span><span class="s1">self._d.keys()</span>

    <span class="s0">def </span><span class="s1">values(self):</span>
        <span class="s0">return </span><span class="s1">self._d.values()</span>

    <span class="s0">def </span><span class="s1">items(self):</span>
        <span class="s0">return </span><span class="s1">self._d.items()</span>

    <span class="s0">def </span><span class="s1">update(self</span><span class="s0">, </span><span class="s1">*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">self._d.update(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s5"># Unused methods that are part of the MutableMapping protocol</span>
    <span class="s5">#def get(self, key, *args):</span>
    <span class="s5">#    return self._d.get(key, *args)</span>

    <span class="s5">#def pop(self, key, *args):</span>
    <span class="s5">#    return self._d.pop(key, *args)</span>

    <span class="s5">#def popitem(self, key):</span>
    <span class="s5">#    return self._d.popitem()</span>

    <span class="s5">#def clear(self):</span>
    <span class="s5">#    self._d.clear()</span>

    <span class="s5">#def setdefault(self, key, *args):</span>
    <span class="s5">#    return self._d.setdefault(self, key, *args)</span>


<span class="s0">class </span><span class="s1">TestCustomMapping(TestDict):</span>
    <span class="s3">&quot;&quot;&quot;Test CustomMapping as input and factory 
 
    Class attributes: 
        D: callable that inputs a dict and creates or returns a MutableMapping 
        kw: kwargs dict to specify &quot;factory&quot; keyword (if applicable) 
    &quot;&quot;&quot;</span>
    <span class="s1">D = CustomMapping</span>
    <span class="s1">kw = {</span><span class="s4">'factory'</span><span class="s1">: </span><span class="s0">lambda</span><span class="s1">: CustomMapping()}</span>


<span class="s0">def </span><span class="s1">test_environ():</span>
    <span class="s5"># See: https://github.com/pytoolz/cytoolz/issues/127</span>
    <span class="s0">assert </span><span class="s1">keymap(identity</span><span class="s0">, </span><span class="s1">os.environ) == os.environ</span>
    <span class="s0">assert </span><span class="s1">valmap(identity</span><span class="s0">, </span><span class="s1">os.environ) == os.environ</span>
    <span class="s0">assert </span><span class="s1">itemmap(identity</span><span class="s0">, </span><span class="s1">os.environ) == os.environ</span>


<span class="s0">def </span><span class="s1">test_merge_with_non_dict_mappings():</span>
    <span class="s0">class </span><span class="s1">Foo(Mapping):</span>
        <span class="s0">def </span><span class="s1">__init__(self</span><span class="s0">, </span><span class="s1">d):</span>
            <span class="s1">self.d = d</span>

        <span class="s0">def </span><span class="s1">__iter__(self):</span>
            <span class="s0">return </span><span class="s1">iter(self.d)</span>

        <span class="s0">def </span><span class="s1">__getitem__(self</span><span class="s0">, </span><span class="s1">key):</span>
            <span class="s0">return </span><span class="s1">self.d[key]</span>

        <span class="s0">def </span><span class="s1">__len__(self):</span>
            <span class="s0">return </span><span class="s1">len(self.d)</span>

    <span class="s1">d = Foo({</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">})</span>

    <span class="s0">assert </span><span class="s1">merge(d) </span><span class="s0">is </span><span class="s1">d </span><span class="s0">or </span><span class="s1">merge(d) == {</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">merge_with(sum</span><span class="s0">, </span><span class="s1">d) == {</span><span class="s2">1</span><span class="s1">: </span><span class="s2">1</span><span class="s1">}</span>
</pre>
</body>
</html>