<html>
<head>
<title>test_svmlight_format.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_svmlight_format.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">gzip</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">shutil</span>
<span class="s0">from </span><span class="s1">bz2 </span><span class="s0">import </span><span class="s1">BZ2File</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span>
<span class="s0">from </span><span class="s1">tempfile </span><span class="s0">import </span><span class="s1">NamedTemporaryFile</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">scipy.sparse </span><span class="s0">as </span><span class="s1">sp</span>

<span class="s0">import </span><span class="s1">sklearn</span>
<span class="s0">from </span><span class="s1">sklearn.datasets </span><span class="s0">import </span><span class="s1">dump_svmlight_file</span><span class="s0">, </span><span class="s1">load_svmlight_file</span><span class="s0">, </span><span class="s1">load_svmlight_files</span>
<span class="s0">from </span><span class="s1">sklearn.utils._testing </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_allclose</span><span class="s0">,</span>
    <span class="s1">assert_array_almost_equal</span><span class="s0">,</span>
    <span class="s1">assert_array_equal</span><span class="s0">,</span>
    <span class="s1">fails_if_pypy</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">sklearn.utils.fixes </span><span class="s0">import </span><span class="s1">_open_binary</span><span class="s0">, </span><span class="s1">_path</span>

<span class="s1">TEST_DATA_MODULE = </span><span class="s2">&quot;sklearn.datasets.tests.data&quot;</span>
<span class="s1">datafile = </span><span class="s2">&quot;svmlight_classification.txt&quot;</span>
<span class="s1">multifile = </span><span class="s2">&quot;svmlight_multilabel.txt&quot;</span>
<span class="s1">invalidfile = </span><span class="s2">&quot;svmlight_invalid.txt&quot;</span>
<span class="s1">invalidfile2 = </span><span class="s2">&quot;svmlight_invalid_order.txt&quot;</span>

<span class="s1">pytestmark = fails_if_pypy</span>


<span class="s0">def </span><span class="s1">_load_svmlight_local_test_file(filename</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s3">&quot;&quot;&quot; 
    Helper to load resource `filename` with `importlib.resources` 
    &quot;&quot;&quot;</span>
    <span class="s0">with </span><span class="s1">_open_binary(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">filename) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">return </span><span class="s1">load_svmlight_file(f</span><span class="s0">, </span><span class="s1">**kwargs)</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_file():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile)</span>

    <span class="s4"># test X's shape</span>
    <span class="s0">assert </span><span class="s1">X.indptr.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">7</span>
    <span class="s0">assert </span><span class="s1">X.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">6</span>
    <span class="s0">assert </span><span class="s1">X.shape[</span><span class="s5">1</span><span class="s1">] == </span><span class="s5">21</span>
    <span class="s0">assert </span><span class="s1">y.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">6</span>

    <span class="s4"># test X's non-zero values</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">(</span>
        <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">2.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s1">-</span><span class="s5">5.2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">15</span><span class="s0">, </span><span class="s5">1.5</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">12</span><span class="s0">, </span><span class="s1">-</span><span class="s5">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">20</span><span class="s0">, </span><span class="s5">27</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">):</span>
        <span class="s0">assert </span><span class="s1">X[i</span><span class="s0">, </span><span class="s1">j] == val</span>

    <span class="s4"># tests X's zero values</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">] == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">] == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">8</span><span class="s1">] == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">16</span><span class="s1">] == </span><span class="s5">0</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">18</span><span class="s1">] == </span><span class="s5">0</span>

    <span class="s4"># test can change X's values</span>
    <span class="s1">X[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s1">] *= </span><span class="s5">2</span>
    <span class="s0">assert </span><span class="s1">X[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s1">] == </span><span class="s5">5</span>

    <span class="s4"># test y</span>
    <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_file_fd():</span>
    <span class="s4"># test loading from file descriptor</span>

    <span class="s4"># GH20081: testing equality between path-based and</span>
    <span class="s4"># fd-based load_svmlight_file</span>
    <span class="s0">with </span><span class="s1">_path(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">data_path:</span>
        <span class="s1">data_path = str(data_path)</span>
        <span class="s1">X1</span><span class="s0">, </span><span class="s1">y1 = load_svmlight_file(data_path)</span>

        <span class="s1">fd = os.open(data_path</span><span class="s0">, </span><span class="s1">os.O_RDONLY)</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(fd)</span>
            <span class="s1">assert_array_almost_equal(X1.data</span><span class="s0">, </span><span class="s1">X2.data)</span>
            <span class="s1">assert_array_almost_equal(y1</span><span class="s0">, </span><span class="s1">y2)</span>
        <span class="s0">finally</span><span class="s1">:</span>
            <span class="s1">os.close(fd)</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_pathlib():</span>
    <span class="s4"># test loading from file descriptor</span>
    <span class="s0">with </span><span class="s1">_path(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">data_path:</span>
        <span class="s1">X1</span><span class="s0">, </span><span class="s1">y1 = load_svmlight_file(str(data_path))</span>
        <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(data_path)</span>

    <span class="s1">assert_allclose(X1.data</span><span class="s0">, </span><span class="s1">X2.data)</span>
    <span class="s1">assert_allclose(y1</span><span class="s0">, </span><span class="s1">y2)</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_file_multilabel():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(multifile</span><span class="s0">, </span><span class="s1">multilabel=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y == [(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">()</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_files():</span>
    <span class="s0">with </span><span class="s1">_path(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">data_path:</span>
        <span class="s1">X_train</span><span class="s0">, </span><span class="s1">y_train</span><span class="s0">, </span><span class="s1">X_test</span><span class="s0">, </span><span class="s1">y_test = load_svmlight_files(</span>
            <span class="s1">[str(data_path)] * </span><span class="s5">2</span><span class="s0">, </span><span class="s1">dtype=np.float32</span>
        <span class="s1">)</span>
    <span class="s1">assert_array_equal(X_train.toarray()</span><span class="s0">, </span><span class="s1">X_test.toarray())</span>
    <span class="s1">assert_array_almost_equal(y_train</span><span class="s0">, </span><span class="s1">y_test)</span>
    <span class="s0">assert </span><span class="s1">X_train.dtype == np.float32</span>
    <span class="s0">assert </span><span class="s1">X_test.dtype == np.float32</span>

    <span class="s0">with </span><span class="s1">_path(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">data_path:</span>
        <span class="s1">X1</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">X2</span><span class="s0">, </span><span class="s1">y2</span><span class="s0">, </span><span class="s1">X3</span><span class="s0">, </span><span class="s1">y3 = load_svmlight_files(</span>
            <span class="s1">[str(data_path)] * </span><span class="s5">3</span><span class="s0">, </span><span class="s1">dtype=np.float64</span>
        <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">X1.dtype == X2.dtype</span>
    <span class="s0">assert </span><span class="s1">X2.dtype == X3.dtype</span>
    <span class="s0">assert </span><span class="s1">X3.dtype == np.float64</span>


<span class="s0">def </span><span class="s1">test_load_svmlight_file_n_features():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile</span><span class="s0">, </span><span class="s1">n_features=</span><span class="s5">22</span><span class="s1">)</span>

    <span class="s4"># test X'shape</span>
    <span class="s0">assert </span><span class="s1">X.indptr.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">7</span>
    <span class="s0">assert </span><span class="s1">X.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">6</span>
    <span class="s0">assert </span><span class="s1">X.shape[</span><span class="s5">1</span><span class="s1">] == </span><span class="s5">22</span>

    <span class="s4"># test X's non-zero values</span>
    <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">((</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">2.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0</span><span class="s0">, </span><span class="s5">10</span><span class="s0">, </span><span class="s1">-</span><span class="s5">5.2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">12</span><span class="s0">, </span><span class="s1">-</span><span class="s5">3</span><span class="s1">)):</span>
        <span class="s0">assert </span><span class="s1">X[i</span><span class="s0">, </span><span class="s1">j] == val</span>

    <span class="s4"># 21 features in file</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">_load_svmlight_local_test_file(datafile</span><span class="s0">, </span><span class="s1">n_features=</span><span class="s5">20</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_load_compressed():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile)</span>

    <span class="s0">with </span><span class="s1">NamedTemporaryFile(prefix=</span><span class="s2">&quot;sklearn-test&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s2">&quot;.gz&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
        <span class="s1">tmp.close()  </span><span class="s4"># necessary under windows</span>
        <span class="s0">with </span><span class="s1">_open_binary(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s0">with </span><span class="s1">gzip.open(tmp.name</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fh_out:</span>
                <span class="s1">shutil.copyfileobj(f</span><span class="s0">, </span><span class="s1">fh_out)</span>
        <span class="s1">Xgz</span><span class="s0">, </span><span class="s1">ygz = load_svmlight_file(tmp.name)</span>
        <span class="s4"># because we &quot;close&quot; it manually and write to it,</span>
        <span class="s4"># we need to remove it manually.</span>
        <span class="s1">os.remove(tmp.name)</span>
    <span class="s1">assert_array_almost_equal(X.toarray()</span><span class="s0">, </span><span class="s1">Xgz.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">ygz)</span>

    <span class="s0">with </span><span class="s1">NamedTemporaryFile(prefix=</span><span class="s2">&quot;sklearn-test&quot;</span><span class="s0">, </span><span class="s1">suffix=</span><span class="s2">&quot;.bz2&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">tmp:</span>
        <span class="s1">tmp.close()  </span><span class="s4"># necessary under windows</span>
        <span class="s0">with </span><span class="s1">_open_binary(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s0">with </span><span class="s1">BZ2File(tmp.name</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fh_out:</span>
                <span class="s1">shutil.copyfileobj(f</span><span class="s0">, </span><span class="s1">fh_out)</span>
        <span class="s1">Xbz</span><span class="s0">, </span><span class="s1">ybz = load_svmlight_file(tmp.name)</span>
        <span class="s4"># because we &quot;close&quot; it manually and write to it,</span>
        <span class="s4"># we need to remove it manually.</span>
        <span class="s1">os.remove(tmp.name)</span>
    <span class="s1">assert_array_almost_equal(X.toarray()</span><span class="s0">, </span><span class="s1">Xbz.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">ybz)</span>


<span class="s0">def </span><span class="s1">test_load_invalid_file():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">_load_svmlight_local_test_file(invalidfile)</span>


<span class="s0">def </span><span class="s1">test_load_invalid_order_file():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">_load_svmlight_local_test_file(invalidfile2)</span>


<span class="s0">def </span><span class="s1">test_load_zero_based():</span>
    <span class="s1">f = BytesIO(</span><span class="s6">b&quot;-1 4:1.</span><span class="s0">\n</span><span class="s6">1 0:1</span><span class="s0">\n</span><span class="s6">&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">load_svmlight_file(f</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_load_zero_based_auto():</span>
    <span class="s1">data1 = </span><span class="s6">b&quot;-1 1:1 2:2 3:3</span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s1">data2 = </span><span class="s6">b&quot;-1 0:0 1:1</span><span class="s0">\n</span><span class="s6">&quot;</span>

    <span class="s1">f1 = BytesIO(data1)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = load_svmlight_file(f1</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">X.shape == (</span><span class="s5">1</span><span class="s0">, </span><span class="s5">3</span><span class="s1">)</span>

    <span class="s1">f1 = BytesIO(data1)</span>
    <span class="s1">f2 = BytesIO(data2)</span>
    <span class="s1">X1</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_files([f1</span><span class="s0">, </span><span class="s1">f2]</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s2">&quot;auto&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">X1.shape == (</span><span class="s5">1</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">X2.shape == (</span><span class="s5">1</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_load_with_qid():</span>
    <span class="s4"># load svmfile with qid attribute</span>
    <span class="s1">data = </span><span class="s6">b&quot;&quot;&quot; 
    3 qid:1 1:0.53 2:0.12 
    2 qid:1 1:0.13 2:0.1 
    7 qid:2 1:0.87 2:0.12&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = load_svmlight_file(BytesIO(data)</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">7</span><span class="s1">])</span>
    <span class="s1">assert_array_equal(X.toarray()</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">0.53</span><span class="s0">, </span><span class="s5">0.12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.13</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.87</span><span class="s0">, </span><span class="s5">0.12</span><span class="s1">]])</span>
    <span class="s1">res1 = load_svmlight_files([BytesIO(data)]</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">res2 = load_svmlight_file(BytesIO(data)</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">qid </span><span class="s0">in </span><span class="s1">(res1</span><span class="s0">, </span><span class="s1">res2):</span>
        <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">7</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(qid</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span>
        <span class="s1">assert_array_equal(X.toarray()</span><span class="s0">, </span><span class="s1">[[</span><span class="s5">0.53</span><span class="s0">, </span><span class="s5">0.12</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.13</span><span class="s0">, </span><span class="s5">0.1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0.87</span><span class="s0">, </span><span class="s5">0.12</span><span class="s1">]])</span>


<span class="s1">@pytest.mark.skip(</span>
    <span class="s2">&quot;testing the overflow of 32 bit sparse indexing requires a large amount of memory&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_load_large_qid():</span>
    <span class="s3">&quot;&quot;&quot; 
    load large libsvm / svmlight file with qid attribute. Tests 64-bit query ID 
    &quot;&quot;&quot;</span>
    <span class="s1">data = </span><span class="s6">b&quot;</span><span class="s0">\n</span><span class="s6">&quot;</span><span class="s1">.join(</span>
        <span class="s1">(</span>
            <span class="s2">&quot;3 qid:{0} 1:0.53 2:0.12</span><span class="s0">\n</span><span class="s2">2 qid:{0} 1:0.13 2:0.1&quot;</span><span class="s1">.format(i).encode()</span>
            <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">40 </span><span class="s1">* </span><span class="s5">1000 </span><span class="s1">* </span><span class="s5">1000</span><span class="s1">)</span>
        <span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">qid = load_svmlight_file(BytesIO(data)</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(y[-</span><span class="s5">4</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span>
    <span class="s1">assert_array_equal(np.unique(qid)</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s5">1</span><span class="s0">, </span><span class="s5">40 </span><span class="s1">* </span><span class="s5">1000 </span><span class="s1">* </span><span class="s5">1000</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_load_invalid_file2():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s0">with </span><span class="s1">_path(TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">datafile) </span><span class="s0">as </span><span class="s1">data_path</span><span class="s0">, </span><span class="s1">_path(</span>
            <span class="s1">TEST_DATA_MODULE</span><span class="s0">, </span><span class="s1">invalidfile</span>
        <span class="s1">) </span><span class="s0">as </span><span class="s1">invalid_path:</span>
            <span class="s1">load_svmlight_files([str(data_path)</span><span class="s0">, </span><span class="s1">str(invalid_path)</span><span class="s0">, </span><span class="s1">str(data_path)])</span>


<span class="s0">def </span><span class="s1">test_not_a_filename():</span>
    <span class="s4"># in python 3 integers are valid file opening arguments (taken as unix</span>
    <span class="s4"># file descriptors)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError):</span>
        <span class="s1">load_svmlight_file(</span><span class="s5">0.42</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_invalid_filename():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(OSError):</span>
        <span class="s1">load_svmlight_file(</span><span class="s2">&quot;trou pic nic douille&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_dump():</span>
    <span class="s1">X_sparse</span><span class="s0">, </span><span class="s1">y_dense = _load_svmlight_local_test_file(datafile)</span>
    <span class="s1">X_dense = X_sparse.toarray()</span>
    <span class="s1">y_sparse = sp.csr_matrix(y_dense)</span>

    <span class="s4"># slicing a csr_matrix can unsort its .indices, so test that we sort</span>
    <span class="s4"># those correctly</span>
    <span class="s1">X_sliced = X_sparse[np.arange(X_sparse.shape[</span><span class="s5">0</span><span class="s1">])]</span>
    <span class="s1">y_sliced = y_sparse[np.arange(y_sparse.shape[</span><span class="s5">0</span><span class="s1">])]</span>

    <span class="s0">for </span><span class="s1">X </span><span class="s0">in </span><span class="s1">(X_sparse</span><span class="s0">, </span><span class="s1">X_dense</span><span class="s0">, </span><span class="s1">X_sliced):</span>
        <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">(y_sparse</span><span class="s0">, </span><span class="s1">y_dense</span><span class="s0">, </span><span class="s1">y_sliced):</span>
            <span class="s0">for </span><span class="s1">zero_based </span><span class="s0">in </span><span class="s1">(</span><span class="s0">True, False</span><span class="s1">):</span>
                <span class="s0">for </span><span class="s1">dtype </span><span class="s0">in </span><span class="s1">[np.float32</span><span class="s0">, </span><span class="s1">np.float64</span><span class="s0">, </span><span class="s1">np.int32</span><span class="s0">, </span><span class="s1">np.int64]:</span>
                    <span class="s1">f = BytesIO()</span>
                    <span class="s4"># we need to pass a comment to get the version info in;</span>
                    <span class="s4"># LibSVM doesn't grok comments so they're not put in by</span>
                    <span class="s4"># default anymore.</span>

                    <span class="s0">if </span><span class="s1">sp.issparse(y) </span><span class="s0">and </span><span class="s1">y.shape[</span><span class="s5">0</span><span class="s1">] == </span><span class="s5">1</span><span class="s1">:</span>
                        <span class="s4"># make sure y's shape is: (n_samples, n_labels)</span>
                        <span class="s4"># when it is sparse</span>
                        <span class="s1">y = y.T</span>

                    <span class="s4"># Note: with dtype=np.int32 we are performing unsafe casts,</span>
                    <span class="s4"># where X.astype(dtype) overflows. The result is</span>
                    <span class="s4"># then platform dependent and X_dense.astype(dtype) may be</span>
                    <span class="s4"># different from X_sparse.astype(dtype).asarray().</span>
                    <span class="s1">X_input = X.astype(dtype)</span>

                    <span class="s1">dump_svmlight_file(</span>
                        <span class="s1">X_input</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">comment=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">zero_based=zero_based</span>
                    <span class="s1">)</span>
                    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>

                    <span class="s1">comment = f.readline()</span>
                    <span class="s1">comment = str(comment</span><span class="s0">, </span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>

                    <span class="s0">assert </span><span class="s2">&quot;scikit-learn %s&quot; </span><span class="s1">% sklearn.__version__ </span><span class="s0">in </span><span class="s1">comment</span>

                    <span class="s1">comment = f.readline()</span>
                    <span class="s1">comment = str(comment</span><span class="s0">, </span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>

                    <span class="s0">assert </span><span class="s1">[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;zero&quot;</span><span class="s1">][zero_based] + </span><span class="s2">&quot;-based&quot; </span><span class="s0">in </span><span class="s1">comment</span>

                    <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">dtype=dtype</span><span class="s0">, </span><span class="s1">zero_based=zero_based)</span>
                    <span class="s0">assert </span><span class="s1">X2.dtype == dtype</span>
                    <span class="s1">assert_array_equal(X2.sorted_indices().indices</span><span class="s0">, </span><span class="s1">X2.indices)</span>

                    <span class="s1">X2_dense = X2.toarray()</span>
                    <span class="s0">if </span><span class="s1">sp.issparse(X_input):</span>
                        <span class="s1">X_input_dense = X_input.toarray()</span>
                    <span class="s0">else</span><span class="s1">:</span>
                        <span class="s1">X_input_dense = X_input</span>

                    <span class="s0">if </span><span class="s1">dtype == np.float32:</span>
                        <span class="s4"># allow a rounding error at the last decimal place</span>
                        <span class="s1">assert_array_almost_equal(X_input_dense</span><span class="s0">, </span><span class="s1">X2_dense</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)</span>
                        <span class="s1">assert_array_almost_equal(</span>
                            <span class="s1">y_dense.astype(dtype</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y2</span><span class="s0">, </span><span class="s5">4</span>
                        <span class="s1">)</span>
                    <span class="s0">else</span><span class="s1">:</span>
                        <span class="s4"># allow a rounding error at the last decimal place</span>
                        <span class="s1">assert_array_almost_equal(X_input_dense</span><span class="s0">, </span><span class="s1">X2_dense</span><span class="s0">, </span><span class="s5">15</span><span class="s1">)</span>
                        <span class="s1">assert_array_almost_equal(</span>
                            <span class="s1">y_dense.astype(dtype</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y2</span><span class="s0">, </span><span class="s5">15</span>
                        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_dump_multilabel():</span>
    <span class="s1">X = [[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]]</span>
    <span class="s1">y_dense = [[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]]</span>
    <span class="s1">y_sparse = sp.csr_matrix(y_dense)</span>
    <span class="s0">for </span><span class="s1">y </span><span class="s0">in </span><span class="s1">[y_dense</span><span class="s0">, </span><span class="s1">y_sparse]:</span>
        <span class="s1">f = BytesIO()</span>
        <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">multilabel=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s4"># make sure it dumps multilabel correctly</span>
        <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;1 0:1 2:3 4:5</span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;0,2 </span><span class="s0">\n</span><span class="s6">&quot;</span>
        <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;0,1 1:5 3:1</span><span class="s0">\n</span><span class="s6">&quot;</span>


<span class="s0">def </span><span class="s1">test_dump_concise():</span>
    <span class="s1">one = </span><span class="s5">1</span>
    <span class="s1">two = </span><span class="s5">2.1</span>
    <span class="s1">three = </span><span class="s5">3.01</span>
    <span class="s1">exact = </span><span class="s5">1.000000000000001</span>
    <span class="s4"># loses the last decimal place</span>
    <span class="s1">almost = </span><span class="s5">1.0000000000000001</span>
    <span class="s1">X = [</span>
        <span class="s1">[one</span><span class="s0">, </span><span class="s1">two</span><span class="s0">, </span><span class="s1">three</span><span class="s0">, </span><span class="s1">exact</span><span class="s0">, </span><span class="s1">almost]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">1e9</span><span class="s0">, </span><span class="s5">2e18</span><span class="s0">, </span><span class="s5">3e27</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s1">y = [one</span><span class="s0">, </span><span class="s1">two</span><span class="s0">, </span><span class="s1">three</span><span class="s0">, </span><span class="s1">exact</span><span class="s0">, </span><span class="s1">almost]</span>
    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s4"># make sure it's using the most concise format possible</span>
    <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;1 0:1 1:2.1 2:3.01 3:1.000000000000001 4:1</span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;2.1 0:1000000000 1:2e+18 2:3e+27</span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;3.01 </span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;1.000000000000001 </span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s0">assert </span><span class="s1">f.readline() == </span><span class="s6">b&quot;1 </span><span class="s0">\n</span><span class="s6">&quot;</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s4"># make sure it's correct too :)</span>
    <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(f)</span>
    <span class="s1">assert_array_almost_equal(X</span><span class="s0">, </span><span class="s1">X2.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y2)</span>


<span class="s0">def </span><span class="s1">test_dump_comment():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile)</span>
    <span class="s1">X = X.toarray()</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">ascii_comment = </span><span class="s2">&quot;This is a comment</span><span class="s0">\n</span><span class="s2">spanning multiple lines.&quot;</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">comment=ascii_comment</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(X</span><span class="s0">, </span><span class="s1">X2.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y2)</span>

    <span class="s4"># XXX we have to update this to support Python 3.x</span>
    <span class="s1">utf8_comment = </span><span class="s6">b&quot;It is true that</span><span class="s0">\n\xc2\xbd\xc2\xb2 </span><span class="s6">= </span><span class="s0">\xc2\xbc</span><span class="s6">&quot;</span>
    <span class="s1">f = BytesIO()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(UnicodeDecodeError):</span>
        <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">comment=utf8_comment)</span>

    <span class="s1">unicode_comment = utf8_comment.decode(</span><span class="s2">&quot;utf-8&quot;</span><span class="s1">)</span>
    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">comment=unicode_comment</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">X2</span><span class="s0">, </span><span class="s1">y2 = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(X</span><span class="s0">, </span><span class="s1">X2.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y2)</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">comment=</span><span class="s2">&quot;I've got a </span><span class="s0">\0</span><span class="s2">.&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_dump_invalid():</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile)</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">y2d = [y]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y2d</span><span class="s0">, </span><span class="s1">f)</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y[:-</span><span class="s5">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">f)</span>


<span class="s0">def </span><span class="s1">test_dump_query_id():</span>
    <span class="s4"># test dumping a file with query_id</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = _load_svmlight_local_test_file(datafile)</span>
    <span class="s1">X = X.toarray()</span>
    <span class="s1">query_id = np.arange(X.shape[</span><span class="s5">0</span><span class="s1">]) // </span><span class="s5">2</span>
    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">query_id=query_id</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">X1</span><span class="s0">, </span><span class="s1">y1</span><span class="s0">, </span><span class="s1">query_id1 = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True, </span><span class="s1">zero_based=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(X</span><span class="s0">, </span><span class="s1">X1.toarray())</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y1)</span>
    <span class="s1">assert_array_almost_equal(query_id</span><span class="s0">, </span><span class="s1">query_id1)</span>


<span class="s0">def </span><span class="s1">test_load_with_long_qid():</span>
    <span class="s4"># load svmfile with longint qid attribute</span>
    <span class="s1">data = </span><span class="s6">b&quot;&quot;&quot; 
    1 qid:0 0:1 1:2 2:3 
    0 qid:72048431380967004 0:1440446648 1:72048431380967004 2:236784985 
    0 qid:-9223372036854775807 0:1440446648 1:72048431380967004 2:236784985 
    3 qid:9223372036854775807  0:1440446648 1:72048431380967004 2:236784985&quot;&quot;&quot;</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">qid = load_svmlight_file(BytesIO(data)</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">true_X = [</span>
        <span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">1440446648</span><span class="s0">, </span><span class="s5">72048431380967004</span><span class="s0">, </span><span class="s5">236784985</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">1440446648</span><span class="s0">, </span><span class="s5">72048431380967004</span><span class="s0">, </span><span class="s5">236784985</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s5">1440446648</span><span class="s0">, </span><span class="s5">72048431380967004</span><span class="s0">, </span><span class="s5">236784985</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span>

    <span class="s1">true_y = [</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span>
    <span class="s1">trueQID = [</span><span class="s5">0</span><span class="s0">, </span><span class="s5">72048431380967004</span><span class="s0">, </span><span class="s1">-</span><span class="s5">9223372036854775807</span><span class="s0">, </span><span class="s5">9223372036854775807</span><span class="s1">]</span>
    <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">true_y)</span>
    <span class="s1">assert_array_equal(X.toarray()</span><span class="s0">, </span><span class="s1">true_X)</span>
    <span class="s1">assert_array_equal(qid</span><span class="s0">, </span><span class="s1">trueQID)</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">query_id=qid</span><span class="s0">, </span><span class="s1">zero_based=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">qid = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True, </span><span class="s1">zero_based=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">true_y)</span>
    <span class="s1">assert_array_equal(X.toarray()</span><span class="s0">, </span><span class="s1">true_X)</span>
    <span class="s1">assert_array_equal(qid</span><span class="s0">, </span><span class="s1">trueQID)</span>

    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">X</span><span class="s0">, </span><span class="s1">y = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">False, </span><span class="s1">zero_based=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_array_equal(y</span><span class="s0">, </span><span class="s1">true_y)</span>
    <span class="s1">assert_array_equal(X.toarray()</span><span class="s0">, </span><span class="s1">true_X)</span>


<span class="s0">def </span><span class="s1">test_load_zeros():</span>
    <span class="s1">f = BytesIO()</span>
    <span class="s1">true_X = sp.csr_matrix(np.zeros(shape=(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">)))</span>
    <span class="s1">true_y = np.array([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">dump_svmlight_file(true_X</span><span class="s0">, </span><span class="s1">true_y</span><span class="s0">, </span><span class="s1">f)</span>

    <span class="s0">for </span><span class="s1">zero_based </span><span class="s0">in </span><span class="s1">[</span><span class="s2">&quot;auto&quot;</span><span class="s0">, True, False</span><span class="s1">]:</span>
        <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">X</span><span class="s0">, </span><span class="s1">y = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">n_features=</span><span class="s5">4</span><span class="s0">, </span><span class="s1">zero_based=zero_based)</span>
        <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">true_y)</span>
        <span class="s1">assert_array_almost_equal(X.toarray()</span><span class="s0">, </span><span class="s1">true_X.toarray())</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;sparsity&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0.1</span><span class="s0">, </span><span class="s5">0.5</span><span class="s0">, </span><span class="s5">0.99</span><span class="s0">, </span><span class="s5">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n_samples&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s5">13</span><span class="s0">, </span><span class="s5">101</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n_features&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s5">2</span><span class="s0">, </span><span class="s5">7</span><span class="s0">, </span><span class="s5">41</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_load_with_offsets(sparsity</span><span class="s0">, </span><span class="s1">n_samples</span><span class="s0">, </span><span class="s1">n_features):</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">X = rng.uniform(low=</span><span class="s5">0.0</span><span class="s0">, </span><span class="s1">high=</span><span class="s5">1.0</span><span class="s0">, </span><span class="s1">size=(n_samples</span><span class="s0">, </span><span class="s1">n_features))</span>
    <span class="s0">if </span><span class="s1">sparsity:</span>
        <span class="s1">X[X &lt; sparsity] = </span><span class="s5">0.0</span>
    <span class="s1">X = sp.csr_matrix(X)</span>
    <span class="s1">y = rng.randint(low=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">high=</span><span class="s5">2</span><span class="s0">, </span><span class="s1">size=n_samples)</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">size = len(f.getvalue())</span>

    <span class="s4"># put some marks that are likely to happen anywhere in a row</span>
    <span class="s1">mark_0 = </span><span class="s5">0</span>
    <span class="s1">mark_1 = size // </span><span class="s5">3</span>
    <span class="s1">length_0 = mark_1 - mark_0</span>
    <span class="s1">mark_2 = </span><span class="s5">4 </span><span class="s1">* size // </span><span class="s5">5</span>
    <span class="s1">length_1 = mark_2 - mark_1</span>

    <span class="s4"># load the original sparse matrix into 3 independent CSR matrices</span>
    <span class="s1">X_0</span><span class="s0">, </span><span class="s1">y_0 = load_svmlight_file(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s1">n_features=n_features</span><span class="s0">, </span><span class="s1">offset=mark_0</span><span class="s0">, </span><span class="s1">length=length_0</span>
    <span class="s1">)</span>
    <span class="s1">X_1</span><span class="s0">, </span><span class="s1">y_1 = load_svmlight_file(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s1">n_features=n_features</span><span class="s0">, </span><span class="s1">offset=mark_1</span><span class="s0">, </span><span class="s1">length=length_1</span>
    <span class="s1">)</span>
    <span class="s1">X_2</span><span class="s0">, </span><span class="s1">y_2 = load_svmlight_file(f</span><span class="s0">, </span><span class="s1">n_features=n_features</span><span class="s0">, </span><span class="s1">offset=mark_2)</span>

    <span class="s1">y_concat = np.concatenate([y_0</span><span class="s0">, </span><span class="s1">y_1</span><span class="s0">, </span><span class="s1">y_2])</span>
    <span class="s1">X_concat = sp.vstack([X_0</span><span class="s0">, </span><span class="s1">X_1</span><span class="s0">, </span><span class="s1">X_2])</span>
    <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y_concat)</span>
    <span class="s1">assert_array_almost_equal(X.toarray()</span><span class="s0">, </span><span class="s1">X_concat.toarray())</span>


<span class="s0">def </span><span class="s1">test_load_offset_exhaustive_splits():</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s5">0</span><span class="s1">)</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">X = sp.csr_matrix(X)</span>
    <span class="s1">n_samples</span><span class="s0">, </span><span class="s1">n_features = X.shape</span>
    <span class="s1">y = rng.randint(low=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">high=</span><span class="s5">2</span><span class="s0">, </span><span class="s1">size=n_samples)</span>
    <span class="s1">query_id = np.arange(n_samples) // </span><span class="s5">2</span>

    <span class="s1">f = BytesIO()</span>
    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">query_id=query_id)</span>
    <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>

    <span class="s1">size = len(f.getvalue())</span>

    <span class="s4"># load the same data in 2 parts with all the possible byte offsets to</span>
    <span class="s4"># locate the split so has to test for particular boundary cases</span>
    <span class="s0">for </span><span class="s1">mark </span><span class="s0">in </span><span class="s1">range(size):</span>
        <span class="s1">f.seek(</span><span class="s5">0</span><span class="s1">)</span>
        <span class="s1">X_0</span><span class="s0">, </span><span class="s1">y_0</span><span class="s0">, </span><span class="s1">q_0 = load_svmlight_file(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">n_features=n_features</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True, </span><span class="s1">offset=</span><span class="s5">0</span><span class="s0">, </span><span class="s1">length=mark</span>
        <span class="s1">)</span>
        <span class="s1">X_1</span><span class="s0">, </span><span class="s1">y_1</span><span class="s0">, </span><span class="s1">q_1 = load_svmlight_file(</span>
            <span class="s1">f</span><span class="s0">, </span><span class="s1">n_features=n_features</span><span class="s0">, </span><span class="s1">query_id=</span><span class="s0">True, </span><span class="s1">offset=mark</span><span class="s0">, </span><span class="s1">length=-</span><span class="s5">1</span>
        <span class="s1">)</span>
        <span class="s1">q_concat = np.concatenate([q_0</span><span class="s0">, </span><span class="s1">q_1])</span>
        <span class="s1">y_concat = np.concatenate([y_0</span><span class="s0">, </span><span class="s1">y_1])</span>
        <span class="s1">X_concat = sp.vstack([X_0</span><span class="s0">, </span><span class="s1">X_1])</span>
        <span class="s1">assert_array_almost_equal(y</span><span class="s0">, </span><span class="s1">y_concat)</span>
        <span class="s1">assert_array_equal(query_id</span><span class="s0">, </span><span class="s1">q_concat)</span>
        <span class="s1">assert_array_almost_equal(X.toarray()</span><span class="s0">, </span><span class="s1">X_concat.toarray())</span>


<span class="s0">def </span><span class="s1">test_load_with_offsets_error():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;n_features is required&quot;</span><span class="s1">):</span>
        <span class="s1">_load_svmlight_local_test_file(datafile</span><span class="s0">, </span><span class="s1">offset=</span><span class="s5">3</span><span class="s0">, </span><span class="s1">length=</span><span class="s5">3</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_multilabel_y_explicit_zeros(tmp_path):</span>
    <span class="s3">&quot;&quot;&quot; 
    Ensure that if y contains explicit zeros (i.e. elements of y.data equal to 
    0) then those explicit zeros are not encoded. 
    &quot;&quot;&quot;</span>
    <span class="s1">save_path = str(tmp_path / </span><span class="s2">&quot;svm_explicit_zero&quot;</span><span class="s1">)</span>
    <span class="s1">rng = np.random.RandomState(</span><span class="s5">42</span><span class="s1">)</span>
    <span class="s1">X = rng.randn(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s1">).astype(np.float64)</span>
    <span class="s1">indptr = np.array([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">6</span><span class="s1">])</span>
    <span class="s1">indices = np.array([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s1">])</span>
    <span class="s4"># The first and last element are explicit zeros.</span>
    <span class="s1">data = np.array([</span><span class="s5">0</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">0</span><span class="s1">])</span>
    <span class="s1">y = sp.csr_matrix((data</span><span class="s0">, </span><span class="s1">indices</span><span class="s0">, </span><span class="s1">indptr)</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">3</span><span class="s1">))</span>
    <span class="s4"># y as a dense array would look like</span>
    <span class="s4"># [[0, 0, 1],</span>
    <span class="s4">#  [0, 0, 1],</span>
    <span class="s4">#  [1, 1, 0]]</span>

    <span class="s1">dump_svmlight_file(X</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">save_path</span><span class="s0">, </span><span class="s1">multilabel=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">_</span><span class="s0">, </span><span class="s1">y_load = load_svmlight_file(save_path</span><span class="s0">, </span><span class="s1">multilabel=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">y_true = [(</span><span class="s5">2.0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2.0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s5">0.0</span><span class="s0">, </span><span class="s5">1.0</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">y_load == y_true</span>
</pre>
</body>
</html>