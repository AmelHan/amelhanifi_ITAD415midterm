<html>
<head>
<title>test_demo.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_demo.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.dataframe </span><span class="s0">as </span><span class="s1">dd</span>
<span class="s0">from </span><span class="s1">dask.blockwise </span><span class="s0">import </span><span class="s1">Blockwise</span><span class="s0">, </span><span class="s1">optimize_blockwise</span>
<span class="s0">from </span><span class="s1">dask.dataframe._compat </span><span class="s0">import </span><span class="s1">PANDAS_GE_200</span><span class="s0">, </span><span class="s1">PANDAS_GE_220</span><span class="s0">, </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">dask.dataframe.optimize </span><span class="s0">import </span><span class="s1">optimize_dataframe_getitem</span>
<span class="s0">from </span><span class="s1">dask.dataframe.utils </span><span class="s0">import </span><span class="s1">assert_eq</span><span class="s0">, </span><span class="s1">get_string_dtype</span>

<span class="s1">ME = </span><span class="s2">&quot;ME&quot; </span><span class="s0">if </span><span class="s1">PANDAS_GE_220 </span><span class="s0">else </span><span class="s2">&quot;M&quot;</span>


<span class="s0">def </span><span class="s1">test_make_timeseries():</span>
    <span class="s1">df = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">df.divisions[</span><span class="s3">0</span><span class="s1">] == pd.Timestamp(</span><span class="s2">&quot;2000-01-31&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">df.divisions[-</span><span class="s3">1</span><span class="s1">] == pd.Timestamp(</span><span class="s2">&quot;2014-07-31&quot;</span><span class="s1">)</span>
    <span class="s1">tm.assert_index_equal(df.columns</span><span class="s0">, </span><span class="s1">pd.Index([</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]))</span>
    <span class="s0">assert </span><span class="s1">df[</span><span class="s2">&quot;A&quot;</span><span class="s1">].head().dtype == float</span>
    <span class="s0">assert </span><span class="s1">df[</span><span class="s2">&quot;B&quot;</span><span class="s1">].head().dtype == int</span>
    <span class="s0">assert </span><span class="s1">df[</span><span class="s2">&quot;C&quot;</span><span class="s1">].head().dtype == get_string_dtype()</span>
    <span class="s0">assert </span><span class="s1">df.index.name == </span><span class="s2">&quot;timestamp&quot;</span>
    <span class="s0">assert </span><span class="s1">df.head().index.name == df.index.name</span>
    <span class="s0">assert </span><span class="s1">df.divisions == tuple(pd.date_range(start=</span><span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s1">end=</span><span class="s2">&quot;2015&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s1">))</span>

    <span class="s1">tm.assert_frame_equal(df.head()</span><span class="s0">, </span><span class="s1">df.head())</span>

    <span class="s1">a = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">seed=</span><span class="s3">123</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">b = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">seed=</span><span class="s3">123</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">c = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">seed=</span><span class="s3">456</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">d = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;2D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;3</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">seed=</span><span class="s3">123</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">e = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2015&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;1D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">seed=</span><span class="s3">123</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(a.head()</span><span class="s0">, </span><span class="s1">b.head())</span>
    <span class="s0">assert not </span><span class="s1">(a.head(</span><span class="s3">10</span><span class="s1">) == c.head(</span><span class="s3">10</span><span class="s1">)).all().all()</span>
    <span class="s0">assert </span><span class="s1">a._name == b._name</span>
    <span class="s0">assert </span><span class="s1">a._name != c._name</span>
    <span class="s0">assert </span><span class="s1">a._name != d._name</span>
    <span class="s0">assert </span><span class="s1">a._name != e._name</span>


<span class="s0">def </span><span class="s1">test_make_timeseries_no_args():</span>
    <span class="s1">df = dd.demo.make_timeseries()</span>
    <span class="s0">assert </span><span class="s3">1 </span><span class="s1">&lt; df.npartitions &lt; </span><span class="s3">1000</span>
    <span class="s0">assert </span><span class="s1">len(df.columns) &gt; </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">len(set(df.dtypes)) &gt; </span><span class="s3">1</span>


<span class="s1">@pytest.mark.skip_with_pyarrow_strings  </span><span class="s4"># checks graph layers</span>
<span class="s0">def </span><span class="s1">test_make_timeseries_blockwise():</span>
    <span class="s1">df = dd.demo.make_timeseries()</span>
    <span class="s1">df = df[[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">]]</span>
    <span class="s1">keys = [(df._name</span><span class="s0">, </span><span class="s1">i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(df.npartitions)]</span>

    <span class="s4"># Check that `optimize_dataframe_getitem` changes the</span>
    <span class="s4"># `columns` attribute of the &quot;make-timeseries&quot; layer</span>
    <span class="s1">graph = optimize_dataframe_getitem(df.__dask_graph__()</span><span class="s0">, </span><span class="s1">keys)</span>
    <span class="s1">key = [k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">graph.layers.keys() </span><span class="s0">if </span><span class="s1">k.startswith(</span><span class="s2">&quot;make-timeseries-&quot;</span><span class="s1">)][</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">set(graph.layers[key].columns) == {</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">}</span>

    <span class="s4"># Check that `optimize_blockwise` fuses both</span>
    <span class="s4"># `Blockwise` layers together into a singe `Blockwise` layer</span>
    <span class="s1">graph = optimize_blockwise(df.__dask_graph__()</span><span class="s0">, </span><span class="s1">keys)</span>
    <span class="s1">layers = graph.layers</span>
    <span class="s1">name = list(layers.keys())[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">len(layers) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">isinstance(layers[name]</span><span class="s0">, </span><span class="s1">Blockwise)</span>


<span class="s0">def </span><span class="s1">test_no_overlaps():</span>
    <span class="s1">df = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">, </span><span class="s2">&quot;2001&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: float}</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;3h&quot;</span><span class="s0">, </span><span class="s1">partition_freq=</span><span class="s2">f&quot;3</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">all(</span>
        <span class="s1">df.get_partition(i).index.max().compute()</span>
        <span class="s1">&lt; df.get_partition(i + </span><span class="s3">1</span><span class="s1">).index.min().compute()</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(df.npartitions - </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_make_timeseries_keywords():</span>
    <span class="s1">df = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2001&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;1D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">A_lam=</span><span class="s3">1000000</span><span class="s0">,</span>
        <span class="s1">B_lam=</span><span class="s3">2</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a_cardinality = df.A.nunique()</span>
    <span class="s1">b_cardinality = df.B.nunique()</span>

    <span class="s1">aa</span><span class="s0">, </span><span class="s1">bb = dask.compute(a_cardinality</span><span class="s0">, </span><span class="s1">b_cardinality</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s3">100 </span><span class="s1">&lt; aa &lt;= </span><span class="s3">10000000</span>
    <span class="s0">assert </span><span class="s3">1 </span><span class="s1">&lt; bb &lt;= </span><span class="s3">100</span>


<span class="s0">def </span><span class="s1">test_make_timeseries_fancy_keywords():</span>
    <span class="s1">df = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2000&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;2001&quot;</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;A_B&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;B_&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: str}</span><span class="s0">,</span>
        <span class="s1">freq=</span><span class="s2">&quot;1D&quot;</span><span class="s0">,</span>
        <span class="s1">partition_freq=</span><span class="s2">f&quot;6</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">,</span>
        <span class="s1">A_B_lam=</span><span class="s3">1000000</span><span class="s0">,</span>
        <span class="s1">B__lam=</span><span class="s3">2</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">a_cardinality = df.A_B.nunique()</span>
    <span class="s1">b_cardinality = df.B_.nunique()</span>

    <span class="s1">aa</span><span class="s0">, </span><span class="s1">bb = dask.compute(a_cardinality</span><span class="s0">, </span><span class="s1">b_cardinality</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;single-threaded&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s3">100 </span><span class="s1">&lt; aa &lt;= </span><span class="s3">10000000</span>
    <span class="s0">assert </span><span class="s3">1 </span><span class="s1">&lt; bb &lt;= </span><span class="s3">100</span>


<span class="s0">def </span><span class="s1">test_make_timeseries_getitem_compute():</span>
    <span class="s4"># See https://github.com/dask/dask/issues/7692</span>

    <span class="s1">df = dd.demo.make_timeseries()</span>
    <span class="s1">df2 = df[df.y &gt; </span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">df3 = df2.compute()</span>
    <span class="s0">assert </span><span class="s1">df3[</span><span class="s2">&quot;y&quot;</span><span class="s1">].min() &gt; </span><span class="s3">0</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == list(df3.columns)</span>


<span class="s0">def </span><span class="s1">test_make_timeseries_column_projection():</span>
    <span class="s1">ddf = dd.demo.make_timeseries(</span>
        <span class="s2">&quot;2001&quot;</span><span class="s0">, </span><span class="s2">&quot;2002&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1D&quot;</span><span class="s0">, </span><span class="s1">partition_freq=</span><span class="s2">f&quot;3</span><span class="s0">{</span><span class="s1">ME</span><span class="s0">}</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s1">seed=</span><span class="s3">42</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(ddf[[</span><span class="s2">&quot;x&quot;</span><span class="s1">]].compute()</span><span class="s0">, </span><span class="s1">ddf.compute()[[</span><span class="s2">&quot;x&quot;</span><span class="s1">]])</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">ddf.groupby(</span><span class="s2">&quot;name&quot;</span><span class="s1">).aggregate({</span><span class="s2">&quot;x&quot;</span><span class="s1">: </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: </span><span class="s2">&quot;max&quot;</span><span class="s1">}).compute()</span><span class="s0">,</span>
        <span class="s1">ddf.compute().groupby(</span><span class="s2">&quot;name&quot;</span><span class="s1">).aggregate({</span><span class="s2">&quot;x&quot;</span><span class="s1">: </span><span class="s2">&quot;sum&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: </span><span class="s2">&quot;max&quot;</span><span class="s1">})</span><span class="s0">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">42</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_with_spec(seed):</span>
    <span class="s5">&quot;&quot;&quot;Make a dataset with default random columns&quot;&quot;&quot;</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(nrecords=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=seed)</span>
    <span class="s0">assert </span><span class="s1">isinstance(ddf</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">ddf.npartitions == </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">ddf.columns.tolist() == [</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;f1&quot;</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s2">&quot;s1&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;i1&quot;</span><span class="s1">].dtype == </span><span class="s2">&quot;int64&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;f1&quot;</span><span class="s1">].dtype == float</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;c1&quot;</span><span class="s1">].dtype.name == </span><span class="s2">&quot;category&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;s1&quot;</span><span class="s1">].dtype == get_string_dtype()</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">assert </span><span class="s1">len(res) == </span><span class="s3">10</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">42</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_with_spec_non_default(seed):</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">(</span>
        <span class="s1">ColumnSpec</span><span class="s0">,</span>
        <span class="s1">DatasetSpec</span><span class="s0">,</span>
        <span class="s1">RangeIndexSpec</span><span class="s0">,</span>
        <span class="s1">with_spec</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">10</span><span class="s0">,</span>
        <span class="s1">index_spec=RangeIndexSpec(dtype=</span><span class="s2">&quot;int32&quot;</span><span class="s0">, </span><span class="s1">step=</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int32&quot;</span><span class="s0">, </span><span class="s1">low=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">high=</span><span class="s3">100</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;float32&quot;</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;category&quot;</span><span class="s0">, </span><span class="s1">choices=[</span><span class="s2">&quot;apple&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s1">])</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;s&quot;</span><span class="s0">, </span><span class="s1">dtype=str</span><span class="s0">, </span><span class="s1">length=</span><span class="s3">15</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=seed)</span>
    <span class="s0">assert </span><span class="s1">isinstance(ddf</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">ddf.columns.tolist() == [</span><span class="s2">&quot;i1&quot;</span><span class="s0">, </span><span class="s2">&quot;f1&quot;</span><span class="s0">, </span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s2">&quot;s1&quot;</span><span class="s1">]</span>
    <span class="s0">if </span><span class="s1">PANDAS_GE_200:</span>
        <span class="s0">assert </span><span class="s1">ddf.index.dtype == </span><span class="s2">&quot;int32&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;i1&quot;</span><span class="s1">].dtype == </span><span class="s2">&quot;int32&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;f1&quot;</span><span class="s1">].dtype == </span><span class="s2">&quot;float32&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;c1&quot;</span><span class="s1">].dtype.name == </span><span class="s2">&quot;category&quot;</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;s1&quot;</span><span class="s1">].dtype == get_string_dtype()</span>
    <span class="s1">res = ddf.compute().sort_index()</span>
    <span class="s0">assert </span><span class="s1">len(res) == </span><span class="s3">10</span>
    <span class="s0">assert </span><span class="s1">set(res.c1.cat.categories) == {</span><span class="s2">&quot;apple&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">res.i1.min() &gt;= </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">res.i1.max() &lt;= </span><span class="s3">100</span>
    <span class="s0">assert </span><span class="s1">all(len(s) == </span><span class="s3">15 </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">res.s1.tolist())</span>
    <span class="s0">assert </span><span class="s1">len(res.s1.unique()) &lt;= </span><span class="s3">10</span>


<span class="s0">def </span><span class="s1">test_with_spec_pyarrow():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;pyarrow&quot;</span><span class="s0">, </span><span class="s2">&quot;1.0.0&quot;</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;pyarrow is required&quot;</span><span class="s1">)</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">ColumnSpec</span><span class="s0">, </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">10</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(dtype=</span><span class="s2">&quot;string[pyarrow]&quot;</span><span class="s0">, </span><span class="s1">length=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(ddf</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">ddf.columns.tolist() == [</span><span class="s2">&quot;string_pyarrow1&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">ddf[</span><span class="s2">&quot;string_pyarrow1&quot;</span><span class="s1">].dtype == </span><span class="s2">&quot;string[pyarrow]&quot;</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;string_pyarrow1&quot;</span><span class="s1">].dtype == </span><span class="s2">&quot;string[pyarrow]&quot;</span>
    <span class="s0">assert </span><span class="s1">all(len(s) == </span><span class="s3">10 </span><span class="s0">for </span><span class="s1">s </span><span class="s0">in </span><span class="s1">res[</span><span class="s2">&quot;string_pyarrow1&quot;</span><span class="s1">].tolist())</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">42</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_same_prefix_col_numbering(seed):</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">ColumnSpec</span><span class="s0">, </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=seed)</span>
    <span class="s0">assert </span><span class="s1">ddf.columns.tolist() == [</span><span class="s2">&quot;int1&quot;</span><span class="s0">, </span><span class="s2">&quot;int2&quot;</span><span class="s0">, </span><span class="s2">&quot;int3&quot;</span><span class="s0">, </span><span class="s2">&quot;int4&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_with_spec_category_nunique():</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">ColumnSpec</span><span class="s0">, </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">20</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(dtype=</span><span class="s2">&quot;category&quot;</span><span class="s0">, </span><span class="s1">nunique=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">assert </span><span class="s1">res.category1.cat.categories.tolist() == [</span>
        <span class="s2">&quot;01&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;02&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;03&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;04&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;05&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;06&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;07&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;08&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;09&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;10&quot;</span><span class="s0">,</span>
    <span class="s1">]</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;seed&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">42</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_with_spec_default_integer(seed):</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">ColumnSpec</span><span class="s0">, </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(dtype=int)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=seed)</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">for </span><span class="s1">col </span><span class="s0">in </span><span class="s1">res.columns:</span>
        <span class="s0">assert </span><span class="s3">500 </span><span class="s1">&lt; res[col].min() &lt; </span><span class="s3">1500</span>
        <span class="s0">assert </span><span class="s3">500 </span><span class="s1">&lt; res[col].max() &lt; </span><span class="s3">1500</span>


<span class="s0">def </span><span class="s1">test_with_spec_integer_method():</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">ColumnSpec</span><span class="s0">, </span><span class="s1">DatasetSpec</span><span class="s0">, </span><span class="s1">with_spec</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">npartitions=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">nrecords=</span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">column_specs=[</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;pois&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;poisson&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;norm&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;normal&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;unif&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;uniform&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;binom&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;binomial&quot;</span><span class="s0">, </span><span class="s1">args=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">0.4</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;choice&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">method=</span><span class="s2">&quot;choice&quot;</span><span class="s0">, </span><span class="s1">args=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;rand&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True, </span><span class="s1">low=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">high=</span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">ColumnSpec(prefix=</span><span class="s2">&quot;rand&quot;</span><span class="s0">, </span><span class="s1">dtype=int</span><span class="s0">, </span><span class="s1">random=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;pois1&quot;</span><span class="s1">].tolist() == [</span><span class="s3">1002</span><span class="s0">, </span><span class="s3">985</span><span class="s0">, </span><span class="s3">947</span><span class="s0">, </span><span class="s3">1003</span><span class="s0">, </span><span class="s3">1017</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;norm1&quot;</span><span class="s1">].tolist() == [-</span><span class="s3">1097</span><span class="s0">, </span><span class="s1">-</span><span class="s3">276</span><span class="s0">, </span><span class="s3">853</span><span class="s0">, </span><span class="s3">272</span><span class="s0">, </span><span class="s3">784</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;unif1&quot;</span><span class="s1">].tolist() == [</span><span class="s3">772</span><span class="s0">, </span><span class="s3">972</span><span class="s0">, </span><span class="s3">798</span><span class="s0">, </span><span class="s3">393</span><span class="s0">, </span><span class="s3">656</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;binom1&quot;</span><span class="s1">].tolist() == [</span><span class="s3">34</span><span class="s0">, </span><span class="s3">46</span><span class="s0">, </span><span class="s3">38</span><span class="s0">, </span><span class="s3">37</span><span class="s0">, </span><span class="s3">43</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;choice1&quot;</span><span class="s1">].tolist() == [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;rand1&quot;</span><span class="s1">].tolist() == [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">res[</span><span class="s2">&quot;rand2&quot;</span><span class="s1">].tolist() == [</span><span class="s3">883</span><span class="s0">, </span><span class="s3">104</span><span class="s0">, </span><span class="s3">192</span><span class="s0">, </span><span class="s3">648</span><span class="s0">, </span><span class="s3">256</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_with_spec_datetime_index():</span>
    <span class="s0">from </span><span class="s1">dask.dataframe.io.demo </span><span class="s0">import </span><span class="s1">(</span>
        <span class="s1">ColumnSpec</span><span class="s0">,</span>
        <span class="s1">DatasetSpec</span><span class="s0">,</span>
        <span class="s1">DatetimeIndexSpec</span><span class="s0">,</span>
        <span class="s1">with_spec</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">spec = DatasetSpec(</span>
        <span class="s1">nrecords=</span><span class="s3">10</span><span class="s0">,</span>
        <span class="s1">index_spec=DatetimeIndexSpec(</span>
            <span class="s1">dtype=</span><span class="s2">&quot;datetime64[ns]&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1h&quot;</span><span class="s0">, </span><span class="s1">start=</span><span class="s2">&quot;2023-01-02&quot;</span><span class="s0">, </span><span class="s1">partition_freq=</span><span class="s2">&quot;1D&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">column_specs=[ColumnSpec(dtype=int)]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">ddf = with_spec(spec</span><span class="s0">, </span><span class="s1">seed=</span><span class="s3">42</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">ddf.index.dtype == </span><span class="s2">&quot;datetime64[ns]&quot;</span>
    <span class="s1">res = ddf.compute()</span>
    <span class="s0">assert </span><span class="s1">len(res) == </span><span class="s3">10</span>
</pre>
</body>
</html>