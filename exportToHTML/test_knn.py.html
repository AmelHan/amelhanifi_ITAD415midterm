<html>
<head>
<title>test_knn.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_knn.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">sklearn </span><span class="s0">import </span><span class="s1">config_context</span>
<span class="s0">from </span><span class="s1">sklearn.impute </span><span class="s0">import </span><span class="s1">KNNImputer</span>
<span class="s0">from </span><span class="s1">sklearn.metrics.pairwise </span><span class="s0">import </span><span class="s1">nan_euclidean_distances</span><span class="s0">, </span><span class="s1">pairwise_distances</span>
<span class="s0">from </span><span class="s1">sklearn.neighbors </span><span class="s0">import </span><span class="s1">KNeighborsRegressor</span>
<span class="s0">from </span><span class="s1">sklearn.utils._testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weights&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;uniform&quot;</span><span class="s0">, </span><span class="s2">&quot;distance&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;n_neighbors&quot;</span><span class="s0">, </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_shape(weights</span><span class="s0">, </span><span class="s1">n_neighbors):</span>
    <span class="s4"># Verify the shapes of the imputed matrix for different weights and</span>
    <span class="s4"># number of neighbors.</span>
    <span class="s1">n_rows = </span><span class="s3">10</span>
    <span class="s1">n_cols = </span><span class="s3">2</span>
    <span class="s1">X = np.random.rand(n_rows</span><span class="s0">, </span><span class="s1">n_cols)</span>
    <span class="s1">X[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = np.nan</span>

    <span class="s1">imputer = KNNImputer(n_neighbors=n_neighbors</span><span class="s0">, </span><span class="s1">weights=weights)</span>
    <span class="s1">X_imputed = imputer.fit_transform(X)</span>
    <span class="s0">assert </span><span class="s1">X_imputed.shape == (n_rows</span><span class="s0">, </span><span class="s1">n_cols)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_default_with_invalid_input(na):</span>
    <span class="s4"># Test imputation with default values and invalid input</span>

    <span class="s4"># Test with inf present</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Input X contains (infinity|NaN)&quot;</span><span class="s1">):</span>
        <span class="s1">KNNImputer(missing_values=na).fit(X)</span>

    <span class="s4"># Test with inf present in matrix passed in transform()</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[np.inf</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">X_fit = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">imputer = KNNImputer(missing_values=na).fit(X_fit)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Input X contains (infinity|NaN)&quot;</span><span class="s1">):</span>
        <span class="s1">imputer.transform(X)</span>

    <span class="s4"># Test with missing_values=0 when NaN present</span>
    <span class="s1">imputer = KNNImputer(missing_values=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;uniform&quot;</span><span class="s1">)</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">msg = </span><span class="s2">&quot;Input X contains NaN&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">imputer.fit(X)</span>

    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_removes_all_na_features(na):</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">knn = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">2</span><span class="s1">).fit(X)</span>

    <span class="s1">X_transform = knn.transform(X)</span>
    <span class="s0">assert not </span><span class="s1">np.isnan(X_transform).any()</span>
    <span class="s0">assert </span><span class="s1">X_transform.shape == (</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span>

    <span class="s1">X_test = np.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">12</span><span class="s1">).reshape(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span>
    <span class="s1">X_transform = knn.transform(X_test)</span>
    <span class="s1">assert_allclose(X_test[:</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">X_transform)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_zero_nan_imputes_the_same(na):</span>
    <span class="s4"># Test with an imputable matrix and compare with different missing_values</span>
    <span class="s1">X_zero = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">X_nan = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2.5</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">1.5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">2.5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer_zero = KNNImputer(missing_values=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;uniform&quot;</span><span class="s1">)</span>

    <span class="s1">imputer_nan = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;uniform&quot;</span><span class="s1">)</span>

    <span class="s1">assert_allclose(imputer_zero.fit_transform(X_zero)</span><span class="s0">, </span><span class="s1">X_imputed)</span>
    <span class="s1">assert_allclose(</span>
        <span class="s1">imputer_zero.fit_transform(X_zero)</span><span class="s0">, </span><span class="s1">imputer_nan.fit_transform(X_nan)</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_verify(na):</span>
    <span class="s4"># Test with an imputable matrix</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">16</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>

    <span class="s4"># Test when there is not enough neighbors</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s4"># Not enough neighbors, use column mean from training</span>
    <span class="s1">X_impute_value = (</span><span class="s3">20 </span><span class="s1">+ </span><span class="s3">22</span><span class="s1">) / </span><span class="s3">2</span>
    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s1">X_impute_value]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s0">, </span><span class="s3">22</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>

    <span class="s4"># Test when data in fit() and transform() are different</span>
    <span class="s1">X = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">16</span><span class="s1">]])</span>

    <span class="s1">X1 = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">na]])</span>

    <span class="s1">X_2_1 = (</span><span class="s3">0 </span><span class="s1">+ </span><span class="s3">3 </span><span class="s1">+ </span><span class="s3">6 </span><span class="s1">+ </span><span class="s3">7 </span><span class="s1">+ </span><span class="s3">8</span><span class="s1">) / </span><span class="s3">5</span>
    <span class="s1">X1_imputed = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">X_2_1]])</span>

    <span class="s1">imputer = KNNImputer(missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit(X).transform(X1)</span><span class="s0">, </span><span class="s1">X1_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_one_n_neighbors(na):</span>
    <span class="s1">X = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]])</span>

    <span class="s1">X_imputed = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]])</span>

    <span class="s1">imputer = KNNImputer(n_neighbors=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">missing_values=na)</span>

    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_all_samples_are_neighbors(na):</span>
    <span class="s1">X = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]])</span>

    <span class="s1">X_imputed = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5.5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">14</span><span class="s0">, </span><span class="s3">13</span><span class="s1">]])</span>

    <span class="s1">n_neighbors = X.shape[</span><span class="s3">0</span><span class="s1">] - </span><span class="s3">1</span>
    <span class="s1">imputer = KNNImputer(n_neighbors=n_neighbors</span><span class="s0">, </span><span class="s1">missing_values=na)</span>

    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>

    <span class="s1">n_neighbors = X.shape[</span><span class="s3">0</span><span class="s1">]</span>
    <span class="s1">imputer_plus1 = KNNImputer(n_neighbors=n_neighbors</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer_plus1.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_weight_uniform(na):</span>
    <span class="s1">X = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]])</span>

    <span class="s4"># Test with &quot;uniform&quot; weight (or unweighted)</span>
    <span class="s1">X_imputed_uniform = np.array(</span>
        <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(weights=</span><span class="s2">&quot;uniform&quot;</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed_uniform)</span>

    <span class="s4"># Test with &quot;callable&quot; weight</span>
    <span class="s0">def </span><span class="s1">no_weight(dist):</span>
        <span class="s0">return None</span>

    <span class="s1">imputer = KNNImputer(weights=no_weight</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed_uniform)</span>

    <span class="s4"># Test with &quot;callable&quot; uniform weight</span>
    <span class="s0">def </span><span class="s1">uniform_weight(dist):</span>
        <span class="s0">return </span><span class="s1">np.ones_like(dist)</span>

    <span class="s1">imputer = KNNImputer(weights=uniform_weight</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed_uniform)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_weight_distance(na):</span>
    <span class="s1">X = np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]])</span>

    <span class="s4"># Test with &quot;distance&quot; weight</span>
    <span class="s1">nn = KNeighborsRegressor(metric=</span><span class="s2">&quot;euclidean&quot;</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;distance&quot;</span><span class="s1">)</span>
    <span class="s1">X_rows_idx = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span>
    <span class="s1">nn.fit(X[X_rows_idx</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">X[X_rows_idx</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s1">knn_imputed_value = nn.predict(X[</span><span class="s3">1</span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">:])[</span><span class="s3">0</span><span class="s1">]</span>

    <span class="s4"># Manual calculation</span>
    <span class="s1">X_neighbors_idx = [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span>
    <span class="s1">dist = nan_euclidean_distances(X[</span><span class="s3">1</span><span class="s1">:</span><span class="s3">2</span><span class="s0">, </span><span class="s1">:]</span><span class="s0">, </span><span class="s1">X</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">weights = </span><span class="s3">1 </span><span class="s1">/ dist[:</span><span class="s0">, </span><span class="s1">X_neighbors_idx].ravel()</span>
    <span class="s1">manual_imputed_value = np.average(X[X_neighbors_idx</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=weights)</span>

    <span class="s1">X_imputed_distance1 = np.array(</span>
        <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[manual_imputed_value</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s4"># NearestNeighbor calculation</span>
    <span class="s1">X_imputed_distance2 = np.array(</span>
        <span class="s1">[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[knn_imputed_value</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">9</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">11</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(weights=</span><span class="s2">&quot;distance&quot;</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed_distance1)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed_distance2)</span>

    <span class="s4"># Test with weights = &quot;distance&quot; and n_neighbors=2</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s4"># neighbors are rows 1, 2, the nan_euclidean_distances are:</span>
    <span class="s1">dist_0_1 = np.sqrt((</span><span class="s3">3 </span><span class="s1">/ </span><span class="s3">2</span><span class="s1">) * ((</span><span class="s3">1 </span><span class="s1">- </span><span class="s3">0</span><span class="s1">) ** </span><span class="s3">2 </span><span class="s1">+ (</span><span class="s3">2 </span><span class="s1">- </span><span class="s3">0</span><span class="s1">) ** </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">dist_0_2 = np.sqrt((</span><span class="s3">3 </span><span class="s1">/ </span><span class="s3">2</span><span class="s1">) * ((</span><span class="s3">2 </span><span class="s1">- </span><span class="s3">0</span><span class="s1">) ** </span><span class="s3">2 </span><span class="s1">+ (</span><span class="s3">3 </span><span class="s1">- </span><span class="s3">0</span><span class="s1">) ** </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">imputed_value = np.average([</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=[</span><span class="s3">1 </span><span class="s1">/ dist_0_1</span><span class="s0">, </span><span class="s3">1 </span><span class="s1">/ dist_0_2])</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[imputed_value</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(n_neighbors=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;distance&quot;</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>

    <span class="s4"># Test with varying missingness patterns</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s4"># Get weights of donor neighbors</span>
    <span class="s1">dist = nan_euclidean_distances(X</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">r1c1_nbor_dists = dist[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span>
    <span class="s1">r1c3_nbor_dists = dist[</span><span class="s3">1</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
    <span class="s1">r1c1_nbor_wt = </span><span class="s3">1 </span><span class="s1">/ r1c1_nbor_dists</span>
    <span class="s1">r1c3_nbor_wt = </span><span class="s3">1 </span><span class="s1">/ r1c3_nbor_dists</span>

    <span class="s1">r2c3_nbor_dists = dist[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span>
    <span class="s1">r2c3_nbor_wt = </span><span class="s3">1 </span><span class="s1">/ r2c3_nbor_dists</span>

    <span class="s4"># Collect donor values</span>
    <span class="s1">col1_donor_values = np.ma.masked_invalid(X[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]).copy()</span>
    <span class="s1">col3_donor_values = np.ma.masked_invalid(X[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]).copy()</span>

    <span class="s4"># Final imputed values</span>
    <span class="s1">r1c1_imp = np.ma.average(col1_donor_values</span><span class="s0">, </span><span class="s1">weights=r1c1_nbor_wt)</span>
    <span class="s1">r1c3_imp = np.ma.average(col3_donor_values</span><span class="s0">, </span><span class="s1">weights=r1c3_nbor_wt)</span>
    <span class="s1">r2c3_imp = np.ma.average(col3_donor_values</span><span class="s0">, </span><span class="s1">weights=r2c3_nbor_wt)</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">r1c1_imp</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">r1c3_imp]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">r2c3_imp]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(weights=</span><span class="s2">&quot;distance&quot;</span><span class="s0">, </span><span class="s1">missing_values=na)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>

    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">dist = pairwise_distances(</span>
        <span class="s1">X</span><span class="s0">, </span><span class="s1">metric=</span><span class="s2">&quot;nan_euclidean&quot;</span><span class="s0">, </span><span class="s1">squared=</span><span class="s0">False, </span><span class="s1">missing_values=na</span>
    <span class="s1">)</span>

    <span class="s4"># Calculate weights</span>
    <span class="s1">r0c3_w = </span><span class="s3">1.0 </span><span class="s1">/ dist[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">r1c3_w = </span><span class="s3">1.0 </span><span class="s1">/ dist[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">r2c2_w = </span><span class="s3">1.0 </span><span class="s1">/ dist[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]</span>
    <span class="s1">r7c0_w = </span><span class="s3">1.0 </span><span class="s1">/ dist[</span><span class="s3">7</span><span class="s0">, </span><span class="s3">2</span><span class="s1">:</span><span class="s3">7</span><span class="s1">]</span>

    <span class="s4"># Calculate weighted averages</span>
    <span class="s1">r0c3 = np.average(X[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=r0c3_w)</span>
    <span class="s1">r1c3 = np.average(X[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=r1c3_w)</span>
    <span class="s1">r2c2 = np.average(X[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=r2c2_w)</span>
    <span class="s1">r7c0 = np.average(X[</span><span class="s3">2</span><span class="s1">:</span><span class="s3">7</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=r7c0_w)</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">r0c3]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">r1c3]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">r2c2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[r7c0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">imputer_comp_wt = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;distance&quot;</span><span class="s1">)</span>
    <span class="s1">assert_allclose(imputer_comp_wt.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>


<span class="s0">def </span><span class="s1">test_knn_imputer_callable_metric():</span>
    <span class="s4"># Define callable metric that returns the l1 norm:</span>
    <span class="s0">def </span><span class="s1">custom_callable(x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">missing_values=np.nan</span><span class="s0">, </span><span class="s1">squared=</span><span class="s0">False</span><span class="s1">):</span>
        <span class="s1">x = np.ma.array(x</span><span class="s0">, </span><span class="s1">mask=np.isnan(x))</span>
        <span class="s1">y = np.ma.array(y</span><span class="s0">, </span><span class="s1">mask=np.isnan(y))</span>
        <span class="s1">dist = np.nansum(np.abs(x - y))</span>
        <span class="s0">return </span><span class="s1">dist</span>

    <span class="s1">X = np.array([[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">np.nan]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">10.0</span><span class="s1">]])</span>

    <span class="s1">X_0_3 = (</span><span class="s3">9 </span><span class="s1">+ </span><span class="s3">9</span><span class="s1">) / </span><span class="s3">2</span>
    <span class="s1">X_3_0 = (</span><span class="s3">6 </span><span class="s1">+ </span><span class="s3">4</span><span class="s1">) / </span><span class="s3">2</span>
    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">X_0_3]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[X_3_0</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">10.0</span><span class="s1">]]</span>
    <span class="s1">)</span>

    <span class="s1">imputer = KNNImputer(n_neighbors=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">metric=custom_callable)</span>
    <span class="s1">assert_allclose(imputer.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;working_memory&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
<span class="s4"># Note that we use working_memory=0 to ensure that chunking is tested, even</span>
<span class="s4"># for a small dataset. However, it should raise a UserWarning that we ignore.</span>
<span class="s1">@pytest.mark.filterwarnings(</span><span class="s2">&quot;ignore:adhere to working_memory&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_with_simple_example(na</span><span class="s0">, </span><span class="s1">working_memory):</span>
    <span class="s1">X = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[na</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s1">r0c1 = np.mean(X[</span><span class="s3">1</span><span class="s1">:</span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">r0c3 = np.mean(X[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">r1c3 = np.mean(X[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">r2c2 = np.mean(X[[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">r7c0 = np.mean(X[</span><span class="s3">2</span><span class="s1">:-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">])</span>

    <span class="s1">X_imputed = np.array(</span>
        <span class="s1">[</span>
            <span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">r0c1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">r0c3]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">r1c3]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">r2c2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[r7c0</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">config_context(working_memory=working_memory):</span>
        <span class="s1">imputer_comp = KNNImputer(missing_values=na)</span>
        <span class="s1">assert_allclose(imputer_comp.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;weights&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;uniform&quot;</span><span class="s0">, </span><span class="s2">&quot;distance&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_not_enough_valid_distances(na</span><span class="s0">, </span><span class="s1">weights):</span>
    <span class="s4"># Samples with needed feature has nan distance</span>
    <span class="s1">X1 = np.array([[na</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]])</span>
    <span class="s1">X1_imputed = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">11</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>

    <span class="s1">knn = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">weights=weights)</span>
    <span class="s1">assert_allclose(knn.fit_transform(X1)</span><span class="s0">, </span><span class="s1">X1_imputed)</span>

    <span class="s1">X2 = np.array([[</span><span class="s3">4</span><span class="s0">, </span><span class="s1">na]])</span>
    <span class="s1">X2_imputed = np.array([[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(knn.transform(X2)</span><span class="s0">, </span><span class="s1">X2_imputed)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_drops_all_nan_features(na):</span>
    <span class="s1">X1 = np.array([[na</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">knn = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">X1_expected = np.array([[</span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(knn.fit_transform(X1)</span><span class="s0">, </span><span class="s1">X1_expected)</span>

    <span class="s1">X2 = np.array([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]])</span>
    <span class="s1">X2_expected = np.array([[</span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1.5</span><span class="s1">]])</span>
    <span class="s1">assert_allclose(knn.transform(X2)</span><span class="s0">, </span><span class="s1">X2_expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;working_memory&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s3">0</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan])</span>
<span class="s0">def </span><span class="s1">test_knn_imputer_distance_weighted_not_enough_neighbors(na</span><span class="s0">, </span><span class="s1">working_memory):</span>
    <span class="s1">X = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">na]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[na</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>

    <span class="s1">dist = pairwise_distances(</span>
        <span class="s1">X</span><span class="s0">, </span><span class="s1">metric=</span><span class="s2">&quot;nan_euclidean&quot;</span><span class="s0">, </span><span class="s1">squared=</span><span class="s0">False, </span><span class="s1">missing_values=na</span>
    <span class="s1">)</span>

    <span class="s1">X_01 = np.average(X[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=</span><span class="s3">1 </span><span class="s1">/ dist[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">X_11 = np.average(X[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=</span><span class="s3">1 </span><span class="s1">/ dist[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">X_20 = np.average(X[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=</span><span class="s3">1 </span><span class="s1">/ dist[</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s1">])</span>
    <span class="s1">X_50 = np.average(X[</span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">weights=</span><span class="s3">1 </span><span class="s1">/ dist[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">:</span><span class="s3">5</span><span class="s1">])</span>

    <span class="s1">X_expected = np.array([[</span><span class="s3">3</span><span class="s0">, </span><span class="s1">X_01]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">2</span><span class="s0">, </span><span class="s1">X_11]</span><span class="s0">, </span><span class="s1">[X_20</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[X_50</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]])</span>

    <span class="s0">with </span><span class="s1">config_context(working_memory=working_memory):</span>
        <span class="s1">knn_3 = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;distance&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(knn_3.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_expected)</span>

        <span class="s1">knn_4 = KNNImputer(missing_values=na</span><span class="s0">, </span><span class="s1">n_neighbors=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">weights=</span><span class="s2">&quot;distance&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(knn_4.fit_transform(X)</span><span class="s0">, </span><span class="s1">X_expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;na, allow_nan&quot;</span><span class="s0">, </span><span class="s1">[(-</span><span class="s3">1</span><span class="s0">, False</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(np.nan</span><span class="s0">, True</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_knn_tags(na</span><span class="s0">, </span><span class="s1">allow_nan):</span>
    <span class="s1">knn = KNNImputer(missing_values=na)</span>
    <span class="s0">assert </span><span class="s1">knn._get_tags()[</span><span class="s2">&quot;allow_nan&quot;</span><span class="s1">] == allow_nan</span>
</pre>
</body>
</html>