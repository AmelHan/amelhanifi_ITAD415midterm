<html>
<head>
<title>test_survival.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_survival.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_allclose</span>
<span class="s0">from </span><span class="s1">scipy </span><span class="s0">import </span><span class="s1">stats</span>
<span class="s0">from </span><span class="s1">scipy.stats </span><span class="s0">import </span><span class="s1">_survival</span>


<span class="s0">def </span><span class="s1">_kaplan_meier_reference(times</span><span class="s0">, </span><span class="s1">censored):</span>
    <span class="s2"># This is a very straightforward implementation of the Kaplan-Meier</span>
    <span class="s2"># estimator that does almost everything differently from the implementation</span>
    <span class="s2"># in stats.ecdf.</span>

    <span class="s2"># Begin by sorting the raw data. Note that the order of death and loss</span>
    <span class="s2"># at a given time matters: death happens first. See [2] page 461:</span>
    <span class="s2"># &quot;These conventions may be paraphrased by saying that deaths recorded as</span>
    <span class="s2"># of an age t are treated as if they occurred slightly before t, and losses</span>
    <span class="s2"># recorded as of an age t are treated as occurring slightly after t.&quot;</span>
    <span class="s2"># We implement this by sorting the data first by time, then by `censored`,</span>
    <span class="s2"># (which is 0 when there is a death and 1 when there is only a loss).</span>
    <span class="s1">dtype = [(</span><span class="s3">'time'</span><span class="s0">, </span><span class="s1">float)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">'censored'</span><span class="s0">, </span><span class="s1">int)]</span>
    <span class="s1">data = np.array([(t</span><span class="s0">, </span><span class="s1">d) </span><span class="s0">for </span><span class="s1">t</span><span class="s0">, </span><span class="s1">d </span><span class="s0">in </span><span class="s1">zip(times</span><span class="s0">, </span><span class="s1">censored)]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">data = np.sort(data</span><span class="s0">, </span><span class="s1">order=(</span><span class="s3">'time'</span><span class="s0">, </span><span class="s3">'censored'</span><span class="s1">))</span>
    <span class="s1">times = data[</span><span class="s3">'time'</span><span class="s1">]</span>
    <span class="s1">died = np.logical_not(data[</span><span class="s3">'censored'</span><span class="s1">])</span>

    <span class="s1">m = times.size</span>
    <span class="s1">n = np.arange(m</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">)  </span><span class="s2"># number at risk</span>
    <span class="s1">sf = np.cumprod((n - died) / n)</span>

    <span class="s2"># Find the indices of the *last* occurrence of unique times. The</span>
    <span class="s2"># corresponding entries of `times` and `sf` are what we want.</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">indices = np.unique(times[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">return_index=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">ref_times = times[-indices - </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">ref_sf = sf[-indices - </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s0">return </span><span class="s1">ref_times</span><span class="s0">, </span><span class="s1">ref_sf</span>


<span class="s0">class </span><span class="s1">TestSurvival:</span>

    <span class="s1">@staticmethod</span>
    <span class="s0">def </span><span class="s1">get_random_sample(rng</span><span class="s0">, </span><span class="s1">n_unique):</span>
        <span class="s2"># generate random sample</span>
        <span class="s1">unique_times = rng.random(n_unique)</span>
        <span class="s2"># convert to `np.int32` to resolve `np.repeat` failure in 32-bit CI</span>
        <span class="s1">repeats = rng.integers(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s1">n_unique).astype(np.int32)</span>
        <span class="s1">times = rng.permuted(np.repeat(unique_times</span><span class="s0">, </span><span class="s1">repeats))</span>
        <span class="s1">censored = rng.random(size=times.size) &gt; rng.random()</span>
        <span class="s1">sample = stats.CensoredData.right_censored(times</span><span class="s0">, </span><span class="s1">censored)</span>
        <span class="s0">return </span><span class="s1">sample</span><span class="s0">, </span><span class="s1">times</span><span class="s0">, </span><span class="s1">censored</span>

    <span class="s0">def </span><span class="s1">test_input_validation(self):</span>
        <span class="s1">message = </span><span class="s3">'`sample` must be a one-dimensional sequence.'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">stats.ecdf([[</span><span class="s4">1</span><span class="s1">]])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">stats.ecdf(</span><span class="s4">1</span><span class="s1">)</span>

        <span class="s1">message = </span><span class="s3">'`sample` must not contain nan'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">stats.ecdf([np.nan])</span>

        <span class="s1">message = </span><span class="s3">'Currently, only uncensored and right-censored data...'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">stats.ecdf(stats.CensoredData.left_censored([</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">censored=[</span><span class="s0">True</span><span class="s1">]))</span>

        <span class="s1">message = </span><span class="s3">'method` must be one of...'</span>
        <span class="s1">res = stats.ecdf([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">res.cdf.confidence_interval(method=</span><span class="s3">'ekki-ekki'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">res.sf.confidence_interval(method=</span><span class="s3">'shrubbery'</span><span class="s1">)</span>

        <span class="s1">message = </span><span class="s3">'confidence_level` must be a scalar between 0 and 1'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">res.cdf.confidence_interval(-</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">res.sf.confidence_interval([</span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">])</span>

        <span class="s1">message = </span><span class="s3">'The confidence interval is undefined at some observations.'</span>
        <span class="s0">with </span><span class="s1">pytest.warns(RuntimeWarning</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci = res.cdf.confidence_interval()</span>

        <span class="s1">message = </span><span class="s3">'Confidence interval bounds do not implement...'</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci.low.confidence_interval()</span>
        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci.high.confidence_interval()</span>

    <span class="s0">def </span><span class="s1">test_edge_cases(self):</span>
        <span class="s1">res = stats.ecdf([])</span>
        <span class="s1">assert_equal(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s1">assert_equal(res.cdf.probabilities</span><span class="s0">, </span><span class="s1">[])</span>

        <span class="s1">res = stats.ecdf([</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">assert_equal(res.cdf.probabilities</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_unique(self):</span>
        <span class="s2"># Example with unique observations; `stats.ecdf` ref. [1] page 80</span>
        <span class="s1">sample = [</span><span class="s4">6.23</span><span class="s0">, </span><span class="s4">5.58</span><span class="s0">, </span><span class="s4">7.06</span><span class="s0">, </span><span class="s4">6.42</span><span class="s0">, </span><span class="s4">5.20</span><span class="s1">]</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">ref_x = np.sort(np.unique(sample))</span>
        <span class="s1">ref_cdf = np.arange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">6</span><span class="s1">) / </span><span class="s4">5</span>
        <span class="s1">ref_sf = </span><span class="s4">1 </span><span class="s1">- ref_cdf</span>
        <span class="s1">assert_equal(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">ref_x)</span>
        <span class="s1">assert_equal(res.cdf.probabilities</span><span class="s0">, </span><span class="s1">ref_cdf)</span>
        <span class="s1">assert_equal(res.sf.quantiles</span><span class="s0">, </span><span class="s1">ref_x)</span>
        <span class="s1">assert_equal(res.sf.probabilities</span><span class="s0">, </span><span class="s1">ref_sf)</span>

    <span class="s0">def </span><span class="s1">test_nonunique(self):</span>
        <span class="s2"># Example with non-unique observations; `stats.ecdf` ref. [1] page 82</span>
        <span class="s1">sample = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">ref_x = np.sort(np.unique(sample))</span>
        <span class="s1">ref_cdf = np.array([</span><span class="s4">1</span><span class="s1">/</span><span class="s4">6</span><span class="s0">, </span><span class="s4">2</span><span class="s1">/</span><span class="s4">6</span><span class="s0">, </span><span class="s4">4</span><span class="s1">/</span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s1">/</span><span class="s4">6</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">ref_sf = </span><span class="s4">1 </span><span class="s1">- ref_cdf</span>
        <span class="s1">assert_equal(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">ref_x)</span>
        <span class="s1">assert_equal(res.cdf.probabilities</span><span class="s0">, </span><span class="s1">ref_cdf)</span>
        <span class="s1">assert_equal(res.sf.quantiles</span><span class="s0">, </span><span class="s1">ref_x)</span>
        <span class="s1">assert_equal(res.sf.probabilities</span><span class="s0">, </span><span class="s1">ref_sf)</span>

    <span class="s0">def </span><span class="s1">test_evaluate_methods(self):</span>
        <span class="s2"># Test CDF and SF `evaluate` methods</span>
        <span class="s1">rng = np.random.default_rng(</span><span class="s4">1162729143302572461</span><span class="s1">)</span>
        <span class="s1">sample</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = self.get_random_sample(rng</span><span class="s0">, </span><span class="s4">15</span><span class="s1">)</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">x = res.cdf.quantiles</span>
        <span class="s1">xr = x + np.diff(x</span><span class="s0">, </span><span class="s1">append=x[-</span><span class="s4">1</span><span class="s1">]+</span><span class="s4">1</span><span class="s1">)/</span><span class="s4">2  </span><span class="s2"># right shifted points</span>

        <span class="s1">assert_equal(res.cdf.evaluate(x)</span><span class="s0">, </span><span class="s1">res.cdf.probabilities)</span>
        <span class="s1">assert_equal(res.cdf.evaluate(xr)</span><span class="s0">, </span><span class="s1">res.cdf.probabilities)</span>
        <span class="s1">assert_equal(res.cdf.evaluate(x[</span><span class="s4">0</span><span class="s1">]-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">0</span><span class="s1">)  </span><span class="s2"># CDF starts at 0</span>
        <span class="s1">assert_equal(res.cdf.evaluate([-np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">assert_equal(res.sf.evaluate(x)</span><span class="s0">, </span><span class="s1">res.sf.probabilities)</span>
        <span class="s1">assert_equal(res.sf.evaluate(xr)</span><span class="s0">, </span><span class="s1">res.sf.probabilities)</span>
        <span class="s1">assert_equal(res.sf.evaluate(x[</span><span class="s4">0</span><span class="s1">]-</span><span class="s4">1</span><span class="s1">)</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)  </span><span class="s2"># SF starts at 1</span>
        <span class="s1">assert_equal(res.sf.evaluate([-np.inf</span><span class="s0">, </span><span class="s1">np.inf])</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">])</span>

    <span class="s2"># ref. [1] page 91</span>
    <span class="s1">t1 = [</span><span class="s4">37</span><span class="s0">, </span><span class="s4">43</span><span class="s0">, </span><span class="s4">47</span><span class="s0">, </span><span class="s4">56</span><span class="s0">, </span><span class="s4">60</span><span class="s0">, </span><span class="s4">62</span><span class="s0">, </span><span class="s4">71</span><span class="s0">, </span><span class="s4">77</span><span class="s0">, </span><span class="s4">80</span><span class="s0">, </span><span class="s4">81</span><span class="s1">]  </span><span class="s2"># times</span>
    <span class="s1">d1 = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]  </span><span class="s2"># 1 means deaths (not censored)</span>
    <span class="s1">r1 = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.875</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">0.25</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]  </span><span class="s2"># reference SF</span>

    <span class="s2"># https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/BS704_Survival5.html  # noqa</span>
    <span class="s1">t2 = [</span><span class="s4">8</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">26</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">27</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">32</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">40</span><span class="s1">]</span>
    <span class="s1">d2 = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">r2 = [</span><span class="s4">0.9</span><span class="s0">, </span><span class="s4">0.788</span><span class="s0">, </span><span class="s4">0.675</span><span class="s0">, </span><span class="s4">0.675</span><span class="s0">, </span><span class="s4">0.54</span><span class="s0">, </span><span class="s4">0.405</span><span class="s0">, </span><span class="s4">0.27</span><span class="s0">, </span><span class="s4">0.27</span><span class="s0">, </span><span class="s4">0.27</span><span class="s1">]</span>
    <span class="s1">t3 = [</span><span class="s4">33</span><span class="s0">, </span><span class="s4">28</span><span class="s0">, </span><span class="s4">41</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">37</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">43</span><span class="s1">]</span>
    <span class="s1">d3 = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span>
    <span class="s1">r3 = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0.875</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.75</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.6</span><span class="s0">, </span><span class="s4">0.6</span><span class="s1">]</span>

    <span class="s2"># https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/bs704_survival4.html  # noqa</span>
    <span class="s1">t4 = [</span><span class="s4">24</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">19</span><span class="s0">, </span><span class="s4">24</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">18</span><span class="s0">, </span><span class="s4">17</span><span class="s0">,</span>
          <span class="s4">24</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">23</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">17</span><span class="s1">]</span>
    <span class="s1">d4 = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">r4 = [</span><span class="s4">0.95</span><span class="s0">, </span><span class="s4">0.95</span><span class="s0">, </span><span class="s4">0.897</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.844</span><span class="s0">,</span>
          <span class="s4">0.844</span><span class="s0">, </span><span class="s4">0.76</span><span class="s0">, </span><span class="s4">0.676</span><span class="s0">, </span><span class="s4">0.676</span><span class="s0">, </span><span class="s4">0.676</span><span class="s0">, </span><span class="s4">0.676</span><span class="s0">, </span><span class="s4">0.507</span><span class="s0">, </span><span class="s4">0.507</span><span class="s1">]</span>

    <span class="s2"># https://www.real-statistics.com/survival-analysis/kaplan-meier-procedure/confidence-interval-for-the-survival-function/  # noqa</span>
    <span class="s1">t5 = [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">11</span><span class="s1">]</span>
    <span class="s1">d5 = [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">r5 = [</span><span class="s4">0.944</span><span class="s0">, </span><span class="s4">0.889</span><span class="s0">, </span><span class="s4">0.722</span><span class="s0">, </span><span class="s4">0.542</span><span class="s0">, </span><span class="s4">0.542</span><span class="s0">, </span><span class="s4">0.542</span><span class="s0">, </span><span class="s4">0.361</span><span class="s0">, </span><span class="s4">0.181</span><span class="s0">, </span><span class="s4">0.181</span><span class="s0">, </span><span class="s4">0.181</span><span class="s1">]</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;case&quot;</span><span class="s0">, </span><span class="s1">[(t1</span><span class="s0">, </span><span class="s1">d1</span><span class="s0">, </span><span class="s1">r1)</span><span class="s0">, </span><span class="s1">(t2</span><span class="s0">, </span><span class="s1">d2</span><span class="s0">, </span><span class="s1">r2)</span><span class="s0">, </span><span class="s1">(t3</span><span class="s0">, </span><span class="s1">d3</span><span class="s0">, </span><span class="s1">r3)</span><span class="s0">,</span>
                                      <span class="s1">(t4</span><span class="s0">, </span><span class="s1">d4</span><span class="s0">, </span><span class="s1">r4)</span><span class="s0">, </span><span class="s1">(t5</span><span class="s0">, </span><span class="s1">d5</span><span class="s0">, </span><span class="s1">r5)])</span>
    <span class="s0">def </span><span class="s1">test_right_censored_against_examples(self</span><span class="s0">, </span><span class="s1">case):</span>
        <span class="s2"># test `ecdf` against other implementations on example problems</span>
        <span class="s1">times</span><span class="s0">, </span><span class="s1">died</span><span class="s0">, </span><span class="s1">ref = case</span>
        <span class="s1">sample = stats.CensoredData.right_censored(times</span><span class="s0">, </span><span class="s1">np.logical_not(died))</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">assert_allclose(res.sf.probabilities</span><span class="s0">, </span><span class="s1">ref</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.sf.quantiles</span><span class="s0">, </span><span class="s1">np.sort(np.unique(times)))</span>

        <span class="s2"># test reference implementation against other implementations</span>
        <span class="s1">res = _kaplan_meier_reference(times</span><span class="s0">, </span><span class="s1">np.logical_not(died))</span>
        <span class="s1">assert_equal(res[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.sort(np.unique(times)))</span>
        <span class="s1">assert_allclose(res[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s3">'seed'</span><span class="s0">, </span><span class="s1">[</span><span class="s4">182746786639392128</span><span class="s0">, </span><span class="s4">737379171436494115</span><span class="s0">,</span>
                                      <span class="s4">576033618403180168</span><span class="s0">, </span><span class="s4">308115465002673650</span><span class="s1">])</span>
    <span class="s0">def </span><span class="s1">test_right_censored_against_reference_implementation(self</span><span class="s0">, </span><span class="s1">seed):</span>
        <span class="s2"># test `ecdf` against reference implementation on random problems</span>
        <span class="s1">rng = np.random.default_rng(seed)</span>
        <span class="s1">n_unique = rng.integers(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span>
        <span class="s1">sample</span><span class="s0">, </span><span class="s1">times</span><span class="s0">, </span><span class="s1">censored = self.get_random_sample(rng</span><span class="s0">, </span><span class="s1">n_unique)</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">ref = _kaplan_meier_reference(times</span><span class="s0">, </span><span class="s1">censored)</span>
        <span class="s1">assert_allclose(res.sf.quantiles</span><span class="s0">, </span><span class="s1">ref[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(res.sf.probabilities</span><span class="s0">, </span><span class="s1">ref[</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s2"># If all observations are uncensored, the KM estimate should match</span>
        <span class="s2"># the usual estimate for uncensored data</span>
        <span class="s1">sample = stats.CensoredData(uncensored=times)</span>
        <span class="s1">res = _survival._ecdf_right_censored(sample)  </span><span class="s2"># force Kaplan-Meier</span>
        <span class="s1">ref = stats.ecdf(times)</span>
        <span class="s1">assert_equal(res[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref.sf.quantiles)</span>
        <span class="s1">assert_allclose(res[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref.cdf.probabilities</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res[</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref.sf.probabilities</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_right_censored_ci(self):</span>
        <span class="s2"># test &quot;greenwood&quot; confidence interval against example 4 (URL above).</span>
        <span class="s1">times</span><span class="s0">, </span><span class="s1">died = self.t4</span><span class="s0">, </span><span class="s1">self.d4</span>
        <span class="s1">sample = stats.CensoredData.right_censored(times</span><span class="s0">, </span><span class="s1">np.logical_not(died))</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">ref_allowance = [</span><span class="s4">0.096</span><span class="s0">, </span><span class="s4">0.096</span><span class="s0">, </span><span class="s4">0.135</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">,</span>
                         <span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.162</span><span class="s0">, </span><span class="s4">0.214</span><span class="s0">, </span><span class="s4">0.246</span><span class="s0">, </span><span class="s4">0.246</span><span class="s0">, </span><span class="s4">0.246</span><span class="s0">,</span>
                         <span class="s4">0.246</span><span class="s0">, </span><span class="s4">0.341</span><span class="s0">, </span><span class="s4">0.341</span><span class="s1">]</span>

        <span class="s1">sf_ci = res.sf.confidence_interval()</span>
        <span class="s1">cdf_ci = res.cdf.confidence_interval()</span>
        <span class="s1">allowance = res.sf.probabilities - sf_ci.low.probabilities</span>

        <span class="s1">assert_allclose(allowance</span><span class="s0">, </span><span class="s1">ref_allowance</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.low.probabilities</span><span class="s0">,</span>
                        <span class="s1">np.clip(res.sf.probabilities - allowance</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_allclose(sf_ci.high.probabilities</span><span class="s0">,</span>
                        <span class="s1">np.clip(res.sf.probabilities + allowance</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_allclose(cdf_ci.low.probabilities</span><span class="s0">,</span>
                        <span class="s1">np.clip(res.cdf.probabilities - allowance</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">assert_allclose(cdf_ci.high.probabilities</span><span class="s0">,</span>
                        <span class="s1">np.clip(res.cdf.probabilities + allowance</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>

        <span class="s2"># test &quot;log-log&quot; confidence interval against Mathematica</span>
        <span class="s2"># e = {24, 3, 11, 19, 24, 13, 14, 2, 18, 17, 24, 21, 12, 1, 10, 23, 6, 5,</span>
        <span class="s2">#      9, 17}</span>
        <span class="s2"># ci = {1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0}</span>
        <span class="s2"># R = EventData[e, ci]</span>
        <span class="s2"># S = SurvivalModelFit[R]</span>
        <span class="s2"># S[&quot;PointwiseIntervals&quot;, ConfidenceLevel-&gt;0.95,</span>
        <span class="s2">#   ConfidenceTransform-&gt;&quot;LogLog&quot;]</span>

        <span class="s1">ref_low = [</span><span class="s4">0.694743</span><span class="s0">, </span><span class="s4">0.694743</span><span class="s0">, </span><span class="s4">0.647529</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">,</span>
                   <span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.591142</span><span class="s0">, </span><span class="s4">0.464605</span><span class="s0">, </span><span class="s4">0.370359</span><span class="s0">,</span>
                   <span class="s4">0.370359</span><span class="s0">, </span><span class="s4">0.370359</span><span class="s0">, </span><span class="s4">0.370359</span><span class="s0">, </span><span class="s4">0.160489</span><span class="s0">, </span><span class="s4">0.160489</span><span class="s1">]</span>
        <span class="s1">ref_high = [</span><span class="s4">0.992802</span><span class="s0">, </span><span class="s4">0.992802</span><span class="s0">, </span><span class="s4">0.973299</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">,</span>
                    <span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.947073</span><span class="s0">, </span><span class="s4">0.906422</span><span class="s0">, </span><span class="s4">0.856521</span><span class="s0">,</span>
                    <span class="s4">0.856521</span><span class="s0">, </span><span class="s4">0.856521</span><span class="s0">, </span><span class="s4">0.856521</span><span class="s0">, </span><span class="s4">0.776724</span><span class="s0">, </span><span class="s4">0.776724</span><span class="s1">]</span>
        <span class="s1">sf_ci = res.sf.confidence_interval(method=</span><span class="s3">'log-log'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.low.probabilities</span><span class="s0">, </span><span class="s1">ref_low</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.high.probabilities</span><span class="s0">, </span><span class="s1">ref_high</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_right_censored_ci_example_5(self):</span>
        <span class="s2"># test &quot;exponential greenwood&quot; confidence interval against example 5</span>
        <span class="s1">times</span><span class="s0">, </span><span class="s1">died = self.t5</span><span class="s0">, </span><span class="s1">self.d5</span>
        <span class="s1">sample = stats.CensoredData.right_censored(times</span><span class="s0">, </span><span class="s1">np.logical_not(died))</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">lower = np.array([</span><span class="s4">0.66639</span><span class="s0">, </span><span class="s4">0.624174</span><span class="s0">, </span><span class="s4">0.456179</span><span class="s0">, </span><span class="s4">0.287822</span><span class="s0">, </span><span class="s4">0.287822</span><span class="s0">,</span>
                          <span class="s4">0.287822</span><span class="s0">, </span><span class="s4">0.128489</span><span class="s0">, </span><span class="s4">0.030957</span><span class="s0">, </span><span class="s4">0.030957</span><span class="s0">, </span><span class="s4">0.030957</span><span class="s1">])</span>
        <span class="s1">upper = np.array([</span><span class="s4">0.991983</span><span class="s0">, </span><span class="s4">0.970995</span><span class="s0">, </span><span class="s4">0.87378</span><span class="s0">, </span><span class="s4">0.739467</span><span class="s0">, </span><span class="s4">0.739467</span><span class="s0">,</span>
                          <span class="s4">0.739467</span><span class="s0">, </span><span class="s4">0.603133</span><span class="s0">, </span><span class="s4">0.430365</span><span class="s0">, </span><span class="s4">0.430365</span><span class="s0">, </span><span class="s4">0.430365</span><span class="s1">])</span>

        <span class="s1">sf_ci = res.sf.confidence_interval(method=</span><span class="s3">'log-log'</span><span class="s1">)</span>
        <span class="s1">cdf_ci = res.cdf.confidence_interval(method=</span><span class="s3">'log-log'</span><span class="s1">)</span>

        <span class="s1">assert_allclose(sf_ci.low.probabilities</span><span class="s0">, </span><span class="s1">lower</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.high.probabilities</span><span class="s0">, </span><span class="s1">upper</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(cdf_ci.low.probabilities</span><span class="s0">, </span><span class="s4">1</span><span class="s1">-upper</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(cdf_ci.high.probabilities</span><span class="s0">, </span><span class="s4">1</span><span class="s1">-lower</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-5</span><span class="s1">)</span>

        <span class="s2"># Test against R's `survival` library `survfit` function, 90%CI</span>
        <span class="s2"># library(survival)</span>
        <span class="s2"># options(digits=16)</span>
        <span class="s2"># time = c(3, 5, 8, 10, 5, 5, 8, 12, 15, 14, 2, 11, 10, 9, 12, 5, 8, 11)</span>
        <span class="s2"># status = c(1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1)</span>
        <span class="s2"># res = survfit(Surv(time, status)</span>
        <span class="s2"># ~1, conf.type = &quot;log-log&quot;, conf.int = 0.90)</span>
        <span class="s2"># res$time; res$lower; res$upper</span>
        <span class="s1">low = [</span><span class="s4">0.74366748406861172</span><span class="s0">, </span><span class="s4">0.68582332289196246</span><span class="s0">, </span><span class="s4">0.50596835651480121</span><span class="s0">,</span>
               <span class="s4">0.32913131413336727</span><span class="s0">, </span><span class="s4">0.32913131413336727</span><span class="s0">, </span><span class="s4">0.32913131413336727</span><span class="s0">,</span>
               <span class="s4">0.15986912028781664</span><span class="s0">, </span><span class="s4">0.04499539918147757</span><span class="s0">, </span><span class="s4">0.04499539918147757</span><span class="s0">,</span>
               <span class="s4">0.04499539918147757</span><span class="s1">]</span>
        <span class="s1">high = [</span><span class="s4">0.9890291867238429</span><span class="s0">, </span><span class="s4">0.9638835422144144</span><span class="s0">, </span><span class="s4">0.8560366823086629</span><span class="s0">,</span>
                <span class="s4">0.7130167643978450</span><span class="s0">, </span><span class="s4">0.7130167643978450</span><span class="s0">, </span><span class="s4">0.7130167643978450</span><span class="s0">,</span>
                <span class="s4">0.5678602982997164</span><span class="s0">, </span><span class="s4">0.3887616766886558</span><span class="s0">, </span><span class="s4">0.3887616766886558</span><span class="s0">,</span>
                <span class="s4">0.3887616766886558</span><span class="s1">]</span>
        <span class="s1">sf_ci = res.sf.confidence_interval(method=</span><span class="s3">'log-log'</span><span class="s0">,</span>
                                           <span class="s1">confidence_level=</span><span class="s4">0.9</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.low.probabilities</span><span class="s0">, </span><span class="s1">low)</span>
        <span class="s1">assert_allclose(sf_ci.high.probabilities</span><span class="s0">, </span><span class="s1">high)</span>

        <span class="s2"># And with conf.type = &quot;plain&quot;</span>
        <span class="s1">low = [</span><span class="s4">0.8556383113628162</span><span class="s0">, </span><span class="s4">0.7670478794850761</span><span class="s0">, </span><span class="s4">0.5485720663578469</span><span class="s0">,</span>
               <span class="s4">0.3441515412527123</span><span class="s0">, </span><span class="s4">0.3441515412527123</span><span class="s0">, </span><span class="s4">0.3441515412527123</span><span class="s0">,</span>
               <span class="s4">0.1449184105424544</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s4">0.</span><span class="s1">]</span>
        <span class="s1">high = [</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">0.8958723780865975</span><span class="s0">, </span><span class="s4">0.7391817920806210</span><span class="s0">,</span>
                <span class="s4">0.7391817920806210</span><span class="s0">, </span><span class="s4">0.7391817920806210</span><span class="s0">, </span><span class="s4">0.5773038116797676</span><span class="s0">,</span>
                <span class="s4">0.3642270254596720</span><span class="s0">, </span><span class="s4">0.3642270254596720</span><span class="s0">, </span><span class="s4">0.3642270254596720</span><span class="s1">]</span>
        <span class="s1">sf_ci = res.sf.confidence_interval(confidence_level=</span><span class="s4">0.9</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sf_ci.low.probabilities</span><span class="s0">, </span><span class="s1">low)</span>
        <span class="s1">assert_allclose(sf_ci.high.probabilities</span><span class="s0">, </span><span class="s1">high)</span>

    <span class="s0">def </span><span class="s1">test_right_censored_ci_nans(self):</span>
        <span class="s2"># test `ecdf` confidence interval on a problem that results in NaNs</span>
        <span class="s1">times</span><span class="s0">, </span><span class="s1">died = self.t1</span><span class="s0">, </span><span class="s1">self.d1</span>
        <span class="s1">sample = stats.CensoredData.right_censored(times</span><span class="s0">, </span><span class="s1">np.logical_not(died))</span>
        <span class="s1">res = stats.ecdf(sample)</span>

        <span class="s2"># Reference values generated with Matlab</span>
        <span class="s2"># format long</span>
        <span class="s2"># t = [37 43 47 56 60 62 71 77 80 81];</span>
        <span class="s2"># d = [0 0 1 1 0 0 0 1 1 1];</span>
        <span class="s2"># censored = ~d1;</span>
        <span class="s2"># [f, x, flo, fup] = ecdf(t, 'Censoring', censored, 'Alpha', 0.05);</span>
        <span class="s1">x = [</span><span class="s4">37</span><span class="s0">, </span><span class="s4">47</span><span class="s0">, </span><span class="s4">56</span><span class="s0">, </span><span class="s4">77</span><span class="s0">, </span><span class="s4">80</span><span class="s0">, </span><span class="s4">81</span><span class="s1">]</span>
        <span class="s1">flo = [np.nan</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.052701464070711</span><span class="s0">, </span><span class="s4">0.337611126231790</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">fup = [np.nan</span><span class="s0">, </span><span class="s4">0.35417230377</span><span class="s0">, </span><span class="s4">0.5500569798</span><span class="s0">, </span><span class="s4">0.9472985359</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">i = np.searchsorted(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">x)</span>

        <span class="s1">message = </span><span class="s3">&quot;The confidence interval is undefined at some observations&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.warns(RuntimeWarning</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci = res.cdf.confidence_interval()</span>

        <span class="s2"># Matlab gives NaN as the first element of the CIs. Mathematica agrees,</span>
        <span class="s2"># but R's survfit does not. It makes some sense, but it's not what the</span>
        <span class="s2"># formula gives, so skip that element.</span>
        <span class="s1">assert_allclose(ci.low.probabilities[i][</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">flo[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">assert_allclose(ci.high.probabilities[i][</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">fup[</span><span class="s4">1</span><span class="s1">:])</span>

        <span class="s2"># [f, x, flo, fup] = ecdf(t, 'Censoring', censored, 'Function',</span>
        <span class="s2">#                        'survivor', 'Alpha', 0.05);</span>
        <span class="s1">flo = [np.nan</span><span class="s0">, </span><span class="s4">0.64582769623</span><span class="s0">, </span><span class="s4">0.449943020228</span><span class="s0">, </span><span class="s4">0.05270146407</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">fup = [np.nan</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">0.947298535929289</span><span class="s0">, </span><span class="s4">0.662388873768210</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">i = np.searchsorted(res.cdf.quantiles</span><span class="s0">, </span><span class="s1">x)</span>

        <span class="s0">with </span><span class="s1">pytest.warns(RuntimeWarning</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci = res.sf.confidence_interval()</span>

        <span class="s1">assert_allclose(ci.low.probabilities[i][</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">flo[</span><span class="s4">1</span><span class="s1">:])</span>
        <span class="s1">assert_allclose(ci.high.probabilities[i][</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">fup[</span><span class="s4">1</span><span class="s1">:])</span>

        <span class="s2"># With the same data, R's `survival` library `survfit` function</span>
        <span class="s2"># doesn't produce the leading NaN</span>
        <span class="s2"># library(survival)</span>
        <span class="s2"># options(digits=16)</span>
        <span class="s2"># time = c(37, 43, 47, 56, 60, 62, 71, 77, 80, 81)</span>
        <span class="s2"># status = c(0, 0, 1, 1, 0, 0, 0, 1, 1, 1)</span>
        <span class="s2"># res = survfit(Surv(time, status)</span>
        <span class="s2"># ~1, conf.type = &quot;plain&quot;, conf.int = 0.95)</span>
        <span class="s2"># res$time</span>
        <span class="s2"># res$lower</span>
        <span class="s2"># res$upper</span>
        <span class="s1">low = [</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">0.64582769623233816</span><span class="s0">, </span><span class="s4">0.44994302022779326</span><span class="s0">,</span>
               <span class="s4">0.44994302022779326</span><span class="s0">, </span><span class="s4">0.44994302022779326</span><span class="s0">, </span><span class="s4">0.44994302022779326</span><span class="s0">,</span>
               <span class="s4">0.05270146407071086</span><span class="s0">, </span><span class="s4">0.</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">high = [</span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">1.</span><span class="s0">, </span><span class="s4">0.9472985359292891</span><span class="s0">,</span>
                <span class="s4">0.6623888737682101</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">assert_allclose(ci.low.probabilities</span><span class="s0">, </span><span class="s1">low)</span>
        <span class="s1">assert_allclose(ci.high.probabilities</span><span class="s0">, </span><span class="s1">high)</span>

        <span class="s2"># It does with conf.type=&quot;log-log&quot;, as do we</span>
        <span class="s0">with </span><span class="s1">pytest.warns(RuntimeWarning</span><span class="s0">, </span><span class="s1">match=message):</span>
            <span class="s1">ci = res.sf.confidence_interval(method=</span><span class="s3">'log-log'</span><span class="s1">)</span>
        <span class="s1">low = [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">0.38700001403202522</span><span class="s0">, </span><span class="s4">0.31480711370551911</span><span class="s0">,</span>
               <span class="s4">0.31480711370551911</span><span class="s0">, </span><span class="s4">0.31480711370551911</span><span class="s0">, </span><span class="s4">0.31480711370551911</span><span class="s0">,</span>
               <span class="s4">0.08048821148507734</span><span class="s0">, </span><span class="s4">0.01049958986680601</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">high = [np.nan</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s4">0.9813929658789660</span><span class="s0">, </span><span class="s4">0.9308983170906275</span><span class="s0">,</span>
                <span class="s4">0.9308983170906275</span><span class="s0">, </span><span class="s4">0.9308983170906275</span><span class="s0">, </span><span class="s4">0.9308983170906275</span><span class="s0">,</span>
                <span class="s4">0.8263946341076415</span><span class="s0">, </span><span class="s4">0.6558775085110887</span><span class="s0">, </span><span class="s1">np.nan]</span>
        <span class="s1">assert_allclose(ci.low.probabilities</span><span class="s0">, </span><span class="s1">low)</span>
        <span class="s1">assert_allclose(ci.high.probabilities</span><span class="s0">, </span><span class="s1">high)</span>

    <span class="s0">def </span><span class="s1">test_right_censored_against_uncensored(self):</span>
        <span class="s1">rng = np.random.default_rng(</span><span class="s4">7463952748044886637</span><span class="s1">)</span>
        <span class="s1">sample = rng.integers(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">100</span><span class="s0">, </span><span class="s1">size=</span><span class="s4">1000</span><span class="s1">)</span>
        <span class="s1">censored = np.zeros_like(sample)</span>
        <span class="s1">censored[np.argmax(sample)] = </span><span class="s0">True</span>
        <span class="s1">res = stats.ecdf(sample)</span>
        <span class="s1">ref = stats.ecdf(stats.CensoredData.right_censored(sample</span><span class="s0">, </span><span class="s1">censored))</span>
        <span class="s1">assert_equal(res.sf.quantiles</span><span class="s0">, </span><span class="s1">ref.sf.quantiles)</span>
        <span class="s1">assert_equal(res.sf._n</span><span class="s0">, </span><span class="s1">ref.sf._n)</span>
        <span class="s1">assert_equal(res.sf._d[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref.sf._d[:-</span><span class="s4">1</span><span class="s1">])  </span><span class="s2"># difference @ [-1]</span>
        <span class="s1">assert_allclose(res.sf._sf[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ref.sf._sf[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-14</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_plot_iv(self):</span>
        <span class="s1">rng = np.random.default_rng(</span><span class="s4">1769658657308472721</span><span class="s1">)</span>
        <span class="s1">n_unique = rng.integers(</span><span class="s4">10</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)</span>
        <span class="s1">sample</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = self.get_random_sample(rng</span><span class="s0">, </span><span class="s1">n_unique)</span>
        <span class="s1">res = stats.ecdf(sample)</span>

        <span class="s0">try</span><span class="s1">:</span>
            <span class="s0">import </span><span class="s1">matplotlib.pyplot </span><span class="s0">as </span><span class="s1">plt  </span><span class="s2"># noqa</span>
            <span class="s1">res.sf.plot()  </span><span class="s2"># no other errors occur</span>
        <span class="s0">except </span><span class="s1">(ModuleNotFoundError</span><span class="s0">, </span><span class="s1">ImportError):</span>
            <span class="s1">message = </span><span class="s3">r&quot;matplotlib must be installed to use method `plot`.&quot;</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ModuleNotFoundError</span><span class="s0">, </span><span class="s1">match=message):</span>
                <span class="s1">res.sf.plot()</span>


<span class="s0">class </span><span class="s1">TestLogRank:</span>

    <span class="s1">@pytest.mark.parametrize(</span>
        <span class="s3">&quot;x, y, statistic, pvalue&quot;</span><span class="s0">,</span>
        <span class="s2"># Results validate with R</span>
        <span class="s2"># library(survival)</span>
        <span class="s2"># options(digits=16)</span>
        <span class="s2">#</span>
        <span class="s2"># futime_1 &lt;- c(8, 12, 26, 14, 21, 27, 8, 32, 20, 40)</span>
        <span class="s2"># fustat_1 &lt;- c(1, 1, 1, 1, 1, 1, 0, 0, 0, 0)</span>
        <span class="s2"># rx_1 &lt;- c(0, 0, 0, 0, 0, 0, 0, 0, 0, 0)</span>
        <span class="s2">#</span>
        <span class="s2"># futime_2 &lt;- c(33, 28, 41, 48, 48, 25, 37, 48, 25, 43)</span>
        <span class="s2"># fustat_2 &lt;- c(1, 1, 1, 0, 0, 0, 0, 0, 0, 0)</span>
        <span class="s2"># rx_2 &lt;- c(1, 1, 1, 1, 1, 1, 1, 1, 1, 1)</span>
        <span class="s2">#</span>
        <span class="s2"># futime &lt;- c(futime_1, futime_2)</span>
        <span class="s2"># fustat &lt;- c(fustat_1, fustat_2)</span>
        <span class="s2"># rx &lt;- c(rx_1, rx_2)</span>
        <span class="s2">#</span>
        <span class="s2"># survdiff(formula = Surv(futime, fustat) ~ rx)</span>
        <span class="s2">#</span>
        <span class="s2"># Also check against another library which handle alternatives</span>
        <span class="s2"># library(nph)</span>
        <span class="s2"># logrank.test(futime, fustat, rx, alternative = &quot;two.sided&quot;)</span>
        <span class="s2"># res[&quot;test&quot;]</span>
        <span class="s1">[(</span>
              <span class="s2"># https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/BS704_Survival5.html  # noqa</span>
              <span class="s2"># uncensored, censored</span>
              <span class="s1">[[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">26</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">27</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">8</span><span class="s0">, </span><span class="s4">32</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">40</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s1">[[</span><span class="s4">33</span><span class="s0">, </span><span class="s4">28</span><span class="s0">, </span><span class="s4">41</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">48</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">37</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">43</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s2"># chi2, [&quot;two-sided&quot;, &quot;less&quot;, &quot;greater&quot;]</span>
              <span class="s4">6.91598157449</span><span class="s0">,</span>
              <span class="s1">[</span><span class="s4">0.008542873404</span><span class="s0">, </span><span class="s4">0.9957285632979385</span><span class="s0">, </span><span class="s4">0.004271436702061537</span><span class="s1">]</span>
         <span class="s1">)</span><span class="s0">,</span>
         <span class="s1">(</span>
              <span class="s2"># https://sphweb.bumc.bu.edu/otlt/mph-modules/bs/bs704_survival/BS704_Survival5.html  # noqa</span>
              <span class="s1">[[</span><span class="s4">19</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">20</span><span class="s0">, </span><span class="s4">19</span><span class="s0">, </span><span class="s4">17</span><span class="s0">, </span><span class="s4">14</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s1">[[</span><span class="s4">16</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">21</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">18</span><span class="s0">, </span><span class="s4">18</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s4">0.835004855038</span><span class="s0">,</span>
              <span class="s1">[</span><span class="s4">0.3608293039</span><span class="s0">, </span><span class="s4">0.8195853480676912</span><span class="s0">, </span><span class="s4">0.1804146519323088</span><span class="s1">]</span>
         <span class="s1">)</span><span class="s0">,</span>
         <span class="s1">(</span>
              <span class="s2"># Bland, Altman, &quot;The logrank test&quot;, BMJ, 2004</span>
              <span class="s2"># https://www.bmj.com/content/328/7447/1073.short</span>
              <span class="s1">[[</span><span class="s4">6</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">21</span><span class="s0">, </span><span class="s4">30</span><span class="s0">, </span><span class="s4">37</span><span class="s0">, </span><span class="s4">38</span><span class="s0">, </span><span class="s4">49</span><span class="s0">, </span><span class="s4">50</span><span class="s0">, </span><span class="s4">63</span><span class="s0">, </span><span class="s4">79</span><span class="s0">, </span><span class="s4">86</span><span class="s0">, </span><span class="s4">98</span><span class="s0">, </span><span class="s4">202</span><span class="s0">, </span><span class="s4">219</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">[</span><span class="s4">31</span><span class="s0">, </span><span class="s4">47</span><span class="s0">, </span><span class="s4">80</span><span class="s0">, </span><span class="s4">82</span><span class="s0">, </span><span class="s4">82</span><span class="s0">, </span><span class="s4">149</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s1">[[</span><span class="s4">10</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s0">, </span><span class="s4">17</span><span class="s0">, </span><span class="s4">18</span><span class="s0">, </span><span class="s4">20</span><span class="s0">, </span><span class="s4">24</span><span class="s0">, </span><span class="s4">24</span><span class="s0">, </span><span class="s4">25</span><span class="s0">, </span><span class="s4">28</span><span class="s0">, </span><span class="s4">30</span><span class="s0">,</span>
                <span class="s4">33</span><span class="s0">, </span><span class="s4">35</span><span class="s0">, </span><span class="s4">37</span><span class="s0">, </span><span class="s4">40</span><span class="s0">, </span><span class="s4">40</span><span class="s0">, </span><span class="s4">46</span><span class="s0">, </span><span class="s4">48</span><span class="s0">, </span><span class="s4">76</span><span class="s0">, </span><span class="s4">81</span><span class="s0">, </span><span class="s4">82</span><span class="s0">, </span><span class="s4">91</span><span class="s0">, </span><span class="s4">112</span><span class="s0">, </span><span class="s4">181</span><span class="s1">]</span><span class="s0">,</span>
               <span class="s1">[</span><span class="s4">34</span><span class="s0">, </span><span class="s4">40</span><span class="s0">, </span><span class="s4">70</span><span class="s1">]]</span><span class="s0">,</span>
              <span class="s4">7.49659416854</span><span class="s0">,</span>
              <span class="s1">[</span><span class="s4">0.006181578637</span><span class="s0">, </span><span class="s4">0.003090789318730882</span><span class="s0">, </span><span class="s4">0.9969092106812691</span><span class="s1">]</span>
         <span class="s1">)]</span>
    <span class="s1">)</span>
    <span class="s0">def </span><span class="s1">test_log_rank(self</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">statistic</span><span class="s0">, </span><span class="s1">pvalue):</span>
        <span class="s1">x = stats.CensoredData(uncensored=x[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">right=x[</span><span class="s4">1</span><span class="s1">])</span>
        <span class="s1">y = stats.CensoredData(uncensored=y[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">right=y[</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">alternative </span><span class="s0">in </span><span class="s1">enumerate([</span><span class="s3">&quot;two-sided&quot;</span><span class="s0">, </span><span class="s3">&quot;less&quot;</span><span class="s0">, </span><span class="s3">&quot;greater&quot;</span><span class="s1">]):</span>
            <span class="s1">res = stats.logrank(x=x</span><span class="s0">, </span><span class="s1">y=y</span><span class="s0">, </span><span class="s1">alternative=alternative)</span>

            <span class="s2"># we return z and use the normal distribution while other framework</span>
            <span class="s2"># return z**2. The p-value are directly comparable, but we have to</span>
            <span class="s2"># square the statistic</span>
            <span class="s1">assert_allclose(res.statistic**</span><span class="s4">2</span><span class="s0">, </span><span class="s1">statistic</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-10</span><span class="s1">)</span>
            <span class="s1">assert_allclose(res.pvalue</span><span class="s0">, </span><span class="s1">pvalue[i]</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-10</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_raises(self):</span>
        <span class="s1">sample = stats.CensoredData([</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>

        <span class="s1">msg = </span><span class="s3">r&quot;`y` must be&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">stats.logrank(x=sample</span><span class="s0">, </span><span class="s1">y=[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]])</span>

        <span class="s1">msg = </span><span class="s3">r&quot;`x` must be&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">stats.logrank(x=[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">y=sample)</span>
</pre>
</body>
</html>