<html>
<head>
<title>test_corrpsd.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #808080;}
.s1 { color: #a9b7c6;}
.s2 { color: #629755; font-style: italic;}
.s3 { color: #cc7832;}
.s4 { color: #6897bb;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_corrpsd.py</font>
</center></td></tr></table>
<pre><span class="s0"># -*- coding: utf-8 -*-</span>
<span class="s2">&quot;&quot;&quot;Tests for finding a positive semi-definite correlation or covariance matrix 
 
Created on Mon May 27 12:07:02 2013 
 
Author: Josef Perktold 
&quot;&quot;&quot;</span>
<span class="s3">import </span><span class="s1">warnings</span>

<span class="s3">import </span><span class="s1">numpy </span><span class="s3">as </span><span class="s1">np</span>
<span class="s3">from </span><span class="s1">numpy.testing </span><span class="s3">import </span><span class="s1">assert_almost_equal</span><span class="s3">, </span><span class="s1">assert_allclose</span>
<span class="s3">import </span><span class="s1">scipy.sparse </span><span class="s3">as </span><span class="s1">sparse</span>
<span class="s3">import </span><span class="s1">pytest</span>

<span class="s3">from </span><span class="s1">statsmodels.stats.correlation_tools </span><span class="s3">import </span><span class="s1">(</span>
    <span class="s1">corr_nearest</span><span class="s3">, </span><span class="s1">corr_clipped</span><span class="s3">, </span><span class="s1">cov_nearest</span><span class="s3">,</span>
    <span class="s1">_project_correlation_factors</span><span class="s3">, </span><span class="s1">corr_nearest_factor</span><span class="s3">, </span><span class="s1">_spg_optim</span><span class="s3">,</span>
    <span class="s1">corr_thresholded</span><span class="s3">, </span><span class="s1">cov_nearest_factor_homog</span><span class="s3">, </span><span class="s1">FactoredPSDMatrix)</span>
<span class="s3">from </span><span class="s1">statsmodels.tools.testing </span><span class="s3">import </span><span class="s1">Holder</span>


<span class="s3">def </span><span class="s1">norm_f(x</span><span class="s3">, </span><span class="s1">y):</span>
    <span class="s2">'''Frobenious norm (squared sum) of difference between two arrays 
    '''</span>
    <span class="s1">d = ((x - y)**</span><span class="s4">2</span><span class="s1">).sum()</span>
    <span class="s3">return </span><span class="s1">np.sqrt(d)</span>


<span class="s0"># R library Matrix results</span>
<span class="s1">cov1_r = Holder()</span>
<span class="s0">#&gt; nc  &lt;- nearPD(pr, conv.tol = 1e-7, keepDiag = TRUE, doDykstra =FALSE, corr=TRUE)</span>
<span class="s0">#&gt; cat_items(nc, prefix=&quot;cov1_r.&quot;)</span>
<span class="s1">cov1_r.mat = </span><span class="s5">'''&lt;S4 object of class structure(&quot;dpoMatrix&quot;, package = &quot;Matrix&quot;)&gt;'''</span>
<span class="s1">cov1_r.eigenvalues = np.array([</span>
     <span class="s4">4.197315628646795</span><span class="s3">, </span><span class="s4">0.7540460243978023</span><span class="s3">, </span><span class="s4">0.5077608149667492</span><span class="s3">,</span>
     <span class="s4">0.3801267599652769</span><span class="s3">, </span><span class="s4">0.1607508970775889</span><span class="s3">, </span><span class="s4">4.197315628646795e-08</span>
    <span class="s1">])</span>
<span class="s1">cov1_r.corr = </span><span class="s5">'''TRUE'''</span>
<span class="s1">cov1_r.normF = </span><span class="s4">0.0743805226512533</span>
<span class="s1">cov1_r.iterations = </span><span class="s4">11</span>
<span class="s1">cov1_r.rel_tol = </span><span class="s4">8.288594638441735e-08</span>
<span class="s1">cov1_r.converged = </span><span class="s5">'''TRUE'''</span>
<span class="s0">#&gt; mkarray2(as.matrix(nc$mat), name=&quot;cov1_r.mat&quot;)</span>
<span class="s1">cov1_r.mat = np.array([</span>
     <span class="s4">1</span><span class="s3">, </span><span class="s4">0.487968018215892</span><span class="s3">, </span><span class="s4">0.642651880010906</span><span class="s3">, </span><span class="s4">0.4906386709070835</span><span class="s3">,</span>
     <span class="s4">0.6440990530811909</span><span class="s3">, </span><span class="s4">0.8087111845493985</span><span class="s3">, </span><span class="s4">0.487968018215892</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,</span>
     <span class="s4">0.5141147294352735</span><span class="s3">, </span><span class="s4">0.2506688108312097</span><span class="s3">, </span><span class="s4">0.672351311297074</span><span class="s3">,</span>
     <span class="s4">0.725832055882795</span><span class="s3">, </span><span class="s4">0.642651880010906</span><span class="s3">, </span><span class="s4">0.5141147294352735</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,</span>
     <span class="s4">0.596827778712154</span><span class="s3">, </span><span class="s4">0.5821917790519067</span><span class="s3">, </span><span class="s4">0.7449631633814129</span><span class="s3">,</span>
     <span class="s4">0.4906386709070835</span><span class="s3">, </span><span class="s4">0.2506688108312097</span><span class="s3">, </span><span class="s4">0.596827778712154</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,</span>
     <span class="s4">0.729882058012399</span><span class="s3">, </span><span class="s4">0.772150225146826</span><span class="s3">, </span><span class="s4">0.6440990530811909</span><span class="s3">,</span>
     <span class="s4">0.672351311297074</span><span class="s3">, </span><span class="s4">0.5821917790519067</span><span class="s3">, </span><span class="s4">0.729882058012399</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,</span>
     <span class="s4">0.813191720191944</span><span class="s3">, </span><span class="s4">0.8087111845493985</span><span class="s3">, </span><span class="s4">0.725832055882795</span><span class="s3">,</span>
     <span class="s4">0.7449631633814129</span><span class="s3">, </span><span class="s4">0.772150225146826</span><span class="s3">, </span><span class="s4">0.813191720191944</span><span class="s3">, </span><span class="s4">1</span>
    <span class="s1">]).reshape(</span><span class="s4">6</span><span class="s3">,</span><span class="s4">6</span><span class="s3">, </span><span class="s1">order=</span><span class="s5">'F'</span><span class="s1">)</span>


<span class="s1">cov_r = Holder()</span>
<span class="s0">#nc  &lt;- nearPD(pr+0.01*diag(6), conv.tol = 1e-7, keepDiag = TRUE, doDykstra =FALSE, corr=FALSE)</span>
<span class="s0">#&gt; cat_items(nc, prefix=&quot;cov_r.&quot;)</span>
<span class="s0">#cov_r.mat = '''&lt;S4 object of class structure(&quot;dpoMatrix&quot;, package = &quot;Matrix&quot;)&gt;'''</span>
<span class="s1">cov_r.eigenvalues = np.array([</span>
     <span class="s4">4.209897516692652</span><span class="s3">, </span><span class="s4">0.7668341923072066</span><span class="s3">, </span><span class="s4">0.518956980021938</span><span class="s3">,</span>
     <span class="s4">0.390838551407132</span><span class="s3">, </span><span class="s4">0.1734728460460068</span><span class="s3">, </span><span class="s4">4.209897516692652e-08</span>
    <span class="s1">])</span>
<span class="s1">cov_r.corr = </span><span class="s5">'''FALSE'''</span>
<span class="s1">cov_r.normF = </span><span class="s4">0.0623948693159157</span>
<span class="s1">cov_r.iterations = </span><span class="s4">11</span>
<span class="s1">cov_r.rel_tol = </span><span class="s4">5.83987595937896e-08</span>
<span class="s1">cov_r.converged = </span><span class="s5">'''TRUE'''</span>

<span class="s0">#&gt; mkarray2(as.matrix(nc$mat), name=&quot;cov_r.mat&quot;)</span>
<span class="s1">cov_r.mat = np.array([</span>
     <span class="s4">1.01</span><span class="s3">, </span><span class="s4">0.486207476951913</span><span class="s3">, </span><span class="s4">0.6428524769306785</span><span class="s3">, </span><span class="s4">0.4886092840296514</span><span class="s3">,</span>
     <span class="s4">0.645175579158233</span><span class="s3">, </span><span class="s4">0.811533860074678</span><span class="s3">, </span><span class="s4">0.486207476951913</span><span class="s3">, </span><span class="s4">1.01</span><span class="s3">,</span>
     <span class="s4">0.514394615153752</span><span class="s3">, </span><span class="s4">0.2478398278204047</span><span class="s3">, </span><span class="s4">0.673852495852274</span><span class="s3">,</span>
     <span class="s4">0.7297661648968664</span><span class="s3">, </span><span class="s4">0.6428524769306785</span><span class="s3">, </span><span class="s4">0.514394615153752</span><span class="s3">, </span><span class="s4">1.01</span><span class="s3">,</span>
     <span class="s4">0.5971503271420517</span><span class="s3">, </span><span class="s4">0.582018469844712</span><span class="s3">, </span><span class="s4">0.7445177382760834</span><span class="s3">,</span>
     <span class="s4">0.4886092840296514</span><span class="s3">, </span><span class="s4">0.2478398278204047</span><span class="s3">, </span><span class="s4">0.5971503271420517</span><span class="s3">, </span><span class="s4">1.01</span><span class="s3">,</span>
     <span class="s4">0.73161232298669</span><span class="s3">, </span><span class="s4">0.7766852947049376</span><span class="s3">, </span><span class="s4">0.645175579158233</span><span class="s3">,</span>
     <span class="s4">0.673852495852274</span><span class="s3">, </span><span class="s4">0.582018469844712</span><span class="s3">, </span><span class="s4">0.73161232298669</span><span class="s3">, </span><span class="s4">1.01</span><span class="s3">,</span>
     <span class="s4">0.8107916469252828</span><span class="s3">, </span><span class="s4">0.811533860074678</span><span class="s3">, </span><span class="s4">0.7297661648968664</span><span class="s3">,</span>
     <span class="s4">0.7445177382760834</span><span class="s3">, </span><span class="s4">0.7766852947049376</span><span class="s3">, </span><span class="s4">0.8107916469252828</span><span class="s3">, </span><span class="s4">1.01</span>
    <span class="s1">]).reshape(</span><span class="s4">6</span><span class="s3">,</span><span class="s4">6</span><span class="s3">, </span><span class="s1">order=</span><span class="s5">'F'</span><span class="s1">)</span>


<span class="s3">def </span><span class="s1">test_corr_psd():</span>
    <span class="s0"># test positive definite matrix is unchanged</span>
    <span class="s1">x = np.array([[</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.2</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.9</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.2</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">0.9</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.2</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s1">y = corr_nearest(x</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s0">#print np.max(np.abs(x - y))</span>
    <span class="s1">assert_almost_equal(x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">14</span><span class="s1">)</span>

    <span class="s1">y = corr_clipped(x)</span>
    <span class="s1">assert_almost_equal(x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">14</span><span class="s1">)</span>

    <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(x</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">14</span><span class="s1">)</span>

    <span class="s1">x2 = x + </span><span class="s4">0.001 </span><span class="s1">* np.eye(</span><span class="s4">3</span><span class="s1">)</span>
    <span class="s1">y = cov_nearest(x2</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">assert_almost_equal(x2</span><span class="s3">, </span><span class="s1">y</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">14</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">CheckCorrPSDMixin:</span>

    <span class="s3">def </span><span class="s1">test_nearest(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">res_r = self.res</span>
        <span class="s1">y = corr_nearest(x</span><span class="s3">, </span><span class="s1">threshold=</span><span class="s4">1e-7</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s1">)</span>
        <span class="s0">#print np.max(np.abs(x - y))</span>
        <span class="s1">assert_almost_equal(y</span><span class="s3">, </span><span class="s1">res_r.mat</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">d = norm_f(x</span><span class="s3">, </span><span class="s1">y)</span>
        <span class="s1">assert_allclose(d</span><span class="s3">, </span><span class="s1">res_r.normF</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.0015</span><span class="s1">)</span>
        <span class="s1">evals = np.linalg.eigvalsh(y)</span>
        <span class="s0">#print 'evals', evals / res_r.eigenvalues[::-1] - 1</span>
        <span class="s1">assert_allclose(evals</span><span class="s3">, </span><span class="s1">res_r.eigenvalues[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.003</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>
        <span class="s0">#print evals[0] / 1e-7 - 1</span>
        <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s4">1e-7</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_clipped(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">res_r = self.res</span>
        <span class="s1">y = corr_clipped(x</span><span class="s3">, </span><span class="s1">threshold=</span><span class="s4">1e-7</span><span class="s1">)</span>
        <span class="s0">#print np.max(np.abs(x - y)), np.max(np.abs((x - y) / y))</span>
        <span class="s1">assert_almost_equal(y</span><span class="s3">, </span><span class="s1">res_r.mat</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">d = norm_f(x</span><span class="s3">, </span><span class="s1">y)</span>
        <span class="s1">assert_allclose(d</span><span class="s3">, </span><span class="s1">res_r.normF</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.15</span><span class="s1">)</span>

        <span class="s1">evals = np.linalg.eigvalsh(y)</span>
        <span class="s1">assert_allclose(evals</span><span class="s3">, </span><span class="s1">res_r.eigenvalues[::-</span><span class="s4">1</span><span class="s1">]</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.1</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>
        <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s4">1e-7</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.02</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_cov_nearest(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">res_r = self.res</span>
        <span class="s3">with </span><span class="s1">warnings.catch_warnings():</span>
            <span class="s1">warnings.simplefilter(</span><span class="s5">&quot;ignore&quot;</span><span class="s1">)</span>
            <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'nearest'</span><span class="s3">, </span><span class="s1">threshold=</span><span class="s4">1e-7</span><span class="s1">)</span>
        <span class="s0">#print np.max(np.abs(x - y))</span>
        <span class="s1">assert_almost_equal(y</span><span class="s3">, </span><span class="s1">res_r.mat</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">d = norm_f(x</span><span class="s3">, </span><span class="s1">y)</span>
        <span class="s1">assert_allclose(d</span><span class="s3">, </span><span class="s1">res_r.normF</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.0015</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestCovPSD:</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">x = np.array([ </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.477</span><span class="s3">, </span><span class="s4">0.644</span><span class="s3">, </span><span class="s4">0.478</span><span class="s3">, </span><span class="s4">0.651</span><span class="s3">, </span><span class="s4">0.826</span><span class="s3">,</span>
                       <span class="s4">0.477</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.516</span><span class="s3">, </span><span class="s4">0.233</span><span class="s3">, </span><span class="s4">0.682</span><span class="s3">, </span><span class="s4">0.75</span><span class="s3">,</span>
                       <span class="s4">0.644</span><span class="s3">, </span><span class="s4">0.516</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.599</span><span class="s3">, </span><span class="s4">0.581</span><span class="s3">, </span><span class="s4">0.742</span><span class="s3">,</span>
                       <span class="s4">0.478</span><span class="s3">, </span><span class="s4">0.233</span><span class="s3">, </span><span class="s4">0.599</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.741</span><span class="s3">, </span><span class="s4">0.8</span><span class="s3">,</span>
                       <span class="s4">0.651</span><span class="s3">, </span><span class="s4">0.682</span><span class="s3">, </span><span class="s4">0.581</span><span class="s3">, </span><span class="s4">0.741</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.798</span><span class="s3">,</span>
                       <span class="s4">0.826</span><span class="s3">, </span><span class="s4">0.75</span><span class="s3">,  </span><span class="s4">0.742</span><span class="s3">, </span><span class="s4">0.8</span><span class="s3">,   </span><span class="s4">0.798</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]).reshape(</span><span class="s4">6</span><span class="s3">,</span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">cls.x = x + </span><span class="s4">0.01 </span><span class="s1">* np.eye(</span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">cls.res = cov_r</span>

    <span class="s3">def </span><span class="s1">test_cov_nearest(self):</span>
        <span class="s1">x = self.x</span>
        <span class="s1">res_r = self.res</span>
        <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'nearest'</span><span class="s1">)</span>
        <span class="s0">#print np.max(np.abs(x - y))</span>
        <span class="s1">assert_almost_equal(y</span><span class="s3">, </span><span class="s1">res_r.mat</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">3</span><span class="s1">)</span>
        <span class="s1">d = norm_f(x</span><span class="s3">, </span><span class="s1">y)</span>
        <span class="s1">assert_allclose(d</span><span class="s3">, </span><span class="s1">res_r.normF</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.001</span><span class="s1">)</span>

        <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'clipped'</span><span class="s1">)</span>
        <span class="s0">#print np.max(np.abs(x - y))</span>
        <span class="s1">assert_almost_equal(y</span><span class="s3">, </span><span class="s1">res_r.mat</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">d = norm_f(x</span><span class="s3">, </span><span class="s1">y)</span>
        <span class="s1">assert_allclose(d</span><span class="s3">, </span><span class="s1">res_r.normF</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.15</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">TestCorrPSD1(CheckCorrPSDMixin):</span>

    <span class="s1">@classmethod</span>
    <span class="s3">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">x = np.array([ </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.477</span><span class="s3">, </span><span class="s4">0.644</span><span class="s3">, </span><span class="s4">0.478</span><span class="s3">, </span><span class="s4">0.651</span><span class="s3">, </span><span class="s4">0.826</span><span class="s3">,</span>
                       <span class="s4">0.477</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.516</span><span class="s3">, </span><span class="s4">0.233</span><span class="s3">, </span><span class="s4">0.682</span><span class="s3">, </span><span class="s4">0.75</span><span class="s3">,</span>
                       <span class="s4">0.644</span><span class="s3">, </span><span class="s4">0.516</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.599</span><span class="s3">, </span><span class="s4">0.581</span><span class="s3">, </span><span class="s4">0.742</span><span class="s3">,</span>
                       <span class="s4">0.478</span><span class="s3">, </span><span class="s4">0.233</span><span class="s3">, </span><span class="s4">0.599</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.741</span><span class="s3">, </span><span class="s4">0.8</span><span class="s3">,</span>
                       <span class="s4">0.651</span><span class="s3">, </span><span class="s4">0.682</span><span class="s3">, </span><span class="s4">0.581</span><span class="s3">, </span><span class="s4">0.741</span><span class="s3">, </span><span class="s4">1</span><span class="s3">,     </span><span class="s4">0.798</span><span class="s3">,</span>
                       <span class="s4">0.826</span><span class="s3">, </span><span class="s4">0.75</span><span class="s3">,  </span><span class="s4">0.742</span><span class="s3">, </span><span class="s4">0.8</span><span class="s3">,   </span><span class="s4">0.798</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]).reshape(</span><span class="s4">6</span><span class="s3">,</span><span class="s4">6</span><span class="s1">)</span>
        <span class="s1">cls.x = x</span>
        <span class="s1">cls.res = cov1_r</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s5">'threshold'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">0</span><span class="s3">, </span><span class="s4">1e-15</span><span class="s3">, </span><span class="s4">1e-10</span><span class="s3">, </span><span class="s4">1e-6</span><span class="s1">])</span>
<span class="s3">def </span><span class="s1">test_corrpsd_threshold(threshold):</span>
    <span class="s1">x = np.array([[</span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.9</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.9</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">0.9</span><span class="s3">, </span><span class="s4">1</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.9</span><span class="s1">]</span><span class="s3">, </span><span class="s1">[-</span><span class="s4">0.9</span><span class="s3">, </span><span class="s1">-</span><span class="s4">0.9</span><span class="s3">, </span><span class="s4">1</span><span class="s1">]])</span>

    <span class="s1">y = corr_nearest(x</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">threshold=threshold)</span>
    <span class="s1">evals = np.linalg.eigvalsh(y)</span>
    <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">threshold</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-15</span><span class="s1">)</span>

    <span class="s1">y = corr_clipped(x</span><span class="s3">, </span><span class="s1">threshold=threshold)</span>
    <span class="s1">evals = np.linalg.eigvalsh(y)</span>
    <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">threshold</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-15</span><span class="s1">)</span>

    <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">method=</span><span class="s5">'nearest'</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">threshold=threshold)</span>
    <span class="s1">evals = np.linalg.eigvalsh(y)</span>
    <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">threshold</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-15</span><span class="s1">)</span>

    <span class="s1">y = cov_nearest(x</span><span class="s3">, </span><span class="s1">n_fact=</span><span class="s4">100</span><span class="s3">, </span><span class="s1">threshold=threshold)</span>
    <span class="s1">evals = np.linalg.eigvalsh(y)</span>
    <span class="s1">assert_allclose(evals[</span><span class="s4">0</span><span class="s1">]</span><span class="s3">, </span><span class="s1">threshold</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-15</span><span class="s1">)</span>


<span class="s3">class </span><span class="s1">Test_Factor:</span>

    <span class="s3">def </span><span class="s1">test_corr_nearest_factor_arrpack(self):</span>

        <span class="s0"># regression results for svds call</span>
        <span class="s1">u2 = np.array([[</span>
         <span class="s4">6.39407581e-19</span><span class="s3">,   </span><span class="s4">9.15225947e-03</span><span class="s3">,   </span><span class="s4">1.82631698e-02</span><span class="s3">,</span>
         <span class="s4">2.72917181e-02</span><span class="s3">,   </span><span class="s4">3.61975557e-02</span><span class="s3">,   </span><span class="s4">4.49413101e-02</span><span class="s3">,</span>
         <span class="s4">5.34848732e-02</span><span class="s3">,   </span><span class="s4">6.17916613e-02</span><span class="s3">,   </span><span class="s4">6.98268388e-02</span><span class="s3">,</span>
         <span class="s4">7.75575058e-02</span><span class="s3">,   </span><span class="s4">8.49528448e-02</span><span class="s3">,   </span><span class="s4">9.19842264e-02</span><span class="s3">,</span>
         <span class="s4">9.86252769e-02</span><span class="s3">,   </span><span class="s4">1.04851906e-01</span><span class="s3">,   </span><span class="s4">1.10642305e-01</span><span class="s3">,</span>
         <span class="s4">1.15976906e-01</span><span class="s3">,   </span><span class="s4">1.20838331e-01</span><span class="s3">,   </span><span class="s4">1.25211306e-01</span><span class="s3">,</span>
         <span class="s4">1.29082570e-01</span><span class="s3">,   </span><span class="s4">1.32440778e-01</span><span class="s3">,   </span><span class="s4">1.35276397e-01</span><span class="s3">,</span>
         <span class="s4">1.37581605e-01</span><span class="s3">,   </span><span class="s4">1.39350201e-01</span><span class="s3">,   </span><span class="s4">1.40577526e-01</span><span class="s3">,</span>
         <span class="s4">1.41260396e-01</span><span class="s3">,   </span><span class="s4">1.41397057e-01</span><span class="s3">,   </span><span class="s4">1.40987160e-01</span><span class="s3">,</span>
         <span class="s4">1.40031756e-01</span><span class="s3">,   </span><span class="s4">1.38533306e-01</span><span class="s3">,   </span><span class="s4">1.36495727e-01</span><span class="s3">,</span>
         <span class="s4">1.33924439e-01</span><span class="s3">,   </span><span class="s4">1.30826443e-01</span><span class="s3">,   </span><span class="s4">1.27210404e-01</span><span class="s3">,</span>
         <span class="s4">1.23086750e-01</span><span class="s3">,   </span><span class="s4">1.18467769e-01</span><span class="s3">,   </span><span class="s4">1.13367717e-01</span><span class="s3">,</span>
         <span class="s4">1.07802909e-01</span><span class="s3">,   </span><span class="s4">1.01791811e-01</span><span class="s3">,   </span><span class="s4">9.53551023e-02</span><span class="s3">,</span>
         <span class="s4">8.85157320e-02</span><span class="s3">,   </span><span class="s4">8.12989329e-02</span><span class="s3">,   </span><span class="s4">7.37322125e-02</span><span class="s3">,</span>
         <span class="s4">6.58453049e-02</span><span class="s3">,   </span><span class="s4">5.76700847e-02</span><span class="s3">,   </span><span class="s4">4.92404406e-02</span><span class="s3">,</span>
         <span class="s4">4.05921079e-02</span><span class="s3">,   </span><span class="s4">3.17624629e-02</span><span class="s3">,   </span><span class="s4">2.27902803e-02</span><span class="s3">,</span>
         <span class="s4">1.37154584e-02</span><span class="s3">,   </span><span class="s4">4.57871801e-03</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">4.57871801e-03</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.37154584e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">2.27902803e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">3.17624629e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">4.05921079e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">4.92404406e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">5.76700847e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">6.58453049e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">7.37322125e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">8.12989329e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">8.85157320e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">9.53551023e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.01791811e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.07802909e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.13367717e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.18467769e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.23086750e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.27210404e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.30826443e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.33924439e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.36495727e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.38533306e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.40031756e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.40987160e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.41397057e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.41260396e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.40577526e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.39350201e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.37581605e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.35276397e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.32440778e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.29082570e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.25211306e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.20838331e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">1.15976906e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.10642305e-01</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.04851906e-01</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">9.86252769e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">9.19842264e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">8.49528448e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">7.75575058e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">6.98268388e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">6.17916613e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">5.34848732e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">4.49413101e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">3.61975557e-02</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">2.72917181e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">1.82631698e-02</span><span class="s3">,  </span><span class="s1">-</span><span class="s4">9.15225947e-03</span><span class="s3">,</span>
        <span class="s1">-</span><span class="s4">3.51829569e-17</span><span class="s1">]]).T</span>
        <span class="s1">s2 = np.array([ </span><span class="s4">24.88812183</span><span class="s1">])</span>

        <span class="s1">d = </span><span class="s4">100</span>
        <span class="s1">dm = </span><span class="s4">1</span>

        <span class="s0"># Construct a test matrix with exact factor structure</span>
        <span class="s1">X = np.zeros((d</span><span class="s3">,</span><span class="s1">dm)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">x = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s1">*np.pi</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range(dm):</span>
            <span class="s1">X[:</span><span class="s3">,</span><span class="s1">j] = np.sin(x*(j+</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">_project_correlation_factors(X)</span>
        <span class="s1">X *= </span><span class="s4">0.7</span>
        <span class="s1">mat = np.dot(X</span><span class="s3">, </span><span class="s1">X.T)</span>
        <span class="s1">np.fill_diagonal(mat</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">)</span>

        <span class="s3">from </span><span class="s1">scipy.sparse.linalg </span><span class="s3">import </span><span class="s1">svds</span>
        <span class="s1">u</span><span class="s3">, </span><span class="s1">s</span><span class="s3">, </span><span class="s1">vt = svds(mat</span><span class="s3">, </span><span class="s1">dm)</span>

        <span class="s0">#difference in sign</span>
        <span class="s1">dsign = np.sign(u[</span><span class="s4">1</span><span class="s1">]) * np.sign(u2[</span><span class="s4">1</span><span class="s1">])</span>

        <span class="s1">assert_allclose(u</span><span class="s3">, </span><span class="s1">dsign * u2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-14</span><span class="s1">)</span>
        <span class="s1">assert_allclose(s</span><span class="s3">, </span><span class="s1">s2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'dm'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s3">def </span><span class="s1">test_corr_nearest_factor(self</span><span class="s3">, </span><span class="s1">dm):</span>

        <span class="s1">objvals = [np.array([</span><span class="s4">6241.8</span><span class="s3">, </span><span class="s4">6241.8</span><span class="s3">, </span><span class="s4">579.4</span><span class="s3">, </span><span class="s4">264.6</span><span class="s3">, </span><span class="s4">264.3</span><span class="s1">])</span><span class="s3">,</span>
                   <span class="s1">np.array([</span><span class="s4">2104.9</span><span class="s3">, </span><span class="s4">2104.9</span><span class="s3">, </span><span class="s4">710.5</span><span class="s3">, </span><span class="s4">266.3</span><span class="s3">, </span><span class="s4">286.1</span><span class="s1">])]</span>

        <span class="s1">d = </span><span class="s4">100</span>

        <span class="s0"># Construct a test matrix with exact factor structure</span>
        <span class="s1">X = np.zeros((d</span><span class="s3">, </span><span class="s1">dm)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">x = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* np.pi</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">np.random.seed(</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range(dm):</span>
            <span class="s1">X[:</span><span class="s3">, </span><span class="s1">j] = np.sin(x * (j + </span><span class="s4">1</span><span class="s1">)) + </span><span class="s4">1e-10 </span><span class="s1">* np.random.randn(d)</span>

        <span class="s1">_project_correlation_factors(X)</span>
        <span class="s3">assert </span><span class="s1">np.isfinite(X).all()</span>
        <span class="s1">X *= </span><span class="s4">0.7</span>
        <span class="s1">mat = np.dot(X</span><span class="s3">, </span><span class="s1">X.T)</span>
        <span class="s1">np.fill_diagonal(mat</span><span class="s3">, </span><span class="s4">1.</span><span class="s1">)</span>

        <span class="s0"># Try to recover the structure</span>
        <span class="s1">rslt = corr_nearest_factor(mat</span><span class="s3">, </span><span class="s1">dm</span><span class="s3">, </span><span class="s1">maxiter=</span><span class="s4">10000</span><span class="s1">)</span>
        <span class="s1">err_msg = </span><span class="s5">'rank=%d, niter=%d' </span><span class="s1">% (dm</span><span class="s3">, </span><span class="s1">len(rslt.objective_values))</span>
        <span class="s1">assert_allclose(rslt.objective_values[:</span><span class="s4">5</span><span class="s1">]</span><span class="s3">, </span><span class="s1">objvals[dm - </span><span class="s4">1</span><span class="s1">]</span><span class="s3">,</span>
                        <span class="s1">rtol=</span><span class="s4">0.5</span><span class="s3">, </span><span class="s1">err_msg=err_msg)</span>
        <span class="s3">assert </span><span class="s1">rslt.Converged</span>

        <span class="s1">mat1 = rslt.corr.to_matrix()</span>
        <span class="s1">assert_allclose(mat</span><span class="s3">, </span><span class="s1">mat1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s3">, </span><span class="s1">err_msg=err_msg)</span>

    <span class="s1">@pytest.mark.slow</span>
    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'dm'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s3">def </span><span class="s1">test_corr_nearest_factor_sparse(self</span><span class="s3">, </span><span class="s1">dm):</span>
        <span class="s0"># Test that result is the same if the input is dense or sparse</span>
        <span class="s1">d = </span><span class="s4">200</span>

        <span class="s0"># Generate a test matrix of factors</span>
        <span class="s1">X = np.zeros((d</span><span class="s3">, </span><span class="s1">dm)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">x = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2 </span><span class="s1">* np.pi</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">rs = np.random.RandomState(</span><span class="s4">10</span><span class="s1">)</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range(dm):</span>
            <span class="s1">X[:</span><span class="s3">, </span><span class="s1">j] = np.sin(x * (j + </span><span class="s4">1</span><span class="s1">)) + rs.randn(d)</span>

        <span class="s0"># Get the correlation matrix</span>
        <span class="s1">_project_correlation_factors(X)</span>
        <span class="s1">X *= </span><span class="s4">0.7</span>
        <span class="s1">mat = np.dot(X</span><span class="s3">, </span><span class="s1">X.T)</span>
        <span class="s1">np.fill_diagonal(mat</span><span class="s3">, </span><span class="s4">1</span><span class="s1">)</span>

        <span class="s0"># Threshold it</span>
        <span class="s1">mat.flat[np.abs(mat.flat) &lt; </span><span class="s4">0.35</span><span class="s1">] = </span><span class="s4">0.0</span>
        <span class="s1">smat = sparse.csr_matrix(mat)</span>

        <span class="s1">dense_rslt = corr_nearest_factor(mat</span><span class="s3">, </span><span class="s1">dm</span><span class="s3">, </span><span class="s1">maxiter=</span><span class="s4">10000</span><span class="s1">)</span>
        <span class="s1">sparse_rslt = corr_nearest_factor(smat</span><span class="s3">, </span><span class="s1">dm</span><span class="s3">, </span><span class="s1">maxiter=</span><span class="s4">10000</span><span class="s1">)</span>

        <span class="s1">mat_dense = dense_rslt.corr.to_matrix()</span>
        <span class="s1">mat_sparse = sparse_rslt.corr.to_matrix()</span>

        <span class="s3">assert </span><span class="s1">dense_rslt.Converged </span><span class="s3">is </span><span class="s1">sparse_rslt.Converged</span>
        <span class="s3">assert </span><span class="s1">dense_rslt.Converged </span><span class="s3">is True</span>

        <span class="s1">assert_allclose(mat_dense</span><span class="s3">, </span><span class="s1">mat_sparse</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s0"># Test on a quadratic function.</span>
    <span class="s3">def </span><span class="s1">test_spg_optim(self</span><span class="s3">, </span><span class="s1">reset_randomstate):</span>

        <span class="s1">dm = </span><span class="s4">100</span>

        <span class="s1">ind = np.arange(dm)</span>
        <span class="s1">indmat = np.abs(ind[:</span><span class="s3">,None</span><span class="s1">] - ind[</span><span class="s3">None,</span><span class="s1">:])</span>
        <span class="s1">M = </span><span class="s4">0.8</span><span class="s1">**indmat</span>

        <span class="s3">def </span><span class="s1">obj(x):</span>
            <span class="s3">return </span><span class="s1">np.dot(x</span><span class="s3">, </span><span class="s1">np.dot(M</span><span class="s3">, </span><span class="s1">x))</span>

        <span class="s3">def </span><span class="s1">grad(x):</span>
            <span class="s3">return </span><span class="s4">2</span><span class="s1">*np.dot(M</span><span class="s3">, </span><span class="s1">x)</span>

        <span class="s3">def </span><span class="s1">project(x):</span>
            <span class="s3">return </span><span class="s1">x</span>

        <span class="s1">x = np.random.normal(size=dm)</span>
        <span class="s1">rslt = _spg_optim(obj</span><span class="s3">, </span><span class="s1">grad</span><span class="s3">, </span><span class="s1">x</span><span class="s3">, </span><span class="s1">project)</span>
        <span class="s1">xnew = rslt.params</span>
        <span class="s3">assert </span><span class="s1">rslt.Converged </span><span class="s3">is True</span>
        <span class="s1">assert_almost_equal(obj(xnew)</span><span class="s3">, </span><span class="s4">0</span><span class="s3">, </span><span class="s1">decimal=</span><span class="s4">3</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_decorrelate(self</span><span class="s3">, </span><span class="s1">reset_randomstate):</span>

        <span class="s1">d = </span><span class="s4">30</span>
        <span class="s1">dg = np.linspace(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">root = np.random.normal(size=(d</span><span class="s3">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">fac = FactoredPSDMatrix(dg</span><span class="s3">, </span><span class="s1">root)</span>
        <span class="s1">mat = fac.to_matrix()</span>
        <span class="s1">rmat = np.linalg.cholesky(mat)</span>
        <span class="s1">dcr = fac.decorrelate(rmat)</span>
        <span class="s1">idm = np.dot(dcr</span><span class="s3">, </span><span class="s1">dcr.T)</span>
        <span class="s1">assert_almost_equal(idm</span><span class="s3">, </span><span class="s1">np.eye(d))</span>

        <span class="s1">rhs = np.random.normal(size=(d</span><span class="s3">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">mat2 = np.dot(rhs.T</span><span class="s3">, </span><span class="s1">np.linalg.solve(mat</span><span class="s3">, </span><span class="s1">rhs))</span>
        <span class="s1">mat3 = fac.decorrelate(rhs)</span>
        <span class="s1">mat3 = np.dot(mat3.T</span><span class="s3">, </span><span class="s1">mat3)</span>
        <span class="s1">assert_almost_equal(mat2</span><span class="s3">, </span><span class="s1">mat3)</span>

    <span class="s3">def </span><span class="s1">test_logdet(self</span><span class="s3">, </span><span class="s1">reset_randomstate):</span>

        <span class="s1">d = </span><span class="s4">30</span>
        <span class="s1">dg = np.linspace(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">root = np.random.normal(size=(d</span><span class="s3">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">fac = FactoredPSDMatrix(dg</span><span class="s3">, </span><span class="s1">root)</span>
        <span class="s1">mat = fac.to_matrix()</span>

        <span class="s1">_</span><span class="s3">, </span><span class="s1">ld = np.linalg.slogdet(mat)</span>
        <span class="s1">ld2 = fac.logdet()</span>

        <span class="s1">assert_almost_equal(ld</span><span class="s3">, </span><span class="s1">ld2)</span>

    <span class="s3">def </span><span class="s1">test_solve(self</span><span class="s3">, </span><span class="s1">reset_randomstate):</span>

        <span class="s1">d = </span><span class="s4">30</span>
        <span class="s1">dg = np.linspace(</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s1">root = np.random.normal(size=(d</span><span class="s3">, </span><span class="s4">2</span><span class="s1">))</span>
        <span class="s1">fac = FactoredPSDMatrix(dg</span><span class="s3">, </span><span class="s1">root)</span>
        <span class="s1">rhs = np.random.normal(size=(d</span><span class="s3">, </span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">sr1 = fac.solve(rhs)</span>
        <span class="s1">mat = fac.to_matrix()</span>
        <span class="s1">sr2 = np.linalg.solve(mat</span><span class="s3">, </span><span class="s1">rhs)</span>
        <span class="s1">assert_almost_equal(sr1</span><span class="s3">, </span><span class="s1">sr2)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'dm'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s3">def </span><span class="s1">test_cov_nearest_factor_homog(self</span><span class="s3">, </span><span class="s1">dm):</span>

        <span class="s1">d = </span><span class="s4">100</span>

        <span class="s0"># Construct a test matrix with exact factor structure</span>
        <span class="s1">X = np.zeros((d</span><span class="s3">, </span><span class="s1">dm)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">x = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s1">*np.pi</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range(dm):</span>
            <span class="s1">X[:</span><span class="s3">, </span><span class="s1">j] = np.sin(x*(j+</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">mat = np.dot(X</span><span class="s3">, </span><span class="s1">X.T)</span>
        <span class="s1">np.fill_diagonal(mat</span><span class="s3">, </span><span class="s1">np.diag(mat) + </span><span class="s4">3.1</span><span class="s1">)</span>

        <span class="s0"># Try to recover the structure</span>
        <span class="s1">rslt = cov_nearest_factor_homog(mat</span><span class="s3">, </span><span class="s1">dm)</span>
        <span class="s1">mat1 = rslt.to_matrix()</span>

        <span class="s1">assert_allclose(mat</span><span class="s3">, </span><span class="s1">mat1</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s1">@pytest.mark.parametrize(</span><span class="s5">'dm'</span><span class="s3">, </span><span class="s1">[</span><span class="s4">1</span><span class="s3">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s3">def </span><span class="s1">test_cov_nearest_factor_homog_sparse(self</span><span class="s3">, </span><span class="s1">dm):</span>
        <span class="s0"># Check that dense and sparse inputs give the same result</span>

        <span class="s1">d = </span><span class="s4">100</span>

        <span class="s0"># Construct a test matrix with exact factor structure</span>
        <span class="s1">X = np.zeros((d</span><span class="s3">, </span><span class="s1">dm)</span><span class="s3">, </span><span class="s1">dtype=np.float64)</span>
        <span class="s1">x = np.linspace(</span><span class="s4">0</span><span class="s3">, </span><span class="s4">2</span><span class="s1">*np.pi</span><span class="s3">, </span><span class="s1">d)</span>
        <span class="s3">for </span><span class="s1">j </span><span class="s3">in </span><span class="s1">range(dm):</span>
            <span class="s1">X[:</span><span class="s3">, </span><span class="s1">j] = np.sin(x*(j+</span><span class="s4">1</span><span class="s1">))</span>
        <span class="s1">mat = np.dot(X</span><span class="s3">, </span><span class="s1">X.T)</span>
        <span class="s1">np.fill_diagonal(mat</span><span class="s3">, </span><span class="s1">np.diag(mat) + </span><span class="s4">3.1</span><span class="s1">)</span>

        <span class="s0"># Fit to dense</span>
        <span class="s1">rslt = cov_nearest_factor_homog(mat</span><span class="s3">, </span><span class="s1">dm)</span>
        <span class="s1">mat1 = rslt.to_matrix()</span>

        <span class="s0"># Fit to sparse</span>
        <span class="s1">smat = sparse.csr_matrix(mat)</span>
        <span class="s1">rslt = cov_nearest_factor_homog(smat</span><span class="s3">, </span><span class="s1">dm)</span>
        <span class="s1">mat2 = rslt.to_matrix()</span>

        <span class="s1">assert_allclose(mat1</span><span class="s3">, </span><span class="s1">mat2</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s3">def </span><span class="s1">test_corr_thresholded(self</span><span class="s3">, </span><span class="s1">reset_randomstate):</span>

        <span class="s3">import </span><span class="s1">datetime</span>

        <span class="s1">t1 = datetime.datetime.now()</span>
        <span class="s1">X = np.random.normal(size=(</span><span class="s4">2000</span><span class="s3">,</span><span class="s4">10</span><span class="s1">))</span>
        <span class="s1">tcor = corr_thresholded(X</span><span class="s3">, </span><span class="s4">0.2</span><span class="s3">, </span><span class="s1">max_elt=</span><span class="s4">4e6</span><span class="s1">)</span>
        <span class="s1">t2 = datetime.datetime.now()</span>
        <span class="s1">ss = (t2-t1).seconds</span>

        <span class="s1">fcor = np.corrcoef(X)</span>
        <span class="s1">fcor *= (np.abs(fcor) &gt;= </span><span class="s4">0.2</span><span class="s1">)</span>

        <span class="s1">assert_allclose(tcor.todense()</span><span class="s3">, </span><span class="s1">fcor</span><span class="s3">, </span><span class="s1">rtol=</span><span class="s4">0.25</span><span class="s3">, </span><span class="s1">atol=</span><span class="s4">1e-3</span><span class="s1">)</span>
</pre>
</body>
</html>