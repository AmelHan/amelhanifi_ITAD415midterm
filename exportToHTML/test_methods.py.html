<html>
<head>
<title>test_methods.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_methods.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">pandas.errors </span><span class="s0">import </span><span class="s1">SettingWithCopyWarning</span>

<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">pandas </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">DataFrame</span><span class="s0">,</span>
    <span class="s1">Index</span><span class="s0">,</span>
    <span class="s1">MultiIndex</span><span class="s0">,</span>
    <span class="s1">Period</span><span class="s0">,</span>
    <span class="s1">Series</span><span class="s0">,</span>
    <span class="s1">Timestamp</span><span class="s0">,</span>
    <span class="s1">date_range</span><span class="s0">,</span>
    <span class="s1">period_range</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">import </span><span class="s1">pandas._testing </span><span class="s0">as </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">pandas.tests.copy_view.util </span><span class="s0">import </span><span class="s1">get_array</span>


<span class="s0">def </span><span class="s1">test_copy(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_copy = df.copy()</span>

    <span class="s4"># the deep copy by defaults takes a shallow copy of the Index</span>
    <span class="s0">assert </span><span class="s1">df_copy.index </span><span class="s0">is not </span><span class="s1">df.index</span>
    <span class="s0">assert </span><span class="s1">df_copy.columns </span><span class="s0">is not </span><span class="s1">df.columns</span>
    <span class="s0">assert </span><span class="s1">df_copy.index.is_(df.index)</span>
    <span class="s0">assert </span><span class="s1">df_copy.columns.is_(df.columns)</span>

    <span class="s4"># the deep copy doesn't share memory</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df_copy</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">df_copy._mgr.blocks[</span><span class="s3">0</span><span class="s1">].refs.has_reference()</span>
        <span class="s0">assert not </span><span class="s1">df_copy._mgr.blocks[</span><span class="s3">1</span><span class="s1">].refs.has_reference()</span>

    <span class="s4"># mutating copy doesn't mutate original</span>
    <span class="s1">df_copy.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert </span><span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_copy_shallow(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_copy = df.copy(deep=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s4"># the shallow copy also makes a shallow copy of the index</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">df_copy.index </span><span class="s0">is not </span><span class="s1">df.index</span>
        <span class="s0">assert </span><span class="s1">df_copy.columns </span><span class="s0">is not </span><span class="s1">df.columns</span>
        <span class="s0">assert </span><span class="s1">df_copy.index.is_(df.index)</span>
        <span class="s0">assert </span><span class="s1">df_copy.columns.is_(df.columns)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">df_copy.index </span><span class="s0">is </span><span class="s1">df.index</span>
        <span class="s0">assert </span><span class="s1">df_copy.columns </span><span class="s0">is </span><span class="s1">df.columns</span>

    <span class="s4"># the shallow copy still shares memory</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df_copy</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">df_copy._mgr.blocks[</span><span class="s3">0</span><span class="s1">].refs.has_reference()</span>
        <span class="s0">assert </span><span class="s1">df_copy._mgr.blocks[</span><span class="s3">1</span><span class="s1">].refs.has_reference()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># mutating shallow copy doesn't mutate original</span>
        <span class="s1">df_copy.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s0">assert </span><span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">1</span>
        <span class="s4"># mutating triggered a copy-on-write -&gt; no longer shares memory</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df_copy</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s4"># but still shares memory for the other columns/blocks</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df_copy</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># mutating shallow copy does mutate original</span>
        <span class="s1">df_copy.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s0">assert </span><span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">0</span>
        <span class="s4"># and still shares memory</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df_copy</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;copy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, None, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;method&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.rename(columns=str.lower</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.reindex(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.reindex_like(df</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.align(df</span><span class="s0">, </span><span class="s1">copy=copy)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.set_axis([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.rename_axis(index=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.rename_axis(columns=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.astype({</span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;int64&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s4"># lambda df, copy: df.swaplevel(0, 0, copy=copy),</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.truncate(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.infer_objects(copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.to_timestamp(copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.to_period(freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.tz_localize(</span><span class="s2">&quot;US/Central&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.tz_convert(</span><span class="s2">&quot;US/Central&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">copy: df.set_flags(allows_duplicate_labels=</span><span class="s0">False, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span>
        <span class="s2">&quot;rename&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;reindex&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;reindex_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;align&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;set_axis&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;rename_axis0&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;rename_axis1&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;astype&quot;</span><span class="s0">,</span>
        <span class="s4"># &quot;swaplevel&quot;,  # only series</span>
        <span class="s2">&quot;swapaxes&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;truncate&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;infer_objects&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;to_timestamp&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;to_period&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;tz_localize&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;tz_convert&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;set_flags&quot;</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_methods_copy_keyword(</span>
    <span class="s1">request</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">copy</span><span class="s0">, </span><span class="s1">using_copy_on_write</span><span class="s0">, </span><span class="s1">using_array_manager</span>
<span class="s1">):</span>
    <span class="s1">index = </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s2">&quot;to_timestamp&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = period_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;to_period&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;tz_localize&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;tz_convert&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;Europe/Brussels&quot;</span><span class="s1">)</span>

    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>

    <span class="s0">if </span><span class="s2">&quot;swapaxes&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">msg = </span><span class="s2">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">df2 = method(df</span><span class="s0">, </span><span class="s1">copy=copy)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">df2 = method(df</span><span class="s0">, </span><span class="s1">copy=copy)</span>

    <span class="s1">share_memory = using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False</span>

    <span class="s0">if </span><span class="s1">request.node.callspec.id.startswith(</span><span class="s2">&quot;reindex-&quot;</span><span class="s1">):</span>
        <span class="s4"># TODO copy=False without CoW still returns a copy in this case</span>
        <span class="s0">if not </span><span class="s1">using_copy_on_write </span><span class="s0">and not </span><span class="s1">using_array_manager </span><span class="s0">and </span><span class="s1">copy </span><span class="s0">is False</span><span class="s1">:</span>
            <span class="s1">share_memory = </span><span class="s0">False</span>

    <span class="s0">if </span><span class="s1">share_memory:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;copy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, None, False</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;method&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.rename(index={</span><span class="s3">0</span><span class="s1">: </span><span class="s3">100</span><span class="s1">}</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.rename(</span><span class="s0">None, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.reindex(index=ser.index</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.reindex_like(ser</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.align(ser</span><span class="s0">, </span><span class="s1">copy=copy)[</span><span class="s3">0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.set_axis([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.rename_axis(index=</span><span class="s2">&quot;test&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.astype(</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.swaplevel(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.swapaxes(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.truncate(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.infer_objects(copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.to_timestamp(copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.to_period(freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.tz_localize(</span><span class="s2">&quot;US/Central&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.tz_convert(</span><span class="s2">&quot;US/Central&quot;</span><span class="s0">, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser</span><span class="s0">, </span><span class="s1">copy: ser.set_flags(allows_duplicate_labels=</span><span class="s0">False, </span><span class="s1">copy=copy)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span>
        <span class="s2">&quot;rename (dict)&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;rename&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;reindex&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;reindex_like&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;align&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;set_axis&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;rename_axis0&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;astype&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;swaplevel&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;swapaxes&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;truncate&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;infer_objects&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;to_timestamp&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;to_period&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;tz_localize&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;tz_convert&quot;</span><span class="s0">,</span>
        <span class="s2">&quot;set_flags&quot;</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_methods_series_copy_keyword(request</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">copy</span><span class="s0">, </span><span class="s1">using_copy_on_write):</span>
    <span class="s1">index = </span><span class="s0">None</span>
    <span class="s0">if </span><span class="s2">&quot;to_timestamp&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = period_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;to_period&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;tz_localize&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;tz_convert&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = date_range(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">tz=</span><span class="s2">&quot;Europe/Brussels&quot;</span><span class="s1">)</span>
    <span class="s0">elif </span><span class="s2">&quot;swaplevel&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">index = MultiIndex.from_arrays([[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]])</span>

    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>

    <span class="s0">if </span><span class="s2">&quot;swapaxes&quot; </span><span class="s0">in </span><span class="s1">request.node.callspec.id:</span>
        <span class="s1">msg = </span><span class="s2">&quot;'Series.swapaxes' is deprecated&quot;</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
            <span class="s1">ser2 = method(ser</span><span class="s0">, </span><span class="s1">copy=copy)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">ser2 = method(ser</span><span class="s0">, </span><span class="s1">copy=copy)</span>

    <span class="s1">share_memory = using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False</span>

    <span class="s0">if </span><span class="s1">share_memory:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser2)</span><span class="s0">, </span><span class="s1">get_array(ser))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser2)</span><span class="s0">, </span><span class="s1">get_array(ser))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;copy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, None, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_transpose_copy_keyword(using_copy_on_write</span><span class="s0">, </span><span class="s1">copy</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s1">result = df.transpose(copy=copy)</span>
    <span class="s1">share_memory = using_copy_on_write </span><span class="s0">or </span><span class="s1">copy </span><span class="s0">is False or </span><span class="s1">copy </span><span class="s0">is None</span>
    <span class="s1">share_memory = share_memory </span><span class="s0">and not </span><span class="s1">using_array_manager</span>

    <span class="s0">if </span><span class="s1">share_memory:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>


<span class="s4"># -----------------------------------------------------------------------------</span>
<span class="s4"># DataFrame methods returning new DataFrame using shallow copy</span>


<span class="s0">def </span><span class="s1">test_reset_index(using_copy_on_write):</span>
    <span class="s4"># Case: resetting the index (i.e. adding a new column) + mutating the</span>
    <span class="s4"># resulting dataframe</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">10</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">12</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.reset_index()</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s4"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s1">[pd.RangeIndex(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Index([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])])</span>
<span class="s0">def </span><span class="s1">test_reset_index_series_drop(using_copy_on_write</span><span class="s0">, </span><span class="s1">index):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(ser2))</span>
        <span class="s0">assert not </span><span class="s1">ser._mgr._has_no_reference(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(ser2))</span>

    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_rename_columns(using_copy_on_write):</span>
    <span class="s4"># Case: renaming columns returns a new dataframe</span>
    <span class="s4"># + afterwards modifying the result</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.rename(columns=str.upper)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_rename_columns_modify_parent(using_copy_on_write):</span>
    <span class="s4"># Case: renaming columns returns a new dataframe</span>
    <span class="s4"># + afterwards modifying the original (parent) dataframe</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df2 = df.rename(columns=str.upper)</span>
    <span class="s1">df2_orig = df2.copy()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">df2_orig)</span>


<span class="s0">def </span><span class="s1">test_pipe(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s0">def </span><span class="s1">testfunc(df):</span>
        <span class="s0">return </span><span class="s1">df</span>

    <span class="s1">df2 = df.pipe(testfunc)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_pipe_modify_df(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s0">def </span><span class="s1">testfunc(df):</span>
        <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
        <span class="s0">return </span><span class="s1">df</span>

    <span class="s1">df2 = df.pipe(testfunc)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_reindex_columns(using_copy_on_write):</span>
    <span class="s4"># Case: reindexing the column returns a new dataframe</span>
    <span class="s4"># + afterwards modifying the result</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.reindex(columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s4"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;index&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">idx: idx</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">idx: idx.view()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">idx: idx.copy()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">idx: list(idx)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span><span class="s2">&quot;identical&quot;</span><span class="s0">, </span><span class="s2">&quot;view&quot;</span><span class="s0">, </span><span class="s2">&quot;copy&quot;</span><span class="s0">, </span><span class="s2">&quot;values&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_reindex_rows(index</span><span class="s0">, </span><span class="s1">using_copy_on_write):</span>
    <span class="s4"># Case: reindexing the rows with an index that matches the current index</span>
    <span class="s4"># can use a shallow copy</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.reindex(index=index(df.index))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># still shares memory (df2 is a shallow copy)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s4"># mutating df2 triggers a copy-on-write for that column</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_drop_on_column(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.drop(columns=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_select_dtypes(using_copy_on_write):</span>
    <span class="s4"># Case: selecting columns using `select_dtypes()` returns a new dataframe</span>
    <span class="s4"># + afterwards modifying the result</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.select_dtypes(</span><span class="s2">&quot;int64&quot;</span><span class="s1">)</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;filter_kwargs&quot;</span><span class="s0">, </span><span class="s1">[{</span><span class="s2">&quot;items&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;like&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;regex&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">}]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_filter(using_copy_on_write</span><span class="s0">, </span><span class="s1">filter_kwargs):</span>
    <span class="s4"># Case: selecting columns using `filter()` returns a new dataframe</span>
    <span class="s4"># + afterwards modifying the result</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.filter(**filter_kwargs)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_shift_no_op(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-03&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.shift(periods=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_shift_index(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-03&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df2 = df.shift(periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_shift_rows_freq(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-03&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">columns=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df_orig.index = date_range(</span><span class="s2">&quot;2020-01-02&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-04&quot;</span><span class="s1">)</span>
    <span class="s1">df2 = df.shift(periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1D&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_shift_columns(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">[[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-02&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s1">df2 = df.shift(periods=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;2020-01-02&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;2020-01-01&quot;</span><span class="s1">))</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(</span>
            <span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;2020-01-02&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;2020-01-01&quot;</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">expected = DataFrame(</span>
            <span class="s1">[[np.nan</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">columns=date_range(</span><span class="s2">&quot;2020-01-01&quot;</span><span class="s0">, </span><span class="s2">&quot;2020-01-02&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_pop(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">view_original = df[:]</span>
    <span class="s1">result = df.pop(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(result.values</span><span class="s0">, </span><span class="s1">get_array(view_original</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view_original</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(result.values</span><span class="s0">, </span><span class="s1">get_array(view_original</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view_original</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(view_original</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(view_original</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x.align(y)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x.align(y.a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x.align(y.a.iloc[slice(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_align_frame(using_copy_on_write</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df_changed = df[[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">]].copy()</span>
    <span class="s1">df2</span><span class="s0">, </span><span class="s1">_ = func(df</span><span class="s0">, </span><span class="s1">df_changed)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_align_series(using_copy_on_write):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser_other = ser.copy()</span>
    <span class="s1">ser2</span><span class="s0">, </span><span class="s1">ser_other_result = ser.align(ser_other)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser_other_result.values</span><span class="s0">, </span><span class="s1">ser_other.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser_other_result.values</span><span class="s0">, </span><span class="s1">ser_other.values)</span>

    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">ser_other_result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser_other_result.values</span><span class="s0">, </span><span class="s1">ser_other.values)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>
    <span class="s1">tm.assert_series_equal(ser_other</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_align_copy_false(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2</span><span class="s0">, </span><span class="s1">df3 = df.align(df</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">df2.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)  </span><span class="s4"># Original is unchanged</span>

        <span class="s1">df3.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)  </span><span class="s4"># Original is unchanged</span>


<span class="s0">def </span><span class="s1">test_align_with_series_copy_false(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;x&quot;</span><span class="s1">)</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2</span><span class="s0">, </span><span class="s1">ser2 = df.align(ser</span><span class="s0">, </span><span class="s1">copy=</span><span class="s0">False, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(ser2</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">df2.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)  </span><span class="s4"># Original is unchanged</span>

        <span class="s1">ser2.loc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)  </span><span class="s4"># Original is unchanged</span>


<span class="s0">def </span><span class="s1">test_to_frame(using_copy_on_write):</span>
    <span class="s4"># Case: converting a Series to a DataFrame with to_frame</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>

    <span class="s1">df = ser[:].to_frame()</span>

    <span class="s4"># currently this always returns a &quot;view&quot;</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># mutating df triggers a copy-on-write for that column</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># but currently select_dtypes() actually returns a view -&gt; mutates parent</span>
        <span class="s1">expected = ser_orig.copy()</span>
        <span class="s1">expected.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">expected)</span>

    <span class="s4"># modify original series -&gt; don't modify dataframe</span>
    <span class="s1">df = ser[:].to_frame()</span>
    <span class="s1">ser.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">ser_orig.to_frame())</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = ser_orig.copy().to_frame()</span>
        <span class="s1">expected.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;ax&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;columns&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_swapaxes_noop(using_copy_on_write</span><span class="s0">, </span><span class="s1">ax):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">msg = </span><span class="s2">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">df2 = df.swapaxes(ax</span><span class="s0">, </span><span class="s1">ax)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_swapaxes_single_block(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">])</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">msg = </span><span class="s2">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">df2 = df.swapaxes(</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s2">&quot;columns&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column/block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_swapaxes_read_only_array():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">3</span><span class="s1">})</span>
    <span class="s1">msg = </span><span class="s2">&quot;'DataFrame.swapaxes' is deprecated&quot;</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(FutureWarning</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">df = df.swapaxes(axis1=</span><span class="s2">&quot;index&quot;</span><span class="s0">, </span><span class="s1">axis2=</span><span class="s2">&quot;columns&quot;</span><span class="s1">)</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">expected = DataFrame({</span><span class="s3">0</span><span class="s1">: [</span><span class="s3">100</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s3">1</span><span class="s1">: [</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;method, idx&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">df: df.copy(deep=</span><span class="s0">False</span><span class="s1">).copy(deep=</span><span class="s0">False</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">df: df.reset_index().reset_index()</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">df: df.rename(columns=str.upper).rename(columns=str.lower)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">lambda </span><span class="s1">df: df.copy(deep=</span><span class="s0">False</span><span class="s1">).select_dtypes(include=</span><span class="s2">&quot;number&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">ids=[</span><span class="s2">&quot;shallow-copy&quot;</span><span class="s0">, </span><span class="s2">&quot;reset_index&quot;</span><span class="s0">, </span><span class="s2">&quot;rename&quot;</span><span class="s0">, </span><span class="s2">&quot;select_dtypes&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_chained_methods(request</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">idx</span><span class="s0">, </span><span class="s1">using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s4"># when not using CoW, only the copy() variant actually gives a view</span>
    <span class="s1">df2_is_view = </span><span class="s0">not </span><span class="s1">using_copy_on_write </span><span class="s0">and </span><span class="s1">request.node.callspec.id == </span><span class="s2">&quot;shallow-copy&quot;</span>

    <span class="s4"># modify df2 -&gt; don't modify df</span>
    <span class="s1">df2 = method(df)</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">idx] = </span><span class="s3">0</span>
    <span class="s0">if not </span><span class="s1">df2_is_view:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>

    <span class="s4"># modify df -&gt; don't modify df2</span>
    <span class="s1">df2 = method(df)</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if not </span><span class="s1">df2_is_view:</span>
        <span class="s1">tm.assert_frame_equal(df2.iloc[:</span><span class="s0">, </span><span class="s1">idx:]</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;obj&quot;</span><span class="s0">, </span><span class="s1">[Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})])</span>
<span class="s0">def </span><span class="s1">test_to_timestamp(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj):</span>
    <span class="s1">obj.index = Index([Period(</span><span class="s2">&quot;2012-1-1&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Period(</span><span class="s2">&quot;2012-1-2&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;D&quot;</span><span class="s1">)])</span>

    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.to_timestamp()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating obj2 triggers a copy-on-write for that column / block</span>
    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;obj&quot;</span><span class="s0">, </span><span class="s1">[Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})])</span>
<span class="s0">def </span><span class="s1">test_to_period(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj):</span>
    <span class="s1">obj.index = Index([Timestamp(</span><span class="s2">&quot;2019-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;2020-12-31&quot;</span><span class="s1">)])</span>

    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.to_period(freq=</span><span class="s2">&quot;Y&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating obj2 triggers a copy-on-write for that column / block</span>
    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s0">def </span><span class="s1">test_set_index(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.set_index(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_set_index_mutating_parent_does_not_mutate_index():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">result = df.set_index(</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">expected = result.copy()</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_add_prefix(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.add_prefix(</span><span class="s2">&quot;CoW_&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;CoW_a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;CoW_a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;CoW_c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;CoW_a&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;CoW_b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;CoW_c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_add_suffix(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.add_suffix(</span><span class="s2">&quot;_CoW&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a_CoW&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a_CoW&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c_CoW&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s1">expected = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a_CoW&quot;</span><span class="s1">: [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b_CoW&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c_CoW&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">tm.assert_frame_equal(df2</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis, val&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">5.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.nan)])</span>
<span class="s0">def </span><span class="s1">test_dropna(using_copy_on_write</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">val):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s2">&quot;d&quot;</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.dropna(axis=axis)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;val&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5.5</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_dropna_series(using_copy_on_write</span><span class="s0">, </span><span class="s1">val):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s3">4</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.dropna()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>

    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;method&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">df: df.head()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df: df.head(</span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df: df.tail()</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df: df.tail(</span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_head_tail(method</span><span class="s0">, </span><span class="s1">using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = method(df)</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># We are explicitly deviating for CoW here to make an eager copy (avoids</span>
        <span class="s4"># tracking references for very cheap ops)</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s4"># modify df2 to trigger CoW for that block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># without CoW enabled, head and tail return views. Mutating df2 also mutates df.</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">1</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_infer_objects(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: </span><span class="s2">&quot;x&quot;</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.infer_objects()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s2">&quot;d&quot;</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_infer_objects_no_reference(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;c&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: Series(</span>
                <span class="s1">[Timestamp(</span><span class="s2">&quot;2019-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;2020-12-31&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s2">&quot;e&quot;</span><span class="s1">: </span><span class="s2">&quot;b&quot;</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">df = df.infer_objects()</span>

    <span class="s1">arr_a = get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">arr_b = get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">arr_d = get_array(df</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s2">&quot;d&quot;</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">] = Timestamp(</span><span class="s2">&quot;2018-12-31&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(arr_a</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s4"># TODO(CoW): Block splitting causes references here</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(arr_b</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(arr_d</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_infer_objects_reference(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;c&quot;</span><span class="s0">,</span>
            <span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">,</span>
            <span class="s2">&quot;d&quot;</span><span class="s1">: Series(</span>
                <span class="s1">[Timestamp(</span><span class="s2">&quot;2019-12-31&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">Timestamp(</span><span class="s2">&quot;2020-12-31&quot;</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;object&quot;</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">view = df[:]  </span><span class="s4"># noqa: F841</span>
    <span class="s1">df = df.infer_objects()</span>

    <span class="s1">arr_a = get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">arr_b = get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s1">arr_d = get_array(df</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s2">&quot;d&quot;</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">3</span><span class="s1">] = Timestamp(</span><span class="s2">&quot;2018-12-31&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(arr_a</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(arr_b</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(arr_d</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">{</span><span class="s2">&quot;before&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;after&quot;</span><span class="s1">: </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;axis&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">{</span><span class="s2">&quot;before&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;after&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;axis&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_truncate(using_copy_on_write</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.truncate(**kwargs)</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;method&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;assign&quot;</span><span class="s0">, </span><span class="s2">&quot;drop_duplicates&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_assign_drop_duplicates(using_copy_on_write</span><span class="s0">, </span><span class="s1">method):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = getattr(df</span><span class="s0">, </span><span class="s1">method)()</span>
    <span class="s1">df2._mgr._verify_integrity()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;obj&quot;</span><span class="s0">, </span><span class="s1">[Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})])</span>
<span class="s0">def </span><span class="s1">test_take(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj):</span>
    <span class="s4"># Check that no copy is made when we take all rows in original order</span>
    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.take([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>

    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;obj&quot;</span><span class="s0">, </span><span class="s1">[Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})])</span>
<span class="s0">def </span><span class="s1">test_between_time(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj):</span>
    <span class="s1">obj.index = date_range(</span><span class="s2">&quot;2018-04-09&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;1D20min&quot;</span><span class="s1">)</span>
    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.between_time(</span><span class="s2">&quot;0:00&quot;</span><span class="s0">, </span><span class="s2">&quot;1:00&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>

    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s0">def </span><span class="s1">test_reindex_like(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">})</span>
    <span class="s1">other = DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]})</span>

    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.reindex_like(other)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_sort_index(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.sort_index()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">ser2.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">ser2.values)</span>

    <span class="s4"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;obj, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">, </span><span class="s1">(DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;by&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">})]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_sort_values(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.sort_values(**kwargs)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df triggers a copy-on-write for the column / block</span>
    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;obj, kwargs&quot;</span><span class="s0">,</span>
    <span class="s1">[(Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">, </span><span class="s1">(DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;by&quot;</span><span class="s1">: </span><span class="s2">&quot;a&quot;</span><span class="s1">})]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_sort_values_inplace(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj</span><span class="s0">, </span><span class="s1">kwargs</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">view = obj[:]</span>
    <span class="s1">obj.sort_values(inplace=</span><span class="s0">True, </span><span class="s1">**kwargs)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating obj triggers a copy-on-write for the column / block</span>
    <span class="s1">obj.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_equal(view</span><span class="s0">, </span><span class="s1">obj_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(obj</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;decimals&quot;</span><span class="s0">, </span><span class="s1">[-</span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_round(using_copy_on_write</span><span class="s0">, </span><span class="s1">decimals):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s2">&quot;c&quot;</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.round(decimals=decimals)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s4"># TODO: Make inplace by using out parameter of ndarray.round?</span>
        <span class="s0">if </span><span class="s1">decimals &gt;= </span><span class="s3">0</span><span class="s1">:</span>
            <span class="s4"># Ensure lazy copy if no-op</span>
            <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s2">&quot;d&quot;</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">4</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_reorder_levels(using_copy_on_write):</span>
    <span class="s1">index = MultiIndex.from_tuples(</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.reorder_levels(order=[</span><span class="s2">&quot;two&quot;</span><span class="s0">, </span><span class="s2">&quot;one&quot;</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_series_reorder_levels(using_copy_on_write):</span>
    <span class="s1">index = MultiIndex.from_tuples(</span>
        <span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.reorder_levels(order=[</span><span class="s2">&quot;two&quot;</span><span class="s0">, </span><span class="s2">&quot;one&quot;</span><span class="s1">])</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>

    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;obj&quot;</span><span class="s0">, </span><span class="s1">[Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})])</span>
<span class="s0">def </span><span class="s1">test_swaplevel(using_copy_on_write</span><span class="s0">, </span><span class="s1">obj):</span>
    <span class="s1">index = MultiIndex.from_tuples([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">])</span>
    <span class="s1">obj.index = index</span>
    <span class="s1">obj_orig = obj.copy()</span>
    <span class="s1">obj2 = obj.swaplevel()</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>

    <span class="s1">obj2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(obj2.values</span><span class="s0">, </span><span class="s1">obj.values)</span>
    <span class="s1">tm.assert_equal(obj</span><span class="s0">, </span><span class="s1">obj_orig)</span>


<span class="s0">def </span><span class="s1">test_frame_set_axis(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">0.1</span><span class="s0">, </span><span class="s3">0.2</span><span class="s0">, </span><span class="s3">0.3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.set_axis([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">&quot;index&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_series_set_axis(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.set_axis([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">&quot;index&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser</span><span class="s0">, </span><span class="s1">ser2)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser</span><span class="s0">, </span><span class="s1">ser2)</span>

    <span class="s4"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2</span><span class="s0">, </span><span class="s1">ser)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_set_flags(using_copy_on_write):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = ser.set_flags(allows_duplicate_labels=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">np.shares_memory(ser</span><span class="s0">, </span><span class="s1">ser2)</span>

    <span class="s4"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2</span><span class="s0">, </span><span class="s1">ser)</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser2</span><span class="s0">, </span><span class="s1">ser)</span>
        <span class="s1">expected = Series([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;kwargs&quot;</span><span class="s0">, </span><span class="s1">[{</span><span class="s2">&quot;mapper&quot;</span><span class="s1">: </span><span class="s2">&quot;test&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;index&quot;</span><span class="s1">: </span><span class="s2">&quot;test&quot;</span><span class="s1">}])</span>
<span class="s0">def </span><span class="s1">test_rename_axis(using_copy_on_write</span><span class="s0">, </span><span class="s1">kwargs):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=Index([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">name=</span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.rename_axis(**kwargs)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func, tz&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;tz_convert&quot;</span><span class="s0">, </span><span class="s2">&quot;Europe/Berlin&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;tz_localize&quot;</span><span class="s0">, None</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_tz_convert_localize(using_copy_on_write</span><span class="s0">, </span><span class="s1">func</span><span class="s0">, </span><span class="s1">tz):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">ser = Series(</span>
        <span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=date_range(start=</span><span class="s2">&quot;2014-08-01 09:00&quot;</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;H&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">tz=tz)</span>
    <span class="s1">)</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">ser2 = getattr(ser</span><span class="s0">, </span><span class="s1">func)(</span><span class="s2">&quot;US/Central&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">ser2.values)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(ser.values</span><span class="s0">, </span><span class="s1">ser2.values)</span>

    <span class="s4"># mutating ser triggers a copy-on-write for the column / block</span>
    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">assert not </span><span class="s1">np.shares_memory(ser2.values</span><span class="s0">, </span><span class="s1">ser.values)</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_droplevel(using_copy_on_write):</span>
    <span class="s4"># GH 49473</span>
    <span class="s1">index = MultiIndex.from_tuples([(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;one&quot;</span><span class="s0">, </span><span class="s2">&quot;two&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=index)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.droplevel(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_squeeze(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">series = df.squeeze()</span>

    <span class="s4"># Should share memory regardless of CoW since squeeze is just an iloc</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(series.values</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating squeezed df triggers a copy-on-write for that column/block</span>
    <span class="s1">series.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(series.values</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># Without CoW the original will be modified</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(series.values</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] == </span><span class="s3">0</span>


<span class="s0">def </span><span class="s1">test_items(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s4"># Test this twice, since the second time, the item cache will be</span>
    <span class="s4"># triggered, and we want to make sure it still works then.</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">ser </span><span class="s0">in </span><span class="s1">df.items():</span>
            <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser</span><span class="s0">, </span><span class="s1">name)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s1">name))</span>

            <span class="s4"># mutating df triggers a copy-on-write for that column / block</span>
            <span class="s1">ser.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

            <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
                <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser</span><span class="s0">, </span><span class="s1">name)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s1">name))</span>
                <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
            <span class="s0">else</span><span class="s1">:</span>
                <span class="s4"># Original frame will be modified</span>
                <span class="s0">assert </span><span class="s1">df.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s1">name] == </span><span class="s3">0</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;Int64&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_putmask(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">view = df[:]</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df[df == df] = </span><span class="s3">5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># Without CoW the original will be modified</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">view.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">5</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;Int64&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_putmask_no_reference(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">arr_a = get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">df[df == df] = </span><span class="s3">5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(arr_a</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;float64&quot;</span><span class="s0">, </span><span class="s2">&quot;Float64&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_putmask_aligns_rhs_no_reference(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">arr_a = get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span>
    <span class="s1">df[df == df] = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">5.5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">]})</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(arr_a</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;val, exp, warn&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">5.5</span><span class="s0">, True, </span><span class="s1">FutureWarning)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, False, None</span><span class="s1">)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_putmask_dont_copy_some_blocks(using_copy_on_write</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s1">exp</span><span class="s0">, </span><span class="s1">warn):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
    <span class="s1">view = df[:]</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">indexer = DataFrame(</span>
        <span class="s1">[[</span><span class="s0">True, False, False</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False, False</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tm.assert_produces_warning(warn</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;incompatible dtype&quot;</span><span class="s1">):</span>
        <span class="s1">df[indexer] = val</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s4"># TODO(CoW): Could split blocks to avoid copying the whole block</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)) </span><span class="s0">is </span><span class="s1">exp</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">df._mgr._has_no_reference(</span><span class="s3">1</span><span class="s1">) </span><span class="s0">is not </span><span class="s1">exp</span>
        <span class="s0">assert not </span><span class="s1">df._mgr._has_no_reference(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">elif </span><span class="s1">val == </span><span class="s3">5</span><span class="s1">:</span>
        <span class="s4"># Without CoW the original will be modified, the other case upcasts, e.g. copy</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(view</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">view.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">5</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;Int64&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">ser: ser.where(ser &gt; </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser: ser.mask(ser &lt;= </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_where_mask_noop(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">ser_orig = ser.copy()</span>

    <span class="s1">result = func(ser)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(result))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(result))</span>

    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">10</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(result))</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;Int64&quot;</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">ser: ser.where(ser &lt; </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">ser: ser.mask(ser &gt;= </span><span class="s3">0</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_where_mask(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">ser_orig = ser.copy()</span>

    <span class="s1">result = func(ser)</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(result))</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;dtype, val&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s3">10.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;Int64&quot;</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;func&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">val: df.where(df &lt; </span><span class="s3">0</span><span class="s0">, </span><span class="s1">val)</span><span class="s0">,</span>
        <span class="s0">lambda </span><span class="s1">df</span><span class="s0">, </span><span class="s1">val: df.mask(df &gt;= </span><span class="s3">0</span><span class="s0">, </span><span class="s1">val)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_where_mask_noop_on_single_column(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype</span><span class="s0">, </span><span class="s1">val</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [-</span><span class="s3">4</span><span class="s0">, </span><span class="s1">-</span><span class="s3">5</span><span class="s0">, </span><span class="s1">-</span><span class="s3">6</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=dtype)</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s1">result = func(df</span><span class="s0">, </span><span class="s1">val)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s3">10</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;func&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;mask&quot;</span><span class="s0">, </span><span class="s2">&quot;where&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_chained_where_mask(using_copy_on_write</span><span class="s0">, </span><span class="s1">func):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">with </span><span class="s1">tm.raises_chained_assignment_error():</span>
            <span class="s1">getattr(df[</span><span class="s2">&quot;a&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">func)(df[</span><span class="s2">&quot;a&quot;</span><span class="s1">] &gt; </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>

        <span class="s0">with </span><span class="s1">tm.raises_chained_assignment_error():</span>
            <span class="s1">getattr(df[[</span><span class="s2">&quot;a&quot;</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">func)(df[</span><span class="s2">&quot;a&quot;</span><span class="s1">] &gt; </span><span class="s3">2</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_asfreq_noop(using_copy_on_write):</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">0.0</span><span class="s0">, None, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]}</span><span class="s0">,</span>
        <span class="s1">index=date_range(</span><span class="s2">&quot;1/1/2000&quot;</span><span class="s0">, </span><span class="s1">periods=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">freq=</span><span class="s2">&quot;T&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.asfreq(freq=</span><span class="s2">&quot;T&quot;</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s4"># mutating df2 triggers a copy-on-write for that column / block</span>
    <span class="s1">df2.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_iterrows(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s0">for </span><span class="s1">_</span><span class="s0">, </span><span class="s1">sub </span><span class="s0">in </span><span class="s1">df.iterrows():</span>
        <span class="s1">sub.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_interpolate_creates_copy(using_copy_on_write):</span>
    <span class="s4"># GH#51126</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.5</span><span class="s0">, </span><span class="s1">np.nan</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">view = df[:]</span>
    <span class="s1">expected = df.copy()</span>

    <span class="s1">df.ffill(inplace=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100.5</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">100.5</span><span class="s0">, </span><span class="s3">1.5</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_isetitem(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df2 = df.copy(deep=</span><span class="s0">None</span><span class="s1">)  </span><span class="s4"># Trigger a CoW</span>
    <span class="s1">df2.isetitem(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">2</span><span class="s0">, </span><span class="s1">-</span><span class="s3">3</span><span class="s1">]))  </span><span class="s4"># This is inplace</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df2.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)  </span><span class="s4"># Original is unchanged</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df2</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;float64&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ids=[</span><span class="s2">&quot;single-block&quot;</span><span class="s0">, </span><span class="s2">&quot;mixed-block&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_isetitem_series(using_copy_on_write</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)})</span>
    <span class="s1">ser = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">df.isetitem(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">ser)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(ser))</span>
        <span class="s0">assert not </span><span class="s1">df._mgr._has_no_reference(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s4"># mutating dataframe doesn't update series</span>
    <span class="s1">df.loc[</span><span class="s3">0</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>

    <span class="s4"># mutating series doesn't update dataframe</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)})</span>
    <span class="s1">ser = Series([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">])</span>
    <span class="s1">df.isetitem(</span><span class="s3">0</span><span class="s0">, </span><span class="s1">ser)</span>

    <span class="s1">ser.loc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: np.array([</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)})</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_isetitem_frame(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span>
    <span class="s1">rhs = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">})</span>
    <span class="s1">df.isetitem([</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rhs)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(rhs</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(rhs</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">df._mgr._has_no_reference(</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(rhs</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(rhs</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s1">expected = df.copy()</span>
    <span class="s1">rhs.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">rhs.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;key&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s1">]])</span>
<span class="s0">def </span><span class="s1">test_get(using_copy_on_write</span><span class="s0">, </span><span class="s1">key):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s1">result = df.get(key)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(result</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(result</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s4"># for non-CoW it depends on whether we got a Series or DataFrame if it</span>
        <span class="s4"># is a view or copy or triggers a warning or not</span>
        <span class="s1">warn = SettingWithCopyWarning </span><span class="s0">if </span><span class="s1">isinstance(key</span><span class="s0">, </span><span class="s1">list) </span><span class="s0">else None</span>
        <span class="s0">with </span><span class="s1">pd.option_context(</span><span class="s2">&quot;chained_assignment&quot;</span><span class="s0">, </span><span class="s2">&quot;warn&quot;</span><span class="s1">):</span>
            <span class="s0">with </span><span class="s1">tm.assert_produces_warning(warn):</span>
                <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

        <span class="s0">if </span><span class="s1">isinstance(key</span><span class="s0">, </span><span class="s1">list):</span>
            <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">0</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis, key&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)])</span>
<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dtype&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s2">&quot;float64&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ids=[</span><span class="s2">&quot;single-block&quot;</span><span class="s0">, </span><span class="s2">&quot;mixed-block&quot;</span><span class="s1">]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_xs(using_copy_on_write</span><span class="s0">, </span><span class="s1">using_array_manager</span><span class="s0">, </span><span class="s1">axis</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">dtype):</span>
    <span class="s1">single_block = (dtype == </span><span class="s2">&quot;int64&quot;</span><span class="s1">) </span><span class="s0">and not </span><span class="s1">using_array_manager</span>
    <span class="s1">is_view = single_block </span><span class="s0">or </span><span class="s1">(using_array_manager </span><span class="s0">and </span><span class="s1">axis == </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">df = DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: np.array([</span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=dtype)}</span>
    <span class="s1">)</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s1">result = df.xs(key</span><span class="s0">, </span><span class="s1">axis=axis)</span>

    <span class="s0">if </span><span class="s1">axis == </span><span class="s3">1 </span><span class="s0">or </span><span class="s1">single_block:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result))</span>
    <span class="s0">elif </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">result._mgr._has_no_reference(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">is_view:</span>
        <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">with </span><span class="s1">pd.option_context(</span><span class="s2">&quot;chained_assignment&quot;</span><span class="s0">, </span><span class="s2">&quot;warn&quot;</span><span class="s1">):</span>
            <span class="s0">with </span><span class="s1">tm.assert_produces_warning(SettingWithCopyWarning):</span>
                <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write </span><span class="s0">or </span><span class="s1">(</span><span class="s0">not </span><span class="s1">single_block </span><span class="s0">and </span><span class="s1">axis == </span><span class="s3">0</span><span class="s1">):</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] == </span><span class="s3">0</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;axis&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;key, level&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;l1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_xs_multiindex(using_copy_on_write</span><span class="s0">, </span><span class="s1">using_array_manager</span><span class="s0">, </span><span class="s1">key</span><span class="s0">, </span><span class="s1">level</span><span class="s0">, </span><span class="s1">axis):</span>
    <span class="s1">arr = np.arange(</span><span class="s3">18</span><span class="s1">).reshape(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">index = MultiIndex.from_product([[</span><span class="s2">&quot;l1&quot;</span><span class="s0">, </span><span class="s2">&quot;l2&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;lev1&quot;</span><span class="s0">, </span><span class="s2">&quot;lev2&quot;</span><span class="s1">])</span>
    <span class="s1">df = DataFrame(arr</span><span class="s0">, </span><span class="s1">index=index</span><span class="s0">, </span><span class="s1">columns=list(</span><span class="s2">&quot;abc&quot;</span><span class="s1">))</span>
    <span class="s0">if </span><span class="s1">axis == </span><span class="s3">1</span><span class="s1">:</span>
        <span class="s1">df = df.transpose().copy()</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s1">result = df.xs(key</span><span class="s0">, </span><span class="s1">level=level</span><span class="s0">, </span><span class="s1">axis=axis)</span>

    <span class="s0">if </span><span class="s1">level == </span><span class="s3">0</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(</span>
            <span class="s1">get_array(df</span><span class="s0">, </span><span class="s1">df.columns[</span><span class="s3">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s1">result.columns[</span><span class="s3">0</span><span class="s1">])</span>
        <span class="s1">)</span>

    <span class="s1">warn = (</span>
        <span class="s1">SettingWithCopyWarning</span>
        <span class="s0">if not </span><span class="s1">using_copy_on_write </span><span class="s0">and not </span><span class="s1">using_array_manager</span>
        <span class="s0">else None</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">pd.option_context(</span><span class="s2">&quot;chained_assignment&quot;</span><span class="s0">, </span><span class="s2">&quot;warn&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">tm.assert_produces_warning(warn):</span>
            <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">0</span>

    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_update_frame(using_copy_on_write):</span>
    <span class="s1">df1 = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">5.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">]})</span>
    <span class="s1">df2 = DataFrame({</span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">100.0</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">df1_orig = df1.copy()</span>
    <span class="s1">view = df1[:]</span>

    <span class="s1">df1.update(df2)</span>

    <span class="s1">expected = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: [</span><span class="s3">4.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s0">, </span><span class="s3">6.0</span><span class="s1">]})</span>
    <span class="s1">tm.assert_frame_equal(df1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># df1 is updated, but its view not</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">df1_orig)</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df1</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df1</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(view</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">tm.assert_frame_equal(view</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_update_series(using_copy_on_write):</span>
    <span class="s1">ser1 = Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">2.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span>
    <span class="s1">ser2 = Series([</span><span class="s3">100.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">ser1_orig = ser1.copy()</span>
    <span class="s1">view = ser1[:]</span>

    <span class="s1">ser1.update(ser2)</span>

    <span class="s1">expected = Series([</span><span class="s3">1.0</span><span class="s0">, </span><span class="s3">100.0</span><span class="s0">, </span><span class="s3">3.0</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(ser1</span><span class="s0">, </span><span class="s1">expected)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s4"># ser1 is updated, but its view not</span>
        <span class="s1">tm.assert_series_equal(view</span><span class="s0">, </span><span class="s1">ser1_orig)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">tm.assert_series_equal(view</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_update_chained_assignment(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">ser2 = Series([</span><span class="s3">100.0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">with </span><span class="s1">tm.raises_chained_assignment_error():</span>
            <span class="s1">df[</span><span class="s2">&quot;a&quot;</span><span class="s1">].update(ser2)</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>

        <span class="s0">with </span><span class="s1">tm.raises_chained_assignment_error():</span>
            <span class="s1">df[[</span><span class="s2">&quot;a&quot;</span><span class="s1">]].update(ser2.to_frame())</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_inplace_arithmetic_series():</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">data = get_array(ser)</span>
    <span class="s1">ser *= </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">data)</span>
    <span class="s1">tm.assert_numpy_array_equal(data</span><span class="s0">, </span><span class="s1">get_array(ser))</span>


<span class="s0">def </span><span class="s1">test_inplace_arithmetic_series_with_reference(using_copy_on_write):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">view = ser[:]</span>
    <span class="s1">ser *= </span><span class="s3">2</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(view))</span>
        <span class="s1">tm.assert_series_equal(ser_orig</span><span class="s0">, </span><span class="s1">view)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(view))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;copy&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_transpose(using_copy_on_write</span><span class="s0">, </span><span class="s1">copy</span><span class="s0">, </span><span class="s1">using_array_manager):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">result = df.transpose(copy=copy)</span>

    <span class="s0">if not </span><span class="s1">copy </span><span class="s0">and not </span><span class="s1">using_array_manager </span><span class="s0">or </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>

    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_transpose_different_dtypes(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1.5</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">result = df.T</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_transpose_ea_single_column(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;Int64&quot;</span><span class="s1">)</span>
    <span class="s1">result = df.T</span>

    <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_transform_frame(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s0">def </span><span class="s1">func(ser):</span>
        <span class="s1">ser.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
        <span class="s0">return </span><span class="s1">ser</span>

    <span class="s1">df.transform(func)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_transform_series(using_copy_on_write):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>

    <span class="s0">def </span><span class="s1">func(ser):</span>
        <span class="s1">ser.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
        <span class="s0">return </span><span class="s1">ser</span>

    <span class="s1">ser.transform(func)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_count_read_only_array():</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">3</span><span class="s1">})</span>
    <span class="s1">result = df.count()</span>
    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">expected = Series([</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])</span>
    <span class="s1">tm.assert_series_equal(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_series_view(using_copy_on_write):</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>

    <span class="s1">ser2 = ser.view()</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(ser2))</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert not </span><span class="s1">ser2._mgr._has_no_reference(</span><span class="s3">0</span><span class="s1">)</span>

    <span class="s1">ser2.iloc[</span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>

    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_series_equal(ser_orig</span><span class="s0">, </span><span class="s1">ser)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">expected = Series([</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_insert_series(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">ser = Series([</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">])</span>
    <span class="s1">ser_orig = ser.copy()</span>
    <span class="s1">df.insert(loc=</span><span class="s3">1</span><span class="s0">, </span><span class="s1">value=ser</span><span class="s0">, </span><span class="s1">column=</span><span class="s2">&quot;b&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>
        <span class="s0">assert not </span><span class="s1">df._mgr._has_no_reference(</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(ser)</span><span class="s0">, </span><span class="s1">get_array(df</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">))</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">tm.assert_series_equal(ser</span><span class="s0">, </span><span class="s1">ser_orig)</span>


<span class="s0">def </span><span class="s1">test_eval(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>

    <span class="s1">result = df.eval(</span><span class="s2">&quot;c = a+b&quot;</span><span class="s1">)</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert not </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(result</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">result.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s1">tm.assert_frame_equal(df</span><span class="s0">, </span><span class="s1">df_orig)</span>


<span class="s0">def </span><span class="s1">test_eval_inplace(using_copy_on_write):</span>
    <span class="s1">df = DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s1">df_orig = df.copy()</span>
    <span class="s1">df_view = df[:]</span>

    <span class="s1">df.eval(</span><span class="s2">&quot;c = a+b&quot;</span><span class="s0">, </span><span class="s1">inplace=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">np.shares_memory(get_array(df</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">get_array(df_view</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">))</span>

    <span class="s1">df.iloc[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">] = </span><span class="s3">100</span>
    <span class="s0">if </span><span class="s1">using_copy_on_write:</span>
        <span class="s1">tm.assert_frame_equal(df_view</span><span class="s0">, </span><span class="s1">df_orig)</span>
</pre>
</body>
</html>