<html>
<head>
<title>test_ivp.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #6a8759;}
.s4 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_ivp.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">itertools </span><span class="s0">import </span><span class="s1">product</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(assert_</span><span class="s0">, </span><span class="s1">assert_allclose</span><span class="s0">,</span>
                           <span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_no_warnings</span><span class="s0">, </span><span class="s1">suppress_warnings)</span>
<span class="s0">import </span><span class="s1">pytest</span>
<span class="s0">from </span><span class="s1">pytest </span><span class="s0">import </span><span class="s1">raises </span><span class="s0">as </span><span class="s1">assert_raises</span>
<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">scipy.optimize._numdiff </span><span class="s0">import </span><span class="s1">group_columns</span>
<span class="s0">from </span><span class="s1">scipy.integrate </span><span class="s0">import </span><span class="s1">solve_ivp</span><span class="s0">, </span><span class="s1">RK23</span><span class="s0">, </span><span class="s1">RK45</span><span class="s0">, </span><span class="s1">DOP853</span><span class="s0">, </span><span class="s1">Radau</span><span class="s0">, </span><span class="s1">BDF</span><span class="s0">, </span><span class="s1">LSODA</span>
<span class="s0">from </span><span class="s1">scipy.integrate </span><span class="s0">import </span><span class="s1">OdeSolution</span>
<span class="s0">from </span><span class="s1">scipy.integrate._ivp.common </span><span class="s0">import </span><span class="s1">num_jac</span>
<span class="s0">from </span><span class="s1">scipy.integrate._ivp.base </span><span class="s0">import </span><span class="s1">ConstantDenseOutput</span>
<span class="s0">from </span><span class="s1">scipy.sparse </span><span class="s0">import </span><span class="s1">coo_matrix</span><span class="s0">, </span><span class="s1">csc_matrix</span>


<span class="s0">def </span><span class="s1">fun_zero(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">np.zeros_like(y)</span>


<span class="s0">def </span><span class="s1">fun_linear(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">np.array([-y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">5 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[</span><span class="s2">0</span><span class="s1">] + y[</span><span class="s2">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">jac_linear():</span>
    <span class="s0">return </span><span class="s1">np.array([[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">sol_linear(t):</span>
    <span class="s0">return </span><span class="s1">np.vstack((-</span><span class="s2">5 </span><span class="s1">* np.sin(</span><span class="s2">2 </span><span class="s1">* t)</span><span class="s0">,</span>
                      <span class="s2">2 </span><span class="s1">* np.cos(</span><span class="s2">2 </span><span class="s1">* t) + np.sin(</span><span class="s2">2 </span><span class="s1">* t)))</span>


<span class="s0">def </span><span class="s1">fun_rational(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">np.array([y[</span><span class="s2">1</span><span class="s1">] / t</span><span class="s0">,</span>
                     <span class="s1">y[</span><span class="s2">1</span><span class="s1">] * (y[</span><span class="s2">0</span><span class="s1">] + </span><span class="s2">2 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) / (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">))])</span>


<span class="s0">def </span><span class="s1">fun_rational_vectorized(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">np.vstack((y[</span><span class="s2">1</span><span class="s1">] / t</span><span class="s0">,</span>
                      <span class="s1">y[</span><span class="s2">1</span><span class="s1">] * (y[</span><span class="s2">0</span><span class="s1">] + </span><span class="s2">2 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) / (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">))))</span>


<span class="s0">def </span><span class="s1">jac_rational(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">np.array([</span>
        <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1 </span><span class="s1">/ t]</span><span class="s0">,</span>
        <span class="s1">[-</span><span class="s2">2 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">2 </span><span class="s1">/ (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) ** </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
         <span class="s1">(y[</span><span class="s2">0</span><span class="s1">] + </span><span class="s2">4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) / (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">))]</span>
    <span class="s1">])</span>


<span class="s0">def </span><span class="s1">jac_rational_sparse(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">csc_matrix([</span>
        <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1 </span><span class="s1">/ t]</span><span class="s0">,</span>
        <span class="s1">[-</span><span class="s2">2 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">2 </span><span class="s1">/ (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) ** </span><span class="s2">2</span><span class="s1">)</span><span class="s0">,</span>
         <span class="s1">(y[</span><span class="s2">0</span><span class="s1">] + </span><span class="s2">4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">) / (t * (y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1</span><span class="s1">))]</span>
    <span class="s1">])</span>


<span class="s0">def </span><span class="s1">sol_rational(t):</span>
    <span class="s0">return </span><span class="s1">np.asarray((t / (t + </span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s2">10 </span><span class="s1">* t / (t + </span><span class="s2">10</span><span class="s1">) ** </span><span class="s2">2</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">fun_medazko(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s1">n = y.shape[</span><span class="s2">0</span><span class="s1">] // </span><span class="s2">2</span>
    <span class="s1">k = </span><span class="s2">100</span>
    <span class="s1">c = </span><span class="s2">4</span>

    <span class="s1">phi = </span><span class="s2">2 </span><span class="s0">if </span><span class="s1">t &lt;= </span><span class="s2">5 </span><span class="s0">else </span><span class="s2">0</span>
    <span class="s1">y = np.hstack((phi</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">y[-</span><span class="s2">2</span><span class="s1">]))</span>

    <span class="s1">d = </span><span class="s2">1 </span><span class="s1">/ n</span>
    <span class="s1">j = np.arange(n) + </span><span class="s2">1</span>
    <span class="s1">alpha = </span><span class="s2">2 </span><span class="s1">* (j * d - </span><span class="s2">1</span><span class="s1">) ** </span><span class="s2">3 </span><span class="s1">/ c ** </span><span class="s2">2</span>
    <span class="s1">beta = (j * d - </span><span class="s2">1</span><span class="s1">) ** </span><span class="s2">4 </span><span class="s1">/ c ** </span><span class="s2">2</span>

    <span class="s1">j_2_p1 = </span><span class="s2">2 </span><span class="s1">* j + </span><span class="s2">2</span>
    <span class="s1">j_2_m3 = </span><span class="s2">2 </span><span class="s1">* j - </span><span class="s2">2</span>
    <span class="s1">j_2_m1 = </span><span class="s2">2 </span><span class="s1">* j</span>
    <span class="s1">j_2 = </span><span class="s2">2 </span><span class="s1">* j + </span><span class="s2">1</span>

    <span class="s1">f = np.empty(</span><span class="s2">2 </span><span class="s1">* n)</span>
    <span class="s1">f[::</span><span class="s2">2</span><span class="s1">] = (alpha * (y[j_2_p1] - y[j_2_m3]) / (</span><span class="s2">2 </span><span class="s1">* d) +</span>
              <span class="s1">beta * (y[j_2_m3] - </span><span class="s2">2 </span><span class="s1">* y[j_2_m1] + y[j_2_p1]) / d ** </span><span class="s2">2 </span><span class="s1">-</span>
              <span class="s1">k * y[j_2_m1] * y[j_2])</span>
    <span class="s1">f[</span><span class="s2">1</span><span class="s1">::</span><span class="s2">2</span><span class="s1">] = -k * y[j_2] * y[j_2_m1]</span>

    <span class="s0">return </span><span class="s1">f</span>


<span class="s0">def </span><span class="s1">medazko_sparsity(n):</span>
    <span class="s1">cols = []</span>
    <span class="s1">rows = []</span>

    <span class="s1">i = np.arange(n) * </span><span class="s2">2</span>

    <span class="s1">cols.append(i[</span><span class="s2">1</span><span class="s1">:])</span>
    <span class="s1">rows.append(i[</span><span class="s2">1</span><span class="s1">:] - </span><span class="s2">2</span><span class="s1">)</span>

    <span class="s1">cols.append(i)</span>
    <span class="s1">rows.append(i)</span>

    <span class="s1">cols.append(i)</span>
    <span class="s1">rows.append(i + </span><span class="s2">1</span><span class="s1">)</span>

    <span class="s1">cols.append(i[:-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">rows.append(i[:-</span><span class="s2">1</span><span class="s1">] + </span><span class="s2">2</span><span class="s1">)</span>

    <span class="s1">i = np.arange(n) * </span><span class="s2">2 </span><span class="s1">+ </span><span class="s2">1</span>

    <span class="s1">cols.append(i)</span>
    <span class="s1">rows.append(i)</span>

    <span class="s1">cols.append(i)</span>
    <span class="s1">rows.append(i - </span><span class="s2">1</span><span class="s1">)</span>

    <span class="s1">cols = np.hstack(cols)</span>
    <span class="s1">rows = np.hstack(rows)</span>

    <span class="s0">return </span><span class="s1">coo_matrix((np.ones_like(cols)</span><span class="s0">, </span><span class="s1">(cols</span><span class="s0">, </span><span class="s1">rows)))</span>


<span class="s0">def </span><span class="s1">fun_complex(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">-y</span>


<span class="s0">def </span><span class="s1">jac_complex(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">-np.eye(y.shape[</span><span class="s2">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">jac_complex_sparse(t</span><span class="s0">, </span><span class="s1">y):</span>
    <span class="s0">return </span><span class="s1">csc_matrix(jac_complex(t</span><span class="s0">, </span><span class="s1">y))</span>


<span class="s0">def </span><span class="s1">sol_complex(t):</span>
    <span class="s1">y = (</span><span class="s2">0.5 </span><span class="s1">+ </span><span class="s2">1j</span><span class="s1">) * np.exp(-t)</span>
    <span class="s0">return </span><span class="s1">y.reshape((</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">compute_error(y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol):</span>
    <span class="s1">e = (y - y_true) / (atol + rtol * np.abs(y_true))</span>
    <span class="s0">return </span><span class="s1">np.linalg.norm(e</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">) / np.sqrt(e.shape[</span><span class="s2">0</span><span class="s1">])</span>


<span class="s0">def </span><span class="s1">test_integration():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>

    <span class="s0">for </span><span class="s1">vectorized</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">jac </span><span class="s0">in </span><span class="s1">product(</span>
            <span class="s1">[</span><span class="s0">False, True</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s0">None, </span><span class="s1">jac_rational</span><span class="s0">, </span><span class="s1">jac_rational_sparse]):</span>

        <span class="s0">if </span><span class="s1">vectorized:</span>
            <span class="s1">fun = fun_rational_vectorized</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">fun = fun_rational</span>

        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(UserWarning</span><span class="s0">,</span>
                       <span class="s3">&quot;The following arguments have no effect for a chosen &quot;</span>
                       <span class="s3">&quot;solver: `jac`&quot;</span><span class="s1">)</span>
            <span class="s1">res = solve_ivp(fun</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">,</span>
                            <span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True,</span>
                            <span class="s1">jac=jac</span><span class="s0">, </span><span class="s1">vectorized=vectorized)</span>
        <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.y_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.success)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method == </span><span class="s3">'DOP853'</span><span class="s1">:</span>
            <span class="s4"># DOP853 spends more functions evaluation because it doesn't</span>
            <span class="s4"># have enough time to develop big enough step size.</span>
            <span class="s1">assert_(res.nfev &lt; </span><span class="s2">50</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(res.nfev &lt; </span><span class="s2">40</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
            <span class="s1">assert_equal(res.njev</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">assert_equal(res.nlu</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_(</span><span class="s2">0 </span><span class="s1">&lt; res.njev &lt; </span><span class="s2">3</span><span class="s1">)</span>
            <span class="s1">assert_(</span><span class="s2">0 </span><span class="s1">&lt; res.nlu &lt; </span><span class="s2">10</span><span class="s1">)</span>

        <span class="s1">y_true = sol_rational(res.t)</span>
        <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

        <span class="s1">tc = np.linspace(*t_span)</span>
        <span class="s1">yc_true = sol_rational(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>

        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

        <span class="s1">tc = (t_span[</span><span class="s2">0</span><span class="s1">] + t_span[-</span><span class="s2">1</span><span class="s1">]) / </span><span class="s2">2</span>
        <span class="s1">yc_true = sol_rational(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>

        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

        <span class="s4"># LSODA for some reasons doesn't pass the polynomial through the</span>
        <span class="s4"># previous points exactly after the order change. It might be some</span>
        <span class="s4"># bug in LSOSA implementation or maybe we missing something.</span>
        <span class="s0">if </span><span class="s1">method != </span><span class="s3">'LSODA'</span><span class="s1">:</span>
            <span class="s1">assert_allclose(res.sol(res.t)</span><span class="s0">, </span><span class="s1">res.y</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-15</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_integration_complex():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">0.5 </span><span class="s1">+ </span><span class="s2">1j</span><span class="s1">]</span>
    <span class="s1">t_span = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span>
    <span class="s1">tc = np.linspace(t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s0">for </span><span class="s1">method</span><span class="s0">, </span><span class="s1">jac </span><span class="s0">in </span><span class="s1">product([</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s1">]</span><span class="s0">,</span>
                               <span class="s1">[</span><span class="s0">None, </span><span class="s1">jac_complex</span><span class="s0">, </span><span class="s1">jac_complex_sparse]):</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(UserWarning</span><span class="s0">,</span>
                       <span class="s3">&quot;The following arguments have no effect for a chosen &quot;</span>
                       <span class="s3">&quot;solver: `jac`&quot;</span><span class="s1">)</span>
            <span class="s1">res = solve_ivp(fun_complex</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                            <span class="s1">dense_output=</span><span class="s0">True, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">jac=jac)</span>

        <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.y_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.success)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s0">if </span><span class="s1">method == </span><span class="s3">'DOP853'</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">res.nfev &lt; </span><span class="s2">35</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">res.nfev &lt; </span><span class="s2">25</span>

        <span class="s0">if </span><span class="s1">method == </span><span class="s3">'BDF'</span><span class="s1">:</span>
            <span class="s1">assert_equal(res.njev</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">res.nlu &lt; </span><span class="s2">6</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s0">assert </span><span class="s1">res.njev == </span><span class="s2">0</span>
            <span class="s0">assert </span><span class="s1">res.nlu == </span><span class="s2">0</span>

        <span class="s1">y_true = sol_complex(res.t)</span>
        <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s0">assert </span><span class="s1">np.all(e &lt; </span><span class="s2">5</span><span class="s1">)</span>

        <span class="s1">yc_true = sol_complex(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>
        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>

        <span class="s0">assert </span><span class="s1">np.all(e &lt; </span><span class="s2">5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_integration_sparse_difference():</span>
    <span class="s1">n = </span><span class="s2">200</span>
    <span class="s1">t_span = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">20</span><span class="s1">]</span>
    <span class="s1">y0 = np.zeros(</span><span class="s2">2 </span><span class="s1">* n)</span>
    <span class="s1">y0[</span><span class="s2">1</span><span class="s1">::</span><span class="s2">2</span><span class="s1">] = </span><span class="s2">1</span>
    <span class="s1">sparsity = medazko_sparsity(n)</span>

    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s1">]:</span>
        <span class="s1">res = solve_ivp(fun_medazko</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">jac_sparsity=sparsity)</span>

        <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.y_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.success)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res.y[</span><span class="s2">78</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.233994e-3</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">79</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">148</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.359561e-3</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">149</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">198</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.117374129e-3</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-2</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">199</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.6190807e-5</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">238</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.y[</span><span class="s2">239</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.9999997</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_integration_const_jac():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
    <span class="s1">t_span = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span>
    <span class="s1">J = jac_linear()</span>
    <span class="s1">J_sparse = csc_matrix(J)</span>

    <span class="s0">for </span><span class="s1">method</span><span class="s0">, </span><span class="s1">jac </span><span class="s0">in </span><span class="s1">product([</span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[J</span><span class="s0">, </span><span class="s1">J_sparse]):</span>
        <span class="s1">res = solve_ivp(fun_linear</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                        <span class="s1">method=method</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True, </span><span class="s1">jac=jac)</span>
        <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.y_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.success)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">assert_(res.nfev &lt; </span><span class="s2">100</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.njev</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">0 </span><span class="s1">&lt; res.nlu &lt; </span><span class="s2">15</span><span class="s1">)</span>

        <span class="s1">y_true = sol_linear(res.t)</span>
        <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">10</span><span class="s1">))</span>

        <span class="s1">tc = np.linspace(*t_span)</span>
        <span class="s1">yc_true = sol_linear(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>

        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">15</span><span class="s1">))</span>

        <span class="s1">assert_allclose(res.sol(res.t)</span><span class="s0">, </span><span class="s1">res.y</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-14</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-14</span><span class="s1">)</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_integration_stiff(method):</span>
    <span class="s1">rtol = </span><span class="s2">1e-6</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1e4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">tspan = [</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1e8</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">fun_robertson(t</span><span class="s0">, </span><span class="s1">state):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = state</span>
        <span class="s0">return </span><span class="s1">[</span>
            <span class="s1">-</span><span class="s2">0.04 </span><span class="s1">* x + </span><span class="s2">1e4 </span><span class="s1">* y * z</span><span class="s0">,</span>
            <span class="s2">0.04 </span><span class="s1">* x - </span><span class="s2">1e4 </span><span class="s1">* y * z - </span><span class="s2">3e7 </span><span class="s1">* y * y</span><span class="s0">,</span>
            <span class="s2">3e7 </span><span class="s1">* y * y</span><span class="s0">,</span>
        <span class="s1">]</span>

    <span class="s1">res = solve_ivp(fun_robertson</span><span class="s0">, </span><span class="s1">tspan</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">,</span>
                    <span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">method=method)</span>

    <span class="s4"># If the stiff mode is not activated correctly, these numbers will be much bigger</span>
    <span class="s0">assert </span><span class="s1">res.nfev &lt; </span><span class="s2">5000</span>
    <span class="s0">assert </span><span class="s1">res.njev &lt; </span><span class="s2">200</span>


<span class="s0">def </span><span class="s1">test_events():</span>
    <span class="s0">def </span><span class="s1">event_rational_1(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">y[</span><span class="s2">0</span><span class="s1">] - y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">0.7</span>

    <span class="s0">def </span><span class="s1">event_rational_2(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">0.6 </span><span class="s1">- y[</span><span class="s2">0</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">event_rational_3(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">t - </span><span class="s2">7.4</span>

    <span class="s1">event_rational_3.terminal = </span><span class="s0">True</span>

    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.7</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_2(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = </span><span class="s2">1</span>
        <span class="s1">event_rational_2.direction = </span><span class="s2">1</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1 </span><span class="s1">/ </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">/ </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = -</span><span class="s2">1</span>
        <span class="s1">event_rational_2.direction = -</span><span class="s2">1</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1 </span><span class="s1">/ </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">/ </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.7</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_2(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = </span><span class="s2">0</span>
        <span class="s1">event_rational_2.direction = </span><span class="s2">0</span>

        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1 </span><span class="s1">/ </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">/ </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2</span><span class="s0">,</span>
                                <span class="s1">event_rational_3)</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">2</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.5</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">2</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_3(res.t_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">8</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1 </span><span class="s1">/ </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">/ </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=event_rational_1</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s4"># Also test that termination by event doesn't break interpolants.</span>
        <span class="s1">tc = np.linspace(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.t[-</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">yc_true = sol_rational(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>
        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s2">1e-3</span><span class="s0">, </span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

        <span class="s4"># Test that the y_event matches solution</span>
        <span class="s0">assert </span><span class="s1">np.allclose(sol_rational(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-3</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s4"># Test in backward direction.</span>
    <span class="s1">event_rational_1.direction = </span><span class="s2">0</span>
    <span class="s1">event_rational_2.direction = </span><span class="s2">0</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">8</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">/</span><span class="s2">9</span><span class="s0">, </span><span class="s2">20</span><span class="s1">/</span><span class="s2">81</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.7</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_2(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = -</span><span class="s2">1</span>
        <span class="s1">event_rational_2.direction = -</span><span class="s2">1</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">8</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">/</span><span class="s2">9</span><span class="s0">, </span><span class="s2">20</span><span class="s1">/</span><span class="s2">81</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">5.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">5.7</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_1(res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = </span><span class="s2">1</span>
        <span class="s1">event_rational_2.direction = </span><span class="s2">1</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">8</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">/</span><span class="s2">9</span><span class="s0">, </span><span class="s2">20</span><span class="s1">/</span><span class="s2">81</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2))</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.7</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_2(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">event_rational_1.direction = </span><span class="s2">0</span>
        <span class="s1">event_rational_2.direction = </span><span class="s2">0</span>

        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">8</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s1">/</span><span class="s2">9</span><span class="s0">, </span><span class="s2">20</span><span class="s1">/</span><span class="s2">81</span><span class="s1">]</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                        <span class="s1">events=(event_rational_1</span><span class="s0">, </span><span class="s1">event_rational_2</span><span class="s0">,</span>
                                <span class="s1">event_rational_3)</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">0</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">1</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.t_events[</span><span class="s2">2</span><span class="s1">].size</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.7</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s2">7.3 </span><span class="s1">&lt; res.t_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] &lt; </span><span class="s2">7.5</span><span class="s1">)</span>

        <span class="s1">assert_equal(res.y_events[</span><span class="s2">0</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">1</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(res.y_events[</span><span class="s2">2</span><span class="s1">].shape</span><span class="s0">, </span><span class="s1">(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_2(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.isclose(</span>
            <span class="s1">event_rational_3(res.t_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s4"># Also test that termination by event doesn't break interpolants.</span>
        <span class="s1">tc = np.linspace(res.t[-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">res.t[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">yc_true = sol_rational(tc)</span>
        <span class="s1">yc = res.sol(tc)</span>
        <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s2">1e-3</span><span class="s0">, </span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

        <span class="s0">assert </span><span class="s1">np.allclose(sol_rational(res.t_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">1</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-3</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">np.allclose(sol_rational(res.t_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">res.y_events[</span><span class="s2">2</span><span class="s1">][</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-3</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_max_step():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[RK23</span><span class="s0">, </span><span class="s1">RK45</span><span class="s0">, </span><span class="s1">DOP853</span><span class="s0">, </span><span class="s1">Radau</span><span class="s0">, </span><span class="s1">BDF</span><span class="s0">, </span><span class="s1">LSODA]:</span>
        <span class="s0">for </span><span class="s1">t_span </span><span class="s0">in </span><span class="s1">([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]):</span>
            <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">,</span>
                            <span class="s1">max_step=</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                            <span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
            <span class="s1">assert_equal(res.t[-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[-</span><span class="s2">1</span><span class="s1">])</span>
            <span class="s1">assert_(np.all(np.abs(np.diff(res.t)) &lt;= </span><span class="s2">0.5 </span><span class="s1">+ </span><span class="s2">1e-15</span><span class="s1">))</span>
            <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
            <span class="s1">assert_(res.success)</span>
            <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

            <span class="s1">y_true = sol_rational(res.t)</span>
            <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
            <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

            <span class="s1">tc = np.linspace(*t_span)</span>
            <span class="s1">yc_true = sol_rational(tc)</span>
            <span class="s1">yc = res.sol(tc)</span>

            <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
            <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

            <span class="s4"># See comment in test_integration.</span>
            <span class="s0">if </span><span class="s1">method </span><span class="s0">is not </span><span class="s1">LSODA:</span>
                <span class="s1">assert_allclose(res.sol(res.t)</span><span class="s0">, </span><span class="s1">res.y</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-15</span><span class="s1">)</span>

            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">fun_rational</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                          <span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">max_step=-</span><span class="s2">1</span><span class="s1">)</span>

            <span class="s0">if </span><span class="s1">method </span><span class="s0">is not </span><span class="s1">LSODA:</span>
                <span class="s1">solver = method(fun_rational</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">,</span>
                                <span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">max_step=</span><span class="s2">1e-20</span><span class="s1">)</span>
                <span class="s1">message = solver.step()</span>

                <span class="s1">assert_equal(solver.status</span><span class="s0">, </span><span class="s3">'failed'</span><span class="s1">)</span>
                <span class="s1">assert_(</span><span class="s3">&quot;step size is less&quot; </span><span class="s0">in </span><span class="s1">message)</span>
                <span class="s1">assert_raises(RuntimeError</span><span class="s0">, </span><span class="s1">solver.step)</span>


<span class="s0">def </span><span class="s1">test_first_step():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">first_step = </span><span class="s2">0.1</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[RK23</span><span class="s0">, </span><span class="s1">RK45</span><span class="s0">, </span><span class="s1">DOP853</span><span class="s0">, </span><span class="s1">Radau</span><span class="s0">, </span><span class="s1">BDF</span><span class="s0">, </span><span class="s1">LSODA]:</span>
        <span class="s0">for </span><span class="s1">t_span </span><span class="s0">in </span><span class="s1">([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]):</span>
            <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">,</span>
                            <span class="s1">max_step=</span><span class="s2">0.5</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">method=method</span><span class="s0">,</span>
                            <span class="s1">dense_output=</span><span class="s0">True, </span><span class="s1">first_step=first_step)</span>

            <span class="s1">assert_equal(res.t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">])</span>
            <span class="s1">assert_equal(res.t[-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[-</span><span class="s2">1</span><span class="s1">])</span>
            <span class="s1">assert_allclose(first_step</span><span class="s0">, </span><span class="s1">np.abs(res.t[</span><span class="s2">1</span><span class="s1">] - </span><span class="s2">5</span><span class="s1">))</span>
            <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
            <span class="s1">assert_(res.success)</span>
            <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

            <span class="s1">y_true = sol_rational(res.t)</span>
            <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
            <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

            <span class="s1">tc = np.linspace(*t_span)</span>
            <span class="s1">yc_true = sol_rational(tc)</span>
            <span class="s1">yc = res.sol(tc)</span>

            <span class="s1">e = compute_error(yc</span><span class="s0">, </span><span class="s1">yc_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
            <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

            <span class="s4"># See comment in test_integration.</span>
            <span class="s0">if </span><span class="s1">method </span><span class="s0">is not </span><span class="s1">LSODA:</span>
                <span class="s1">assert_allclose(res.sol(res.t)</span><span class="s0">, </span><span class="s1">res.y</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-15</span><span class="s1">)</span>

            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">fun_rational</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                          <span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">first_step=-</span><span class="s2">1</span><span class="s1">)</span>
            <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">method</span><span class="s0">, </span><span class="s1">fun_rational</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                          <span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">first_step=</span><span class="s2">5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_t_eval():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">t_span </span><span class="s0">in </span><span class="s1">([</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]):</span>
        <span class="s1">t_eval = np.linspace(t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                        <span class="s1">t_eval=t_eval)</span>
        <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
        <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s1">assert_(res.success)</span>
        <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">y_true = sol_rational(res.t)</span>
        <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
        <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

    <span class="s1">t_eval = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">5.01</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8.01</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                    <span class="s1">t_eval=t_eval)</span>
    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
    <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res.success)</span>
    <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">y_true = sol_rational(res.t)</span>
    <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
    <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

    <span class="s1">t_eval = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">4.99</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.01</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span>
    <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                    <span class="s1">t_eval=t_eval)</span>
    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
    <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res.success)</span>
    <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">t_eval = [</span><span class="s2">5.01</span><span class="s0">, </span><span class="s2">7</span><span class="s0">, </span><span class="s2">8</span><span class="s0">, </span><span class="s2">8.01</span><span class="s1">]</span>
    <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                    <span class="s1">t_eval=t_eval)</span>
    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
    <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res.success)</span>
    <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">y_true = sol_rational(res.t)</span>
    <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
    <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>

    <span class="s1">t_eval = [</span><span class="s2">4.99</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">1.1</span><span class="s0">, </span><span class="s2">1.01</span><span class="s1">]</span>
    <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                    <span class="s1">t_eval=t_eval)</span>
    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
    <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res.success)</span>
    <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">t_eval = [</span><span class="s2">4</span><span class="s0">, </span><span class="s2">6</span><span class="s1">]</span>
    <span class="s1">assert_raises(ValueError</span><span class="s0">, </span><span class="s1">solve_ivp</span><span class="s0">, </span><span class="s1">fun_rational</span><span class="s0">, </span><span class="s1">[</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                  <span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">, </span><span class="s1">t_eval=t_eval)</span>


<span class="s0">def </span><span class="s1">test_t_eval_dense_output():</span>
    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">t_span = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">t_eval = np.linspace(t_span[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">t_span[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">10</span><span class="s1">)</span>
    <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                    <span class="s1">t_eval=t_eval)</span>
    <span class="s1">res_d = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                      <span class="s1">t_eval=t_eval</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">t_eval)</span>
    <span class="s1">assert_(res.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res.success)</span>
    <span class="s1">assert_equal(res.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s1">assert_equal(res.t</span><span class="s0">, </span><span class="s1">res_d.t)</span>
    <span class="s1">assert_equal(res.y</span><span class="s0">, </span><span class="s1">res_d.y)</span>
    <span class="s1">assert_(res_d.t_events </span><span class="s0">is None</span><span class="s1">)</span>
    <span class="s1">assert_(res_d.success)</span>
    <span class="s1">assert_equal(res_d.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

    <span class="s4"># if t and y are equal only test values for one case</span>
    <span class="s1">y_true = sol_rational(res.t)</span>
    <span class="s1">e = compute_error(res.y</span><span class="s0">, </span><span class="s1">y_true</span><span class="s0">, </span><span class="s1">rtol</span><span class="s0">, </span><span class="s1">atol)</span>
    <span class="s1">assert_(np.all(e &lt; </span><span class="s2">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_t_eval_early_event():</span>
    <span class="s0">def </span><span class="s1">early_event(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">t - </span><span class="s2">7</span>

    <span class="s1">early_event.terminal = </span><span class="s0">True</span>

    <span class="s1">rtol = </span><span class="s2">1e-3</span>
    <span class="s1">atol = </span><span class="s2">1e-6</span>
    <span class="s1">y0 = [</span><span class="s2">1</span><span class="s1">/</span><span class="s2">3</span><span class="s0">, </span><span class="s2">2</span><span class="s1">/</span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">t_span = [</span><span class="s2">5</span><span class="s0">, </span><span class="s2">9</span><span class="s1">]</span>
    <span class="s1">t_eval = np.linspace(</span><span class="s2">7.5</span><span class="s0">, </span><span class="s2">9</span><span class="s0">, </span><span class="s2">16</span><span class="s1">)</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(UserWarning</span><span class="s0">,</span>
                       <span class="s3">&quot;The following arguments have no effect for a chosen &quot;</span>
                       <span class="s3">&quot;solver: `jac`&quot;</span><span class="s1">)</span>
            <span class="s1">res = solve_ivp(fun_rational</span><span class="s0">, </span><span class="s1">t_span</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=rtol</span><span class="s0">, </span><span class="s1">atol=atol</span><span class="s0">,</span>
                            <span class="s1">method=method</span><span class="s0">, </span><span class="s1">t_eval=t_eval</span><span class="s0">, </span><span class="s1">events=early_event</span><span class="s0">,</span>
                            <span class="s1">jac=jac_rational)</span>
        <span class="s0">assert </span><span class="s1">res.success</span>
        <span class="s0">assert </span><span class="s1">res.message == </span><span class="s3">'A termination event occurred.'</span>
        <span class="s0">assert </span><span class="s1">res.status == </span><span class="s2">1</span>
        <span class="s0">assert not </span><span class="s1">res.t </span><span class="s0">and not </span><span class="s1">res.y</span>
        <span class="s0">assert </span><span class="s1">len(res.t_events) == </span><span class="s2">1</span>
        <span class="s0">assert </span><span class="s1">res.t_events[</span><span class="s2">0</span><span class="s1">].size == </span><span class="s2">1</span>
        <span class="s0">assert </span><span class="s1">res.t_events[</span><span class="s2">0</span><span class="s1">][</span><span class="s2">0</span><span class="s1">] == </span><span class="s2">7</span>


<span class="s0">def </span><span class="s1">test_no_integration():</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s1">sol = solve_ivp(</span><span class="s0">lambda </span><span class="s1">t</span><span class="s0">, </span><span class="s1">y: -y</span><span class="s0">, </span><span class="s1">[</span><span class="s2">4</span><span class="s0">, </span><span class="s2">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">method=method</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(sol.sol(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(sol.sol([</span><span class="s2">4</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">6</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]])</span>


<span class="s0">def </span><span class="s1">test_no_integration_class():</span>
    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[RK23</span><span class="s0">, </span><span class="s1">RK45</span><span class="s0">, </span><span class="s1">DOP853</span><span class="s0">, </span><span class="s1">Radau</span><span class="s0">, </span><span class="s1">BDF</span><span class="s0">, </span><span class="s1">LSODA]:</span>
        <span class="s1">solver = method(</span><span class="s0">lambda </span><span class="s1">t</span><span class="s0">, </span><span class="s1">y: -y</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">)</span>
        <span class="s1">solver.step()</span>
        <span class="s1">assert_equal(solver.status</span><span class="s0">, </span><span class="s3">'finished'</span><span class="s1">)</span>
        <span class="s1">sol = solver.dense_output()</span>
        <span class="s1">assert_equal(sol(</span><span class="s2">0.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">0.0</span><span class="s1">])</span>
        <span class="s1">assert_equal(sol([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]])</span>

        <span class="s1">solver = method(</span><span class="s0">lambda </span><span class="s1">t</span><span class="s0">, </span><span class="s1">y: -y</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">solver.step()</span>
        <span class="s1">assert_equal(solver.status</span><span class="s0">, </span><span class="s3">'finished'</span><span class="s1">)</span>
        <span class="s1">sol = solver.dense_output()</span>
        <span class="s1">assert_equal(sol(</span><span class="s2">100.0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[])</span>
        <span class="s1">assert_equal(sol([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.empty((</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_empty():</span>
    <span class="s0">def </span><span class="s1">fun(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">np.zeros((</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s1">y0 = np.zeros((</span><span class="s2">0</span><span class="s0">,</span><span class="s1">))</span>

    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s1">sol = assert_no_warnings(solve_ivp</span><span class="s0">, </span><span class="s1">fun</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                                 <span class="s1">method=method</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(sol.sol(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">0</span><span class="s0">,</span><span class="s1">)))</span>
        <span class="s1">assert_equal(sol.sol([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>

    <span class="s0">for </span><span class="s1">method </span><span class="s0">in </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">]:</span>
        <span class="s1">sol = assert_no_warnings(solve_ivp</span><span class="s0">, </span><span class="s1">fun</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">np.inf]</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">,</span>
                                 <span class="s1">method=method</span><span class="s0">, </span><span class="s1">dense_output=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(sol.sol(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">0</span><span class="s0">,</span><span class="s1">)))</span>
        <span class="s1">assert_equal(sol.sol([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.zeros((</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_ConstantDenseOutput():</span>
    <span class="s1">sol = ConstantDenseOutput(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]))</span>
    <span class="s1">assert_allclose(sol(</span><span class="s2">1.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
    <span class="s1">assert_allclose(sol([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">[[</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">]])</span>

    <span class="s1">sol = ConstantDenseOutput(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.array([]))</span>
    <span class="s1">assert_allclose(sol(</span><span class="s2">1.5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.empty(</span><span class="s2">0</span><span class="s1">))</span>
    <span class="s1">assert_allclose(sol([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.empty((</span><span class="s2">0</span><span class="s0">, </span><span class="s2">3</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_classes():</span>
    <span class="s1">y0 = [</span><span class="s2">1 </span><span class="s1">/ </span><span class="s2">3</span><span class="s0">, </span><span class="s2">2 </span><span class="s1">/ </span><span class="s2">9</span><span class="s1">]</span>
    <span class="s0">for </span><span class="s1">cls </span><span class="s0">in </span><span class="s1">[RK23</span><span class="s0">, </span><span class="s1">RK45</span><span class="s0">, </span><span class="s1">DOP853</span><span class="s0">, </span><span class="s1">Radau</span><span class="s0">, </span><span class="s1">BDF</span><span class="s0">, </span><span class="s1">LSODA]:</span>
        <span class="s1">solver = cls(fun_rational</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(solver.n</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.status</span><span class="s0">, </span><span class="s3">'running'</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.t_bound</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(solver.direction</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.t</span><span class="s0">, </span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.y</span><span class="s0">, </span><span class="s1">y0)</span>
        <span class="s1">assert_(solver.step_size </span><span class="s0">is None</span><span class="s1">)</span>
        <span class="s0">if </span><span class="s1">cls </span><span class="s0">is not </span><span class="s1">LSODA:</span>
            <span class="s1">assert_(solver.nfev &gt; </span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">assert_(solver.njev &gt;= </span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">assert_equal(solver.nlu</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_equal(solver.nfev</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">assert_equal(solver.njev</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
            <span class="s1">assert_equal(solver.nlu</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>

        <span class="s1">assert_raises(RuntimeError</span><span class="s0">, </span><span class="s1">solver.dense_output)</span>

        <span class="s1">message = solver.step()</span>
        <span class="s1">assert_equal(solver.status</span><span class="s0">, </span><span class="s3">'running'</span><span class="s1">)</span>
        <span class="s1">assert_equal(message</span><span class="s0">, None</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.n</span><span class="s0">, </span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">assert_equal(solver.t_bound</span><span class="s0">, </span><span class="s1">np.inf)</span>
        <span class="s1">assert_equal(solver.direction</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">assert_(solver.t &gt; </span><span class="s2">5</span><span class="s1">)</span>
        <span class="s1">assert_(</span><span class="s0">not </span><span class="s1">np.all(np.equal(solver.y</span><span class="s0">, </span><span class="s1">y0)))</span>
        <span class="s1">assert_(solver.step_size &gt; </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(solver.nfev &gt; </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(solver.njev &gt;= </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">assert_(solver.nlu &gt;= </span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">sol = solver.dense_output()</span>
        <span class="s1">assert_allclose(sol(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">y0</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">0</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_OdeSolution():</span>
    <span class="s1">ts = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">5</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=float)</span>
    <span class="s1">s1 = ConstantDenseOutput(ts[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ts[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s2">1</span><span class="s1">]))</span>
    <span class="s1">s2 = ConstantDenseOutput(ts[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ts[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s1">]))</span>

    <span class="s1">sol = OdeSolution(ts</span><span class="s0">, </span><span class="s1">[s1</span><span class="s0">, </span><span class="s1">s2])</span>

    <span class="s1">assert_equal(sol(-</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s1">assert_equal(sol([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1.5</span><span class="s0">, </span><span class="s2">4.5</span><span class="s0">, </span><span class="s2">2.5</span><span class="s0">, </span><span class="s2">5</span><span class="s0">, </span><span class="s2">5.5</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span><span class="s0">,</span>
                 <span class="s1">np.array([[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]]))</span>

    <span class="s1">ts = np.array([</span><span class="s2">10</span><span class="s0">, </span><span class="s2">4</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s1">])</span>
    <span class="s1">s1 = ConstantDenseOutput(ts[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ts[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s2">1</span><span class="s1">]))</span>
    <span class="s1">s2 = ConstantDenseOutput(ts[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ts[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">1</span><span class="s1">]))</span>

    <span class="s1">sol = OdeSolution(ts</span><span class="s0">, </span><span class="s1">[s1</span><span class="s0">, </span><span class="s1">s2])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">11</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(-</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(-</span><span class="s2">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">])</span>

    <span class="s1">assert_equal(sol([</span><span class="s2">12</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s1">-</span><span class="s2">3</span><span class="s0">, </span><span class="s2">6</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">4</span><span class="s1">])</span><span class="s0">,</span>
                 <span class="s1">np.array([[-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]]))</span>

    <span class="s1">ts = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
    <span class="s1">s = ConstantDenseOutput(</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">10</span><span class="s1">]))</span>
    <span class="s1">sol = OdeSolution(ts</span><span class="s0">, </span><span class="s1">[s])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10</span><span class="s1">])</span>
    <span class="s1">assert_equal(sol(</span><span class="s2">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10</span><span class="s1">])</span>

    <span class="s1">assert_equal(sol([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]]))</span>


<span class="s0">def </span><span class="s1">test_num_jac():</span>
    <span class="s0">def </span><span class="s1">fun(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">np.vstack([</span>
            <span class="s1">-</span><span class="s2">0.04 </span><span class="s1">* y[</span><span class="s2">0</span><span class="s1">] + </span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] * y[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s2">0.04 </span><span class="s1">* y[</span><span class="s2">0</span><span class="s1">] - </span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] * y[</span><span class="s2">2</span><span class="s1">] - </span><span class="s2">3e7 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">2</span><span class="s0">,</span>
            <span class="s2">3e7 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">] ** </span><span class="s2">2</span>
        <span class="s1">])</span>

    <span class="s0">def </span><span class="s1">jac(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">np.array([</span>
            <span class="s1">[-</span><span class="s2">0.04</span><span class="s0">, </span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">0.04</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">2</span><span class="s1">] - </span><span class="s2">6e7 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1e4 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">]]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">6e7 </span><span class="s1">* y[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span>
        <span class="s1">])</span>

    <span class="s1">t = </span><span class="s2">1</span>
    <span class="s1">y = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
    <span class="s1">J_true = jac(t</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">threshold = </span><span class="s2">1e-5</span>
    <span class="s1">f = fun(t</span><span class="s0">, </span><span class="s1">y).ravel()</span>

    <span class="s1">J_num</span><span class="s0">, </span><span class="s1">factor = num_jac(fun</span><span class="s0">, </span><span class="s1">t</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">threshold</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">assert_allclose(J_num</span><span class="s0">, </span><span class="s1">J_true</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-5</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-5</span><span class="s1">)</span>

    <span class="s1">J_num</span><span class="s0">, </span><span class="s1">factor = num_jac(fun</span><span class="s0">, </span><span class="s1">t</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">threshold</span><span class="s0">, </span><span class="s1">factor)</span>
    <span class="s1">assert_allclose(J_num</span><span class="s0">, </span><span class="s1">J_true</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-5</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-5</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_num_jac_sparse():</span>
    <span class="s0">def </span><span class="s1">fun(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s1">e = y[</span><span class="s2">1</span><span class="s1">:]**</span><span class="s2">3 </span><span class="s1">- y[:-</span><span class="s2">1</span><span class="s1">]**</span><span class="s2">2</span>
        <span class="s1">z = np.zeros(y.shape[</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s0">return </span><span class="s1">np.vstack((z</span><span class="s0">, </span><span class="s2">3 </span><span class="s1">* e)) + np.vstack((</span><span class="s2">2 </span><span class="s1">* e</span><span class="s0">, </span><span class="s1">z))</span>

    <span class="s0">def </span><span class="s1">structure(n):</span>
        <span class="s1">A = np.zeros((n</span><span class="s0">, </span><span class="s1">n)</span><span class="s0">, </span><span class="s1">dtype=int)</span>
        <span class="s1">A[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">A[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s2">1</span><span class="s0">, </span><span class="s1">n - </span><span class="s2">1</span><span class="s1">):</span>
            <span class="s1">A[i</span><span class="s0">, </span><span class="s1">i - </span><span class="s2">1</span><span class="s1">: i + </span><span class="s2">2</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">A[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">] = </span><span class="s2">1</span>
        <span class="s1">A[-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s1">] = </span><span class="s2">1</span>

        <span class="s0">return </span><span class="s1">A</span>

    <span class="s1">np.random.seed(</span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">n = </span><span class="s2">20</span>
    <span class="s1">y = np.random.randn(n)</span>
    <span class="s1">A = structure(n)</span>
    <span class="s1">groups = group_columns(A)</span>

    <span class="s1">f = fun(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">y[:</span><span class="s0">, None</span><span class="s1">]).ravel()</span>

    <span class="s4"># Compare dense and sparse results, assuming that dense implementation</span>
    <span class="s4"># is correct (as it is straightforward).</span>
    <span class="s1">J_num_sparse</span><span class="s0">, </span><span class="s1">factor_sparse = num_jac(fun</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">y.ravel()</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">1e-8</span><span class="s0">, None,</span>
                                          <span class="s1">sparsity=(A</span><span class="s0">, </span><span class="s1">groups))</span>
    <span class="s1">J_num_dense</span><span class="s0">, </span><span class="s1">factor_dense = num_jac(fun</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">y.ravel()</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">1e-8</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">assert_allclose(J_num_dense</span><span class="s0">, </span><span class="s1">J_num_sparse.toarray()</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(factor_dense</span><span class="s0">, </span><span class="s1">factor_sparse</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-14</span><span class="s1">)</span>

    <span class="s4"># Take small factors to trigger their recomputing inside.</span>
    <span class="s1">factor = np.random.uniform(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">size=n)</span>
    <span class="s1">J_num_sparse</span><span class="s0">, </span><span class="s1">factor_sparse = num_jac(fun</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">y.ravel()</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">1e-8</span><span class="s0">, </span><span class="s1">factor</span><span class="s0">,</span>
                                          <span class="s1">sparsity=(A</span><span class="s0">, </span><span class="s1">groups))</span>
    <span class="s1">J_num_dense</span><span class="s0">, </span><span class="s1">factor_dense = num_jac(fun</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">y.ravel()</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">1e-8</span><span class="s0">, </span><span class="s1">factor)</span>

    <span class="s1">assert_allclose(J_num_dense</span><span class="s0">, </span><span class="s1">J_num_sparse.toarray()</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(factor_dense</span><span class="s0">, </span><span class="s1">factor_sparse</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-12</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-14</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_args():</span>

    <span class="s4"># sys3 is actually two decoupled systems. (x, y) form a</span>
    <span class="s4"># linear oscillator, while z is a nonlinear first order</span>
    <span class="s4"># system with equilibria at z=0 and z=1. If k &gt; 0, z=1</span>
    <span class="s4"># is stable and z=0 is unstable.</span>

    <span class="s0">def </span><span class="s1">sys3(t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = w</span>
        <span class="s0">return </span><span class="s1">[-omega*y</span><span class="s0">, </span><span class="s1">omega*x</span><span class="s0">, </span><span class="s1">k*z*(</span><span class="s2">1 </span><span class="s1">- z)]</span>

    <span class="s0">def </span><span class="s1">sys3_jac(t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = w</span>
        <span class="s1">J = np.array([[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-omega</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[omega</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">k*(</span><span class="s2">1 </span><span class="s1">- </span><span class="s2">2</span><span class="s1">*z)]])</span>
        <span class="s0">return </span><span class="s1">J</span>

    <span class="s0">def </span><span class="s1">sys3_x0decreasing(t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = w</span>
        <span class="s0">return </span><span class="s1">x</span>

    <span class="s0">def </span><span class="s1">sys3_y0increasing(t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = w</span>
        <span class="s0">return </span><span class="s1">y</span>

    <span class="s0">def </span><span class="s1">sys3_zfinal(t</span><span class="s0">, </span><span class="s1">w</span><span class="s0">, </span><span class="s1">omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal):</span>
        <span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z = w</span>
        <span class="s0">return </span><span class="s1">z - zfinal</span>

    <span class="s4"># Set the event flags for the event functions.</span>
    <span class="s1">sys3_x0decreasing.direction = -</span><span class="s2">1</span>
    <span class="s1">sys3_y0increasing.direction = </span><span class="s2">1</span>
    <span class="s1">sys3_zfinal.terminal = </span><span class="s0">True</span>

    <span class="s1">omega = </span><span class="s2">2</span>
    <span class="s1">k = </span><span class="s2">4</span>

    <span class="s1">tfinal = </span><span class="s2">5</span>
    <span class="s1">zfinal = </span><span class="s2">0.99</span>
    <span class="s4"># Find z0 such that when z(0) = z0, z(tfinal) = zfinal.</span>
    <span class="s4"># The condition z(tfinal) = zfinal is the terminal event.</span>
    <span class="s1">z0 = np.exp(-k*tfinal)/((</span><span class="s2">1 </span><span class="s1">- zfinal)/zfinal + np.exp(-k*tfinal))</span>

    <span class="s1">w0 = [</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">z0]</span>

    <span class="s4"># Provide the jac argument and use the Radau method to ensure that the use</span>
    <span class="s4"># of the Jacobian function is exercised.</span>
    <span class="s4"># If event handling is working, the solution will stop at tfinal, not tend.</span>
    <span class="s1">tend = </span><span class="s2">2</span><span class="s1">*tfinal</span>
    <span class="s1">sol = solve_ivp(sys3</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">tend]</span><span class="s0">, </span><span class="s1">w0</span><span class="s0">,</span>
                    <span class="s1">events=[sys3_x0decreasing</span><span class="s0">, </span><span class="s1">sys3_y0increasing</span><span class="s0">, </span><span class="s1">sys3_zfinal]</span><span class="s0">,</span>
                    <span class="s1">dense_output=</span><span class="s0">True, </span><span class="s1">args=(omega</span><span class="s0">, </span><span class="s1">k</span><span class="s0">, </span><span class="s1">zfinal)</span><span class="s0">,</span>
                    <span class="s1">method=</span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s1">jac=sys3_jac</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s2">1e-10</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-13</span><span class="s1">)</span>

    <span class="s4"># Check that we got the expected events at the expected times.</span>
    <span class="s1">x0events_t = sol.t_events[</span><span class="s2">0</span><span class="s1">]</span>
    <span class="s1">y0events_t = sol.t_events[</span><span class="s2">1</span><span class="s1">]</span>
    <span class="s1">zfinalevents_t = sol.t_events[</span><span class="s2">2</span><span class="s1">]</span>
    <span class="s1">assert_allclose(x0events_t</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.5</span><span class="s1">*np.pi</span><span class="s0">, </span><span class="s2">1.5</span><span class="s1">*np.pi])</span>
    <span class="s1">assert_allclose(y0events_t</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.25</span><span class="s1">*np.pi</span><span class="s0">, </span><span class="s2">1.25</span><span class="s1">*np.pi])</span>
    <span class="s1">assert_allclose(zfinalevents_t</span><span class="s0">, </span><span class="s1">[tfinal])</span>

    <span class="s4"># Check that the solution agrees with the known exact solution.</span>
    <span class="s1">t = np.linspace(</span><span class="s2">0</span><span class="s0">, </span><span class="s1">zfinalevents_t[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">250</span><span class="s1">)</span>
    <span class="s1">w = sol.sol(t)</span>
    <span class="s1">assert_allclose(w[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.sin(omega*t)</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-9</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>
    <span class="s1">assert_allclose(w[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">-np.cos(omega*t)</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-9</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>
    <span class="s1">assert_allclose(w[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s2">1</span><span class="s1">/(((</span><span class="s2">1 </span><span class="s1">- z0)/z0)*np.exp(-k*t) + </span><span class="s2">1</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">rtol=</span><span class="s2">1e-9</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>

    <span class="s4"># Check that the state variables have the expected values at the events.</span>
    <span class="s1">x0events = sol.sol(x0events_t)</span>
    <span class="s1">y0events = sol.sol(y0events_t)</span>
    <span class="s1">zfinalevents = sol.sol(zfinalevents_t)</span>
    <span class="s1">assert_allclose(x0events[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.zeros_like(x0events[</span><span class="s2">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">5e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(x0events[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones_like(x0events[</span><span class="s2">1</span><span class="s1">]))</span>
    <span class="s1">assert_allclose(y0events[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones_like(y0events[</span><span class="s2">0</span><span class="s1">]))</span>
    <span class="s1">assert_allclose(y0events[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.zeros_like(y0events[</span><span class="s2">1</span><span class="s1">])</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">5e-14</span><span class="s1">)</span>
    <span class="s1">assert_allclose(zfinalevents[</span><span class="s2">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[zfinal])</span>


<span class="s0">def </span><span class="s1">test_array_rtol():</span>
    <span class="s4"># solve_ivp had a bug with array_like `rtol`; see gh-15482</span>
    <span class="s4"># check that it's fixed</span>
    <span class="s0">def </span><span class="s1">f(t</span><span class="s0">, </span><span class="s1">y):</span>
        <span class="s0">return </span><span class="s1">y[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">y[</span><span class="s2">1</span><span class="s1">]</span>

    <span class="s4"># no warning (or error) when `rtol` is array_like</span>
    <span class="s1">sol = solve_ivp(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=[</span><span class="s2">1e-1</span><span class="s0">, </span><span class="s2">1e-1</span><span class="s1">])</span>
    <span class="s1">err1 = np.abs(np.linalg.norm(sol.y[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">] - np.exp(</span><span class="s2">1</span><span class="s1">)))</span>

    <span class="s4"># warning when an element of `rtol` is too small</span>
    <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s3">&quot;At least one element...&quot;</span><span class="s1">):</span>
        <span class="s1">sol = solve_ivp(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">1.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">rtol=[</span><span class="s2">1e-1</span><span class="s0">, </span><span class="s2">1e-16</span><span class="s1">])</span>
        <span class="s1">err2 = np.abs(np.linalg.norm(sol.y[:</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">] - np.exp(</span><span class="s2">1</span><span class="s1">)))</span>

    <span class="s4"># tighter rtol improves the error</span>
    <span class="s0">assert </span><span class="s1">err2 &lt; err1</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s3">'method'</span><span class="s0">, </span><span class="s1">[</span><span class="s3">'RK23'</span><span class="s0">, </span><span class="s3">'RK45'</span><span class="s0">, </span><span class="s3">'DOP853'</span><span class="s0">, </span><span class="s3">'Radau'</span><span class="s0">, </span><span class="s3">'BDF'</span><span class="s0">, </span><span class="s3">'LSODA'</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_integration_zero_rhs(method):</span>
    <span class="s1">result = solve_ivp(fun_zero</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s2">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">method=method)</span>
    <span class="s1">assert_(result.success)</span>
    <span class="s1">assert_equal(result.status</span><span class="s0">, </span><span class="s2">0</span><span class="s1">)</span>
    <span class="s1">assert_allclose(result.y</span><span class="s0">, </span><span class="s2">1.0</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s2">1e-15</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_args_single_value():</span>
    <span class="s0">def </span><span class="s1">fun_with_arg(t</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">a):</span>
        <span class="s0">return </span><span class="s1">a*y</span>

    <span class="s1">message = </span><span class="s3">&quot;Supplied 'args' cannot be unpacked.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(TypeError</span><span class="s0">, </span><span class="s1">match=message):</span>
        <span class="s1">solve_ivp(fun_with_arg</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">args=-</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s1">sol = solve_ivp(fun_with_arg</span><span class="s0">, </span><span class="s1">(</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">args=(-</span><span class="s2">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_allclose(sol.y[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.exp(-</span><span class="s2">0.1</span><span class="s1">))</span>

<span class="s1">@pytest.mark.parametrize(</span><span class="s3">&quot;f0_fill&quot;</span><span class="s0">, </span><span class="s1">[np.nan</span><span class="s0">, </span><span class="s1">np.inf])</span>
<span class="s0">def </span><span class="s1">test_initial_state_finiteness(f0_fill):</span>
    <span class="s4"># regression test for gh-17846</span>
    <span class="s1">msg = </span><span class="s3">&quot;All components of the initial state `y0` must be finite.&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=msg):</span>
        <span class="s1">solve_ivp(fun_zero</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s2">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.full(</span><span class="s2">3</span><span class="s0">, </span><span class="s1">f0_fill))</span>
</pre>
</body>
</html>