<html>
<head>
<title>test_atop.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_atop.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">collections</span>
<span class="s0">from </span><span class="s1">operator </span><span class="s0">import </span><span class="s1">add</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
<span class="s0">from </span><span class="s1">dask.array.utils </span><span class="s0">import </span><span class="s1">assert_eq</span>
<span class="s0">from </span><span class="s1">dask.blockwise </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_BLOCKWISE_DEFAULT_PREFIX</span><span class="s0">,</span>
    <span class="s1">Blockwise</span><span class="s0">,</span>
    <span class="s1">_unique_dep</span><span class="s0">,</span>
    <span class="s1">index_subs</span><span class="s0">,</span>
    <span class="s1">optimize_blockwise</span><span class="s0">,</span>
    <span class="s1">rewrite_blockwise</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.highlevelgraph </span><span class="s0">import </span><span class="s1">HighLevelGraph</span>
<span class="s0">from </span><span class="s1">dask.utils_test </span><span class="s0">import </span><span class="s1">dec</span><span class="s0">, </span><span class="s1">hlg_layer_topological</span><span class="s0">, </span><span class="s1">inc</span>

<span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s1">g = </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s2">&quot;g&quot;</span>
<span class="s1">_0</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2</span><span class="s0">, </span><span class="s1">_3</span><span class="s0">, </span><span class="s1">_4</span><span class="s0">, </span><span class="s1">_5</span><span class="s0">, </span><span class="s1">_6</span><span class="s0">, </span><span class="s1">_7</span><span class="s0">, </span><span class="s1">_8</span><span class="s0">, </span><span class="s1">_9 = (</span>
    <span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">_BLOCKWISE_DEFAULT_PREFIX</span><span class="s0">}{</span><span class="s1">i</span><span class="s0">}</span><span class="s2">&quot; </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)</span>
<span class="s1">)</span>
<span class="s1">i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k = </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;inputs,expected&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s4"># output name, output index, task, input indices</span>
        <span class="s1">[[(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])]</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (dec</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{d: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">d</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (dec</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">,</span>
                    <span class="s1">d: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s1">{_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">, </span><span class="s1">c: (inc</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">))}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (sum</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span><span class="s0">, </span><span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s1">{_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span><span class="s1">): (sum</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">, </span><span class="s1">c: (inc</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;k&quot;</span><span class="s1">))}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;kA&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{d: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(g</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">{g: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">g</span><span class="s0">,</span>
                <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">g: (add</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_unique_dep(d</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(d</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;ji&quot;</span><span class="s0">, </span><span class="s1">{b: (np.transpose</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">): (np.transpose</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;ji&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{d: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">d</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{d: (inc</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">{b: (np.transpose</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ji&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">{d: (np.dot</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;kj&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">d</span><span class="s0">,</span>
                <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">d: (np.dot</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ik&quot;</span><span class="s1">): (np.transpose</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;kj&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;ki&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{f: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(g</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{g: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">g</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">g: (add</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_unique_dep(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_2</span><span class="s0">, </span><span class="s1">_3)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s1">i)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{f: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(g</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{g: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">g</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s1">g: (add</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_unique_dep(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_2)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (sum</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (sum</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;iA&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{c: (inc</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{d: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">d</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s1">{d: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">))</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s4"># Include literals</span>
        <span class="s1">[</span>
            <span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])]</span><span class="s0">,</span>
            <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">456</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s1">{_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)</span><span class="s0">, </span><span class="s1">c: (add</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s3">456</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s4"># Literals that compare equal (e.g. 0 and False) aren't deduplicated</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">False, None</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s1">{_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)</span><span class="s0">, </span><span class="s1">c: (add</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s0">False, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">0</span><span class="s0">, None</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s4"># Literals are deduplicated</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s1">c</span><span class="s0">,</span>
                <span class="s2">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s1">{_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">, </span><span class="s1">c: (add</span><span class="s0">, </span><span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_0)}</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s4"># Check cases where two distinct indices are used</span>
        <span class="s4"># for the same dependency name, and where the same</span>
        <span class="s4"># dependency-index combination is repeated</span>
        <span class="s4"># (See: https://github.com/dask/dask/issues/8535)</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">{d: (inc</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(c</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s2">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;ijk&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s2">&quot;d&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">_0)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s1">): (</span>
                        <span class="s1">add</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_3</span><span class="s0">, </span><span class="s1">_2)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(</span><span class="s3">123</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">[</span>
                <span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">{b: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">{c: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)])</span><span class="s0">,</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s2">&quot;ijk&quot;</span><span class="s0">, </span><span class="s1">{d: (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1</span><span class="s0">, </span><span class="s1">_2)}</span><span class="s0">, </span><span class="s1">[(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)])</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s1">(</span>
                <span class="s2">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;ijk&quot;</span><span class="s0">,</span>
                <span class="s1">{</span>
                    <span class="s2">&quot;d&quot;</span><span class="s1">: (</span>
                        <span class="s1">add</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(c</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">): (</span>
                        <span class="s1">add</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_0</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                    <span class="s1">_unique_dep(b</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">): (add</span><span class="s0">, </span><span class="s1">_2</span><span class="s0">, </span><span class="s1">_1)</span><span class="s0">,</span>
                <span class="s1">}</span><span class="s0">,</span>
                <span class="s1">[(a</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s1">)]</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_rewrite(inputs</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">inputs = [</span>
        <span class="s1">Blockwise(</span>
            <span class="s1">*inp</span><span class="s0">, </span><span class="s1">numblocks={k: (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">) * len(v) </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">inp[-</span><span class="s3">1</span><span class="s1">] </span><span class="s0">if </span><span class="s1">v </span><span class="s0">is not None</span><span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">inp </span><span class="s0">in </span><span class="s1">inputs</span>
    <span class="s1">]</span>
    <span class="s1">result = rewrite_blockwise(inputs)</span>
    <span class="s1">result2 = (</span>
        <span class="s1">result.output</span><span class="s0">,</span>
        <span class="s2">&quot;&quot;</span><span class="s1">.join(result.output_indices)</span><span class="s0">,</span>
        <span class="s1">result.dsk</span><span class="s0">,</span>
        <span class="s1">[</span>
            <span class="s1">(name</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s1">.join(ind) </span><span class="s0">if </span><span class="s1">ind </span><span class="s0">is not None else </span><span class="s1">ind)</span>
            <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">ind </span><span class="s0">in </span><span class="s1">result.indices</span>
        <span class="s1">]</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">result2 == expected</span>


<span class="s0">def </span><span class="s1">test_index_subs():</span>
    <span class="s0">assert </span><span class="s1">index_subs(tuple(</span><span class="s2">&quot;ij&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s1">: </span><span class="s2">&quot;i&quot;</span><span class="s1">}) == tuple(</span><span class="s2">&quot;ji&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_optimize_blockwise():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = (((x + </span><span class="s3">1</span><span class="s1">) + </span><span class="s3">2</span><span class="s1">) + </span><span class="s3">3</span><span class="s1">) + </span><span class="s3">4</span>

    <span class="s1">dsk = da.optimization.optimize_blockwise(y.dask)</span>

    <span class="s0">assert </span><span class="s1">isinstance(dsk</span><span class="s0">, </span><span class="s1">HighLevelGraph)</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">len([layer </span><span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">dsk.layers.values() </span><span class="s0">if </span><span class="s1">isinstance(layer</span><span class="s0">, </span><span class="s1">Blockwise)])</span>
        <span class="s1">== </span><span class="s3">1</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_optimize_blockwise_control_annotations():</span>
    <span class="s5">&quot;&quot;&quot; 
    Can we fuse blockwise layers with different, but compatible 
    annotations for retries, priority, etc. 
    &quot;&quot;&quot;</span>

    <span class="s1">a = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = a + </span><span class="s3">1</span>

    <span class="s0">with </span><span class="s1">dask.annotate(retries=</span><span class="s3">5</span><span class="s0">, </span><span class="s1">workers=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">allow_other_workers=</span><span class="s0">False</span><span class="s1">):</span>
        <span class="s1">c = b + </span><span class="s3">2</span>

    <span class="s0">with </span><span class="s1">dask.annotate(priority=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">workers=[</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">allow_other_workers=</span><span class="s0">True</span><span class="s1">):</span>
        <span class="s1">d = c + </span><span class="s3">3</span>

    <span class="s0">with </span><span class="s1">dask.annotate(retries=</span><span class="s3">3</span><span class="s0">, </span><span class="s1">resources={</span><span class="s2">&quot;GPU&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;Memory&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}):</span>
        <span class="s1">e = d + </span><span class="s3">4</span>

    <span class="s0">with </span><span class="s1">dask.annotate(priority=</span><span class="s3">4</span><span class="s0">, </span><span class="s1">resources={</span><span class="s2">&quot;GPU&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s0">, </span><span class="s2">&quot;Memory&quot;</span><span class="s1">: </span><span class="s3">4</span><span class="s1">}):</span>
        <span class="s1">f = e + </span><span class="s3">5</span>

    <span class="s4"># This one will not be fused due to the custom annotation, nor will the one below</span>
    <span class="s0">with </span><span class="s1">dask.annotate(foo=</span><span class="s2">&quot;bar&quot;</span><span class="s1">):</span>
        <span class="s1">g = f + </span><span class="s3">6</span>

    <span class="s1">h = g + </span><span class="s3">6</span>

    <span class="s1">dsk = da.optimization.optimize_blockwise(h.dask)</span>

    <span class="s4"># The layers and their annotations should be fusable until the custom one</span>
    <span class="s0">assert </span><span class="s1">len(dsk.layers) == </span><span class="s3">3</span>
    <span class="s1">layer = hlg_layer_topological(dsk</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)  </span><span class="s4"># First layer is the fused one</span>
    <span class="s1">annotations = layer.annotations</span>

    <span class="s0">assert </span><span class="s1">len(annotations) == </span><span class="s3">5</span>
    <span class="s0">assert </span><span class="s1">annotations[</span><span class="s2">&quot;priority&quot;</span><span class="s1">] == </span><span class="s3">4  </span><span class="s4"># max</span>
    <span class="s0">assert </span><span class="s1">annotations[</span><span class="s2">&quot;retries&quot;</span><span class="s1">] == </span><span class="s3">5  </span><span class="s4"># max</span>
    <span class="s0">assert </span><span class="s1">annotations[</span><span class="s2">&quot;allow_other_workers&quot;</span><span class="s1">] </span><span class="s0">is False  </span><span class="s4"># More restrictive</span>
    <span class="s0">assert </span><span class="s1">set(annotations[</span><span class="s2">&quot;workers&quot;</span><span class="s1">]) == {</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">}  </span><span class="s4"># intersection</span>
    <span class="s0">assert </span><span class="s1">annotations[</span><span class="s2">&quot;resources&quot;</span><span class="s1">] == {</span><span class="s2">&quot;GPU&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s0">, </span><span class="s2">&quot;Memory&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}  </span><span class="s4"># Max of resources</span>

    <span class="s4"># If we disable blockwise annotation fusion, we can only fuse the first two layers.</span>
    <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;optimization.annotations.fuse&quot;</span><span class="s1">: </span><span class="s0">False</span><span class="s1">}):</span>
        <span class="s1">dsk = da.optimization.optimize_blockwise(h.dask)</span>
        <span class="s0">assert </span><span class="s1">len(dsk.layers) == </span><span class="s3">7</span>


<span class="s0">def </span><span class="s1">test_optimize_blockwise_custom_annotations():</span>
    <span class="s1">a = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">b = a + </span><span class="s3">1</span>

    <span class="s0">with </span><span class="s1">dask.annotate(qux=</span><span class="s2">&quot;foo&quot;</span><span class="s1">):</span>
        <span class="s1">c = b + </span><span class="s3">2</span>
        <span class="s1">d = c + </span><span class="s3">3</span>

    <span class="s0">with </span><span class="s1">dask.annotate(qux=</span><span class="s2">&quot;baz&quot;</span><span class="s1">):</span>
        <span class="s1">e = d + </span><span class="s3">4</span>
        <span class="s1">f = e + </span><span class="s3">5</span>

    <span class="s1">g = f + </span><span class="s3">6</span>

    <span class="s1">dsk = da.optimization.optimize_blockwise(g.dask)</span>

    <span class="s1">annotations = (</span>
        <span class="s1">layer.annotations</span>
        <span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">dsk.layers.values()</span>
        <span class="s0">if </span><span class="s1">isinstance(layer</span><span class="s0">, </span><span class="s1">Blockwise)</span>
    <span class="s1">)</span>
    <span class="s1">annotations = collections.Counter(</span>
        <span class="s1">tuple(a.items()) </span><span class="s0">if </span><span class="s1">type(a) </span><span class="s0">is </span><span class="s1">dict </span><span class="s0">else </span><span class="s1">a </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">annotations</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">len(annotations) == </span><span class="s3">3</span>
    <span class="s0">assert </span><span class="s1">annotations[</span><span class="s0">None</span><span class="s1">] == </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">annotations[((</span><span class="s2">&quot;qux&quot;</span><span class="s0">, </span><span class="s2">&quot;baz&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)] == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">annotations[((</span><span class="s2">&quot;qux&quot;</span><span class="s0">, </span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)] == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_blockwise_diamond_fusion():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = ((x + </span><span class="s3">1</span><span class="s1">) + </span><span class="s3">2</span><span class="s1">) + </span><span class="s3">3</span>
    <span class="s1">a = y * </span><span class="s3">2</span>
    <span class="s1">b = y * </span><span class="s3">3</span>
    <span class="s1">c = a + b</span>
    <span class="s1">d = ((c + </span><span class="s3">1</span><span class="s1">) + </span><span class="s3">2</span><span class="s1">) + </span><span class="s3">3</span>

    <span class="s1">dsk = da.optimization.optimize_blockwise(d.dask)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dsk</span><span class="s0">, </span><span class="s1">HighLevelGraph)</span>

    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">len([layer </span><span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">dsk.layers.values() </span><span class="s0">if </span><span class="s1">isinstance(layer</span><span class="s0">, </span><span class="s1">Blockwise)])</span>
        <span class="s1">== </span><span class="s3">1</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_blockwise_non_blockwise_output():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = ((x + </span><span class="s3">1</span><span class="s1">) + </span><span class="s3">2</span><span class="s1">) + </span><span class="s3">3</span>
    <span class="s1">w = y.sum()</span>
    <span class="s1">z = ((y * </span><span class="s3">2</span><span class="s1">) * </span><span class="s3">3</span><span class="s1">) * </span><span class="s3">4</span>

    <span class="s1">z_top_before = tuple(z.dask.layers[z.name].indices)</span>
    <span class="s1">(zz</span><span class="s0">,</span><span class="s1">) = dask.optimize(z)</span>
    <span class="s1">z_top_after = tuple(z.dask.layers[z.name].indices)</span>
    <span class="s0">assert </span><span class="s1">z_top_before == z_top_after</span><span class="s0">, </span><span class="s2">&quot;z_top mutated&quot;</span>

    <span class="s1">dsk = optimize_blockwise(z.dask</span><span class="s0">, </span><span class="s1">keys=list(dask.core.flatten(z.__dask_keys__())))</span>
    <span class="s0">assert </span><span class="s1">isinstance(dsk</span><span class="s0">, </span><span class="s1">HighLevelGraph)</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">len([layer </span><span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">dsk.layers.values() </span><span class="s0">if </span><span class="s1">isinstance(layer</span><span class="s0">, </span><span class="s1">Blockwise)])</span>
        <span class="s1">== </span><span class="s3">1</span>
    <span class="s1">)</span>

    <span class="s1">dsk = optimize_blockwise(</span>
        <span class="s1">HighLevelGraph.merge(w.dask</span><span class="s0">, </span><span class="s1">z.dask)</span><span class="s0">,</span>
        <span class="s1">keys=list(dask.core.flatten([w.__dask_keys__()</span><span class="s0">, </span><span class="s1">z.__dask_keys__()]))</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(dsk</span><span class="s0">, </span><span class="s1">HighLevelGraph)</span>
    <span class="s0">assert </span><span class="s1">(</span>
        <span class="s1">len([layer </span><span class="s0">for </span><span class="s1">layer </span><span class="s0">in </span><span class="s1">z.dask.layers.values() </span><span class="s0">if </span><span class="s1">isinstance(layer</span><span class="s0">, </span><span class="s1">Blockwise)])</span>
        <span class="s1">&gt;= </span><span class="s3">1</span>
    <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_top_len():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = x[:</span><span class="s0">, None</span><span class="s1">] * x[</span><span class="s0">None, </span><span class="s1">:]</span>

    <span class="s1">d = y.dask.layers[y.name]</span>
    <span class="s0">assert </span><span class="s1">len(d) == </span><span class="s3">4</span>


<span class="s0">def </span><span class="s1">test_inner_compute():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)) + </span><span class="s3">1 </span><span class="s1">+ </span><span class="s3">2 </span><span class="s1">+ </span><span class="s3">3</span>
    <span class="s1">a = x.sum()</span>
    <span class="s1">y = x * </span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3 </span><span class="s1">* </span><span class="s3">4</span>
    <span class="s1">b = y.sum()</span>
    <span class="s1">z = x * </span><span class="s3">2 </span><span class="s1">* </span><span class="s3">3</span>

    <span class="s1">dask.compute(x</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">z)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;_&quot;</span><span class="s0">, </span><span class="s2">&quot;_0&quot;</span><span class="s0">, </span><span class="s2">&quot;_1&quot;</span><span class="s0">, </span><span class="s2">&quot;.&quot;</span><span class="s0">, </span><span class="s2">&quot;.0&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_common_token_names_args(name):</span>
    <span class="s1">x = np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;bb&quot;</span><span class="s0">, </span><span class="s2">&quot;ccc&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">result = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, None, </span><span class="s1">dtype=object)</span>
    <span class="s1">expected = x + name</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;_0&quot;</span><span class="s0">, </span><span class="s2">&quot;_1&quot;</span><span class="s0">, </span><span class="s2">&quot;.&quot;</span><span class="s0">, </span><span class="s2">&quot;.0&quot;</span><span class="s0">, </span><span class="s2">&quot;_&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_common_token_names_kwargs(name):</span>
    <span class="s1">x = np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;bb&quot;</span><span class="s0">, </span><span class="s2">&quot;ccc&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">d = da.from_array(x</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>

    <span class="s1">result = da.blockwise(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">y=name</span><span class="s0">, </span><span class="s1">dtype=object)</span>
    <span class="s1">expected = x + name</span>

    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_blockwise_names():</span>
    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s0">assert </span><span class="s1">y.name.startswith(</span><span class="s2">&quot;add&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_blockwise_new_axes():</span>
    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">return </span><span class="s1">x[:</span><span class="s0">, None</span><span class="s1">] * np.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;aq&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">return </span><span class="s1">x[</span><span class="s0">None, </span><span class="s1">:] * np.ones((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;qa&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s1">y = x.sum(axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s0">return </span><span class="s1">y[:</span><span class="s0">, None</span><span class="s1">] * np.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>

    <span class="s1">x = da.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;aq&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">5</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)) * </span><span class="s3">6</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_blockwise_new_axes_2():</span>
    <span class="s1">x = da.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">func(x):</span>
        <span class="s0">return </span><span class="s1">np.stack([x</span><span class="s0">, </span><span class="s1">-x]</span><span class="s0">, </span><span class="s1">axis=-</span><span class="s3">1</span><span class="s1">)</span>

    <span class="s1">y = da.blockwise(</span>
        <span class="s1">func</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s2">&quot;sign&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">x</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">dtype=x.dtype</span><span class="s0">,</span>
        <span class="s1">concatenate=</span><span class="s0">True,</span>
        <span class="s1">new_axes={</span><span class="s2">&quot;sign&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s1">}</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">y)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;concatenate&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_blockwise_stacked_new_axes(concatenate):</span>
    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">return </span><span class="s1">x[...</span><span class="s0">, None</span><span class="s1">] * np.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;aq&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">z = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;abq&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;concatenate&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_blockwise_stacked_new_axes_front(concatenate):</span>
    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">if </span><span class="s1">isinstance(x</span><span class="s0">, </span><span class="s1">list):</span>
            <span class="s1">x = np.concatenate(x)</span>
        <span class="s0">return </span><span class="s1">x[</span><span class="s0">None, </span><span class="s1">...] * np.ones(</span><span class="s3">7</span><span class="s1">)[(slice(</span><span class="s0">None</span><span class="s1">)</span><span class="s0">,</span><span class="s1">) + (</span><span class="s0">None,</span><span class="s1">) * x.ndim]</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;qa&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">z = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;qab&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">z.chunks == ((</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">7</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>

    <span class="s1">w = da.blockwise(</span>
        <span class="s0">lambda </span><span class="s1">x: x[:</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span><span class="s0">, </span><span class="s1">concatenate=</span><span class="s0">True</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">w.chunks == ((</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span><span class="s1">)</span>
    <span class="s1">assert_eq(w</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">7</span><span class="s0">,</span><span class="s1">)))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;concatenate&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_blockwise_stacked_new_axes_same_dim(concatenate):</span>
    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">return </span><span class="s1">x[...</span><span class="s0">, None</span><span class="s1">] * np.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">y = da.zeros(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s1">)</span>
    <span class="s1">a = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;aq&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">b = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;aq&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: </span><span class="s3">7</span><span class="s1">}</span><span class="s0">, </span><span class="s1">concatenate=concatenate</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s1">c = a + b</span>
    <span class="s0">assert </span><span class="s1">c.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">7</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">assert_eq(c</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_blockwise_new_axes_chunked():</span>
    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">return </span><span class="s1">x[</span><span class="s0">None, </span><span class="s1">:] * </span><span class="s3">2</span>

    <span class="s1">x = da.arange(</span><span class="s3">0</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">chunks=</span><span class="s3">2</span><span class="s0">, </span><span class="s1">dtype=np.int32)</span>
    <span class="s1">y = da.blockwise(f</span><span class="s0">, </span><span class="s2">&quot;qa&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;q&quot;</span><span class="s1">: (</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.array([[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]]</span><span class="s0">, </span><span class="s1">np.int32))</span>


<span class="s0">def </span><span class="s1">test_blockwise_no_args():</span>
    <span class="s0">def </span><span class="s1">f():</span>
        <span class="s0">return </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32)</span>

    <span class="s1">x = da.blockwise(f</span><span class="s0">, </span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s1">new_axes={</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=np.float32)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32))</span>


<span class="s0">def </span><span class="s1">test_blockwise_no_array_args():</span>
    <span class="s0">def </span><span class="s1">f(dtype):</span>
        <span class="s0">return </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype)</span>

    <span class="s1">x = da.blockwise(</span>
        <span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;ab&quot;</span><span class="s0">, </span><span class="s1">np.float32</span><span class="s0">, None, </span><span class="s1">new_axes={</span><span class="s2">&quot;a&quot;</span><span class="s1">: </span><span class="s3">2</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=np.float32</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">x.chunks == ((</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.float32))</span>


<span class="s0">def </span><span class="s1">test_blockwise_kwargs():</span>
    <span class="s0">def </span><span class="s1">f(a</span><span class="s0">, </span><span class="s1">b=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">a + b</span>

    <span class="s1">x = da.ones(</span><span class="s3">5</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">2</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.blockwise(f</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">b=</span><span class="s3">10</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s3">5</span><span class="s1">) + </span><span class="s3">10</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_blockwise_chunks():</span>
    <span class="s1">x = da.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">double(a</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">):</span>
        <span class="s0">return </span><span class="s1">np.concatenate([a</span><span class="s0">, </span><span class="s1">a]</span><span class="s0">, </span><span class="s1">axis=axis)</span>

    <span class="s1">y = da.blockwise(</span>
        <span class="s1">double</span><span class="s0">,</span>
        <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
        <span class="s1">x</span><span class="s0">,</span>
        <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
        <span class="s1">adjust_chunks={</span><span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">n: </span><span class="s3">2 </span><span class="s1">* n}</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">dtype=x.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">4</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)))</span>

    <span class="s1">y = da.blockwise(</span>
        <span class="s1">double</span><span class="s0">,</span>
        <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
        <span class="s1">x</span><span class="s0">,</span>
        <span class="s2">&quot;ij&quot;</span><span class="s0">,</span>
        <span class="s1">adjust_chunks={</span><span class="s2">&quot;j&quot;</span><span class="s1">: </span><span class="s0">lambda </span><span class="s1">n: </span><span class="s3">2 </span><span class="s1">* n}</span><span class="s0">,</span>
        <span class="s1">axis=</span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">dtype=x.dtype</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">6</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>

    <span class="s1">x = da.ones((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">y = da.blockwise(</span>
        <span class="s1">double</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">adjust_chunks={</span><span class="s2">&quot;i&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>

    <span class="s1">y = da.blockwise(</span>
        <span class="s1">double</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s0">, </span><span class="s1">adjust_chunks={</span><span class="s2">&quot;i&quot;</span><span class="s1">: (</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)}</span><span class="s0">, </span><span class="s1">dtype=x.dtype</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">y.chunks == ((</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s3">5</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">np.ones((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">10</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">test_blockwise_numpy_arg():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = np.arange(</span><span class="s3">1000</span><span class="s1">)</span>

    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span>
    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span>
    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x</span><span class="s0">, </span><span class="s1">y)</span>
    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s1">)</span>
    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x</span><span class="s0">, </span><span class="s3">1.0</span><span class="s1">)</span>
    <span class="s1">x = x.map_blocks(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s1">z: x</span><span class="s0">, </span><span class="s2">&quot;abc&quot;</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_bag_array_conversion():</span>
    <span class="s0">import </span><span class="s1">dask.bag </span><span class="s0">as </span><span class="s1">db</span>

    <span class="s1">b = db.range(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">(x</span><span class="s0">,</span><span class="s1">) = b.map_partitions(np.asarray).to_delayed()</span>
    <span class="s1">(x</span><span class="s0">,</span><span class="s1">) = (da.from_delayed(a</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s3">10</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=int) </span><span class="s0">for </span><span class="s1">a </span><span class="s0">in </span><span class="s1">[x])</span>
    <span class="s1">z = da.concatenate([x])</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">)</span><span class="s0">, </span><span class="s1">check_graph=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_svd():</span>
    <span class="s1">x = da.ones((</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>
    <span class="s1">y = x * </span><span class="s3">2</span>
    <span class="s1">u</span><span class="s0">, </span><span class="s1">s</span><span class="s0">, </span><span class="s1">v = da.linalg.svd(y)</span>
    <span class="s1">z = y + u</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">z)</span>


<span class="s0">def </span><span class="s1">test_args_delayed():</span>
    <span class="s1">x = da.arange(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = dask.delayed(</span><span class="s0">lambda</span><span class="s1">: </span><span class="s3">100</span><span class="s1">)()</span>

    <span class="s1">z = da.blockwise(add</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, None, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">100</span><span class="s1">)</span>

    <span class="s1">z = da.blockwise(</span><span class="s0">lambda </span><span class="s1">x</span><span class="s0">, </span><span class="s1">y: x + y</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">y=y</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(z</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">10</span><span class="s1">) + </span><span class="s3">100</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;tup&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">collections.namedtuple(</span><span class="s2">&quot;foo&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">])(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]  </span><span class="s4"># type: ignore</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_namedtuple(tup):</span>
    <span class="s1">A = da.random.default_rng().random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">f(data</span><span class="s0">, </span><span class="s1">x):</span>
        <span class="s0">return </span><span class="s1">data</span>

    <span class="s1">B = da.blockwise(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d1&quot;</span><span class="s0">, </span><span class="s2">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d1&quot;</span><span class="s0">, </span><span class="s2">&quot;d2&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">x=tup</span><span class="s0">, </span><span class="s1">dtype=A.dtype)</span>

    <span class="s1">assert_eq(A</span><span class="s0">, </span><span class="s1">B)</span>


<span class="s0">def </span><span class="s1">test_validate_top_inputs():</span>
    <span class="s1">A = da.random.default_rng().random((</span><span class="s3">20</span><span class="s0">, </span><span class="s3">20</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">10</span><span class="s1">))</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">da.blockwise(inc</span><span class="s0">, </span><span class="s2">&quot;jk&quot;</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">dtype=A.dtype)</span>

    <span class="s0">assert </span><span class="s2">&quot;unknown dimension&quot; </span><span class="s0">in </span><span class="s1">str(info.value).lower()</span>
    <span class="s0">assert </span><span class="s2">&quot;k&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>
    <span class="s0">assert </span><span class="s2">&quot;j&quot; </span><span class="s0">not in </span><span class="s1">str(info.value)</span>

    <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">info:</span>
        <span class="s1">da.blockwise(inc</span><span class="s0">, </span><span class="s2">&quot;ii&quot;</span><span class="s0">, </span><span class="s1">A</span><span class="s0">, </span><span class="s2">&quot;ij&quot;</span><span class="s0">, </span><span class="s1">dtype=A.dtype)</span>

    <span class="s0">assert </span><span class="s2">&quot;repeated&quot; </span><span class="s0">in </span><span class="s1">str(info.value).lower()</span>
    <span class="s0">assert </span><span class="s2">&quot;i&quot; </span><span class="s0">in </span><span class="s1">str(info.value)</span>


<span class="s0">def </span><span class="s1">test_dont_merge_before_reductions():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">y = da.blockwise(inc</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">z = da.blockwise(sum</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">y</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=y.dtype)</span>
    <span class="s1">w = da.blockwise(sum</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">z</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s1">dtype=y.dtype)</span>

    <span class="s1">dsk = optimize_blockwise(w.dask)</span>

    <span class="s0">assert </span><span class="s1">len([d </span><span class="s0">for </span><span class="s1">d </span><span class="s0">in </span><span class="s1">dsk.layers.values() </span><span class="s0">if </span><span class="s1">isinstance(d</span><span class="s0">, </span><span class="s1">Blockwise)]) == </span><span class="s3">2</span>

    <span class="s1">z.compute()</span>


<span class="s0">def </span><span class="s1">test_atop_legacy():</span>
    <span class="s1">x = da.ones(</span><span class="s3">10</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">5</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s0">with </span><span class="s1">pytest.warns(</span>
        <span class="s1">UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;The da.atop function has moved to da.blockwise&quot;</span>
    <span class="s1">):</span>
        <span class="s1">y = da.atop(inc</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">z = da.blockwise(inc</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">x</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s0">, </span><span class="s1">dtype=x.dtype)</span>
    <span class="s1">assert_eq(y</span><span class="s0">, </span><span class="s1">z)</span>
    <span class="s0">assert </span><span class="s1">y.name == z.name</span>


<span class="s0">def </span><span class="s1">test_non_hlg():</span>
    <span class="s4"># Regression test for https://github.com/dask/dask/issues/5850</span>
    <span class="s1">a = da.from_array(np.ones(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">a.dask = dict(a.dask)  </span><span class="s4"># Convert from HighLevelGraph to plain dict</span>
    <span class="s1">b = da.from_array(np.zeros(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">np.float64)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">,</span><span class="s1">))</span>
    <span class="s1">x = a + b</span>
    <span class="s1">assert_eq(x</span><span class="s0">, </span><span class="s1">a)</span>
</pre>
</body>
</html>