<html>
<head>
<title>test_csv.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
.s5 { color: #a5c261;}
.s6 { color: #629755; font-style: italic;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_csv.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">gzip</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">warnings</span>
<span class="s0">from </span><span class="s1">io </span><span class="s0">import </span><span class="s1">BytesIO</span><span class="s0">, </span><span class="s1">StringIO</span>
<span class="s0">from </span><span class="s1">unittest </span><span class="s0">import </span><span class="s1">mock</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s1">pd = pytest.importorskip(</span><span class="s2">&quot;pandas&quot;</span><span class="s1">)</span>
<span class="s1">dd = pytest.importorskip(</span><span class="s2">&quot;dask.dataframe&quot;</span><span class="s1">)</span>

<span class="s0">import </span><span class="s1">fsspec</span>
<span class="s0">from </span><span class="s1">fsspec.compression </span><span class="s0">import </span><span class="s1">compr</span>
<span class="s0">from </span><span class="s1">packaging.version </span><span class="s0">import </span><span class="s1">Version</span>
<span class="s0">from </span><span class="s1">tlz </span><span class="s0">import </span><span class="s1">partition_all</span><span class="s0">, </span><span class="s1">valmap</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">from </span><span class="s1">dask.base </span><span class="s0">import </span><span class="s1">compute_as_if_collection</span>
<span class="s0">from </span><span class="s1">dask.bytes.core </span><span class="s0">import </span><span class="s1">read_bytes</span>
<span class="s0">from </span><span class="s1">dask.bytes.utils </span><span class="s0">import </span><span class="s1">compress</span>
<span class="s0">from </span><span class="s1">dask.core </span><span class="s0">import </span><span class="s1">flatten</span>
<span class="s0">from </span><span class="s1">dask.dataframe._compat </span><span class="s0">import </span><span class="s1">PANDAS_GE_140</span><span class="s0">, </span><span class="s1">PANDAS_GE_200</span><span class="s0">, </span><span class="s1">tm</span>
<span class="s0">from </span><span class="s1">dask.dataframe.io.csv </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">_infer_block_size</span><span class="s0">,</span>
    <span class="s1">auto_blocksize</span><span class="s0">,</span>
    <span class="s1">block_mask</span><span class="s0">,</span>
    <span class="s1">pandas_read_text</span><span class="s0">,</span>
    <span class="s1">text_blocks_to_pandas</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.dataframe.optimize </span><span class="s0">import </span><span class="s1">optimize_dataframe_getitem</span>
<span class="s0">from </span><span class="s1">dask.dataframe.utils </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">assert_eq</span><span class="s0">,</span>
    <span class="s1">get_string_dtype</span><span class="s0">,</span>
    <span class="s1">has_known_categories</span><span class="s0">,</span>
    <span class="s1">pyarrow_strings_enabled</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">from </span><span class="s1">dask.layers </span><span class="s0">import </span><span class="s1">DataFrameIOLayer</span>
<span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">filetext</span><span class="s0">, </span><span class="s1">filetexts</span><span class="s0">, </span><span class="s1">tmpdir</span><span class="s0">, </span><span class="s1">tmpfile</span>
<span class="s0">from </span><span class="s1">dask.utils_test </span><span class="s0">import </span><span class="s1">hlg_layer</span>

<span class="s3"># List of available compression format for test_read_csv_compression</span>
<span class="s1">compression_fmts = [fmt </span><span class="s0">for </span><span class="s1">fmt </span><span class="s0">in </span><span class="s1">compr] + [</span><span class="s0">None</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">normalize_text(s):</span>
    <span class="s0">return </span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">.join(map(str.strip</span><span class="s0">, </span><span class="s1">s.strip().split(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)))</span>


<span class="s0">def </span><span class="s1">parse_filename(path):</span>
    <span class="s0">return </span><span class="s1">os.path.split(path)[</span><span class="s4">1</span><span class="s1">]</span>


<span class="s1">csv_text = </span><span class="s2">&quot;&quot;&quot; 
name,amount 
Alice,100 
Bob,-200 
Charlie,300 
Dennis,400 
Edith,-500 
Frank,600 
Alice,200 
Frank,-200 
Bob,600 
Alice,400 
Frank,200 
Alice,300 
Edith,600 
&quot;&quot;&quot;</span><span class="s1">.strip()</span>

<span class="s1">tsv_text = csv_text.replace(</span><span class="s2">&quot;,&quot;</span><span class="s0">, </span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">)</span>

<span class="s1">tsv_text2 = </span><span class="s2">&quot;&quot;&quot; 
name   amount 
Alice    100 
Bob     -200 
Charlie  300 
Dennis   400 
Edith   -500 
Frank    600 
Alice    200 
Frank   -200 
Bob      600 
Alice    400 
Frank    200 
Alice    300 
Edith    600 
&quot;&quot;&quot;</span><span class="s1">.strip()</span>

<span class="s1">timeseries = </span><span class="s2">&quot;&quot;&quot; 
Date,Open,High,Low,Close,Volume,Adj Close 
2015-08-28,198.50,199.839996,197.919998,199.240005,143298900,199.240005 
2015-08-27,197.020004,199.419998,195.210007,199.160004,266244700,199.160004 
2015-08-26,192.080002,194.789993,188.369995,194.679993,328058100,194.679993 
2015-08-25,195.429993,195.449997,186.919998,187.229996,353966700,187.229996 
2015-08-24,197.630005,197.630005,182.399994,189.550003,478672400,189.550003 
2015-08-21,201.729996,203.940002,197.520004,197.630005,328271500,197.630005 
2015-08-20,206.509995,208.289993,203.899994,204.009995,185865600,204.009995 
2015-08-19,209.089996,210.009995,207.350006,208.279999,167316300,208.279999 
2015-08-18,210.259995,210.679993,209.699997,209.929993,70043800,209.929993 
&quot;&quot;&quot;</span><span class="s1">.strip()</span>

<span class="s1">csv_files = {</span>
    <span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">: (</span>
        <span class="s5">b&quot;name,amount,id</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Alice,100,1</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Bob,200,2</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Charlie,300,3</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s2">&quot;2014-01-02.csv&quot;</span><span class="s1">: </span><span class="s5">b&quot;name,amount,id</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;2014-01-03.csv&quot;</span><span class="s1">: (</span>
        <span class="s5">b&quot;name,amount,id</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Dennis,400,4</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Edith,500,5</span><span class="s0">\n</span><span class="s5">&quot; b&quot;Frank,600,6</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">}</span>

<span class="s1">tsv_files = {k: v.replace(</span><span class="s5">b&quot;,&quot;</span><span class="s0">, </span><span class="s5">b&quot;</span><span class="s0">\t</span><span class="s5">&quot;</span><span class="s1">) </span><span class="s0">for </span><span class="s1">(k</span><span class="s0">, </span><span class="s1">v) </span><span class="s0">in </span><span class="s1">csv_files.items()}</span>

<span class="s1">fwf_files = {</span>
    <span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">: (</span>
        <span class="s5">b&quot;    name  amount  id</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot;   Alice     100   1</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot;     Bob     200   2</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot; Charlie     300   3</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">)</span><span class="s0">,</span>
    <span class="s2">&quot;2014-01-02.csv&quot;</span><span class="s1">: </span><span class="s5">b&quot;    name  amount  id</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">,</span>
    <span class="s2">&quot;2014-01-03.csv&quot;</span><span class="s1">: (</span>
        <span class="s5">b&quot;    name  amount  id</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot;  Dennis     400   4</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot;   Edith     500   5</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s5">b&quot;   Frank     600   6</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">)</span><span class="s0">,</span>
<span class="s1">}</span>


<span class="s0">def </span><span class="s1">read_files(file_names=csv_files):</span>
    <span class="s1">df = pd.concat([pd.read_csv(BytesIO(csv_files[k])) </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted(file_names)])</span>
    <span class="s1">df = df.astype({</span><span class="s2">&quot;name&quot;</span><span class="s1">: get_string_dtype()</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">: int})</span>
    <span class="s0">return </span><span class="s1">df</span>


<span class="s0">def </span><span class="s1">read_files_with(file_names</span><span class="s0">, </span><span class="s1">handler</span><span class="s0">, </span><span class="s1">**kwargs):</span>
    <span class="s1">df = pd.concat([handler(n</span><span class="s0">, </span><span class="s1">**kwargs) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">sorted(file_names)])</span>
    <span class="s1">df = df.astype({</span><span class="s2">&quot;name&quot;</span><span class="s1">: get_string_dtype()</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">: int</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">: int})</span>
    <span class="s0">return </span><span class="s1">df</span>


<span class="s1">comment_header = </span><span class="s5">b&quot;&quot;&quot;# some header lines 
# that may be present 
# in a data file 
# before any data&quot;&quot;&quot;</span>

<span class="s1">comment_footer = </span><span class="s5">b&quot;&quot;&quot;# some footer lines 
# that may be present 
# at the end of the file&quot;&quot;&quot;</span>

<span class="s1">csv_units_row = </span><span class="s5">b&quot;str, int, int</span><span class="s0">\n</span><span class="s5">&quot;</span>
<span class="s1">tsv_units_row = csv_units_row.replace(</span><span class="s5">b&quot;,&quot;</span><span class="s0">, </span><span class="s5">b&quot;</span><span class="s0">\t</span><span class="s5">&quot;</span><span class="s1">)</span>


<span class="s1">csv_and_table = pytest.mark.parametrize(</span>
    <span class="s2">&quot;reader,files&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">,</span>
        <span class="s1">(pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)</span><span class="s0">,</span>
        <span class="s1">(pd.read_fwf</span><span class="s0">, </span><span class="s1">fwf_files)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_pandas_read_text(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">b = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span>
    <span class="s1">df = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s1">{})</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">len(df) == </span><span class="s4">3</span>
    <span class="s0">assert </span><span class="s1">df.id.sum() == </span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">3</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_pandas_read_text_kwargs(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">b = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span>
    <span class="s1">df = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;usecols&quot;</span><span class="s1">: [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]})</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_pandas_read_text_dtype_coercion(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">b = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span>
    <span class="s1">df = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s1">{}</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;amount&quot;</span><span class="s1">: </span><span class="s2">&quot;float&quot;</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">df.amount.dtype == </span><span class="s2">&quot;float&quot;</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_pandas_read_text_with_header(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">b = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span>
    <span class="s1">header</span><span class="s0">, </span><span class="s1">b = b.split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">header = header + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">df = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">{})</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">len(df) == </span><span class="s4">3</span>
    <span class="s0">assert </span><span class="s1">df.id.sum() == </span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">3</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_text_blocks_to_pandas_simple(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">blocks = [[files[k]] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted(files)]</span>
    <span class="s1">kwargs = {}</span>
    <span class="s1">head = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s1">{})</span>
    <span class="s1">header = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">].split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>

    <span class="s1">df = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">head</span><span class="s0">, </span><span class="s1">kwargs)</span>
    <span class="s0">assert </span><span class="s1">isinstance(df</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>

    <span class="s1">values = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">head</span><span class="s0">, </span><span class="s1">kwargs)</span>
    <span class="s0">assert </span><span class="s1">isinstance(values</span><span class="s0">, </span><span class="s1">dd.DataFrame)</span>
    <span class="s0">assert </span><span class="s1">hasattr(values</span><span class="s0">, </span><span class="s2">&quot;dask&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">len(values.dask) == </span><span class="s4">6 </span><span class="s0">if </span><span class="s1">pyarrow_strings_enabled() </span><span class="s0">else </span><span class="s4">3</span>

    <span class="s1">assert_eq(df.amount.sum()</span><span class="s0">, </span><span class="s4">100 </span><span class="s1">+ </span><span class="s4">200 </span><span class="s1">+ </span><span class="s4">300 </span><span class="s1">+ </span><span class="s4">400 </span><span class="s1">+ </span><span class="s4">500 </span><span class="s1">+ </span><span class="s4">600</span><span class="s1">)</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_text_blocks_to_pandas_kwargs(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">blocks = [files[k] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted(files)]</span>
    <span class="s1">blocks = [[b] </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">blocks]</span>
    <span class="s1">kwargs = {</span><span class="s2">&quot;usecols&quot;</span><span class="s1">: [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]}</span>
    <span class="s1">head = pandas_read_text(reader</span><span class="s0">, </span><span class="s1">files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s5">b&quot;&quot;</span><span class="s0">, </span><span class="s1">kwargs)</span>
    <span class="s1">header = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">].split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>

    <span class="s1">df = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">head</span><span class="s0">, </span><span class="s1">kwargs)</span>
    <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>
    <span class="s1">result = df.compute()</span>
    <span class="s0">assert </span><span class="s1">(result.columns == df.columns).all()</span>


<span class="s1">@csv_and_table</span>
<span class="s0">def </span><span class="s1">test_text_blocks_to_pandas_blocked(reader</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">expected = read_files()</span>
    <span class="s1">header = files[</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">].split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">blocks = []</span>
    <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">sorted(files):</span>
        <span class="s1">b = files[k]</span>
        <span class="s1">lines = b.split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)</span>
        <span class="s1">blocks.append([</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">.join(bs) </span><span class="s0">for </span><span class="s1">bs </span><span class="s0">in </span><span class="s1">partition_all(</span><span class="s4">2</span><span class="s0">, </span><span class="s1">lines)])</span>

    <span class="s1">df = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">expected.head()</span><span class="s0">, </span><span class="s1">{})</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">df.compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">check_dtype=</span><span class="s0">False,</span>
    <span class="s1">)</span>

    <span class="s1">expected2 = expected[[</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]]</span>
    <span class="s1">df = text_blocks_to_pandas(</span>
        <span class="s1">reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">expected2.head()</span><span class="s0">, </span><span class="s1">{</span><span class="s2">&quot;usecols&quot;</span><span class="s1">: [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]}</span>
    <span class="s1">)</span>
    <span class="s1">assert_eq(</span>
        <span class="s1">df.compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">expected2.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">check_dtype=</span><span class="s0">False,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files&quot;</span><span class="s0">,</span>
    <span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_skiprows(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">files = {name: comment_header + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s1">+ content </span><span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files.items()}</span>
    <span class="s1">skip = len(comment_header.splitlines())</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">skiprows=skip)</span>
        <span class="s1">expected_df = read_files_with(files</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">skiprows=skip)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected_df</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files&quot;</span><span class="s0">,</span>
    <span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_comment(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">files = {</span>
        <span class="s1">name: comment_header</span>
        <span class="s1">+ </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>
        <span class="s1">+ content.replace(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;# just some comment</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files.items()</span>
    <span class="s1">}</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">comment=</span><span class="s2">&quot;#&quot;</span><span class="s1">)</span>
        <span class="s1">expected_df = read_files_with(files</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">comment=</span><span class="s2">&quot;#&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected_df</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files&quot;</span><span class="s0">,</span>
    <span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_skipfooter(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">files = {name: content + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s1">+ comment_footer </span><span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files.items()}</span>
    <span class="s1">skip = len(comment_footer.splitlines())</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">skipfooter=skip</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>
        <span class="s1">expected_df = read_files_with(files</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">skipfooter=skip</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected_df</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files,units&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files</span><span class="s0">, </span><span class="s1">csv_units_row)</span><span class="s0">,</span>
        <span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files</span><span class="s0">, </span><span class="s1">tsv_units_row)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_skiprows_as_list(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files</span><span class="s0">, </span><span class="s1">units):</span>
    <span class="s1">files = {</span>
        <span class="s1">name: (comment_header + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s1">+ content.replace(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s1">+ units</span><span class="s0">, </span><span class="s4">1</span><span class="s1">))</span>
        <span class="s0">for </span><span class="s1">name</span><span class="s0">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">files.items()</span>
    <span class="s1">}</span>
    <span class="s1">skip = [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">5</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">skiprows=skip)</span>
        <span class="s1">expected_df = read_files_with(files</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">skiprows=skip)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected_df</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">csv_blocks = [</span>
    <span class="s1">[</span><span class="s5">b&quot;aa,bb</span><span class="s0">\n</span><span class="s5">1,1.0</span><span class="s0">\n</span><span class="s5">2,2.0&quot;</span><span class="s0">, </span><span class="s5">b&quot;10,20</span><span class="s0">\n</span><span class="s5">30,40&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s5">b&quot;aa,bb</span><span class="s0">\n</span><span class="s5">1,1.0</span><span class="s0">\n</span><span class="s5">2,2.0&quot;</span><span class="s0">, </span><span class="s5">b&quot;10,20</span><span class="s0">\n</span><span class="s5">30,40&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">]</span>

<span class="s1">tsv_blocks = [</span>
    <span class="s1">[</span><span class="s5">b&quot;aa</span><span class="s0">\t</span><span class="s5">bb</span><span class="s0">\n</span><span class="s5">1</span><span class="s0">\t</span><span class="s5">1.0</span><span class="s0">\n</span><span class="s5">2</span><span class="s0">\t</span><span class="s5">2.0&quot;</span><span class="s0">, </span><span class="s5">b&quot;10</span><span class="s0">\t</span><span class="s5">20</span><span class="s0">\n</span><span class="s5">30</span><span class="s0">\t</span><span class="s5">40&quot;</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s5">b&quot;aa</span><span class="s0">\t</span><span class="s5">bb</span><span class="s0">\n</span><span class="s5">1</span><span class="s0">\t</span><span class="s5">1.0</span><span class="s0">\n</span><span class="s5">2</span><span class="s0">\t</span><span class="s5">2.0&quot;</span><span class="s0">, </span><span class="s5">b&quot;10</span><span class="s0">\t</span><span class="s5">20</span><span class="s0">\n</span><span class="s5">30</span><span class="s0">\t</span><span class="s5">40&quot;</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">]</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;reader,blocks&quot;</span><span class="s0">, </span><span class="s1">[(pd.read_csv</span><span class="s0">, </span><span class="s1">csv_blocks)</span><span class="s0">, </span><span class="s1">(pd.read_table</span><span class="s0">, </span><span class="s1">tsv_blocks)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_enforce_dtypes(reader</span><span class="s0">, </span><span class="s1">blocks):</span>
    <span class="s1">head = reader(BytesIO(blocks[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">header = blocks[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s1">dfs = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">head</span><span class="s0">, </span><span class="s1">{})</span>
    <span class="s1">dfs = dask.compute(dfs</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">all(df.dtypes.to_dict() == head.dtypes.to_dict() </span><span class="s0">for </span><span class="s1">df </span><span class="s0">in </span><span class="s1">dfs)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;reader,blocks&quot;</span><span class="s0">, </span><span class="s1">[(pd.read_csv</span><span class="s0">, </span><span class="s1">csv_blocks)</span><span class="s0">, </span><span class="s1">(pd.read_table</span><span class="s0">, </span><span class="s1">tsv_blocks)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_enforce_columns(reader</span><span class="s0">, </span><span class="s1">blocks):</span>
    <span class="s3"># Replace second header with different column name</span>
    <span class="s1">blocks = [blocks[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[blocks[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].replace(</span><span class="s5">b&quot;a&quot;</span><span class="s0">, </span><span class="s5">b&quot;A&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">blocks[</span><span class="s4">1</span><span class="s1">][</span><span class="s4">1</span><span class="s1">]]]</span>
    <span class="s1">head = reader(BytesIO(blocks[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">])</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s1">)</span>
    <span class="s1">header = blocks[</span><span class="s4">0</span><span class="s1">][</span><span class="s4">0</span><span class="s1">].split(</span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">)[</span><span class="s4">0</span><span class="s1">] + </span><span class="s5">b&quot;</span><span class="s0">\n</span><span class="s5">&quot;</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
        <span class="s1">dfs = text_blocks_to_pandas(reader</span><span class="s0">, </span><span class="s1">blocks</span><span class="s0">, </span><span class="s1">header</span><span class="s0">, </span><span class="s1">head</span><span class="s0">, </span><span class="s1">{}</span><span class="s0">, </span><span class="s1">enforce=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">dask.compute(*dfs</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>


<span class="s3">#############################</span>
<span class="s3">#  read_csv and read_table  #</span>
<span class="s3">#############################</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,text,sep&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_text</span><span class="s0">, </span><span class="s2">&quot;,&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_text</span><span class="s0">, </span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_text2</span><span class="s0">, </span><span class="s2">r&quot;\s+&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">text</span><span class="s0">, </span><span class="s1">sep):</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">f = dd_read(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">lineterminator=os.linesep</span><span class="s0">, </span><span class="s1">sep=sep)</span>
        <span class="s0">assert </span><span class="s1">list(f.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">]</span>
        <span class="s3"># index may be different</span>
        <span class="s1">result = f.compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">pd_read(fn</span><span class="s0">, </span><span class="s1">sep=sep))</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s0">not </span><span class="s1">PANDAS_GE_200</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;dataframe.convert-string requires pandas&gt;=2.0&quot;</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_convert_string_config():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;pyarrow&quot;</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;Requires pyarrow strings&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = pd.read_csv(fn)</span>
        <span class="s0">with </span><span class="s1">dask.config.set({</span><span class="s2">&quot;dataframe.convert-string&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}):</span>
            <span class="s1">ddf = dd.read_csv(fn)</span>
        <span class="s1">df_pyarrow = df.astype({</span><span class="s2">&quot;name&quot;</span><span class="s1">: </span><span class="s2">&quot;string[pyarrow]&quot;</span><span class="s1">})</span>
        <span class="s1">assert_eq(df_pyarrow</span><span class="s0">, </span><span class="s1">ddf</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,text,skip&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_text</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_text</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">13</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_large_skiprows(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">text</span><span class="s0">, </span><span class="s1">skip):</span>
    <span class="s1">names = [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">actual = dd_read(fn</span><span class="s0">, </span><span class="s1">skiprows=skip</span><span class="s0">, </span><span class="s1">names=names)</span>
        <span class="s1">assert_eq(actual</span><span class="s0">, </span><span class="s1">pd_read(fn</span><span class="s0">, </span><span class="s1">skiprows=skip</span><span class="s0">, </span><span class="s1">names=names))</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,text,skip&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_text</span><span class="s0">, </span><span class="s4">7</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_text</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">12</span><span class="s1">])</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_skiprows_only_in_first_partition(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">text</span><span class="s0">, </span><span class="s1">skip):</span>
    <span class="s1">names = [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;sample=blocksize&quot;</span><span class="s1">):</span>
            <span class="s1">actual = dd_read(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">200</span><span class="s0">, </span><span class="s1">skiprows=skip</span><span class="s0">, </span><span class="s1">names=names).compute()</span>
            <span class="s1">assert_eq(actual</span><span class="s0">, </span><span class="s1">pd_read(fn</span><span class="s0">, </span><span class="s1">skiprows=skip</span><span class="s0">, </span><span class="s1">names=names))</span>

        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
            <span class="s3"># if new sample does not contain all the skiprows, raise error</span>
            <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
                <span class="s1">dd_read(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">skiprows=skip</span><span class="s0">, </span><span class="s1">names=names)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files&quot;</span><span class="s0">,</span>
    <span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_files(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s1">expected = read_files()</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">fn = </span><span class="s2">&quot;2014-01-01.csv&quot;</span>
        <span class="s1">df = dd_read(fn)</span>
        <span class="s1">expected2 = pd_read(BytesIO(files[fn]))</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected2</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,pd_read,files&quot;</span><span class="s0">,</span>
    <span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">pd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">pd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_files_list(dd_read</span><span class="s0">, </span><span class="s1">pd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">subset = sorted(files)[:</span><span class="s4">2</span><span class="s1">]  </span><span class="s3"># Just first 2</span>
        <span class="s1">sol = read_files(subset)</span>
        <span class="s1">res = dd_read(subset)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">sol</span><span class="s0">, </span><span class="s1">check_dtype=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">dd_read([])</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,files&quot;</span><span class="s0">, </span><span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_include_path_column(dd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span>
            <span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">,</span>
            <span class="s1">include_path_column=</span><span class="s0">True,</span>
            <span class="s1">converters={</span><span class="s2">&quot;path&quot;</span><span class="s1">: parse_filename}</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">filenames = df.path.compute().unique()</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-01.csv&quot; </span><span class="s0">in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-02.csv&quot; </span><span class="s0">not in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-03.csv&quot; </span><span class="s0">in </span><span class="s1">filenames</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,files&quot;</span><span class="s0">, </span><span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_include_path_column_as_str(dd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span>
            <span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">,</span>
            <span class="s1">include_path_column=</span><span class="s2">&quot;filename&quot;</span><span class="s0">,</span>
            <span class="s1">converters={</span><span class="s2">&quot;filename&quot;</span><span class="s1">: parse_filename}</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">filenames = df.filename.compute().unique()</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-01.csv&quot; </span><span class="s0">in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-02.csv&quot; </span><span class="s0">not in </span><span class="s1">filenames</span>
        <span class="s0">assert </span><span class="s2">&quot;2014-01-03.csv&quot; </span><span class="s0">in </span><span class="s1">filenames</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,files&quot;</span><span class="s0">, </span><span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_include_path_column_with_duplicate_name(dd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s2">&quot;name&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,files&quot;</span><span class="s0">, </span><span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_include_path_column_is_dtype_category(dd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.path.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert </span><span class="s1">has_known_categories(df.path)</span>

        <span class="s1">dfs = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = dfs.compute()</span>
        <span class="s0">assert </span><span class="s1">result.path.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert </span><span class="s1">has_known_categories(result.path)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;dd_read,files&quot;</span><span class="s0">, </span><span class="s1">[(dd.read_csv</span><span class="s0">, </span><span class="s1">csv_files)</span><span class="s0">, </span><span class="s1">(dd.read_table</span><span class="s0">, </span><span class="s1">tsv_files)]</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_include_path_column_with_multiple_partitions_per_file(dd_read</span><span class="s0">, </span><span class="s1">files):</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">df = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;10B&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.npartitions &gt; </span><span class="s4">3</span>
        <span class="s0">assert </span><span class="s1">df.path.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert </span><span class="s1">has_known_categories(df.path)</span>

        <span class="s1">dfs = dd_read(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;10B&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = dfs.compute()</span>
        <span class="s0">assert </span><span class="s1">result.path.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert </span><span class="s1">has_known_categories(result.path)</span>


<span class="s3"># After this point, we test just using read_csv, as all functionality</span>
<span class="s3"># for both is implemented using the same code.</span>


<span class="s0">def </span><span class="s1">test_read_csv_index():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">f = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">20</span><span class="s1">).set_index(</span><span class="s2">&quot;amount&quot;</span><span class="s1">)</span>
        <span class="s1">result = f.compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.index.name == </span><span class="s2">&quot;amount&quot;</span>

        <span class="s1">blocks = compute_as_if_collection(</span>
            <span class="s1">dd.DataFrame</span><span class="s0">, </span><span class="s1">f.dask</span><span class="s0">, </span><span class="s1">f.__dask_keys__()</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;sync&quot;</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">block </span><span class="s0">in </span><span class="s1">enumerate(blocks):</span>
            <span class="s0">if </span><span class="s1">i &lt; len(f.divisions) - </span><span class="s4">2</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">(block.index &lt; f.divisions[i + </span><span class="s4">1</span><span class="s1">]).all()</span>
            <span class="s0">if </span><span class="s1">i &gt; </span><span class="s4">0</span><span class="s1">:</span>
                <span class="s0">assert </span><span class="s1">(block.index &gt;= f.divisions[i]).all()</span>

        <span class="s1">expected = pd.read_csv(fn).set_index(</span><span class="s2">&quot;amount&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_read_csv_skiprows_range():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">f = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">skiprows=range(</span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">result = f</span>
        <span class="s1">expected = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">skiprows=range(</span><span class="s4">5</span><span class="s1">))</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_usecols():</span>
    <span class="s0">with </span><span class="s1">filetext(timeseries) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s2">&quot;High&quot;</span><span class="s0">, </span><span class="s2">&quot;Low&quot;</span><span class="s1">])</span>
        <span class="s1">df_select = df[[</span><span class="s2">&quot;High&quot;</span><span class="s1">]]</span>
        <span class="s1">expected = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s2">&quot;High&quot;</span><span class="s0">, </span><span class="s2">&quot;Low&quot;</span><span class="s1">])</span>
        <span class="s1">expected_select = expected[[</span><span class="s2">&quot;High&quot;</span><span class="s1">]]</span>
        <span class="s0">assert </span><span class="s1">(df.compute().values == expected.values).all()</span>
        <span class="s0">assert </span><span class="s1">(df_select.compute().values == expected_select.values).all()</span>


<span class="s0">def </span><span class="s1">test_string_blocksize():</span>
    <span class="s0">with </span><span class="s1">filetext(timeseries) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;30B&quot;</span><span class="s1">)</span>
        <span class="s1">b = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;30&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a.npartitions == b.npartitions</span>

        <span class="s1">c = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;64MiB&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">c.npartitions == </span><span class="s4">1</span>


<span class="s0">def </span><span class="s1">test_skipinitialspace():</span>
    <span class="s1">text = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    name, amount 
    Alice,100 
    Bob,-200 
    Charlie,300 
    Dennis,400 
    Edith,-500 
    Frank,600 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">skipinitialspace=</span><span class="s0">True, </span><span class="s1">blocksize=</span><span class="s4">20</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s2">&quot;amount&quot; </span><span class="s0">in </span><span class="s1">df.columns</span>
        <span class="s0">assert </span><span class="s1">df.amount.max().compute() == </span><span class="s4">600</span>


<span class="s0">def </span><span class="s1">test_consistent_dtypes():</span>
    <span class="s1">text = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    name,amount 
    Alice,100.5 
    Bob,-200.5 
    Charlie,300 
    Dennis,400 
    Edith,-500 
    Frank,600 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.amount.compute().dtype == float</span>


<span class="s0">def </span><span class="s1">test_consistent_dtypes_2():</span>
    <span class="s1">text1 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    name,amount 
    Alice,100 
    Bob,-200 
    Charlie,300 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s1">text2 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    name,amount 
    1,400 
    2,-500 
    Frank,600 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>
    <span class="s1">string_dtype = get_string_dtype()</span>
    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;foo.1.csv&quot;</span><span class="s1">: text1</span><span class="s0">, </span><span class="s2">&quot;foo.2.csv&quot;</span><span class="s1">: text2}):</span>
        <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">25</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.name.dtype == string_dtype</span>
        <span class="s0">assert </span><span class="s1">df.name.compute().dtype == string_dtype</span>


<span class="s0">def </span><span class="s1">test_categorical_dtypes():</span>
    <span class="s1">text1 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    fruit,count 
    apple,10 
    apple,25 
    pear,100 
    orange,15 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s1">text2 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    fruit,count 
    apple,200 
    banana,300 
    orange,400 
    banana,10 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;foo.1.csv&quot;</span><span class="s1">: text1</span><span class="s0">, </span><span class="s2">&quot;foo.2.csv&quot;</span><span class="s1">: text2}):</span>
        <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;fruit&quot;</span><span class="s1">: </span><span class="s2">&quot;category&quot;</span><span class="s1">}</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">25</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.fruit.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert not </span><span class="s1">has_known_categories(df.fruit)</span>
        <span class="s1">res = df.compute()</span>
        <span class="s0">assert </span><span class="s1">res.fruit.dtype == </span><span class="s2">&quot;category&quot;</span>
        <span class="s0">assert </span><span class="s1">sorted(res.fruit.cat.categories) == [</span><span class="s2">&quot;apple&quot;</span><span class="s0">, </span><span class="s2">&quot;banana&quot;</span><span class="s0">, </span><span class="s2">&quot;orange&quot;</span><span class="s0">, </span><span class="s2">&quot;pear&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_categorical_known():</span>
    <span class="s1">text1 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    A,B 
    a,a 
    b,b 
    a,a 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>
    <span class="s1">text2 = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    A,B 
    a,a 
    b,b 
    c,c 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>
    <span class="s1">dtype = pd.api.types.CategoricalDtype([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;foo.1.csv&quot;</span><span class="s1">: text1</span><span class="s0">, </span><span class="s2">&quot;foo.2.csv&quot;</span><span class="s1">: text2}):</span>
        <span class="s1">result = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;A&quot;</span><span class="s1">: </span><span class="s2">&quot;category&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s2">&quot;category&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.known </span><span class="s0">is False</span>
        <span class="s0">assert </span><span class="s1">result.B.cat.known </span><span class="s0">is False</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: pd.Categorical(</span>
                    <span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=dtype.categories</span>
                <span class="s1">)</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: pd.Categorical(</span>
                    <span class="s1">[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">categories=dtype.categories</span>
                <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">}</span><span class="s0">,</span>
            <span class="s1">index=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># Specify a dtype</span>
        <span class="s1">result = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;A&quot;</span><span class="s1">: dtype</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s2">&quot;category&quot;</span><span class="s1">})</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.known </span><span class="s0">is True</span>
        <span class="s0">assert </span><span class="s1">result.B.cat.known </span><span class="s0">is False</span>
        <span class="s1">tm.assert_index_equal(result.A.cat.categories</span><span class="s0">, </span><span class="s1">dtype.categories)</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.ordered </span><span class="s0">is False</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># ordered</span>
        <span class="s1">dtype = pd.api.types.CategoricalDtype([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">ordered=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;A&quot;</span><span class="s1">: dtype</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s1">: </span><span class="s2">&quot;category&quot;</span><span class="s1">})</span>
        <span class="s1">expected[</span><span class="s2">&quot;A&quot;</span><span class="s1">] = expected[</span><span class="s2">&quot;A&quot;</span><span class="s1">].cat.as_ordered()</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.known </span><span class="s0">is True</span>
        <span class="s0">assert </span><span class="s1">result.B.cat.known </span><span class="s0">is False</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.ordered </span><span class="s0">is True</span>

        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected)</span>

        <span class="s3"># Specify &quot;unknown&quot; categories</span>
        <span class="s1">result = dd.read_csv(</span>
            <span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype=pd.api.types.CategoricalDtype(ordered=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.known </span><span class="s0">is False</span>

        <span class="s1">result = dd.read_csv(</span><span class="s2">&quot;foo.*.csv&quot;</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">result.A.cat.known </span><span class="s0">is False</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;compression&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s2">&quot;infer&quot;</span><span class="s0">, </span><span class="s2">&quot;gzip&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_compression_multiple_files(compression):</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">tdir:</span>
        <span class="s1">f = gzip.open(os.path.join(tdir</span><span class="s0">, </span><span class="s2">&quot;a.csv.gz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">)</span>
        <span class="s1">f.write(csv_text.encode())</span>
        <span class="s1">f.close()</span>

        <span class="s1">f = gzip.open(os.path.join(tdir</span><span class="s0">, </span><span class="s2">&quot;b.csv.gz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">)</span>
        <span class="s1">f.write(csv_text.encode())</span>
        <span class="s1">f.close()</span>

        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
            <span class="s1">df = dd.read_csv(os.path.join(tdir</span><span class="s0">, </span><span class="s2">&quot;*.csv.gz&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">compression=compression)</span>

        <span class="s0">assert </span><span class="s1">len(df.compute()) == (len(csv_text.split(</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)) - </span><span class="s4">1</span><span class="s1">) * </span><span class="s4">2</span>


<span class="s0">def </span><span class="s1">test_empty_csv_file():</span>
    <span class="s0">with </span><span class="s1">filetext(</span><span class="s2">&quot;a,b&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">len(df.compute()) == </span><span class="s4">0</span>
        <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_read_csv_no_sample():</span>
    <span class="s0">with </span><span class="s1">filetexts(csv_files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_read_csv_sensitive_to_enforce():</span>
    <span class="s0">with </span><span class="s1">filetexts(csv_files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">a = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">enforce=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">b = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">enforce=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a._name != b._name</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;blocksize&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">None, </span><span class="s4">10</span><span class="s1">])</span>
<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;fmt&quot;</span><span class="s0">, </span><span class="s1">compression_fmts)</span>
<span class="s0">def </span><span class="s1">test_read_csv_compression(fmt</span><span class="s0">, </span><span class="s1">blocksize):</span>
    <span class="s0">if </span><span class="s1">fmt </span><span class="s0">and </span><span class="s1">fmt </span><span class="s0">not in </span><span class="s1">compress:</span>
        <span class="s1">pytest.skip(</span><span class="s2">&quot;compress function not provided for %s&quot; </span><span class="s1">% fmt)</span>

    <span class="s1">expected = read_files()</span>
    <span class="s1">suffix = {</span><span class="s2">&quot;gzip&quot;</span><span class="s1">: </span><span class="s2">&quot;.gz&quot;</span><span class="s0">, </span><span class="s2">&quot;bz2&quot;</span><span class="s1">: </span><span class="s2">&quot;.bz2&quot;</span><span class="s0">, </span><span class="s2">&quot;zip&quot;</span><span class="s1">: </span><span class="s2">&quot;.zip&quot;</span><span class="s0">, </span><span class="s2">&quot;xz&quot;</span><span class="s1">: </span><span class="s2">&quot;.xz&quot;</span><span class="s1">}.get(fmt</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s1">)</span>
    <span class="s1">files2 = valmap(compress[fmt]</span><span class="s0">, </span><span class="s1">csv_files) </span><span class="s0">if </span><span class="s1">fmt </span><span class="s0">else </span><span class="s1">csv_files</span>
    <span class="s1">renamed_files = {k + suffix: v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">files2.items()}</span>
    <span class="s0">with </span><span class="s1">filetexts(renamed_files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s3"># This test is using `compression=&quot;infer&quot;` (the default) for</span>
        <span class="s3"># read_csv.  The paths must have the appropriate extension.</span>
        <span class="s0">if </span><span class="s1">fmt </span><span class="s0">and </span><span class="s1">blocksize:</span>
            <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):</span>
                <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot; </span><span class="s1">+ suffix</span><span class="s0">, </span><span class="s1">blocksize=blocksize)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot; </span><span class="s1">+ suffix</span><span class="s0">, </span><span class="s1">blocksize=blocksize)</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">df.compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">expected.reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">check_dtype=</span><span class="s0">False,</span>
        <span class="s1">)</span>


<span class="s1">@pytest.mark.skip</span>
<span class="s0">def </span><span class="s1">test_warn_non_seekable_files():</span>
    <span class="s1">files2 = valmap(compress[</span><span class="s2">&quot;gzip&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">csv_files)</span>
    <span class="s0">with </span><span class="s1">filetexts(files2</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s0">with </span><span class="s1">pytest.warns(UserWarning) </span><span class="s0">as </span><span class="s1">w:</span>
            <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">df.npartitions == </span><span class="s4">3</span>

        <span class="s0">assert </span><span class="s1">len(w) == </span><span class="s4">1</span>
        <span class="s1">msg = str(w[</span><span class="s4">0</span><span class="s1">].message)</span>
        <span class="s0">assert </span><span class="s2">&quot;gzip&quot; </span><span class="s0">in </span><span class="s1">msg</span>
        <span class="s0">assert </span><span class="s2">&quot;blocksize=None&quot; </span><span class="s0">in </span><span class="s1">msg</span>

        <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">record:</span>
            <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert not </span><span class="s1">record</span>

        <span class="s0">with </span><span class="s1">pytest.raises(NotImplementedError):</span>
            <span class="s0">with </span><span class="s1">pytest.warns(UserWarning):  </span><span class="s3"># needed for pytest</span>
                <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_windows_line_terminator():</span>
    <span class="s1">text = </span><span class="s2">&quot;a,b</span><span class="s0">\r\n</span><span class="s2">1,2</span><span class="s0">\r\n</span><span class="s2">2,3</span><span class="s0">\r\n</span><span class="s2">3,4</span><span class="s0">\r\n</span><span class="s2">4,5</span><span class="s0">\r\n</span><span class="s2">5,6</span><span class="s0">\r\n</span><span class="s2">6,7&quot;</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">5</span><span class="s0">, </span><span class="s1">lineterminator=</span><span class="s2">&quot;</span><span class="s0">\r\n</span><span class="s2">&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.b.sum().compute() == </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">5 </span><span class="s1">+ </span><span class="s4">6 </span><span class="s1">+ </span><span class="s4">7</span>
        <span class="s0">assert </span><span class="s1">df.a.sum().compute() == </span><span class="s4">1 </span><span class="s1">+ </span><span class="s4">2 </span><span class="s1">+ </span><span class="s4">3 </span><span class="s1">+ </span><span class="s4">4 </span><span class="s1">+ </span><span class="s4">5 </span><span class="s1">+ </span><span class="s4">6</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;header&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_header_int(header):</span>
    <span class="s1">text = (</span>
        <span class="s2">&quot;id0,name0,x0,y0</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;id,name,x,y</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;1034,Victor,-0.25,0.84</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;998,Xavier,-0.48,-0.13</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;999,Zelda,0.00,0.47</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;980,Alice,0.67,-0.98</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;989,Zelda,-0.04,0.03</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;test_header_int.csv&quot;</span><span class="s1">: text}):</span>
        <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;test_header_int.csv&quot;</span><span class="s0">, </span><span class="s1">header=header</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">64</span><span class="s1">)</span>
        <span class="s1">expected = pd.read_csv(</span><span class="s2">&quot;test_header_int.csv&quot;</span><span class="s0">, </span><span class="s1">header=header)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_header_None():</span>
    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;.tmp.1.csv&quot;</span><span class="s1">: </span><span class="s2">&quot;1,2&quot;</span><span class="s0">, </span><span class="s2">&quot;.tmp.2.csv&quot;</span><span class="s1">: </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;.tmp.3.csv&quot;</span><span class="s1">: </span><span class="s2">&quot;3,4&quot;</span><span class="s1">}):</span>
        <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;.tmp.*.csv&quot;</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame({</span><span class="s4">0</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
        <span class="s1">assert_eq(df.compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_auto_blocksize():</span>
    <span class="s0">assert </span><span class="s1">isinstance(auto_blocksize(</span><span class="s4">3000</span><span class="s0">, </span><span class="s4">15</span><span class="s1">)</span><span class="s0">, </span><span class="s1">int)</span>
    <span class="s0">assert </span><span class="s1">auto_blocksize(</span><span class="s4">3000</span><span class="s0">, </span><span class="s4">3</span><span class="s1">) == </span><span class="s4">100</span>
    <span class="s0">assert </span><span class="s1">auto_blocksize(</span><span class="s4">5000</span><span class="s0">, </span><span class="s4">2</span><span class="s1">) == </span><span class="s4">250</span>


<span class="s0">def </span><span class="s1">test__infer_block_size(monkeypatch):</span>
    <span class="s6">&quot;&quot;&quot; 
    psutil returns a total memory of `None` on some systems 
    see https://github.com/dask/dask/pull/7601 
    &quot;&quot;&quot;</span>
    <span class="s1">psutil = pytest.importorskip(</span><span class="s2">&quot;psutil&quot;</span><span class="s1">)</span>

    <span class="s0">class </span><span class="s1">MockOutput:</span>
        <span class="s1">total = </span><span class="s0">None</span>

    <span class="s0">def </span><span class="s1">mock_virtual_memory():</span>
        <span class="s0">return </span><span class="s1">MockOutput</span>

    <span class="s1">monkeypatch.setattr(psutil</span><span class="s0">, </span><span class="s2">&quot;virtual_memory&quot;</span><span class="s0">, </span><span class="s1">mock_virtual_memory)</span>
    <span class="s0">assert </span><span class="s1">_infer_block_size()</span>


<span class="s0">def </span><span class="s1">test_auto_blocksize_max64mb():</span>
    <span class="s1">blocksize = auto_blocksize(</span><span class="s4">1000000000000</span><span class="s0">, </span><span class="s4">3</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">blocksize == int(</span><span class="s4">64e6</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">isinstance(blocksize</span><span class="s0">, </span><span class="s1">int)</span>


<span class="s0">def </span><span class="s1">test_auto_blocksize_csv(monkeypatch):</span>
    <span class="s1">psutil = pytest.importorskip(</span><span class="s2">&quot;psutil&quot;</span><span class="s1">)</span>
    <span class="s1">total_memory = psutil.virtual_memory().total</span>
    <span class="s1">cpu_count = psutil.cpu_count()</span>
    <span class="s1">mock_read_bytes = mock.Mock(wraps=read_bytes)</span>
    <span class="s1">monkeypatch.setattr(dask.dataframe.io.csv</span><span class="s0">, </span><span class="s2">&quot;read_bytes&quot;</span><span class="s0">, </span><span class="s1">mock_read_bytes)</span>

    <span class="s1">expected_block_size = auto_blocksize(total_memory</span><span class="s0">, </span><span class="s1">cpu_count)</span>
    <span class="s0">with </span><span class="s1">filetexts(csv_files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">dd.read_csv(</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">mock_read_bytes.called</span>
        <span class="s0">assert </span><span class="s1">mock_read_bytes.call_args[</span><span class="s4">1</span><span class="s1">][</span><span class="s2">&quot;blocksize&quot;</span><span class="s1">] == expected_block_size</span>


<span class="s0">def </span><span class="s1">test_head_partial_line_fix():</span>
    <span class="s1">files = {</span>
        <span class="s2">&quot;.overflow1.csv&quot;</span><span class="s1">: (</span>
            <span class="s2">&quot;a,b</span><span class="s0">\n</span><span class="s2">0,'abcdefghijklmnopqrstuvwxyz'</span><span class="s0">\n</span><span class="s2">1,'abcdefghijklmnopqrstuvwxyz'&quot;</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;.overflow2.csv&quot;</span><span class="s1">: </span><span class="s2">&quot;a,b</span><span class="s0">\n</span><span class="s2">111111,-11111</span><span class="s0">\n</span><span class="s2">222222,-22222</span><span class="s0">\n</span><span class="s2">333333,-33333</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">with </span><span class="s1">filetexts(files):</span>
        <span class="s3"># 64 byte file, 52 characters is mid-quote; this should not cause exception in head-handling code.</span>
        <span class="s1">dd.read_csv(</span><span class="s2">&quot;.overflow1.csv&quot;</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">52</span><span class="s1">)</span>

        <span class="s3"># 35 characters is cuts off before the second number on the last line</span>
        <span class="s3"># Should sample to end of line, otherwise pandas will infer `b` to be</span>
        <span class="s3"># a float dtype</span>
        <span class="s1">df = dd.read_csv(</span><span class="s2">&quot;.overflow2.csv&quot;</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">35</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(df.dtypes == </span><span class="s2">&quot;i8&quot;</span><span class="s1">).all()</span>


<span class="s0">def </span><span class="s1">test_read_csv_raises_on_no_files():</span>
    <span class="s1">fn = </span><span class="s2">&quot;.not.a.real.file.csv&quot;</span>
    <span class="s0">try</span><span class="s1">:</span>
        <span class="s1">dd.read_csv(fn)</span>
        <span class="s0">assert False</span>
    <span class="s0">except </span><span class="s1">OSError </span><span class="s0">as </span><span class="s1">e:</span>
        <span class="s0">assert </span><span class="s1">fn </span><span class="s0">in </span><span class="s1">str(e)</span>


<span class="s0">def </span><span class="s1">test_read_csv_has_deterministic_name():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a = dd.read_csv(fn)</span>
        <span class="s1">b = dd.read_csv(fn)</span>
        <span class="s0">assert </span><span class="s1">a._name == b._name</span>
        <span class="s0">assert </span><span class="s1">sorted(a.dask.keys()</span><span class="s0">, </span><span class="s1">key=str) == sorted(b.dask.keys()</span><span class="s0">, </span><span class="s1">key=str)</span>
        <span class="s0">assert </span><span class="s1">isinstance(a._name</span><span class="s0">, </span><span class="s1">str)</span>

        <span class="s1">c = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">na_values=[</span><span class="s4">0</span><span class="s1">])</span>
        <span class="s0">assert </span><span class="s1">a._name != c._name</span>


<span class="s0">def </span><span class="s1">test_multiple_read_csv_has_deterministic_name():</span>
    <span class="s0">with </span><span class="s1">filetexts({</span><span class="s2">&quot;_foo.1.csv&quot;</span><span class="s1">: csv_text</span><span class="s0">, </span><span class="s2">&quot;_foo.2.csv&quot;</span><span class="s1">: csv_text}):</span>
        <span class="s1">a = dd.read_csv(</span><span class="s2">&quot;_foo.*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">b = dd.read_csv(</span><span class="s2">&quot;_foo.*.csv&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">sorted(a.dask.keys()</span><span class="s0">, </span><span class="s1">key=str) == sorted(b.dask.keys()</span><span class="s0">, </span><span class="s1">key=str)</span>


<span class="s0">def </span><span class="s1">test_read_csv_has_different_names_based_on_blocksize():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">a = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;10kB&quot;</span><span class="s1">)</span>
        <span class="s1">b = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s2">&quot;20kB&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">a._name != b._name</span>


<span class="s0">def </span><span class="s1">test_csv_with_integer_names():</span>
    <span class="s0">with </span><span class="s1">filetext(</span><span class="s2">&quot;alice,1</span><span class="s0">\n</span><span class="s2">bob,2&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">list(df.columns) == [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_late_dtypes():</span>
    <span class="s1">text = </span><span class="s2">&quot;numbers,names,more_numbers,integers,dates</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1000</span><span class="s1">):</span>
        <span class="s1">text += </span><span class="s2">&quot;1,,2,3,2017-10-31 00:00:00</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s1">text += </span><span class="s2">&quot;1.5,bar,2.5,3,4998-01-01 00:00:00</span><span class="s0">\n</span><span class="s2">&quot;</span>

    <span class="s1">date_msg = (</span>
        <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;-------------------------------------------------------------</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;The following columns also failed to properly parse as dates:</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;- dates</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;This is usually due to an invalid value in that column. To</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;diagnose and fix it's recommended to drop these columns from the</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;`parse_dates` keyword, and manually convert them to dates later</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;using `dd.to_datetime`.&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">sol = pd.read_csv(fn)</span>
        <span class="s1">msg = (</span>
            <span class="s2">&quot;Mismatched dtypes found in `pd.read_csv`/`pd.read_table`.</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| Column       | Found   | Expected |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| more_numbers | float64 | int64    |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| names        | object  | float64  |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| numbers      | float64 | int64    |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- names</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;  ValueError(.*)</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Usually this is due to dask's dtype inference failing, and</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;*may* be fixed by specifying dtypes manually by adding:</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;dtype={'more_numbers': 'float64',</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;       'names': 'object',</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;       'numbers': 'float64'}</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;to the call to `read_csv`/`read_table`.&quot;</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;dates&quot;</span><span class="s1">]).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">e.match(msg + date_msg)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s1">).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">e.match(msg)</span>

        <span class="s1">msg = (</span>
            <span class="s2">&quot;Mismatched dtypes found in `pd.read_csv`/`pd.read_table`.</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| Column       | Found   | Expected |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| more_numbers | float64 | int64    |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;| numbers      | float64 | int64    |</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;+--------------+---------+----------+</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Usually this is due to dask's dtype inference failing, and</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;*may* be fixed by specifying dtypes manually by adding:</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;dtype={'more_numbers': 'float64',</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;       'numbers': 'float64'}</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;to the call to `read_csv`/`read_table`.</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;Alternatively, provide `assume_missing=True` to interpret</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;all unspecified integer columns as floats.&quot;</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;names&quot;</span><span class="s1">: </span><span class="s2">&quot;O&quot;</span><span class="s1">}).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">str(e.value) == msg</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">dd.read_csv(</span>
                <span class="s1">fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;dates&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype={</span><span class="s2">&quot;names&quot;</span><span class="s1">: </span><span class="s2">&quot;O&quot;</span><span class="s1">}</span>
            <span class="s1">).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">str(e.value) == msg + date_msg</span>

        <span class="s1">msg = (</span>
            <span class="s2">&quot;Mismatched dtypes found in `pd.read_csv`/`pd.read_table`.</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;The following columns failed to properly parse as dates:</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;- dates</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;This is usually due to an invalid value in that column. To</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;diagnose and fix it's recommended to drop these columns from the</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;`parse_dates` keyword, and manually convert them to dates later</span><span class="s0">\n</span><span class="s2">&quot;</span>
            <span class="s2">&quot;using `dd.to_datetime`.&quot;</span>
        <span class="s1">)</span>

        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s1">dd.read_csv(</span>
                <span class="s1">fn</span><span class="s0">,</span>
                <span class="s1">sample=</span><span class="s4">50</span><span class="s0">,</span>
                <span class="s1">parse_dates=[</span><span class="s2">&quot;dates&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">dtype={</span><span class="s2">&quot;more_numbers&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;names&quot;</span><span class="s1">: object</span><span class="s0">, </span><span class="s2">&quot;numbers&quot;</span><span class="s1">: float}</span><span class="s0">,</span>
            <span class="s1">).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">str(e.value) == msg</span>

        <span class="s3"># Specifying dtypes works</span>
        <span class="s1">res = dd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">,</span>
            <span class="s1">sample=</span><span class="s4">50</span><span class="s0">,</span>
            <span class="s1">dtype={</span><span class="s2">&quot;more_numbers&quot;</span><span class="s1">: float</span><span class="s0">, </span><span class="s2">&quot;names&quot;</span><span class="s1">: object</span><span class="s0">, </span><span class="s2">&quot;numbers&quot;</span><span class="s1">: float}</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">sol)</span>


<span class="s0">def </span><span class="s1">test_assume_missing():</span>
    <span class="s1">text = </span><span class="s2">&quot;numbers,names,more_numbers,integers</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1000</span><span class="s1">):</span>
        <span class="s1">text += </span><span class="s2">&quot;1,foo,2,3</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s1">text += </span><span class="s2">&quot;1.5,bar,2.5,3</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">sol = pd.read_csv(fn)</span>

        <span class="s3"># assume_missing affects all columns</span>
        <span class="s1">res = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">assume_missing=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">sol.astype({</span><span class="s2">&quot;integers&quot;</span><span class="s1">: float}))</span>

        <span class="s3"># assume_missing doesn't override specified dtypes</span>
        <span class="s1">res = dd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">assume_missing=</span><span class="s0">True, </span><span class="s1">dtype={</span><span class="s2">&quot;integers&quot;</span><span class="s1">: </span><span class="s2">&quot;int64&quot;</span><span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">sol)</span>

        <span class="s3"># assume_missing works with dtype=None</span>
        <span class="s1">res = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">50</span><span class="s0">, </span><span class="s1">assume_missing=</span><span class="s0">True, </span><span class="s1">dtype=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">assert_eq(res</span><span class="s0">, </span><span class="s1">sol.astype({</span><span class="s2">&quot;integers&quot;</span><span class="s1">: float}))</span>

    <span class="s1">text = </span><span class="s2">&quot;numbers,integers</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">1000</span><span class="s1">):</span>
        <span class="s1">text += </span><span class="s2">&quot;1,2</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s1">text += </span><span class="s2">&quot;1.5,2</span><span class="s0">\n</span><span class="s2">&quot;</span>

    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">sol = pd.read_csv(fn)</span>

        <span class="s3"># assume_missing ignored when all dtypes specifed</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">dtype=</span><span class="s2">&quot;int64&quot;</span><span class="s0">, </span><span class="s1">assume_missing=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">df.numbers.dtype == </span><span class="s2">&quot;int64&quot;</span>


<span class="s0">def </span><span class="s1">test_index_col():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s0">try</span><span class="s1">:</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s2">&quot;name&quot;</span><span class="s1">)</span>
            <span class="s0">assert False</span>
        <span class="s0">except </span><span class="s1">ValueError </span><span class="s0">as </span><span class="s1">e:</span>
            <span class="s0">assert </span><span class="s2">&quot;set_index&quot; </span><span class="s0">in </span><span class="s1">str(e)</span>

        <span class="s1">df = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">ddf = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">30</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_read_csv_with_datetime_index_partitions_one():</span>
    <span class="s0">with </span><span class="s1">filetext(timeseries) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = pd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;Date&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s3"># blocksize set to explicitly set to single chunk</span>
        <span class="s1">ddf = dd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;Date&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">10000000</span>
        <span class="s1">).set_index(</span><span class="s2">&quot;Date&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf)</span>

        <span class="s3"># because fn is so small, by default, this will only be one chunk</span>
        <span class="s1">ddf = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;Date&quot;</span><span class="s1">]).set_index(</span>
            <span class="s2">&quot;Date&quot;</span>
        <span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf)</span>


<span class="s0">def </span><span class="s1">test_read_csv_with_datetime_index_partitions_n():</span>
    <span class="s0">with </span><span class="s1">filetext(timeseries) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = pd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;Date&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s3"># because fn is so small, by default, set chunksize small</span>
        <span class="s1">ddf = dd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">usecols=[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">parse_dates=[</span><span class="s2">&quot;Date&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">400</span>
        <span class="s1">).set_index(</span><span class="s2">&quot;Date&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf)</span>


<span class="s1">xfail_pandas_100 = pytest.mark.xfail(reason=</span><span class="s2">&quot;https://github.com/dask/dask/issues/5787&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;encoding&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">pytest.param(</span><span class="s2">&quot;utf-16&quot;</span><span class="s0">, </span><span class="s1">marks=xfail_pandas_100)</span><span class="s0">,</span>
        <span class="s1">pytest.param(</span><span class="s2">&quot;utf-16-le&quot;</span><span class="s0">, </span><span class="s1">marks=xfail_pandas_100)</span><span class="s0">,</span>
        <span class="s2">&quot;utf-16-be&quot;</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_encoding_gh601(encoding):</span>
    <span class="s1">ar = pd.Series(range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">100</span><span class="s1">))</span>
    <span class="s1">br = ar % </span><span class="s4">7</span>
    <span class="s1">cr = br * </span><span class="s4">3.3</span>
    <span class="s1">dr = br / </span><span class="s4">1.9836</span>
    <span class="s1">test_df = pd.DataFrame({</span><span class="s2">&quot;a&quot;</span><span class="s1">: ar</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: br</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: cr</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: dr})</span>

    <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;.csv&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">test_df.to_csv(fn</span><span class="s0">, </span><span class="s1">encoding=encoding</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">a = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">encoding=encoding)</span>
        <span class="s1">d = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">encoding=encoding</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">1000</span><span class="s1">)</span>
        <span class="s1">d = d.compute()</span>
        <span class="s1">d.index = range(len(d.index))</span>
        <span class="s1">assert_eq(d</span><span class="s0">, </span><span class="s1">a)</span>


<span class="s0">def </span><span class="s1">test_read_csv_header_issue_823():</span>
    <span class="s1">text = </span><span class="s2">&quot;&quot;&quot;a b c-d</span><span class="s0">\n</span><span class="s2">1 2 3</span><span class="s0">\n</span><span class="s2">4 5 6&quot;&quot;&quot;</span><span class="s1">.replace(</span><span class="s2">&quot; &quot;</span><span class="s0">, </span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">pd.read_csv(fn</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">))</span>

        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">pd.read_csv(fn</span><span class="s0">, </span><span class="s1">delimiter=</span><span class="s2">&quot;</span><span class="s0">\t</span><span class="s2">&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_none_usecols():</span>
    <span class="s0">with </span><span class="s1">filetext(csv_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">df = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">usecols=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">pd.read_csv(fn</span><span class="s0">, </span><span class="s1">usecols=</span><span class="s0">None</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_parse_dates_multi_column():</span>
    <span class="s1">pdmc_text = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    ID,date,time 
    10,2003-11-04,180036 
    11,2003-11-05,125640 
    12,2003-11-01,2519 
    13,2003-10-22,142559 
    14,2003-10-24,163113 
    15,2003-10-20,170133 
    16,2003-11-11,160448 
    17,2003-11-03,171759 
    18,2003-11-07,190928 
    19,2003-10-21,84623 
    20,2003-10-25,192207 
    21,2003-11-13,180156 
    22,2003-11-15,131037 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(pdmc_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">ddf = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">parse_dates=[[</span><span class="s2">&quot;date&quot;</span><span class="s0">, </span><span class="s2">&quot;time&quot;</span><span class="s1">]])</span>
        <span class="s1">df = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">parse_dates=[[</span><span class="s2">&quot;date&quot;</span><span class="s0">, </span><span class="s2">&quot;time&quot;</span><span class="s1">]])</span>

        <span class="s0">assert </span><span class="s1">(df.columns == ddf.columns).all()</span>
        <span class="s0">assert </span><span class="s1">len(df) == len(ddf)</span>


<span class="s0">def </span><span class="s1">test_read_csv_sep():</span>
    <span class="s1">sep_text = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    name###amount 
    alice###100 
    bob###200 
    charlie###300&quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(sep_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">ddf = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">&quot;###&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>
        <span class="s1">df = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">&quot;###&quot;</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;python&quot;</span><span class="s1">)</span>

        <span class="s0">assert </span><span class="s1">(df.columns == ddf.columns).all()</span>
        <span class="s0">assert </span><span class="s1">len(df) == len(ddf)</span>


<span class="s0">def </span><span class="s1">test_read_csv_slash_r():</span>
    <span class="s1">data = </span><span class="s5">b&quot;0,my</span><span class="s0">\n</span><span class="s5">1,data</span><span class="s0">\n</span><span class="s5">&quot; </span><span class="s1">* </span><span class="s4">1000 </span><span class="s1">+ </span><span class="s5">b&quot;2,foo</span><span class="s0">\r</span><span class="s5">bar&quot;</span>
    <span class="s0">with </span><span class="s1">filetext(data</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">dd.read_csv(</span>
            <span class="s1">fn</span><span class="s0">,</span>
            <span class="s1">header=</span><span class="s0">None,</span>
            <span class="s1">sep=</span><span class="s2">&quot;,&quot;</span><span class="s0">,</span>
            <span class="s1">lineterminator=</span><span class="s2">&quot;</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">blocksize=</span><span class="s4">200</span><span class="s0">,</span>
        <span class="s1">).compute(scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_read_csv_singleton_dtype():</span>
    <span class="s1">data = </span><span class="s5">b&quot;a,b</span><span class="s0">\n</span><span class="s5">1,2</span><span class="s0">\n</span><span class="s5">3,4</span><span class="s0">\n</span><span class="s5">5,6&quot;</span>
    <span class="s0">with </span><span class="s1">filetext(data</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">assert_eq(pd.read_csv(fn</span><span class="s0">, </span><span class="s1">dtype=float)</span><span class="s0">, </span><span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">dtype=float))</span>


<span class="s1">@pytest.mark.skipif(</span><span class="s0">not </span><span class="s1">PANDAS_GE_140</span><span class="s0">, </span><span class="s1">reason=</span><span class="s2">&quot;arrow engine available from 1.4&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_read_csv_arrow_engine():</span>
    <span class="s1">pytest.importorskip(</span><span class="s2">&quot;pyarrow&quot;</span><span class="s1">)</span>
    <span class="s1">sep_text = normalize_text(</span>
        <span class="s2">&quot;&quot;&quot; 
    a,b 
    1,2 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">with </span><span class="s1">filetext(sep_text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">assert_eq(pd.read_csv(fn</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;pyarrow&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">engine=</span><span class="s2">&quot;pyarrow&quot;</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_robust_column_mismatch():</span>
    <span class="s1">files = csv_files.copy()</span>
    <span class="s1">k = sorted(files)[-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">files[k] = files[k].replace(</span><span class="s5">b&quot;name&quot;</span><span class="s0">, </span><span class="s5">b&quot;Name&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">ddf = dd.read_csv(</span>
            <span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">skiprows=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">names=[</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]</span>
        <span class="s1">)</span>
        <span class="s1">df = pd.read_csv(</span><span class="s2">&quot;2014-01-01.csv&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">(df.columns == ddf.columns).all()</span>
        <span class="s1">assert_eq(ddf</span><span class="s0">, </span><span class="s1">ddf)</span>


<span class="s0">def </span><span class="s1">test_different_columns_are_allowed():</span>
    <span class="s1">files = csv_files.copy()</span>
    <span class="s1">k = sorted(files)[-</span><span class="s4">1</span><span class="s1">]</span>
    <span class="s1">files[k] = files[k].replace(</span><span class="s5">b&quot;name&quot;</span><span class="s0">, </span><span class="s5">b&quot;address&quot;</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">filetexts(files</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;b&quot;</span><span class="s1">):</span>
        <span class="s1">ddf = dd.read_csv(</span><span class="s2">&quot;2014-01-*.csv&quot;</span><span class="s1">)</span>

        <span class="s3"># since enforce is False, meta doesn't have to match computed</span>
        <span class="s0">assert </span><span class="s1">(ddf.columns == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s1">]).all()</span>
        <span class="s0">assert </span><span class="s1">(ddf.compute().columns == [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s0">, </span><span class="s2">&quot;id&quot;</span><span class="s0">, </span><span class="s2">&quot;address&quot;</span><span class="s1">]).all()</span>


<span class="s0">def </span><span class="s1">test_error_if_sample_is_too_small():</span>
    <span class="s1">text = </span><span class="s2">&quot;AAAAA,BBBBB,CCCCC,DDDDD,EEEEE</span><span class="s0">\n</span><span class="s2">1,2,3,4,5</span><span class="s0">\n</span><span class="s2">6,7,8,9,10</span><span class="s0">\n</span><span class="s2">11,12,13,14,15&quot;</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s3"># Sample size stops mid header row</span>
        <span class="s1">sample = </span><span class="s4">20</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=sample)</span>

        <span class="s3"># Saying no header means this is fine</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=sample</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None</span><span class="s1">)</span><span class="s0">, </span><span class="s1">pd.read_csv(fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None</span><span class="s1">)</span>
        <span class="s1">)</span>

    <span class="s1">skiptext = </span><span class="s2">&quot;# skip</span><span class="s0">\n</span><span class="s2"># these</span><span class="s0">\n</span><span class="s2"># lines</span><span class="s0">\n</span><span class="s2">&quot;</span>

    <span class="s1">text = skiptext + text</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s3"># Sample size stops mid header row</span>
        <span class="s1">sample = </span><span class="s4">20 </span><span class="s1">+ len(skiptext)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=sample</span><span class="s0">, </span><span class="s1">skiprows=</span><span class="s4">3</span><span class="s1">)</span>

        <span class="s3"># Saying no header means this is fine</span>
        <span class="s1">assert_eq(</span>
            <span class="s1">dd.read_csv(fn</span><span class="s0">, </span><span class="s1">sample=sample</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">skiprows=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">pd.read_csv(fn</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">skiprows=</span><span class="s4">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_read_csv_names_not_none():</span>
    <span class="s1">text = (</span>
        <span class="s2">&quot;Alice,100</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Bob,-200</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Charlie,300</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Dennis,400</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Edith,-500</span><span class="s0">\n</span><span class="s2">&quot;</span>
        <span class="s2">&quot;Frank,600</span><span class="s0">\n</span><span class="s2">&quot;</span>
    <span class="s1">)</span>
    <span class="s1">names = [</span><span class="s2">&quot;name&quot;</span><span class="s0">, </span><span class="s2">&quot;amount&quot;</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">filetext(text) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">ddf = dd.read_csv(fn</span><span class="s0">, </span><span class="s1">names=names</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s4">16</span><span class="s1">)</span>
        <span class="s1">df = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">names=names)</span>
        <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s3">############</span>
<span class="s3">#  to_csv  #</span>
<span class="s3">############</span>


<span class="s0">def </span><span class="s1">test_to_csv():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>

    <span class="s0">for </span><span class="s1">npartitions </span><span class="s0">in </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]:</span>
        <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions)</span>
        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">a.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">result = dd.read_csv(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">r = a.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s1">paths = dask.compute(*r</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
            <span class="s3"># this is a tuple rather than a list since it's the output of dask.compute</span>
            <span class="s0">assert </span><span class="s1">paths == tuple(</span>
                <span class="s1">os.path.join(dn</span><span class="s0">, </span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">n</span><span class="s0">}</span><span class="s2">.part&quot;</span><span class="s1">) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(npartitions)</span>
            <span class="s1">)</span>
            <span class="s1">result = dd.read_csv(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;data_*.csv&quot;</span><span class="s1">)</span>
            <span class="s1">paths = a.to_csv(fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
            <span class="s0">assert </span><span class="s1">paths == [</span>
                <span class="s1">os.path.join(dn</span><span class="s0">, </span><span class="s2">f&quot;data_</span><span class="s0">{</span><span class="s1">n</span><span class="s0">}</span><span class="s2">.csv&quot;</span><span class="s1">) </span><span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">range(npartitions)</span>
            <span class="s1">]</span>
            <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_to_csv_multiple_files_cornercases():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;data_*_*.csv&quot;</span><span class="s1">)</span>
            <span class="s1">a.to_csv(fn)</span>

    <span class="s1">df16 = pd.DataFrame(</span>
        <span class="s1">{</span>
            <span class="s2">&quot;x&quot;</span><span class="s1">: [</span>
                <span class="s2">&quot;a&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;b&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;c&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;d&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;e&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;f&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;g&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;h&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;i&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;j&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;k&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;l&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;m&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;n&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;o&quot;</span><span class="s0">,</span>
                <span class="s2">&quot;p&quot;</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
            <span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s0">, </span><span class="s4">7</span><span class="s0">, </span><span class="s4">8</span><span class="s0">, </span><span class="s4">9</span><span class="s0">, </span><span class="s4">10</span><span class="s0">, </span><span class="s4">11</span><span class="s0">, </span><span class="s4">12</span><span class="s0">, </span><span class="s4">13</span><span class="s0">, </span><span class="s4">14</span><span class="s0">, </span><span class="s4">15</span><span class="s0">, </span><span class="s4">16</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">}</span>
    <span class="s1">)</span>
    <span class="s1">a = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;data_*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df16)</span>

    <span class="s3"># test handling existing files when links are optimized out</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">a.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;data_*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>

    <span class="s3"># test handling existing files when links are optimized out</span>
    <span class="s1">a = dd.from_pandas(df16</span><span class="s0">, </span><span class="s4">16</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">a.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;data_*.csv&quot;</span><span class="s1">)</span>
        <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df16)</span>


<span class="s0">def </span><span class="s1">test_to_single_csv():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>

    <span class="s0">for </span><span class="s1">npartitions </span><span class="s0">in </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]:</span>
        <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions)</span>
        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
            <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>

        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
            <span class="s1">r = a.to_csv(fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">compute=</span><span class="s0">False, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">dask.compute(r</span><span class="s0">, </span><span class="s1">scheduler=</span><span class="s2">&quot;sync&quot;</span><span class="s1">)</span>
            <span class="s1">result = dd.read_csv(fn).compute().reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s0">def </span><span class="s1">test_to_single_csv_with_name_function():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">ValueError</span><span class="s0">,</span>
            <span class="s1">match=</span><span class="s2">&quot;name_function is not supported under the single file mode&quot;</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">name_function=</span><span class="s0">lambda </span><span class="s1">x: x</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_single_csv_with_header_first_partition_only():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s4">1</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(</span>
            <span class="s1">ValueError</span><span class="s0">,</span>
            <span class="s1">match=</span><span class="s2">&quot;header_first_partition_only cannot be False in the single file mode.&quot;</span><span class="s0">,</span>
        <span class="s1">):</span>
            <span class="s1">a.to_csv(</span>
                <span class="s1">fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">header_first_partition_only=</span><span class="s0">False, </span><span class="s1">single_file=</span><span class="s0">True</span>
            <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_with_single_file_and_exclusive_mode():</span>
    <span class="s1">df0 = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">df = dd.from_pandas(df0</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">directory:</span>
        <span class="s1">csv_path = os.path.join(directory</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
        <span class="s1">df.to_csv(csv_path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">mode=</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">result = dd.read_csv(os.path.join(directory</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute()</span>
    <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df0</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_single_file_exlusive_mode_no_overwrite():</span>
    <span class="s1">df0 = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">df = dd.from_pandas(df0</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">directory:</span>
        <span class="s1">csv_path = os.path.join(str(directory)</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
        <span class="s1">df.to_csv(csv_path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">mode=</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">os.path.exists(csv_path)</span>
        <span class="s3"># mode=&quot;x&quot; should fail if file already exists</span>
        <span class="s0">with </span><span class="s1">pytest.raises(FileExistsError):</span>
            <span class="s1">df.to_csv(csv_path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">mode=</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s3"># but mode=&quot;w&quot; will overwrite an existing file</span>
        <span class="s1">df.to_csv(csv_path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">mode=</span><span class="s2">&quot;w&quot;</span><span class="s0">, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_single_csv_gzip():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>

    <span class="s0">for </span><span class="s1">npartitions </span><span class="s0">in </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]:</span>
        <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions)</span>
        <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
            <span class="s1">fn = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;test.csv.gz&quot;</span><span class="s1">)</span>
            <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s0">, </span><span class="s1">single_file=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">result = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s1">).reset_index(drop=</span><span class="s0">True</span><span class="s1">)</span>
            <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s1">@pytest.mark.xfail(reason=</span><span class="s2">&quot;to_csv does not support compression&quot;</span><span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_to_csv_gzip():</span>
    <span class="s1">df = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>

    <span class="s0">for </span><span class="s1">npartitions </span><span class="s0">in </span><span class="s1">[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]:</span>
        <span class="s1">a = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions)</span>
        <span class="s0">with </span><span class="s1">tmpfile(</span><span class="s2">&quot;csv&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">fn:</span>
            <span class="s1">a.to_csv(fn</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s1">)</span>
            <span class="s1">result = pd.read_csv(fn</span><span class="s0">, </span><span class="s1">index_col=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">compression=</span><span class="s2">&quot;gzip&quot;</span><span class="s1">)</span>
            <span class="s1">tm.assert_frame_equal(result</span><span class="s0">, </span><span class="s1">df)</span>


<span class="s1">@pytest.mark.skipif(</span>
    <span class="s1">Version(fsspec.__version__) == Version(</span><span class="s2">&quot;2023.9.1&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">reason=</span><span class="s2">&quot;https://github.com/dask/dask/issues/10515&quot;</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_to_csv_nodir():</span>
    <span class="s3"># See #6062 https://github.com/intake/filesystem_spec/pull/271 and</span>
    <span class="s1">df0 = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">df = dd.from_pandas(df0</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dir:</span>
        <span class="s1">dir0 = os.path.join(str(dir)</span><span class="s0">, </span><span class="s2">&quot;createme&quot;</span><span class="s1">)</span>
        <span class="s1">df.to_csv(dir0)</span>
        <span class="s0">assert </span><span class="s2">&quot;createme&quot; </span><span class="s0">in </span><span class="s1">os.listdir(dir)</span>
        <span class="s0">assert </span><span class="s1">os.listdir(dir0)</span>
        <span class="s1">result = dd.read_csv(os.path.join(dir0</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute()</span>
    <span class="s0">assert </span><span class="s1">(result.x.values == df0.x.values).all()</span>


<span class="s0">def </span><span class="s1">test_to_csv_simple():</span>
    <span class="s1">df0 = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s1">df = dd.from_pandas(df0</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dir:</span>
        <span class="s1">dir = str(dir)</span>
        <span class="s1">df.to_csv(dir)</span>
        <span class="s0">assert </span><span class="s1">os.listdir(dir)</span>
        <span class="s1">result = dd.read_csv(os.path.join(dir</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute()</span>
    <span class="s0">assert </span><span class="s1">(result.x.values == df0.x.values).all()</span>


<span class="s0">def </span><span class="s1">test_to_csv_with_single_file_and_append_mode():</span>
    <span class="s3"># regression test for https://github.com/dask/dask/issues/10414</span>
    <span class="s1">df0 = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]}</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df1 = pd.DataFrame(</span>
        <span class="s1">{</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]}</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">df = dd.from_pandas(df1</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dir:</span>
        <span class="s1">csv_path = os.path.join(dir</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
        <span class="s1">df0.to_csv(</span>
            <span class="s1">csv_path</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s0">False,</span>
        <span class="s1">)</span>
        <span class="s1">df.to_csv(</span>
            <span class="s1">csv_path</span><span class="s0">,</span>
            <span class="s1">mode=</span><span class="s2">&quot;a&quot;</span><span class="s0">,</span>
            <span class="s1">header=</span><span class="s0">False,</span>
            <span class="s1">index=</span><span class="s0">False,</span>
            <span class="s1">single_file=</span><span class="s0">True,</span>
        <span class="s1">)</span>
        <span class="s1">result = dd.read_csv(os.path.join(dir</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)).compute()</span>
    <span class="s1">expected = pd.concat([df0</span><span class="s0">, </span><span class="s1">df1])</span>
    <span class="s0">assert </span><span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">expected</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_series():</span>
    <span class="s1">df0 = pd.Series([</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">index=[</span><span class="s4">1.0</span><span class="s0">, </span><span class="s4">2.0</span><span class="s0">, </span><span class="s4">3.0</span><span class="s0">, </span><span class="s4">4.0</span><span class="s1">])</span>
    <span class="s1">df = dd.from_pandas(df0</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dir:</span>
        <span class="s1">dir = str(dir)</span>
        <span class="s1">df.to_csv(dir</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">os.listdir(dir)</span>
        <span class="s1">result = dd.read_csv(os.path.join(dir</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">names=[</span><span class="s2">&quot;x&quot;</span><span class="s1">]).compute()</span>
    <span class="s0">assert </span><span class="s1">(result.x == df0).all()</span>


<span class="s0">def </span><span class="s1">test_to_csv_with_get():</span>
    <span class="s0">from </span><span class="s1">dask.multiprocessing </span><span class="s0">import </span><span class="s1">get </span><span class="s0">as </span><span class="s1">mp_get</span>

    <span class="s1">flag = [</span><span class="s0">False</span><span class="s1">]</span>

    <span class="s0">def </span><span class="s1">my_get(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s1">flag[</span><span class="s4">0</span><span class="s1">] = </span><span class="s0">True</span>
        <span class="s0">return </span><span class="s1">mp_get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">ddf.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">compute_kwargs={</span><span class="s2">&quot;scheduler&quot;</span><span class="s1">: my_get})</span>
        <span class="s0">assert </span><span class="s1">flag[</span><span class="s4">0</span><span class="s1">]</span>
        <span class="s1">result = dd.read_csv(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;*&quot;</span><span class="s1">))</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_warns_using_scheduler_argument():</span>
    <span class="s0">from </span><span class="s1">dask.multiprocessing </span><span class="s0">import </span><span class="s1">get </span><span class="s0">as </span><span class="s1">mp_get</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">my_get(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">return </span><span class="s1">mp_get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s0">with </span><span class="s1">pytest.warns(FutureWarning):</span>
            <span class="s1">ddf.to_csv(dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">scheduler=my_get)</span>


<span class="s0">def </span><span class="s1">test_to_csv_errors_using_multiple_scheduler_args():</span>
    <span class="s0">from </span><span class="s1">dask.multiprocessing </span><span class="s0">import </span><span class="s1">get </span><span class="s0">as </span><span class="s1">mp_get</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">my_get(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">return </span><span class="s1">mp_get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError) </span><span class="s0">and </span><span class="s1">pytest.warns(FutureWarning):</span>
            <span class="s1">ddf.to_csv(</span>
                <span class="s1">dn</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">scheduler=my_get</span><span class="s0">, </span><span class="s1">compute_kwargs={</span><span class="s2">&quot;scheduler&quot;</span><span class="s1">: my_get}</span>
            <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_keeps_all_non_scheduler_compute_kwargs():</span>
    <span class="s0">from </span><span class="s1">dask.multiprocessing </span><span class="s0">import </span><span class="s1">get </span><span class="s0">as </span><span class="s1">mp_get</span>

    <span class="s0">def </span><span class="s1">my_get(*args</span><span class="s0">, </span><span class="s1">**kwargs):</span>
        <span class="s0">assert </span><span class="s1">kwargs[</span><span class="s2">&quot;test_kwargs_passed&quot;</span><span class="s1">] == </span><span class="s2">&quot;foobar&quot;</span>
        <span class="s0">return </span><span class="s1">mp_get(*args</span><span class="s0">, </span><span class="s1">**kwargs)</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">ddf.to_csv(</span>
            <span class="s1">dn</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s0">False,</span>
            <span class="s1">compute_kwargs={</span><span class="s2">&quot;scheduler&quot;</span><span class="s1">: my_get</span><span class="s0">, </span><span class="s2">&quot;test_kwargs_passed&quot;</span><span class="s1">: </span><span class="s2">&quot;foobar&quot;</span><span class="s1">}</span><span class="s0">,</span>
        <span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_to_csv_paths():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;A&quot;</span><span class="s1">: range(</span><span class="s4">10</span><span class="s1">)})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">2</span><span class="s1">)</span>
    <span class="s1">paths = ddf.to_csv(</span><span class="s2">&quot;foo*.csv&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">paths[</span><span class="s4">0</span><span class="s1">].endswith(</span><span class="s2">&quot;foo0.csv&quot;</span><span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">paths[</span><span class="s4">1</span><span class="s1">].endswith(</span><span class="s2">&quot;foo1.csv&quot;</span><span class="s1">)</span>

    <span class="s1">os.remove(</span><span class="s2">&quot;foo0.csv&quot;</span><span class="s1">)</span>
    <span class="s1">os.remove(</span><span class="s2">&quot;foo1.csv&quot;</span><span class="s1">)</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;header, expected&quot;</span><span class="s0">, </span><span class="s1">[(</span><span class="s0">False, </span><span class="s2">&quot;&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s0">True, </span><span class="s2">&quot;x,y</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)])</span>
<span class="s0">def </span><span class="s1">test_to_csv_header_empty_dataframe(header</span><span class="s0">, </span><span class="s1">expected):</span>
    <span class="s1">dfe = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: []</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: []})</span>
    <span class="s1">ddfe = dd.from_pandas(dfe</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">1</span><span class="s1">)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">ddfe.to_csv(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooe*.csv&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">header=header)</span>
        <span class="s0">assert not </span><span class="s1">os.path.exists(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooe1.csv&quot;</span><span class="s1">))</span>
        <span class="s1">filename = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooe0.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(filename) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">line = fp.readline()</span>
            <span class="s0">assert </span><span class="s1">line == expected</span>
        <span class="s1">os.remove(filename)</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;header,header_first_partition_only,expected_first,expected_next&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">(</span><span class="s0">False, False, </span><span class="s2">&quot;a,1</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;d,4</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, False, </span><span class="s2">&quot;x,y</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;x,y</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">False, True, </span><span class="s2">&quot;a,1</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;d,4</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s0">True, True, </span><span class="s2">&quot;x,y</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;d,4</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">&quot;aa&quot;</span><span class="s0">, </span><span class="s2">&quot;bb&quot;</span><span class="s1">]</span><span class="s0">, False, </span><span class="s2">&quot;aa,bb</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;aa,bb</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">([</span><span class="s2">&quot;aa&quot;</span><span class="s0">, </span><span class="s2">&quot;bb&quot;</span><span class="s1">]</span><span class="s0">, True, </span><span class="s2">&quot;aa,bb</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s0">, </span><span class="s2">&quot;d,4</span><span class="s0">\n</span><span class="s2">&quot;</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_to_csv_header(</span>
    <span class="s1">header</span><span class="s0">, </span><span class="s1">header_first_partition_only</span><span class="s0">, </span><span class="s1">expected_first</span><span class="s0">, </span><span class="s1">expected_next</span>
<span class="s1">):</span>
    <span class="s1">partition_count = </span><span class="s4">2</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s2">&quot;f&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s2">&quot;y&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">3</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=partition_count)</span>

    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s3"># Test NO header case</span>
        <span class="s3"># (header=False, header_first_chunk_only not passed)</span>
        <span class="s1">ddf.to_csv(</span>
            <span class="s1">os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooa*.csv&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">index=</span><span class="s0">False,</span>
            <span class="s1">header=header</span><span class="s0">,</span>
            <span class="s1">header_first_partition_only=header_first_partition_only</span><span class="s0">,</span>
        <span class="s1">)</span>
        <span class="s1">filename = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooa0.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(filename) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">line = fp.readline()</span>
            <span class="s0">assert </span><span class="s1">line == expected_first</span>
        <span class="s1">os.remove(filename)</span>

        <span class="s1">filename = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;fooa1.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(filename) </span><span class="s0">as </span><span class="s1">fp:</span>
            <span class="s1">line = fp.readline()</span>
            <span class="s0">assert </span><span class="s1">line == expected_next</span>
        <span class="s1">os.remove(filename)</span>


<span class="s0">def </span><span class="s1">test_to_csv_line_ending():</span>
    <span class="s1">df = pd.DataFrame({</span><span class="s2">&quot;x&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s1">]})</span>
    <span class="s1">ddf = dd.from_pandas(df</span><span class="s0">, </span><span class="s1">npartitions=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">expected = {</span><span class="s5">b&quot;0</span><span class="s0">\r\n</span><span class="s5">&quot;</span><span class="s0">, </span><span class="s5">b&quot;0</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s1">}  </span><span class="s3"># either/or</span>
    <span class="s3"># For comparison...</span>
    <span class="s3"># unexpected = {b'0\r\r\n'}</span>
    <span class="s3"># This test addresses GH4809, and checks that only (at most) one</span>
    <span class="s3">#  '\r' character is written per line when writing to csv.</span>
    <span class="s3">#  In case it's correct (on UNIX) to have no '\r' at all, this test</span>
    <span class="s3">#  considers either '\r\n' or '\n' as appropriate line endings,</span>
    <span class="s3">#  but not '\r\r\n'.</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">dn:</span>
        <span class="s1">ddf.to_csv(os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;foo*.csv&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">False, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">filename = os.path.join(dn</span><span class="s0">, </span><span class="s2">&quot;foo0.csv&quot;</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">open(filename</span><span class="s0">, </span><span class="s2">&quot;rb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
            <span class="s1">raw = f.read()</span>
    <span class="s0">assert </span><span class="s1">raw </span><span class="s0">in </span><span class="s1">expected</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;block_lists&quot;</span><span class="s0">,</span>
    <span class="s1">[</span>
        <span class="s1">[[</span><span class="s4">1</span><span class="s0">, </span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">4</span><span class="s0">, </span><span class="s4">5</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">[[]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">[</span><span class="s4">1</span><span class="s1">]]</span><span class="s0">,</span>
        <span class="s1">[list(range(i)) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">10</span><span class="s1">)]</span><span class="s0">,</span>
    <span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_block_mask(block_lists):</span>
    <span class="s1">mask = list(block_mask(block_lists))</span>
    <span class="s0">assert </span><span class="s1">len(mask) == len(list(flatten(block_lists)))</span>


<span class="s0">def </span><span class="s1">test_reading_empty_csv_files_with_path():</span>
    <span class="s0">with </span><span class="s1">tmpdir() </span><span class="s0">as </span><span class="s1">tdir:</span>
        <span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">content </span><span class="s0">in </span><span class="s1">enumerate([</span><span class="s2">&quot;0, 1, 2&quot;</span><span class="s0">, </span><span class="s2">&quot;&quot;</span><span class="s0">, </span><span class="s2">&quot;6, 7, 8&quot;</span><span class="s1">]):</span>
            <span class="s0">with </span><span class="s1">open(os.path.join(tdir</span><span class="s0">, </span><span class="s1">str(k) + </span><span class="s2">&quot;.csv&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">file:</span>
                <span class="s1">file.write(content)</span>
        <span class="s1">result = dd.read_csv(</span>
            <span class="s1">os.path.join(tdir</span><span class="s0">, </span><span class="s2">&quot;*.csv&quot;</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">include_path_column=</span><span class="s0">True,</span>
            <span class="s1">converters={</span><span class="s2">&quot;path&quot;</span><span class="s1">: parse_filename}</span><span class="s0">,</span>
            <span class="s1">names=[</span><span class="s2">&quot;A&quot;</span><span class="s0">, </span><span class="s2">&quot;B&quot;</span><span class="s0">, </span><span class="s2">&quot;C&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">).compute()</span>
        <span class="s1">df = pd.DataFrame(</span>
            <span class="s1">{</span>
                <span class="s2">&quot;A&quot;</span><span class="s1">: [</span><span class="s4">0</span><span class="s0">, </span><span class="s4">6</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;B&quot;</span><span class="s1">: [</span><span class="s4">1</span><span class="s0">, </span><span class="s4">7</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;C&quot;</span><span class="s1">: [</span><span class="s4">2</span><span class="s0">, </span><span class="s4">8</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s2">&quot;path&quot;</span><span class="s1">: [</span><span class="s2">&quot;0.csv&quot;</span><span class="s0">, </span><span class="s2">&quot;2.csv&quot;</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s1">df[</span><span class="s2">&quot;path&quot;</span><span class="s1">] = df[</span><span class="s2">&quot;path&quot;</span><span class="s1">].astype(</span><span class="s2">&quot;category&quot;</span><span class="s1">)</span>
        <span class="s1">assert_eq(result</span><span class="s0">, </span><span class="s1">df</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_read_csv_groupby_get_group(tmpdir):</span>
    <span class="s3"># https://github.com/dask/dask/issues/7005</span>

    <span class="s1">path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
    <span class="s1">df1 = pd.DataFrame([{</span><span class="s2">&quot;foo&quot;</span><span class="s1">: </span><span class="s4">10</span><span class="s0">, </span><span class="s2">&quot;bar&quot;</span><span class="s1">: </span><span class="s4">4</span><span class="s1">}])</span>
    <span class="s1">df1.to_csv(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">ddf1 = dd.read_csv(path)</span>
    <span class="s1">ddfs = ddf1.groupby(</span><span class="s2">&quot;foo&quot;</span><span class="s1">)</span>

    <span class="s1">assert_eq(df1</span><span class="s0">, </span><span class="s1">ddfs.get_group(</span><span class="s4">10</span><span class="s1">).compute())</span>


<span class="s0">def </span><span class="s1">test_csv_getitem_column_order(tmpdir):</span>
    <span class="s3"># See: https://github.com/dask/dask/issues/7759</span>

    <span class="s1">path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
    <span class="s1">columns = list(</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz&quot;</span><span class="s1">)</span>
    <span class="s1">values = list(range(len(columns)))</span>

    <span class="s1">df1 = pd.DataFrame([{c: v </span><span class="s0">for </span><span class="s1">c</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">zip(columns</span><span class="s0">, </span><span class="s1">values)}])</span>
    <span class="s1">df1.to_csv(path)</span>

    <span class="s3"># Use disordered and duplicated column selection</span>
    <span class="s1">columns = list(</span><span class="s2">&quot;hczzkylaape&quot;</span><span class="s1">)</span>
    <span class="s1">df2 = dd.read_csv(path)[columns].head(</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(df1[columns]</span><span class="s0">, </span><span class="s1">df2)</span>


<span class="s1">@pytest.mark.skip_with_pyarrow_strings  </span><span class="s3"># checks graph layers</span>
<span class="s0">def </span><span class="s1">test_getitem_optimization_after_filter():</span>
    <span class="s0">with </span><span class="s1">filetext(timeseries) </span><span class="s0">as </span><span class="s1">fn:</span>
        <span class="s1">expect = pd.read_csv(fn)</span>
        <span class="s1">expect = expect[expect[</span><span class="s2">&quot;High&quot;</span><span class="s1">] &gt; </span><span class="s4">205.0</span><span class="s1">][[</span><span class="s2">&quot;Low&quot;</span><span class="s1">]]</span>
        <span class="s1">ddf = dd.read_csv(fn)</span>
        <span class="s1">ddf = ddf[ddf[</span><span class="s2">&quot;High&quot;</span><span class="s1">] &gt; </span><span class="s4">205.0</span><span class="s1">][[</span><span class="s2">&quot;Low&quot;</span><span class="s1">]]</span>

        <span class="s1">dsk = optimize_dataframe_getitem(ddf.dask</span><span class="s0">, </span><span class="s1">keys=[ddf._name])</span>
        <span class="s1">subgraph_rd = hlg_layer(dsk</span><span class="s0">, </span><span class="s2">&quot;read-csv&quot;</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(subgraph_rd</span><span class="s0">, </span><span class="s1">DataFrameIOLayer)</span>
        <span class="s0">assert </span><span class="s1">set(subgraph_rd.columns) == {</span><span class="s2">&quot;High&quot;</span><span class="s0">, </span><span class="s2">&quot;Low&quot;</span><span class="s1">}</span>
        <span class="s1">assert_eq(expect</span><span class="s0">, </span><span class="s1">ddf)</span>


<span class="s0">def </span><span class="s1">test_csv_parse_fail(tmpdir):</span>
    <span class="s3"># See GH #7680</span>
    <span class="s1">path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;test.csv&quot;</span><span class="s1">)</span>
    <span class="s1">data = </span><span class="s5">b'a,b</span><span class="s0">\n</span><span class="s5">1,&quot;hi</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">2,&quot;oi</span><span class="s0">\n</span><span class="s5">&quot;</span><span class="s0">\n</span><span class="s5">'</span>
    <span class="s1">expected = pd.read_csv(BytesIO(data))</span>
    <span class="s0">with </span><span class="s1">open(path</span><span class="s0">, </span><span class="s2">&quot;wb&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s1">f.write(data)</span>
    <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;EOF encountered&quot;</span><span class="s1">):</span>
        <span class="s1">dd.read_csv(path</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">13</span><span class="s1">)</span>
    <span class="s1">df = dd.read_csv(path</span><span class="s0">, </span><span class="s1">sample=</span><span class="s4">13</span><span class="s0">, </span><span class="s1">sample_rows=</span><span class="s4">1</span><span class="s1">)</span>
    <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">expected)</span>


<span class="s0">def </span><span class="s1">test_csv_name_should_be_different_even_if_head_is_same(tmpdir):</span>
    <span class="s3"># https://github.com/dask/dask/issues/7904</span>
    <span class="s0">import </span><span class="s1">random</span>
    <span class="s0">from </span><span class="s1">shutil </span><span class="s0">import </span><span class="s1">copyfile</span>

    <span class="s1">old_csv_path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;old.csv&quot;</span><span class="s1">)</span>
    <span class="s1">new_csv_path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;new_csv&quot;</span><span class="s1">)</span>

    <span class="s3"># Create random CSV</span>
    <span class="s0">with </span><span class="s1">open(old_csv_path</span><span class="s0">, </span><span class="s2">&quot;w&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">10</span><span class="s1">):</span>
            <span class="s1">f.write(</span>
                <span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}\n</span><span class="s2">&quot;</span>
            <span class="s1">)</span>

    <span class="s1">copyfile(old_csv_path</span><span class="s0">, </span><span class="s1">new_csv_path)</span>

    <span class="s3"># Add three new rows</span>
    <span class="s0">with </span><span class="s1">open(new_csv_path</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">) </span><span class="s0">as </span><span class="s1">f:</span>
        <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">3</span><span class="s1">):</span>
            <span class="s1">f.write(</span>
                <span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}</span><span class="s2">, </span><span class="s0">{</span><span class="s1">random.randrange(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">10</span><span class="s1">**</span><span class="s4">9</span><span class="s1">)</span><span class="s0">:</span><span class="s2">09</span><span class="s0">}\n</span><span class="s2">&quot;</span>
            <span class="s1">)</span>

    <span class="s1">new_df = dd.read_csv(</span>
        <span class="s1">new_csv_path</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s2">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=str</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s0">None</span>
    <span class="s1">)</span>
    <span class="s1">old_df = dd.read_csv(</span>
        <span class="s1">old_csv_path</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None, </span><span class="s1">delimiter=</span><span class="s2">&quot;,&quot;</span><span class="s0">, </span><span class="s1">dtype=str</span><span class="s0">, </span><span class="s1">blocksize=</span><span class="s0">None</span>
    <span class="s1">)</span>

    <span class="s0">assert </span><span class="s1">new_df.dask.keys() != old_df.dask.keys()</span>


<span class="s0">def </span><span class="s1">test_select_with_include_path_column(tmpdir):</span>
    <span class="s3"># https://github.com/dask/dask/issues/9518</span>

    <span class="s1">d = {</span><span class="s2">&quot;col1&quot;</span><span class="s1">: [i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">0</span><span class="s0">, </span><span class="s4">100</span><span class="s1">)]</span><span class="s0">, </span><span class="s2">&quot;col2&quot;</span><span class="s1">: [i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">100</span><span class="s0">, </span><span class="s4">200</span><span class="s1">)]}</span>
    <span class="s1">df = pd.DataFrame(data=d)</span>

    <span class="s1">temp_path = str(tmpdir) + </span><span class="s2">&quot;/&quot;</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s4">6</span><span class="s1">):</span>
        <span class="s1">df.to_csv(</span><span class="s2">f&quot;</span><span class="s0">{</span><span class="s1">temp_path</span><span class="s0">}</span><span class="s2">file_</span><span class="s0">{</span><span class="s1">i</span><span class="s0">}</span><span class="s2">.csv&quot;</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s1">ddf = dd.read_csv(temp_path + </span><span class="s2">&quot;*.csv&quot;</span><span class="s0">, </span><span class="s1">include_path_column=</span><span class="s0">True</span><span class="s1">)</span>

    <span class="s1">assert_eq(ddf.col1</span><span class="s0">, </span><span class="s1">pd.concat([df.col1] * </span><span class="s4">6</span><span class="s1">))</span>


<span class="s1">@pytest.mark.parametrize(</span><span class="s2">&quot;use_names&quot;</span><span class="s0">, </span><span class="s1">[</span><span class="s0">True, False</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">test_names_with_header_0(tmpdir</span><span class="s0">, </span><span class="s1">use_names):</span>
    <span class="s3"># This test sets `blocksize` so that we will</span>
    <span class="s3"># get two partitions in `dd.read_csv`. We are</span>
    <span class="s3"># testing that `header=0` results in the expected</span>
    <span class="s3"># behavior when `names` is also specified.</span>
    <span class="s3"># See: https://github.com/dask/dask/issues/9610</span>

    <span class="s1">csv = StringIO(</span>
        <span class="s2">&quot;&quot;&quot;</span><span class="s0">\ 
    </span><span class="s2">city1,1992-09-13,10 
    city2,1992-09-13,14 
    city3,1992-09-13,98 
    city4,1992-09-13,13 
    city5,1992-09-13,45 
    city6,1992-09-13,64 
    &quot;&quot;&quot;</span>
    <span class="s1">)</span>

    <span class="s0">if </span><span class="s1">use_names:</span>
        <span class="s1">names = [</span><span class="s2">&quot;city&quot;</span><span class="s0">, </span><span class="s2">&quot;date&quot;</span><span class="s0">, </span><span class="s2">&quot;sales&quot;</span><span class="s1">]</span>
        <span class="s1">usecols = [</span><span class="s2">&quot;city&quot;</span><span class="s0">, </span><span class="s2">&quot;sales&quot;</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">names = usecols = </span><span class="s0">None</span>

    <span class="s1">path = os.path.join(str(tmpdir)</span><span class="s0">, </span><span class="s2">&quot;input.csv&quot;</span><span class="s1">)</span>
    <span class="s1">pd.read_csv(csv</span><span class="s0">, </span><span class="s1">header=</span><span class="s0">None</span><span class="s1">).to_csv(path</span><span class="s0">, </span><span class="s1">index=</span><span class="s0">False, </span><span class="s1">header=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">df = pd.read_csv(path</span><span class="s0">, </span><span class="s1">header=</span><span class="s4">0</span><span class="s0">, </span><span class="s1">names=names</span><span class="s0">, </span><span class="s1">usecols=usecols)</span>
    <span class="s1">ddf = dd.read_csv(</span>
        <span class="s1">path</span><span class="s0">,</span>
        <span class="s1">header=</span><span class="s4">0</span><span class="s0">,</span>
        <span class="s1">names=names</span><span class="s0">,</span>
        <span class="s1">usecols=usecols</span><span class="s0">,</span>
        <span class="s1">blocksize=</span><span class="s4">60</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s3"># Result should only leave out 0th row</span>
    <span class="s1">assert_eq(df</span><span class="s0">, </span><span class="s1">ddf</span><span class="s0">, </span><span class="s1">check_index=</span><span class="s0">False</span><span class="s1">)</span>
</pre>
</body>
</html>