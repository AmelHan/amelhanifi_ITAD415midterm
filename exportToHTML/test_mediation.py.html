<html>
<head>
<title>test_mediation.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #808080;}
.s3 { color: #6a8759;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_mediation.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">import </span><span class="s1">statsmodels.api </span><span class="s0">as </span><span class="s1">sm</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">from </span><span class="s1">statsmodels.stats.mediation </span><span class="s0">import </span><span class="s1">Mediation</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span>
<span class="s0">import </span><span class="s1">patsy</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s2"># Compare to mediation R package vignette</span>
<span class="s1">df = [[</span><span class="s3">'index'</span><span class="s0">, </span><span class="s3">'Estimate'</span><span class="s0">, </span><span class="s3">'Lower CI bound'</span><span class="s0">, </span><span class="s3">'Upper CI bound'</span><span class="s0">, </span><span class="s3">'P-value'</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (control)'</span><span class="s0">, </span><span class="s4">0.085106</span><span class="s0">, </span><span class="s4">0.029938</span><span class="s0">, </span><span class="s4">0.141525</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (treated)'</span><span class="s0">, </span><span class="s4">0.085674</span><span class="s0">, </span><span class="s4">0.031089</span><span class="s0">, </span><span class="s4">0.147762</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (control)'</span><span class="s0">, </span><span class="s4">0.016938</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.129157</span><span class="s0">, </span><span class="s4">0.121945</span><span class="s0">, </span><span class="s4">0.66</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (treated)'</span><span class="s0">, </span><span class="s4">0.017506</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.139649</span><span class="s0">, </span><span class="s4">0.130030</span><span class="s0">, </span><span class="s4">0.66</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Total effect'</span><span class="s0">, </span><span class="s4">0.102612</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.036749</span><span class="s0">, </span><span class="s4">0.227213</span><span class="s0">, </span><span class="s4">0.20</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (control)'</span><span class="s0">, </span><span class="s4">0.698070</span><span class="s0">, </span><span class="s1">-</span><span class="s4">6.901715</span><span class="s0">, </span><span class="s4">2.725978</span><span class="s0">, </span><span class="s4">0.20</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (treated)'</span><span class="s0">, </span><span class="s4">0.718648</span><span class="s0">, </span><span class="s1">-</span><span class="s4">6.145419</span><span class="s0">, </span><span class="s4">2.510750</span><span class="s0">, </span><span class="s4">0.20</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (average)'</span><span class="s0">, </span><span class="s4">0.085390</span><span class="s0">, </span><span class="s4">0.030272</span><span class="s0">, </span><span class="s4">0.144768</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (average)'</span><span class="s0">, </span><span class="s4">0.017222</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.134465</span><span class="s0">, </span><span class="s4">0.125987</span><span class="s0">, </span><span class="s4">0.66</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (average)'</span><span class="s0">, </span><span class="s4">0.710900</span><span class="s0">, </span><span class="s1">-</span><span class="s4">6.523567</span><span class="s0">, </span><span class="s4">2.618364</span><span class="s0">, </span><span class="s4">0.20</span><span class="s1">]]</span>
<span class="s1">framing_boot_4231 = pd.DataFrame(df[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">columns=df[</span><span class="s4">0</span><span class="s1">]).set_index(</span><span class="s3">'index'</span><span class="s1">)</span>

<span class="s2"># Compare to mediation R package vignette</span>
<span class="s1">df = [[</span><span class="s3">'index'</span><span class="s0">, </span><span class="s3">'Estimate'</span><span class="s0">, </span><span class="s3">'Lower CI bound'</span><span class="s0">, </span><span class="s3">'Upper CI bound'</span><span class="s0">, </span><span class="s3">'P-value'</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (control)'</span><span class="s0">, </span><span class="s4">0.075529</span><span class="s0">, </span><span class="s4">0.024995</span><span class="s0">, </span><span class="s4">0.132408</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (treated)'</span><span class="s0">, </span><span class="s4">0.076348</span><span class="s0">, </span><span class="s4">0.027475</span><span class="s0">, </span><span class="s4">0.130138</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (control)'</span><span class="s0">, </span><span class="s4">0.021389</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.094323</span><span class="s0">, </span><span class="s4">0.139148</span><span class="s0">, </span><span class="s4">0.68</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (treated)'</span><span class="s0">, </span><span class="s4">0.022207</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.101239</span><span class="s0">, </span><span class="s4">0.145740</span><span class="s0">, </span><span class="s4">0.68</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Total effect'</span><span class="s0">, </span><span class="s4">0.097736</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.025384</span><span class="s0">, </span><span class="s4">0.225386</span><span class="s0">, </span><span class="s4">0.16</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (control)'</span><span class="s0">, </span><span class="s4">0.656820</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3.664956</span><span class="s0">, </span><span class="s4">4.845269</span><span class="s0">, </span><span class="s4">0.16</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (treated)'</span><span class="s0">, </span><span class="s4">0.687690</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3.449415</span><span class="s0">, </span><span class="s4">4.469289</span><span class="s0">, </span><span class="s4">0.16</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (average)'</span><span class="s0">, </span><span class="s4">0.075938</span><span class="s0">, </span><span class="s4">0.026109</span><span class="s0">, </span><span class="s4">0.129450</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (average)'</span><span class="s0">, </span><span class="s4">0.021798</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.097781</span><span class="s0">, </span><span class="s4">0.142444</span><span class="s0">, </span><span class="s4">0.68</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (average)'</span><span class="s0">, </span><span class="s4">0.669659</span><span class="s0">, </span><span class="s1">-</span><span class="s4">3.557185</span><span class="s0">, </span><span class="s4">4.657279</span><span class="s0">, </span><span class="s4">0.16</span><span class="s1">]]</span>
<span class="s1">framing_para_4231 = pd.DataFrame(df[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">columns=df[</span><span class="s4">0</span><span class="s1">]).set_index(</span><span class="s3">'index'</span><span class="s1">)</span>



<span class="s1">df = [[</span><span class="s3">'index'</span><span class="s0">, </span><span class="s3">'Estimate'</span><span class="s0">, </span><span class="s3">'Lower CI bound'</span><span class="s0">, </span><span class="s3">'Upper CI bound'</span><span class="s0">, </span><span class="s3">'P-value'</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (control)'</span><span class="s0">, </span><span class="s4">0.065989</span><span class="s0">, </span><span class="s4">0.003366</span><span class="s0">, </span><span class="s4">0.152261</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (treated)'</span><span class="s0">, </span><span class="s4">0.081424</span><span class="s0">, </span><span class="s4">0.008888</span><span class="s0">, </span><span class="s4">0.199853</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (control)'</span><span class="s0">, </span><span class="s4">0.240392</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.026286</span><span class="s0">, </span><span class="s4">0.470918</span><span class="s0">, </span><span class="s4">0.08</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (treated)'</span><span class="s0">, </span><span class="s4">0.255827</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.030681</span><span class="s0">, </span><span class="s4">0.491535</span><span class="s0">, </span><span class="s4">0.08</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Total effect'</span><span class="s0">, </span><span class="s4">0.321816</span><span class="s0">, </span><span class="s4">0.037238</span><span class="s0">, </span><span class="s4">0.549530</span><span class="s0">, </span><span class="s4">0.00</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (control)'</span><span class="s0">, </span><span class="s4">0.196935</span><span class="s0">, </span><span class="s4">0.015232</span><span class="s0">, </span><span class="s4">1.864804</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (treated)'</span><span class="s0">, </span><span class="s4">0.248896</span><span class="s0">, </span><span class="s4">0.032229</span><span class="s0">, </span><span class="s4">1.738846</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ACME (average)'</span><span class="s0">, </span><span class="s4">0.073707</span><span class="s0">, </span><span class="s4">0.006883</span><span class="s0">, </span><span class="s4">0.169923</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'ADE (average)'</span><span class="s0">, </span><span class="s4">0.248109</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.028483</span><span class="s0">, </span><span class="s4">0.478978</span><span class="s0">, </span><span class="s4">0.08</span><span class="s1">]</span><span class="s0">,</span>
      <span class="s1">[</span><span class="s3">'Prop. mediated (average)'</span><span class="s0">, </span><span class="s4">0.226799</span><span class="s0">, </span><span class="s4">0.028865</span><span class="s0">, </span><span class="s4">1.801825</span><span class="s0">, </span><span class="s4">0.04</span><span class="s1">]]</span>
<span class="s1">framing_moderated_4231 = pd.DataFrame(df[</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">, </span><span class="s1">columns=df[</span><span class="s4">0</span><span class="s1">]).set_index(</span><span class="s3">'index'</span><span class="s1">)</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_framing_example():</span>

    <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
    <span class="s1">data = pd.read_csv(os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">&quot;framing.csv&quot;</span><span class="s1">))</span>

    <span class="s1">outcome = np.asarray(data[</span><span class="s3">&quot;cong_mesg&quot;</span><span class="s1">])</span>
    <span class="s1">outcome_exog = patsy.dmatrix(</span><span class="s3">&quot;emo + treat + age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data</span><span class="s0">,</span>
                                  <span class="s1">return_type=</span><span class="s3">'dataframe'</span><span class="s1">)</span>
    <span class="s1">outcome_model = sm.GLM(</span>
        <span class="s1">outcome</span><span class="s0">,</span>
        <span class="s1">outcome_exog</span><span class="s0">,</span>
        <span class="s1">family=sm.families.Binomial(link=sm.families.links.Probit())</span>
    <span class="s1">)</span>

    <span class="s1">mediator = np.asarray(data[</span><span class="s3">&quot;emo&quot;</span><span class="s1">])</span>
    <span class="s1">mediator_exog = patsy.dmatrix(</span><span class="s3">&quot;treat + age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data</span><span class="s0">,</span>
                                 <span class="s1">return_type=</span><span class="s3">'dataframe'</span><span class="s1">)</span>
    <span class="s1">mediator_model = sm.OLS(mediator</span><span class="s0">, </span><span class="s1">mediator_exog)</span>

    <span class="s1">tx_pos = [outcome_exog.columns.tolist().index(</span><span class="s3">&quot;treat&quot;</span><span class="s1">)</span><span class="s0">,</span>
              <span class="s1">mediator_exog.columns.tolist().index(</span><span class="s3">&quot;treat&quot;</span><span class="s1">)]</span>
    <span class="s1">med_pos = outcome_exog.columns.tolist().index(</span><span class="s3">&quot;emo&quot;</span><span class="s1">)</span>

    <span class="s1">med = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s1">tx_pos</span><span class="s0">, </span><span class="s1">med_pos</span><span class="s0">,</span>
                    <span class="s1">outcome_fit_kwargs={</span><span class="s3">'atol'</span><span class="s1">:</span><span class="s4">1e-11</span><span class="s1">})</span>

    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">para_rslt = med.fit(method=</span><span class="s3">'parametric'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">diff = np.asarray(para_rslt.summary() - framing_para_4231)</span>
    <span class="s1">assert_allclose(diff</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">boot_rslt = med.fit(method=</span><span class="s3">'boot'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">diff = np.asarray(boot_rslt.summary() - framing_boot_4231)</span>
    <span class="s1">assert_allclose(diff</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>



<span class="s0">def </span><span class="s1">test_framing_example_moderator():</span>
    <span class="s2"># moderation without formulas, generally not useful but test anyway</span>

    <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
    <span class="s1">data = pd.read_csv(os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">&quot;framing.csv&quot;</span><span class="s1">))</span>

    <span class="s1">outcome = np.asarray(data[</span><span class="s3">&quot;cong_mesg&quot;</span><span class="s1">])</span>
    <span class="s1">outcome_exog = patsy.dmatrix(</span><span class="s3">&quot;emo + treat + age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data</span><span class="s0">,</span>
                                  <span class="s1">return_type=</span><span class="s3">'dataframe'</span><span class="s1">)</span>
    <span class="s1">outcome_model = sm.GLM(</span>
        <span class="s1">outcome</span><span class="s0">,</span>
        <span class="s1">outcome_exog</span><span class="s0">,</span>
        <span class="s1">family=sm.families.Binomial(link=sm.families.links.Probit())</span>
    <span class="s1">)</span>

    <span class="s1">mediator = np.asarray(data[</span><span class="s3">&quot;emo&quot;</span><span class="s1">])</span>
    <span class="s1">mediator_exog = patsy.dmatrix(</span><span class="s3">&quot;treat + age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data</span><span class="s0">,</span>
                                 <span class="s1">return_type=</span><span class="s3">'dataframe'</span><span class="s1">)</span>
    <span class="s1">mediator_model = sm.OLS(mediator</span><span class="s0">, </span><span class="s1">mediator_exog)</span>

    <span class="s1">tx_pos = [outcome_exog.columns.tolist().index(</span><span class="s3">&quot;treat&quot;</span><span class="s1">)</span><span class="s0">,</span>
              <span class="s1">mediator_exog.columns.tolist().index(</span><span class="s3">&quot;treat&quot;</span><span class="s1">)]</span>
    <span class="s1">med_pos = outcome_exog.columns.tolist().index(</span><span class="s3">&quot;emo&quot;</span><span class="s1">)</span>

    <span class="s1">ix = (outcome_exog.columns.tolist().index(</span><span class="s3">&quot;age&quot;</span><span class="s1">)</span><span class="s0">,</span>
          <span class="s1">mediator_exog.columns.tolist().index(</span><span class="s3">&quot;age&quot;</span><span class="s1">))</span>
    <span class="s1">moderators = {ix : </span><span class="s4">20</span><span class="s1">}</span>
    <span class="s1">med = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s1">tx_pos</span><span class="s0">, </span><span class="s1">med_pos</span><span class="s0">,</span>
                    <span class="s1">moderators=moderators)</span>

    <span class="s2"># Just a smoke test</span>
    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">med_rslt = med.fit(method=</span><span class="s3">'parametric'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_framing_example_formula():</span>

    <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
    <span class="s1">data = pd.read_csv(os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">&quot;framing.csv&quot;</span><span class="s1">))</span>

    <span class="s1">outcome_model = sm.GLM.from_formula(</span>
        <span class="s3">&quot;cong_mesg ~ emo + treat + age + educ + gender + income&quot;</span><span class="s0">,</span>
        <span class="s1">data</span><span class="s0">,</span>
        <span class="s1">family=sm.families.Binomial(link=sm.families.links.Probit())</span>
    <span class="s1">)</span>

    <span class="s1">mediator_model = sm.OLS.from_formula(</span><span class="s3">&quot;emo ~ treat + age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s1">med = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s3">&quot;treat&quot;</span><span class="s0">, </span><span class="s3">&quot;emo&quot;</span><span class="s0">,</span>
                    <span class="s1">outcome_fit_kwargs={</span><span class="s3">'atol'</span><span class="s1">: </span><span class="s4">1e-11</span><span class="s1">})</span>

    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">med_rslt = med.fit(method=</span><span class="s3">'boot'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">diff = np.asarray(med_rslt.summary() - framing_boot_4231)</span>
    <span class="s1">assert_allclose(diff</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">med_rslt = med.fit(method=</span><span class="s3">'parametric'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">diff = np.asarray(med_rslt.summary() - framing_para_4231)</span>
    <span class="s1">assert_allclose(diff</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s1">@pytest.mark.slow</span>
<span class="s0">def </span><span class="s1">test_framing_example_moderator_formula():</span>

    <span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
    <span class="s1">data = pd.read_csv(os.path.join(cur_dir</span><span class="s0">, </span><span class="s3">'results'</span><span class="s0">, </span><span class="s3">&quot;framing.csv&quot;</span><span class="s1">))</span>

    <span class="s1">outcome_model = sm.GLM.from_formula(</span>
        <span class="s3">&quot;cong_mesg ~ emo + treat*age + emo*age + educ + gender + income&quot;</span><span class="s0">,</span>
        <span class="s1">data</span><span class="s0">,</span>
        <span class="s1">family=sm.families.Binomial(link=sm.families.links.Probit())</span>
    <span class="s1">)</span>

    <span class="s1">mediator_model = sm.OLS.from_formula(</span><span class="s3">&quot;emo ~ treat*age + educ + gender + income&quot;</span><span class="s0">, </span><span class="s1">data)</span>

    <span class="s1">moderators = {</span><span class="s3">&quot;age&quot; </span><span class="s1">: </span><span class="s4">20</span><span class="s1">}</span>
    <span class="s1">med = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s3">&quot;treat&quot;</span><span class="s0">, </span><span class="s3">&quot;emo&quot;</span><span class="s0">,</span>
                    <span class="s1">moderators=moderators)</span>

    <span class="s1">np.random.seed(</span><span class="s4">4231</span><span class="s1">)</span>
    <span class="s1">med_rslt = med.fit(method=</span><span class="s3">'parametric'</span><span class="s0">, </span><span class="s1">n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">diff = np.asarray(med_rslt.summary() - framing_moderated_4231)</span>
    <span class="s1">assert_allclose(diff</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">t_est_mixedlm():</span>

    <span class="s2"># check backwards compat of np.random</span>
    <span class="s1">np.random.seed(</span><span class="s4">3424</span><span class="s1">)</span>
    <span class="s1">mn = np.random.randn(</span><span class="s4">5</span><span class="s1">)</span>
    <span class="s1">c = </span><span class="s4">1e-4 </span><span class="s1">* (np.random.rand(</span><span class="s4">5</span><span class="s0">, </span><span class="s4">5</span><span class="s1">) - </span><span class="s4">0.5</span><span class="s1">)</span>
    <span class="s1">cov = np.eye(</span><span class="s4">5</span><span class="s1">) + c + c.T</span>
    <span class="s1">rvs = np.random.multivariate_normal(mn</span><span class="s0">, </span><span class="s1">cov)</span>
    <span class="s1">rvs1 = [</span><span class="s4">0.3357151</span><span class="s0">, </span><span class="s4">1.26183927</span><span class="s0">, </span><span class="s4">1.22539916</span><span class="s0">, </span><span class="s4">0.85838887</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.0493799</span><span class="s1">]</span>
    <span class="s1">assert_allclose(rvs</span><span class="s0">, </span><span class="s1">rvs1</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>

    <span class="s1">np.random.seed(</span><span class="s4">3424</span><span class="s1">)</span>

    <span class="s1">n = </span><span class="s4">200</span>

    <span class="s2"># The exposure (not time varying)</span>
    <span class="s1">x = np.random.normal(size=n)</span>
    <span class="s1">xv = np.outer(x</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">3</span><span class="s1">))</span>

    <span class="s2"># The mediator (with random intercept)</span>
    <span class="s1">mx = np.asarray([</span><span class="s4">4.</span><span class="s0">, </span><span class="s4">4</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">mx /= np.sqrt(np.sum(mx**</span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">med = mx[</span><span class="s4">0</span><span class="s1">] * np.outer(x</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">med += mx[</span><span class="s4">1</span><span class="s1">] * np.outer(np.random.normal(size=n)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">med += mx[</span><span class="s4">2</span><span class="s1">] * np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>

    <span class="s2"># The outcome (exposure and mediator effects)</span>
    <span class="s1">ey = np.outer(x</span><span class="s0">, </span><span class="s1">np.r_[</span><span class="s4">0</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s4">1</span><span class="s1">]) + med</span>

    <span class="s2"># Random structure of the outcome (random intercept and slope)</span>
    <span class="s1">ex = np.asarray([</span><span class="s4">5.</span><span class="s0">, </span><span class="s4">2</span><span class="s0">, </span><span class="s4">2</span><span class="s1">])</span>
    <span class="s1">ex /= np.sqrt(np.sum(ex**</span><span class="s4">2</span><span class="s1">))</span>
    <span class="s1">e = ex[</span><span class="s4">0</span><span class="s1">] * np.outer(np.random.normal(size=n)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">e += ex[</span><span class="s4">1</span><span class="s1">] * np.outer(np.random.normal(size=n)</span><span class="s0">, </span><span class="s1">np.r_[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>
    <span class="s1">e += ex[</span><span class="s4">2</span><span class="s1">] * np.random.normal(size=(n</span><span class="s0">, </span><span class="s4">3</span><span class="s1">))</span>
    <span class="s1">y = ey + e</span>

    <span class="s2"># Group membership</span>
    <span class="s1">idx = np.outer(np.arange(n)</span><span class="s0">, </span><span class="s1">np.ones(</span><span class="s4">3</span><span class="s1">))</span>

    <span class="s2"># Time</span>
    <span class="s1">tim = np.outer(np.ones(n)</span><span class="s0">, </span><span class="s1">np.r_[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s4">1</span><span class="s1">])</span>

    <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;y&quot;</span><span class="s1">: y.flatten()</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s1">: xv.flatten()</span><span class="s0">,</span>
                       <span class="s3">&quot;id&quot;</span><span class="s1">: idx.flatten()</span><span class="s0">, </span><span class="s3">&quot;time&quot;</span><span class="s1">: tim.flatten()</span><span class="s0">,</span>
                       <span class="s3">&quot;med&quot;</span><span class="s1">: med.flatten()})</span>

    <span class="s2"># check data is unchanged, regression numbers</span>
    <span class="s1">dmean = [-</span><span class="s4">0.13643661</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.14266871</span><span class="s0">, </span><span class="s4">99.5</span><span class="s0">, </span><span class="s4">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">0.15102166</span><span class="s1">]</span>
    <span class="s1">assert_allclose(np.asarray(df.mean())</span><span class="s0">, </span><span class="s1">dmean</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>

    <span class="s1">mediator_model = sm.MixedLM.from_formula(</span><span class="s3">&quot;med ~ x&quot;</span><span class="s0">, </span><span class="s1">groups=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">data=df)</span>
    <span class="s1">outcome_model = sm.MixedLM.from_formula(</span><span class="s3">&quot;y ~ med + x&quot;</span><span class="s0">, </span><span class="s1">groups=</span><span class="s3">&quot;id&quot;</span><span class="s0">, </span><span class="s1">data=df)</span>
    <span class="s1">me = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s3">&quot;x&quot;</span><span class="s0">, </span><span class="s3">&quot;med&quot;</span><span class="s1">)</span>
    <span class="s1">np.random.seed(</span><span class="s4">383628</span><span class="s1">)</span>
    <span class="s1">mr = me.fit(n_rep=</span><span class="s4">100</span><span class="s1">)</span>
    <span class="s1">st = mr.summary()</span>

    <span class="s2"># check model results unchanged, regression numbers</span>
    <span class="s1">params_om = me.outcome_model.fit().params.to_numpy()</span>
    <span class="s1">p_om = [</span><span class="s4">0.08118371</span><span class="s0">, </span><span class="s4">0.96107436</span><span class="s0">, </span><span class="s4">0.50801102</span><span class="s0">, </span><span class="s4">1.22452252</span><span class="s1">]</span>
    <span class="s1">assert_allclose(params_om</span><span class="s0">, </span><span class="s1">p_om</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>
    <span class="s1">params_mm = me.mediator_model.fit().params.to_numpy()</span>
    <span class="s1">p_mm = [-</span><span class="s4">0.0547506</span><span class="s0">, </span><span class="s4">0.67478745</span><span class="s0">, </span><span class="s4">17.03184275</span><span class="s1">]</span>
    <span class="s1">assert_allclose(params_mm</span><span class="s0">, </span><span class="s1">p_mm</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-7</span><span class="s1">)</span>

    <span class="s2"># more regression numbers</span>
    <span class="s1">res_summ = np.array([</span>
        <span class="s1">[</span><span class="s4">0.64539794</span><span class="s0">, </span><span class="s4">0.57652012</span><span class="s0">, </span><span class="s4">0.71427576</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.64539794</span><span class="s0">, </span><span class="s4">0.57652012</span><span class="s0">, </span><span class="s4">0.71427576</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.59401941</span><span class="s0">, </span><span class="s4">0.56963807</span><span class="s0">, </span><span class="s4">0.61840074</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.59401941</span><span class="s0">, </span><span class="s4">0.56963807</span><span class="s0">, </span><span class="s4">0.61840074</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">1.23941735</span><span class="s0">, </span><span class="s4">1.14615820</span><span class="s0">, </span><span class="s4">1.33267651</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.51935169</span><span class="s0">, </span><span class="s4">0.50285723</span><span class="s0">, </span><span class="s4">0.53584615</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.51935169</span><span class="s0">, </span><span class="s4">0.50285723</span><span class="s0">, </span><span class="s4">0.53584615</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.64539794</span><span class="s0">, </span><span class="s4">0.57652012</span><span class="s0">, </span><span class="s4">0.71427576</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.59401941</span><span class="s0">, </span><span class="s4">0.56963807</span><span class="s0">, </span><span class="s4">0.61840074</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">[</span><span class="s4">0.51935169</span><span class="s0">, </span><span class="s4">0.50285723</span><span class="s0">, </span><span class="s4">0.53584615</span><span class="s0">, </span><span class="s4">0.0</span><span class="s1">]</span>
        <span class="s1">])</span>

    <span class="s1">assert_allclose(st.to_numpy()</span><span class="s0">, </span><span class="s1">res_summ</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.15</span><span class="s1">)</span>
    <span class="s1">assert_allclose(st.iloc[-</span><span class="s4">1</span><span class="s0">, </span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.56</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-2</span><span class="s1">)</span>

    <span class="s1">pm = st.loc[</span><span class="s3">&quot;Prop. mediated (average)&quot;</span><span class="s0">, </span><span class="s3">&quot;Estimate&quot;</span><span class="s1">]</span>
    <span class="s1">assert_allclose(pm</span><span class="s0">, </span><span class="s4">0.56</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-2</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-2</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">test_surv():</span>

    <span class="s1">np.random.seed(</span><span class="s4">2341</span><span class="s1">)</span>

    <span class="s1">n = </span><span class="s4">1000</span>

    <span class="s2"># Generate exposures</span>
    <span class="s1">exp = np.random.normal(size=n)</span>

    <span class="s2"># Generate mediators</span>
    <span class="s1">mn = np.exp(exp)</span>
    <span class="s1">mtime0 = -mn * np.log(np.random.uniform(size=n))</span>
    <span class="s1">ctime = -</span><span class="s4">2 </span><span class="s1">* mn * np.log(np.random.uniform(size=n))</span>
    <span class="s1">mstatus = (ctime &gt;= mtime0).astype(int)</span>
    <span class="s1">mtime = np.where(mtime0 &lt;= ctime</span><span class="s0">, </span><span class="s1">mtime0</span><span class="s0">, </span><span class="s1">ctime)</span>

    <span class="s0">for </span><span class="s1">mt </span><span class="s0">in </span><span class="s3">&quot;full&quot;</span><span class="s0">, </span><span class="s3">&quot;partial&quot;</span><span class="s0">, </span><span class="s3">&quot;no&quot;</span><span class="s1">:</span>

        <span class="s2"># Outcome</span>
        <span class="s0">if </span><span class="s1">mt == </span><span class="s3">&quot;full&quot;</span><span class="s1">:</span>
            <span class="s1">lp = </span><span class="s4">0.5</span><span class="s1">*mtime0</span>
        <span class="s0">elif </span><span class="s1">mt == </span><span class="s3">&quot;partial&quot;</span><span class="s1">:</span>
            <span class="s1">lp = exp + mtime0</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">lp = exp</span>

        <span class="s2"># Generate outcomes</span>
        <span class="s1">mn = np.exp(-lp)</span>
        <span class="s1">ytime0 = -mn * np.log(np.random.uniform(size=n))</span>
        <span class="s1">ctime = -</span><span class="s4">2 </span><span class="s1">* mn * np.log(np.random.uniform(size=n))</span>
        <span class="s1">ystatus = (ctime &gt;= ytime0).astype(int)</span>
        <span class="s1">ytime = np.where(ytime0 &lt;= ctime</span><span class="s0">, </span><span class="s1">ytime0</span><span class="s0">, </span><span class="s1">ctime)</span>

        <span class="s1">df = pd.DataFrame({</span><span class="s3">&quot;ytime&quot;</span><span class="s1">: ytime</span><span class="s0">, </span><span class="s3">&quot;ystatus&quot;</span><span class="s1">: ystatus</span><span class="s0">,</span>
                           <span class="s3">&quot;mtime&quot;</span><span class="s1">: mtime</span><span class="s0">, </span><span class="s3">&quot;mstatus&quot;</span><span class="s1">: mstatus</span><span class="s0">,</span>
                           <span class="s3">&quot;exp&quot;</span><span class="s1">: exp})</span>

        <span class="s1">fml = </span><span class="s3">&quot;ytime ~ exp + mtime&quot;</span>
        <span class="s1">outcome_model = sm.PHReg.from_formula(fml</span><span class="s0">, </span><span class="s1">status=</span><span class="s3">&quot;ystatus&quot;</span><span class="s0">, </span><span class="s1">data=df)</span>
        <span class="s1">fml = </span><span class="s3">&quot;mtime ~ exp&quot;</span>
        <span class="s1">mediator_model = sm.PHReg.from_formula(fml</span><span class="s0">, </span><span class="s1">status=</span><span class="s3">&quot;mstatus&quot;</span><span class="s0">, </span><span class="s1">data=df)</span>

        <span class="s1">med = Mediation(outcome_model</span><span class="s0">, </span><span class="s1">mediator_model</span><span class="s0">, </span><span class="s3">&quot;exp&quot;</span><span class="s0">, </span><span class="s3">&quot;mtime&quot;</span><span class="s0">,</span>
                        <span class="s1">outcome_predict_kwargs={</span><span class="s3">&quot;pred_only&quot;</span><span class="s1">: </span><span class="s0">True</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s1">outcome_fit_kwargs={</span><span class="s3">&quot;method&quot;</span><span class="s1">: </span><span class="s3">&quot;lbfgs&quot;</span><span class="s1">}</span><span class="s0">,</span>
                        <span class="s1">mediator_fit_kwargs={</span><span class="s3">&quot;method&quot;</span><span class="s1">: </span><span class="s3">&quot;lbfgs&quot;</span><span class="s1">})</span>
        <span class="s1">med_result = med.fit(n_rep=</span><span class="s4">2</span><span class="s1">)</span>
        <span class="s1">dr = med_result.summary()</span>
        <span class="s1">pm = dr.loc[</span><span class="s3">&quot;Prop. mediated (average)&quot;</span><span class="s0">, </span><span class="s3">&quot;Estimate&quot;</span><span class="s1">]</span>
        <span class="s0">if </span><span class="s1">mt == </span><span class="s3">&quot;no&quot;</span><span class="s1">:</span>
            <span class="s1">assert_allclose(pm</span><span class="s0">, </span><span class="s4">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.1</span><span class="s1">)</span>
        <span class="s0">elif </span><span class="s1">mt == </span><span class="s3">&quot;full&quot;</span><span class="s1">:</span>
            <span class="s1">assert_allclose(pm</span><span class="s0">, </span><span class="s4">1</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.1</span><span class="s1">)</span>
        <span class="s0">else</span><span class="s1">:</span>
            <span class="s1">assert_allclose(pm</span><span class="s0">, </span><span class="s4">0.5</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">0.1</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.1</span><span class="s1">)</span>
</pre>
</body>
</html>