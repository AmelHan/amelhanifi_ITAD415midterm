<html>
<head>
<title>test_idl.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #629755; font-style: italic;}
.s4 { color: #808080;}
.s5 { color: #6897bb;}
.s6 { color: #a5c261;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_idl.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">os </span><span class="s0">import </span><span class="s1">path</span>
<span class="s0">import </span><span class="s1">warnings</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">(assert_equal</span><span class="s0">, </span><span class="s1">assert_array_equal</span><span class="s0">,</span>
                           <span class="s1">assert_</span><span class="s0">, </span><span class="s1">suppress_warnings)</span>
<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">from </span><span class="s1">scipy.io </span><span class="s0">import </span><span class="s1">readsav</span>
<span class="s0">from </span><span class="s1">scipy.io </span><span class="s0">import </span><span class="s1">_idl</span>

<span class="s1">DATA_PATH = path.join(path.dirname(__file__)</span><span class="s0">, </span><span class="s2">'data'</span><span class="s1">)</span>


<span class="s0">def </span><span class="s1">assert_identical(a</span><span class="s0">, </span><span class="s1">b):</span>
    <span class="s3">&quot;&quot;&quot;Assert whether value AND type are the same&quot;&quot;&quot;</span>
    <span class="s1">assert_equal(a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s0">if </span><span class="s1">type(b) </span><span class="s0">is </span><span class="s1">str:</span>
        <span class="s1">assert_equal(type(a)</span><span class="s0">, </span><span class="s1">type(b))</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s1">assert_equal(np.asarray(a).dtype.type</span><span class="s0">, </span><span class="s1">np.asarray(b).dtype.type)</span>


<span class="s0">def </span><span class="s1">assert_array_identical(a</span><span class="s0">, </span><span class="s1">b):</span>
    <span class="s3">&quot;&quot;&quot;Assert whether values AND type are the same&quot;&quot;&quot;</span>
    <span class="s1">assert_array_equal(a</span><span class="s0">, </span><span class="s1">b)</span>
    <span class="s1">assert_equal(a.dtype.type</span><span class="s0">, </span><span class="s1">b.dtype.type)</span>


<span class="s4"># Define vectorized ID function for pointer arrays</span>
<span class="s1">vect_id = np.vectorize(id)</span>


<span class="s0">class </span><span class="s1">TestIdict:</span>

    <span class="s0">def </span><span class="s1">test_idict(self):</span>
        <span class="s1">custom_dict = {</span><span class="s2">'a'</span><span class="s1">: np.int16(</span><span class="s5">999</span><span class="s1">)}</span>
        <span class="s1">original_id = id(custom_dict)</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_byte.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">idict=custom_dict</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(original_id</span><span class="s0">, </span><span class="s1">id(s))</span>
        <span class="s1">assert_(</span><span class="s2">'a' </span><span class="s0">in </span><span class="s1">s)</span>
        <span class="s1">assert_identical(s[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.int16(</span><span class="s5">999</span><span class="s1">))</span>
        <span class="s1">assert_identical(s[</span><span class="s2">'i8u'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.uint8(</span><span class="s5">234</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestScalars:</span>
    <span class="s4"># Test that scalar values are read in with the correct value and type</span>

    <span class="s0">def </span><span class="s1">test_byte(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_byte.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i8u</span><span class="s0">, </span><span class="s1">np.uint8(</span><span class="s5">234</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_int16(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_int16.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i16s</span><span class="s0">, </span><span class="s1">np.int16(-</span><span class="s5">23456</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_int32(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_int32.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i32s</span><span class="s0">, </span><span class="s1">np.int32(-</span><span class="s5">1234567890</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_float32(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_float32.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.f32</span><span class="s0">, </span><span class="s1">np.float32(-</span><span class="s5">3.1234567e+37</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_float64(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_float64.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.f64</span><span class="s0">, </span><span class="s1">np.float64(-</span><span class="s5">1.1976931348623157e+307</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_complex32(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_complex32.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.c32</span><span class="s0">, </span><span class="s1">np.complex64(</span><span class="s5">3.124442e13</span><span class="s1">-</span><span class="s5">2.312442e31j</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_bytes(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_string.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.s</span><span class="s0">, </span><span class="s1">np.bytes_(</span><span class="s2">&quot;The quick brown fox jumps over the lazy python&quot;</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_structure(self):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">test_complex64(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_complex64.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.c64</span><span class="s0">, </span><span class="s1">np.complex128(</span><span class="s5">1.1987253647623157e+112</span><span class="s1">-</span><span class="s5">5.1987258887729157e+307j</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_heap_pointer(self):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">test_object_reference(self):</span>
        <span class="s0">pass</span>

    <span class="s0">def </span><span class="s1">test_uint16(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_uint16.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i16u</span><span class="s0">, </span><span class="s1">np.uint16(</span><span class="s5">65511</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_uint32(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_uint32.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i32u</span><span class="s0">, </span><span class="s1">np.uint32(</span><span class="s5">4294967233</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_int64(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_int64.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i64s</span><span class="s0">, </span><span class="s1">np.int64(-</span><span class="s5">9223372036854774567</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_uint64(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_uint64.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i64u</span><span class="s0">, </span><span class="s1">np.uint64(</span><span class="s5">18446744073709529285</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestCompressed(TestScalars):</span>
    <span class="s4"># Test that compressed .sav files can be read in</span>

    <span class="s0">def </span><span class="s1">test_compressed(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'various_compressed.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">assert_identical(s.i8u</span><span class="s0">, </span><span class="s1">np.uint8(</span><span class="s5">234</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.f32</span><span class="s0">, </span><span class="s1">np.float32(-</span><span class="s5">3.1234567e+37</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.c64</span><span class="s0">, </span><span class="s1">np.complex128(</span><span class="s5">1.1987253647623157e+112</span><span class="s1">-</span><span class="s5">5.1987258887729157e+307j</span><span class="s1">))</span>
        <span class="s1">assert_equal(s.array5d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.arrays.a[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
        <span class="s1">assert_identical(s.arrays.b[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">4.</span><span class="s0">, </span><span class="s5">5.</span><span class="s0">, </span><span class="s5">6.</span><span class="s0">, </span><span class="s5">7.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
        <span class="s1">assert_identical(s.arrays.c[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([np.complex64(</span><span class="s5">1</span><span class="s1">+</span><span class="s5">2j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.complex64(</span><span class="s5">7</span><span class="s1">+</span><span class="s5">8j</span><span class="s1">)]))</span>
        <span class="s1">assert_identical(s.arrays.d[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s6">b&quot;cheese&quot;</span><span class="s0">, </span><span class="s6">b&quot;bacon&quot;</span><span class="s0">, </span><span class="s6">b&quot;spam&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span>


<span class="s0">class </span><span class="s1">TestArrayDimensions:</span>
    <span class="s4"># Test that multi-dimensional arrays are read in with the correct dimensions</span>

    <span class="s0">def </span><span class="s1">test_1d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_1d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array1d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">123</span><span class="s0">, </span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_2d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_2d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array2d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">22</span><span class="s0">, </span><span class="s5">12</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_3d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_3d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array3d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">11</span><span class="s0">, </span><span class="s5">22</span><span class="s0">, </span><span class="s5">12</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_4d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_4d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array4d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">8</span><span class="s0">, </span><span class="s5">7</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_5d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_5d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array5d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_6d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_6d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array6d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_7d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_7d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array7d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_8d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_8d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array8d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>


<span class="s0">class </span><span class="s1">TestStructures:</span>

    <span class="s0">def </span><span class="s1">test_scalars(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_scalars.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.scalars.a</span><span class="s0">, </span><span class="s1">np.array(np.int16(</span><span class="s5">1</span><span class="s1">)))</span>
        <span class="s1">assert_identical(s.scalars.b</span><span class="s0">, </span><span class="s1">np.array(np.int32(</span><span class="s5">2</span><span class="s1">)))</span>
        <span class="s1">assert_identical(s.scalars.c</span><span class="s0">, </span><span class="s1">np.array(np.float32(</span><span class="s5">3.</span><span class="s1">)))</span>
        <span class="s1">assert_identical(s.scalars.d</span><span class="s0">, </span><span class="s1">np.array(np.float64(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_identical(s.scalars.e</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s6">b&quot;spam&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span>
        <span class="s1">assert_identical(s.scalars.f</span><span class="s0">, </span><span class="s1">np.array(np.complex64(-</span><span class="s5">1.</span><span class="s1">+</span><span class="s5">3j</span><span class="s1">)))</span>

    <span class="s0">def </span><span class="s1">test_scalars_replicated(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_scalars_replicated.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.scalars_rep.a</span><span class="s0">, </span><span class="s1">np.repeat(np.int16(</span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.b</span><span class="s0">, </span><span class="s1">np.repeat(np.int32(</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.c</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">3.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.d</span><span class="s0">, </span><span class="s1">np.repeat(np.float64(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.e</span><span class="s0">, </span><span class="s1">np.repeat(</span><span class="s6">b&quot;spam&quot;</span><span class="s0">, </span><span class="s5">5</span><span class="s1">).astype(object))</span>
        <span class="s1">assert_identical(s.scalars_rep.f</span><span class="s0">, </span><span class="s1">np.repeat(np.complex64(-</span><span class="s5">1.</span><span class="s1">+</span><span class="s5">3j</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_scalars_replicated_3d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_scalars_replicated_3d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.scalars_rep.a</span><span class="s0">, </span><span class="s1">np.repeat(np.int16(</span><span class="s5">1</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.b</span><span class="s0">, </span><span class="s1">np.repeat(np.int32(</span><span class="s5">2</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.c</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">3.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.d</span><span class="s0">, </span><span class="s1">np.repeat(np.float64(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.scalars_rep.e</span><span class="s0">, </span><span class="s1">np.repeat(</span><span class="s6">b&quot;spam&quot;</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">).astype(object))</span>
        <span class="s1">assert_identical(s.scalars_rep.f</span><span class="s0">, </span><span class="s1">np.repeat(np.complex64(-</span><span class="s5">1.</span><span class="s1">+</span><span class="s5">3j</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

    <span class="s0">def </span><span class="s1">test_arrays(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_arrays.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_identical(s.arrays.a[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
        <span class="s1">assert_array_identical(s.arrays.b[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">4.</span><span class="s0">, </span><span class="s5">5.</span><span class="s0">, </span><span class="s5">6.</span><span class="s0">, </span><span class="s5">7.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
        <span class="s1">assert_array_identical(s.arrays.c[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([np.complex64(</span><span class="s5">1</span><span class="s1">+</span><span class="s5">2j</span><span class="s1">)</span><span class="s0">, </span><span class="s1">np.complex64(</span><span class="s5">7</span><span class="s1">+</span><span class="s5">8j</span><span class="s1">)]))</span>
        <span class="s1">assert_array_identical(s.arrays.d[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s6">b&quot;cheese&quot;</span><span class="s0">, </span><span class="s6">b&quot;bacon&quot;</span><span class="s0">, </span><span class="s6">b&quot;spam&quot;</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=object))</span>

    <span class="s0">def </span><span class="s1">test_arrays_replicated(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_arrays_replicated.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s4"># Check column types</span>
        <span class="s1">assert_(s.arrays_rep.a.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.b.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.c.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.d.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>

        <span class="s4"># Check column shapes</span>
        <span class="s1">assert_equal(s.arrays_rep.a.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.b.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.c.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>

        <span class="s4"># Check values</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">5</span><span class="s1">):</span>
            <span class="s1">assert_array_identical(s.arrays_rep.a[i]</span><span class="s0">,</span>
                                   <span class="s1">np.array([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
            <span class="s1">assert_array_identical(s.arrays_rep.b[i]</span><span class="s0">,</span>
                                   <span class="s1">np.array([</span><span class="s5">4.</span><span class="s0">, </span><span class="s5">5.</span><span class="s0">, </span><span class="s5">6.</span><span class="s0">, </span><span class="s5">7.</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.float32))</span>
            <span class="s1">assert_array_identical(s.arrays_rep.c[i]</span><span class="s0">,</span>
                                   <span class="s1">np.array([np.complex64(</span><span class="s5">1</span><span class="s1">+</span><span class="s5">2j</span><span class="s1">)</span><span class="s0">,</span>
                                             <span class="s1">np.complex64(</span><span class="s5">7</span><span class="s1">+</span><span class="s5">8j</span><span class="s1">)]))</span>
            <span class="s1">assert_array_identical(s.arrays_rep.d[i]</span><span class="s0">,</span>
                                   <span class="s1">np.array([</span><span class="s6">b&quot;cheese&quot;</span><span class="s0">, </span><span class="s6">b&quot;bacon&quot;</span><span class="s0">, </span><span class="s6">b&quot;spam&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                            <span class="s1">dtype=object))</span>

    <span class="s0">def </span><span class="s1">test_arrays_replicated_3d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_arrays_replicated_3d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s4"># Check column types</span>
        <span class="s1">assert_(s.arrays_rep.a.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.b.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.c.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.d.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>

        <span class="s4"># Check column shapes</span>
        <span class="s1">assert_equal(s.arrays_rep.a.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.b.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.c.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

        <span class="s4"># Check values</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">4</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
                <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.a[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                                           <span class="s1">np.array([</span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.b[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                                           <span class="s1">np.array([</span><span class="s5">4.</span><span class="s0">, </span><span class="s5">5.</span><span class="s0">, </span><span class="s5">6.</span><span class="s0">, </span><span class="s5">7.</span><span class="s1">]</span><span class="s0">,</span>
                                                    <span class="s1">dtype=np.float32))</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.c[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                                           <span class="s1">np.array([np.complex64(</span><span class="s5">1</span><span class="s1">+</span><span class="s5">2j</span><span class="s1">)</span><span class="s0">,</span>
                                                     <span class="s1">np.complex64(</span><span class="s5">7</span><span class="s1">+</span><span class="s5">8j</span><span class="s1">)]))</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.d[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                                           <span class="s1">np.array([</span><span class="s6">b&quot;cheese&quot;</span><span class="s0">, </span><span class="s6">b&quot;bacon&quot;</span><span class="s0">, </span><span class="s6">b&quot;spam&quot;</span><span class="s1">]</span><span class="s0">,</span>
                                                    <span class="s1">dtype=object))</span>

    <span class="s0">def </span><span class="s1">test_inheritance(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_inherit.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.fc.x</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
        <span class="s1">assert_identical(s.fc.y</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
        <span class="s1">assert_identical(s.fc.r</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>
        <span class="s1">assert_identical(s.fc.c</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">4</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.int16))</span>

    <span class="s0">def </span><span class="s1">test_arrays_corrupt_idl80(self):</span>
        <span class="s4"># test byte arrays with missing nbyte information from IDL 8.0 .sav file</span>
        <span class="s0">with </span><span class="s1">suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(UserWarning</span><span class="s0">, </span><span class="s2">&quot;Not able to verify number of bytes from header&quot;</span><span class="s1">)</span>
            <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">,</span><span class="s2">'struct_arrays_byte_idl80.sav'</span><span class="s1">)</span><span class="s0">,</span>
                        <span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s1">assert_identical(s.y.x[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s5">55</span><span class="s0">,</span><span class="s5">66</span><span class="s1">]</span><span class="s0">, </span><span class="s1">dtype=np.uint8))</span>


<span class="s0">class </span><span class="s1">TestPointers:</span>
    <span class="s4"># Check that pointers in .sav files produce references to the same object in Python</span>

    <span class="s0">def </span><span class="s1">test_pointers(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_heap_pointer.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.c64_pointer1</span><span class="s0">, </span><span class="s1">np.complex128(</span><span class="s5">1.1987253647623157e+112</span><span class="s1">-</span><span class="s5">5.1987258887729157e+307j</span><span class="s1">))</span>
        <span class="s1">assert_identical(s.c64_pointer2</span><span class="s0">, </span><span class="s1">np.complex128(</span><span class="s5">1.1987253647623157e+112</span><span class="s1">-</span><span class="s5">5.1987258887729157e+307j</span><span class="s1">))</span>
        <span class="s1">assert_(s.c64_pointer1 </span><span class="s0">is </span><span class="s1">s.c64_pointer2)</span>


<span class="s0">class </span><span class="s1">TestPointerArray:</span>
    <span class="s4"># Test that pointers in arrays are correctly read in</span>

    <span class="s0">def </span><span class="s1">test_1d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_1d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array1d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">123</span><span class="s0">, </span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array1d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array1d) == id(s.array1d[</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_2d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_2d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array2d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">22</span><span class="s0">, </span><span class="s5">12</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array2d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array2d) == id(s.array2d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_3d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_3d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array3d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">11</span><span class="s0">, </span><span class="s5">22</span><span class="s0">, </span><span class="s5">12</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array3d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array3d) == id(s.array3d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_4d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_4d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array4d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">8</span><span class="s0">, </span><span class="s5">7</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array4d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array4d) == id(s.array4d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_5d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_5d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array5d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">5</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array5d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array5d) == id(s.array5d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_6d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_6d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array6d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">3</span><span class="s0">, </span><span class="s5">6</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array6d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array6d) == id(s.array6d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_7d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_7d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array7d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array7d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array7d) == id(s.array7d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_8d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'array_float32_pointer_8d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(s.array8d.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">1</span><span class="s0">, </span><span class="s5">2</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">5</span><span class="s0">, </span><span class="s5">4</span><span class="s1">))</span>
        <span class="s1">assert_(np.all(s.array8d == np.float32(</span><span class="s5">4.</span><span class="s1">)))</span>
        <span class="s1">assert_(np.all(vect_id(s.array8d) == id(s.array8d[</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s0">,</span><span class="s5">0</span><span class="s1">])))</span>


<span class="s0">class </span><span class="s1">TestPointerStructures:</span>
    <span class="s4"># Test that structures are correctly read in</span>

    <span class="s0">def </span><span class="s1">test_scalars(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointers.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.pointers.g</span><span class="s0">, </span><span class="s1">np.array(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.object_))</span>
        <span class="s1">assert_identical(s.pointers.h</span><span class="s0">, </span><span class="s1">np.array(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s1">dtype=np.object_))</span>
        <span class="s1">assert_(id(s.pointers.g[</span><span class="s5">0</span><span class="s1">]) == id(s.pointers.h[</span><span class="s5">0</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_pointers_replicated(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointers_replicated.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.pointers_rep.g</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">).astype(np.object_))</span>
        <span class="s1">assert_identical(s.pointers_rep.h</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">5</span><span class="s1">).astype(np.object_))</span>
        <span class="s1">assert_(np.all(vect_id(s.pointers_rep.g) == vect_id(s.pointers_rep.h)))</span>

    <span class="s0">def </span><span class="s1">test_pointers_replicated_3d(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointers_replicated_3d.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">s_expect = np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">24</span><span class="s1">).reshape(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">).astype(np.object_)</span>
        <span class="s1">assert_identical(s.pointers_rep.g</span><span class="s0">, </span><span class="s1">s_expect)</span>
        <span class="s1">assert_identical(s.pointers_rep.h</span><span class="s0">, </span><span class="s1">s_expect)</span>
        <span class="s1">assert_(np.all(vect_id(s.pointers_rep.g) == vect_id(s.pointers_rep.h)))</span>

    <span class="s0">def </span><span class="s1">test_arrays(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointer_arrays.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_array_identical(s.arrays.g[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">2</span><span class="s1">).astype(np.object_))</span>
        <span class="s1">assert_array_identical(s.arrays.h[</span><span class="s5">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">3</span><span class="s1">).astype(np.object_))</span>
        <span class="s1">assert_(np.all(vect_id(s.arrays.g[</span><span class="s5">0</span><span class="s1">]) == id(s.arrays.g[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">assert_(np.all(vect_id(s.arrays.h[</span><span class="s5">0</span><span class="s1">]) == id(s.arrays.h[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>
        <span class="s1">assert_(id(s.arrays.g[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]) == id(s.arrays.h[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">]))</span>

    <span class="s0">def </span><span class="s1">test_arrays_replicated(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointer_arrays_replicated.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s4"># Check column types</span>
        <span class="s1">assert_(s.arrays_rep.g.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.h.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>

        <span class="s4"># Check column shapes</span>
        <span class="s1">assert_equal(s.arrays_rep.g.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.h.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">5</span><span class="s0">, </span><span class="s1">))</span>

        <span class="s4"># Check values</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">5</span><span class="s1">):</span>
            <span class="s1">assert_array_identical(s.arrays_rep.g[i]</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">2</span><span class="s1">).astype(np.object_))</span>
            <span class="s1">assert_array_identical(s.arrays_rep.h[i]</span><span class="s0">, </span><span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">3</span><span class="s1">).astype(np.object_))</span>
            <span class="s1">assert_(np.all(vect_id(s.arrays_rep.g[i]) == id(s.arrays_rep.g[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>
            <span class="s1">assert_(np.all(vect_id(s.arrays_rep.h[i]) == id(s.arrays_rep.h[</span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>

    <span class="s0">def </span><span class="s1">test_arrays_replicated_3d(self):</span>
        <span class="s1">pth = path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'struct_pointer_arrays_replicated_3d.sav'</span><span class="s1">)</span>
        <span class="s1">s = readsav(pth</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>

        <span class="s4"># Check column types</span>
        <span class="s1">assert_(s.arrays_rep.g.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>
        <span class="s1">assert_(s.arrays_rep.h.dtype.type </span><span class="s0">is </span><span class="s1">np.object_)</span>

        <span class="s4"># Check column shapes</span>
        <span class="s1">assert_equal(s.arrays_rep.g.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>
        <span class="s1">assert_equal(s.arrays_rep.h.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s5">4</span><span class="s0">, </span><span class="s5">3</span><span class="s0">, </span><span class="s5">2</span><span class="s1">))</span>

        <span class="s4"># Check values</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">4</span><span class="s1">):</span>
            <span class="s0">for </span><span class="s1">j </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">3</span><span class="s1">):</span>
                <span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">range(</span><span class="s5">2</span><span class="s1">):</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.g[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                            <span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">2</span><span class="s1">).astype(np.object_))</span>
                    <span class="s1">assert_array_identical(s.arrays_rep.h[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]</span><span class="s0">,</span>
                            <span class="s1">np.repeat(np.float32(</span><span class="s5">4.</span><span class="s1">)</span><span class="s0">, </span><span class="s5">3</span><span class="s1">).astype(np.object_))</span>
                    <span class="s1">assert_(np.all(vect_id(s.arrays_rep.g[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]) == id(s.arrays_rep.g[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>
                    <span class="s1">assert_(np.all(vect_id(s.arrays_rep.h[i</span><span class="s0">, </span><span class="s1">j</span><span class="s0">, </span><span class="s1">k]) == id(s.arrays_rep.h[</span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s0">, </span><span class="s5">0</span><span class="s1">][</span><span class="s5">0</span><span class="s1">])))</span>
<span class="s0">class </span><span class="s1">TestTags:</span>
    <span class="s3">'''Test that sav files with description tag read at all'''</span>

    <span class="s0">def </span><span class="s1">test_description(self):</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'scalar_byte_descr.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">assert_identical(s.i8u</span><span class="s0">, </span><span class="s1">np.uint8(</span><span class="s5">234</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_null_pointer():</span>
    <span class="s4"># Regression test for null pointers.</span>
    <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'null_pointer.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">assert_identical(s.point</span><span class="s0">, None</span><span class="s1">)</span>
    <span class="s1">assert_identical(s.check</span><span class="s0">, </span><span class="s1">np.int16(</span><span class="s5">5</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">test_invalid_pointer():</span>
    <span class="s4"># Regression test for invalid pointers (gh-4613).</span>

    <span class="s4"># In some files in the wild, pointers can sometimes refer to a heap</span>
    <span class="s4"># variable that does not exist. In that case, we now gracefully fail for</span>
    <span class="s4"># that variable and replace the variable with None and emit a warning.</span>
    <span class="s4"># Since it's difficult to artificially produce such files, the file used</span>
    <span class="s4"># here has been edited to force the pointer reference to be invalid.</span>
    <span class="s0">with </span><span class="s1">warnings.catch_warnings(record=</span><span class="s0">True</span><span class="s1">) </span><span class="s0">as </span><span class="s1">w:</span>
        <span class="s1">warnings.simplefilter(</span><span class="s2">&quot;always&quot;</span><span class="s1">)</span>
        <span class="s1">s = readsav(path.join(DATA_PATH</span><span class="s0">, </span><span class="s2">'invalid_pointer.sav'</span><span class="s1">)</span><span class="s0">, </span><span class="s1">verbose=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">assert_(len(w) == </span><span class="s5">1</span><span class="s1">)</span>
    <span class="s1">assert_(str(w[</span><span class="s5">0</span><span class="s1">].message) == (</span><span class="s2">&quot;Variable referenced by pointer not found in &quot;</span>
                                  <span class="s2">&quot;heap: variable will be set to None&quot;</span><span class="s1">))</span>
    <span class="s1">assert_identical(s[</span><span class="s2">'a'</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s0">None, None</span><span class="s1">]))</span>


<span class="s0">def </span><span class="s1">test_attrdict():</span>
    <span class="s1">d = _idl.AttrDict({</span><span class="s2">'one'</span><span class="s1">: </span><span class="s5">1</span><span class="s1">})</span>
    <span class="s0">assert </span><span class="s1">d[</span><span class="s2">'one'</span><span class="s1">] == </span><span class="s5">1</span>
    <span class="s0">assert </span><span class="s1">d.one == </span><span class="s5">1</span>
    <span class="s0">with </span><span class="s1">pytest.raises(KeyError):</span>
        <span class="s1">d[</span><span class="s2">'two'</span><span class="s1">]</span>
    <span class="s0">with </span><span class="s1">pytest.raises(AttributeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">'has no attribute'</span><span class="s1">):</span>
        <span class="s1">d.two</span>
</pre>
</body>
</html>