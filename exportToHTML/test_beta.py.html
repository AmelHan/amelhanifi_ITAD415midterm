<html>
<head>
<title>test_beta.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #808080;}
.s4 { color: #6897bb;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_beta.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">print_function</span>
<span class="s0">import </span><span class="s1">io</span>
<span class="s0">import </span><span class="s1">os</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s0">, </span><span class="s1">assert_equal</span>
<span class="s0">import </span><span class="s1">pandas </span><span class="s0">as </span><span class="s1">pd</span>
<span class="s0">import </span><span class="s1">patsy</span>
<span class="s0">from </span><span class="s1">statsmodels.api </span><span class="s0">import </span><span class="s1">families</span>
<span class="s0">from </span><span class="s1">statsmodels.tools.sm_exceptions </span><span class="s0">import </span><span class="s1">(</span>
    <span class="s1">ValueWarning</span><span class="s0">,</span>
    <span class="s1">)</span>
<span class="s0">from </span><span class="s1">statsmodels.othermod.betareg </span><span class="s0">import </span><span class="s1">BetaModel</span>
<span class="s0">from </span><span class="s1">.results </span><span class="s0">import </span><span class="s1">results_betareg </span><span class="s0">as </span><span class="s1">resultsb</span>

<span class="s1">links = families.links</span>

<span class="s1">cur_dir = os.path.dirname(os.path.abspath(__file__))</span>
<span class="s1">res_dir = os.path.join(cur_dir</span><span class="s0">, </span><span class="s2">&quot;results&quot;</span><span class="s1">)</span>


<span class="s3"># betareg(I(food/income) ~ income + persons, data = FoodExpenditure)</span>
<span class="s1">_income_estimates_mean = </span><span class="s2">u&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">varname        Estimate  StdError   zvalue     Pr(&gt;|z|) 
(Intercept) -0.62254806 0.223853539 -2.781051 5.418326e-03 
income      -0.01229884 0.003035585 -4.051556 5.087819e-05 
persons      0.11846210 0.035340667  3.352005 8.022853e-04&quot;&quot;&quot;</span>

<span class="s1">_income_estimates_precision = </span><span class="s2">u&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">varname  Estimate StdError  zvalue     Pr(&gt;|z|) 
(phi) 35.60975   8.079598 4.407366 1.046351e-05 
&quot;&quot;&quot;</span>

<span class="s1">_methylation_estimates_mean = </span><span class="s2">u&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">varname      Estimate StdError zvalue Pr(&gt;|z|) 
(Intercept)  1.44224    0.03401  42.404   2e-16 
genderM      0.06986    0.04359   1.603    0.109 
CpGCpG_1     0.60735    0.04834  12.563   2e-16 
CpGCpG_2     0.97355    0.05311  18.331   2e-16&quot;&quot;&quot;</span>

<span class="s1">_methylation_estimates_precision = </span><span class="s2">u&quot;&quot;&quot;</span><span class="s0">\ 
</span><span class="s2">varname Estimate StdError zvalue Pr(&gt;|z|) 
(Intercept)  8.22829    1.79098   4.594 4.34e-06 
age         -0.03471    0.03276  -1.059    0.289&quot;&quot;&quot;</span>


<span class="s1">expected_income_mean = pd.read_table(</span>
    <span class="s1">io.StringIO(_income_estimates_mean)</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">r&quot;\s+&quot;</span><span class="s1">)</span>
<span class="s1">expected_income_precision = pd.read_table(</span>
    <span class="s1">io.StringIO(_income_estimates_precision)</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">r&quot;\s+&quot;</span><span class="s1">)</span>

<span class="s1">expected_methylation_mean = pd.read_table(</span>
    <span class="s1">io.StringIO(_methylation_estimates_mean)</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">r&quot;\s+&quot;</span><span class="s1">)</span>
<span class="s1">expected_methylation_precision = pd.read_table(</span>
    <span class="s1">io.StringIO(_methylation_estimates_precision)</span><span class="s0">, </span><span class="s1">sep=</span><span class="s2">r&quot;\s+&quot;</span><span class="s1">)</span>

<span class="s1">income = pd.read_csv(os.path.join(res_dir</span><span class="s0">, </span><span class="s2">'foodexpenditure.csv'</span><span class="s1">))</span>
<span class="s1">methylation = pd.read_csv(os.path.join(res_dir</span><span class="s0">, </span><span class="s2">'methylation-test.csv'</span><span class="s1">))</span>


<span class="s0">def </span><span class="s1">check_same(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">eps</span><span class="s0">, </span><span class="s1">name):</span>
    <span class="s0">assert </span><span class="s1">np.allclose(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.01</span><span class="s0">, </span><span class="s1">atol=eps)</span><span class="s0">, </span><span class="s1">\</span>
            <span class="s1">(</span><span class="s2">&quot;different from expected&quot;</span><span class="s0">, </span><span class="s1">name</span><span class="s0">, </span><span class="s1">list(a)</span><span class="s0">, </span><span class="s1">list(b))</span>


<span class="s0">def </span><span class="s1">assert_close(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">eps):</span>
    <span class="s0">assert </span><span class="s1">np.allclose(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">0.01</span><span class="s0">, </span><span class="s1">atol=eps)</span><span class="s0">, </span><span class="s1">(list(a)</span><span class="s0">, </span><span class="s1">list(b))</span>


<span class="s0">class </span><span class="s1">TestBetaModel:</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">model = </span><span class="s2">&quot;I(food/income) ~ income + persons&quot;</span>
        <span class="s1">cls.income_fit = BetaModel.from_formula(model</span><span class="s0">, </span><span class="s1">income).fit()</span>

        <span class="s1">model = cls.model = </span><span class="s2">&quot;methylation ~ gender + CpG&quot;</span>
        <span class="s1">Z = cls.Z = patsy.dmatrix(</span><span class="s2">&quot;~ age&quot;</span><span class="s0">, </span><span class="s1">methylation)</span>
        <span class="s1">mod = BetaModel.from_formula(model</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">, </span><span class="s1">exog_precision=Z</span><span class="s0">,</span>
                                     <span class="s1">link_precision=links.Identity())</span>
        <span class="s1">cls.meth_fit = mod.fit()</span>
        <span class="s1">mod = BetaModel.from_formula(model</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">, </span><span class="s1">exog_precision=Z</span><span class="s0">,</span>
                                     <span class="s1">link_precision=links.Log())</span>
        <span class="s1">cls.meth_log_fit = mod.fit()</span>

    <span class="s0">def </span><span class="s1">test_income_coefficients(self):</span>
        <span class="s1">rslt = self.income_fit</span>
        <span class="s1">assert_close(rslt.params[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected_income_mean[</span><span class="s2">'Estimate'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_close(rslt.tvalues[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected_income_mean[</span><span class="s2">'zvalue'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">)</span>
        <span class="s1">assert_close(rslt.pvalues[:-</span><span class="s4">1</span><span class="s1">]</span><span class="s0">, </span><span class="s1">expected_income_mean[</span><span class="s2">'Pr(&gt;|z|)'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_income_precision(self):</span>

        <span class="s1">rslt = self.income_fit</span>
        <span class="s3"># note that we have to exp the phi results for now.</span>
        <span class="s1">assert_close(np.exp(rslt.params[-</span><span class="s4">1</span><span class="s1">:])</span><span class="s0">,</span>
                     <span class="s1">expected_income_precision[</span><span class="s2">'Estimate'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s3"># yield check_same, rslt.tvalues[-1:],</span>
        <span class="s3">#                   expected_income_precision['zvalue'], 0.1, &quot;z-score&quot;</span>
        <span class="s1">assert_close(rslt.pvalues[-</span><span class="s4">1</span><span class="s1">:]</span><span class="s0">,</span>
                     <span class="s1">expected_income_precision[</span><span class="s2">'Pr(&gt;|z|)'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-3</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_methylation_coefficients(self):</span>
        <span class="s1">rslt = self.meth_fit</span>
        <span class="s1">assert_close(rslt.params[:-</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">expected_methylation_mean[</span><span class="s2">'Estimate'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-2</span><span class="s1">)</span>
        <span class="s1">assert_close(rslt.tvalues[:-</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">expected_methylation_mean[</span><span class="s2">'zvalue'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">0.1</span><span class="s1">)</span>
        <span class="s1">assert_close(rslt.pvalues[:-</span><span class="s4">2</span><span class="s1">]</span><span class="s0">,</span>
                     <span class="s1">expected_methylation_mean[</span><span class="s2">'Pr(&gt;|z|)'</span><span class="s1">]</span><span class="s0">, </span><span class="s4">1e-2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_methylation_precision(self):</span>
        <span class="s3"># R results are from log link_precision</span>
        <span class="s1">rslt = self.meth_log_fit</span>
        <span class="s1">assert_allclose(rslt.params[-</span><span class="s4">2</span><span class="s1">:]</span><span class="s0">,</span>
                        <span class="s1">expected_methylation_precision[</span><span class="s2">'Estimate'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s4">1e-5</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s3">#     expected_methylation_precision['Estimate']</span>
        <span class="s3"># yield check_same, links.logit()(rslt.params[-2:]),</span>
        <span class="s3">#     expected_methylation_precision['Estimate'], 1e-3, &quot;estimate&quot;</span>
        <span class="s3"># yield check_same, rslt.tvalues[-2:],</span>
        <span class="s3">#     expected_methylation_precision['zvalue'], 0.1, &quot;z-score&quot;</span>

    <span class="s0">def </span><span class="s1">test_precision_formula(self):</span>
        <span class="s1">m = BetaModel.from_formula(self.model</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">,</span>
                                   <span class="s1">exog_precision_formula=</span><span class="s2">'~ age'</span><span class="s0">,</span>
                                   <span class="s1">link_precision=links.Identity())</span>
        <span class="s1">rslt = m.fit()</span>
        <span class="s1">assert_close(rslt.params</span><span class="s0">, </span><span class="s1">self.meth_fit.params</span><span class="s0">, </span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s0">assert </span><span class="s1">isinstance(rslt.params</span><span class="s0">, </span><span class="s1">pd.Series)</span>

        <span class="s0">with </span><span class="s1">pytest.warns(ValueWarning</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;unknown kwargs&quot;</span><span class="s1">):</span>
            <span class="s1">BetaModel.from_formula(self.model</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">,</span>
                                   <span class="s1">exog_precision_formula=</span><span class="s2">'~ age'</span><span class="s0">,</span>
                                   <span class="s1">link_precision=links.Identity()</span><span class="s0">,</span>
                                   <span class="s1">junk=</span><span class="s0">False</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_scores(self):</span>
        <span class="s1">model</span><span class="s0">, </span><span class="s1">Z = self.model</span><span class="s0">, </span><span class="s1">self.Z</span>
        <span class="s0">for </span><span class="s1">link </span><span class="s0">in </span><span class="s1">(links.Identity()</span><span class="s0">, </span><span class="s1">links.Log()):</span>
            <span class="s1">mod2 = BetaModel.from_formula(model</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">, </span><span class="s1">exog_precision=Z</span><span class="s0">,</span>
                                          <span class="s1">link_precision=link)</span>
            <span class="s1">rslt_m = mod2.fit()</span>

            <span class="s3"># evaluate away from optimum to get larger score</span>
            <span class="s1">analytical = rslt_m.model.score(rslt_m.params * </span><span class="s4">1.01</span><span class="s1">)</span>
            <span class="s1">numerical = rslt_m.model._score_check(rslt_m.params * </span><span class="s4">1.01</span><span class="s1">)</span>
            <span class="s1">assert_allclose(analytical</span><span class="s0">, </span><span class="s1">numerical</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_allclose(link.inverse(analytical[</span><span class="s4">3</span><span class="s1">:])</span><span class="s0">,</span>
                            <span class="s1">link.inverse(numerical[</span><span class="s4">3</span><span class="s1">:])</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">5e-7</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">5e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_results_other(self):</span>

        <span class="s1">rslt = self.meth_fit</span>
        <span class="s1">distr = rslt.get_distribution()</span>
        <span class="s1">mean</span><span class="s0">, </span><span class="s1">var = distr.stats()</span>
        <span class="s1">assert_allclose(rslt.fittedvalues</span><span class="s0">, </span><span class="s1">mean</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(rslt.model._predict_var(rslt.params)</span><span class="s0">, </span><span class="s1">var</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">resid = rslt.model.endog - mean</span>
        <span class="s1">assert_allclose(rslt.resid</span><span class="s0">, </span><span class="s1">resid</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-12</span><span class="s1">)</span>
        <span class="s1">assert_allclose(rslt.resid_pearson</span><span class="s0">, </span><span class="s1">resid / np.sqrt(var)</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-12</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestBetaMeth():</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">formula = </span><span class="s2">&quot;methylation ~ gender + CpG&quot;</span>
        <span class="s1">mod = BetaModel.from_formula(formula</span><span class="s0">, </span><span class="s1">methylation</span><span class="s0">,</span>
                                     <span class="s1">exog_precision_formula=</span><span class="s2">&quot;~ age&quot;</span><span class="s0">,</span>
                                     <span class="s1">link_precision=links.Log())</span>
        <span class="s1">cls.res1 = mod.fit(cov_type=</span><span class="s2">&quot;eim&quot;</span><span class="s1">)</span>
        <span class="s1">cls.res2 = resultsb.results_meth</span>

    <span class="s0">def </span><span class="s1">test_basic(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s1">k_mean = </span><span class="s4">4</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">pv = res2.table_mean.T</span>
        <span class="s1">assert_allclose(res1.params[:k_mean]</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bse[:k_mean]</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.tvalues[:k_mean]</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.pvalues[:k_mean]</span><span class="s0">, </span><span class="s1">pv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>

        <span class="s1">p</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">pv = res2.table_precision.T</span>
        <span class="s1">assert_allclose(res1.params[k_mean:]</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bse[k_mean:]</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.tvalues[k_mean:]</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.pvalues[k_mean:]</span><span class="s0">, </span><span class="s1">pv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>

        <span class="s1">assert_allclose(res1.llf</span><span class="s0">, </span><span class="s1">res2.loglik</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.aic</span><span class="s0">, </span><span class="s1">res2.aic</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bic</span><span class="s0">, </span><span class="s1">res2.bic</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s3"># dofferent definitions for prsquared</span>
        <span class="s1">assert_allclose(res1.prsquared</span><span class="s0">, </span><span class="s1">res2.pseudo_r_squared</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">0.01</span><span class="s1">)</span>
        <span class="s1">assert_equal(res1.df_resid</span><span class="s0">, </span><span class="s1">res2.df_residual)</span>
        <span class="s1">assert_equal(res1.nobs</span><span class="s0">, </span><span class="s1">res2.nobs)</span>

        <span class="s3"># null model compared to R betareg and lmtest</span>
        <span class="s1">df_c = res1.df_resid_null - res1.df_resid</span>
        <span class="s1">assert_equal(res1.k_null</span><span class="s0">, </span><span class="s4">2</span><span class="s1">)</span>

        <span class="s3"># &gt; lrt = lrtest(res_meth_null, res_meth)  # results from R</span>
        <span class="s1">pv = </span><span class="s4">7.21872953868659e-18</span>
        <span class="s1">lln = </span><span class="s4">60.88809589492269</span>
        <span class="s1">llf = </span><span class="s4">104.14802840534323</span>
        <span class="s1">chisq = </span><span class="s4">86.51986502084107</span>
        <span class="s1">dfc = </span><span class="s4">4</span>
        <span class="s3"># stats.chi2.sf(86.51986502093865, 4)</span>
        <span class="s1">assert_equal(df_c</span><span class="s0">, </span><span class="s1">dfc)</span>
        <span class="s1">assert_allclose(res1.llf</span><span class="s0">, </span><span class="s1">llf</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.llnull</span><span class="s0">, </span><span class="s1">lln</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.llr</span><span class="s0">, </span><span class="s1">chisq</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.llr_pvalue</span><span class="s0">, </span><span class="s1">pv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_resid(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">res2 = self.res2</span>
        <span class="s1">assert_allclose(res1.fittedvalues</span><span class="s0">, </span><span class="s1">res2.resid[</span><span class="s2">'fittedvalues'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">rtol=</span><span class="s4">1e-8</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.resid</span><span class="s0">, </span><span class="s1">res2.resid[</span><span class="s2">'response'</span><span class="s1">]</span><span class="s0">,</span>
                        <span class="s1">atol=</span><span class="s4">1e-8</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-8</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_oim(self):</span>
        <span class="s3"># estimate with default oim, cov_type nonrobust</span>
        <span class="s1">res1 = self.res1.model.fit()</span>
        <span class="s1">res2 = self.res2</span>

        <span class="s1">k_mean = </span><span class="s4">4</span>
        <span class="s3"># R betareg uses numerical derivatives from bfgs, has lower precision</span>
        <span class="s1">p</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">pv = res2.table_mean_oim.T</span>
        <span class="s1">assert_allclose(res1.params[:k_mean]</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bse[:k_mean]</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.tvalues[:k_mean]</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.pvalues[:k_mean]</span><span class="s0">, </span><span class="s1">pv</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-5</span><span class="s1">)</span>

        <span class="s1">p</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">pv = res2.table_precision_oim.T</span>
        <span class="s1">assert_allclose(res1.params[k_mean:]</span><span class="s0">, </span><span class="s1">p</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-6</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.bse[k_mean:]</span><span class="s0">, </span><span class="s1">se</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.tvalues[k_mean:]</span><span class="s0">, </span><span class="s1">zv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-3</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res1.pvalues[k_mean:]</span><span class="s0">, </span><span class="s1">pv</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-2</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_predict_distribution(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">mean = res1.predict()</span>
        <span class="s1">var_ = res1.model._predict_var(res1.params)</span>
        <span class="s1">distr = res1.get_distribution()</span>
        <span class="s1">m2</span><span class="s0">, </span><span class="s1">v2 = distr.stats()</span>
        <span class="s1">assert_allclose(mean</span><span class="s0">, </span><span class="s1">m2</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var_</span><span class="s0">, </span><span class="s1">v2</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s3"># from R: &gt; predict(res_meth, type=&quot;variance&quot;)</span>
        <span class="s1">var_r6 = [</span>
            <span class="s4">3.1090848852102e-04</span><span class="s0">, </span><span class="s4">2.4509604000073e-04</span><span class="s0">, </span><span class="s4">3.7199753140565e-04</span><span class="s0">,</span>
            <span class="s4">2.8088261358738e-04</span><span class="s0">, </span><span class="s4">2.7561111800350e-04</span><span class="s0">, </span><span class="s4">3.3929220526847e-04</span><span class="s1">]</span>
        <span class="s1">n = </span><span class="s4">6</span>
        <span class="s1">assert_allclose(v2[:n]</span><span class="s0">, </span><span class="s1">var_r6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-7</span><span class="s1">)</span>

        <span class="s1">ex = res1.model.exog[:n]</span>
        <span class="s1">ex_prec = res1.model.exog_precision[:n]</span>
        <span class="s1">mean6 = res1.predict(ex</span><span class="s0">, </span><span class="s1">transform=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">prec = res1.predict(which=</span><span class="s2">&quot;precision&quot;</span><span class="s1">)</span>
        <span class="s3"># todo: prec6 wrong exog if not used as keyword, no exception raised</span>
        <span class="s1">prec6 = res1.predict(exog_precision=ex_prec</span><span class="s0">, </span><span class="s1">which=</span><span class="s2">&quot;precision&quot;</span><span class="s0">,</span>
                             <span class="s1">transform=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">var6 = res1.model._predict_var(res1.params</span><span class="s0">, </span><span class="s1">exog=ex</span><span class="s0">,</span>
                                       <span class="s1">exog_precision=ex_prec)</span>

        <span class="s1">assert_allclose(mean6</span><span class="s0">, </span><span class="s1">mean[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(prec6</span><span class="s0">, </span><span class="s1">prec[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var6</span><span class="s0">, </span><span class="s1">var_[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(var6</span><span class="s0">, </span><span class="s1">var_r6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-7</span><span class="s1">)</span>

        <span class="s1">distr6 = res1.model.get_distribution(res1.params</span><span class="s0">,</span>
                                             <span class="s1">exog=ex</span><span class="s0">, </span><span class="s1">exog_precision=ex_prec)</span>
        <span class="s1">m26</span><span class="s0">, </span><span class="s1">v26 = distr6.stats()</span>
        <span class="s1">assert_allclose(m26</span><span class="s0">, </span><span class="s1">m2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(v26</span><span class="s0">, </span><span class="s1">v2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s1">distr6f = res1.get_distribution(exog=ex</span><span class="s0">, </span><span class="s1">exog_precision=ex_prec</span><span class="s0">,</span>
                                        <span class="s1">transform=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">m26</span><span class="s0">, </span><span class="s1">v26 = distr6f.stats()</span>
        <span class="s1">assert_allclose(m26</span><span class="s0">, </span><span class="s1">m2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(v26</span><span class="s0">, </span><span class="s1">v2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>

        <span class="s3"># check formula transform works for predict, currently mean only</span>
        <span class="s1">df6 = methylation.iloc[:</span><span class="s4">6</span><span class="s1">]</span>
        <span class="s1">mean6f = res1.predict(df6)</span>
        <span class="s3"># todo: prec6 wrong exog if not used as keyword, no exception raised</span>
        <span class="s3">#       formula not supported for exog_precision in predict</span>
        <span class="s3"># prec6f = res1.predict(exog_precision=ex_prec, which=&quot;precision&quot;)</span>
        <span class="s1">assert_allclose(mean6f</span><span class="s0">, </span><span class="s1">mean[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s3"># assert_allclose(prec6f, prec[:n], rtol=1e-13)</span>

        <span class="s1">distr6f = res1.get_distribution(exog=df6</span><span class="s0">, </span><span class="s1">exog_precision=ex_prec)</span>
        <span class="s1">m26</span><span class="s0">, </span><span class="s1">v26 = distr6f.stats()</span>
        <span class="s1">assert_allclose(m26</span><span class="s0">, </span><span class="s1">m2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(v26</span><span class="s0">, </span><span class="s1">v2[:n]</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s3"># check that we don't have pandas in distr</span>
        <span class="s0">assert </span><span class="s1">isinstance(distr6f.args[</span><span class="s4">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">np.ndarray)</span>

        <span class="s3"># minimal checks for get_prediction</span>
        <span class="s1">pma = res1.get_prediction(which=</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">dfma = pma.summary_frame()</span>
        <span class="s1">assert_allclose(pma.predicted</span><span class="s0">, </span><span class="s1">mean.mean()</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(dfma.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">1</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">pm = res1.get_prediction(exog=df6</span><span class="s0">, </span><span class="s1">which=</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">dfm = pm.summary_frame()</span>
        <span class="s1">assert_allclose(pm.predicted</span><span class="s0">, </span><span class="s1">mean6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(dfm.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s1">pv = res1.get_prediction(exog=df6</span><span class="s0">, </span><span class="s1">exog_precision=ex_prec</span><span class="s0">,</span>
                                 <span class="s1">which=</span><span class="s2">&quot;var&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">dfv = pv.summary_frame()</span>
        <span class="s1">assert_allclose(pv.predicted</span><span class="s0">, </span><span class="s1">var6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_equal(dfv.shape</span><span class="s0">, </span><span class="s1">(</span><span class="s4">6</span><span class="s0">, </span><span class="s4">4</span><span class="s1">))</span>
        <span class="s3"># smoke tests</span>
        <span class="s1">res1.get_prediction(which=</span><span class="s2">&quot;linear&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">res1.get_prediction(which=</span><span class="s2">&quot;precision&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">res1.get_prediction(exog_precision=ex_prec</span><span class="s0">, </span><span class="s1">which=</span><span class="s2">&quot;precision&quot;</span><span class="s0">,</span>
                            <span class="s1">average=</span><span class="s0">False</span><span class="s1">)</span>
        <span class="s1">res1.get_prediction(which=</span><span class="s2">&quot;linear-precision&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True</span><span class="s1">)</span>

        <span class="s3"># test agg_weights</span>
        <span class="s1">pm = res1.get_prediction(exog=df6</span><span class="s0">, </span><span class="s1">which=</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">dfm = pm.summary_frame()</span>
        <span class="s1">aw = np.zeros(len(res1.model.endog))</span>
        <span class="s1">aw[:</span><span class="s4">6</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">aw /= aw.mean()</span>
        <span class="s1">pm6 = res1.get_prediction(exog=df6</span><span class="s0">, </span><span class="s1">which=</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True</span><span class="s1">)</span>
        <span class="s1">dfm6 = pm6.summary_frame()</span>
        <span class="s1">pmw = res1.get_prediction(which=</span><span class="s2">&quot;mean&quot;</span><span class="s0">, </span><span class="s1">average=</span><span class="s0">True, </span><span class="s1">agg_weights=aw)</span>
        <span class="s1">dfmw = pmw.summary_frame()</span>
        <span class="s1">assert_allclose(pmw.predicted</span><span class="s0">, </span><span class="s1">pm6.predicted</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>
        <span class="s1">assert_allclose(dfmw</span><span class="s0">, </span><span class="s1">dfm6</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">TestBetaIncome():</span>

    <span class="s1">@classmethod</span>
    <span class="s0">def </span><span class="s1">setup_class(cls):</span>

        <span class="s1">formula = </span><span class="s2">&quot;I(food/income) ~ income + persons&quot;</span>
        <span class="s1">exog_prec = patsy.dmatrix(</span><span class="s2">&quot;~ persons&quot;</span><span class="s0">, </span><span class="s1">income)</span>
        <span class="s1">mod_income = BetaModel.from_formula(</span>
            <span class="s1">formula</span><span class="s0">,</span>
            <span class="s1">income</span><span class="s0">,</span>
            <span class="s1">exog_precision=exog_prec</span><span class="s0">,</span>
            <span class="s1">link_precision=links.Log()</span>
            <span class="s1">)</span>
        <span class="s1">res_income = mod_income.fit(method=</span><span class="s2">&quot;newton&quot;</span><span class="s1">)</span>

        <span class="s1">mod_restricted = BetaModel.from_formula(</span>
            <span class="s1">formula</span><span class="s0">,</span>
            <span class="s1">income</span><span class="s0">,</span>
            <span class="s1">link_precision=links.Log()</span>
            <span class="s1">)</span>
        <span class="s1">res_restricted = mod_restricted.fit(method=</span><span class="s2">&quot;newton&quot;</span><span class="s1">)</span>

        <span class="s1">cls.res1 = res_income</span>
        <span class="s1">cls.resr = res_restricted</span>

    <span class="s0">def </span><span class="s1">test_score_test(self):</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s1">resr = self.resr</span>
        <span class="s1">params_restr = np.concatenate([resr.params</span><span class="s0">, </span><span class="s1">[</span><span class="s4">0</span><span class="s1">]])</span>
        <span class="s1">r_matrix = np.zeros((</span><span class="s4">1</span><span class="s0">, </span><span class="s1">len(params_restr)))</span>
        <span class="s1">r_matrix[</span><span class="s4">0</span><span class="s0">, </span><span class="s1">-</span><span class="s4">1</span><span class="s1">] = </span><span class="s4">1</span>
        <span class="s1">exog_prec_extra = res1.model.exog_precision[:</span><span class="s0">, </span><span class="s4">1</span><span class="s1">:]</span>

        <span class="s0">from </span><span class="s1">statsmodels.base._parameter_inference </span><span class="s0">import </span><span class="s1">score_test</span>
        <span class="s1">sc1 = score_test(res1</span><span class="s0">, </span><span class="s1">params_constrained=params_restr</span><span class="s0">,</span>
                         <span class="s1">k_constraints=</span><span class="s4">1</span><span class="s1">)</span>
        <span class="s1">sc2 = score_test(resr</span><span class="s0">, </span><span class="s1">exog_extra=(</span><span class="s0">None, </span><span class="s1">exog_prec_extra))</span>
        <span class="s1">assert_allclose(sc2[:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sc1[:</span><span class="s4">2</span><span class="s1">])</span>

        <span class="s1">sc1_hc = score_test(res1</span><span class="s0">, </span><span class="s1">params_constrained=params_restr</span><span class="s0">,</span>
                            <span class="s1">k_constraints=</span><span class="s4">1</span><span class="s0">, </span><span class="s1">r_matrix=r_matrix</span><span class="s0">, </span><span class="s1">cov_type=</span><span class="s2">&quot;HC0&quot;</span><span class="s1">)</span>
        <span class="s1">sc2_hc = score_test(resr</span><span class="s0">, </span><span class="s1">exog_extra=(</span><span class="s0">None, </span><span class="s1">exog_prec_extra)</span><span class="s0">,</span>
                            <span class="s1">cov_type=</span><span class="s2">&quot;HC0&quot;</span><span class="s1">)</span>
        <span class="s1">assert_allclose(sc2_hc[:</span><span class="s4">2</span><span class="s1">]</span><span class="s0">, </span><span class="s1">sc1_hc[:</span><span class="s4">2</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_influence(self):</span>
        <span class="s3"># currently only smoke test</span>
        <span class="s1">res1 = self.res1</span>
        <span class="s0">from </span><span class="s1">statsmodels.stats.outliers_influence </span><span class="s0">import </span><span class="s1">MLEInfluence</span>

        <span class="s1">influ0 = MLEInfluence(res1)</span>
        <span class="s1">influ = res1.get_influence()</span>
        <span class="s1">attrs = [</span><span class="s2">'cooks_distance'</span><span class="s0">, </span><span class="s2">'d_fittedvalues'</span><span class="s0">, </span><span class="s2">'d_fittedvalues_scaled'</span><span class="s0">,</span>
                 <span class="s2">'d_params'</span><span class="s0">, </span><span class="s2">'dfbetas'</span><span class="s0">, </span><span class="s2">'hat_matrix_diag'</span><span class="s0">, </span><span class="s2">'resid_studentized'</span>
                 <span class="s1">]</span>
        <span class="s0">for </span><span class="s1">attr </span><span class="s0">in </span><span class="s1">attrs:</span>
            <span class="s1">getattr(influ</span><span class="s0">, </span><span class="s1">attr)</span>

        <span class="s1">frame = influ.summary_frame()</span>
        <span class="s1">frame0 = influ0.summary_frame()</span>
        <span class="s1">assert_allclose(frame</span><span class="s0">, </span><span class="s1">frame0</span><span class="s0">, </span><span class="s1">rtol=</span><span class="s4">1e-13</span><span class="s0">, </span><span class="s1">atol=</span><span class="s4">1e-13</span><span class="s1">)</span>
</pre>
</body>
</html>