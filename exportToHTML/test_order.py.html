<html>
<head>
<title>test_order.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6a8759;}
.s3 { color: #6897bb;}
.s4 { color: #629755; font-style: italic;}
.s5 { color: #808080;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_order.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">__future__ </span><span class="s0">import </span><span class="s1">annotations</span>

<span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">dask</span>
<span class="s0">from </span><span class="s1">dask.base </span><span class="s0">import </span><span class="s1">collections_to_dsk</span>
<span class="s0">from </span><span class="s1">dask.core </span><span class="s0">import </span><span class="s1">get_deps</span>
<span class="s0">from </span><span class="s1">dask.order </span><span class="s0">import </span><span class="s1">diagnostics</span><span class="s0">, </span><span class="s1">ndependencies</span><span class="s0">, </span><span class="s1">order</span>
<span class="s0">from </span><span class="s1">dask.utils_test </span><span class="s0">import </span><span class="s1">add</span><span class="s0">, </span><span class="s1">inc</span>


<span class="s1">@pytest.fixture(params=[</span><span class="s2">&quot;abcde&quot;</span><span class="s0">, </span><span class="s2">&quot;edcba&quot;</span><span class="s1">])</span>
<span class="s0">def </span><span class="s1">abcde(request):</span>
    <span class="s0">return </span><span class="s1">request.param</span>


<span class="s0">def </span><span class="s1">issorted(L</span><span class="s0">, </span><span class="s1">reverse=</span><span class="s0">False</span><span class="s1">):</span>
    <span class="s0">return </span><span class="s1">sorted(L</span><span class="s0">, </span><span class="s1">reverse=reverse) == L</span>


<span class="s0">def </span><span class="s1">f(*args):</span>
    <span class="s0">pass</span>


<span class="s0">def </span><span class="s1">test_ordering_keeps_groups_together(abcde):</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">d = {(a</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">,</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)}</span>
    <span class="s1">d.update({(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))})</span>
    <span class="s1">o = order(d)</span>

    <span class="s0">assert </span><span class="s1">abs(o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] - o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">abs(o[(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)] - o[(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]) == </span><span class="s3">1</span>

    <span class="s1">d = {(a</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">,</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)}</span>
    <span class="s1">d.update({(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))})</span>
    <span class="s1">o = order(d)</span>

    <span class="s0">assert </span><span class="s1">abs(o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] - o[(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]) == </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">abs(o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] - o[(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]) == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_avoid_broker_nodes(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
 
    b0    b1  b2 
    |      \  / 
    a0      a1 
 
    a0 should be run before a1 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>

    <span class="s5"># Switch name of 0, 1 to ensure that this isn't due to string comparison</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &gt; o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>

    <span class="s5"># Switch name of 0, 1 for &quot;b&quot;s too</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_base_of_reduce_preferred(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
               a3 
              /| 
            a2 | 
           /|  | 
         a1 |  | 
        /|  |  | 
      a0 |  |  | 
      |  |  |  | 
      b0 b1 b2 b3 
        \ \ / / 
           c 
 
    We really want to run b0 quickly 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {(a</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s1">i - </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s1">i)) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">[</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]}</span>
    <span class="s1">dsk[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] = (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">dsk.update({(b</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">[</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s1">]})</span>
    <span class="s1">dsk[c] = </span><span class="s3">1</span>

    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt;= </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt;= </span><span class="s3">3</span>


<span class="s0">def </span><span class="s1">test_avoid_upwards_branching(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
       a1 
       | 
       a2 
       | 
       a3    d1 
      /  \  / 
    b1    c1 
    |     | 
    b2    c2 
          | 
          c3 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s1">o[(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_avoid_upwards_branching_complex(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
         a1 
         | 
    e2   a2  d2  d3 
    |    |    \  / 
    e1   a3    d1 
     \  /  \  / 
      b1    c1 
      |     | 
      b2    c2 
            | 
            c3 
 
    Prefer c1 over b1 because c1 will stay in memory less long while b1 
    computes 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">abs(o[(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)] - o[(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]) == </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_deep_bases_win_over_dependents(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
    It's not clear who should run first, e or d 
 
    1.  d is nicer because it exposes parallelism 
    2.  e is nicer (hypothetically) because it will be sooner released 
        (though in this case we need d to run first regardless) 
 
    Regardless of e or d first, we should run b before c. 
 
            a 
          / | \   . 
         b  c | 
        / \ | / 
       e    d 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {a: (f</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">b: (f</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e)</span><span class="s0">, </span><span class="s1">c: (f</span><span class="s0">, </span><span class="s1">d)</span><span class="s0">, </span><span class="s1">d: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">e: </span><span class="s3">2</span><span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[e] &lt; o[d]  </span><span class="s5"># ambiguous, but this is what we currently expect</span>
    <span class="s0">assert </span><span class="s1">o[b] &lt; o[c]</span>


<span class="s0">def </span><span class="s1">test_prefer_deep(abcde):</span>
    <span class="s4">&quot;&quot;&quot; 
        c 
        | 
    e   b 
    |   | 
    d   a 
 
    Prefer longer chains first so we should start with c 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {a: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">b: (f</span><span class="s0">, </span><span class="s1">a)</span><span class="s0">, </span><span class="s1">c: (f</span><span class="s0">, </span><span class="s1">b)</span><span class="s0">, </span><span class="s1">d: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">e: (f</span><span class="s0">, </span><span class="s1">d)}</span>

    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[a] &lt; o[d]</span>
    <span class="s0">assert </span><span class="s1">o[b] &lt; o[d]</span>


<span class="s0">def </span><span class="s1">test_stacklimit(abcde):</span>
    <span class="s1">dsk = {</span><span class="s2">&quot;x%s&quot; </span><span class="s1">% (i + </span><span class="s3">1</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s2">&quot;x%s&quot; </span><span class="s1">% i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10000</span><span class="s1">)}</span>
    <span class="s1">dependencies</span><span class="s0">, </span><span class="s1">dependents = get_deps(dsk)</span>
    <span class="s1">ndependencies(dependencies</span><span class="s0">, </span><span class="s1">dependents)</span>


<span class="s0">def </span><span class="s1">test_break_ties_by_str(abcde):</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">i): (inc</span><span class="s0">, </span><span class="s1">i) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">10</span><span class="s1">)}</span>
    <span class="s1">x_keys = sorted(dsk)</span>
    <span class="s1">dsk[</span><span class="s2">&quot;y&quot;</span><span class="s1">] = list(x_keys)</span>

    <span class="s1">o = order(dsk)</span>
    <span class="s1">expected = {</span><span class="s2">&quot;y&quot;</span><span class="s1">: </span><span class="s3">10</span><span class="s1">}</span>
    <span class="s1">expected.update({k: i </span><span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">k </span><span class="s0">in </span><span class="s1">enumerate(x_keys)})</span>

    <span class="s0">assert </span><span class="s1">o == expected</span>


<span class="s0">def </span><span class="s1">test_order_doesnt_fail_on_mixed_type_keys(abcde):</span>
    <span class="s1">order({</span><span class="s2">&quot;x&quot;</span><span class="s1">: (inc</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (inc</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;z&quot;</span><span class="s1">: (add</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;y&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))})</span>


<span class="s0">def </span><span class="s1">test_gh_3055():</span>
    <span class="s1">da = pytest.importorskip(</span><span class="s2">&quot;dask.array&quot;</span><span class="s1">)</span>
    <span class="s1">A</span><span class="s0">, </span><span class="s1">B = </span><span class="s3">20</span><span class="s0">, </span><span class="s3">99</span>
    <span class="s1">orig = x = da.random.normal(size=(A</span><span class="s0">, </span><span class="s1">B)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, None</span><span class="s1">))</span>
    <span class="s0">for </span><span class="s1">_ </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s1">):</span>
        <span class="s1">y = (x[:</span><span class="s0">, None, </span><span class="s1">:] * x[:</span><span class="s0">, </span><span class="s1">:</span><span class="s0">, None</span><span class="s1">]).cumsum(axis=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">x = x.cumsum(axis=</span><span class="s3">0</span><span class="s1">)</span>
    <span class="s1">w = (y * x[:</span><span class="s0">, None</span><span class="s1">]).sum(axis=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">dsk = dict(w.__dask_graph__())</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s1">L = [o[k] </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">w.__dask_keys__()]</span>
    <span class="s0">assert </span><span class="s1">sum(x &lt; len(o) / </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">L) &gt; len(L) / </span><span class="s3">3  </span><span class="s5"># some complete quickly</span>

    <span class="s1">L = [o[k] </span><span class="s0">for </span><span class="s1">kk </span><span class="s0">in </span><span class="s1">orig.__dask_keys__() </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">kk]</span>
    <span class="s0">assert </span><span class="s1">sum(x &gt; len(o) / </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">L) &gt; len(L) / </span><span class="s3">3  </span><span class="s5"># some start later</span>

    <span class="s0">assert </span><span class="s1">sorted(L) == L  </span><span class="s5"># operate in order</span>


<span class="s0">def </span><span class="s1">test_type_comparisions_ok(abcde):</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {a: </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">2</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s1">}</span>
    <span class="s1">order(dsk)  </span><span class="s5"># this doesn't err</span>


<span class="s0">def </span><span class="s1">test_favor_longest_critical_path(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
 
       a 
       | 
    d  b  e 
     \ | / 
       c 
 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {c: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">d: (f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">e: (f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">b: (f</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">, </span><span class="s1">a: (f</span><span class="s0">, </span><span class="s1">b)}</span>

    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[d] &gt; o[b]</span>
    <span class="s0">assert </span><span class="s1">o[e] &gt; o[b]</span>


<span class="s0">def </span><span class="s1">test_run_smaller_sections(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
            aa 
           / | 
      b   d  bb dd 
     / \ /|  | / 
    a   c e  cc 
 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">aa</span><span class="s0">, </span><span class="s1">bb</span><span class="s0">, </span><span class="s1">cc</span><span class="s0">, </span><span class="s1">dd = (x * </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">[a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d])</span>

    <span class="s1">dsk = {</span>
        <span class="s1">a: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">c: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">e: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">cc: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">b: (f</span><span class="s0">, </span><span class="s1">a</span><span class="s0">, </span><span class="s1">c)</span><span class="s0">,</span>
        <span class="s1">d: (f</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">e)</span><span class="s0">,</span>
        <span class="s1">bb: (f</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">,</span>
        <span class="s1">aa: (f</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">bb)</span><span class="s0">,</span>
        <span class="s1">dd: (f</span><span class="s0">, </span><span class="s1">cc)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">max(diagnostics(dsk)[</span><span class="s3">1</span><span class="s1">]) &lt;= </span><span class="s3">4  </span><span class="s5"># optimum is 3</span>
    <span class="s5"># This is a mildly ambiguous example</span>
    <span class="s5"># https://github.com/dask/dask/pull/10535/files#r1337528255</span>
    <span class="s0">assert </span><span class="s1">(o[aa] &lt; o[a] </span><span class="s0">and </span><span class="s1">o[dd] &lt; o[a]) </span><span class="s0">or </span><span class="s1">(o[b] &lt; o[e] </span><span class="s0">and </span><span class="s1">o[b] &lt; o[cc])</span>


<span class="s0">def </span><span class="s1">test_local_parents_of_reduction(abcde):</span>
    <span class="s4">&quot;&quot;&quot; 
 
            c1 
            | 
        b1  c2 
        |  /| 
    a1  b2  c3 
    |  /| 
    a2  b3 
    | 
    a3 
 
    Prefer to finish a1 stack before proceeding to b2 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">a2</span><span class="s0">, </span><span class="s1">a3 = (a + i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;123&quot;</span><span class="s1">)</span>
    <span class="s1">b1</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">b3 = (b + i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;123&quot;</span><span class="s1">)</span>
    <span class="s1">c1</span><span class="s0">, </span><span class="s1">c2</span><span class="s0">, </span><span class="s1">c3 = (c + i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;123&quot;</span><span class="s1">)</span>

    <span class="s1">expected = [a3</span><span class="s0">, </span><span class="s1">a2</span><span class="s0">, </span><span class="s1">a1</span><span class="s0">, </span><span class="s1">b3</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">c3</span><span class="s0">, </span><span class="s1">c2</span><span class="s0">, </span><span class="s1">c1]</span>

    <span class="s1">log = []</span>

    <span class="s0">def </span><span class="s1">f(x):</span>
        <span class="s0">def </span><span class="s1">_(*args):</span>
            <span class="s1">log.append(x)</span>

        <span class="s0">return </span><span class="s1">_</span>

    <span class="s1">dsk = {</span>
        <span class="s1">a3: (f(a3)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">a2: (f(a2)</span><span class="s0">, </span><span class="s1">a3)</span><span class="s0">,</span>
        <span class="s1">a1: (f(a1)</span><span class="s0">, </span><span class="s1">a2)</span><span class="s0">,</span>
        <span class="s1">b3: (f(b3)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">b2: (f(b2)</span><span class="s0">, </span><span class="s1">b3</span><span class="s0">, </span><span class="s1">a2)</span><span class="s0">,</span>
        <span class="s1">b1: (f(b1)</span><span class="s0">, </span><span class="s1">b2)</span><span class="s0">,</span>
        <span class="s1">c3: (f(c3)</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">c2: (f(c2)</span><span class="s0">, </span><span class="s1">c3</span><span class="s0">, </span><span class="s1">b2)</span><span class="s0">,</span>
        <span class="s1">c1: (f(c1)</span><span class="s0">, </span><span class="s1">c2)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">order(dsk)</span>
    <span class="s1">dask.get(dsk</span><span class="s0">, </span><span class="s1">[a1</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">c1])  </span><span class="s5"># trigger computation</span>

    <span class="s0">assert </span><span class="s1">log == expected</span>


<span class="s0">def </span><span class="s1">test_nearest_neighbor(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
 
    a1  a2  a3  a4  a5  a6  a7 a8  a9 
     \  |  /  \ |  /  \ |  / \ |  / 
        b1      b2      b3     b4 
 
    Want to finish off a local group before moving on. 
    This is difficult because all groups are connected. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = abcde</span>
    <span class="s1">a1</span><span class="s0">, </span><span class="s1">a2</span><span class="s0">, </span><span class="s1">a3</span><span class="s0">, </span><span class="s1">a4</span><span class="s0">, </span><span class="s1">a5</span><span class="s0">, </span><span class="s1">a6</span><span class="s0">, </span><span class="s1">a7</span><span class="s0">, </span><span class="s1">a8</span><span class="s0">, </span><span class="s1">a9 = (a + i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;123456789&quot;</span><span class="s1">)</span>
    <span class="s1">b1</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">b3</span><span class="s0">, </span><span class="s1">b4 = (b + i </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;1234&quot;</span><span class="s1">)</span>

    <span class="s1">dsk = {</span>
        <span class="s1">b1: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">b2: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">b3: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">b4: (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">a1: (f</span><span class="s0">, </span><span class="s1">b1)</span><span class="s0">,</span>
        <span class="s1">a2: (f</span><span class="s0">, </span><span class="s1">b1)</span><span class="s0">,</span>
        <span class="s1">a3: (f</span><span class="s0">, </span><span class="s1">b1</span><span class="s0">, </span><span class="s1">b2)</span><span class="s0">,</span>
        <span class="s1">a4: (f</span><span class="s0">, </span><span class="s1">b2)</span><span class="s0">,</span>
        <span class="s1">a5: (f</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">b3)</span><span class="s0">,</span>
        <span class="s1">a6: (f</span><span class="s0">, </span><span class="s1">b3)</span><span class="s0">,</span>
        <span class="s1">a7: (f</span><span class="s0">, </span><span class="s1">b3</span><span class="s0">, </span><span class="s1">b4)</span><span class="s0">,</span>
        <span class="s1">a8: (f</span><span class="s0">, </span><span class="s1">b4)</span><span class="s0">,</span>
        <span class="s1">a9: (f</span><span class="s0">, </span><span class="s1">b4)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s3">3 </span><span class="s1">&lt; sum(o[a + i] &lt; len(o) / </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;123456789&quot;</span><span class="s1">) &lt; </span><span class="s3">7</span>
    <span class="s0">assert </span><span class="s3">1 </span><span class="s1">&lt; sum(o[b + i] &lt; len(o) / </span><span class="s3">2 </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s2">&quot;1234&quot;</span><span class="s1">) &lt; </span><span class="s3">4</span>
    <span class="s0">assert </span><span class="s1">o[min([b1</span><span class="s0">, </span><span class="s1">b2</span><span class="s0">, </span><span class="s1">b3</span><span class="s0">, </span><span class="s1">b4])] == </span><span class="s3">0</span>


<span class="s0">def </span><span class="s1">test_string_ordering():</span>
    <span class="s4">&quot;&quot;&quot;Prefer ordering tasks by name first&quot;&quot;&quot;</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o == {(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): </span><span class="s3">2</span><span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_string_ordering_dependents():</span>
    <span class="s4">&quot;&quot;&quot;Prefer ordering tasks by name first even when in dependencies&quot;&quot;&quot;</span>
    <span class="s1">dsk = {(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">,</span><span class="s1">)}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o == {</span><span class="s2">&quot;b&quot;</span><span class="s1">: </span><span class="s3">0</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): </span><span class="s3">2</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): </span><span class="s3">3</span><span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_prefer_short_narrow(abcde):</span>
    <span class="s5"># See test_prefer_short_ancestor for a fail case.</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_prefer_short_ancestor(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
    From https://github.com/dask/dask-ml/issues/206#issuecomment-395869929 
 
    Two cases, one where chunks of an array are independent, and one where the 
    chunks of an array have a shared source. We handled the independent one 
    &quot;well&quot; earlier. 
 
    Good: 
 
                    c2 
                   / \ \ 
                  /   \ \ 
                c1     \ \ 
              / | \     \ \ 
            c0  a0 b0   a1 b1 
 
    Bad: 
 
                    c2 
                   / \ \ 
                  /   \ \ 
                c1     \ \ 
              / | \     \ \ 
            c0  a0 b0   a1 b1 
                   \ \   / / 
                    \ \ / / 
                      a-b 
 
 
    The difference is that all the `a` and `b` tasks now have a common 
    ancestor. 
 
    We would like to choose c1 *before* a1, and b1 because 
 
    * we can release a0 and b0 once c1 is done 
    * we don't need a1 and b1 to compute c1. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = abcde</span>
    <span class="s1">ab = a + b</span>

    <span class="s1">dsk = {</span>
        <span class="s1">ab: </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">ab</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">ab</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">ab</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">ab</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] &lt; o[(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_map_overlap(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
      b1      b3      b5 
       |\    / | \  / | 
      c1  c2  c3  c4  c5 
       |/  | \ | / | \| 
      d1  d2  d3  d4  d5 
       |       |      | 
      e1      e2      e5 
 
    Want to finish b1 before we start on e5 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] &lt; o[(e</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] </span><span class="s0">or </span><span class="s1">o[(b</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] &lt; o[(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_use_structure_not_keys(abcde):</span>
    <span class="s4">&quot;&quot;&quot;See https://github.com/dask/dask/issues/5584#issuecomment-554963958 
 
    We were using key names to infer structure, which could result in funny behavior. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_</span><span class="s0">, </span><span class="s1">_ = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">7</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">8</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">9</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">7</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">9</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">7</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">7</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">9</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">9</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">8</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">6</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">8</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s1">As = sorted(val </span><span class="s0">for </span><span class="s1">(letter</span><span class="s0">, </span><span class="s1">_)</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">letter == a)</span>
    <span class="s1">Bs = sorted(val </span><span class="s0">for </span><span class="s1">(letter</span><span class="s0">, </span><span class="s1">_)</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">letter == b)</span>
    <span class="s0">assert </span><span class="s1">Bs[</span><span class="s3">0</span><span class="s1">] </span><span class="s0">in </span><span class="s1">{</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s1">}</span>
    <span class="s0">if </span><span class="s1">Bs[</span><span class="s3">0</span><span class="s1">] == </span><span class="s3">3</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">As == [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">16</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">Bs == [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">19</span><span class="s1">]</span>
    <span class="s0">else</span><span class="s1">:</span>
        <span class="s0">assert </span><span class="s1">As == [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">10</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">14</span><span class="s0">, </span><span class="s3">16</span><span class="s0">, </span><span class="s3">18</span><span class="s1">]</span>
        <span class="s0">assert </span><span class="s1">Bs == [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">11</span><span class="s0">, </span><span class="s3">13</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">17</span><span class="s0">, </span><span class="s3">19</span><span class="s1">]</span>


<span class="s0">def </span><span class="s1">test_dont_run_all_dependents_too_early(abcde):</span>
    <span class="s4">&quot;&quot;&quot;From https://github.com/dask/dask-ml/issues/206#issuecomment-395873372&quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">depth = </span><span class="s3">10</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">depth):</span>
        <span class="s1">dsk[(b</span><span class="s0">, </span><span class="s1">i)] = (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">dsk[(c</span><span class="s0">, </span><span class="s1">i)] = (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
        <span class="s1">dsk[(d</span><span class="s0">, </span><span class="s1">i)] = (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s1">i - </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s1">i)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">i))</span>
    <span class="s1">o = order(dsk)</span>

    <span class="s1">expected = [</span><span class="s3">3</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">12</span><span class="s0">, </span><span class="s3">15</span><span class="s0">, </span><span class="s3">18</span><span class="s0">, </span><span class="s3">21</span><span class="s0">, </span><span class="s3">24</span><span class="s0">, </span><span class="s3">27</span><span class="s0">, </span><span class="s3">30</span><span class="s1">]</span>
    <span class="s1">actual = sorted(v </span><span class="s0">for </span><span class="s1">(letter</span><span class="s0">, </span><span class="s1">num)</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">letter == d)</span>
    <span class="s0">assert </span><span class="s1">expected == actual</span>


<span class="s0">def </span><span class="s1">test_many_branches_use_ndependencies(abcde):</span>
    <span class="s4">&quot;&quot;&quot;From https://github.com/dask/dask/pull/5646#issuecomment-562700533 
 
    Sometimes we need larger or wider DAGs to test behavior.  This test 
    ensures we choose the branch with more work twice in successtion. 
    This is important, because ``order`` may search along dependencies 
    and then along dependents. 
 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dd = d + d</span>
    <span class="s1">ee = e + e</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,  </span><span class="s5"># most short and thin; should go last</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(dd</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(dd</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(dd</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(dd</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(dd</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(ee</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(ee</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(ee</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(ee</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(ee</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(dd</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(ee</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s5"># run all d's and e's first</span>
    <span class="s1">expected = [</span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s3">8</span><span class="s0">, </span><span class="s3">9</span><span class="s0">, </span><span class="s3">10</span><span class="s1">]</span>
    <span class="s1">actual = sorted(v </span><span class="s0">for </span><span class="s1">(letter</span><span class="s0">, </span><span class="s1">_)</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">letter </span><span class="s0">in </span><span class="s1">{d</span><span class="s0">, </span><span class="s1">dd</span><span class="s0">, </span><span class="s1">e</span><span class="s0">, </span><span class="s1">ee})</span>
    <span class="s0">assert </span><span class="s1">actual == expected</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == o[(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)] - </span><span class="s3">1</span>


<span class="s0">def </span><span class="s1">test_order_cycle():</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">dask.get({</span><span class="s2">&quot;a&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)}</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)  </span><span class="s5"># we encounter this in `get`</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">order({</span><span class="s2">&quot;a&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)})  </span><span class="s5"># trivial self-loop</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">order({(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))})  </span><span class="s5"># non-string</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">order({</span><span class="s2">&quot;a&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s1">)})  </span><span class="s5"># non-trivial loop</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">order({</span><span class="s2">&quot;a&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: </span><span class="s3">1</span><span class="s1">})</span>
    <span class="s0">with </span><span class="s1">pytest.raises(RuntimeError</span><span class="s0">, </span><span class="s1">match=</span><span class="s2">&quot;Cycle detected&quot;</span><span class="s1">):</span>
        <span class="s1">order({</span><span class="s2">&quot;a&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;c&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">)</span><span class="s0">, </span><span class="s2">&quot;d&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;b&quot;</span><span class="s1">)})</span>


<span class="s0">def </span><span class="s1">test_order_empty():</span>
    <span class="s0">assert </span><span class="s1">order({}) == {}</span>


<span class="s0">def </span><span class="s1">test_switching_dependents(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
 
    a7 a8  &lt;-- do these last 
    | / 
    a6                e6 
    |                / 
    a5   c5    d5  e5 
    |    |    /   / 
    a4   c4 d4  e4 
    |  \ | /   / 
    a3   b3---/ 
    | 
    a2 
    | 
    a1 
    | 
    a0  &lt;-- start here 
 
    Test that we are able to switch to better dependents. 
    In this graph, we expect to start at a0.  To compute a4, we need to compute b3. 
    After computing b3, three &quot;better&quot; paths become available. 
    Confirm that we take the better paths before continuing down `a` path. 
 
    This test is pretty specific to how `order` is implemented 
    and is intended to increase code coverage. 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">7</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">8</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">6</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">3</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">6</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>

    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] == </span><span class="s3">0  </span><span class="s5"># probably</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] &gt; o[(c</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] &gt; o[(d</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)]</span>
    <span class="s0">assert </span><span class="s1">o[(a</span><span class="s0">, </span><span class="s3">5</span><span class="s1">)] &gt; o[(e</span><span class="s0">, </span><span class="s3">6</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_order_with_equal_dependents(abcde):</span>
    <span class="s4">&quot;&quot;&quot;From https://github.com/dask/dask/issues/5859#issuecomment-608422198 
 
    See the visualization of `(maxima, argmax)` example from the above comment. 
 
    This DAG has enough structure to exercise more parts of `order` 
 
    &quot;&quot;&quot;</span>
    <span class="s5"># Lower pressure is better but this is where we are right now. Important is</span>
    <span class="s5"># that no variation below should be worse since all variations below should</span>
    <span class="s5"># reduce to the same graph when optimized/fused.</span>
    <span class="s1">max_pressure = </span><span class="s3">11</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {}</span>
    <span class="s1">abc = [a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d]</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s1">dsk.update(</span>
            <span class="s1">{</span>
                <span class="s1">(x</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(x</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
        <span class="s0">for </span><span class="s1">i</span><span class="s0">, </span><span class="s1">y </span><span class="s0">in </span><span class="s1">enumerate(abc):</span>
            <span class="s1">dsk.update(</span>
                <span class="s1">{</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(y</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,  </span><span class="s5"># cross x and y</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">i): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s1">i))</span><span class="s0">,</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">i))</span><span class="s0">,</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s1">i))</span><span class="s0">,</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
                    <span class="s1">(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
                <span class="s1">}</span>
            <span class="s1">)</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s1">total = </span><span class="s3">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s1">val = o[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] - o[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">val &gt; </span><span class="s3">0  </span><span class="s5"># ideally, val == 2</span>
            <span class="s1">total += val</span>
    <span class="s0">assert </span><span class="s1">total &lt;= </span><span class="s3">56  </span><span class="s5"># ideally, this should be 2 * 16 == 32</span>
    <span class="s1">pressure = diagnostics(dsk</span><span class="s0">, </span><span class="s1">o=o)[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= max_pressure</span>

    <span class="s5"># Add one to the end of the nine bundles</span>
    <span class="s1">dsk2 = dict(dsk)</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s1">dsk2[(x</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)] = (f</span><span class="s0">, </span><span class="s1">(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span>
    <span class="s1">o = order(dsk2)</span>
    <span class="s1">total = </span><span class="s3">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s1">val = o[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] - o[(x</span><span class="s0">, </span><span class="s3">7</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">val &gt; </span><span class="s3">0  </span><span class="s5"># ideally, val == 3</span>
            <span class="s1">total += val</span>
    <span class="s0">assert </span><span class="s1">total &lt;= </span><span class="s3">75  </span><span class="s5"># ideally, this should be 3 * 16 == 48</span>
    <span class="s1">pressure = diagnostics(dsk2</span><span class="s0">, </span><span class="s1">o=o)[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= max_pressure</span>

    <span class="s5"># Remove one from each of the nine bundles</span>
    <span class="s1">dsk3 = dict(dsk)</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s0">del </span><span class="s1">dsk3[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)]</span>
    <span class="s1">o = order(dsk3)</span>
    <span class="s1">total = </span><span class="s3">0</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s1">val = o[(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] - o[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
            <span class="s0">assert </span><span class="s1">val &gt; </span><span class="s3">0</span>
            <span class="s1">total += val</span>
    <span class="s0">assert </span><span class="s1">total &lt;= </span><span class="s3">45  </span><span class="s5"># ideally, this should be 2 * 16 == 32</span>
    <span class="s1">pressure = diagnostics(dsk3</span><span class="s0">, </span><span class="s1">o=o)[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= max_pressure</span>

    <span class="s5"># Remove another one from each of the nine bundles</span>
    <span class="s1">dsk4 = dict(dsk3)</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s0">del </span><span class="s1">dsk4[(x</span><span class="s0">, </span><span class="s3">6</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
    <span class="s1">o = order(dsk4)</span>
    <span class="s1">pressure = diagnostics(dsk4</span><span class="s0">, </span><span class="s1">o=o)[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= max_pressure</span>
    <span class="s0">for </span><span class="s1">x </span><span class="s0">in </span><span class="s1">abc:</span>
        <span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(len(abc)):</span>
            <span class="s0">assert </span><span class="s1">abs(o[(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] - o[(x</span><span class="s0">, </span><span class="s3">5</span><span class="s0">, </span><span class="s1">i</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]) &lt;= </span><span class="s3">10</span>


<span class="s0">def </span><span class="s1">test_terminal_node_backtrack():</span>
    <span class="s4">r&quot;&quot;&quot; 
    https://github.com/dask/dask/issues/6745 
 
    We have 
 
    1. A terminal node that depends on the entire graph ('s') 
    2. Some shared dependencies near the roots ('a1', 'a4') 
    3. But the left and right halves are disconnected, other 
       than the terminal node. 
 
                       s 
               /   /       \   \ 
              /   /         \   \ 
            s00  s10       s01  s11 
             |    |         |    | 
            b00  b10       b01  b11 
            / \  / \       / \ / \ 
           a0  a1  a2    a3  a4  a5 
 
    Previously we started at 'a', and worked up to 's00'. We'd like to finish 
    's00' completely, so we progress to 's' and work through its dependencies. 
 
    Ideally, we would choose 's10', since we've already computed one of its 
    (eventual) dependencies: 'a1'. However, all of 's00' through 's11' had 
    equal metrics so we fell back to the name tie-breaker and started on 
    's01' (via 'a3', a4', 'b01', ...). 
    &quot;&quot;&quot;</span>
    <span class="s1">dsk = {</span>
        <span class="s5"># left half</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s3">0</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s3">1</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (</span><span class="s3">2</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s5"># right half</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (</span><span class="s3">3</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s1">): (</span><span class="s3">4</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">5</span><span class="s1">): (</span><span class="s3">5</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">5</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;b&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;store&quot;</span><span class="s1">: (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;store&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)] &lt; o[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_array_store_final_order(tmpdir):</span>
    <span class="s5"># https://github.com/dask/dask/issues/6745</span>
    <span class="s5"># This essentially tests the same thing as test_terminal_node_backtrack,</span>
    <span class="s5"># but with the graph actually generated by da.store.</span>
    <span class="s1">da = pytest.importorskip(</span><span class="s2">&quot;dask.array&quot;</span><span class="s1">)</span>
    <span class="s1">zarr = pytest.importorskip(</span><span class="s2">&quot;zarr&quot;</span><span class="s1">)</span>
    <span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>

    <span class="s1">arrays = [da.from_array(np.ones((</span><span class="s3">110</span><span class="s0">, </span><span class="s3">4</span><span class="s1">))</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)) </span><span class="s0">for </span><span class="s1">i </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">)]</span>
    <span class="s1">x = da.concatenate(arrays</span><span class="s0">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">).rechunk((</span><span class="s3">100</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span>

    <span class="s1">store = zarr.DirectoryStore(tmpdir)</span>
    <span class="s1">root = zarr.group(store</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">dest = root.empty_like(name=</span><span class="s2">&quot;dest&quot;</span><span class="s0">, </span><span class="s1">data=x</span><span class="s0">, </span><span class="s1">chunks=x.chunksize</span><span class="s0">, </span><span class="s1">overwrite=</span><span class="s0">True</span><span class="s1">)</span>
    <span class="s1">d = x.store(dest</span><span class="s0">, </span><span class="s1">lock=</span><span class="s0">False, </span><span class="s1">compute=</span><span class="s0">False</span><span class="s1">)</span>
    <span class="s1">o = order(d.dask)</span>

    <span class="s5"># Find the lowest store. Dask starts here.</span>
    <span class="s1">stores = [k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">o </span><span class="s0">if </span><span class="s1">isinstance(k</span><span class="s0">, </span><span class="s1">tuple) </span><span class="s0">and </span><span class="s1">k[</span><span class="s3">0</span><span class="s1">].startswith(</span><span class="s2">&quot;store-map-&quot;</span><span class="s1">)]</span>
    <span class="s1">first_store = min(stores</span><span class="s0">, </span><span class="s1">key=</span><span class="s0">lambda </span><span class="s1">k: o[k])</span>
    <span class="s1">connected_stores = [k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">stores </span><span class="s0">if </span><span class="s1">k[-</span><span class="s3">1</span><span class="s1">] == first_store[-</span><span class="s3">1</span><span class="s1">]]</span>
    <span class="s1">disconnected_stores = [k </span><span class="s0">for </span><span class="s1">k </span><span class="s0">in </span><span class="s1">stores </span><span class="s0">if </span><span class="s1">k[-</span><span class="s3">1</span><span class="s1">] != first_store[-</span><span class="s3">1</span><span class="s1">]]</span>

    <span class="s1">connected_max = max(v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">k </span><span class="s0">in </span><span class="s1">connected_stores)</span>
    <span class="s1">disconnected_min = min(v </span><span class="s0">for </span><span class="s1">k</span><span class="s0">, </span><span class="s1">v </span><span class="s0">in </span><span class="s1">o.items() </span><span class="s0">if </span><span class="s1">k </span><span class="s0">in </span><span class="s1">disconnected_stores)</span>
    <span class="s0">assert </span><span class="s1">connected_max &lt; disconnected_min</span>


<span class="s0">def </span><span class="s1">test_eager_to_compute_dependent_to_free_parent():</span>
    <span class="s4">r&quot;&quot;&quot;https://github.com/dask/dask/pull/7929 
 
    This graph begins with many motifs like the following: 
 
    |      | 
    c1    c2 
      \ / 
       b 
       | 
       a 
 
    We want to compute c2 and c3 pretty close together, because if we choose to 
    compute c1, then we should also compute c2 so we can release b.  Being 
    greedy here allows us to release memory sooner and be more globally optimal. 
    &quot;&quot;&quot;</span>
    <span class="s1">dsk = {</span>
        <span class="s2">&quot;a00&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a06&quot;</span><span class="s0">, </span><span class="s2">&quot;a08&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a01&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a28&quot;</span><span class="s0">, </span><span class="s2">&quot;a26&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a02&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a24&quot;</span><span class="s0">, </span><span class="s2">&quot;a21&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a03&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a22&quot;</span><span class="s0">, </span><span class="s2">&quot;a25&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a04&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a29&quot;</span><span class="s0">, </span><span class="s2">&quot;a20&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a05&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a23&quot;</span><span class="s0">, </span><span class="s2">&quot;a27&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a06&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a04&quot;</span><span class="s0">, </span><span class="s2">&quot;a02&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a07&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a00&quot;</span><span class="s0">, </span><span class="s2">&quot;a01&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a08&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a05&quot;</span><span class="s0">, </span><span class="s2">&quot;a03&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a09&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a43&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a10&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a36&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a11&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a33&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a12&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a47&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a13&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a44&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a14&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a42&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a15&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a37&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a16&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a48&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a17&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a49&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a18&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a35&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a19&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a46&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a20&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a55&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a21&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a53&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a22&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a60&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a23&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a54&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a24&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a59&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a25&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a56&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a26&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a61&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a27&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a52&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a28&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a57&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a29&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a58&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a30&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a19&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a31&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a07&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a32&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a30&quot;</span><span class="s0">, </span><span class="s2">&quot;a31&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a33&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a58&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a34&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a11&quot;</span><span class="s0">, </span><span class="s2">&quot;a09&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a35&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a60&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a36&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a52&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a37&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a61&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a38&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a14&quot;</span><span class="s0">, </span><span class="s2">&quot;a10&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a39&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a38&quot;</span><span class="s0">, </span><span class="s2">&quot;a40&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a40&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a18&quot;</span><span class="s0">, </span><span class="s2">&quot;a17&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a41&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a34&quot;</span><span class="s0">, </span><span class="s2">&quot;a50&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a42&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a54&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a43&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a55&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a44&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a53&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a45&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a16&quot;</span><span class="s0">, </span><span class="s2">&quot;a15&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a46&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a51&quot;</span><span class="s0">, </span><span class="s2">&quot;a45&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a47&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a59&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a48&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a57&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a49&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a56&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a50&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a12&quot;</span><span class="s0">, </span><span class="s2">&quot;a13&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a51&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a41&quot;</span><span class="s0">, </span><span class="s2">&quot;a39&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a52&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a62&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a53&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a68&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a54&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a70&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a55&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a67&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a56&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a71&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a57&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a64&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a58&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a65&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a59&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a63&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a60&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a69&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a61&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s2">&quot;a66&quot;</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s2">&quot;a62&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a63&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a64&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a65&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a66&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a67&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a68&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a69&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a70&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
        <span class="s2">&quot;a71&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s1">f)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">dependencies</span><span class="s0">, </span><span class="s1">dependents = get_deps(dsk)</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s1">parents = {deps.pop() </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">deps </span><span class="s0">in </span><span class="s1">dependents.items() </span><span class="s0">if not </span><span class="s1">dependencies[key]}</span>

    <span class="s0">def </span><span class="s1">cost(deps):</span>
        <span class="s1">a</span><span class="s0">, </span><span class="s1">b = deps</span>
        <span class="s0">return </span><span class="s1">abs(o[a] - o[b])</span>

    <span class="s1">cost_of_pairs = {key: cost(dependents[key]) </span><span class="s0">for </span><span class="s1">key </span><span class="s0">in </span><span class="s1">parents}</span>
    <span class="s5"># Allow one to be bad, b/c this is hard!</span>
    <span class="s1">costs = sorted(cost_of_pairs.values())</span>
    <span class="s0">assert </span><span class="s1">sum(costs[:-</span><span class="s3">1</span><span class="s1">]) &lt;= </span><span class="s3">25 </span><span class="s0">or </span><span class="s1">sum(costs) &lt;= </span><span class="s3">31</span>


<span class="s0">def </span><span class="s1">test_diagnostics(abcde):</span>
    <span class="s4">r&quot;&quot;&quot; 
        a1  b1  c1  d1  e1 
        /|\ /|\ /|\ /|  / 
       / | X | X | X | / 
      /  |/ \|/ \|/ \|/ 
    a0  b0  c0  d0  e0 
    &quot;&quot;&quot;</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = abcde</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">o[(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == len(dsk) - </span><span class="s3">1</span>
    <span class="s0">assert </span><span class="s1">o[(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == len(dsk) - </span><span class="s3">2</span>
    <span class="s0">assert </span><span class="s1">o[(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)] == len(dsk) - </span><span class="s3">3</span>
    <span class="s1">info</span><span class="s0">, </span><span class="s1">memory_over_time = diagnostics(dsk)</span>
    <span class="s0">assert </span><span class="s1">memory_over_time == [</span><span class="s3">0</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">1</span><span class="s1">]</span>
    <span class="s0">assert </span><span class="s1">{key: val.order </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">info.items()} == {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">4</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">6</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">7</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">8</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">9</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">{key: val.age </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">info.items()} == {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">4</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">5</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">4</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">{key: val.num_dependencies_freed </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">info.items()} == {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">{key: val.num_data_when_run </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">info.items()} == {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">0</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s0">assert </span><span class="s1">{key: val.num_data_when_released </span><span class="s0">for </span><span class="s1">key</span><span class="s0">, </span><span class="s1">val </span><span class="s0">in </span><span class="s1">info.items()} == {</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
        <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">3</span><span class="s0">,</span>
        <span class="s1">(d</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">2</span><span class="s0">,</span>
        <span class="s1">(e</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): </span><span class="s3">1</span><span class="s0">,</span>
    <span class="s1">}</span>


<span class="s0">def </span><span class="s1">test_xarray_like_reduction():</span>
    <span class="s1">a</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">c</span><span class="s0">, </span><span class="s1">d</span><span class="s0">, </span><span class="s1">e = list(</span><span class="s2">&quot;abcde&quot;</span><span class="s1">)</span>

    <span class="s1">dsk = {}</span>
    <span class="s0">for </span><span class="s1">ix </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
        <span class="s1">part = {</span>
            <span class="s5"># Part1</span>
            <span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">,</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
            <span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix)</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
            <span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(a</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
            <span class="s1">(c</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
            <span class="s1">(c</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
            <span class="s1">(c</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(b</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s1">ix))</span><span class="s0">,</span>
        <span class="s1">}</span>
        <span class="s1">dsk.update(part)</span>
    <span class="s0">for </span><span class="s1">ix </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
        <span class="s1">dsk.update(</span>
            <span class="s1">{</span>
                <span class="s1">(d</span><span class="s0">, </span><span class="s1">ix): (f</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">ix</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">ix</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(c</span><span class="s0">, </span><span class="s1">ix</span><span class="s0">, </span><span class="s3">2</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">}</span>
        <span class="s1">)</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">pressure = diagnostics(dsk</span><span class="s0">, </span><span class="s1">o=o)</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= </span><span class="s3">9</span>


<span class="s1">@pytest.mark.parametrize(</span>
    <span class="s2">&quot;optimize&quot;</span><span class="s0">,</span>
    <span class="s1">[</span><span class="s0">True, False</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">)</span>
<span class="s0">def </span><span class="s1">test_array_vs_dataframe(optimize):</span>
    <span class="s1">xr = pytest.importorskip(</span><span class="s2">&quot;xarray&quot;</span><span class="s1">)</span>

    <span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>

    <span class="s1">size = </span><span class="s3">5000</span>
    <span class="s1">ds = xr.Dataset(</span>
        <span class="s1">dict(</span>
            <span class="s1">anom_u=(</span>
                <span class="s1">[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;face&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">da.random.random((size</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
            <span class="s1">anom_v=(</span>
                <span class="s1">[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;face&quot;</span><span class="s0">, </span><span class="s2">&quot;j&quot;</span><span class="s0">, </span><span class="s2">&quot;i&quot;</span><span class="s1">]</span><span class="s0">,</span>
                <span class="s1">da.random.random((size</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s0">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
            <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span>
    <span class="s1">)</span>

    <span class="s1">quad = ds**</span><span class="s3">2</span>
    <span class="s1">quad[</span><span class="s2">&quot;uv&quot;</span><span class="s1">] = ds.anom_u * ds.anom_v</span>
    <span class="s1">mean = quad.mean(</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
    <span class="s1">diag_array = diagnostics(collections_to_dsk([mean]</span><span class="s0">, </span><span class="s1">optimize_graph=optimize))</span>
    <span class="s1">diag_df = diagnostics(</span>
        <span class="s1">collections_to_dsk([mean.to_dask_dataframe()]</span><span class="s0">, </span><span class="s1">optimize_graph=optimize)</span>
    <span class="s1">)</span>
    <span class="s0">assert </span><span class="s1">max(diag_df[</span><span class="s3">1</span><span class="s1">]) == max(diag_array[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">max(diag_array[</span><span class="s3">1</span><span class="s1">]) &lt; </span><span class="s3">50</span>


<span class="s0">def </span><span class="s1">test_anom_mean():</span>
    <span class="s1">np = pytest.importorskip(</span><span class="s2">&quot;numpy&quot;</span><span class="s1">)</span>
    <span class="s1">xr = pytest.importorskip(</span><span class="s2">&quot;xarray&quot;</span><span class="s1">)</span>

    <span class="s0">import </span><span class="s1">dask.array </span><span class="s0">as </span><span class="s1">da</span>
    <span class="s0">from </span><span class="s1">dask.utils </span><span class="s0">import </span><span class="s1">parse_bytes</span>

    <span class="s1">data = da.random.random(</span>
        <span class="s1">(</span><span class="s3">260</span><span class="s0">, </span><span class="s3">1310720</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s1">parse_bytes(</span><span class="s2">&quot;10MiB&quot;</span><span class="s1">) // </span><span class="s3">8</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">ngroups = data.shape[</span><span class="s3">0</span><span class="s1">] // </span><span class="s3">4</span>
    <span class="s1">arr = xr.DataArray(</span>
        <span class="s1">data</span><span class="s0">,</span>
        <span class="s1">dims=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">coords={</span><span class="s2">&quot;day&quot;</span><span class="s1">: (</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">np.arange(data.shape[</span><span class="s3">0</span><span class="s1">]) % ngroups)}</span><span class="s0">,</span>
    <span class="s1">)</span>
    <span class="s1">data = da.random.random((</span><span class="s3">5</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">chunks=(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span>

    <span class="s1">arr = xr.DataArray(</span>
        <span class="s1">data</span><span class="s0">,</span>
        <span class="s1">dims=[</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s2">&quot;x&quot;</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">coords={</span><span class="s2">&quot;day&quot;</span><span class="s1">: (</span><span class="s2">&quot;time&quot;</span><span class="s0">, </span><span class="s1">np.arange(</span><span class="s3">5</span><span class="s1">) % </span><span class="s3">2</span><span class="s1">)}</span><span class="s0">,</span>
    <span class="s1">)</span>

    <span class="s1">clim = arr.groupby(</span><span class="s2">&quot;day&quot;</span><span class="s1">).mean(dim=</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
    <span class="s1">anom = arr.groupby(</span><span class="s2">&quot;day&quot;</span><span class="s1">) - clim</span>
    <span class="s1">anom_mean = anom.mean(dim=</span><span class="s2">&quot;time&quot;</span><span class="s1">)</span>
    <span class="s1">_</span><span class="s0">, </span><span class="s1">pressure = diagnostics(anom_mean.__dask_graph__())</span>
    <span class="s0">assert </span><span class="s1">max(pressure) &lt;= </span><span class="s3">9</span>


<span class="s0">def </span><span class="s1">test_anom_mean_raw():</span>
    <span class="s1">dsk = {</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;random_sample&quot;</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;random_sample&quot;</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;random_sample&quot;</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;random_sample&quot;</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">f</span><span class="s0">, </span><span class="s2">&quot;random_sample&quot;</span><span class="s0">, None, </span><span class="s1">(</span><span class="s3">1</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">[]</span><span class="s0">, </span><span class="s1">{})</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;g3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b0&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;g1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c0&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;b2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;g3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;b1&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;c2&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;g2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)])</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">o = order(dsk)</span>

    <span class="s5"># The left hand computation branch should complete before we start loading</span>
    <span class="s5"># more data</span>
    <span class="s1">nodes_to_finish_before_loading_more_data = [</span>
        <span class="s1">(</span><span class="s2">&quot;f&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;d&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
    <span class="s1">]</span>
    <span class="s0">for </span><span class="s1">n </span><span class="s0">in </span><span class="s1">nodes_to_finish_before_loading_more_data:</span>
        <span class="s0">assert </span><span class="s1">o[n] &lt; o[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>
        <span class="s0">assert </span><span class="s1">o[n] &lt; o[(</span><span class="s2">&quot;a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)]</span>


<span class="s0">def </span><span class="s1">test_flaky_array_reduction():</span>
    <span class="s1">first = {</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-10d721567ef5a0d6a0e1afae8a87c066&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-98a32cd9f4fadbed908fffb32e0c9679&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-fdb340546b01334890192fcfa55fa0d9&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-7edba1c5a284fcec88b9efdda6c2135f&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-cc19342c8116d616fc6573f5d20b5762&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-540e88b7d9289f6b5461b95a0787af3e&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-17c7b5c6eed42e203858b3f6dde16003&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-0c98c5a4517f58f8268985e7464daace&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;random_sample-e16bcfb15a013023c98a21e2f03d66a9&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-23adb4747560e6e33afd63c5bb179709&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;random_sample-02eaa4a8dbb23fac4db22ad034c401b3&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>

    <span class="s1">other = {</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-e79dd3b9757c9fb2ad7ade96f3f6c814&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-0df65d9a6e168673f32082f59f19576a&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-c7647920facf0e557f947b7a6626b7be&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-d6bd425ea61739f1eaa71762fe3bbbd7&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_agg-aggregate-05071ebaabb68a64c180f6f443c5c8f4&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;mean_chunk-fd17feaf0728ea7a89d119d3fd172c75&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s3">2</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">3</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s2">&quot;random_sample&quot;</span><span class="s0">,</span>
            <span class="s1">(</span><span class="s3">10</span><span class="s0">, </span><span class="s3">1</span><span class="s0">, </span><span class="s3">987</span><span class="s0">, </span><span class="s3">1920</span><span class="s1">)</span><span class="s0">,</span>
            <span class="s1">[]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-a7c475f79a46af4265b189ffdc000bb3&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-e7d9fd7c132e12007a4b4f62ce443a75&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[</span>
                <span class="s1">(</span>
                    <span class="s1">f</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;random_sample-a155d5a37ac5e09ede89c98a3bfcadff&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                    <span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
                <span class="s1">)</span>
            <span class="s1">]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span>
            <span class="s2">&quot;mean_chunk-mean_combine-partial-57413f0bb18da78db0f689a096c7fbbf&quot;</span><span class="s0">,</span>
            <span class="s3">1</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
            <span class="s3">0</span><span class="s0">,</span>
        <span class="s1">): (</span>
            <span class="s1">f</span><span class="s0">,</span>
            <span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;random_sample-241fdbadc062900adc59d1a79c4c41e1&quot;</span><span class="s0">, </span><span class="s3">4</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s3">2</span><span class="s1">)]</span><span class="s0">,</span>
        <span class="s1">)</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">first_pressure = max(diagnostics(first)[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s1">second_pressure = max(diagnostics(other)[</span><span class="s3">1</span><span class="s1">])</span>
    <span class="s0">assert </span><span class="s1">first_pressure == second_pressure</span>


<span class="s0">def </span><span class="s1">test_flox_reduction():</span>
    <span class="s5"># TODO: It would be nice to scramble keys to ensure we're not comparing keys</span>
    <span class="s1">dsk = {</span>
        <span class="s2">&quot;A0&quot;</span><span class="s1">: (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;B1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;B2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;B2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s1">[(f</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;A2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;C2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))])</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;EE&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;EE&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (</span><span class="s2">&quot;E&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">)</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F1&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F1&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F1&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;EE&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F2&quot;</span><span class="s0">, </span><span class="s3">0</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B11&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F2&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;B22&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
        <span class="s1">(</span><span class="s2">&quot;F2&quot;</span><span class="s0">, </span><span class="s3">2</span><span class="s1">): (f</span><span class="s0">, </span><span class="s2">&quot;A0&quot;</span><span class="s0">, </span><span class="s1">(</span><span class="s2">&quot;EE&quot;</span><span class="s0">, </span><span class="s3">1</span><span class="s1">))</span><span class="s0">,</span>
    <span class="s1">}</span>
    <span class="s1">o = order(dsk)</span>
    <span class="s0">assert </span><span class="s1">max(o[(</span><span class="s2">&quot;F1&quot;</span><span class="s0">, </span><span class="s1">ix)] </span><span class="s0">for </span><span class="s1">ix </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">)) &lt; min(o[(</span><span class="s2">&quot;F2&quot;</span><span class="s0">, </span><span class="s1">ix)] </span><span class="s0">for </span><span class="s1">ix </span><span class="s0">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">))</span>
</pre>
</body>
</html>