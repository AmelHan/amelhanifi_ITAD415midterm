<html>
<head>
<title>test_lsq_linear.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cc7832;}
.s1 { color: #a9b7c6;}
.s2 { color: #6897bb;}
.s3 { color: #808080;}
.s4 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_lsq_linear.py</font>
</center></td></tr></table>
<pre><span class="s0">import </span><span class="s1">pytest</span>

<span class="s0">import </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span>
<span class="s0">from </span><span class="s1">numpy.linalg </span><span class="s0">import </span><span class="s1">lstsq</span>
<span class="s0">from </span><span class="s1">numpy.testing </span><span class="s0">import </span><span class="s1">assert_allclose</span><span class="s0">, </span><span class="s1">assert_equal</span><span class="s0">, </span><span class="s1">assert_</span>

<span class="s0">from </span><span class="s1">scipy.sparse </span><span class="s0">import </span><span class="s1">rand</span><span class="s0">, </span><span class="s1">coo_matrix</span>
<span class="s0">from </span><span class="s1">scipy.sparse.linalg </span><span class="s0">import </span><span class="s1">aslinearoperator</span>
<span class="s0">from </span><span class="s1">scipy.optimize </span><span class="s0">import </span><span class="s1">lsq_linear</span>
<span class="s0">from </span><span class="s1">scipy.optimize._minimize </span><span class="s0">import </span><span class="s1">Bounds</span>


<span class="s1">A = np.array([</span>
    <span class="s1">[</span><span class="s2">0.171</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.057</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[-</span><span class="s2">0.049</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.248</span><span class="s1">]</span><span class="s0">,</span>
    <span class="s1">[-</span><span class="s2">0.166</span><span class="s0">, </span><span class="s2">0.054</span><span class="s1">]</span><span class="s0">,</span>
<span class="s1">])</span>
<span class="s1">b = np.array([</span><span class="s2">0.074</span><span class="s0">, </span><span class="s2">1.014</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.383</span><span class="s1">])</span>


<span class="s0">class </span><span class="s1">BaseMixin:</span>
    <span class="s0">def </span><span class="s1">setup_method(self):</span>
        <span class="s1">self.rnd = np.random.RandomState(</span><span class="s2">0</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_dense_no_bounds(self):</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">, </span><span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">])</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">res.unbounded_sol[</span><span class="s2">0</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_dense_bounds(self):</span>
        <span class="s3"># Solutions for comparison are taken from MATLAB.</span>
        <span class="s1">lb = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">10</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">unbounded_sol = lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">])</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

        <span class="s1">lb = np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">-np.inf])</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4.084174437334673</span><span class="s1">])</span><span class="s0">,</span>
                            <span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

        <span class="s1">lb = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">np.inf)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0.448427311733504</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span><span class="s0">,</span>
                            <span class="s1">atol=</span><span class="s2">1e-15</span><span class="s1">)</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

        <span class="s1">ub = np.array([np.inf</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">])</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s2">0.105560998682388</span><span class="s0">, </span><span class="s1">-</span><span class="s2">5</span><span class="s1">]))</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

        <span class="s1">ub = np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">np.inf])</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(-np.inf</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">np.array([-</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4.181102129483254</span><span class="s1">]))</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

        <span class="s1">lb = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">np.array([</span><span class="s2">0.005236663400791</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s1">]))</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">unbounded_sol)</span>

    <span class="s0">def </span><span class="s1">test_bounds_variants(self):</span>
        <span class="s1">x = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">3</span><span class="s1">])</span>
        <span class="s1">A = self.rnd.uniform(size=(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">b = A@x</span>
        <span class="s1">lb = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">bounds_old = (lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">bounds_new = Bounds(lb</span><span class="s0">, </span><span class="s1">ub)</span>
        <span class="s1">res_old = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds_old)</span>
        <span class="s1">res_new = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds_new)</span>
        <span class="s0">assert not </span><span class="s1">np.allclose(res_new.x</span><span class="s0">, </span><span class="s1">res_new.unbounded_sol[</span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">assert_allclose(res_old.x</span><span class="s0">, </span><span class="s1">res_new.x)</span>

    <span class="s0">def </span><span class="s1">test_np_matrix(self):</span>
        <span class="s3"># gh-10711</span>
        <span class="s0">with </span><span class="s1">np.testing.suppress_warnings() </span><span class="s0">as </span><span class="s1">sup:</span>
            <span class="s1">sup.filter(PendingDeprecationWarning)</span>
            <span class="s1">A = np.matrix([[</span><span class="s2">20</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">3</span><span class="s1">]</span><span class="s0">, </span><span class="s1">[</span><span class="s2">10</span><span class="s0">, </span><span class="s1">-</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]])</span>
        <span class="s1">k = np.array([</span><span class="s2">20</span><span class="s0">, </span><span class="s2">15</span><span class="s1">])</span>
        <span class="s1">lsq_linear(A</span><span class="s0">, </span><span class="s1">k)</span>

    <span class="s0">def </span><span class="s1">test_dense_rank_deficient(self):</span>
        <span class="s1">A = np.array([[-</span><span class="s2">0.307</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.184</span><span class="s1">]])</span>
        <span class="s1">b = np.array([</span><span class="s2">0.773</span><span class="s1">])</span>
        <span class="s1">lb = [-</span><span class="s2">0.1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.1</span><span class="s1">]</span>
        <span class="s1">ub = [</span><span class="s2">0.1</span><span class="s0">, </span><span class="s2">0.1</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">[-</span><span class="s2">0.1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.1</span><span class="s1">])</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">A = np.array([</span>
            <span class="s1">[</span><span class="s2">0.334</span><span class="s0">, </span><span class="s2">0.668</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[-</span><span class="s2">0.516</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1.032</span><span class="s1">]</span><span class="s0">,</span>
            <span class="s1">[</span><span class="s2">0.192</span><span class="s0">, </span><span class="s2">0.384</span><span class="s1">]</span><span class="s0">,</span>
        <span class="s1">])</span>
        <span class="s1">b = np.array([-</span><span class="s2">1.436</span><span class="s0">, </span><span class="s2">0.135</span><span class="s0">, </span><span class="s2">0.909</span><span class="s1">])</span>
        <span class="s1">lb = [</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">]</span>
        <span class="s1">ub = [</span><span class="s2">1</span><span class="s0">, </span><span class="s1">-</span><span class="s2">0.5</span><span class="s1">]</span>
        <span class="s0">for </span><span class="s1">lsq_solver </span><span class="s0">in </span><span class="s1">self.lsq_solvers:</span>
            <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method</span><span class="s0">,</span>
                             <span class="s1">lsq_solver=lsq_solver)</span>
            <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-11</span><span class="s1">)</span>
            <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">])</span>

    <span class="s0">def </span><span class="s1">test_full_result(self):</span>
        <span class="s1">lb = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">ub = np.array([</span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s1">])</span>
        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">method=self.method)</span>

        <span class="s1">assert_allclose(res.x</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0.005236663400791</span><span class="s0">, </span><span class="s1">-</span><span class="s2">4</span><span class="s1">])</span>
        <span class="s1">assert_allclose(res.unbounded_sol[</span><span class="s2">0</span><span class="s1">]</span><span class="s0">, </span><span class="s1">lstsq(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">rcond=-</span><span class="s2">1</span><span class="s1">)[</span><span class="s2">0</span><span class="s1">])</span>

        <span class="s1">r = A.dot(res.x) - b</span>
        <span class="s1">assert_allclose(res.cost</span><span class="s0">, </span><span class="s2">0.5 </span><span class="s1">* np.dot(r</span><span class="s0">, </span><span class="s1">r))</span>
        <span class="s1">assert_allclose(res.fun</span><span class="s0">, </span><span class="s1">r)</span>

        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-12</span><span class="s1">)</span>
        <span class="s1">assert_equal(res.active_mask</span><span class="s0">, </span><span class="s1">[</span><span class="s2">0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">1</span><span class="s1">])</span>
        <span class="s1">assert_(res.nit &lt; </span><span class="s2">15</span><span class="s1">)</span>
        <span class="s1">assert_(res.status == </span><span class="s2">1 </span><span class="s0">or </span><span class="s1">res.status == </span><span class="s2">3</span><span class="s1">)</span>
        <span class="s1">assert_(isinstance(res.message</span><span class="s0">, </span><span class="s1">str))</span>
        <span class="s1">assert_(res.success)</span>

    <span class="s3"># This is a test for issue #9982.</span>
    <span class="s0">def </span><span class="s1">test_almost_singular(self):</span>
        <span class="s1">A = np.array(</span>
            <span class="s1">[[</span><span class="s2">0.8854232310355122</span><span class="s0">, </span><span class="s2">0.0365312146937765</span><span class="s0">, </span><span class="s2">0.0365312146836789</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s2">0.3742460132129041</span><span class="s0">, </span><span class="s2">0.0130523214078376</span><span class="s0">, </span><span class="s2">0.0130523214077873</span><span class="s1">]</span><span class="s0">,</span>
             <span class="s1">[</span><span class="s2">0.9680633871281361</span><span class="s0">, </span><span class="s2">0.0319366128718639</span><span class="s0">, </span><span class="s2">0.0319366128718388</span><span class="s1">]])</span>

        <span class="s1">b = np.array(</span>
            <span class="s1">[</span><span class="s2">0.0055029366538097</span><span class="s0">, </span><span class="s2">0.0026677442422208</span><span class="s0">, </span><span class="s2">0.0066612514782381</span><span class="s1">])</span>

        <span class="s1">result = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">method=self.method)</span>
        <span class="s1">assert_(result.cost &lt; </span><span class="s2">1.1e-8</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_large_rank_deficient(self):</span>
        <span class="s1">np.random.seed(</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">n</span><span class="s0">, </span><span class="s1">m = np.sort(np.random.randint(</span><span class="s2">2</span><span class="s0">, </span><span class="s2">1000</span><span class="s0">, </span><span class="s1">size=</span><span class="s2">2</span><span class="s1">))</span>
        <span class="s1">m *= </span><span class="s2">2   </span><span class="s3"># make m &gt;&gt; n</span>
        <span class="s1">A = </span><span class="s2">1.0 </span><span class="s1">* np.random.randint(-</span><span class="s2">99</span><span class="s0">, </span><span class="s2">99</span><span class="s0">, </span><span class="s1">size=[m</span><span class="s0">, </span><span class="s1">n])</span>
        <span class="s1">b = </span><span class="s2">1.0 </span><span class="s1">* np.random.randint(-</span><span class="s2">99</span><span class="s0">, </span><span class="s2">99</span><span class="s0">, </span><span class="s1">size=[m])</span>
        <span class="s1">bounds = </span><span class="s2">1.0 </span><span class="s1">* np.sort(np.random.randint(-</span><span class="s2">99</span><span class="s0">, </span><span class="s2">99</span><span class="s0">, </span><span class="s1">size=(</span><span class="s2">2</span><span class="s0">, </span><span class="s1">n))</span><span class="s0">, </span><span class="s1">axis=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">bounds[</span><span class="s2">1</span><span class="s0">, </span><span class="s1">:] += </span><span class="s2">1.0  </span><span class="s3"># ensure up &gt; lb</span>

        <span class="s3"># Make the A matrix strongly rank deficient by replicating some columns</span>
        <span class="s1">w = np.random.choice(n</span><span class="s0">, </span><span class="s1">n)  </span><span class="s3"># Select random columns with duplicates</span>
        <span class="s1">A = A[:</span><span class="s0">, </span><span class="s1">w]</span>

        <span class="s1">x_bvls = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds=bounds</span><span class="s0">, </span><span class="s1">method=</span><span class="s4">'bvls'</span><span class="s1">).x</span>
        <span class="s1">x_trf = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds=bounds</span><span class="s0">, </span><span class="s1">method=</span><span class="s4">'trf'</span><span class="s1">).x</span>

        <span class="s1">cost_bvls = np.sum((A @ x_bvls - b)**</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">cost_trf = np.sum((A @ x_trf - b)**</span><span class="s2">2</span><span class="s1">)</span>

        <span class="s1">assert_(abs(cost_bvls - cost_trf) &lt; cost_trf*</span><span class="s2">1e-10</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_convergence_small_matrix(self):</span>
        <span class="s1">A = np.array([[</span><span class="s2">49.0</span><span class="s0">, </span><span class="s2">41.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">32.0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[-</span><span class="s2">19.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">32.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">8.0</span><span class="s1">]</span><span class="s0">,</span>
                      <span class="s1">[-</span><span class="s2">13.0</span><span class="s0">, </span><span class="s2">10.0</span><span class="s0">, </span><span class="s2">69.0</span><span class="s1">]])</span>
        <span class="s1">b = np.array([-</span><span class="s2">41.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">90.0</span><span class="s0">, </span><span class="s2">47.0</span><span class="s1">])</span>
        <span class="s1">bounds = np.array([[</span><span class="s2">31.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">44.0</span><span class="s0">, </span><span class="s2">26.0</span><span class="s1">]</span><span class="s0">,</span>
                           <span class="s1">[</span><span class="s2">54.0</span><span class="s0">, </span><span class="s1">-</span><span class="s2">32.0</span><span class="s0">, </span><span class="s2">28.0</span><span class="s1">]])</span>

        <span class="s1">x_bvls = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds=bounds</span><span class="s0">, </span><span class="s1">method=</span><span class="s4">'bvls'</span><span class="s1">).x</span>
        <span class="s1">x_trf = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">bounds=bounds</span><span class="s0">, </span><span class="s1">method=</span><span class="s4">'trf'</span><span class="s1">).x</span>

        <span class="s1">cost_bvls = np.sum((A @ x_bvls - b)**</span><span class="s2">2</span><span class="s1">)</span>
        <span class="s1">cost_trf = np.sum((A @ x_trf - b)**</span><span class="s2">2</span><span class="s1">)</span>

        <span class="s1">assert_(abs(cost_bvls - cost_trf) &lt; cost_trf*</span><span class="s2">1e-10</span><span class="s1">)</span>


<span class="s0">class </span><span class="s1">SparseMixin:</span>
    <span class="s0">def </span><span class="s1">test_sparse_and_LinearOperator(self):</span>
        <span class="s1">m = </span><span class="s2">5000</span>
        <span class="s1">n = </span><span class="s2">1000</span>
        <span class="s1">A = rand(m</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">b = self.rnd.randn(m)</span>
        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

        <span class="s1">A = aslinearoperator(A)</span>
        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b)</span>
        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_sparse_bounds(self):</span>
        <span class="s1">m = </span><span class="s2">5000</span>
        <span class="s1">n = </span><span class="s2">1000</span>
        <span class="s1">A = rand(m</span><span class="s0">, </span><span class="s1">n</span><span class="s0">, </span><span class="s1">random_state=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s1">b = self.rnd.randn(m)</span>
        <span class="s1">lb = self.rnd.randn(n)</span>
        <span class="s1">ub = lb + </span><span class="s2">1</span>
        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub))</span>
        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s2">1e-13</span><span class="s0">,</span>
                         <span class="s1">lsmr_maxiter=</span><span class="s2">1500</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

        <span class="s1">res = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">(lb</span><span class="s0">, </span><span class="s1">ub)</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s4">'auto'</span><span class="s1">)</span>
        <span class="s1">assert_allclose(res.optimality</span><span class="s0">, </span><span class="s2">0.0</span><span class="s0">, </span><span class="s1">atol=</span><span class="s2">1e-6</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_sparse_ill_conditioned(self):</span>
        <span class="s3"># Sparse matrix with condition number of ~4 million</span>
        <span class="s1">data = np.array([</span><span class="s2">1.</span><span class="s0">, </span><span class="s2">1.</span><span class="s0">, </span><span class="s2">1.</span><span class="s0">, </span><span class="s2">1. </span><span class="s1">+ </span><span class="s2">1e-6</span><span class="s0">, </span><span class="s2">1.</span><span class="s1">])</span>
        <span class="s1">row = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">col = np.array([</span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s0">, </span><span class="s2">1</span><span class="s0">, </span><span class="s2">0</span><span class="s0">, </span><span class="s2">2</span><span class="s1">])</span>
        <span class="s1">A = coo_matrix((data</span><span class="s0">, </span><span class="s1">(row</span><span class="s0">, </span><span class="s1">col))</span><span class="s0">, </span><span class="s1">shape=(</span><span class="s2">3</span><span class="s0">, </span><span class="s2">3</span><span class="s1">))</span>

        <span class="s3"># Get the exact solution</span>
        <span class="s1">exact_sol = lsq_linear(A.toarray()</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'exact'</span><span class="s1">)</span>

        <span class="s3"># Default lsmr arguments should not fully converge the solution</span>
        <span class="s1">default_lsmr_sol = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(AssertionError</span><span class="s0">, </span><span class="s1">match=</span><span class="s4">&quot;&quot;</span><span class="s1">):</span>
            <span class="s1">assert_allclose(exact_sol.x</span><span class="s0">, </span><span class="s1">default_lsmr_sol.x)</span>

        <span class="s3"># By increasing the maximum lsmr iters, it will converge</span>
        <span class="s1">conv_lsmr = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_maxiter=</span><span class="s2">10</span><span class="s1">)</span>
        <span class="s1">assert_allclose(exact_sol.x</span><span class="s0">, </span><span class="s1">conv_lsmr.x)</span>


<span class="s0">class </span><span class="s1">TestTRF(BaseMixin</span><span class="s0">, </span><span class="s1">SparseMixin):</span>
    <span class="s1">method = </span><span class="s4">'trf'</span>
    <span class="s1">lsq_solvers = [</span><span class="s4">'exact'</span><span class="s0">, </span><span class="s4">'lsmr'</span><span class="s1">]</span>


<span class="s0">class </span><span class="s1">TestBVLS(BaseMixin):</span>
    <span class="s1">method = </span><span class="s4">'bvls'</span>
    <span class="s1">lsq_solvers = [</span><span class="s4">'exact'</span><span class="s1">]</span>


<span class="s0">class </span><span class="s1">TestErrorChecking:</span>
    <span class="s0">def </span><span class="s1">test_option_lsmr_tol(self):</span>
        <span class="s3"># Should work with a positive float, string equal to 'auto', or None</span>
        <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s2">1e-2</span><span class="s1">)</span>
        <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s4">'auto'</span><span class="s1">)</span>
        <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s3"># Should raise error with negative float, strings</span>
        <span class="s3"># other than 'auto', and integers</span>
        <span class="s1">err_message = </span><span class="s4">&quot;`lsmr_tol` must be None, 'auto', or positive float.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_message):</span>
            <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=-</span><span class="s2">0.1</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_message):</span>
            <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s4">'foo'</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_message):</span>
            <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_tol=</span><span class="s2">1</span><span class="s1">)</span>

    <span class="s0">def </span><span class="s1">test_option_lsmr_maxiter(self):</span>
        <span class="s3"># Should work with positive integers or None</span>
        <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_maxiter=</span><span class="s2">1</span><span class="s1">)</span>
        <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_maxiter=</span><span class="s0">None</span><span class="s1">)</span>

        <span class="s3"># Should raise error with 0 or negative max iter</span>
        <span class="s1">err_message = </span><span class="s4">&quot;`lsmr_maxiter` must be None or positive integer.&quot;</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_message):</span>
            <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_maxiter=</span><span class="s2">0</span><span class="s1">)</span>
        <span class="s0">with </span><span class="s1">pytest.raises(ValueError</span><span class="s0">, </span><span class="s1">match=err_message):</span>
            <span class="s1">_ = lsq_linear(A</span><span class="s0">, </span><span class="s1">b</span><span class="s0">, </span><span class="s1">lsq_solver=</span><span class="s4">'lsmr'</span><span class="s0">, </span><span class="s1">lsmr_maxiter=-</span><span class="s2">1</span><span class="s1">)</span>
</pre>
</body>
</html>