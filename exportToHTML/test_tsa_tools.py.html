<html>
<head>
<title>test_tsa_tools.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #629755; font-style: italic;}
.s1 { color: #a9b7c6;}
.s2 { color: #cc7832;}
.s3 { color: #6897bb;}
.s4 { color: #808080;}
.s5 { color: #6a8759;}
</style>
</head>
<body bgcolor="#2b2b2b">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
test_tsa_tools.py</font>
</center></td></tr></table>
<pre><span class="s0">&quot;&quot;&quot;tests for some time series analysis functions 
 
&quot;&quot;&quot;</span>
<span class="s2">from </span><span class="s1">statsmodels.compat.pandas </span><span class="s2">import </span><span class="s1">assert_frame_equal</span><span class="s2">, </span><span class="s1">assert_series_equal</span>

<span class="s2">import </span><span class="s1">numpy </span><span class="s2">as </span><span class="s1">np</span>
<span class="s2">from </span><span class="s1">numpy.testing </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">assert_array_almost_equal</span><span class="s2">,</span>
    <span class="s1">assert_array_equal</span><span class="s2">,</span>
    <span class="s1">assert_equal</span><span class="s2">,</span>
    <span class="s1">assert_raises</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">pandas </span><span class="s2">as </span><span class="s1">pd</span>
<span class="s2">import </span><span class="s1">pytest</span>

<span class="s2">from </span><span class="s1">statsmodels </span><span class="s2">import </span><span class="s1">regression</span>
<span class="s2">from </span><span class="s1">statsmodels.datasets </span><span class="s2">import </span><span class="s1">macrodata</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa </span><span class="s2">import </span><span class="s1">stattools</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.tests.results </span><span class="s2">import </span><span class="s1">savedrvs</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.tests.results.datamlw_tls </span><span class="s2">import </span><span class="s1">(</span>
    <span class="s1">mlacf</span><span class="s2">,</span>
    <span class="s1">mlccf</span><span class="s2">,</span>
    <span class="s1">mlpacf</span><span class="s2">,</span>
    <span class="s1">mlywar</span><span class="s2">,</span>
<span class="s1">)</span>
<span class="s2">import </span><span class="s1">statsmodels.tsa.tsatools </span><span class="s2">as </span><span class="s1">tools</span>
<span class="s2">from </span><span class="s1">statsmodels.tsa.tsatools </span><span class="s2">import </span><span class="s1">vec</span><span class="s2">, </span><span class="s1">vech</span>

<span class="s1">xo = savedrvs.rvsdata.xar2</span>
<span class="s1">x100 = xo[-</span><span class="s3">100</span><span class="s1">:] / </span><span class="s3">1000.0</span>
<span class="s1">x1000 = xo / </span><span class="s3">1000.0</span>


<span class="s2">def </span><span class="s1">test_acf():</span>
    <span class="s1">acf_x = stattools.acf(x100</span><span class="s2">, </span><span class="s1">adjusted=</span><span class="s2">False, </span><span class="s1">fft=</span><span class="s2">False, </span><span class="s1">nlags=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(mlacf.acf100.ravel()</span><span class="s2">, </span><span class="s1">acf_x</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)  </span><span class="s4"># why only dec=8</span>
    <span class="s1">acf_x = stattools.acf(x1000</span><span class="s2">, </span><span class="s1">adjusted=</span><span class="s2">False, </span><span class="s1">fft=</span><span class="s2">False, </span><span class="s1">nlags=</span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(</span>
        <span class="s1">mlacf.acf1000.ravel()</span><span class="s2">, </span><span class="s1">acf_x</span><span class="s2">, </span><span class="s3">8</span>
    <span class="s1">)  </span><span class="s4"># why only dec=9</span>


<span class="s2">def </span><span class="s1">test_ccf():</span>
    <span class="s1">ccf_x = stattools.ccf(x100[</span><span class="s3">4</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">x100[:-</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">adjusted=</span><span class="s2">False</span><span class="s1">)[:</span><span class="s3">21</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(mlccf.ccf100.ravel()[:</span><span class="s3">21</span><span class="s1">][::-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">ccf_x</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">ccf_x = stattools.ccf(x1000[</span><span class="s3">4</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">x1000[:-</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">adjusted=</span><span class="s2">False</span><span class="s1">)[:</span><span class="s3">21</span><span class="s1">]</span>
    <span class="s1">assert_array_almost_equal(mlccf.ccf1000.ravel()[:</span><span class="s3">21</span><span class="s1">][::-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s1">ccf_x</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_pacf_yw():</span>
    <span class="s1">pacfyw = stattools.pacf_yw(x100</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s1">method=</span><span class="s5">&quot;mle&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(mlpacf.pacf100.ravel()</span><span class="s2">, </span><span class="s1">pacfyw</span><span class="s2">, </span><span class="s3">1</span><span class="s1">)</span>
    <span class="s1">pacfyw = stattools.pacf_yw(x1000</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s1">method=</span><span class="s5">&quot;mle&quot;</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(mlpacf.pacf1000.ravel()</span><span class="s2">, </span><span class="s1">pacfyw</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s4"># assert False</span>


<span class="s2">def </span><span class="s1">test_pacf_ols():</span>
    <span class="s1">pacfols = stattools.pacf_ols(x100</span><span class="s2">, </span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(mlpacf.pacf100.ravel()</span><span class="s2">, </span><span class="s1">pacfols</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s1">pacfols = stattools.pacf_ols(x1000</span><span class="s2">, </span><span class="s3">20</span><span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(mlpacf.pacf1000.ravel()</span><span class="s2">, </span><span class="s1">pacfols</span><span class="s2">, </span><span class="s3">8</span><span class="s1">)</span>
    <span class="s4"># assert False</span>


<span class="s2">def </span><span class="s1">test_ywcoef():</span>
    <span class="s1">assert_array_almost_equal(</span>
        <span class="s1">mlywar.arcoef100[</span><span class="s3">1</span><span class="s1">:]</span><span class="s2">,</span>
        <span class="s1">-regression.yule_walker(x100</span><span class="s2">, </span><span class="s3">10</span><span class="s2">, </span><span class="s1">method=</span><span class="s5">&quot;mle&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s3">8</span><span class="s2">,</span>
    <span class="s1">)</span>
    <span class="s1">assert_array_almost_equal(</span>
        <span class="s1">mlywar.arcoef1000[</span><span class="s3">1</span><span class="s1">:]</span><span class="s2">,</span>
        <span class="s1">-regression.yule_walker(x1000</span><span class="s2">, </span><span class="s3">20</span><span class="s2">, </span><span class="s1">method=</span><span class="s5">&quot;mle&quot;</span><span class="s1">)[</span><span class="s3">0</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s3">8</span><span class="s2">,</span>
    <span class="s1">)</span>


<span class="s1">@pytest.mark.smoke</span>
<span class="s2">def </span><span class="s1">test_yule_walker_inter():</span>
    <span class="s4"># see 1869</span>
    <span class="s1">x = np.array([</span><span class="s3">1</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">-</span><span class="s3">2</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">-</span><span class="s3">3</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">])</span>
    <span class="s4"># it works</span>
    <span class="s1">regression.yule_walker(x</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_duplication_matrix(reset_randomstate):</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">10</span><span class="s1">):</span>
        <span class="s1">m = tools.unvech(np.random.randn(k * (k + </span><span class="s3">1</span><span class="s1">) // </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s1">Dk = tools.duplication_matrix(k)</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(vec(m)</span><span class="s2">, </span><span class="s1">np.dot(Dk</span><span class="s2">, </span><span class="s1">vech(m)))</span>


<span class="s2">def </span><span class="s1">test_elimination_matrix(reset_randomstate):</span>
    <span class="s2">for </span><span class="s1">k </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">2</span><span class="s2">, </span><span class="s3">10</span><span class="s1">):</span>
        <span class="s1">m = np.random.randn(k</span><span class="s2">, </span><span class="s1">k)</span>
        <span class="s1">Lk = tools.elimination_matrix(k)</span>
        <span class="s2">assert </span><span class="s1">np.array_equal(vech(m)</span><span class="s2">, </span><span class="s1">np.dot(Lk</span><span class="s2">, </span><span class="s1">vec(m)))</span>


<span class="s2">def </span><span class="s1">test_commutation_matrix(reset_randomstate):</span>
    <span class="s1">m = np.random.randn(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s1">K = tools.commutation_matrix(</span><span class="s3">4</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(vec(m.T)</span><span class="s2">, </span><span class="s1">np.dot(K</span><span class="s2">, </span><span class="s1">vec(m)))</span>


<span class="s2">def </span><span class="s1">test_vec():</span>
    <span class="s1">arr = np.array([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(vec(arr)</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">4</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_vech():</span>
    <span class="s1">arr = np.array([[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">6</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">7</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s1">]])</span>
    <span class="s2">assert </span><span class="s1">np.array_equal(vech(arr)</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">8</span><span class="s2">, </span><span class="s3">9</span><span class="s1">])</span>


<span class="s2">def </span><span class="s1">test_ar_transparams():</span>
    <span class="s1">arr = np.array(</span>
        <span class="s1">[-</span><span class="s3">1000.0</span><span class="s2">, </span><span class="s1">-</span><span class="s3">100.0</span><span class="s2">, </span><span class="s1">-</span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">0.0</span><span class="s2">, </span><span class="s3">1.0</span><span class="s2">, </span><span class="s3">10.0</span><span class="s2">, </span><span class="s3">100.0</span><span class="s2">, </span><span class="s3">1000.0</span><span class="s1">]</span>
    <span class="s1">)</span>
    <span class="s2">assert not </span><span class="s1">np.isnan(tools._ar_transparams(arr)).any()</span>


<span class="s2">class </span><span class="s1">TestLagmat:</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">data = macrodata.load_pandas()</span>
        <span class="s1">cls.macro_df = data.data[[</span><span class="s5">&quot;year&quot;</span><span class="s2">, </span><span class="s5">&quot;quarter&quot;</span><span class="s2">, </span><span class="s5">&quot;realgdp&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi&quot;</span><span class="s1">]]</span>
        <span class="s1">cols = list(cls.macro_df.columns)</span>
        <span class="s1">cls.realgdp_loc = cols.index(</span><span class="s5">&quot;realgdp&quot;</span><span class="s1">)</span>
        <span class="s1">cls.cpi_loc = cols.index(</span><span class="s5">&quot;cpi&quot;</span><span class="s1">)</span>
        <span class="s1">np.random.seed(</span><span class="s3">12345</span><span class="s1">)</span>
        <span class="s1">cls.random_data = np.random.randn(</span><span class="s3">100</span><span class="s1">)</span>

        <span class="s1">index = [</span>
            <span class="s1">str(int(yr)) + </span><span class="s5">&quot;-Q&quot; </span><span class="s1">+ str(int(qu))</span>
            <span class="s2">for </span><span class="s1">yr</span><span class="s2">, </span><span class="s1">qu </span><span class="s2">in </span><span class="s1">zip(cls.macro_df.year</span><span class="s2">, </span><span class="s1">cls.macro_df.quarter)</span>
        <span class="s1">]</span>
        <span class="s1">cls.macro_df.index = index</span>
        <span class="s1">cls.series = cls.macro_df.cpi</span>

    <span class="s2">def </span><span class="s1">test_add_lag_insert(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">lagmat</span><span class="s2">, </span><span class="s1">nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">self.realgdp_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_noinsert(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">self.realgdp_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_noinsert_atend(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">self.cpi_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>
        <span class="s4"># should be the same as insert</span>
        <span class="s1">lag_data2 = tools.add_lag(data</span><span class="s2">, </span><span class="s1">self.cpi_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data2</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_ndarray(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">]</span><span class="s2">, </span><span class="s1">lagmat</span><span class="s2">, </span><span class="s1">nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">lag_data = tools.add_lag(nddata</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_noinsert_ndarray(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(nddata</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_noinsertatend_ndarray(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(nddata</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>
        <span class="s4"># should be the same as insert also check negative col number</span>
        <span class="s1">lag_data2 = tools.add_lag(nddata</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data2</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_sep_return(self):</span>
        <span class="s1">data = self.random_data</span>
        <span class="s1">n = data.shape[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">lagmat</span><span class="s2">, </span><span class="s1">leads = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;none&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s1">)</span>
        <span class="s1">expected = np.zeros((n + </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">))</span>
        <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">expected[i : i + n</span><span class="s2">, </span><span class="s1">i] = data</span>
        <span class="s1">expected_leads = expected[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">1</span><span class="s1">]</span>
        <span class="s1">expected_lags = expected[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:]</span>
        <span class="s1">assert_equal(expected_lags</span><span class="s2">, </span><span class="s1">lagmat)</span>
        <span class="s1">assert_equal(expected_leads</span><span class="s2">, </span><span class="s1">leads)</span>

    <span class="s2">def </span><span class="s1">test_add_lag1d(self):</span>
        <span class="s1">data = self.random_data</span>
        <span class="s1">lagmat = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((data[</span><span class="s3">3</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(results</span><span class="s2">, </span><span class="s1">lag_data)</span>

        <span class="s4"># add index</span>
        <span class="s1">data = data[:</span><span class="s2">, None</span><span class="s1">]</span>
        <span class="s1">lagmat = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)  </span><span class="s4"># test for lagmat too</span>
        <span class="s1">results = np.column_stack((data[</span><span class="s3">3</span><span class="s1">:]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(results</span><span class="s2">, </span><span class="s1">lag_data)</span>

    <span class="s2">def </span><span class="s1">test_add_lag1d_drop(self):</span>
        <span class="s1">data = self.random_data</span>
        <span class="s1">lagmat = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">drop=</span><span class="s2">True, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

        <span class="s4"># no insert, should be the same</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">drop=</span><span class="s2">True, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

    <span class="s2">def </span><span class="s1">test_add_lag1d_struct(self):</span>
        <span class="s1">data = np.zeros(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype=[(</span><span class="s5">&quot;variable&quot;</span><span class="s2">, </span><span class="s1">float)])</span>
        <span class="s1">nddata = self.random_data</span>
        <span class="s1">data[</span><span class="s5">&quot;variable&quot;</span><span class="s1">] = nddata</span>

        <span class="s1">lagmat = stattools.lagmat(nddata</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s1">)</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_1d_drop_struct(self):</span>
        <span class="s1">data = np.zeros(</span><span class="s3">100</span><span class="s2">, </span><span class="s1">dtype=[(</span><span class="s5">&quot;variable&quot;</span><span class="s2">, </span><span class="s1">float)])</span>
        <span class="s1">nddata = self.random_data</span>
        <span class="s1">data[</span><span class="s5">&quot;variable&quot;</span><span class="s1">] = nddata</span>

        <span class="s1">lagmat = stattools.lagmat(nddata</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">lags=</span><span class="s3">3</span><span class="s2">, </span><span class="s1">drop=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lagmat</span><span class="s2">, </span><span class="s1">lag_data)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_drop_insert(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">lagmat</span><span class="s2">, </span><span class="s1">nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s1">]))</span>
        <span class="s1">lag_data = tools.add_lag(data</span><span class="s2">, </span><span class="s1">self.realgdp_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">drop=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_add_lag_drop_noinsert(self):</span>
        <span class="s1">data = self.macro_df.values</span>
        <span class="s1">nddata = data.astype(float)</span>
        <span class="s1">lagmat = stattools.lagmat(nddata[:</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;Both&quot;</span><span class="s1">)</span>
        <span class="s1">results = np.column_stack((nddata[</span><span class="s3">3</span><span class="s1">:</span><span class="s2">, </span><span class="s1">np.array([</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s1">])]</span><span class="s2">, </span><span class="s1">lagmat))</span>
        <span class="s1">lag_data = tools.add_lag(</span>
            <span class="s1">data</span><span class="s2">, </span><span class="s1">self.realgdp_loc</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">insert=</span><span class="s2">False, </span><span class="s1">drop=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(lag_data</span><span class="s2">, </span><span class="s1">results)</span>

    <span class="s2">def </span><span class="s1">test_dataframe_without_pandas(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">both = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s1">)</span>
        <span class="s1">both_np = stattools.lagmat(data.values</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(both</span><span class="s2">, </span><span class="s1">both_np)</span>

        <span class="s1">lags = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;none&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s1">)</span>
        <span class="s1">lags_np = stattools.lagmat(data.values</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;none&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(lags</span><span class="s2">, </span><span class="s1">lags_np)</span>

        <span class="s1">lags</span><span class="s2">, </span><span class="s1">lead = stattools.lagmat(data</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s1">)</span>
        <span class="s1">lags_np</span><span class="s2">, </span><span class="s1">lead_np = stattools.lagmat(</span>
            <span class="s1">data.values</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(lags</span><span class="s2">, </span><span class="s1">lags_np)</span>
        <span class="s1">assert_equal(lead</span><span class="s2">, </span><span class="s1">lead_np)</span>

    <span class="s2">def </span><span class="s1">test_dataframe_both(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">columns = list(data.columns)</span>
        <span class="s1">n = data.shape[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">values = np.zeros((n + </span><span class="s3">3</span><span class="s2">, </span><span class="s3">16</span><span class="s1">))</span>
        <span class="s1">values[:n</span><span class="s2">, </span><span class="s1">:</span><span class="s3">4</span><span class="s1">] = data.values</span>
        <span class="s2">for </span><span class="s1">lag </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">new_cols = [col + </span><span class="s5">&quot;.L.&quot; </span><span class="s1">+ str(lag) </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">data]</span>
            <span class="s1">columns.extend(new_cols)</span>
            <span class="s1">values[lag : n + lag</span><span class="s2">, </span><span class="s3">4 </span><span class="s1">* lag : </span><span class="s3">4 </span><span class="s1">* (lag + </span><span class="s3">1</span><span class="s1">)] = data.values</span>
        <span class="s1">index = data.index</span>
        <span class="s1">values = values[:n]</span>
        <span class="s1">expected = pd.DataFrame(values</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">expected = expected.iloc[</span><span class="s3">3</span><span class="s1">:]</span>

        <span class="s1">both = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(both</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">lags = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">4</span><span class="s1">:])</span>
        <span class="s1">lags</span><span class="s2">, </span><span class="s1">lead = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">4</span><span class="s1">:])</span>
        <span class="s1">assert_frame_equal(lead</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">4</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">test_too_few_observations(self):</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">stattools.lagmat</span><span class="s2">, </span><span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">300</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(ValueError</span><span class="s2">, </span><span class="s1">stattools.lagmat</span><span class="s2">, </span><span class="s1">self.macro_df.values</span><span class="s2">, </span><span class="s3">300</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_unknown_trim(self):</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.macro_df</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;unknown&quot;</span><span class="s2">,</span>
            <span class="s1">use_pandas=</span><span class="s2">True,</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.macro_df.values</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;unknown&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_dataframe_forward(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">columns = list(data.columns)</span>
        <span class="s1">n = data.shape[</span><span class="s3">0</span><span class="s1">]</span>
        <span class="s1">values = np.zeros((n + </span><span class="s3">3</span><span class="s2">, </span><span class="s3">16</span><span class="s1">))</span>
        <span class="s1">values[:n</span><span class="s2">, </span><span class="s1">:</span><span class="s3">4</span><span class="s1">] = data.values</span>
        <span class="s2">for </span><span class="s1">lag </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">new_cols = [col + </span><span class="s5">&quot;.L.&quot; </span><span class="s1">+ str(lag) </span><span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">data]</span>
            <span class="s1">columns.extend(new_cols)</span>
            <span class="s1">values[lag : n + lag</span><span class="s2">, </span><span class="s3">4 </span><span class="s1">* lag : </span><span class="s3">4 </span><span class="s1">* (lag + </span><span class="s3">1</span><span class="s1">)] = data.values</span>
        <span class="s1">index = data.index</span>
        <span class="s1">values = values[:n]</span>
        <span class="s1">expected = pd.DataFrame(values</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span>
        <span class="s1">both = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(both</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">lags = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">4</span><span class="s1">:])</span>
        <span class="s1">lags</span><span class="s2">, </span><span class="s1">lead = stattools.lagmat(</span>
            <span class="s1">self.macro_df</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">4</span><span class="s1">:])</span>
        <span class="s1">assert_frame_equal(lead</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">4</span><span class="s1">])</span>

    <span class="s2">def </span><span class="s1">test_pandas_errors(self):</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.macro_df</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;none&quot;</span><span class="s2">,</span>
            <span class="s1">use_pandas=</span><span class="s2">True,</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.macro_df</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;backward&quot;</span><span class="s2">,</span>
            <span class="s1">use_pandas=</span><span class="s2">True,</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.series</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;none&quot;</span><span class="s2">,</span>
            <span class="s1">use_pandas=</span><span class="s2">True,</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">stattools.lagmat</span><span class="s2">,</span>
            <span class="s1">self.series</span><span class="s2">,</span>
            <span class="s3">3</span><span class="s2">,</span>
            <span class="s1">trim=</span><span class="s5">&quot;backward&quot;</span><span class="s2">,</span>
            <span class="s1">use_pandas=</span><span class="s2">True,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_series_forward(self):</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">index=self.series.index</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;cpi&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.1&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.2&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.3&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">expected[</span><span class="s5">&quot;cpi&quot;</span><span class="s1">] = self.series</span>
        <span class="s2">for </span><span class="s1">lag </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">expected[</span><span class="s5">&quot;cpi.L.&quot; </span><span class="s1">+ str(int(lag))] = self.series.shift(lag)</span>
        <span class="s1">expected = expected.fillna(</span><span class="s3">0.0</span><span class="s1">)</span>

        <span class="s1">both = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(both</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">lags = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:])</span>
        <span class="s1">lags</span><span class="s2">, </span><span class="s1">lead = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;forward&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lead</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:])</span>

    <span class="s2">def </span><span class="s1">test_series_both(self):</span>
        <span class="s1">expected = pd.DataFrame(</span>
            <span class="s1">index=self.series.index</span><span class="s2">,</span>
            <span class="s1">columns=[</span><span class="s5">&quot;cpi&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.1&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.2&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi.L.3&quot;</span><span class="s1">]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">expected[</span><span class="s5">&quot;cpi&quot;</span><span class="s1">] = self.series</span>
        <span class="s2">for </span><span class="s1">lag </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s1">):</span>
            <span class="s1">expected[</span><span class="s5">&quot;cpi.L.&quot; </span><span class="s1">+ str(int(lag))] = self.series.shift(lag)</span>
        <span class="s1">expected = expected.iloc[</span><span class="s3">3</span><span class="s1">:]</span>

        <span class="s1">both = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;in&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(both</span><span class="s2">, </span><span class="s1">expected)</span>
        <span class="s1">lags = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;ex&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:])</span>
        <span class="s1">lags</span><span class="s2">, </span><span class="s1">lead = stattools.lagmat(</span>
            <span class="s1">self.series</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s2">, </span><span class="s1">original=</span><span class="s5">&quot;sep&quot;</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(lead</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">1</span><span class="s1">])</span>
        <span class="s1">assert_frame_equal(lags</span><span class="s2">, </span><span class="s1">expected.iloc[:</span><span class="s2">, </span><span class="s3">1</span><span class="s1">:])</span>

    <span class="s2">def </span><span class="s1">test_range_index_columns(self):</span>
        <span class="s4"># GH 8377</span>
        <span class="s1">df = pd.DataFrame(np.arange(</span><span class="s3">200</span><span class="s1">).reshape((-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)))</span>
        <span class="s1">df.columns = pd.RangeIndex(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">result = stattools.lagmat(df</span><span class="s2">, </span><span class="s1">maxlag=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">result.shape == (</span><span class="s3">100</span><span class="s2">, </span><span class="s3">4</span><span class="s1">)</span>
        <span class="s2">assert </span><span class="s1">list(result.columns) == [</span><span class="s5">&quot;0.L.1&quot;</span><span class="s2">, </span><span class="s5">&quot;1.L.1&quot;</span><span class="s2">, </span><span class="s5">&quot;0.L.2&quot;</span><span class="s2">, </span><span class="s5">&quot;1.L.2&quot;</span><span class="s1">]</span>

    <span class="s2">def </span><span class="s1">test_duplicate_column_names(self):</span>
        <span class="s4"># GH 8377</span>
        <span class="s1">df = pd.DataFrame(np.arange(</span><span class="s3">200</span><span class="s1">).reshape((-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)))</span>
        <span class="s1">df.columns = [</span><span class="s3">0</span><span class="s2">, </span><span class="s5">&quot;0&quot;</span><span class="s1">]</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;Columns names must be&quot;</span><span class="s1">):</span>
            <span class="s1">stattools.lagmat(df</span><span class="s2">, </span><span class="s1">maxlag=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_freq_to_period():</span>
    <span class="s2">from </span><span class="s1">pandas.tseries.frequencies </span><span class="s2">import </span><span class="s1">to_offset</span>

    <span class="s1">freqs = [</span><span class="s5">&quot;A&quot;</span><span class="s2">, </span><span class="s5">&quot;AS-MAR&quot;</span><span class="s2">, </span><span class="s5">&quot;Q&quot;</span><span class="s2">, </span><span class="s5">&quot;QS&quot;</span><span class="s2">, </span><span class="s5">&quot;QS-APR&quot;</span><span class="s2">, </span><span class="s5">&quot;W&quot;</span><span class="s2">, </span><span class="s5">&quot;W-MON&quot;</span><span class="s2">, </span><span class="s5">&quot;B&quot;</span><span class="s2">, </span><span class="s5">&quot;D&quot;</span><span class="s2">, </span><span class="s5">&quot;H&quot;</span><span class="s1">]</span>
    <span class="s1">expected = [</span><span class="s3">1</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s2">, </span><span class="s3">52</span><span class="s2">, </span><span class="s3">52</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s3">7</span><span class="s2">, </span><span class="s3">24</span><span class="s1">]</span>
    <span class="s2">for </span><span class="s1">i</span><span class="s2">, </span><span class="s1">j </span><span class="s2">in </span><span class="s1">zip(freqs</span><span class="s2">, </span><span class="s1">expected):</span>
        <span class="s1">assert_equal(tools.freq_to_period(i)</span><span class="s2">, </span><span class="s1">j)</span>
        <span class="s1">assert_equal(tools.freq_to_period(to_offset(i))</span><span class="s2">, </span><span class="s1">j)</span>


<span class="s2">class </span><span class="s1">TestDetrend:</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.data_1d = np.arange(</span><span class="s3">5.0</span><span class="s1">)</span>
        <span class="s1">cls.data_2d = np.arange(</span><span class="s3">10.0</span><span class="s1">).reshape(</span><span class="s3">5</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_detrend_1d(self):</span>
        <span class="s1">data = self.data_1d</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">1</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.zeros_like(data)</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_detrend_2d(self):</span>
        <span class="s1">data = self.data_2d</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s2">, </span><span class="s1">np.zeros_like(data)</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">[[-</span><span class="s3">4</span><span class="s2">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">[[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_detrend_series(self):</span>
        <span class="s1">data = pd.Series(self.data_1d</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;one&quot;</span><span class="s1">)</span>
        <span class="s1">detrended = tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(detrended.values</span><span class="s2">, </span><span class="s1">np.zeros_like(data))</span>
        <span class="s1">assert_series_equal(detrended</span><span class="s2">, </span><span class="s1">pd.Series(detrended.values</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;one&quot;</span><span class="s1">))</span>
        <span class="s1">detrended = tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">detrended.values</span><span class="s2">, </span><span class="s1">pd.Series([-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">-</span><span class="s3">1</span><span class="s2">, </span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">)</span>
        <span class="s1">assert_series_equal(detrended</span><span class="s2">, </span><span class="s1">pd.Series(detrended.values</span><span class="s2">, </span><span class="s1">name=</span><span class="s5">&quot;one&quot;</span><span class="s1">))</span>

    <span class="s2">def </span><span class="s1">test_detrend_dataframe(self):</span>
        <span class="s1">columns = [</span><span class="s5">&quot;one&quot;</span><span class="s2">, </span><span class="s5">&quot;two&quot;</span><span class="s1">]</span>
        <span class="s1">index = [c </span><span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s5">&quot;abcde&quot;</span><span class="s1">]</span>
        <span class="s1">data = pd.DataFrame(self.data_2d</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span>

        <span class="s1">detrended = tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">1</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(detrended.values</span><span class="s2">, </span><span class="s1">np.zeros_like(data))</span>
        <span class="s1">assert_frame_equal(</span>
            <span class="s1">detrended</span><span class="s2">,</span>
            <span class="s1">pd.DataFrame(detrended.values</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">detrended = tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">0</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">detrended.values</span><span class="s2">, </span><span class="s1">[[-</span><span class="s3">4</span><span class="s2">, </span><span class="s1">-</span><span class="s3">4</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">2</span><span class="s2">, </span><span class="s1">-</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">0</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[</span><span class="s3">4</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(</span>
            <span class="s1">detrended</span><span class="s2">,</span>
            <span class="s1">pd.DataFrame(detrended.values</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span><span class="s2">,</span>
        <span class="s1">)</span>

        <span class="s1">detrended = tools.detrend(data</span><span class="s2">, </span><span class="s1">order=</span><span class="s3">0</span><span class="s2">, </span><span class="s1">axis=</span><span class="s3">1</span><span class="s1">)</span>
        <span class="s1">assert_array_almost_equal(</span>
            <span class="s1">detrended.values</span><span class="s2">,</span>
            <span class="s1">[[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]</span><span class="s2">, </span><span class="s1">[-</span><span class="s3">0.5</span><span class="s2">, </span><span class="s3">0.5</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_frame_equal(</span>
            <span class="s1">detrended</span><span class="s2">,</span>
            <span class="s1">pd.DataFrame(detrended.values</span><span class="s2">, </span><span class="s1">columns=columns</span><span class="s2">, </span><span class="s1">index=index)</span><span class="s2">,</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_detrend_dim_too_large(self):</span>
        <span class="s1">assert_raises(NotImplementedError</span><span class="s2">, </span><span class="s1">tools.detrend</span><span class="s2">, </span><span class="s1">np.ones((</span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)))</span>


<span class="s2">class </span><span class="s1">TestAddTrend:</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">cls.n = </span><span class="s3">200</span>
        <span class="s1">cls.arr_1d = np.arange(float(cls.n))</span>
        <span class="s1">cls.arr_2d = np.tile(np.arange(float(cls.n))[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">cls.c = np.ones(cls.n)</span>
        <span class="s1">cls.t = np.arange(</span><span class="s3">1.0</span><span class="s2">, </span><span class="s1">cls.n + </span><span class="s3">1</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_series(self):</span>
        <span class="s1">s = pd.Series(self.arr_1d)</span>
        <span class="s1">appended = tools.add_trend(s)</span>
        <span class="s1">expected = pd.DataFrame(s)</span>
        <span class="s1">expected[</span><span class="s5">&quot;const&quot;</span><span class="s1">] = self.c</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">appended)</span>

        <span class="s1">prepended = tools.add_trend(s</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(s)</span>
        <span class="s1">expected.insert(</span><span class="s3">0</span><span class="s2">, </span><span class="s5">&quot;const&quot;</span><span class="s2">, </span><span class="s1">self.c)</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">prepended)</span>

        <span class="s1">s = pd.Series(self.arr_1d)</span>
        <span class="s1">appended = tools.add_trend(s</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s1">)</span>
        <span class="s1">expected = pd.DataFrame(s)</span>
        <span class="s1">expected[</span><span class="s5">&quot;const&quot;</span><span class="s1">] = self.c</span>
        <span class="s1">expected[</span><span class="s5">&quot;trend&quot;</span><span class="s1">] = self.t</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">appended)</span>

    <span class="s2">def </span><span class="s1">test_dataframe(self):</span>
        <span class="s1">df = pd.DataFrame(self.arr_2d)</span>
        <span class="s1">appended = tools.add_trend(df)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s5">&quot;const&quot;</span><span class="s1">] = self.c</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">appended)</span>

        <span class="s1">prepended = tools.add_trend(df</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected.insert(</span><span class="s3">0</span><span class="s2">, </span><span class="s5">&quot;const&quot;</span><span class="s2">, </span><span class="s1">self.c)</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">prepended)</span>

        <span class="s1">df = pd.DataFrame(self.arr_2d)</span>
        <span class="s1">appended = tools.add_trend(df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;t&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s5">&quot;trend&quot;</span><span class="s1">] = self.t</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">appended)</span>

        <span class="s1">df = pd.DataFrame(self.arr_2d)</span>
        <span class="s1">appended = tools.add_trend(df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ctt&quot;</span><span class="s1">)</span>
        <span class="s1">expected = df.copy()</span>
        <span class="s1">expected[</span><span class="s5">&quot;const&quot;</span><span class="s1">] = self.c</span>
        <span class="s1">expected[</span><span class="s5">&quot;trend&quot;</span><span class="s1">] = self.t</span>
        <span class="s1">expected[</span><span class="s5">&quot;trend_squared&quot;</span><span class="s1">] = self.t ** </span><span class="s3">2</span>
        <span class="s1">assert_frame_equal(expected</span><span class="s2">, </span><span class="s1">appended)</span>

    <span class="s2">def </span><span class="s1">test_duplicate_const(self):</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">tools.add_trend</span><span class="s2">,</span>
            <span class="s1">x=self.c</span><span class="s2">,</span>
            <span class="s1">trend=</span><span class="s5">&quot;c&quot;</span><span class="s2">,</span>
            <span class="s1">has_constant=</span><span class="s5">&quot;raise&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">,</span>
            <span class="s1">tools.add_trend</span><span class="s2">,</span>
            <span class="s1">x=self.c</span><span class="s2">,</span>
            <span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">,</span>
            <span class="s1">has_constant=</span><span class="s5">&quot;raise&quot;</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">df = pd.DataFrame(self.c)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">tools.add_trend</span><span class="s2">, </span><span class="s1">x=df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s1">has_constant=</span><span class="s5">&quot;raise&quot;</span>
        <span class="s1">)</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">tools.add_trend</span><span class="s2">, </span><span class="s1">x=df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">, </span><span class="s1">has_constant=</span><span class="s5">&quot;raise&quot;</span>
        <span class="s1">)</span>

        <span class="s1">skipped = tools.add_trend(self.c</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;c&quot;</span><span class="s1">)</span>
        <span class="s1">assert_equal(skipped</span><span class="s2">, </span><span class="s1">self.c[:</span><span class="s2">, None</span><span class="s1">])</span>

        <span class="s1">skipped_const = tools.add_trend(</span>
            <span class="s1">self.c</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">, </span><span class="s1">has_constant=</span><span class="s5">&quot;skip&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected = np.vstack((self.c</span><span class="s2">, </span><span class="s1">self.t)).T</span>
        <span class="s1">assert_equal(skipped_const</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">added = tools.add_trend(self.c</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;c&quot;</span><span class="s2">, </span><span class="s1">has_constant=</span><span class="s5">&quot;add&quot;</span><span class="s1">)</span>
        <span class="s1">expected = np.vstack((self.c</span><span class="s2">, </span><span class="s1">self.c)).T</span>
        <span class="s1">assert_equal(added</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">added = tools.add_trend(self.c</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">, </span><span class="s1">has_constant=</span><span class="s5">&quot;add&quot;</span><span class="s1">)</span>
        <span class="s1">expected = np.vstack((self.c</span><span class="s2">, </span><span class="s1">self.c</span><span class="s2">, </span><span class="s1">self.t)).T</span>
        <span class="s1">assert_equal(added</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_dataframe_duplicate(self):</span>
        <span class="s1">df = pd.DataFrame(self.arr_2d</span><span class="s2">, </span><span class="s1">columns=[</span><span class="s5">&quot;const&quot;</span><span class="s2">, </span><span class="s5">&quot;trend&quot;</span><span class="s1">])</span>
        <span class="s1">tools.add_trend(df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s1">)</span>
        <span class="s1">tools.add_trend(df</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_array(self):</span>
        <span class="s1">base = np.vstack((self.arr_1d</span><span class="s2">, </span><span class="s1">self.c</span><span class="s2">, </span><span class="s1">self.t</span><span class="s2">, </span><span class="s1">self.t ** </span><span class="s3">2</span><span class="s1">)).T</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_1d)</span><span class="s2">, </span><span class="s1">base[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">])</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_1d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;t&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">base[:</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">2</span><span class="s1">]])</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_1d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">base[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">3</span><span class="s1">])</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_1d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ctt&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">base)</span>

        <span class="s1">base = np.hstack(</span>
            <span class="s1">(</span>
                <span class="s1">self.c[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s1">self.t[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">,</span>
                <span class="s1">self.t[:</span><span class="s2">, None</span><span class="s1">] ** </span><span class="s3">2</span><span class="s2">,</span>
                <span class="s1">self.arr_2d</span><span class="s2">,</span>
            <span class="s1">)</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">, </span><span class="s1">base[:</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;t&quot;</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">base[:</span><span class="s2">, </span><span class="s1">[</span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ct&quot;</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">,</span>
            <span class="s1">base[:</span><span class="s2">, </span><span class="s1">[</span><span class="s3">0</span><span class="s2">, </span><span class="s3">1</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s3">4</span><span class="s1">]]</span><span class="s2">,</span>
        <span class="s1">)</span>
        <span class="s1">assert_equal(</span>
            <span class="s1">tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;ctt&quot;</span><span class="s2">, </span><span class="s1">prepend=</span><span class="s2">True</span><span class="s1">)</span><span class="s2">, </span><span class="s1">base</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_unknown_trend(self):</span>
        <span class="s1">assert_raises(</span>
            <span class="s1">ValueError</span><span class="s2">, </span><span class="s1">tools.add_trend</span><span class="s2">, </span><span class="s1">x=self.arr_1d</span><span class="s2">, </span><span class="s1">trend=</span><span class="s5">&quot;unknown&quot;</span>
        <span class="s1">)</span>

    <span class="s2">def </span><span class="s1">test_trend_n(self):</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_1d</span><span class="s2">, </span><span class="s5">&quot;n&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">self.arr_1d)</span>
        <span class="s2">assert </span><span class="s1">tools.add_trend(self.arr_1d</span><span class="s2">, </span><span class="s5">&quot;n&quot;</span><span class="s1">) </span><span class="s2">is not </span><span class="s1">self.arr_1d</span>
        <span class="s1">assert_equal(tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s5">&quot;n&quot;</span><span class="s1">)</span><span class="s2">, </span><span class="s1">self.arr_2d)</span>
        <span class="s2">assert </span><span class="s1">tools.add_trend(self.arr_2d</span><span class="s2">, </span><span class="s5">&quot;n&quot;</span><span class="s1">) </span><span class="s2">is not </span><span class="s1">self.arr_2d</span>


<span class="s2">class </span><span class="s1">TestLagmat2DS:</span>
    <span class="s1">@classmethod</span>
    <span class="s2">def </span><span class="s1">setup_class(cls):</span>
        <span class="s1">data = macrodata.load_pandas()</span>
        <span class="s1">cls.macro_df = data.data[[</span><span class="s5">&quot;year&quot;</span><span class="s2">, </span><span class="s5">&quot;quarter&quot;</span><span class="s2">, </span><span class="s5">&quot;realgdp&quot;</span><span class="s2">, </span><span class="s5">&quot;cpi&quot;</span><span class="s1">]]</span>
        <span class="s1">np.random.seed(</span><span class="s3">12345</span><span class="s1">)</span>
        <span class="s1">cls.random_data = np.random.randn(</span><span class="s3">100</span><span class="s1">)</span>
        <span class="s1">index = [</span>
            <span class="s1">str(int(yr)) + </span><span class="s5">&quot;-Q&quot; </span><span class="s1">+ str(int(qu))</span>
            <span class="s2">for </span><span class="s1">yr</span><span class="s2">, </span><span class="s1">qu </span><span class="s2">in </span><span class="s1">zip(cls.macro_df.year</span><span class="s2">, </span><span class="s1">cls.macro_df.quarter)</span>
        <span class="s1">]</span>
        <span class="s1">cls.macro_df.index = index</span>
        <span class="s1">cls.series = cls.macro_df.cpi</span>

    <span class="s1">@staticmethod</span>
    <span class="s2">def </span><span class="s1">_prepare_expected(data</span><span class="s2">, </span><span class="s1">lags</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;front&quot;</span><span class="s1">):</span>
        <span class="s1">t</span><span class="s2">, </span><span class="s1">k = data.shape</span>
        <span class="s1">expected = np.zeros((t + lags</span><span class="s2">, </span><span class="s1">(lags + </span><span class="s3">1</span><span class="s1">) * k))</span>
        <span class="s2">for </span><span class="s1">col </span><span class="s2">in </span><span class="s1">range(k):</span>
            <span class="s2">for </span><span class="s1">i </span><span class="s2">in </span><span class="s1">range(lags + </span><span class="s3">1</span><span class="s1">):</span>
                <span class="s2">if </span><span class="s1">i &lt; lags:</span>
                    <span class="s1">expected[i : -lags + i</span><span class="s2">, </span><span class="s1">(lags + </span><span class="s3">1</span><span class="s1">) * col + i] = data[</span>
                        <span class="s1">:</span><span class="s2">, </span><span class="s1">col</span>
                    <span class="s1">]</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">expected[i:</span><span class="s2">, </span><span class="s1">(lags + </span><span class="s3">1</span><span class="s1">) * col + i] = data[:</span><span class="s2">, </span><span class="s1">col]</span>
        <span class="s2">if </span><span class="s1">trim == </span><span class="s5">&quot;front&quot;</span><span class="s1">:</span>
            <span class="s1">expected = expected[:-lags]</span>
        <span class="s2">return </span><span class="s1">expected</span>

    <span class="s2">def </span><span class="s1">test_lagmat2ds_numpy(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">npdata = data.values</span>
        <span class="s1">lagmat = stattools.lagmat2ds(npdata</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(npdata</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">lagmat = stattools.lagmat2ds(npdata[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(npdata[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">npdata = self.series.values</span>
        <span class="s1">lagmat = stattools.lagmat2ds(npdata</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(npdata[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_lagmat2ds_pandas(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">lagmat = stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">lagmat = stattools.lagmat2ds(data.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">expected = expected[</span><span class="s3">3</span><span class="s1">:]</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">data = self.series</span>
        <span class="s1">lagmat = stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>
        <span class="s1">assert_array_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_lagmat2ds_use_pandas(self):</span>
        <span class="s1">data = self.macro_df</span>
        <span class="s1">lagmat = stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
        <span class="s1">cols = []</span>
        <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">data:</span>
            <span class="s2">for </span><span class="s1">lags </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">3</span><span class="s1">):</span>
                <span class="s2">if </span><span class="s1">lags == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">cols.append(c)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">cols.append(c + </span><span class="s5">&quot;.L.&quot; </span><span class="s1">+ str(lags))</span>
        <span class="s1">expected = pd.DataFrame(expected</span><span class="s2">, </span><span class="s1">index=data.index</span><span class="s2">, </span><span class="s1">columns=cols)</span>
        <span class="s1">assert_frame_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">lagmat = stattools.lagmat2ds(</span>
            <span class="s1">data.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True, </span><span class="s1">trim=</span><span class="s5">&quot;both&quot;</span>
        <span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]</span><span class="s2">, </span><span class="s3">3</span><span class="s1">)</span>
        <span class="s1">cols = []</span>
        <span class="s2">for </span><span class="s1">c </span><span class="s2">in </span><span class="s1">data.iloc[:</span><span class="s2">, </span><span class="s1">:</span><span class="s3">2</span><span class="s1">]:</span>
            <span class="s2">for </span><span class="s1">lags </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">4</span><span class="s1">):</span>
                <span class="s2">if </span><span class="s1">lags == </span><span class="s3">0</span><span class="s1">:</span>
                    <span class="s1">cols.append(c)</span>
                <span class="s2">else</span><span class="s1">:</span>
                    <span class="s1">cols.append(c + </span><span class="s5">&quot;.L.&quot; </span><span class="s1">+ str(lags))</span>
        <span class="s1">expected = pd.DataFrame(expected</span><span class="s2">, </span><span class="s1">index=data.index</span><span class="s2">, </span><span class="s1">columns=cols)</span>
        <span class="s1">expected = expected.iloc[</span><span class="s3">3</span><span class="s1">:]</span>
        <span class="s1">assert_frame_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

        <span class="s1">data = self.series</span>
        <span class="s1">lagmat = stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">5</span><span class="s2">, </span><span class="s1">use_pandas=</span><span class="s2">True</span><span class="s1">)</span>
        <span class="s1">expected = self._prepare_expected(data.values[:</span><span class="s2">, None</span><span class="s1">]</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>

        <span class="s1">cols = []</span>
        <span class="s1">c = data.name</span>
        <span class="s2">for </span><span class="s1">lags </span><span class="s2">in </span><span class="s1">range(</span><span class="s3">6</span><span class="s1">):</span>
            <span class="s2">if </span><span class="s1">lags == </span><span class="s3">0</span><span class="s1">:</span>
                <span class="s1">cols.append(c)</span>
            <span class="s2">else</span><span class="s1">:</span>
                <span class="s1">cols.append(c + </span><span class="s5">&quot;.L.&quot; </span><span class="s1">+ str(lags))</span>

        <span class="s1">expected = pd.DataFrame(expected</span><span class="s2">, </span><span class="s1">index=data.index</span><span class="s2">, </span><span class="s1">columns=cols)</span>
        <span class="s1">assert_frame_equal(lagmat</span><span class="s2">, </span><span class="s1">expected)</span>

    <span class="s2">def </span><span class="s1">test_3d_error(self):</span>
        <span class="s1">data = np.array(</span><span class="s3">2</span><span class="s1">)</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>

        <span class="s1">data = np.zeros((</span><span class="s3">100</span><span class="s2">, </span><span class="s3">2</span><span class="s2">, </span><span class="s3">2</span><span class="s1">))</span>
        <span class="s2">with </span><span class="s1">pytest.raises(ValueError):</span>
            <span class="s1">stattools.lagmat2ds(data</span><span class="s2">, </span><span class="s3">5</span><span class="s1">)</span>


<span class="s2">def </span><span class="s1">test_grangercausality():</span>
    <span class="s1">data = np.random.rand(</span><span class="s3">100</span><span class="s2">, </span><span class="s3">2</span><span class="s1">)</span>
    <span class="s2">with </span><span class="s1">pytest.warns(FutureWarning</span><span class="s2">, </span><span class="s1">match=</span><span class="s5">&quot;verbose&quot;</span><span class="s1">):</span>
        <span class="s1">out = stattools.grangercausalitytests(data</span><span class="s2">, </span><span class="s1">maxlag=</span><span class="s3">2</span><span class="s2">, </span><span class="s1">verbose=</span><span class="s2">False</span><span class="s1">)</span>
    <span class="s1">result</span><span class="s2">, </span><span class="s1">models = out[</span><span class="s3">1</span><span class="s1">]</span>
    <span class="s1">res2down</span><span class="s2">, </span><span class="s1">res2djoint</span><span class="s2">, </span><span class="s1">rconstr = models</span>
    <span class="s2">assert </span><span class="s1">res2djoint.centered_tss </span><span class="s2">is not </span><span class="s1">res2djoint.uncentered_tss</span>
</pre>
</body>
</html>